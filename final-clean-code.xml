This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/.next/**, **/node_modules/**, **/*scraper/**, **/*.xml, **/lib/data/recipes-complete.ts, **/lib/data/vetted-products.ts, **/*.backup, **/*.json, **/*.md, **/*.txt
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
__tests__/integration/purchase-flow.test.ts
.gitattributes
.github/workflows/deploy.yml
.github/workflows/main.yml
.gitignore
.husky/pre-commit
.no-cursor-worktrees
app/about/page.tsx
app/api/amazon/purchase-confirmation/route.ts
app/api/purchases/route.ts
app/api/recipes/generate/route.ts
app/api/recommendations/route.ts
app/asin-verification/page.tsx
app/blog/[slug]/page.tsx
app/blog/page.tsx
app/category/[category]/page.tsx
app/contact/metadata.ts
app/contact/page.tsx
app/dashboard/page.tsx
app/diagnostics/image-inversion/page.tsx
app/faq/page.tsx
app/forum/gallery/page.tsx
app/forum/page.tsx
app/globals.css
app/layout.tsx
app/meal-plans/page.tsx
app/nutrition-guide/page.tsx
app/page.tsx
app/pets/[id]/page.tsx
app/privacy/page.tsx
app/profile/page.tsx
app/profile/pet/[id]/custom-meals/[mealId]/page.tsx
app/profile/pet/[id]/custom-meals/page.tsx
app/profile/pet/[id]/meal-plan/page.tsx
app/profile/pet/[id]/page.tsx
app/profile/pet/[id]/recipe-builder/page.tsx
app/profile/pet/[id]/saved-recipes/page.tsx
app/recipe/[id]/page.tsx
app/recipes/recommended/[id]/page.tsx
app/robots.ts
app/sign-in/[[...sign-in]]/page.tsx
app/sign-up/[[...sign-up]]/page.tsx
app/sitemap.ts
app/subscribe/page.tsx
check-package-sizes.mjs
components/ABTestDashboard.tsx
components/BadgeToggle.tsx
components/CompatibilityBadge.tsx
components/CompatibilityPanel.tsx
components/ConfirmModal.tsx
components/CostComparison.tsx
components/CreatePetModal.tsx
components/EmailCaptureModal.tsx
components/EmojiIcon.tsx
components/ErrorBoundary.tsx
components/ErrorBoundaryWrapper.tsx
components/FeedingLogger.tsx
components/FireworksAnimation.tsx
components/Footer.tsx
components/HealthConcernsDropdown.tsx
components/Image.tsx
components/IngredientPicker.tsx
components/InteractiveStarRating.tsx
components/LoadingSpinner.tsx
components/MascotAvatar.tsx
components/MascotIcon.tsx
components/mascots/FarmerFluff.tsx
components/mascots/MascotAnimation.tsx
components/mascots/ProfessorPurrfessor.tsx
components/mascots/PuppyPreper.tsx
components/mascots/RobinRedroute.tsx
components/mascots/SherlockShells.tsx
components/MealBuilderWizard.tsx
components/MealCompleteView.tsx
components/MealCompositionList.tsx
components/MultiPetShoppingModal.tsx
components/Navigation.tsx
components/NutritionDashboard.tsx
components/OfflineBanner.tsx
components/OneClickCheckoutModal.tsx
components/PetBadges.tsx
components/PetVillageWidget.tsx
components/ProfileSelector.tsx
components/PurchaseConfirmationModal.tsx
components/QuickPreviewModal.tsx
components/RatingBreakdown.tsx
components/RatingDistribution.tsx
components/RecipeCard.tsx
components/RecipeRatingSection.tsx
components/RecipeScoreModal.tsx
components/ScoringProgress.tsx
components/SEOHead.tsx
components/ShoppingList.tsx
components/ShoppingListSummary.tsx
components/SocialProof.tsx
components/StarRating.tsx
components/SuggestedIngredients.tsx
components/Tooltip.tsx
components/TrustBadges.tsx
components/ValidationMessages.tsx
components/VillageBackground.tsx
components/VillageBuildings.tsx
components/VillagePlaceholder.tsx
components/VillageScene.tsx
config/deploy.yml
config/firestore.rules
config/globals.d.ts
config/next.confi.js
config/next.config.mjs
config/postcss.config.js
config/tailwind.config.ts
config/vitest.config.ts
data/brand-vetted-high-confidence.ts
data/brand-vetted-medium-confidence.ts
data/csv/AMAZON_LINK_VERIFICATION.csv
data/csv/asins-extracted.csv
data/csv/MANUAL_REVIEW_REQUIRED.csv
data/csv/PHASE_1_5_MANUAL_REVIEW.csv
data/price-rankings.csv
data/vetted-products-price-updates.ts
extract_names.py
fix-small-packages.mjs
hooks/useAsyncOperation.ts
hooks/useOfflineDetector.ts
hooks/useProgressiveMealCount.ts
lib/__tests__/analyzeCustomMeal.test.ts
lib/__tests__/applyModifiers.test.ts
lib/__tests__/ingredientCompositions.test.ts
lib/__tests__/perfect-pet-scoring.test.ts
lib/__tests__/recipe-generator-v2.test.ts
lib/__tests__/scoreRecipe.test.ts
lib/analyzeCustomMeal.ts
lib/applyModifiers.ts
lib/audit/RecipeNutritionalAudit.ts
lib/audit/RecipePalatabilityAudit.ts
lib/audit/RecipeVarietyAudit.ts
lib/competitors/balanceit-analysis.ts
lib/data/__tests__/TESTEST.ts
lib/data/__tests__/vetted-products-species.test.ts
lib/data/__tests__/vetted-products.test.ts
lib/data/aafco-standards.ts
lib/data/avian-nutrition-standards.ts
lib/data/badgeDefinitions.ts
lib/data/baseRecipes.ts
lib/data/celebrity-pets-complete.ts
lib/data/conditionTemplates.ts
lib/data/coreProteins.ts
lib/data/generatedIngredients.ts
lib/data/globalIngredients.ts
lib/data/health-concerns.ts
lib/data/healthBenefitMap.ts
lib/data/healthConcerns.ts
lib/data/healthConcernTemplates.ts
lib/data/imageManifest.ts
lib/data/ingredientCompositions.ts
lib/data/ingredients.ts
lib/data/ingredientTiers.ts
lib/data/micronutrientDefaults.ts
lib/data/nutrition-cat-modifiers.ts
lib/data/nutrition-dog-modifiers.ts
lib/data/nutritional-guidelines.ts
lib/data/nutritionDatabase.ts
lib/data/packageSizes.ts
lib/data/pets.ts
lib/data/product-prices.ts
lib/data/recipes-index.ts
lib/data/reptile-nutrition.ts
lib/data/safe-ingredient-library.ts
lib/data/speciesBreeds.ts
lib/data/supplements.ts
lib/data/unifiedIngredientRegistry.ts
lib/data/verification-state.ts
lib/data/vetted-products-generic.ts
lib/data/vetted-products-new.js
lib/data/vetted-products-new.ts
lib/data/vetted-products-UPDATED.ts
lib/data/vetted-products.ts.backup-prices
lib/data/vetted-species-map.ts
lib/data/villageLevels.ts
lib/generator/AmazonLinkAudit.ts
lib/generator/AutoClassifyLinks.ts
lib/generator/BirdDebug.ts
lib/generator/BirdDetailedDebug.ts
lib/generator/BirdTest.ts
lib/generator/CheckBirdIngredients.ts
lib/generator/CombinatoricsPruning.ts
lib/generator/CommercialPriorEnforcement.test.ts
lib/generator/CommercialPriorEnforcement.ts
lib/generator/ComprehensiveAudit.ts
lib/generator/DebugProteinRole.ts
lib/generator/GenerateVerificationList.ts
lib/generator/Phase1_5_AutoClassify.ts
lib/generator/QuickTest.ts
lib/generator/RecipeBuilder.integration.test.ts
lib/generator/RecipeBuilder.smoke.test.ts
lib/generator/RecipeBuilder.test.ts
lib/generator/RecipeBuilder.ts
lib/generator/RecipeCompositionValidator.ts
lib/generator/RecipeConstraintRules.ts
lib/generator/RecipePMIScoring.ts
lib/generator/RecipePriorScoring.ts
lib/generator/VerifyAmazonLinks.ts
lib/hooks/useChunkedRecipeScoring.ts
lib/meal-plan-generator.ts
lib/modifierRules.ts
lib/nutrition/nutritionHistory.ts
lib/portionCalc.ts
lib/quoteGenerator.ts
lib/recipe-generator-legacy.ts
lib/recipe-generator-v3.ts
lib/recipe-generator.ts
lib/scoreRecipe.ts
lib/seo/metadata.ts
lib/services/amazonPurchaseTracker.ts
lib/services/brandBasedVetter.ts
lib/services/firestoreService.ts
lib/services/unifiedVettingService.ts
lib/state/villageStore.ts
lib/types.ts
lib/types/aliasGroups.ts
lib/types/badges.ts
lib/types/index.ts
lib/types/retailValidation.ts
lib/utils/__tests__/affiliateLinks.test.ts
lib/utils/__tests__/getAmazonBuyLink.test.ts
lib/utils/abTesting.ts
lib/utils/affiliateLinks.ts
lib/utils/allIngredients.ts
lib/utils/auth.ts
lib/utils/badgeChecker.ts
lib/utils/badgeStorage.ts
lib/utils/beep.ts
lib/utils/buyLinkValidation.ts
lib/utils/convertCustomMealToRecipe.ts
lib/utils/customMealStorage.ts
lib/utils/customMealStorageFirebase.ts
lib/utils/diversityTracker.ts
lib/utils/emojiMapping.ts
lib/utils/enhancedCompatibilityScoring.ts
lib/utils/errorHandler.ts
lib/utils/firebaseConfig.ts
lib/utils/getAmazonBuyLink.ts
lib/utils/healthConcernMatching.ts
lib/utils/imageMapping.ts
lib/utils/improvedCompatibilityScoring.ts
lib/utils/ingredientCompatibility.ts
lib/utils/ingredientNameNormalizer.ts
lib/utils/ingredientRegistry.ts
lib/utils/ingredientSuggestions.ts
lib/utils/ingredientWhitelists.ts
lib/utils/localStorageSafe.ts
lib/utils/logger.ts
lib/utils/mascotImageMapping.ts
lib/utils/mealCalculator.ts
lib/utils/mealCountCalculator.ts
lib/utils/mealEstimation.ts
lib/utils/mealImageAssignment.ts
lib/utils/mealNameGenerator.ts
lib/utils/nutritionalRecommendations.ts
lib/utils/nutritionFallbacks.ts
lib/utils/organicCount.ts
lib/utils/petPurchaseTracking.ts
lib/utils/petRatingSystem.ts
lib/utils/petStorage.ts
lib/utils/petUtils.ts
lib/utils/priceValidation.ts
lib/utils/purchaseLinks.ts
lib/utils/purchaseTracking.ts
lib/utils/ratings.ts
lib/utils/recipeIngredients.ts
lib/utils/recipeRecommendations.ts
lib/utils/recipeScoring.ts
lib/utils/scoringDiagnostics.ts
lib/utils/scoringTransparency.ts
lib/utils/telemetry.ts
lib/utils/validation.ts
lib/validation/asinClusterer.ts
lib/validation/enhancedRetailValidator.ts
lib/validation/petSchema.ts
lib/validation/retailSpecDefinitions.ts
lib/validation/retailValidator.ts
lib/validation/tokenEquivalence.ts
middleware.tsx
PetPlates
PHASE_1_5_MANUAL_REVIEW.csv
postcss.config.js
scripts/add-all-vetted-products.ts
scripts/add-quantities-manual.js
scripts/add-species-to-vetted-products.ts
scripts/addRecipeImages.ts
scripts/amazon-api-search.ts
scripts/analyze-emoji-grids.py
scripts/analyze-emoji-images.py
scripts/analyze-ingredient-costs-by-pet.ts
scripts/analyze-missing-ingredients.ts
scripts/audit-all-purchase-links.ts
scripts/audit-amazon-links.js
scripts/audit-ingredient-protein.ts
scripts/audit-purchase-links.ts
scripts/audit-vetted-products.ts
scripts/auto-correct-asins.ts
scripts/auto-tag-recipes.ts
scripts/buildIngredients.js
scripts/check-link-health.ts
scripts/check-price-coverage.ts
scripts/check-protein-role.ts
scripts/classify-cost-tiers.ts
scripts/correct-asins-scraper.ts
scripts/data/analyze-brands.js
scripts/data/extract-recipes.js
scripts/data/fetch-prices-from-asins.js
scripts/data/remove_all_celebrity.py
scripts/debug-cats.ts
scripts/debug-ingredient-scores.ts
scripts/debug-protein-scoring.ts
scripts/debug-recipe-selection.ts
scripts/debugScoreHarness.ts
scripts/diagnose-ingredient-links.ts
scripts/diagnose-scoring.ts
scripts/enhance-recipes.ts
scripts/export-all-ingredient-links.mjs
scripts/export-ingredient-links.ts
scripts/extract-asins.js
scripts/extract-quantities.js
scripts/fetch-product-prices-batch.ts
scripts/fetch-product-prices.ts
scripts/find-better-emoji-images.py
scripts/find-highest-protein.ts
scripts/fix-affiliate-links.mjs
scripts/fix-emoji-colors.py
scripts/fix-string-escaping.js
scripts/fix-string-escaping.mjs
scripts/generate-brand-suggestions.ts
scripts/generate-celebrity-names.ts.disabled
scripts/generate-recipes.ts
scripts/generate-verification-state.ts
scripts/generation/generate_celebrity_pets.py
scripts/generation/generate_ingredient_images.py
scripts/generation/generate_mascot_emojis.py
scripts/generation/generate_meal_images.py
scripts/generation/generate-recipes.js
scripts/invert-emoji-colors.py
scripts/maintenance/add-quantities.js
scripts/maintenance/fix_now.js
scripts/maintenance/fix-all-js-imports.cjs
scripts/maintenance/fix-all-js-imports.js
scripts/maintenance/fix-apostrophes.js
scripts/maintenance/fix-imports.js
scripts/maintenance/fix-prices-standalone.js
scripts/maintenance/simple-price-test.js
scripts/maintenance/simple-replace-prices.js
scripts/maintenance/update-contribution.ts
scripts/maintenance/update-prices-asins.cjs
scripts/maintenance/update-types.ts
scripts/make-product-names-generic.ts
scripts/process-scraped-data.js
scripts/rank-product-prices.js
scripts/regenerate-recipe-names.ts
scripts/regenerate-recipes-cost-aware.ts
scripts/run-amazon-scraper.ts
scripts/run-scrapers.js
scripts/scan-price-outliers.ts
scripts/simple-replace-prices.js
scripts/split-best-emojis.py
scripts/split-emoji-grids.py
scripts/split-mascot-faces.py
scripts/split-new-amojis.py
scripts/split-new-best-emojis.py
scripts/test-all-species.ts
scripts/test-price-fetch.ts
scripts/test-recipe-diversity.ts
scripts/test-scoring.js
scripts/test-tsx.ts
scripts/testing/check-errors.ps1
scripts/testing/check-links.ts
scripts/testing/debug-cat-categories.mjs
scripts/testing/debug-cat-ingredients.mjs
scripts/testing/debug-cat-recipe-generation.mjs
scripts/testing/debug-protein-filter.mjs
scripts/testing/debug-shopping-list.js
scripts/testing/test-amazon-search.js
scripts/testing/test-asin-count.js
scripts/testing/test-automatic-research.js
scripts/testing/test-enhance.ts
scripts/testing/test-final.ts
scripts/testing/test-functions.js
scripts/testing/test-imports.ts
scripts/testing/test-integration.js
scripts/testing/test-link.js
scripts/testing/test-recipe-diversity.ts
scripts/testing/test-script.ts
scripts/training/add-manual-products.ts
scripts/training/canonicalize-commercial.ts
scripts/training/canonicalize-recipes.ts
scripts/training/compute-commercial-priors.ts
scripts/training/extract-commercial-patterns.ts
scripts/training/extract-patterns.ts
scripts/training/extract-top-ingredients.ts
scripts/training/llm-label-recipes.ts
scripts/training/run-commercial-training.ps1
scripts/training/run-training-pipeline.ps1
scripts/training/run-training-pipeline.sh
scripts/training/scrape-commercial.ts
scripts/update-recipe-meal-images.ts
scripts/update-vetted-products-by-link.js
scripts/update-vetted-products-simple.ts
scripts/update-vetted-products-with-asins.js
scripts/update-vetted-products-with-prices-v2.ts
scripts/update-vetted-products-with-prices.ts
scripts/updateRecipeImages.js
scripts/validate-affiliate-links.ts
scripts/validate-buy-links-intent.mjs
scripts/validate-recipes.ts
scripts/validate-species-products.ts
scripts/verify-asin-accuracy.ts
scripts/vet-all-recipes.ts
src/utils/nutrition-data.ts
start.ps1
start.sh
tailwind.config.ts
tests/recipe-generation.test.ts
update_prompts.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="__tests__/integration/purchase-flow.test.ts">
// __tests__/integration/purchase-flow.test.ts
// Integration tests for complete purchase flow from recipe to cart

import { describe, it, expect } from 'vitest';
import { getVettedProduct } from '@/lib/data/vetted-products';
import { 
  ensureSellerId, 
  ensureCartUrlSellerId, 
  extractASIN,
  hasSellerId 
} from '@/lib/utils/affiliateLinks';

describe('Purchase Flow Integration', () => {
  const SELLER_ID = 'robinfrench-20';

  describe('Recipe to Vetted Product Flow', () => {
    it('should map recipe ingredient to vetted product with seller ID', () => {
      const ingredientName = 'ground chicken';
      const product = getVettedProduct(ingredientName);
      
      expect(product).toBeDefined();
      expect(product?.productName).toBeDefined();
      expect(product?.asinLink).toBeDefined();
      expect(hasSellerId(product?.asinLink)).toBe(true);
    });

    it('should have seller ID in all vetted product links', () => {
      // Test sample of common ingredients
      const commonIngredients = [
        'ground chicken',
        'ground turkey',
        'salmon (boneless)',
        'sweet potato',
        'carrots',
        'spinach',
      ];

      commonIngredients.forEach(ingredient => {
        const product = getVettedProduct(ingredient);
        if (product?.asinLink) {
          expect(hasSellerId(product.asinLink)).toBe(true);
        }
      });
    });

    it('should use specific ASIN links (not search URLs)', () => {
      const ingredientName = 'ground chicken';
      const product = getVettedProduct(ingredientName);
      
      if (product?.asinLink) {
        expect(product.asinLink).not.toContain('/s?k=');
        expect(product.asinLink).not.toContain('/s?');
        expect(product.asinLink).toMatch(/\/dp\/[A-Z0-9]{10}|\/gp\/product\/[A-Z0-9]{10}/);
      }
    });
  });

  describe('Cart URL Generation Flow', () => {
    it('should generate valid cart URL with seller ID for multiple items', () => {
      const ingredients = ['ground chicken', 'sweet potato', 'carrots'];
      const cartItems: string[] = [];

      ingredients.forEach((name, idx) => {
        const product = getVettedProduct(name);
        if (product?.asinLink) {
          const asin = extractASIN(product.asinLink);
          if (asin) {
            cartItems.push(`ASIN.${idx + 1}=${asin}&Quantity.${idx + 1}=1`);
          }
        }
      });

      expect(cartItems.length).toBeGreaterThan(0);

      const cartUrl = `https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`;
      const safeCartUrl = ensureCartUrlSellerId(cartUrl);

      expect(safeCartUrl).toContain('AssociateTag=robinfrench-20');
      expect(safeCartUrl).toContain('gp/aws/cart/add.html');
    });

    it('should extract ASINs correctly from vetted product links', () => {
      const ingredientName = 'ground chicken';
      const product = getVettedProduct(ingredientName);
      
      if (product?.asinLink) {
        const asin = extractASIN(product.asinLink);
        expect(asin).toBeTruthy();
        expect(asin?.length).toBe(10);
        expect(asin).toMatch(/^[A-Z0-9]{10}$/);
      }
    });

    it('should preserve ASINs when generating cart URL', () => {
      const ingredients = ['ground chicken', 'ground turkey'];
      const asins: string[] = [];

      ingredients.forEach(name => {
        const product = getVettedProduct(name);
        if (product?.asinLink) {
          const asin = extractASIN(product.asinLink);
          if (asin) {
            asins.push(asin);
          }
        }
      });

      const cartItems = asins.map((asin, idx) => 
        `ASIN.${idx + 1}=${asin}&Quantity.${idx + 1}=1`
      );
      const cartUrl = `https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`;
      const safeCartUrl = ensureCartUrlSellerId(cartUrl);

      // Verify all ASINs are still in the URL
      asins.forEach(asin => {
        expect(safeCartUrl).toContain(asin);
      });
    });
  });

  describe('Seller ID Propagation', () => {
    it('should propagate seller ID through entire flow', () => {
      // Simulate complete flow
      const ingredientName = 'ground chicken';
      
      // Step 1: Get vetted product
      const product = getVettedProduct(ingredientName);
      expect(product).toBeDefined();
      
      // Step 2: Verify vetted product has seller ID
      if (product?.asinLink) {
        expect(hasSellerId(product.asinLink)).toBe(true);
        
        // Step 3: Apply utility function (safety check)
        const safeLink = ensureSellerId(product.asinLink);
        expect(hasSellerId(safeLink)).toBe(true);
        
        // Step 4: Verify link is still valid
        expect(safeLink).toContain('amazon.com');
        expect(safeLink).toContain(SELLER_ID);
      }
    });

    it('should handle missing seller ID gracefully', () => {
      // Test with link that might not have seller ID
      const testLink = 'https://www.amazon.com/dp/B0123456789';
      const safeLink = ensureSellerId(testLink);
      
      expect(hasSellerId(safeLink)).toBe(true);
      expect(safeLink).toContain(SELLER_ID);
    });

    it('should replace wrong seller ID with ours', () => {
      const testLink = 'https://www.amazon.com/dp/B0123456789?tag=wrong-id-20';
      const safeLink = ensureSellerId(testLink);
      
      expect(hasSellerId(safeLink)).toBe(true);
      expect(safeLink).not.toContain('wrong-id-20');
      expect(safeLink).toContain(SELLER_ID);
    });
  });

  describe('Multiple Pet Shopping Flow', () => {
    it('should handle multiple ingredients from different recipes', () => {
      const recipeIngredients = [
        { name: 'ground chicken', recipeId: 'recipe1' },
        { name: 'sweet potato', recipeId: 'recipe1' },
        { name: 'ground turkey', recipeId: 'recipe2' },
        { name: 'carrots', recipeId: 'recipe2' },
      ];

      const allLinks: string[] = [];

      recipeIngredients.forEach(ing => {
        const product = getVettedProduct(ing.name);
        if (product?.asinLink) {
          allLinks.push(ensureSellerId(product.asinLink));
        }
      });

      // Verify all links have seller ID
      allLinks.forEach(link => {
        expect(hasSellerId(link)).toBe(true);
      });

      expect(allLinks.length).toBeGreaterThan(0);
    });
  });

  describe('Error Handling', () => {
    it('should handle missing vetted products gracefully', () => {
      const product = getVettedProduct('nonexistent-ingredient-xyz');
      expect(product).toBeUndefined();
    });

    it('should handle null/undefined links safely', () => {
      expect(ensureSellerId(null)).toBe('');
      expect(ensureSellerId(undefined)).toBe('');
      expect(ensureCartUrlSellerId(null)).toBe('');
      expect(hasSellerId(null)).toBe(false);
    });

    it('should handle malformed URLs gracefully', () => {
      const malformed = 'not-a-valid-url';
      const result = ensureSellerId(malformed);
      // Should not throw, may add tag anyway
      expect(result).toBeTruthy();
    });
  });

  describe('End-to-End Purchase Flow', () => {
    it('should complete full flow: recipe ‚Üí vetted product ‚Üí cart', () => {
      // Simulate complete purchase flow
      const mealIngredients = ['ground chicken', 'sweet potato', 'carrots'];
      const cartItems: string[] = [];

      mealIngredients.forEach((name, idx) => {
        // Get vetted product
        const product = getVettedProduct(name);
        
        if (product?.asinLink) {
          // Verify seller ID
          expect(hasSellerId(product.asinLink)).toBe(true);
          
          // Extract ASIN for cart
          const asin = extractASIN(product.asinLink);
          if (asin) {
            cartItems.push(`ASIN.${idx + 1}=${asin}&Quantity.${idx + 1}=1`);
          }
        }
      });

      expect(cartItems.length).toBe(mealIngredients.length);

      // Generate cart URL
      const cartUrl = `https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`;
      const safeCartUrl = ensureCartUrlSellerId(cartUrl);

      // Verify final URL
      expect(safeCartUrl).toContain('AssociateTag=robinfrench-20');
      expect(safeCartUrl).toContain('gp/aws/cart/add.html');
      
      // Verify all ASINs present
      mealIngredients.forEach(name => {
        const product = getVettedProduct(name);
        if (product?.asinLink) {
          const asin = extractASIN(product.asinLink);
          if (asin) {
            expect(safeCartUrl).toContain(asin);
          }
        }
      });
    });
  });
});
</file>

<file path=".gitattributes">
*.exe filter=lfs diff=lfs merge=lfs -text
</file>

<file path=".github/workflows/deploy.yml">
name: Deploy Next.js to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build static site
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
</file>

<file path=".github/workflows/main.yml">
name: Deploy Next.js to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build static site
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
node_modules/
/.pnp
.pnp.js
.yarn/install-state.gz

# testing
/coverage

# next.js
.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel/

# typescript
*.tsbuildinfo
next-env.d.ts

# clerk configuration (can include secrets)
/.clerk/

# generated images
images/
.vercel

# Auto-generated validation artifacts
.validation-output.log
.pre-commit-validation.log

# Keep manual review CSVs (tracked for audit trail)
# PHASE_*_MANUAL_REVIEW.csv - NOT ignored, these are tracked
# AUTO_CLASSIFICATION_REPORT.md - NOT ignored, these are tracked
</file>

<file path=".husky/pre-commit">
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for validating CSV and artifact changes
# Only runs if validation-related files are staged

echo "üîç Checking for validation-related changes..."

# Check if any validation files are staged
VALIDATION_FILES=$(git diff --cached --name-only | grep -E '(lib/validation|lib/data/vetted-products|retailSpecDefinitions)')

if [ -n "$VALIDATION_FILES" ]; then
  echo "üìã Validation files changed, running Phase 1.5 classifier..."
  
  # Run the classifier
  npx tsx lib/generator/Phase1_5_AutoClassify.ts > .pre-commit-validation.log 2>&1
  
  # Check if it succeeded
  if [ $? -eq 0 ]; then
    echo "‚úÖ Validation passed"
    
    # Stage the generated CSV if it exists
    if [ -f "PHASE_1_5_MANUAL_REVIEW.csv" ]; then
      git add PHASE_1_5_MANUAL_REVIEW.csv
      echo "üìä Staged updated PHASE_1_5_MANUAL_REVIEW.csv"
    fi
  else
    echo "‚ùå Validation failed - check .pre-commit-validation.log"
    exit 1
  fi
fi

# Check if CSV files are being committed
CSV_FILES=$(git diff --cached --name-only | grep '\.csv$')

if [ -n "$CSV_FILES" ]; then
  echo "‚ö†Ô∏è  CSV files being committed:"
  echo "$CSV_FILES"
  echo ""
  echo "Make sure these are intentional changes, not auto-generated artifacts."
  echo "Press Enter to continue or Ctrl+C to abort..."
  read
fi

echo "‚úÖ Pre-commit checks passed"
</file>

<file path=".no-cursor-worktrees">
disable
</file>

<file path="app/about/page.tsx">
import { Award, Heart, Users, CheckCircle, ChefHat } from 'lucide-react';
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'About Us - Vet-Approved Pet Meal Prep',
  description: 'Learn how Paw & Plate provides AAFCO & WSAVA compliant meal plans for dogs, cats, birds, reptiles, and pocket pets. Free personalized nutrition planning.',
  keywords: ['about pet meal prep', 'vet approved pet food', 'AAFCO compliant', 'pet nutrition platform'],
  openGraph: {
    title: 'About Paw & Plate - Vet-Approved Pet Meal Prep',
    description: 'AAFCO & WSAVA compliant meal plans for all pet types. Free personalized nutrition planning.',
  },
};

export default function AboutPage() {
  return (
    <div className="min-h-screen bg-background text-foreground">
      {/* Header */}
      <div className="bg-gradient-to-r from-green-800 to-green-900 text-white py-16 px-4">
        <div className="max-w-4xl mx-auto text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            About Paw & Plate
          </h1>
          <p className="text-xl text-gray-200">
            Fresh, personalized nutrition for pets we love
          </p>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-12">
        {/* Mission */}
        <div className="bg-surface rounded-lg shadow-md p-8 mb-8 border border-surface-highlight">
          <h2 className="text-3xl font-bold text-foreground mb-4">Our Mission</h2>
          <p className="text-lg text-gray-300 leading-relaxed mb-4">
            Paws & Plates was founded on a simple belief: our pets deserve the same quality nutrition we give ourselves.
            Just as meal prep has transformed human health, we're bringing that same personalized, 
            fresh-food approach to pet nutrition.
          </p>
          <p className="text-lg text-gray-300 leading-relaxed">
            Every recipe is scientifically formulated to meet AAFCO and WSAVA guidelines, ensuring your pet 
            gets complete, balanced nutrition tailored to their specific needs.
          </p>
        </div>

        {/* Values */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
          <div className="bg-surface rounded-lg shadow-md p-6">
            <Award className="text-primary-400 mb-4" size={40} />
            <h3 className="text-xl font-bold text-foreground mb-2">
              Science-Based
            </h3>
            <p className="text-gray-400">
              All recipes meet or exceed AAFCO and WSAVA nutritional standards, 
              developed with pet health specialist expertise.
            </p>
          </div>

          <div className="bg-surface rounded-lg shadow-md p-6">
            <Heart className="text-primary-400 mb-4" size={40} />
            <h3 className="text-xl font-bold text-foreground mb-2">
              Pet-First
            </h3>
            <p className="text-gray-400">
              Every decision we make prioritizes your pet's health, happiness, and wellbeing.
            </p>
          </div>

          <div className="bg-surface rounded-lg shadow-md p-6">
            <Users className="text-primary-400 mb-4" size={40} />
            <h3 className="text-xl font-bold text-foreground mb-2">
              Community Driven
            </h3>
            <p className="text-gray-400">
              Our recipes are refined based on feedback from thousands of pet parents like you.
            </p>
          </div>

          <div className="bg-surface rounded-lg shadow-md p-6">
            <CheckCircle className="text-primary-400 mb-4" size={40} />
            <h3 className="text-xl font-bold text-foreground mb-2">
              Transparency
            </h3>
            <p className="text-gray-400">
              Complete ingredient lists, full nutritional breakdowns, and clear sourcing information.
            </p>
          </div>
        </div>


        {/* Nutritional Standards */}
        <div className="bg-surface rounded-lg p-8 mb-8">
          <h2 className="text-3xl font-bold text-foreground mb-4">
            Our Nutritional Standards
          </h2>
          <p className="text-lg text-gray-300 leading-relaxed mb-6">
            We adhere to the highest standards in pet nutrition:
          </p>
          <ul className="space-y-3">
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>AAFCO Guidelines:</strong> All recipes meet Association of American Feed Control Officials standards
              </span>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>WSAVA Recommendations:</strong> Aligned with World Small Animal Veterinary Association best practices
              </span>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>Pet Specialist Reviewed:</strong> Recipes developed and reviewed by pet nutritionists
              </span>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>Regular Updates:</strong> Formulations updated as new research emerges
              </span>
            </li>
          </ul>
        </div>

        {/* Vetting Process */}
        <div className="bg-surface rounded-lg shadow-md p-8 mb-8">
          <h2 className="text-3xl font-bold text-foreground mb-4">
            How We Choose Your Ingredients: The Vetted Vetting Process
          </h2>
          <p className="text-lg text-gray-300 leading-relaxed mb-6">
            When you see a specific product recommendation (e.g., "Brand X Fish Oil") instead of a generic item (e.g., "Fish Oil"),
            it means that item has passed our three-tiered pet health specialist screening process.
          </p>
          <p className="text-lg text-gray-300 leading-relaxed mb-6">
            Our goal is to ensure that the products you purchase are as safe and high-quality as the recipes you cook.
            We select the "best pick" for every core ingredient based on:
          </p>
          <ul className="space-y-4 mb-6">
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>Safety & Purity:</strong> Every supplement and oil is vetted for third-party testing (e.g., heavy metal or contaminant checks) to guarantee safety. We choose minimal processing where possible.
              </span>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>Nutritional Superiority:</strong> We prioritize sourcing that maximizes the intended benefit‚Äîfor instance, choosing low-fat meats for sensitive pets or specific fish (like Wild-Caught Alaskan Salmon) for high Omega-3 concentration.
              </span>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-400 flex-shrink-0 mt-1" size={20} />
              <span className="text-gray-300">
                <strong>Dietary Completeness:</strong> For foundational components like multi-vitamin/mineral mixes, we exclusively select professionally formulated products that meet AAFCO/FEDIAF standards to guarantee your homemade meal is 100% balanced and complete.
              </span>
            </li>
          </ul>
          <p className="text-lg text-gray-300 leading-relaxed">
            Our shopping list is designed to be a recommendation from a pet health specialist, not just a search result.
          </p>
        </div>

        {/* Why Paws & Plates */}
        <div className="bg-surface border border-surface-highlight rounded-lg p-8">
          <h2 className="text-3xl font-bold text-foreground mb-6">
            Why Paws & Plates?
          </h2>
          <p className="text-lg text-gray-300 leading-relaxed mb-8">
            The global pet food market is undergoing a dramatic shift toward fresh, human-grade diets, growing at 20% CAGR.
            But this transition creates significant challenges for pet owners. Here's how Paws & Plates solves the key problems:
          </p>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            {/* Problem 1 */}
            <div className="bg-surface rounded-lg p-5 shadow-sm border border-surface-highlight hover:shadow-md transition-shadow">
              <div className="flex items-center gap-3 mb-3">
                <div className="bg-red-100 text-red-600 rounded-full p-2 flex-shrink-0">
                  <span className="text-xl">‚ö†Ô∏è</span>
                </div>
                <h3 className="text-lg font-bold text-foreground">
                  Information Overload
                </h3>
              </div>
              <p className="text-sm text-gray-300 mb-3">
                Pet owners face analysis paralysis from countless conflicting recipes, blogs, and studies online.
              </p>
              <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                <h4 className="font-bold text-green-900 mb-1 text-sm">‚úÖ Our Solution:</h4>
                <p className="text-green-800 text-sm">
                  <strong>Single authoritative platform</strong> with 1000+ vet-reviewed recipes featuring real nutritional
                  calculations and compatibility scoring.
                </p>
              </div>
            </div>

            {/* Problem 2 */}
            <div className="bg-surface rounded-lg p-5 shadow-sm border border-surface-highlight hover:shadow-md transition-shadow">
              <div className="flex items-center gap-3 mb-3">
                <div className="bg-red-100 text-red-600 rounded-full p-2 flex-shrink-0">
                  <span className="text-xl">üè•</span>
                </div>
                <h3 className="text-lg font-bold text-foreground">
                  Specialist Skepticism
                </h3>
              </div>
              <p className="text-sm text-gray-300 mb-3">
                Pet health specialists worry about homemade diets due to risks of nutritional imbalance and missing essential minerals.
              </p>
              <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                <h4 className="font-bold text-green-900 mb-1 text-sm">‚úÖ Our Solution:</h4>
                <p className="text-green-800 text-sm">
                  <strong>Clinical-grade nutrition</strong> with AAFCO/WSAVA-compliant recipes and transparent nutritional breakdowns that specialists can trust.
                </p>
              </div>
            </div>

            {/* Problem 3 */}
            <div className="bg-surface rounded-lg p-5 shadow-sm border border-surface-highlight hover:shadow-md transition-shadow">
              <div className="flex items-center gap-3 mb-3">
                <div className="bg-red-100 text-red-600 rounded-full p-2 flex-shrink-0">
                  <span className="text-xl">üõí</span>
                </div>
                <h3 className="text-lg font-bold text-foreground">
                  Cooking Inconvenience
                </h3>
              </div>
              <p className="text-sm text-gray-300 mb-3">
                Time investment, shopping complexity, and meal prep work deter most from actually cooking fresh food.
              </p>
              <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                <h4 className="font-bold text-green-900 mb-1 text-sm">‚úÖ Our Solution:</h4>
                <p className="text-green-800 text-sm">
                  <strong>Seamless shopping</strong> with direct Amazon links, "Buy All" functionality, and interactive cooking mode with timers.
                </p>
              </div>
            </div>

            {/* Problem 4 */}
            <div className="bg-surface rounded-lg p-5 shadow-sm border border-surface-highlight hover:shadow-md transition-shadow">
              <div className="flex items-center gap-3 mb-3">
                <div className="bg-red-100 text-red-600 rounded-full p-2 flex-shrink-0">
                  <span className="text-xl">üéØ</span>
                </div>
                <h3 className="text-lg font-bold text-foreground">
                  Health Conditions
                </h3>
              </div>
              <p className="text-sm text-gray-300 mb-3">
                Most pets have specific health concerns that require non-generic diets. One-size-fits-all recipes fail these pets.
              </p>
              <div className="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                <h4 className="font-bold text-green-900 mb-1 text-sm">‚úÖ Our Solution:</h4>
                <p className="text-green-800 text-sm">
                  <strong>11 health conditions</strong> with dynamic recipe modifications, allergy-safe alternatives, and condition-specific supplements.
                </p>
              </div>
            </div>
          </div>

          <div className="mt-8 p-6 bg-green-900/20 border border-green-800/30 rounded-lg">
            <h3 className="text-xl font-bold mb-3 text-green-900">The Result: Fresh Food Made Simple</h3>
            <p className="text-green-800 leading-relaxed">
              Paws & Plates bridges the gap between pet owners' desire for fresh, healthy food and the nutritional
              safety veterinarians demand. We're not just another recipe site‚Äîwe're the trusted partner that makes
              homemade pet nutrition accessible, safe, and effective for every pet parent.
            </p>
          </div>
        </div>

        {/* Call to Action */}
        <div className="bg-gradient-to-r from-green-800 to-green-900 text-white rounded-lg p-8 text-center">
          <h2 className="text-3xl font-bold mb-4">Join Our Community</h2>
          <p className="text-xl text-gray-200 mb-6 max-w-2xl mx-auto">
            Be part of the movement that's transforming pet nutrition. Your ratings, reviews, and modifications
            help create better recipes for pets everywhere.
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="/forum"
              className="inline-flex items-center gap-2 px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors"
            >
              <Users className="w-5 h-5" />
              Join the Discussion
            </a>
            <a
              href="/forum/gallery"
              className="inline-flex items-center gap-2 px-6 py-3 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-green-800 transition-colors"
            >
              <ChefHat className="w-5 h-5" />
              Browse Modifications
            </a>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/api/amazon/purchase-confirmation/route.ts">
import { NextRequest, NextResponse } from 'next/server';

/**
 * Webhook endpoint to receive purchase confirmations from Amazon
 * Validates purchase confirmations and updates tracking
 * 
 * Note: This is a placeholder implementation.
 * In production, this would:
 * 1. Verify the webhook signature from Amazon
 * 2. Validate the purchase data
 * 3. Update the database with confirmed purchases
 * 4. Trigger village level updates
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { 
      userId, 
      orderId, 
      items, 
      signature, 
      timestamp 
    } = body;

    // TODO: Verify webhook signature
    // const isValid = verifyAmazonWebhookSignature(signature, body, timestamp);
    // if (!isValid) {
    //   return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
    // }

    // TODO: Validate purchase data
    if (!userId || !orderId || !items || !Array.isArray(items)) {
      return NextResponse.json(
        { error: 'Invalid purchase data' },
        { status: 400 }
      );
    }

    // TODO: Update database with confirmed purchases
    // For each item in items:
    //   - Find pending purchase record
    //   - Mark as confirmed
    //   - Add amazonOrderId
    //   - Update village level if threshold reached

    // Placeholder response
    return NextResponse.json({
      success: true,
      message: 'Purchase confirmation received',
      userId,
      orderId,
      itemsCount: items.length,
      note: 'Purchase confirmation is currently handled client-side. This endpoint is ready for Amazon Associates API integration.'
    });
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to process purchase confirmation' },
      { status: 500 }
    );
  }
}

/**
 * Verify Amazon webhook signature
 * This would implement proper signature verification in production
 */
function verifyAmazonWebhookSignature(
  signature: string,
  body: any,
  timestamp: string
): boolean {
  // TODO: Implement Amazon webhook signature verification
  // This would use the secret key to verify the signature
  return true; // Placeholder
}
</file>

<file path="app/api/purchases/route.ts">
import { NextRequest, NextResponse } from 'next/server';

/**
 * GET: Returns current purchase count and village level
 * POST: Manually confirm a purchase (for testing/fallback)
 */
export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const userId = searchParams.get('userId');

    if (!userId) {
      return NextResponse.json(
        { error: 'userId is required' },
        { status: 400 }
      );
    }

    // In a real implementation, this would query a database
    // For now, return a placeholder response
    // The actual data is stored in localStorage on the client side
    return NextResponse.json({
      message: 'Purchase data is stored client-side in localStorage',
      userId,
      note: 'Use getPurchaseStats() from lib/utils/purchaseTracking.ts on the client side'
    });
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to fetch purchase data' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { userId, ingredientId, ingredientName, amazonOrderId } = body;

    if (!userId || !ingredientId || !ingredientName) {
      return NextResponse.json(
        { error: 'userId, ingredientId, and ingredientName are required' },
        { status: 400 }
      );
    }

    // In a real implementation, this would update a database
    // For now, return a success response
    // The actual confirmation is handled client-side via confirmPurchase()
    return NextResponse.json({
      success: true,
      message: 'Purchase confirmed',
      userId,
      ingredientId,
      ingredientName,
      amazonOrderId,
      note: 'Purchase confirmation is handled client-side via confirmPurchase() from lib/utils/purchaseTracking.ts'
    });
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to confirm purchase' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/recipes/generate/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { generateRecipesForPet } from '@/lib/recipe-generator-v3';
import type { Pet } from '@/lib/types';

export const runtime = 'nodejs';

interface RecipeRequest {
  species?: string;
  count?: number;
  petProfile?: {
    name?: string;
    weight?: string;
    weightKg?: number;
    age?: string;
    allergies?: string[];
    healthConcerns?: string[];
  };
}

/**
 * Generate recipes dynamically based on pet species
 * POST /api/recipes/generate
 * Body: { species: 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets', count?: number, petProfile?: {...} }
 */
export async function POST(request: NextRequest) {
  try {
    const body: RecipeRequest = await request.json();
    const { species = 'dogs', count = 50, petProfile } = body;

    // Create a mock pet for recipe generation
    const mockPet: any = {
      id: `mock-${species}-${Date.now()}`,
      name: petProfile?.name || 'Your Pet',
      type: species,
      breed: 'Mixed',
      age: petProfile?.age || 'adult',
      weight: petProfile?.weight || '10',
      weightKg: petProfile?.weightKg || 10,
      allergies: petProfile?.allergies || [],
      healthConcerns: petProfile?.healthConcerns || [],
    };

    // Generate recipes using pragmatic system
    console.log('[API] Generating recipes for pet:', {
      name: mockPet.name,
      type: mockPet.type,
      healthConcerns: mockPet.healthConcerns,
      allergies: mockPet.allergies,
    });
    
    const recipes = generateRecipesForPet(
      {
        pet: mockPet as Pet,
      },
      count
    );

    console.log('[API] Generated recipes count:', recipes?.length || 0);

    const generatedRecipes = recipes.map((recipe: any, index: number) => ({
      ...recipe,
      id: recipe.id || `generated-${species}-${index}-${Date.now()}`,
      generatedAt: new Date().toISOString(),
    }));

    if (generatedRecipes.length === 0) {
      console.error('[API] No recipes generated - returning 500');
      return NextResponse.json(
        { error: 'Failed to generate any recipes', species, attemptedCount: count, petProfile: mockPet },
        { status: 500 }
      );
    }

    // Sort by overall score (best first)
    generatedRecipes.sort((a: any, b: any) => (b.scores?.overall || 0) - (a.scores?.overall || 0));

    return NextResponse.json({
      success: true,
      recipes: generatedRecipes,
      stats: {
        total: generatedRecipes.length,
        avgScore: (generatedRecipes.reduce((sum: number, r: any) => sum + (r.scores?.overall || 0), 0) / generatedRecipes.length).toFixed(1),
      },
    });
  } catch (error) {
    console.error('Recipe generation error:', error);
    return NextResponse.json(
      { error: 'Failed to generate recipes', details: String(error) },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/recommendations/route.ts">
import { NextResponse } from 'next/server';
import { generateModifiedRecommendations } from '@/lib/applyModifiers';
import { PetNutritionProfile } from '@/lib/types';
import { getRecommendedRecipes } from '@/lib/utils/recipeRecommendations';

const normalizeValue = (value?: string | null) => {
  const normalized = (value || '').trim().toLowerCase();
  // Replace multiple consecutive non-alphanumeric chars with single dash
  return normalized.replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
};

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { profile, recipeIds, limit, minCompatibilityScore } = body;

    // API request received

    if (!profile || !profile.species || !profile.ageGroup || !profile.weightKg) {
      return NextResponse.json(
        { error: 'Missing required profile fields (species, ageGroup, weightKg).' },
        { status: 400 }
      );
    }

    const bannedIngredients = (profile.bannedIngredients || []).map(normalizeValue);
    
    const normalizedProfile: PetNutritionProfile = {
      species: profile.species,
      ageGroup: normalizeValue(profile.ageGroup),
      weightKg: Number(profile.weightKg),
      breed: profile.breed || null,
      healthConcerns: (profile.healthConcerns || []).map(normalizeValue),
      allergies: (profile.allergies || []).map(normalizeValue),
      caloriesPerKgOverride: profile.caloriesPerKgOverride
        ? Number(profile.caloriesPerKgOverride)
        : undefined,
      petName: profile.petName,
    };
    
    // Helper to check if recipe contains banned ingredients
    const hasBannedIngredient = (recipe: any): boolean => {
      if (bannedIngredients.length === 0) return false;
      const recipeIngredients = (recipe.ingredients || []).map((ing: any) => {
        const name = typeof ing === 'string' ? ing : ing.name;
        return normalizeValue(name);
      });
      return bannedIngredients.some((banned: string) => 
        recipeIngredients.some((ing: string) => ing.includes(banned) || banned.includes(ing))
      );
    };

    // Helper to check if recipe contains allergens
    const hasAllergen = (recipe: any): boolean => {
      const allergies = normalizedProfile.allergies || [];
      if (allergies.length === 0) return false;
      const recipeIngredients = (recipe.ingredients || []).map((ing: any) => {
        const name = typeof ing === 'string' ? ing : ing.name;
        return normalizeValue(name);
      });
      return allergies.some((allergy: string) => 
        recipeIngredients.some((ing: string) => ing.includes(allergy) || allergy.includes(ing))
      );
    };

    if (Number.isNaN(normalizedProfile.weightKg) || normalizedProfile.weightKg <= 0) {
      return NextResponse.json(
        { error: 'weightKg must be a positive number.' },
        { status: 400 }
      );
    }

    let results: any[] = [];
    
    try {
      results = generateModifiedRecommendations({
        profile: normalizedProfile,
        recipeIds: recipeIds || [],
        limit: limit ?? 50,
        minCompatibilityScore: minCompatibilityScore ?? 30,
      });
      
      // Filter out recipes with banned ingredients and allergens
      results = results.filter(result => {
        const recipe = result.recipe;
        return !hasBannedIngredient(recipe) && !hasAllergen(recipe);
      });
    } catch (error) {
      // Error in generateModifiedRecommendations - handled below
      // Continue to fallback
    }

    // Fallback: If no results, use tiered recommendation system
    if (!Array.isArray(results) || results.length === 0) {
      const petForRecommendations = {
        id: '',
        name: normalizedProfile.petName || '',
        type: normalizedProfile.species,
        breed: normalizedProfile.breed || '',
        age: normalizedProfile.ageGroup,
        healthConcerns: normalizedProfile.healthConcerns || []
      };
      
      const tieredRecs = getRecommendedRecipes(petForRecommendations, limit ?? 10, true);
      
      // Filter out recipes with banned ingredients
      const filteredRecs = tieredRecs.filter(rec => !hasBannedIngredient(rec.recipe));
      
      // Convert tiered recommendations to ModifiedRecipeResult format
      results = filteredRecs.map(rec => ({
        recipe: rec.recipe,
        adjustedIngredients: rec.recipe.ingredients,
        appliedRules: [],
        nutritionChanges: {},
        portionPlan: {
          dailyGrams: normalizedProfile.weightKg * 20, // Rough estimate
          multiplier: 1,
          mealsPerDay: 2,
          notes: []
        },
        shoppingList: rec.recipe.ingredients.map(ing => ({
          name: ing.name,
          amount: ing.amount,
          asinLink: ing.asinLink || '',
          notes: '',
          category: 'Ingredient'
        })),
        explanation: `Recommended for ${normalizedProfile.petName || 'your pet'}: ${rec.tierLabel}`,
        weeklyPlan: [],
        score: rec.score,
        _tierLabel: rec.tierLabel,
        _warning: rec.warning,
        _healthMatch: rec.healthConcernMatch
      }));
    }
    
    // FALLBACK 2: If still empty, show general recipes for the species
    if (!Array.isArray(results) || results.length === 0) {
      // Both recommendation methods failed - using general recipes
      const generalRecipes = recipes
        .filter(r => {
          // Try to match by species (normalized)
          const normalizeSpecies = (s: string) => s.toLowerCase().replace(/s$/, '');
          const speciesMatch = normalizeSpecies(r.category) === normalizeSpecies(normalizedProfile.species);
          // Also filter out banned ingredients
          return speciesMatch && !hasBannedIngredient(r);
        })
        .slice(0, limit ?? 5)
        .map(r => ({
          recipe: r,
          adjustedIngredients: r.ingredients,
          appliedRules: [],
          nutritionChanges: {},
          portionPlan: {
            dailyGrams: normalizedProfile.weightKg * 20,
            multiplier: 1,
            mealsPerDay: 2,
            notes: ['General recommendation - consult vet']
          },
          shoppingList: r.ingredients.map(ing => ({
            name: ing.name,
            amount: ing.amount,
            asinLink: ing.asinLink || '',
            notes: 'General recommendation - consult vet',
            category: 'Ingredient'
          })),
          explanation: `${r.name} - General recommendation for ${normalizedProfile.petName || 'your pet'}. Please consult your veterinarian.`,
          weeklyPlan: [],
          score: 30, // Low score to indicate it's a general recommendation
          _tierLabel: 'General Recommendation',
          _warning: 'General recommendation - consult vet',
          _healthMatch: undefined
        }));
      
      results = generalRecipes;
    }

    // API returning recipes
    const totalFound = results.length;

    return NextResponse.json({ 
      results,
      totalFound,
      metadata: {
        filteredByCompatibility: true,
        minCompatibilityScore: minCompatibilityScore ?? 30,
        filteredByBannedIngredients: bannedIngredients.length > 0,
        filteredByAllergies: (normalizedProfile.allergies || []).length > 0,
      }
    });
  } catch (error) {
    console.error('Recommendation engine failure:', error);
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    return NextResponse.json(
      { error: `Unable to generate recommendations: ${errorMessage}` },
      { status: 500 }
    );
  }
}
</file>

<file path="app/asin-verification/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { Search, CheckCircle, AlertCircle, Edit2, ExternalLink, Download } from 'lucide-react';

// Import the real vetted products data
import { VETTED_PRODUCTS } from '@/lib/data/vetted-products';
import { INITIAL_VERIFICATION_STATE } from '@/lib/data/verification-state';

// Import automated correction suggestions (if available)
let AUTOMATED_CORRECTIONS = {};
try {
  const correctionsPath = './lib/data/vetted-products-CORRECTED.txt';
  // We'll load this dynamically if it exists
} catch (e) {
  // File doesn't exist yet
}

function extractASIN(url: string) {
  const match = url.match(/\/dp\/([A-Z0-9]{10})/);
  return match ? match[1] : null;
}

export default function ASINVerificationPage() {
  const [products, setProducts] = useState<any[]>([]);
  const [filter, setFilter] = useState('all');
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editData, setEditData] = useState<any>({});
  const [searchQuery, setSearchQuery] = useState('');

  useEffect(() => {
    // Convert vetted products to array format with initial verification state
    const productArray = Object.entries(VETTED_PRODUCTS).map(([ingredient, data]: [string, any]) => {
      const verificationState = INITIAL_VERIFICATION_STATE.find(v => v.ingredient === ingredient);

      return {
        id: ingredient,
        ingredient,
        productName: data.productName,
        amazonLink: data.asinLink || data.amazonLink,
        vetNote: data.vetNote,
        category: data.category,
        asin: extractASIN(data.asinLink || data.amazonLink),
        verified: verificationState?.verified || false,
        needsReview: verificationState?.needsReview || true,
        autoVerified: verificationState?.autoVerified || false,
        commissionRate: data.commissionRate,
        species: data.species,
        costTier: data.costTier
      };
    });
    setProducts(productArray);
  }, []);

  const filteredProducts = products.filter(p => {
    if (filter === 'needs-review') return p.needsReview;
    if (filter === 'verified') return p.verified;
    if (filter === 'auto-verified') return p.autoVerified;
    if (searchQuery) {
      return p.ingredient.toLowerCase().includes(searchQuery.toLowerCase()) ||
             p.productName.toLowerCase().includes(searchQuery.toLowerCase()) ||
             (p.category && p.category.toLowerCase().includes(searchQuery.toLowerCase()));
    }
    return true;
  });

  const startEdit = (product: any) => {
    setEditingId(product.id);
    setEditData({
      productName: product.productName,
      asin: product.asin,
      vetNote: product.vetNote
    });
  };

  const saveEdit = (id: string) => {
    setProducts(products.map(p => {
      if (p.id === id) {
        return {
          ...p,
          productName: editData.productName,
          asin: editData.asin,
          amazonLink: `https://www.amazon.com/dp/${editData.asin}?tag=robinfrench-20`,
          vetNote: editData.vetNote,
          verified: true,
          needsReview: false
        };
      }
      return p;
    }));
    setEditingId(null);
  };

  const markVerified = (id: string) => {
    setProducts(products.map(p =>
      p.id === id ? { ...p, verified: true, needsReview: false } : p
    ));
  };

  const exportCorrections = () => {
    const corrections = products
      .filter(p => p.verified)
      .map(p => ({
        ingredient: p.ingredient,
        productName: p.productName,
        asin: p.asin,
        amazonLink: p.amazonLink,
        vetNote: p.vetNote,
        category: p.category,
        commissionRate: p.commissionRate,
        species: p.species,
        costTier: p.costTier
      }));

    const tsCode = `// Corrected products - ${new Date().toISOString()}\n` +
      `export const CORRECTED_PRODUCTS: Record<string, any> = {\n` +
      corrections.map(c =>
        `  '${c.ingredient}': {\n` +
        `    productName: '${c.productName}',\n` +
        `    asinLink: '${c.amazonLink}',\n` +
        `    vetNote: '${c.vetNote}',\n` +
        `    category: '${c.category}',\n` +
        `    commissionRate: ${c.commissionRate},\n` +
        `    species: ${JSON.stringify(c.species)},\n` +
        `    costTier: '${c.costTier}'\n` +
        `  }`
      ).join(',\n') +
      '\n};';

    const blob = new Blob([tsCode], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'corrected-products.ts';
    a.click();
  };

  const stats = {
    total: products.length,
    verified: products.filter(p => p.verified).length,
    autoVerified: products.filter(p => p.autoVerified).length,
    manuallyVerified: products.filter(p => p.verified && !p.autoVerified).length,
    needsReview: products.filter(p => p.needsReview).length
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-slate-800 mb-2">
            ASIN Verification Tool
          </h1>
          <p className="text-slate-600">
            Review and correct product ASINs for your vetted products list
          </p>

          {/* Stats */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
            <div className="bg-blue-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
              <div className="text-sm text-blue-600">Total Products</div>
            </div>
            <div className="bg-green-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-green-600">{stats.verified}</div>
              <div className="text-sm text-green-600">Total Verified</div>
            </div>
            <div className="bg-emerald-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-emerald-600">{stats.autoVerified}</div>
              <div className="text-sm text-emerald-600">Auto-Verified</div>
            </div>
            <div className="bg-teal-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-teal-600">{stats.manuallyVerified}</div>
              <div className="text-sm text-teal-600">Manually Verified</div>
            </div>
            <div className="bg-orange-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-orange-600">{stats.needsReview}</div>
              <div className="text-sm text-orange-600">Needs Review</div>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="mt-4">
            <div className="flex justify-between text-sm text-slate-600 mb-1">
              <span>Verification Progress</span>
              <span>{stats.total > 0 ? Math.round((stats.verified / stats.total) * 100) : 0}% Complete</span>
            </div>
            <div className="w-full bg-slate-200 rounded-full h-2">
              <div
                className="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-300"
                style={{ width: `${stats.total > 0 ? (stats.verified / stats.total) * 100 : 0}%` }}
              ></div>
            </div>
          </div>
        </div>

        {/* Controls */}
        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
          <div className="flex gap-4 flex-wrap">
            <div className="flex-1 min-w-64">
              <div className="relative">
                <Search className="absolute left-3 top-3 text-slate-400 w-5 h-5" />
                <input
                  type="text"
                  placeholder="Search ingredients, products, or categories..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Products ({stats.total})</option>
              <option value="needs-review">Needs Review ({stats.needsReview})</option>
              <option value="verified">Verified ({stats.verified})</option>
              <option value="auto-verified">Auto-Verified ({products.filter(p => p.autoVerified).length})</option>
            </select>

            <button
              onClick={exportCorrections}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
              disabled={stats.verified === 0}
            >
              <Download className="w-4 h-4" />
              Export Corrections ({stats.verified})
            </button>
          </div>
        </div>

        {/* Products List */}
        <div className="space-y-4">
          {filteredProducts.map(product => (
            <div key={product.id} className={`bg-white rounded-xl shadow-lg p-6 ${product.needsReview ? 'border-l-4 border-orange-400' : 'border-l-4 border-green-400'}`}>
              {editingId === product.id ? (
                // Edit Mode
                <div className="space-y-4">
                  <div className="flex items-center gap-2 mb-4">
                    <h3 className="text-lg font-bold text-slate-800">
                      Editing: {product.ingredient}
                    </h3>
                    <span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-sm">
                      {product.category}
                    </span>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                      Product Name
                    </label>
                    <input
                      type="text"
                      value={editData.productName}
                      onChange={(e) => setEditData({...editData, productName: e.target.value})}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                      ASIN
                    </label>
                    <input
                      type="text"
                      value={editData.asin}
                      onChange={(e) => setEditData({...editData, asin: e.target.value})}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="B0XXXXXXXXX"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                      Vet Note
                    </label>
                    <textarea
                      value={editData.vetNote}
                      onChange={(e) => setEditData({...editData, vetNote: e.target.value})}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      rows={3}
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={() => saveEdit(product.id)}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                      Save Changes
                    </button>
                    <button
                      onClick={() => setEditingId(null)}
                      className="px-4 py-2 bg-slate-300 text-slate-700 rounded-lg hover:bg-slate-400"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              ) : (
                // View Mode
                <div>
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="text-xl font-bold text-slate-800">
                          {product.ingredient}
                        </h3>
                        {product.verified ? (
                          <span className="flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                            <CheckCircle className="w-4 h-4" />
                            {product.autoVerified ? 'Auto-Verified' : 'Verified'}
                          </span>
                        ) : (
                          <span className="flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">
                            <AlertCircle className="w-4 h-4" />
                            Needs Review
                          </span>
                        )}
                        <span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-sm">
                          {product.category}
                        </span>
                      </div>
                      <div className="text-slate-600 mb-2">
                        <strong>Product:</strong> {product.productName}
                      </div>
                      <div className="text-slate-600 mb-2">
                        <strong>ASIN:</strong> <code className="bg-slate-100 px-2 py-1 rounded">{product.asin}</code>
                      </div>
                      <div className="text-sm text-slate-500 mt-2">
                        {product.vetNote}
                      </div>
                    </div>

                    <div className="flex gap-2">
                      <a
                        href={product.amazonLink}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                        title="View on Amazon"
                      >
                        <ExternalLink className="w-5 h-5" />
                      </a>
                      <button
                        onClick={() => startEdit(product)}
                        className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                        title="Edit"
                      >
                        <Edit2 className="w-5 h-5" />
                      </button>
                      {!product.verified && (
                        <button
                          onClick={() => markVerified(product.id)}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                        >
                          Mark Verified
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Quick Actions */}
                  <div className="mt-4 pt-4 border-t border-slate-200">
                    <div className="text-sm text-slate-600 space-y-2">
                      <div>
                        <strong>Quick Search:</strong>{' '}
                        <a
                          href={`https://www.amazon.com/s?k=${encodeURIComponent(product.ingredient + ' for dogs')}&i=pet-supplies`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:underline"
                        >
                          Search "{product.ingredient}" on Amazon ‚Üí
                        </a>
                      </div>
                      <div>
                        <strong>ASIN Check:</strong>{' '}
                        <a
                          href={`https://www.amazon.com/dp/${product.asin}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:underline"
                        >
                          Verify current ASIN ‚Üí
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>

        {filteredProducts.length === 0 && (
          <div className="bg-white rounded-xl shadow-lg p-12 text-center">
            <p className="text-slate-500 text-lg">No products match your filters</p>
            <p className="text-slate-400 text-sm mt-2">
              Try adjusting your search query or filter settings
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/blog/[slug]/page.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { ArrowLeft, Calendar, Clock, User, Share2, Bookmark } from 'lucide-react';

interface BlogPost {
  id: string;
  title: string;
  content: string;
  author: string;
  date: string;
  readTime: string;
  category: string;
  image: string;
  tags: string[];
}

export default function BlogPostPage({ params }: { params: { slug: string } }) {
  // Mock blog post data - in real app, this would come from a CMS or database
  const blogPost: BlogPost = {
    id: params.slug,
    title: 'The Complete Guide to Homemade Dog Food: What Every Pet Parent Needs to Know',
    content: `
      <p className="text-lg text-gray-700 leading-relaxed mb-6">
        Making homemade dog food can be incredibly rewarding, but it requires careful planning to ensure your dog gets complete, balanced nutrition. This comprehensive guide will walk you through everything you need to know to safely prepare nutritious meals at home.
      </p>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">Why Choose Homemade Dog Food?</h2>
      <p className="text-gray-700 leading-relaxed mb-4">
        Commercial dog food has come a long way, but homemade meals offer several advantages:
      </p>
      <ul className="list-disc pl-6 mb-6 text-gray-700">
        <li>You know exactly what's in every meal</li>
        <li>You can accommodate specific allergies or sensitivities</li>
        <li>You can use higher-quality, fresher ingredients</li>
        <li>You can adjust recipes for specific health conditions</li>
        <li>You can control portion sizes and caloric intake</li>
      </ul>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">Essential Nutrients Your Dog Needs</h2>
      <p className="text-gray-700 leading-relaxed mb-4">
        Dogs require a balance of proteins, fats, carbohydrates, vitamins, and minerals. The key nutrients include:
      </p>

      <div className="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6">
        <h3 className="text-lg font-semibold text-blue-900 mb-2">Macronutrients</h3>
        <ul className="text-blue-800">
          <li><strong>Protein:</strong> 18-25% of diet (muscle maintenance, enzyme production)</li>
          <li><strong>Fat:</strong> 10-15% of diet (energy, skin/coat health, vitamin absorption)</li>
          <li><strong>Carbohydrates:</strong> 30-50% of diet (energy, fiber for digestion)</li>
        </ul>
      </div>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">Getting Started: Basic Recipe Template</h2>
      <p className="text-gray-700 leading-relaxed mb-4">
        Start with this simple template and adjust based on your dog's specific needs:
      </p>

      <div className="bg-gray-100 p-6 rounded-lg mb-6">
        <h3 className="font-semibold text-gray-900 mb-4">Basic Homemade Dog Food Recipe</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <h4 className="font-medium text-gray-900 mb-2">Protein Source (50%)</h4>
            <ul className="text-gray-700">
              <li>‚Ä¢ Ground chicken or turkey</li>
              <li>‚Ä¢ Lean beef or lamb</li>
              <li>‚Ä¢ Fish (canned in water)</li>
            </ul>
          </div>
          <div>
            <h4 className="font-medium text-gray-900 mb-2">Vegetables (25%)</h4>
            <ul className="text-gray-700">
              <li>‚Ä¢ Sweet potatoes</li>
              <li>‚Ä¢ Carrots</li>
              <li>‚Ä¢ Green beans</li>
              <li>‚Ä¢ Pumpkin</li>
            </ul>
          </div>
          <div>
            <h4 className="font-medium text-gray-900 mb-2">Carbs (20%)</h4>
            <ul className="text-gray-700">
              <li>‚Ä¢ Brown rice</li>
              <li>‚Ä¢ Quinoa</li>
              <li>‚Ä¢ Oatmeal</li>
            </ul>
          </div>
          <div>
            <h4 className="font-medium text-gray-900 mb-2">Supplements (5%)</h4>
            <ul className="text-gray-700">
              <li>‚Ä¢ Fish oil</li>
              <li>‚Ä¢ Calcium supplement</li>
              <li>‚Ä¢ Vitamin/mineral mix</li>
            </ul>
          </div>
        </div>
      </div>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">Common Mistakes to Avoid</h2>
      <div className="space-y-4 mb-6">
        <div className="border-l-4 border-red-500 bg-red-50 p-4">
          <h3 className="font-semibold text-red-900">Over-Supplementation</h3>
          <p className="text-red-800">Too many vitamins can be as harmful as deficiencies. Stick to veterinary-recommended amounts.</p>
        </div>
        <div className="border-l-4 border-red-500 bg-red-50 p-4">
          <h3 className="font-semibold text-red-900">Ignoring Calcium-Phosphorus Balance</h3>
          <p className="text-red-800">This ratio is crucial for bone health. Most homemade diets need calcium supplementation.</p>
        </div>
        <div className="border-l-4 border-red-500 bg-red-50 p-4">
          <h3 className="font-semibold text-red-900">Sudden Diet Changes</h3>
          <p className="text-red-800">Transition gradually over 7-10 days to avoid digestive upset.</p>
        </div>
      </div>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">When to Consult a Veterinarian</h2>
      <p className="text-gray-700 leading-relaxed mb-4">
        While homemade dog food can be excellent, certain situations require professional guidance:
      </p>
      <ul className="list-disc pl-6 mb-6 text-gray-700">
        <li>Puppies or senior dogs with specific nutritional needs</li>
        <li>Dogs with health conditions (kidney disease, diabetes, allergies)</li>
        <li>Breed-specific requirements (large/giant breeds, brachycephalic dogs)</li>
        <li>If your dog shows signs of nutritional deficiencies</li>
      </ul>

      <div className="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
        <h3 className="text-lg font-semibold text-green-900 mb-2">üí° Pro Tip</h3>
        <p className="text-green-800">
          Start with commercially available vitamin/mineral mixes formulated for homemade diets. These take the guesswork out of supplementation and ensure complete nutrition.
        </p>
      </div>

      <h2 className="text-2xl font-bold text-gray-900 mt-8 mb-4">Sample Recipes to Get Started</h2>
      <p className="text-gray-700 leading-relaxed mb-6">
        Here are three balanced recipes for different life stages. Each serves one adult dog for one day.
      </p>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="font-bold text-gray-900 mb-3">Adult Maintenance</h3>
          <ul className="text-sm text-gray-700 space-y-1">
            <li>1 lb ground chicken</li>
            <li>1 cup sweet potato</li>
            <li>1 cup carrots</li>
            <li>¬Ω cup brown rice</li>
            <li>1 tbsp fish oil</li>
            <li>Calcium supplement</li>
          </ul>
        </div>
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="font-bold text-gray-900 mb-3">Weight Management</h3>
          <ul className="text-sm text-gray-700 space-y-1">
            <li>¬æ lb ground turkey</li>
            <li>2 cups zucchini</li>
            <li>1 cup green beans</li>
            <li>¬Ω cup quinoa</li>
            <li>¬Ω tbsp fish oil</li>
            <li>Calcium supplement</li>
          </ul>
        </div>
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="font-bold text-gray-900 mb-3">Senior Dog</h3>
          <ul className="text-sm text-gray-700 space-y-1">
            <li>¬æ lb ground chicken</li>
            <li>1 cup pumpkin</li>
            <li>1 cup carrots</li>
            <li>¬Ω cup oatmeal</li>
            <li>1 tbsp fish oil</li>
            <li>Joint supplement</li>
            <li>Calcium supplement</li>
          </ul>
        </div>
      </div>

      <p className="text-gray-700 leading-relaxed mb-8">
        Remember, these are starting points. Every dog is unique, and their nutritional needs can vary based on age, activity level, health status, and individual metabolism. When in doubt, consult with a pet health specialist to create a diet perfectly tailored to your dog's needs.
      </p>
    `,
    author: 'Dr. Sarah Mitchell, DVM',
    date: '2024-11-20',
    readTime: '8 min read',
    category: 'Nutrition',
    image: '/images/emojis/Mascots/Prep Puppy.jpg',
    tags: ['homemade dog food', 'nutrition', 'recipes', 'pet health specialist advice']
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Navigation */}
      <div className="bg-white border-b border-gray-200">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <Link
            href="/blog"
            className="inline-flex items-center gap-2 text-green-800 hover:text-green-900 font-medium"
          >
            <ArrowLeft className="w-4 h-4" />
            Back to Blog
          </Link>
        </div>
      </div>

      <article className="max-w-4xl mx-auto px-4 py-8">
        {/* Header */}
        <header className="mb-8">
          <div className="flex items-center gap-4 text-sm text-gray-500 mb-4">
            <span className="bg-green-900/20 text-green-800 px-3 py-1 rounded-full">
              {blogPost.category}
            </span>
            <div className="flex items-center gap-1">
              <Calendar className="w-4 h-4" />
              {new Date(blogPost.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </div>
            <div className="flex items-center gap-1">
              <Clock className="w-4 h-4" />
              {blogPost.readTime}
            </div>
          </div>

          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-6 leading-tight">
            {blogPost.title}
          </h1>

          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-green-900/20 rounded-full flex items-center justify-center">
                <User className="w-6 h-6 text-green-800" />
              </div>
              <div>
                <div className="font-semibold text-gray-900">{blogPost.author}</div>
                <div className="text-sm text-gray-600">Pet Health Specialist</div>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <button className="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                <Share2 className="w-5 h-5" />
              </button>
              <button className="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                <Bookmark className="w-5 h-5" />
              </button>
            </div>
          </div>
        </header>

        {/* Featured Image */}
        <div className="mb-8 relative w-full h-64 md:h-96">
          <Image
            src={blogPost.image}
            alt={blogPost.title}
            fill
            className="object-cover rounded-lg shadow-lg"
            priority
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px"
          />
        </div>

        {/* Content */}
        <div
          className="prose prose-lg max-w-none"
          dangerouslySetInnerHTML={{ __html: blogPost.content }}
        />

        {/* Tags */}
        <div className="mt-8 pt-8 border-t border-gray-200">
          <div className="flex flex-wrap gap-2">
            {blogPost.tags.map((tag) => (
              <span
                key={tag}
                className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm"
              >
                #{tag}
              </span>
            ))}
          </div>
        </div>

        {/* Author Bio */}
        <div className="mt-8 bg-gray-100 rounded-lg p-6">
          <div className="flex items-start gap-4">
            <div className="w-16 h-16 bg-green-900/20 rounded-full flex items-center justify-center flex-shrink-0">
              <User className="w-8 h-8 text-green-800" />
            </div>
            <div>
              <h3 className="font-semibold text-gray-900 mb-1">{blogPost.author}</h3>
              <p className="text-gray-600 text-sm mb-3">
                Dr. Mitchell is a board-certified pet health specialist with over 15 years of experience
                helping pet parents create balanced homemade diets. She specializes in preventive nutrition
                and works with pets of all species.
              </p>
              <Link
                href="/about"
                className="text-green-800 hover:text-green-900 font-medium text-sm"
              >
                Learn more about our pet health specialist team ‚Üí
              </Link>
            </div>
          </div>
        </div>

        {/* Related Posts */}
        <div className="mt-12">
          <h3 className="text-2xl font-bold text-gray-900 mb-6">Related Articles</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Link
              href="/blog/cat-nutrition-myths-debunked"
              className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
            >
              <h4 className="font-semibold text-gray-900 mb-2">
                Cat Nutrition Myths Debunked
              </h4>
              <p className="text-gray-600 text-sm">
                Separating fact from fiction in feline nutrition...
              </p>
            </Link>
            <Link
              href="/blog/supplements-every-pet-needs"
              className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
            >
              <h4 className="font-semibold text-gray-900 mb-2">
                Essential Supplements Every Pet Needs
              </h4>
              <p className="text-gray-600 text-sm">
                Not all pets need supplements, but many benefit...
              </p>
            </Link>
          </div>
        </div>
      </article>
    </div>
  );
}
</file>

<file path="app/blog/page.tsx">
import Link from 'next/link';
import { Clock } from 'lucide-react';

export default function BlogPage() {
  const blogPosts = [
    {
      id: 'complete-guide-homemade-dog-food',
      title: 'The Complete Guide to Homemade Dog Food: What Every Pet Parent Needs to Know',
      excerpt: 'Learn how to safely transition your dog to homemade meals while ensuring complete nutrition. Our pet health specialist-approved guide covers everything from ingredient selection to portion calculations.',
      author: 'Dr. Sarah Mitchell, DVM',
      date: '2024-11-20',
      readTime: '8 min read',
      category: 'Nutrition'
    },
    {
      id: 'cat-nutrition-myths-debunked',
      title: 'Cat Nutrition Myths Debunked: Separating Fact from Fiction',
      excerpt: 'From "cats need milk" to "raw diets are dangerous," we examine common misconceptions about feline nutrition and provide evidence-based guidance.',
      author: 'Dr. Michael Chen, Pet Health Specialist',
      date: '2024-11-18',
      readTime: '6 min read',
      category: 'Myths',
    },
    {
      id: 'fresh-pet-food-market-trends',
      title: 'The Rise of Fresh Pet Food: Market Trends and What They Mean for Your Pet',
      excerpt: 'The pet food industry is undergoing a revolution. Discover the latest trends in fresh, human-grade pet nutrition and how to choose the best options.',
      author: 'Emma Rodriguez, Pet Industry Analyst',
      date: '2024-11-15',
      readTime: '5 min read',
      category: 'Industry',
    },
    {
      id: 'supplements-every-pet-needs',
      title: 'Essential Supplements Every Pet Needs (And Why)',
      excerpt: 'Not all pets need supplements, but many benefit from targeted nutritional support. Learn which supplements are essential and how to choose quality products.',
      author: 'Dr. James Park, Pet Health Researcher',
      date: '2024-11-12',
      readTime: '7 min read',
      category: 'Supplements',
    },
    {
      id: 'reading-pet-food-labels',
      title: 'How to Read Pet Food Labels Like a Pro',
      excerpt: 'Pet food labels can be confusing, but they contain crucial information about nutrition. Master the art of label reading to make informed choices.',
      author: 'Lisa Thompson, Pet Nutrition Consultant',
      date: '2024-11-10',
      readTime: '4 min read',
      category: 'Education',
    },
    {
      id: 'seasonal-pet-nutrition',
      title: 'Seasonal Pet Nutrition: Adjusting Diets for Winter, Summer, and Everything In Between',
      excerpt: 'Your pet\'s nutritional needs change with the seasons. Learn how to adjust their diet for optimal health year-round.',
      author: 'Dr. Rachel Green, Holistic Veterinarian',
      date: '2024-11-08',
      readTime: '6 min read',
      category: 'Seasonal',
    }
  ];

  const categories = ['All', 'Nutrition', 'Myths', 'Industry', 'Supplements', 'Education', 'Seasonal'];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-green-800 to-green-900 text-white py-12 px-4">
        <div className="max-w-4xl mx-auto text-center">
          <h1 className="text-3xl md:text-4xl font-bold mb-3">
            Pet Nutrition Blog
          </h1>
          <p className="text-lg text-gray-200">
            Expert insights, research-backed advice, and the latest in pet nutrition science
          </p>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-8">
        {/* Category Filter */}
        <div className="flex flex-wrap gap-2 mb-6 justify-center">
          {categories.map((category) => (
            <button
              key={category}
              className="px-4 py-2 bg-white border border-gray-300 rounded-full text-sm font-medium hover:bg-gray-100 hover:border-gray-400 transition-colors"
            >
              {category}
            </button>
          ))}
        </div>

        {/* Blog Posts List - Reddit Style */}
        <div className="space-y-4">
          {blogPosts.map((post) => (
            <article key={post.id} className="bg-white rounded border border-gray-200 hover:border-gray-300 transition-colors">
              <div className="p-4">
                <div className="flex items-start gap-3">
                  {/* Left side - voting area (optional, can be removed) */}
                  <div className="flex flex-col items-center pt-1">
                    <button className="text-gray-400 hover:text-green-600 transition-colors">
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" />
                      </svg>
                    </button>
                    <span className="text-xs text-gray-500 mt-1">0</span>
                    <button className="text-gray-400 hover:text-red-500 transition-colors">
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                      </svg>
                    </button>
                  </div>

                  {/* Right side - content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-2">
                      <span className="bg-gray-100 text-gray-700 px-2 py-0.5 rounded">
                        {post.category}
                      </span>
                      <span>‚Ä¢</span>
                      <span>{post.author}</span>
                      <span>‚Ä¢</span>
                      <span>{new Date(post.date).toLocaleDateString()}</span>
                      <span>‚Ä¢</span>
                      <span className="flex items-center gap-1">
                        <Clock className="w-3 h-3" />
                        {post.readTime}
                      </span>
                    </div>
                    <Link href={`/blog/${post.id}`}>
                      <h3 className="text-lg font-semibold text-gray-900 mb-2 hover:text-green-700 transition-colors">
                        {post.title}
                      </h3>
                    </Link>
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                      {post.excerpt}
                    </p>
                    <div className="flex items-center gap-4 text-xs text-gray-500">
                      <Link
                        href={`/blog/${post.id}`}
                        className="hover:text-green-700 font-medium transition-colors"
                      >
                        Read more
                      </Link>
                      <span>‚Ä¢</span>
                      <button className="hover:text-green-700 transition-colors">Share</button>
                      <span>‚Ä¢</span>
                      <button className="hover:text-green-700 transition-colors">Save</button>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/category/[category]/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { ChevronRight, Filter } from 'lucide-react';
import { breeds, ageGroups, healthConcerns } from '@/lib/data/pets';
import { nutritionalGuidelines } from '@/lib/data/nutritional-guidelines';
import RecipeCard from '@/components/RecipeCard';
import { PetCategory, Breed, AgeGroup, HealthConcern } from '@/lib/types';

export default function CategoryPage() {
  const params = useParams();
  const category = params.category as PetCategory;
  
  const [selectedBreed, setSelectedBreed] = useState<string>('');
  const [selectedAge, setSelectedAge] = useState<string>('');
  const [selectedHealth, setSelectedHealth] = useState<string>('');
  const [showFilters, setShowFilters] = useState(true);

  const categoryBreeds = breeds[category] || [];
  // Recipes are now generated dynamically
  const filteredRecipes: any[] = [];

  const categoryNames: Record<PetCategory, string> = {
    dogs: 'Dogs',
    cats: 'Cats',
    birds: 'Birds',
    reptiles: 'Reptiles',
    'pocket-pets': 'Pocket Pets',
  };

  const getNutritionalInfo = () => {
    const guidelines = nutritionalGuidelines[category];
    if (!guidelines) return null;
    
    let ageKey: 'puppy' | 'adult' | 'senior' = 'adult';
    if (selectedAge === 'baby' || selectedAge === 'young') {
      ageKey = 'puppy';
    } else if (selectedAge === 'senior') {
      ageKey = 'senior';
    }
    
    return guidelines[ageKey] || guidelines.adult;
  };

  const nutritionalInfo = getNutritionalInfo();

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-primary-600 to-primary-800 text-white py-12 px-4">
        <div className="max-w-7xl mx-auto">
          <nav className="flex items-center gap-2 text-sm mb-4 text-primary-200">
            <Link href="/" className="hover:text-white">Home</Link>
            <ChevronRight size={16} />
            <span className="text-white">{categoryNames[category]}</span>
          </nav>
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            {categoryNames[category]} Meal Plans
          </h1>
          <p className="text-xl text-primary-100 max-w-3xl">
            Personalized nutrition based on breed, age, and health needs
          </p>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* Filters Sidebar */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-lg shadow-md p-6 sticky top-20">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <Filter size={20} />
                  Filters
                </h2>
                <button
                  onClick={() => setShowFilters(!showFilters)}
                  className="lg:hidden text-primary-600"
                >
                  {showFilters ? 'Hide' : 'Show'}
                </button>
              </div>

              {showFilters && (
                <div className="space-y-6">
                  {/* Breed Selection */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      1. Select Breed/Type
                    </label>
                    <select
                      value={selectedBreed}
                      onChange={(e) => setSelectedBreed(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                    >
                      <option value="">All Breeds</option>
                      {categoryBreeds.map((breed) => (
                        <option key={breed.id} value={breed.id}>
                          {breed.name}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Age Selection */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      2. Select Age Group
                    </label>
                    <select
                      value={selectedAge}
                      onChange={(e) => setSelectedAge(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                    >
                      <option value="">All Ages</option>
                      {ageGroups.map((age) => (
                        <option key={age.value} value={age.value}>
                          {age.label}
                        </option>
                      ))}
                    </select>
                    {selectedAge && (
                      <p className="text-xs text-gray-500 mt-1">
                        {ageGroups.find(a => a.value === selectedAge)?.label}
                      </p>
                    )}
                  </div>

                  {/* Health Concerns */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      3. Health Concerns
                    </label>
                    <select
                      value={selectedHealth}
                      onChange={(e) => setSelectedHealth(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                    >
                      <option value="">Select Concern</option>
                      {healthConcerns.map((concern) => (
                        <option key={concern.id} value={concern.id}>
                          {concern.name}
                        </option>
                      ))}
                    </select>
                    {selectedHealth && (
                      <div className="mt-2 text-xs text-gray-600">
                        <p className="font-medium">
                          {healthConcerns.find(h => h.id === selectedHealth)?.description}
                        </p>
                        <p className="mt-1 text-gray-500">
                          Focus: {healthConcerns.find(h => h.id === selectedHealth)?.dietaryAdjustments.join(', ')}
                        </p>
                      </div>
                    )}
                  </div>

                  {/* Clear Filters */}
                  {(selectedBreed || selectedAge || selectedHealth) && (
                    <button
                      onClick={() => {
                        setSelectedBreed('');
                        setSelectedAge('');
                        setSelectedHealth('');
                      }}
                      className="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium"
                    >
                      Clear All Filters
                    </button>
                  )}
                </div>
              )}
            </div>

            {/* Nutritional Guidelines */}
            {nutritionalInfo && (
              <div className="bg-primary-50 rounded-lg p-6 mt-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">
                  Nutritional Guidelines
                </h3>
                <div className="space-y-3 text-sm">
                  {nutritionalInfo.protein && (
                    <div>
                      <span className="font-semibold text-gray-700">Protein:</span>
                      <span className="text-gray-600 ml-2">
                        {nutritionalInfo.protein.min}-{nutritionalInfo.protein.max}{nutritionalInfo.protein.unit}
                      </span>
                    </div>
                  )}
                  {nutritionalInfo.fat && (
                    <div>
                      <span className="font-semibold text-gray-700">Fat:</span>
                      <span className="text-gray-600 ml-2">
                        {nutritionalInfo.fat.min}-{nutritionalInfo.fat.max}{nutritionalInfo.fat.unit}
                      </span>
                    </div>
                  )}
                  {nutritionalInfo.fiber && (
                    <div>
                      <span className="font-semibold text-gray-700">Fiber:</span>
                      <span className="text-gray-600 ml-2">
                        {nutritionalInfo.fiber.min}-{nutritionalInfo.fiber.max}{nutritionalInfo.fiber.unit}
                      </span>
                    </div>
                  )}
                  {nutritionalInfo.calcium && (
                    <div>
                      <span className="font-semibold text-gray-700">Calcium:</span>
                      <span className="text-gray-600 ml-2">
                        {nutritionalInfo.calcium.min}-{nutritionalInfo.calcium.max}{nutritionalInfo.calcium.unit}
                      </span>
                    </div>
                  )}
                  {(nutritionalInfo as any).calories && (
                    <div>
                      <span className="font-semibold text-gray-700">Calories:</span>
                      <span className="text-gray-600 ml-2">
                        {(nutritionalInfo as any).calories.min}-{(nutritionalInfo as any).calories.max} {(nutritionalInfo as any).calories.unit}
                      </span>
                    </div>
                  )}
                  {nutritionalInfo.vitamins && (
                    <div>
                      <span className="font-semibold text-gray-700">Key Vitamins:</span>
                      <span className="text-gray-600 ml-2">
                        {nutritionalInfo.vitamins.join(', ')}
                      </span>
                    </div>
                  )}
                </div>
                <p className="text-xs text-gray-500 mt-4">
                  Based on AAFCO and WSAVA guidelines
                </p>
              </div>
            )}
          </div>

          {/* Results */}
          <div className="lg:col-span-3">
            <div className="mb-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                Recommended Meals
              </h2>
              <p className="text-gray-600">
                Found {filteredRecipes.length} recipe{filteredRecipes.length !== 1 ? 's' : ''} matching your criteria
              </p>
            </div>

            {filteredRecipes.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {filteredRecipes.map((recipe) => (
                  <RecipeCard key={recipe.id} recipe={recipe} />
                ))}
              </div>
            ) : (
              <div className="bg-white rounded-lg shadow-md p-12 text-center">
                <p className="text-gray-600 text-lg mb-4">
                  No recipes found matching your filters
                </p>
                <p className="text-gray-500 mb-6">
                  Try adjusting your filters or browse all meals
                </p>
                <Link
                  href="/profile"
                  className="inline-block px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors"
                >
                  Go to My Pets
                </Link>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/contact/metadata.ts">
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Contact Us - Paw & Plate Pet Nutrition Support',
  description: 'Get in touch with the Paw & Plate team. Questions about pet nutrition, meal plans, recipes, or account support? We\'re here to help.',
  keywords: ['contact pet nutrition', 'Paw & Plate support', 'pet food questions', 'meal plan help'],
  openGraph: {
    title: 'Contact Paw & Plate - Pet Nutrition Support',
    description: 'Get in touch with our pet nutrition team for questions about meal plans and recipes.',
  },
};
</file>

<file path="app/contact/page.tsx">
'use client';

import Link from 'next/link';

export default function ContactPage() {
  return (
    <div className="min-h-screen bg-gray-50 py-16 px-4">
      <div className="max-w-3xl mx-auto space-y-8">
        <div>
          <Link href="/" className="text-orange-600 font-semibold hover:underline">
            ‚Üê Back to home
          </Link>
        </div>
        <header>
          <h1 className="text-4xl font-extrabold text-gray-900 mb-3">Contact Us</h1>
          <p className="text-lg text-gray-600">
            Have a question about meal planning, partnerships, or support? We‚Äôre here to help.
          </p>
        </header>
        <section className="bg-white rounded-2xl shadow p-6 border border-gray-100 space-y-4">
          <div>
            <h2 className="text-xl font-semibold text-gray-900">Email</h2>
            <p className="text-gray-600">
              <a href="mailto:hello@petplates.co" className="text-orange-600 font-semibold hover:underline">
                hello@petplates.co
              </a>
            </p>
          </div>
          <div>
            <h2 className="text-xl font-semibold text-gray-900">Response time</h2>
            <p className="text-gray-600">We typically respond within one business day.</p>
          </div>
          <div>
            <h2 className="text-xl font-semibold text-gray-900">Need immediate help?</h2>
            <p className="text-gray-600">
              Check our <Link href="/faq" className="text-orange-600 font-semibold hover:underline">FAQ</Link> or{' '}
              <Link href="/nutrition-guide" className="text-orange-600 font-semibold hover:underline">Nutrition Guide</Link>{' '}
              for quick answers.
            </p>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { useUser } from '@clerk/nextjs';
import { Settings, Plus, Utensils, Heart, ArrowRight } from 'lucide-react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, collection, getDocs, query, onSnapshot, where } from 'firebase/firestore';

// --- Data Structures (Based on your other files) ---
interface SavedRecipe {
    id: string; // This MUST be the actual recipe ID (e.g., dog-immune-01)
    name: string;
    dateAdded: string;
}

interface Pet {
    petId: string; // The Firestore document ID for the pet (e.g., pet_176...)
    name: string;
    type: string;
    breed: string;
    age: string;
    healthConcerns: string[];
    savedRecipes: SavedRecipe[]; // Array of recipes saved to this pet
    names?: string[];
    weight?: string | number;
    weightKg?: number;
    dietaryRestrictions?: string[];
    allergies?: string[];
    dislikes?: string[];
}

// Firestore Globals (MUST be used)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Utility to safely retrieve Firebase services
let app: any;
let db: any;
let auth: any;

if (firebaseConfig) {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    // setLogLevel('debug'); // Uncomment for debugging
  } catch (error) {
    console.error("Firebase initialization failed:", error);
  }
}

// --- Pet Dashboard Component ---
export default function DashboardPage() {
    const { user, isLoaded: isClerkLoaded } = useUser();
    const [pets, setPets] = useState<Pet[]>([]);
    const [userId, setUserId] = useState<string | null>(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isLoading, setIsLoading] = useState(true);

    // 1. Firebase Auth and Initialization
    useEffect(() => {
        if (!auth) return;

        const setupAuth = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
            }
        };

        const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
            if (firebaseUser) {
                setUserId(firebaseUser.uid);
            } else {
                setUserId(crypto.randomUUID()); // Anonymous fallback
            }
            setIsAuthReady(true);
        });

        setupAuth();
        return () => unsubscribe();
    }, []);

    // 2. Real-time Pet Data Fetch (Using onSnapshot)
    useEffect(() => {
        if (!isAuthReady || !userId || !db) return;

        // Reference the 'pets' subcollection under the user's private path
        const petCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pets`);
        
        // Use onSnapshot to listen for real-time changes
        const unsubscribe = onSnapshot(
            petCollectionRef,
            (snapshot) => {
                const fetchedPets: Pet[] = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure savedRecipes is treated as an array, even if empty/missing
                    const savedRecipes = Array.isArray(data.savedRecipes) ? data.savedRecipes : [];

                    fetchedPets.push({
                        petId: doc.id, // Firestore document ID (e.g., pet_176...)
                        name: data.name || 'Unnamed Pet',
                        type: data.type || 'Unknown',
                        breed: data.breed || 'Mixed',
                        age: data.age || 'Adult',
                        healthConcerns: data.healthConcerns || [],
                        savedRecipes: savedRecipes as SavedRecipe[], 
                    });
                });
                setPets(fetchedPets);
                setIsLoading(false);
            },
            (error) => {
                console.error("Error fetching real-time pet data:", error);
                setIsLoading(false);
            }
        );

        return () => unsubscribe();
    }, [isAuthReady, userId]);


    if (!isClerkLoaded || isLoading) {
        return <div className="min-h-screen flex items-center justify-center text-xl text-primary-600">Loading Dashboard...</div>;
    }

    // --- JSX Render ---
    return (
        <div className="min-h-screen bg-gray-50 py-12">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                
                <header className="flex justify-between items-center mb-10 border-b pb-4">
                    <h1 className="text-4xl font-extrabold text-gray-900">Your Paw & Plate Dashboard</h1>
                    <button 
                        // Assuming you have an AddPetModal component (not included here)
                        className="flex items-center px-4 py-2 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors shadow-lg"
                    >
                        <Plus className="w-5 h-5 mr-2" />
                        Add New Pet
                    </button>
                </header>

                <div className="space-y-10">
                    {pets.length === 0 ? (
                        <div className="p-12 text-center bg-white rounded-xl shadow-lg border border-gray-200">
                            <h2 className="text-2xl font-semibold mb-3 text-gray-700">No Pets Found</h2>
                            <p className="text-gray-500 mb-6">Start by adding your first furry (or scaled!) friend.</p>
                            <button 
                                // Placeholder for opening modal
                                className="px-6 py-2 bg-secondary-600 text-white font-medium rounded-lg hover:bg-secondary-700 transition-colors"
                            >
                                Add a Pet Now
                            </button>
                        </div>
                    ) : (
                        // --- Pet List ---
                        pets.map((pet) => (
                            <div key={pet.petId} className="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                                <div className="p-6 bg-primary-50 border-b border-primary-100 flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-primary-800">{pet.name}</h2>
                                    <div className="text-sm text-primary-600 font-medium">
                                        {pet.breed} ‚Ä¢ {pet.age}
                                    </div>
                                </div>

                                <div className="p-6">
                                    <div className="flex flex-wrap gap-2 mb-6">
                                        <span className="flex items-center text-sm font-medium text-gray-700 bg-green-100 px-3 py-1 rounded-full">
                                            <Heart className="w-4 h-4 mr-1 text-green-600" />
                                            Health: {pet.healthConcerns.join(', ') || 'General'}
                                        </span>
                                        <span className="text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full">
                                            Pet ID: {pet.petId}
                                        </span>
                                    </div>
                                    
                                    <h3 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                        <Utensils className="w-5 h-5 mr-2 text-secondary-500" />
                                        Saved Recipes ({pet.savedRecipes.length})
                                    </h3>

                                    {pet.savedRecipes.length === 0 ? (
                                        <p className="text-gray-500 italic">No recipes saved yet. Time to go shopping!</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {pet.savedRecipes.map((recipe) => (
                                                <div key={recipe.id} className="p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center">
                                                    <div className="flex flex-col">
                                                        <span className="font-medium text-gray-900">{recipe.name}</span>
                                                        <span className="text-xs text-gray-500">Added: {new Date(recipe.dateAdded).toLocaleDateString()}</span>
                                                    </div>
                                                    
                                                    <Link
                                                        // === CRITICAL FIX APPLIED HERE ===
                                                        // The link MUST use the recipe.id, NOT the pet.petId.
                                                        href={`/profile/pet/${pet.petId}`}
                                                        className="flex items-center text-sm font-semibold text-secondary-600 hover:text-secondary-800 transition-colors"
                                                    >
                                                        View recommended Meals
                                                        <ArrowRight className="w-4 h-4 ml-1" />
                                                    </Link>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))
                    )}
                </div>
                
                <p className="text-center text-sm text-gray-400 mt-10">
                    User ID: {userId}
                </p>

            </div>
        </div>
    );
}
</file>

<file path="app/diagnostics/image-inversion/page.tsx">
'use client';

export default function ImageInversionDetector() {
  return (
    <div style={{
      margin: 0,
      padding: '20px',
      background: '#0a0a0a',
      fontFamily: 'monospace',
      color: 'white',
      minHeight: '100vh'
    }}>
      <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
        <h1 style={{ color: '#60a5fa' }}>üîç Image Color Inversion Detector</h1>
        <p style={{ color: '#9ca3af', marginBottom: '20px' }}>
          This tool scans your page for CSS that inverts image colors (common in dark mode implementations)
        </p>

        <div style={{ marginBottom: '20px' }}>
          <button
            onClick={() => {
              if (typeof window !== 'undefined' && (window as any).scanPage) {
                (window as any).scanPage();
              }
            }}
            style={{
              background: '#3b82f6',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '16px',
              fontWeight: 'bold',
              marginRight: '10px'
            }}
            onMouseOver={(e) => e.currentTarget.style.background = '#2563eb'}
            onMouseOut={(e) => e.currentTarget.style.background = '#3b82f6'}
          >
            üîé Scan Page
          </button>
          <button
            onClick={() => {
              if (typeof window !== 'undefined' && (window as any).highlightIssues) {
                (window as any).highlightIssues();
              }
            }}
            style={{
              background: '#ef4444',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '16px',
              fontWeight: 'bold',
              marginRight: '10px'
            }}
            onMouseOver={(e) => e.currentTarget.style.background = '#dc2626'}
            onMouseOut={(e) => e.currentTarget.style.background = '#ef4444'}
          >
            üéØ Highlight Affected Images
          </button>
          <button
            onClick={() => {
              if (typeof window !== 'undefined' && (window as any).fixIssues) {
                (window as any).fixIssues();
              }
            }}
            style={{
              background: '#10b981',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '16px',
              fontWeight: 'bold'
            }}
            onMouseOver={(e) => e.currentTarget.style.background = '#059669'}
            onMouseOut={(e) => e.currentTarget.style.background = '#10b981'}
          >
            üîß Auto-Fix (Temporary)
          </button>
        </div>

        <div id="stats" style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: '16px',
          marginBottom: '20px'
        }}></div>
        <div id="results" style={{
          background: '#1a1a1a',
          border: '2px solid #333',
          borderRadius: '8px',
          padding: '20px',
          marginBottom: '20px'
        }}></div>
      </div>

      <script
        dangerouslySetInnerHTML={{
          __html: `
            function scanPage() {
              const results = document.getElementById('results');
              const stats = document.getElementById('stats');
              results.innerHTML = '<h2>Scanning...</h2>';
              
              const issues = [];
              const affectedImages = [];
              
              // Check all images
              const allImages = document.querySelectorAll('img');
              console.log(\`Found \${allImages.length} images\`);
              
              allImages.forEach((img, index) => {
                const computedStyle = window.getComputedStyle(img);
                const filter = computedStyle.filter;
                
                // Check for invert filter
                if (filter && filter !== 'none' && filter.includes('invert')) {
                  issues.push({
                    type: 'Image has invert filter',
                    element: img,
                    selector: getSelector(img),
                    filter: filter,
                    src: img.src,
                    alt: img.alt || 'no alt',
                    severity: 'high'
                  });
                  affectedImages.push(img);
                }
                
                // Check parent elements for dark mode classes
                let parent = img.parentElement;
                let depth = 0;
                while (parent && depth < 10) {
                  const parentStyle = window.getComputedStyle(parent);
                  const parentFilter = parentStyle.filter;
                  
                  if (parentFilter && parentFilter !== 'none' && parentFilter.includes('invert')) {
                    issues.push({
                      type: 'Parent element has invert filter',
                      element: parent,
                      imageElement: img,
                      selector: getSelector(parent),
                      filter: parentFilter,
                      src: img.src,
                      alt: img.alt || 'no alt',
                      severity: 'high'
                    });
                    affectedImages.push(img);
                    break;
                  }
                  
                  parent = parent.parentElement;
                  depth++;
                }
              });
              
              // Check global CSS rules
              const stylesheets = Array.from(document.styleSheets);
              let cssRulesWithInvert = [];
              
              stylesheets.forEach(sheet => {
                try {
                  const rules = Array.from(sheet.cssRules || []);
                  rules.forEach(rule => {
                    if (rule.style && rule.style.filter && rule.style.filter !== 'none' && rule.style.filter.includes('invert')) {
                      cssRulesWithInvert.push({
                        selector: rule.selectorText,
                        filter: rule.style.filter,
                        sheet: sheet.href || 'inline'
                      });
                    }
                  });
                } catch (e) {
                  // Cross-origin stylesheets might throw errors
                  console.warn('Could not access stylesheet:', e);
                }
              });
              
              // Display stats
              stats.innerHTML = \`
                <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #60a5fa;">\${allImages.length}</div>
                  <div style="color: #9ca3af; margin-top: 8px;">Total Images</div>
                </div>
                <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: \${affectedImages.length > 0 ? '#ef4444' : '#10b981'}">\${affectedImages.length}</div>
                  <div style="color: #9ca3af; margin-top: 8px;">Affected Images</div>
                </div>
                <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #60a5fa">\${cssRulesWithInvert.length}</div>
                  <div style="color: #9ca3af; margin-top: 8px;">CSS Rules with Invert</div>
                </div>
              \`;
              
              // Display results
              let html = '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">Scan Results</h2>';
              
              if (issues.length === 0 && cssRulesWithInvert.length === 0) {
                html += '<div style="background: #152d15; border-left: 4px solid #10b981; padding: 12px; margin: 8px 0; border-radius: 4px;">‚úÖ No color inversion issues found!</div>';
              } else {
                // Show affected images
                if (issues.length > 0) {
                  html += '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">üö® Affected Images</h2>';
                  issues.forEach((issue, i) => {
                    html += \`
                      <div style="background: #2d1515; border-left: 4px solid #ef4444; padding: 12px; margin: 8px 0; border-radius: 4px;">
                        <strong>\${issue.type}</strong><br>
                        Selector: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${issue.selector}</code><br>
                        Filter: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${issue.filter}</code><br>
                        Image: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${issue.src.split('/').pop()}</code><br>
                        Alt: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${issue.alt}</code>
                        <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
                          // To fix, add this CSS:<br>
                          \${issue.selector} {<br>
                          &nbsp;&nbsp;filter: none !important;<br>
                          &nbsp;&nbsp;-webkit-filter: none !important;<br>
                          }
                        </div>
                      </div>
                    \`;
                  });
                }
                
                // Show CSS rules
                if (cssRulesWithInvert.length > 0) {
                  html += '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">üìã CSS Rules Using Invert Filter</h2>';
                  cssRulesWithInvert.forEach(rule => {
                    html += \`
                      <div style="background: #2d1515; border-left: 4px solid #ef4444; padding: 12px; margin: 8px 0; border-radius: 4px;">
                        <strong>Rule found in: \${rule.sheet}</strong><br>
                        Selector: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${rule.selector}</code><br>
                        Filter: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">\${rule.filter}</code>
                        <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
                          // This rule might be affecting images.<br>
                          // Consider excluding images from this rule or adding filter: none !important to images.
                        </div>
                      </div>
                    \`;
                  });
                }
                
                // Common fixes
                html += \`
                  <h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">üîß Common Fixes</h2>
                  <div style="background: #152d15; border-left: 4px solid #10b981; padding: 12px; margin: 8px 0; border-radius: 4px;">
                    <strong>Method 1: Exclude images from dark mode inversion</strong>
                    <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
/* In your global CSS */<br>
img, picture, video {<br>
&nbsp;&nbsp;filter: none !important;<br>
}<br>
<br>
/* Or for specific dark mode implementations */<br>
.dark img, [data-theme="dark"] img {<br>
&nbsp;&nbsp;filter: none !important;<br>
}
                    </div>
                  </div>
                  <div style="background: #152d15; border-left: 4px solid #10b981; padding: 12px; margin: 8px 0; border-radius: 4px; margin-top: 12px;">
                    <strong>Method 2: Add a class to images that should NOT be inverted</strong>
                    <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
.no-invert {<br>
&nbsp;&nbsp;filter: none !important;<br>
}<br>
<br>
// Then add to your images:<br>
&lt;img className="no-invert" src="..." /&gt;
                    </div>
                  </div>
                \`;
              }
              
              results.innerHTML = html;
              
              // Store for other functions
              window.affectedImages = affectedImages;
              window.cssRulesWithInvert = cssRulesWithInvert;
            }
            
            function getSelector(element) {
              if (element.id) return \`#\${element.id}\`;
              if (element.className) {
                const classes = element.className.split(' ').filter(c => c).join('.');
                if (classes) return \`\${element.tagName.toLowerCase()}.\${classes}\`;
              }
              return element.tagName.toLowerCase();
            }
            
            function highlightIssues() {
              if (!window.affectedImages) {
                alert('Please run scan first!');
                return;
              }
              
              window.affectedImages.forEach(img => {
                img.style.outline = '4px solid red';
                img.style.outlineOffset = '2px';
              });
              
              setTimeout(() => {
                window.affectedImages.forEach(img => {
                  img.style.outline = '';
                });
              }, 3000);
            }
            
            function fixIssues() {
              if (!window.affectedImages) {
                alert('Please run scan first!');
                return;
              }
              
              let fixed = 0;
              window.affectedImages.forEach(img => {
                img.style.filter = 'none';
                img.style.webkitFilter = 'none';
                fixed++;
              });
              
              alert(\`Temporarily fixed \${fixed} images. Add permanent CSS fix to your stylesheet!\`);
            }
            
            // Auto-run on load
            if (typeof window !== 'undefined') {
              window.addEventListener('load', () => {
                setTimeout(scanPage, 500);
              });
            }
          `
        }}
      />
    </div>
  );
}

// Client-side functions
if (typeof window !== 'undefined') {
  (window as any).scanPage = function() {
    const results = document.getElementById('results');
    const stats = document.getElementById('stats');
    if (!results || !stats) return;
    
    results.innerHTML = '<h2>Scanning...</h2>';
    
    const issues: any[] = [];
    const affectedImages: HTMLImageElement[] = [];
    
    // Check all images
    const allImages = document.querySelectorAll('img');
    console.log(`Found ${allImages.length} images`);
    
    allImages.forEach((img) => {
      const computedStyle = window.getComputedStyle(img);
      const filter = computedStyle.filter;
      
      // Check for invert filter
      if (filter && filter !== 'none' && filter.includes('invert')) {
        issues.push({
          type: 'Image has invert filter',
          element: img,
          selector: getSelector(img),
          filter: filter,
          src: img.src,
          alt: img.alt || 'no alt',
          severity: 'high'
        });
        affectedImages.push(img);
      }
      
      // Check parent elements
      let parent = img.parentElement;
      let depth = 0;
      while (parent && depth < 10) {
        const parentStyle = window.getComputedStyle(parent);
        const parentFilter = parentStyle.filter;
        
        if (parentFilter && parentFilter !== 'none' && parentFilter.includes('invert')) {
          issues.push({
            type: 'Parent element has invert filter',
            element: parent,
            imageElement: img,
            selector: getSelector(parent),
            filter: parentFilter,
            src: img.src,
            alt: img.alt || 'no alt',
            severity: 'high'
          });
          affectedImages.push(img);
          break;
        }
        
        parent = parent.parentElement;
        depth++;
      }
    });
    
    // Check global CSS rules
    const stylesheets = Array.from(document.styleSheets);
    const cssRulesWithInvert: any[] = [];
    
    stylesheets.forEach(sheet => {
      try {
        const rules = Array.from(sheet.cssRules || []);
        rules.forEach(rule => {
          const cssRule = rule as CSSStyleRule;
          if (cssRule.style && cssRule.style.filter && cssRule.style.filter !== 'none' && cssRule.style.filter.includes('invert')) {
            cssRulesWithInvert.push({
              selector: cssRule.selectorText,
              filter: cssRule.style.filter,
              sheet: sheet.href || 'inline'
            });
          }
        });
      } catch (e) {
        console.warn('Could not access stylesheet:', e);
      }
    });
    
    // Display stats
    stats.innerHTML = `
      <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #60a5fa;">${allImages.length}</div>
        <div style="color: #9ca3af; margin-top: 8px;">Total Images</div>
      </div>
      <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: ${affectedImages.length > 0 ? '#ef4444' : '#10b981'}">${affectedImages.length}</div>
        <div style="color: #9ca3af; margin-top: 8px;">Affected Images</div>
      </div>
      <div style="background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #60a5fa">${cssRulesWithInvert.length}</div>
        <div style="color: #9ca3af; margin-top: 8px;">CSS Rules with Invert</div>
      </div>
    `;
    
    // Display results
    let html = '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">Scan Results</h2>';
    
    if (issues.length === 0 && cssRulesWithInvert.length === 0) {
      html += '<div style="background: #152d15; border-left: 4px solid #10b981; padding: 12px; margin: 8px 0; border-radius: 4px;">‚úÖ No color inversion issues found!</div>';
    } else {
      if (issues.length > 0) {
        html += '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">üö® Affected Images</h2>';
        issues.forEach((issue) => {
          html += `
            <div style="background: #2d1515; border-left: 4px solid #ef4444; padding: 12px; margin: 8px 0; border-radius: 4px;">
              <strong>${issue.type}</strong><br>
              Selector: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${issue.selector}</code><br>
              Filter: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${issue.filter}</code><br>
              Image: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${issue.src.split('/').pop()}</code><br>
              Alt: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${issue.alt}</code>
              <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
                // To fix, add this CSS:<br>
                ${issue.selector} {<br>
                &nbsp;&nbsp;filter: none !important;<br>
                &nbsp;&nbsp;-webkit-filter: none !important;<br>
                }
              </div>
            </div>
          `;
        });
      }
      
      if (cssRulesWithInvert.length > 0) {
        html += '<h2 style="color: #34d399; font-size: 18px; margin-top: 20px;">üìã CSS Rules Using Invert Filter</h2>';
        cssRulesWithInvert.forEach(rule => {
          html += `
            <div style="background: #2d1515; border-left: 4px solid #ef4444; padding: 12px; margin: 8px 0; border-radius: 4px;">
              <strong>Rule found in: ${rule.sheet}</strong><br>
              Selector: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${rule.selector}</code><br>
              Filter: <code style="background: #000; padding: 4px; border-radius: 4px; color: #60a5fa;">${rule.filter}</code>
              <div style="background: #000; padding: 8px; border-radius: 4px; margin-top: 8px; overflow-x: auto; font-size: 12px; color: #60a5fa;">
                // This rule might be affecting images.<br>
                // Consider excluding images from this rule or adding filter: none !important to images.
              </div>
            </div>
          `;
        });
      }
    }
    
    results.innerHTML = html;
    (window as any).affectedImages = affectedImages;
    (window as any).cssRulesWithInvert = cssRulesWithInvert;
  };
  
  (window as any).highlightIssues = function() {
    const affectedImages = (window as any).affectedImages;
    if (!affectedImages || affectedImages.length === 0) {
      alert('Please run scan first!');
      return;
    }
    
    affectedImages.forEach((img: HTMLImageElement) => {
      img.style.outline = '4px solid red';
      img.style.outlineOffset = '2px';
    });
    
    setTimeout(() => {
      affectedImages.forEach((img: HTMLImageElement) => {
        img.style.outline = '';
      });
    }, 3000);
  };
  
  (window as any).fixIssues = function() {
    const affectedImages = (window as any).affectedImages;
    if (!affectedImages || affectedImages.length === 0) {
      alert('Please run scan first!');
      return;
    }
    
    let fixed = 0;
    affectedImages.forEach((img: HTMLImageElement) => {
      img.style.filter = 'none';
      img.style.webkitFilter = 'none';
      fixed++;
    });
    
    alert(`Temporarily fixed ${fixed} images. Add permanent CSS fix to your stylesheet!`);
  };
}

function getSelector(element: Element): string {
  if (element.id) return `#${element.id}`;
  if (element.className) {
    const classes = element.className.toString().split(' ').filter(c => c).join('.');
    if (classes) return `${element.tagName.toLowerCase()}.${classes}`;
  }
  return element.tagName.toLowerCase();
}
</file>

<file path="app/faq/page.tsx">
'use client';

import Link from 'next/link';

const faqItems = [
  {
    question: 'What is Paw & Plate?',
    answer:
      'A tool that helps you build fresh, personalized meals for your pets based on species, age, breed, size, and health needs ‚Äî along with links to reputable ingredients and supplements.',
  },
  {
    question: 'Do you sell food directly?',
    answer:
      'No. We guide you to evidence-based nutrition and help you purchase ingredients from trusted retailers and brands.',
  },
  {
    question: 'Are the meals veterinarian-approved?',
    answer:
      'Our guidelines follow AAFCO (dogs/cats) and established exotic-pet nutrition research. Expert review is underway as we expand.',
  },
  {
    question: 'Can I use this instead of my vet?',
    answer:
      'No. Paw & Plate is an educational and planning tool. Always consult your veterinarian when making major dietary changes.',
  },
  {
    question: 'Does the app calculate how much to feed?',
    answer:
      'Yes ‚Äî portions automatically scale to your pet‚Äôs weight, life stage, and body-condition goals.',
  },
  {
    question: 'What species do you support?',
    answer: 'Dogs, cats, birds, reptiles, and small mammals ‚Äî with more to come.',
  },
  {
    question: 'How much does it cost?',
    answer: 'The core meal-planning features are free. Optional premium features will be announced.',
  },
];

export default function FAQPage() {
  return (
    <div className="min-h-screen bg-gray-50 py-16 px-4">
      <div className="max-w-4xl mx-auto">
        <div className="mb-8">
          <Link href="/" className="text-orange-600 font-semibold hover:underline">
            ‚Üê Back to home
          </Link>
        </div>
        <h1 className="text-4xl font-extrabold text-gray-900 mb-4">FAQ</h1>
        <p className="text-lg text-gray-600 mb-12">
          Answers to the most common questions about how Paw & Plate works.
        </p>
        <div className="space-y-6">
          {faqItems.map((item) => (
            <div key={item.question} className="bg-white rounded-2xl shadow p-6 border border-gray-100">
              <h2 className="text-xl font-semibold text-gray-900">{item.question}</h2>
              <p className="text-gray-600 mt-2 leading-relaxed">{item.answer}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/forum/gallery/page.tsx">
'use client';

import Link from 'next/link';
import { useState, useEffect } from 'react';
import { Star, Users, Heart, ChefHat, Clock, ThumbsUp } from 'lucide-react';
import Image from '@/components/Image';
import { getEmojiGroup } from '@/lib/utils/imageMapping';

export default function CommunityGalleryPage() {
  const [communityRecipes, setCommunityRecipes] = useState<any[]>([]);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    // Load all community modifications from localStorage
    const allRecipes = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('recipe_modifications_')) {
        const recipeId = key.replace('recipe_modifications_', '');
        const modifications = JSON.parse(localStorage.getItem(key) || '[]');

        if (modifications.length > 0) {
          // Get original recipe data
          const originalRecipe = JSON.parse(localStorage.getItem('recipes') || '[]').find((r: any) => r.id === recipeId);

          allRecipes.push({
            recipeId,
            originalRecipe,
            modifications,
            totalModifications: modifications.length,
            averageRating: modifications.reduce((sum: number, mod: any) => sum + (mod.rating || 0), 0) / modifications.length,
            lastModified: modifications[0]?.timestamp
          });
        }
      }
    }

    setCommunityRecipes(allRecipes);
  }, []);

  const filteredRecipes = communityRecipes.filter(recipe => {
    if (filter === 'all') return true;
    if (filter === 'highly-rated') return recipe.averageRating >= 4;
    if (filter === 'recent') return new Date(recipe.lastModified) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
    if (filter === 'popular') return recipe.totalModifications >= 3;
    return true;
  });

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-green-800 to-green-900 text-white py-16 px-4">
        <div className="max-w-6xl mx-auto text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            Community Recipe Gallery
          </h1>
          <p className="text-xl text-primary-100 max-w-3xl mx-auto">
            Discover creative recipe modifications and improvements shared by our community of pet parents.
            See how others adapted recipes for their pets' unique needs.
          </p>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        {/* Stats */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
          <div className="bg-white rounded-lg shadow-md p-6 text-center">
            <ChefHat className="w-8 h-8 mx-auto mb-3 text-primary-600" />
            <div className="text-2xl font-bold text-gray-900 mb-1">{communityRecipes.length}</div>
            <div className="text-sm text-gray-600">Modified Recipes</div>
          </div>
          <div className="bg-white rounded-lg shadow-md p-6 text-center">
            <Users className="w-8 h-8 mx-auto mb-3 text-green-600" />
            <div className="text-2xl font-bold text-gray-900 mb-1">
              {communityRecipes.reduce((sum, recipe) => sum + recipe.totalModifications, 0)}
            </div>
            <div className="text-sm text-gray-600">Community Contributions</div>
          </div>
          <div className="bg-white rounded-lg shadow-md p-6 text-center">
            <Star className="w-8 h-8 mx-auto mb-3 text-yellow-600" />
            <div className="text-2xl font-bold text-gray-900 mb-1">
              {communityRecipes.length > 0
                ? (communityRecipes.reduce((sum, recipe) => sum + recipe.averageRating, 0) / communityRecipes.length).toFixed(1)
                : '0.0'
              }
            </div>
            <div className="text-sm text-gray-600">Average Rating</div>
          </div>
          <div className="bg-white rounded-lg shadow-md p-6 text-center">
            <Heart className="w-8 h-8 mx-auto mb-3 text-red-600" />
            <div className="text-2xl font-bold text-gray-900 mb-1">
              {communityRecipes.reduce((sum, recipe) => sum + recipe.modifications.reduce((mSum: number, mod: any) => mSum + (mod.helpful || 0), 0), 0)}
            </div>
            <div className="text-sm text-gray-600">Helpful Votes</div>
          </div>
        </div>

        {/* Filters */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setFilter('all')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                filter === 'all' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              All Meals
            </button>
            <button
              onClick={() => setFilter('highly-rated')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                filter === 'highly-rated' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Highly Rated (4+ stars)
            </button>
            <button
              onClick={() => setFilter('recent')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                filter === 'recent' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Recently Modified
            </button>
            <button
              onClick={() => setFilter('popular')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                filter === 'popular' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Most Modified (3+ variations)
            </button>
          </div>
        </div>

        {/* Recipe Gallery */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredRecipes.map((recipe) => (
            <div key={recipe.recipeId} className="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
              <div className="p-6">
                {/* Original Recipe Info */}
                <div className="mb-4">
                  <h3 className="text-lg font-bold text-gray-900 mb-2">
                    Modified: {recipe.originalRecipe?.name || 'Unknown Recipe'}
                  </h3>
                  <div className="flex items-center gap-2 text-sm text-gray-600 mb-2">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                      recipe.originalRecipe?.category === 'dogs' ? 'bg-blue-100 text-blue-800' :
                      recipe.originalRecipe?.category === 'cats' ? 'bg-orange-100 text-orange-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {recipe.originalRecipe?.category || 'Unknown'}
                    </span>
                    <div className="flex items-center gap-1">
                      <Star className="w-4 h-4 text-yellow-500 fill-yellow-500" />
                      <span>{recipe.averageRating.toFixed(1)}</span>
                    </div>
                  </div>
                </div>

                {/* Community Stats */}
                <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                  <div className="text-center">
                    <div className="font-semibold text-gray-900">{recipe.totalModifications}</div>
                    <div className="text-gray-600">Variations</div>
                  </div>
                  <div className="text-center">
                    <div className="font-semibold text-gray-900">
                      {recipe.modifications.reduce((sum: number, mod: any) => sum + (mod.helpful || 0), 0)}
                    </div>
                    <div className="text-gray-600">Helpful</div>
                  </div>
                </div>

                {/* Latest Modification Preview */}
                <div className="mb-4">
                  <h4 className="font-semibold text-gray-900 mb-2">Latest Variation:</h4>
                  <p className="text-gray-700 text-sm line-clamp-3">
                    {recipe.modifications[0]?.modifications || 'No description available'}
                  </p>
                  <div className="flex items-center gap-2 mt-2 text-xs text-gray-500">
                    <span>by {recipe.modifications[0]?.userName || 'Anonymous'}</span>
                    <span>‚Ä¢</span>
                    <span>{new Date(recipe.modifications[0]?.timestamp).toLocaleDateString()}</span>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex gap-2">
                  <Link
                    href={`/recipe/${recipe.recipeId}`}
                    className="flex-1 text-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors"
                  >
                    View Recipe
                  </Link>
                  <button className="px-3 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                    <ThumbsUp className="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {filteredRecipes.length === 0 && (
          <div className="text-center py-12">
            <ChefHat className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">No recipes found</h3>
            <p className="text-gray-600 mb-6">
              {filter === 'all'
                ? "No community modifications have been shared yet. Be the first to modify a recipe and share your improvements!"
                : `No recipes match the "${filter}" filter. Try a different filter.`
              }
            </p>
            <Link
              href="/forum"
              className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors"
            >
              <ChefHat className="w-5 h-5" />
              Start Modifying Recipes
            </Link>
          </div>
        )}

        {/* Call to Action */}
        <div className="bg-primary-600 text-white rounded-lg p-8 mt-12 text-center">
          <h3 className="text-2xl font-bold mb-4">Share Your Recipe Creations</h3>
          <p className="text-primary-100 mb-6 max-w-2xl mx-auto">
            Have you modified a recipe to better suit your pet's needs? Share your innovations with the community
            and help other pet parents discover new ways to make meals their pets will love.
          </p>
          <Link
            href="/forum"
            className="inline-flex items-center gap-2 px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors"
          >
            Share Your Modifications
          </Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/forum/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { MessageSquare, Users, TrendingUp, Plus, Search, Filter, ThumbsUp, MessageCircle, Eye, ChefHat } from 'lucide-react';

export default function ForumPage() {
  const [activeCategory, setActiveCategory] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');

  const categories = [
    { id: 'all', name: 'All Topics', count: 1247, color: 'bg-gray-100 text-gray-800' },
    { id: 'recipes', name: 'Recipe Discussions', count: 456, color: 'bg-blue-100 text-blue-800' },
    { id: 'nutrition', name: 'Nutrition Questions', count: 234, color: 'bg-green-100 text-green-800' },
    { id: 'health', name: 'Health & Conditions', count: 189, color: 'bg-red-100 text-red-800' },
    { id: 'training', name: 'Training & Behavior', count: 156, color: 'bg-purple-100 text-purple-800' },
    { id: 'products', name: 'Product Reviews', count: 98, color: 'bg-orange-100 text-orange-800' },
    { id: 'general', name: 'General Discussion', count: 114, color: 'bg-indigo-100 text-indigo-800' }
  ];

  const forumThreads = [
    {
      id: 1,
      title: "Homemade chicken and rice recipe - my dog won't eat it!",
      author: "SarahPetMom",
      avatar: "/images/avatars/sarah.jpg",
      category: "recipes",
      replies: 23,
      views: 1456,
      lastReply: "2 hours ago",
      lastReplyBy: "ChefMike",
      isSticky: false,
      tags: ["chicken", "rice", "picky-eater"],
      excerpt: "I've been trying this recipe for 3 days now but my golden retriever just sniffs it and walks away. Any suggestions for making it more appealing?"
    },
    {
      id: 2,
      title: "STICKY: Community Recipe Contest - Winter Warmers!",
      author: "Paw & Plate",
      avatar: "/images/avatars/admin.jpg",
      category: "recipes",
      replies: 67,
      views: 3241,
      lastReply: "1 hour ago",
      lastReplyBy: "RecipeQueen",
      isSticky: true,
      tags: ["contest", "winter", "featured"],
      excerpt: "Share your best warming recipes for cold weather! Winner gets featured on our blog and a $50 Amazon gift card. Contest ends December 15th."
    },
    {
      id: 3,
      title: "Kidney disease diet modifications - success stories?",
      author: "HopefulOwner",
      avatar: "/images/avatars/hope.jpg",
      category: "health",
      replies: 34,
      views: 892,
      lastReply: "4 hours ago",
      lastReplyBy: "KidneyWarrior",
      isSticky: false,
      tags: ["kidney-disease", "success-story", "chronic-illness"],
      excerpt: "My 12-year-old lab was diagnosed with early kidney disease. We've been on a homemade diet for 6 months. Anyone else have positive experiences to share?"
    },
    {
      id: 4,
      title: "Best supplements for senior dogs (8+ years)",
      author: "SeniorDogDad",
      avatar: "/images/avatars/senior.jpg",
      category: "nutrition",
      replies: 28,
      views: 756,
      lastReply: "6 hours ago",
      lastReplyBy: "VetAssistant",
      isSticky: false,
      tags: ["senior-dogs", "supplements", "joint-health"],
      excerpt: "My 10-year-old shepherd has arthritis. What supplements have you found most helpful for mobility and joint health?"
    },
    {
      id: 5,
      title: "Cat food recipes that actually work",
      author: "CatLady2024",
      avatar: "/images/avatars/cat.jpg",
      category: "recipes",
      replies: 45,
      views: 1234,
      lastReply: "3 hours ago",
      lastReplyBy: "FelineExpert",
      isSticky: false,
      tags: ["cats", "recipes", "picky-eaters"],
      excerpt: "My Maine Coon is so picky! She turns her nose up at most commercial foods. What homemade recipes have worked for your finicky felines?"
    },
    {
      id: 6,
      title: "Allergy testing vs elimination diet - which is better?",
      author: "AllergyMom",
      avatar: "/images/avatars/allergy.jpg",
      category: "health",
      replies: 19,
      views: 543,
      lastReply: "8 hours ago",
      lastReplyBy: "Dermatologist",
      isSticky: false,
      tags: ["allergies", "testing", "elimination-diet"],
      excerpt: "My vet recommended allergy testing ($300) but I'm considering trying an elimination diet first. What has your experience been?"
    }
  ];

  const stats = [
    { label: 'Active Members', value: '12,847', icon: Users, color: 'text-blue-600' },
    { label: 'Discussions', value: '3,421', icon: MessageSquare, color: 'text-green-600' },
    { label: 'Recipes Shared', value: '1,892', icon: TrendingUp, color: 'text-purple-600' },
    { label: 'Success Stories', value: '756', icon: ThumbsUp, color: 'text-orange-600' }
  ];

  const filteredThreads = forumThreads.filter(thread => {
    const matchesCategory = activeCategory === 'all' || thread.category === activeCategory;
    const matchesSearch = searchQuery === '' ||
      thread.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      thread.excerpt.toLowerCase().includes(searchQuery.toLowerCase()) ||
      thread.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
    return matchesCategory && matchesSearch;
  });

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-green-800 to-green-900 text-white py-16 px-4">
        <div className="max-w-6xl mx-auto text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            Pet Nutrition Community
          </h1>
          <p className="text-xl text-primary-100 max-w-3xl mx-auto">
            Connect with fellow pet parents, share recipes, get advice from experts,
            and learn from real experiences in our supportive community.
          </p>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        {/* Community Stats */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
          {stats.map((stat, index) => (
            <div key={index} className="bg-white rounded-lg shadow-md p-6 text-center">
              <stat.icon className={`w-8 h-8 mx-auto mb-3 ${stat.color}`} />
              <div className="text-2xl font-bold text-gray-900 mb-1">{stat.value}</div>
              <div className="text-sm text-gray-600">{stat.label}</div>
            </div>
          ))}
        </div>

        {/* Quick Links */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Explore Community</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Link
              href="/forum/gallery"
              className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <ChefHat className="w-8 h-8 text-primary-600" />
              <div>
                <div className="font-semibold text-gray-900">Recipe Gallery</div>
                <div className="text-sm text-gray-600">Browse community modifications</div>
              </div>
            </Link>
            <Link
              href="/forum?category=recipes"
              className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <MessageSquare className="w-8 h-8 text-green-600" />
              <div>
                <div className="font-semibold text-gray-900">Recipe Discussions</div>
                <div className="text-sm text-gray-600">Ask questions, share tips</div>
              </div>
            </Link>
            <Link
              href="/forum?category=health"
              className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <Users className="w-8 h-8 text-blue-600" />
              <div>
                <div className="font-semibold text-gray-900">Health Support</div>
                <div className="text-sm text-gray-600">Connect with other pet parents</div>
              </div>
            </Link>
          </div>
        </div>

        {/* Search and Filters */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
          <div className="flex flex-col md:flex-row gap-4">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <input
                type="text"
                placeholder="Search discussions, recipes, or topics..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              />
            </div>
            <button className="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
              <Plus className="w-5 h-5" />
              Start Discussion
            </button>
          </div>

          {/* Category Filters */}
          <div className="flex flex-wrap gap-2 mt-4">
            {categories.map((category) => (
              <button
                key={category.id}
                onClick={() => setActiveCategory(category.id)}
                className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                  activeCategory === category.id
                    ? 'bg-primary-600 text-white'
                    : category.color + ' hover:opacity-80'
                }`}
              >
                {category.name} ({category.count})
              </button>
            ))}
          </div>
        </div>

        {/* Forum Threads */}
        <div className="space-y-4">
          {filteredThreads.map((thread) => (
            <div key={thread.id} className="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
              <div className="p-6">
                <div className="flex items-start gap-4">
                  {/* Avatar */}
                  <div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                    <span className="text-gray-600 font-semibold text-lg">
                      {thread.author.charAt(0).toUpperCase()}
                    </span>
                  </div>

                  {/* Thread Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          {thread.isSticky && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium">
                              STICKY
                            </span>
                          )}
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            thread.category === 'recipes' ? 'bg-blue-100 text-blue-800' :
                            thread.category === 'health' ? 'bg-red-100 text-red-800' :
                            thread.category === 'nutrition' ? 'bg-green-100 text-green-800' :
                            'bg-gray-100 text-gray-800'
                          }`}>
                            {categories.find(c => c.id === thread.category)?.name}
                          </span>
                        </div>

                        <Link href="/forum">
                          <h3 className="text-lg font-semibold text-gray-900 hover:text-primary-600 transition-colors mb-2">
                            {thread.title}
                          </h3>
                        </Link>

                        <p className="text-gray-600 text-sm mb-3 line-clamp-2">
                          {thread.excerpt}
                        </p>

                        {/* Tags */}
                        <div className="flex flex-wrap gap-1 mb-3">
                          {thread.tags.map((tag) => (
                            <span
                              key={tag}
                              className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs"
                            >
                              #{tag}
                            </span>
                          ))}
                        </div>

                        {/* Thread Meta */}
                        <div className="flex items-center gap-4 text-sm text-gray-500">
                          <span>by <strong className="text-gray-700">{thread.author}</strong></span>
                          <span>Last reply {thread.lastReply} by {thread.lastReplyBy}</span>
                        </div>
                      </div>

                      {/* Thread Stats */}
                      <div className="flex flex-col items-end gap-2 text-sm text-gray-500">
                        <div className="flex items-center gap-1">
                          <MessageCircle className="w-4 h-4" />
                          <span>{thread.replies} replies</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <Eye className="w-4 h-4" />
                          <span>{thread.views.toLocaleString()} views</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Load More */}
        <div className="text-center mt-8">
          <button className="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            Load More Discussions
          </button>
        </div>

        {/* Community Guidelines */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8">
          <h3 className="text-lg font-semibold text-blue-900 mb-3">Community Guidelines</h3>
          <ul className="text-blue-800 text-sm space-y-2">
            <li>‚Ä¢ Be respectful and supportive of fellow pet parents</li>
            <li>‚Ä¢ Always consult your veterinarian for health-related advice</li>
            <li>‚Ä¢ Share your experiences and learn from others</li>
            <li>‚Ä¢ No spam, self-promotion, or inappropriate content</li>
            <li>‚Ä¢ Report any concerns to our moderation team</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/globals.css">
/* ============================================
   IMAGE FILTER NEUTRALIZATION
   Prevent unwanted filters from being applied to images
   BUT allow explicit inline filter styles to work
   ============================================ */

/* Override Tailwind CSS filter variables for images and all parent containers */
img,
img *,
* img {
  --tw-blur: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-brightness: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-contrast: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-grayscale: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-hue-rotate: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-invert: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-saturate: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-sepia: var(--tw-empty, /*!*/ /*!*/) !important;
  --tw-drop-shadow: var(--tw-empty, /*!*/ /*!*/) !important;
}

/* Only prevent filters on images that don't have explicit inline filter styles */
img:not([style*="filter"]) {
  filter: none !important;
  -webkit-filter: none !important;
  isolation: isolate !important;
}

/* Prevent Tailwind filter utility classes from affecting images */
img.blur,
img.invert,
img.brightness,
img.contrast,
img.grayscale,
img.hue-rotate,
img.saturate,
img.sepia {
  filter: none !important;
  -webkit-filter: none !important;
}

/* Prevent parent containers with Tailwind filter classes from affecting images */
.blur img,
.invert img,
.brightness img,
.contrast img,
.grayscale img,
.hue-rotate img,
.saturate img,
.sepia img {
  filter: none !important;
  -webkit-filter: none !important;
  isolation: isolate !important;
}

/* Prevent any filter inheritance from parent containers */
img {
  isolation: isolate !important;
  mix-blend-mode: normal !important;
}

/* Specific fix for mascot images - ensure they can use filters if needed */
img[src*="Sherlock"],
img[src*="Harvest"],
img[src*="Mascots"] {
  mix-blend-mode: normal !important;
  isolation: isolate !important;
  forced-color-adjust: none !important;
  -webkit-forced-color-adjust: none !important;
}

/* Specific fix for badge images - prevent color inversion */
img[src*="ElvenBadges"],
img[src*="/images/ElvenBadges/"] {
  filter: none !important;
  -webkit-filter: none !important;
  isolation: isolate !important;
  mix-blend-mode: normal !important;
  forced-color-adjust: none !important;
  -webkit-forced-color-adjust: none !important;
}

/* Also target Next.js Image components that render badge images */
.next-image img[src*="ElvenBadges"],
img[src*="ElvenBadges"][class*="object-contain"] {
  filter: none !important;
  -webkit-filter: none !important;
}

/* Utility class for badge images */
.no-invert-badge {
  filter: none !important;
  -webkit-filter: none !important;
  isolation: isolate !important;
}

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --foreground-rgb: 240, 240, 240;
  --background-start-rgb: 10, 30, 20;
  --background-end-rgb: 15, 35, 25;
}

body {
  color: rgb(var(--foreground-rgb));
  background: linear-gradient(
      to bottom,
      transparent,
      rgb(var(--background-end-rgb))
    )
    rgb(var(--background-start-rgb));
}

@layer utilities {
  .text-balance {
    text-wrap: balance;
  }
}

/* Modern Button Design System */
@layer components {
  /* Base Button Styles */
  .btn {
    @apply relative inline-flex items-center justify-center font-semibold transition-colors duration-200 ease-out;
    @apply border-0 outline-none cursor-pointer;
    @apply select-none active:scale-95;
    border-radius: 12px;
    font-weight: 600;
    letter-spacing: 0.025em;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn:focus-visible {
    @apply ring-2 ring-blue-500 ring-offset-2;
  }

  /* Button Sizes */
  .btn-sm {
    @apply px-4 py-2 text-sm;
    min-height: 36px;
  }

  .btn-md {
    @apply px-6 py-3 text-base;
    min-height: 44px;
  }

  .btn-lg {
    @apply px-8 py-4 text-lg;
    min-height: 52px;
  }

  .btn-xl {
    @apply px-10 py-5 text-xl;
    min-height: 60px;
  }

  /* Primary Button - Green with Orange Border */
  .btn-primary {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    border: 3px solid #f97316;
    box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.5), 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  .btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  /* Secondary Button - Adjusted for Dark Mode */
  .btn-secondary {
    @apply bg-surface text-gray-200;
    border: 3px solid #f97316;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .btn-secondary:hover {
    @apply bg-surface-highlight text-white;
    border-color: #f97316;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* Success Button */
  .btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: #0f2c0f;
    border: 3px solid #f97316;
    box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.5), 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  /* Danger Button */
  .btn-danger {
    background: transparent;
    color: #ef4444;
    border: 3px solid #ef4444;
    outline: 3px solid #ef4444;
    outline-offset: 2px;
    box-shadow: none;
  }

  .btn-danger:hover {
    background: rgba(239, 68, 68, 0.08);
    color: #ef4444;
    border-color: #ef4444;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  /* Warning Button -> Dark Green with Orange text/outline */
  .btn-warning {
    background: #0f2c0f;
    color: #f97316;
    border: 3px solid #f97316;
    outline: 3px solid #0f2c0f;
    outline-offset: 2px;
    box-shadow: 0 6px 20px rgba(15, 44, 15, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-warning:hover {
    background: #0c240c;
    color: #f97316;
    border-color: #f97316;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(15, 44, 15, 0.5), 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  /* Info Button */
  .btn-info {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    color: #0f2c0f;
    border: 3px solid #f97316;
    box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-info:hover {
    background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
    border-color: #f97316;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(66, 153, 225, 0.5), 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  /* Dark Green / Orange Button */
  .btn-darkgreen {
    background: #0f2c0f;
    color: #f97316;
    border: 3px solid #f97316;
    outline: 3px solid #0f2c0f;
    outline-offset: 2px;
    box-shadow: 0 6px 20px rgba(15, 44, 15, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-darkgreen:hover {
    background: #0c240c;
    color: #f97316;
    border-color: #f97316;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(15, 44, 15, 0.5), 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  .btn-darkgreen:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(15, 44, 15, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  /* Ghost Button - Adjusted for Dark Mode */
  .btn-ghost {
    @apply bg-transparent text-gray-300;
    border: 3px solid #f97316;
    box-shadow: none;
  }

  .btn-ghost:hover {
    @apply bg-surface-highlight text-white;
    border-color: #f97316;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Icon Buttons */
  .btn-icon {
    @apply p-3 rounded-full;
    min-width: 44px;
    min-height: 44px;
  }

  .btn-icon-sm {
    @apply p-2;
    min-width: 36px;
    min-height: 36px;
  }

  /* Loading State */
  .btn-loading {
    @apply cursor-not-allowed;
    position: relative;
  }

  .btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .btn-loading > * {
    opacity: 0;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Disabled State */
  .btn:disabled,
  .btn[disabled] {
    @apply cursor-not-allowed opacity-50;
    transform: none !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }

  .btn:disabled:hover,
  .btn[disabled]:hover {
    transform: none !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }

  /* Ripple Effect */
  .btn-ripple {
    position: relative;
    overflow: hidden;
  }

  .btn-ripple::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .btn-ripple:active::before {
    width: 300px;
    height: 300px;
  }

  /* Full Width */
  .btn-full {
    @apply w-full;
  }

  /* Rounded Variants */
  .btn-pill {
    border-radius: 9999px;
  }

  .btn-square {
    border-radius: 8px;
  }
}

/* Base styles for inputs to ensure visibility in dark mode */
@layer base {
  input, textarea, select {
    @apply bg-surface border border-surface-highlight text-foreground rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none;
  }
  
  /* Placeholder color */
  input::placeholder, textarea::placeholder {
    @apply text-gray-500;
  }
}

/* Mascot Animations */
@keyframes breathe {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.02);
  }
}

@keyframes stern-active {
  0%, 100% {
    transform: translateY(0px) rotate(0deg);
  }
  25% {
    transform: translateY(-2px) rotate(-1deg);
  }
  50% {
    transform: translateY(0px) rotate(0deg);
  }
  75% {
    transform: translateY(-2px) rotate(1deg);
  }
}

@keyframes anxious-active {
  0%, 100% {
    transform: translateX(0px) translateY(0px);
  }
  25% {
    transform: translateX(-1px) translateY(-1px);
  }
  50% {
    transform: translateX(1px) translateY(0px);
  }
  75% {
    transform: translateX(-1px) translateY(-1px);
  }
}

@keyframes excitable-active {
  0%, 100% {
    transform: translateY(0px) scale(1);
  }
  25% {
    transform: translateY(-4px) scale(1.05);
  }
  50% {
    transform: translateY(0px) scale(1);
  }
  75% {
    transform: translateY(-4px) scale(1.05);
  }
}

@keyframes thoughtful-active {
  0%, 100% {
    transform: translateY(0px) rotate(0deg);
  }
  25% {
    transform: translateY(-1px) rotate(-0.5deg);
  }
  50% {
    transform: translateY(0px) rotate(0deg);
  }
  75% {
    transform: translateY(-1px) rotate(0.5deg);
  }
}

@keyframes hyperactive-active {
  0%, 100% {
    transform: translateY(0px) rotate(0deg) scale(1);
  }
  25% {
    transform: translateY(-3px) rotate(-2deg) scale(1.03);
  }
  50% {
    transform: translateY(0px) rotate(2deg) scale(1);
  }
  75% {
    transform: translateY(-3px) rotate(-2deg) scale(1.03);
  }
}

.animate-breathe {
  animation: breathe 2s ease-in-out infinite;
}

.animate-stern-active {
  animation: stern-active 1s ease-in-out infinite;
}

.animate-anxious-active {
  animation: anxious-active 0.6s ease-in-out infinite;
}

.animate-excitable-active {
  animation: excitable-active 0.8s ease-in-out infinite;
}

.animate-thoughtful-active {
  animation: thoughtful-active 2s ease-in-out infinite;
}

.animate-hyperactive-active {
  animation: hyperactive-active 0.5s ease-in-out infinite;
}

@keyframes float {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import Navigation from "@/components/Navigation";
import Footer from "@/components/Footer";
import { ClerkProvider } from '@clerk/nextjs';
import ErrorBoundaryWrapper from "@/components/ErrorBoundaryWrapper";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  metadataBase: new URL('https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app'),
  title: {
    default: "Paws & Plates - Fresh Meal Prep for Dogs, Cats, Birds, Reptiles & Small Pets",
    template: "%s | Paws & Plates"
  },
  description: "Free vet-approved meal plans for ALL your pets. Custom recipes for dogs, cats, birds, reptiles, and pocket pets with one-click Amazon ingredient ordering. AAFCO & WSAVA compliant.",
  keywords: [
    "homemade dog food",
    "homemade cat food", 
    "DIY pet meals",
    "pet meal prep",
    "fresh pet food recipes",
    "vet approved pet food",
    "custom pet nutrition",
    "AAFCO pet food",
    "bird food recipes",
    "reptile diet plans",
    "small pet nutrition",
    "homemade pet food delivery",
    "pet meal planner",
    "healthy pet recipes",
    "balanced dog nutrition",
    "cat diet recipes"
  ],
  authors: [{ name: "Paws & Plates Team" }],
  creator: "Paws & Plates",
  publisher: "Paws & Plates",
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
  openGraph: {
    type: 'website',
    locale: 'en_US',
    url: 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app',
    siteName: 'Paws & Plates',
    title: 'Paws & Plates - Fresh Meal Prep for Dogs, Cats, Birds, Reptiles & Small Pets',
    description: 'Free vet-approved meal plans for ALL your pets. Custom recipes with one-click Amazon ordering. AAFCO & WSAVA compliant nutrition.',
    images: [
      {
        url: '/images/emojis/Mascots/HeroPics/HeroBanner-v3.png',
        width: 1200,
        height: 630,
        alt: 'Paws & Plates - Meal prep for all pets',
      }
    ],
  },
  twitter: {
    card: 'summary_large_image',
    title: 'Paws & Plates - Fresh Meal Prep for Dogs, Cats, Birds, Reptiles & Small Pets',
    description: 'Free vet-approved meal plans for ALL your pets. Custom recipes with one-click Amazon ordering.',
    images: ['/images/emojis/Mascots/HeroPics/HeroBanner-v3.png'],
  },
  alternates: {
    canonical: 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app',
  },
  verification: {
    // Add these later when you have accounts:
    // google: 'your-google-verification-code',
    // yandex: 'your-yandex-verification-code',
    // bing: 'your-bing-verification-code',
  },
  category: 'Pet Care',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ClerkProvider
      publishableKey={process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
    >
      <html lang="en" suppressHydrationWarning>
        <head>
          {/* Additional SEO tags */}
          <link rel="icon" href="/favicon.ico" />
          <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
          <meta name="theme-color" content="#043136" />
          <meta name="apple-mobile-web-app-capable" content="yes" />
          <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
          
          {/* Schema.org markup for Google */}
          <script
            type="application/ld+json"
            dangerouslySetInnerHTML={{
              __html: JSON.stringify({
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "Paws & Plates",
                "description": "Free vet-approved meal plans for dogs, cats, birds, reptiles, and pocket pets",
                "url": "https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app",
                "potentialAction": {
                  "@type": "SearchAction",
                  "target": "https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app/search?q={search_term_string}",
                  "query-input": "required name=search_term_string"
                }
              })
            }}
          />
        </head>
        <body className={`${inter.className} bg-background text-foreground min-h-screen`}>
          <ErrorBoundaryWrapper>
            <Navigation />
            <main className="min-h-screen">
              {children}
            </main>
            <Footer />
          </ErrorBoundaryWrapper>
        </body>
      </html>
    </ClerkProvider>
  );
}
</file>

<file path="app/meal-plans/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { Check, Calendar, ShoppingCart } from 'lucide-react';
import { PetCategory } from '@/lib/types';

export default function MealPlansPage() {
  const [selectedCategory, setSelectedCategory] = useState<PetCategory>('dogs');
  const [planType, setPlanType] = useState<'one-time' | 'weekly'>('weekly');

  // Recipes are now generated dynamically
  const categoryRecipes: any[] = [];

  const planOptions = [
    {
      id: 'one-time',
      name: 'One-Time Meal',
      description: 'Single fresh meal for your pet',
      price: 12.99,
      features: [
        'Choose any recipe',
        'Complete ingredient list',
        'Detailed instructions',
        'Nutritional breakdown',
      ],
    },
    {
      id: 'weekly',
      name: 'Weekly Plan',
      description: '14 meals (2 per day for 7 days)',
      price: 89.99,
      savings: 'Save $92',
      features: [
        'Variety of meals',
        'All ingredients included',
        'Portion controlled',
        'Delivery schedule',
        'Flexible menu changes',
        'Cancel anytime',
      ],
    },
  ];
  const whyCards = [
    {
      id: 'standards',
      title: 'AAFCO Approved',
      subtitle: 'All meals meet or exceed AAFCO + WSAVA nutritional standards',
      hover:
        'AAFCO = Association of American Feed Control Officials. WSAVA = World Small Animal Veterinary Association. We follow both so every bowl stays complete and balanced.',
    },
    {
      id: 'ordering',
      title: 'Easy Ordering',
      subtitle: 'Get every ingredient delivered or buy them with one click online',
      hover:
        'Order from Major Pet Retailers, Chewy, Petco, Walmart, plus fresh options like Ollie, The Farmer‚Äôs Dog, Butternut Box, HolistaPet, and affiliate networks (Skimlinks, Rakuten, CJ, ShareASale).',
    },
    {
      id: 'mealprep',
      title: 'Why Meal Prep?',
      subtitle: 'Fresh prep beats whatever comes in a bag‚Äîevery single time.',
      hover:
        'Meal prepping keeps pets healthier with fresh ingredients tailored to their needs‚Äînot generic kibble. Paw & Plate knows species, age, size, and health concerns, then auto-adjusts portions and links the exact products you can buy today.',
    },
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-primary-600 to-primary-800 text-white py-12 px-4">
        <div className="max-w-7xl mx-auto">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            Meal Plans
          </h1>
          <p className="text-xl text-primary-100">
            Choose the perfect meal plan for your pet
          </p>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-12">
        {/* Category Selection */}
        <div className="mb-12">
          <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
            Select Your Pet Category
          </h2>
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
            {[
              { id: 'dogs' as PetCategory, name: 'Dogs', emoji: 'üêï' },
              { id: 'cats' as PetCategory, name: 'Cats', emoji: 'üêà' },
              { id: 'birds' as PetCategory, name: 'Birds', emoji: 'ü¶ú' },
              { id: 'reptiles' as PetCategory, name: 'Reptiles', emoji: 'ü¶é' },
              { id: 'pocket-pets' as PetCategory, name: 'Pocket Pets', emoji: 'üê∞' },
            ].map((category) => (
              <button
                key={category.id}
                onClick={() => setSelectedCategory(category.id)}
                className={`p-6 rounded-lg border-2 transition-all ${
                  selectedCategory === category.id
                    ? 'border-primary-600 bg-primary-50'
                    : 'border-gray-200 bg-white hover:border-primary-300'
                }`}
              >
                <div className="text-4xl mb-2">{category.emoji}</div>
                <div className="font-semibold text-gray-900">{category.name}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Plan Type Selection */}
        <div className="mb-12">
          <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
            Choose Your Plan
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
            {planOptions.map((plan) => (
              <div
                key={plan.id}
                className={`bg-white rounded-lg shadow-lg overflow-hidden transition-all ${
                  planType === plan.id
                    ? 'ring-4 ring-primary-600'
                    : 'hover:shadow-xl'
                }`}
              >
                <div className="p-8">
                  {plan.savings && (
                    <div className="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold mb-4">
                      {plan.savings}
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">
                    {plan.name}
                  </h3>
                  <p className="text-gray-600 mb-4">{plan.description}</p>
                  <div className="mb-6">
                    <span className="text-4xl font-bold text-gray-900">${plan.price}</span>
                    <span className="text-gray-600 ml-2">
                      {plan.id === 'weekly' ? '/week' : '/meal'}
                    </span>
                  </div>
                  <button
                    onClick={() => setPlanType(plan.id as 'one-time' | 'weekly')}
                    className={`w-full py-3 rounded-lg font-semibold transition-colors ${
                      planType === plan.id
                        ? 'bg-primary-600 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {planType === plan.id ? 'Selected' : 'Select Plan'}
                  </button>
                </div>
                <div className="bg-gray-50 p-8 border-t">
                  <h4 className="font-semibold text-gray-900 mb-4">What's included:</h4>
                  <ul className="space-y-3">
                    {plan.features.map((feature, index) => (
                      <li key={index} className="flex items-start gap-3">
                        <Check size={20} className="text-green-600 flex-shrink-0 mt-0.5" />
                        <span className="text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Sample Weekly Menu */}
        {planType === 'weekly' && (
          <div className="mb-12">
            <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
              Sample Weekly Menu for {selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1)}
            </h2>
            <div className="bg-white rounded-lg shadow-md p-8">
              <div className="grid grid-cols-1 md:grid-cols-7 gap-4">
                {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, dayIndex) => (
                  <div key={day} className="border rounded-lg p-4">
                    <h3 className="font-bold text-gray-900 mb-3 text-center">{day}</h3>
                    <div className="space-y-3">
                      {[0, 1].map((mealIndex) => {
                        const recipeIndex = (dayIndex * 2 + mealIndex) % categoryRecipes.length;
                        const recipe = categoryRecipes[recipeIndex];
                        return recipe ? (
                          <div key={mealIndex} className="bg-gray-50 rounded p-2">
                            <div className="text-xs font-semibold text-gray-600 mb-1">
                              {mealIndex === 0 ? 'Breakfast' : 'Dinner'}
                            </div>
                            <div className="text-sm font-medium text-gray-900 line-clamp-2">
                              {recipe.name}
                            </div>
                          </div>
                        ) : null;
                      })}
                    </div>
                  </div>
                ))}
              </div>
              <p className="text-center text-gray-600 mt-6">
                Menus are customized based on your pet's breed, age, and health needs
              </p>
            </div>
          </div>
        )}

        {/* CTA Section */}
        <div className="bg-gradient-to-r from-primary-600 to-primary-800 rounded-lg p-12 text-center text-white">
          <h2 className="text-3xl font-bold mb-4">
            Ready to Get Started?
          </h2>
          <p className="text-xl text-primary-100 mb-8 max-w-2xl mx-auto">
            Complete your pet's profile to receive a personalized meal plan with meals tailored to their needs
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <Link
              href={`/category/${selectedCategory}`}
              className="inline-flex items-center justify-center gap-2 px-8 py-4 bg-white text-primary-700 font-semibold rounded-lg hover:bg-primary-50 transition-colors"
            >
              <Calendar size={20} />
              Customize My Plan
            </Link>
            <Link
              href="/profile"
              className="inline-flex items-center justify-center gap-2 px-8 py-4 bg-primary-700 text-white font-semibold rounded-lg hover:bg-primary-600 transition-colors border-2 border-white"
            >
              My Pets
            </Link>
          </div>
        </div>

        {/* Why Pet Plates */}
        <div className="mt-16 grid grid-cols-1 md:grid-cols-3 gap-8">
          {whyCards.map((card) => {
            const Icon =
              card.id === 'standards' ? Check : card.id === 'ordering' ? ShoppingCart : Calendar;
            return (
              <div
                key={card.id}
                className="relative group text-center bg-white rounded-xl shadow p-8 overflow-hidden"
              >
                <div className="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Icon size={32} className="text-primary-600" />
                </div>
                <h3 className="text-xl font-bold text-gray-900 mb-2">{card.title}</h3>
                <p className="text-gray-600">{card.subtitle}</p>
                <div className="absolute inset-0 bg-white/95 px-4 py-6 text-sm text-gray-700 flex items-center justify-center opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-opacity duration-200">
                  <p className="leading-relaxed">{card.hover}</p>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/nutrition-guide/page.tsx">
'use client';

import Link from 'next/link';

const foundations = [
  'AAFCO nutrient profiles for growth, maintenance, and senior diets (dogs/cats)',
  'NRC (National Research Council) data for exotic species',
  'Pet health specialist guidance for balancing protein, fats, essential amino acids, minerals, vitamins, and calories',
  'Evidence-backed functional ingredients (joint care, skin, digestion, urinary health, metabolic support)',
];

const adjustments = [
  'Species-specific needs',
  'Breed tendencies',
  'Age and activity level',
  'Weight goals',
  'Medical considerations (allergies, joint support, etc.)',
];

export default function NutritionGuidePage() {
  return (
    <div className="min-h-screen bg-gray-50 py-16 px-4">
      <div className="max-w-5xl mx-auto space-y-8">
        <div>
          <Link href="/" className="text-orange-600 font-semibold hover:underline">
            ‚Üê Back to home
          </Link>
        </div>
        <header>
          <h1 className="text-4xl font-extrabold text-gray-900 mb-3">Nutrition Guide</h1>
          <p className="text-lg text-gray-600 max-w-3xl">
            Paw & Plate uses peer-reviewed science, pet health specialist standards, and functional ingredients to
            keep every fresh meal nutritionally complete.
          </p>
        </header>

        <section className="bg-white rounded-2xl shadow p-6 border border-gray-100">
          <h2 className="text-2xl font-semibold text-gray-900 mb-4">Our foundation</h2>
          <p className="text-gray-600 mb-4">
            We build meal templates using the following evidence-based references:
          </p>
          <ul className="space-y-2 list-disc list-inside text-gray-700">
            {foundations.map((item) => (
              <li key={item}>{item}</li>
            ))}
          </ul>
        </section>

        <section className="bg-white rounded-2xl shadow p-6 border border-gray-100">
          <h2 className="text-2xl font-semibold text-gray-900 mb-4">Key philosophy</h2>
          <p className="text-gray-600 mb-4">
            Nutrition isn‚Äôt one-size-fits-all. Every Paw & Plate meal starts balanced, then adapts to
            your pet‚Äôs unique context.
          </p>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">We adjust for:</h3>
              <ul className="space-y-2 list-disc list-inside text-gray-700">
                {adjustments.map((item) => (
                  <li key={item}>{item}</li>
                ))}
              </ul>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">Non-negotiables</h3>
              <p className="text-gray-600">
                Every meal starts nutritionally complete. Functional modifications only add benefits ‚Äî
                they never reduce baseline requirements.
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="app/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Check, Calendar, ShoppingCart, ArrowRight, Sparkles } from 'lucide-react';
import { useUser, SignOutButton } from '@clerk/nextjs'; 
import { PetCategory } from '@/lib/types';
import QuickPreviewModal from '@/components/QuickPreviewModal';
import SocialProof, { TestimonialSection } from '@/components/SocialProof';
import EmailCaptureModal, { useExitIntent } from '@/components/EmailCaptureModal';
import ABTestDashboard from '@/components/ABTestDashboard';
import TrustBadges from '@/components/TrustBadges';

const getPetData = (userId: string) => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  return stored ? JSON.parse(stored) : [];
};

const whyCards = [
  {
    id: 'standards',
    title: 'AAFCO Approved',
    subtitle: 'All meals meet or exceed AAFCO + WSAVA nutritional standards',
    hover:
      '**AAFCO** (Association of American Feed Control Officials) and **WSAVA** (World Small Animal Veterinary Association) set the gold standard for pet nutrition. We build every meal to those benchmarks with guidance from pet health specialists so your pet stays balanced.',
    icon: Check,
  },
  {
    id: 'ordering',
    title: 'Easy Ordering',
    subtitle: 'Get every ingredient delivered or buy them with one click on Amazon',
    hover:
      'Source ingredients from **Major Pet Retailers** like **Amazon**, Chewy, Petco, Walmart, Ollie, The Farmer\'s Dog, Butternut Box, HolistaPet, plus affiliate networks like Skimlinks, Rakuten, CJ, and ShareASale.',
    icon: ShoppingCart,
  },
  {
    id: 'plans',
    title: 'Why Meal Prep?',
    subtitle: 'Fresh prep beats whatever comes in a bag‚Äîevery single time.',
    hover:
      'Meal prepping keeps pets healthier with fresh ingredients tailored to their needs. Paws & Plates knows species, age, size, and health concerns, then auto-adjusts portions and links trusted products you can buy today.',
    icon: Calendar,
  },
];

const WhyUsSection = () => (
  <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
    {whyCards.map((card) => {
      const Icon = card.icon;
      return (
        <div
          key={card.id}
          className="relative group text-center bg-surface rounded-xl shadow-lg border border-surface-highlight p-8 overflow-hidden hover:shadow-xl transition-shadow duration-300"
        >
          <div className="w-16 h-16 bg-surface-highlight rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10">
            <Icon size={32} className="text-orange-400" />
          </div>
          <h3 className="text-xl font-bold text-foreground mb-2">{card.title}</h3>
          <p className="text-gray-400">{card.subtitle}</p>
          <div className="absolute inset-0 bg-surface/95 px-4 py-6 text-sm text-gray-200 flex items-center justify-center opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-opacity duration-200 backdrop-blur-sm">
            <p className="leading-relaxed"><strong>{card.hover}</strong></p>
          </div>
        </div>
      );
    })}
  </div>
);

export default function HomePage() { 
  const { user, isLoaded } = useUser();
  const [selectedCategory, setSelectedCategory] = useState<PetCategory>('dogs');
  const [showPreviewModal, setShowPreviewModal] = useState(false);
  const [showEmailCapture, setShowEmailCapture] = useState(false);
  
  // Exit intent - show email capture when user tries to leave
  useExitIntent(() => {
    if (!user && !showEmailCapture) {
      setShowEmailCapture(true);
    }
  });
  
  // Get userId for purchase tracking
  const userId = user?.id || (typeof window !== 'undefined' ? localStorage.getItem('last_user_id') || '' : '');
  
  if (isLoaded && user?.id) {
    const pets = getPetData(user.id);
    const hasPets = pets.length > 0;
    
    return (
      <div className="min-h-screen bg-background text-foreground">
        <header className="relative w-full border-b border-surface-highlight py-8" style={{ backgroundColor: '#043136' }}>
          <div className="max-w-4xl mx-auto relative w-full aspect-[16/9] h-[500px] md:h-[600px]">
            <Image
              src="/images/emojis/Mascots/HeroPics/LOGO.png"
              alt="Paws & Plates - Meal prep for All your pets"
              fill
              className="object-contain"
              priority
            />
          </div>
        </header>

        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <section className="text-center mb-12">
            <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight text-white mb-4">
              Welcome Back, {user.firstName || 'Pet Owner'}!
            </h1>
            <p className="text-xl md:text-2xl text-gray-300 max-w-2xl mx-auto mb-8">
              Fresh, vet-approved, and personalized nutrition for your beloved pets.
            </p>
          </section>
          
          <section className="py-12">
            <h2 className="text-2xl font-bold text-white mb-8 text-center">Why Paws & Plates?</h2>
            <WhyUsSection />
          </section>
        </main>

        <footer className="py-6 text-center text-sm text-gray-500 border-t border-surface-highlight">
          <SignOutButton>
            <button className="text-orange-400 hover:text-orange-300 font-medium">
              Log Out
            </button>
          </SignOutButton>
        </footer>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background text-foreground">
      <header className="relative w-full border-b border-surface-highlight py-8" style={{ backgroundColor: '#043136' }}>
        <div className="max-w-4xl mx-auto relative w-full aspect-[16/9] h-[250px] md:h-[300px]">
          <Image
            src="/images/emojis/Mascots/HeroPics/HeroBanner-v3.png"
            alt="Paws & Plates - Meal prep made easy, for ALL your pets!"
            fill
            className="object-contain"
            priority
          />
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <section className="text-center mb-12">
          <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
            {/* PRIMARY CTA - See Examples (Drives Affiliate Clicks!) */}
            <button
              onClick={() => setShowPreviewModal(true)}
              className="btn btn-lg bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white border-3 border-orange-400 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center gap-2"
            >
              <Sparkles size={24} />
              See Example Meals
              <ArrowRight size={20} />
            </button>
            
            {/* Secondary CTA */}
            <Link
              href="/sign-up"
              className="btn btn-lg btn-success"
            >
              Create Free Account
            </Link>
          </div>
          
          {/* Value Prop Subheading */}
          <p className="text-gray-400 text-sm mt-4">
            üéØ View meals instantly ‚Ä¢ No signup required ‚Ä¢ Start shopping now
          </p>
        </section>

        {/* Trust Badges */}
        <section className="py-8">
          <TrustBadges />
        </section>

        {/* Social Proof Section */}
        <section className="py-12">
          <SocialProof />
        </section>

        <section className="py-12 border-t border-surface-highlight">
          <WhyUsSection />
        </section>

        {/* Testimonials Section */}
        <section className="py-12 border-t border-surface-highlight">
          <TestimonialSection />
        </section>
      </main>

      {/* Quick Preview Modal */}
      <QuickPreviewModal 
        isOpen={showPreviewModal}
        onClose={() => setShowPreviewModal(false)}
      />

      {/* Email Capture Modal (Exit Intent) */}
      <EmailCaptureModal
        isOpen={showEmailCapture}
        onClose={() => setShowEmailCapture(false)}
        petType="your pet"
        mealCount={5}
        trigger="exit-intent"
      />

      {/* A/B Test Dashboard (Admin) */}
      <ABTestDashboard />
    </div>
  );
}
</file>

<file path="app/pets/[id]/page.tsx">
'use client';

import { useEffect, useState, useMemo } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';
import { NutritionDashboard } from '@/components/NutritionDashboard';
import { calculateDailyNutrition, getNutritionTargets } from '@/lib/nutrition/nutritionHistory';
import { getCustomMeals } from '@/lib/utils/customMealStorage';
import type { Recipe, CustomMeal } from '@/lib/types';

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

const getCurrentUserId = () => {
  if (typeof window === 'undefined') return SIMULATED_USER_ID;
  return localStorage.getItem('last_user_id') || SIMULATED_USER_ID;
};

const getPetsFromLocalStorage = (userId: string) => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  if (!stored) return [];
  try {
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
};

const convertCustomMealToRecipe = (customMeal: CustomMeal): Recipe => {
  return {
    id: customMeal.id,
    name: customMeal.name,
    category: 'custom',
    ageGroup: ['adult'],
    healthConcerns: [],
    description: `Custom meal created on ${new Date(customMeal.createdAt).toLocaleDateString()}`,
    ingredients: customMeal.ingredients.map((ing, idx) => ({
      id: `${idx + 1}`,
      name: ing.key.replace(/_/g, ' '),
      amount: `${ing.grams}g`,
    })),
    instructions: ['Mix all ingredients according to saved recipe', 'Serve at recommended portion size'],
    nutritionalInfo: {
      protein: {
        min: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      fat: {
        min: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      calories: {
        min: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        max: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        unit: 'kcal',
      },
    },
    rating: 0,
    reviews: 0,
    tags: ['custom', 'user-created'],
  };
};

const buildEvenPlan = (meals: Recipe[]) => {
  const totalSlots = DAYS.length * 2;
  const rotation: Recipe[] = [];
  while (rotation.length < totalSlots) {
    rotation.push(...meals);
  }
  return rotation.slice(0, totalSlots);
};

export default function NutritionPage() {
  const params = useParams();
  const router = useRouter();
  const petId = params.id as string;
  const [pet, setPet] = useState<any>(null);
  const [savedMeals, setSavedMeals] = useState<Recipe[]>([]);
  const [customMeals, setCustomMeals] = useState<CustomMeal[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadPetData() {
      const userId = getCurrentUserId();
      const pets = getPetsFromLocalStorage(userId);
      const foundPet = pets.find((p: any) => p.id === petId) || null;
      setPet(foundPet);
      if (foundPet) {
        // Saved recipes are no longer stored statically
        setSavedMeals([]);
        const customMealsList = await getCustomMeals(userId, petId);
        setCustomMeals(customMealsList);
      }
      setLoading(false);
    }
    loadPetData();
  }, [petId]);

  const weeklyPlan = useMemo(() => {
    const allMeals = [...savedMeals, ...customMeals.map(convertCustomMealToRecipe)];
    if (allMeals.length === 0) return [];
    const rotation = buildEvenPlan(allMeals);
    const plan: { day: string; meals: Recipe[] }[] = [];
    for (let i = 0; i < DAYS.length; i += 1) {
      const breakfastIndex = i * 2;
      const dinnerIndex = breakfastIndex + 1;
      const breakfast = rotation[breakfastIndex];
      let dinner = rotation[dinnerIndex];
      if (dinner.id === breakfast.id) {
        const swapIndex = rotation.findIndex((entry, idx) => idx > dinnerIndex && entry.id !== breakfast.id);
        if (swapIndex !== -1) {
          [rotation[dinnerIndex], rotation[swapIndex]] = [rotation[swapIndex], rotation[dinnerIndex]];
          dinner = rotation[dinnerIndex];
        } else {
          dinner = allMeals.find((meal) => meal.id !== breakfast.id) || dinner;
        }
      }
      plan.push({ day: DAYS[i], meals: [breakfast, dinner] });
    }
    return plan;
  }, [savedMeals, customMeals]);

  const dailyNutrition = useMemo(() => calculateDailyNutrition(weeklyPlan), [weeklyPlan]);
  const targets = useMemo(() => getNutritionTargets(pet?.type), [pet?.type]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <p className="text-gray-600">Loading nutrition data...</p>
      </div>
    );
  }

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white p-8 rounded-xl shadow text-center space-y-4">
          <p className="text-xl font-semibold text-gray-800">Pet not found.</p>
          <Link href="/profile" className="text-green-800 font-semibold">
            Back to Profiles
          </Link>
        </div>
      </div>
    );
  }

  if (dailyNutrition.length === 0) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div className="max-w-lg bg-white rounded-xl shadow p-8 text-center space-y-4">
          <div className="text-5xl">üìä</div>
          <h1 className="text-2xl font-bold text-gray-900">No meal plan data</h1>
          <p className="text-gray-600">
            Save at least one meal for {pet.name || 'your pet'} to view nutrition data.
          </p>
          <Link
            href={`/profile/pet/${petId}/meal-plan`}
            className="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            Go to Meal Plan
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4">
        <Link
          href={`/profile/pet/${petId}/meal-plan`}
          className="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6"
        >
          <ArrowLeft size={20} />
          Back to Meal Plan
        </Link>
        <NutritionDashboard daily={dailyNutrition} targets={targets} petName={pet.name || pet.names?.[0] || 'Your Pet'} />
      </div>
    </div>
  );
}
</file>

<file path="app/privacy/page.tsx">
'use client';

import Link from 'next/link';

const sections = [
  {
    title: 'What we collect',
    body: [
      'Account details (email, login provider)',
      'Pet info (name, weight, age, health concerns)',
      'Interaction data that helps improve meal recommendations',
      'We never collect precise addresses or financial data directly.',
    ],
  },
  {
    title: 'How we use data',
    body: [
      'To personalize meal plans',
      'To recommend ingredients and supplements',
      'To improve product features',
      'To show affiliate product links',
    ],
  },
  {
    title: 'Data sharing',
    body: [
      'We do not sell personal information.',
      'We may share anonymous, aggregated insights to improve pet nutrition research and product selection.',
    ],
  },
  {
    title: 'Your control',
    body: [
      'You may update or delete your data at any time.',
      'You can request permanent removal of your account and stored information.',
    ],
  },
  {
    title: 'Security & compliance',
    body: [
      'Industry-standard encryption and limited internal access protect user data.',
      'We follow CCPA and GDPR principles. Full legal language will be added before launch.',
    ],
  },
];

export default function PrivacyPage() {
  return (
    <div className="min-h-screen bg-gray-50 py-16 px-4">
      <div className="max-w-4xl mx-auto space-y-10">
        <div>
          <Link href="/" className="text-orange-600 font-semibold hover:underline">
            ‚Üê Back to home
          </Link>
        </div>
        <header>
          <h1 className="text-4xl font-extrabold text-gray-900 mb-3">Privacy Policy</h1>
          <p className="text-lg text-gray-600 max-w-3xl">
            Plain-language, transparent, and built for trust.
          </p>
        </header>
        {sections.map((section) => (
          <section key={section.title} className="bg-white rounded-2xl shadow p-6 border border-gray-100">
            <h2 className="text-2xl font-semibold text-gray-900 mb-3">{section.title}</h2>
            <ul className="space-y-2 list-disc list-inside text-gray-700">
              {section.body.map((item) => (
                <li key={item}>{item}</li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="app/profile/page.tsx">
'use client';

import React, { useState, useEffect, useCallback, useMemo, startTransition } from 'react';
import Link from 'next/link';
import { Plus, Edit, Trash2, ShoppingCart } from 'lucide-react';
import { getPrimaryName } from '@/lib/utils/petUtils';
import type { Pet } from '@/lib/types';
import { v4 as uuidv4 } from 'uuid';
import HealthConcernsDropdown from '@/components/HealthConcernsDropdown';
import { useVillageStore } from '@/lib/state/villageStore';
import { getMascotFaceForPetType, getProfilePictureForPetType } from '@/lib/utils/emojiMapping';
import AddPetModal from '@/components/CreatePetModal';
import { getCustomMeals } from '@/lib/utils/customMealStorage';
import { getPets, savePet, deletePet } from '@/lib/utils/petStorage'; // Import from storage util
import type { CustomMeal } from '@/lib/types';
import { getVettedProduct, VETTED_PRODUCTS } from '@/lib/data/vetted-products';
import Image from 'next/image';
import EmojiIcon from '@/components/EmojiIcon';
import { ensureCartUrlSellerId } from '@/lib/utils/affiliateLinks';
import ConfirmModal from '@/components/ConfirmModal';
import { nutritionalGuidelines } from '@/lib/data/nutritional-guidelines';
import { calculateEnhancedCompatibility, calculateRecipeNutrition, type Pet as EnhancedPet } from '@/lib/utils/enhancedCompatibilityScoring';
import type { Recipe } from '@/lib/types';
import { checkAllBadges } from '@/lib/utils/badgeChecker';
import PetBadges from '@/components/PetBadges';
import BadgeToggle from '@/components/BadgeToggle';
import Tooltip from '@/components/Tooltip';

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

const convertCustomMealToRecipe = (customMeal: CustomMeal): any => {
  return {
    id: customMeal.id,
    name: customMeal.name,
    category: 'custom',
    ageGroup: ['adult'],
    healthConcerns: [],
    description: `Custom meal created on ${customMeal.createdAt ? new Date(customMeal.createdAt).toLocaleDateString() : ''}`,
    ingredients: customMeal.ingredients.map((ing, idx) => ({
      id: `${idx + 1}`,
      name: ing.key.replace(/_/g, ' '),
      amount: `${ing.grams}g`,
    })),
    instructions: [
      'Mix all ingredients according to saved recipe',
      'Serve at recommended portion size',
      `Recommended serving: ${customMeal.analysis.recommendedServingGrams}g`,
    ],
    nutritionalInfo: {
      protein: {
        min: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      fat: {
        min: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      calories: {
        min: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        max: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        unit: 'kcal',
      },
    },
    rating: 0,
    reviews: 0,
    tags: ['custom', 'user-created'],
  };
};

const buildEvenPlan = (meals: any[]) => {
  const totalSlots = DAYS.length * 2;
  const rotation: any[] = [];
  if (meals.length === 0) return [];
  while (rotation.length < totalSlots) {
    rotation.push(...meals);
  }
  return rotation.slice(0, totalSlots);
};

// =================================================================
// 1. TYPES & LOCAL STORAGE FUNCTIONS
// =================================================================

type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
type AgeGroup = 'baby' | 'young' | 'adult' | 'senior';

type ProfilePet = Pet;

// Simulated user id (replace with Clerk user.id in real auth)
const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

// =================================================================
// 2. DATA CONSTANTS
// =================================================================

import { getBreedNamesForSpecies } from '@/lib/data/speciesBreeds';

// Get breeds from centralized source
const PET_BREEDS: Record<PetCategory, string[]> = {
  dogs: [...getBreedNamesForSpecies('dogs'), 'Other'],
  cats: [...getBreedNamesForSpecies('cats'), 'Other'],
  birds: [...getBreedNamesForSpecies('birds'), 'Other'],
  reptiles: [...getBreedNamesForSpecies('reptiles'), 'Other'],
  'pocket-pets': [...getBreedNamesForSpecies('pocket-pets'), 'Other'],
};

// Health concerns are now handled by HealthConcernsDropdown component
// This old array is no longer used - kept for reference only
// const PET_HEALTH_CONCERNS: string[] = [
//   'Allergy Support',
//   'Weight Management',
//   'Digestive Health',
//   'Joint & Mobility',
//   'Skin & Coat',
//   'Dental Health',
//   'Kidney/Urinary Support',
//   'Other',
// ];

// =================================================================
// 3. ICON UTILITY
// =================================================================

const formatRecipeName = (id: string) => {
  if (!id) return 'Unnamed Meal';
  // Replace dashes/underscores with spaces and title-case segments
  return id
    .replace(/[-_]+/g, ' ')
    .split(' ')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ')
    .trim();
};

type WeeklyPlanEntry = {
  day: string;
  meals: (string | null)[];
};

const PET_ICON_MAP: Record<PetCategory, string> = {
  dogs: 'üêï',
  cats: 'üêà',
  birds: 'ü¶ú',
  reptiles: 'ü¶é',
  'pocket-pets': 'üê∞',
};

const getPetIcon = (type: PetCategory, breed: string = '', size: number = 24, className = '') => {
  // Ensure type is valid
  if (!type || !PET_ICON_MAP[type]) {
    return <EmojiIcon emoji="üêæ" size={size} className={className} />;
  }
  
  let emoji = PET_ICON_MAP[type];
  
  // Handle pocket-pets breed-specific emojis
  if (type === 'pocket-pets' && breed) {
    const breedLower = breed.toLowerCase();
    if (breedLower.includes('hamster')) emoji = 'üêπ';
    else if (breedLower.includes('gerbil')) emoji = 'üêπ'; // No gerbil emoji, use hamster
    else if (breedLower.includes('guinea pig') || breedLower.includes('guinea-pig')) emoji = 'üêπ';
    else if (breedLower.includes('rat')) emoji = 'üê≠';
    else if (breedLower.includes('mouse')) emoji = 'üê≠';
    else if (breedLower.includes('chinchilla')) emoji = 'üêπ';
    else if (breedLower.includes('hedgehog')) emoji = 'ü¶î';
    else if (breedLower.includes('ferret')) emoji = 'ü¶¶'; // Closest
    // Default to rabbit (üê∞) for pocket-pets
  }
  
  return <EmojiIcon emoji={emoji} size={size} className={className} />;
};

// =================================================================
// 4. PET MODAL COMPONENT
// =================================================================

interface PetModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (pet: any) => void;
  editingPet: Pet | null;
}

const PetModal: React.FC<PetModalProps> = ({ isOpen, onClose, onSave, editingPet }) => {
  // Initialize with empty defaults - will be set by useEffect when modal opens
  const [formData, setFormData] = useState<{
    id: string;
    names: string[];
    type: string;
    breed: string;
    age: string;
    weight: string;
    healthConcerns: string[];
    image: string;
  }>({
    id: uuidv4(),
    names: [],
    type: 'dogs',
    breed: '',
    age: 'adult',
    weight: '',
    healthConcerns: [],
    image: '',
  });

  const [newName, setNewName] = useState('');

  // Reset formData when modal opens or editingPet changes to prevent name bleeding between pets
  useEffect(() => {
    // Only update when modal is open
    if (!isOpen) {
      return;
    }
    
    // When modal opens, load the correct data
    if (editingPet) {
      // Load existing names, filter out empty ones
      const existingNames = editingPet.names && Array.isArray(editingPet.names)
        ? editingPet.names.filter(n => n && n.trim() !== '')
        : [];
      
      setFormData({
        id: editingPet.id,
        names: existingNames.length > 0 ? existingNames : [],
        type: editingPet.type || 'dogs',
        breed: editingPet.breed || '',
        age: editingPet.age || 'adult',
        weight: editingPet.weight || '',
        healthConcerns: Array.isArray(editingPet.healthConcerns) ? editingPet.healthConcerns : [],
        image: editingPet.image || '',
      });
      setNewName('');
    } else {
      // Reset to defaults when adding new pet
      setFormData({
        id: uuidv4(),
        names: [],
        type: 'dogs',
        breed: '',
        age: 'adult',
        weight: '',
        healthConcerns: [],
        image: '',
      });
      setNewName('');
    }
  }, [isOpen, editingPet]);

  if (!isOpen) return null;

  const handleAddName = () => {
    if (newName.trim()) {
      setFormData({
        ...formData,
        names: [...formData.names, newName.trim()]
      });
      setNewName('');
    }
  };

  const handleRemoveName = (index: number) => {
    setFormData({
      ...formData,
      names: formData.names.filter((_, i) => i !== index)
    });
  };

  const handleHealthConcernToggle = (concern: string) => {
    setFormData(prev => ({
      ...prev,
      healthConcerns: prev.healthConcerns.includes(concern)
        ? prev.healthConcerns.filter(c => c !== concern)
        : [...prev.healthConcerns, concern]
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // IMPORTANT: If user typed a name but didn't click "Add", include it now
    let allNames = [...formData.names];
    if (newName.trim() && !allNames.includes(newName.trim())) {
      allNames.push(newName.trim());
    }
    
    // Filter out empty names before saving
    const cleanedNames = allNames.filter(name => name && name.trim() !== '');
    
    // Ensure at least one name exists
    if (cleanedNames.length === 0) {
      cleanedNames.push('Unnamed Pet');
    }
    
    const cleanedData = {
      ...formData,
      names: cleanedNames,
    };
    
    // Saving pet with names
    
    onSave(cleanedData);
    setNewName(''); // Clear the input
    onClose();
  };

  // Get the first name for display at top
  const firstName = formData.names.length > 0 ? formData.names[0] : null;
  const additionalNames = formData.names.slice(1);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-y-auto">
        <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-3 z-10">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-900">
              {editingPet ? 'Edit Pet' : 'Add New Pet'}
            </h2>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 text-2xl"
            >
              ‚úï
            </button>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="p-4">
          {/* Primary Pet Name - Top Row */}
          {firstName && (
            <div className="mb-3 pb-3 border-b border-gray-200">
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Primary Name
              </label>
              <div className="flex items-center gap-2">
                <div className="bg-green-900/20 text-green-800 px-3 py-1.5 rounded-lg text-base font-semibold shadow-sm flex-1">
                  {firstName}
                </div>
                <button
                  type="button"
                  onClick={() => handleRemoveName(0)}
                  className="text-gray-400 hover:text-red-600 text-lg px-2"
                  title="Remove primary name"
                >
                  ‚úï
                </button>
              </div>
            </div>
          )}

          {/* Main Form - Horizontal Layout */}
          <div className="space-y-3">
            {/* Row 1: Name Input */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                {firstName ? 'Add Another Name' : (
                  <>
                    Pet Name(s) <span className="text-gray-500 font-normal">(required)</span>
                  </>
                )}
              </label>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={newName}
                  onChange={(e) => setNewName(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      handleAddName();
                    }
                  }}
                  placeholder={firstName ? "Add another name..." : "Type a name and press Enter"}
                  className="flex-1 px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-1 focus:ring-green-800 focus:border-green-800"
                />
                <button
                  type="button"
                  onClick={handleAddName}
                  disabled={!newName.trim()}
                  className="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Add
                </button>
              </div>
              {firstName && additionalNames.length > 0 && (
                <div className="flex flex-wrap gap-1.5 mt-1.5">
                  {additionalNames.map((name, index) => (
                    name.trim() !== '' && (
                      <div key={index + 1} className="bg-primary-100 text-primary-800 px-2 py-1 rounded-full flex items-center gap-1 text-xs font-medium">
                        <span>{name}</span>
                        <button
                          type="button"
                          onClick={() => handleRemoveName(index + 1)}
                          className="text-green-800 hover:text-green-900"
                          title="Remove name"
                        >
                          ‚úï
                        </button>
                      </div>
                    )
                  ))}
                </div>
              )}
            </div>

            {/* Row 2: Pet Type, Breed, Age, Weight - Horizontal */}
            <div className="grid grid-cols-4 gap-3">
              {/* Pet Type */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  Pet Type
                </label>
                <div className="grid grid-cols-5 gap-1">
                  {Object.entries(PET_ICON_MAP).map(([type, emoji]) => (
                    <button
                      key={type}
                      type="button"
                      onClick={() => setFormData({...formData, type})}
                      className={`flex flex-col items-center p-1 rounded border transition-colors ${formData.type === type ? 'border-primary-500 bg-primary-50' : 'border-gray-200 hover:border-gray-300'}`}
                      title={type.replace('-', ' ')}
                    >
                      <EmojiIcon emoji={emoji} size={24} />
                    </button>
                  ))}
                </div>
              </div>

              {/* Breed */}
              <div className="col-span-2">
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  Breed
                </label>
                <select
                  value={formData.breed}
                  onChange={(e) => setFormData({...formData, breed: e.target.value})}
                  className="w-full min-w-[220px] px-2 py-1.5 text-sm border border-gray-300 rounded-lg"
                >
                  <option value="">Select breed</option>
                  {PET_BREEDS[formData.type as PetCategory]?.map(breed => (
                    <option key={breed} value={breed}>{breed}</option>
                  ))}
                </select>
              </div>

              {/* Age */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  Age
                </label>
                <div className="grid grid-cols-4 gap-1">
                  {['baby', 'young', 'adult', 'senior'].map(age => (
                    <button
                      key={age}
                      type="button"
                      onClick={() => setFormData({...formData, age})}
                      className={`px-2 py-1.5 text-xs rounded border capitalize ${formData.age === age ? 'border-green-800 bg-green-900/10' : 'border-gray-200 hover:border-gray-300'}`}
                    >
                      {age}
                    </button>
                  ))}
                </div>
              </div>

              {/* Weight */}
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  Weight
                </label>
                <input
                  type="text"
                  value={formData.weight}
                  onChange={(e) => setFormData({...formData, weight: e.target.value})}
                  placeholder="e.g., 10 lbs"
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg"
                />
              </div>
            </div>

            {/* Row 3: Health Concerns - Full Width */}
            <div>
              <HealthConcernsDropdown
                species={formData.type || ''}
                selectedConcerns={formData.healthConcerns || []}
                onConcernsChange={(concerns) => setFormData({...formData, healthConcerns: concerns})}
                className="mt-0"
              />
            </div>
          </div>

          <div className="flex justify-end gap-2 mt-4 pt-3 border-t border-gray-200">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="px-4 py-2 text-sm bg-primary-600 text-white hover:bg-primary-700 rounded-lg"
            >
              {editingPet ? 'Save Changes' : 'Add Pet'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// =================================================================
// 5. MAIN PAGE COMPONENT
// =================================================================

export default function MyPetsPage() {
  const userId = SIMULATED_USER_ID;
  const { setUserId } = useVillageStore();

  const [pets, setPets] = useState<ProfilePet[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingPet, setEditingPet] = useState<Pet | null>(null);
  const [customMeals, setCustomMeals] = useState<CustomMeal[]>([]);
  const [isClient, setIsClient] = useState(false);
  const [activePetId, setActivePetId] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'bio' | 'saved' | 'plan'>('bio');
  const [planOffset, setPlanOffset] = useState(0);
const [planWeekly, setPlanWeekly] = useState<{ day: string; meals: any[] }[]>([]);
const [swapTarget, setSwapTarget] = useState<{ dayIdx: number; mealIdx: number } | null>(null);
  const [badgeRefreshKey, setBadgeRefreshKey] = useState(0);
const activePet = useMemo(() => (activePetId ? pets.find((p) => p.id === activePetId) : null), [activePetId, pets]);
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({
    isOpen: false,
    title: '',
    message: '',
    onConfirm: () => {},
  });
  // Recipe name lookup - uses formatted name since recipes are now generated dynamically
  const getRecipeName = useCallback((id: string) => {
    if (!id) return 'Unnamed Meal';
    return formatRecipeName(id);
  }, []);
const buildWeeklyPlan = useCallback(
    (saved: string[], offset: number): WeeklyPlanEntry[] => {
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      if (!Array.isArray(saved) || saved.length < 2) {
        return days.map((day) => ({ day, meals: [null, null] }));
      }
      const unique = saved.filter(Boolean);
      const len = unique.length;
      return days.map((day, idx) => {
        const base = (idx + offset) % len;
        const first = unique[base] || null;
        let second = unique[(base + 1) % len] || null;
        if (second === first) {
          second = unique[(base + 2) % len] || null;
          if (second === first) second = null;
        }
        return { day, meals: [first, second] };
      });
    },
    []
  );

  const shuffleMealsNoRepeats = (meals: any[], totalSlots: number) => {
    if (meals.length === 0) return [];
    const base = [...meals];
    const rotation: any[] = [];
    const shuffle = (arr: any[]) => {
      for (let i = arr.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };
    let pool = shuffle([...base]);
    while (rotation.length < totalSlots) {
      if (pool.length === 0) {
        pool = shuffle([...base]);
      }
      const next = pool.pop();
      if (rotation.length % 2 === 1 && rotation[rotation.length - 1]?.id === next?.id) {
        pool.unshift(next);
        continue;
      }
      rotation.push(next);
    }
    return rotation;
  };

  useEffect(() => {
    setIsClient(true);
  }, []);

  // Load pets function - reusable
  const loadPets = useCallback(async () => {
    const loadedPets = await getPets(userId);
    // Normalize names: convert name field to names array if needed
    const normalizedPets = loadedPets.map((p: Pet) => ({
      ...p,
      names: p.names && Array.isArray(p.names) && p.names.length > 0
        ? p.names.filter((n: string) => n && n.trim() !== '')
        : (p.name && typeof p.name === 'string' && p.name.trim() !== ''
            ? [p.name.trim()]
            : ['Unnamed Pet']),
    }));
    setPets(normalizedPets);
  }, [userId]);

  // Load custom meals when active pet changes - deferred until pet is actually selected
  const loadCustomMeals = useCallback(async () => {
    if (activePetId && userId) {
      const meals = await getCustomMeals(userId, activePetId);
      // Use startTransition for non-critical state updates to avoid blocking UI
      startTransition(() => {
        setCustomMeals(meals);
      });
      // Note: loadPets() is called by the petsUpdated event handler, so we don't need to call it here
      // This avoids race conditions and redundant calls
    } else {
      startTransition(() => {
        setCustomMeals([]);
      });
    }
  }, [activePetId, userId]);

  // Load saved active pet ID from localStorage on mount (before pets load)
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('last_user_id', userId);
      
      // Load saved active pet ID - this will be validated once pets are loaded
      const savedActivePetId = localStorage.getItem(`active_pet_id_${userId}`);
      if (savedActivePetId) {
        setActivePetId(savedActivePetId);
      }
    }
  }, [userId]);

  // Load pets and expose user id for other pages (recipe detail, etc.)
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('last_user_id', userId);
    }
    
    // Initial load - only critical data (pets list)
    loadPets();

    // Initialize village store with userId
    setUserId(userId);
  }, [userId, setUserId, loadPets]);

  // Refresh pets when page becomes visible (user returns to tab)
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const handleVisibilityChange = () => {
      if (!document.hidden) {
        // Page became visible, refresh pets
        loadPets();
      }
    };

    const handleFocus = () => {
      // Window regained focus, refresh pets
      loadPets();
    };

    const handleStorageChange = (e: StorageEvent) => {
      // Refresh if pets storage was modified (cross-tab/window)
      if (e.key === `pets_${userId}`) {
        loadPets();
      }
    };

    const handlePetsUpdated = (e: CustomEvent) => {
      // Refresh if pets were updated (same-tab)
      if (e.detail?.userId === userId) {
        loadPets();
        // If the updated pet is the active pet, also refresh custom meals
        // Use the current activePetId from closure, don't include loadCustomMeals in deps
        if (e.detail?.petId === activePetId && activePetId) {
          // Call getCustomMeals directly - use startTransition for non-critical updates
          getCustomMeals(userId, activePetId).then(meals => {
            startTransition(() => {
              setCustomMeals(meals);
            });
          });
        }
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('focus', handleFocus);
    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('petsUpdated', handlePetsUpdated as EventListener);

    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('focus', handleFocus);
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('petsUpdated', handlePetsUpdated as EventListener);
    };
  }, [userId, loadPets, activePetId]);

  useEffect(() => {
    if (pets.length === 0) {
      setActivePetId(null);
      setActiveTab('bio');
      if (typeof window !== 'undefined') {
        localStorage.removeItem(`active_pet_id_${userId}`);
      }
      return;
    }
    
    // Check if current activePetId still exists in pets list
    const stillExists = pets.some((p) => p.id === activePetId);
    if (activePetId && !stillExists) {
      // Current selection no longer exists, clear it
      setActivePetId(null);
      setActiveTab('bio');
      if (typeof window !== 'undefined') {
        localStorage.removeItem(`active_pet_id_${userId}`);
      }
    }
    
    // If no pet is selected and we have pets, check localStorage first
    if (!activePetId && pets.length > 0) {
      if (typeof window !== 'undefined') {
        const savedActivePetId = localStorage.getItem(`active_pet_id_${userId}`);
        const savedPetExists = savedActivePetId && pets.some((p) => p.id === savedActivePetId);
        if (savedPetExists) {
          // Restore saved selection
          setActivePetId(savedActivePetId);
        } else {
          // Only auto-select first pet if no valid saved selection exists
          // Don't save this auto-selection to localStorage (only user selections are saved)
          setActivePetId(pets[0].id);
        }
      } else {
        setActivePetId(pets[0].id);
      }
    }
  }, [pets, activePetId, userId]);

  // Defer custom meals loading - only load when a pet is actually selected and viewed
  // Don't load on initial mount if no pet is active (saves initial load time)
  useEffect(() => {
    // Only load if we have an active pet ID (pet is selected)
    if (activePetId) {
      loadCustomMeals();
    } else {
      // Clear custom meals if no pet is selected
      setCustomMeals([]);
    }
  }, [activePetId, loadCustomMeals]);

  // Listen for custom meal updates
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const handleCustomMealsUpdated = (e: CustomEvent) => {
      // Refresh if custom meals were updated for the active pet
      if (e.detail?.userId === userId && e.detail?.petId === activePetId && activePetId) {
        // Call getCustomMeals directly to avoid dependency on loadCustomMeals callback
        // Use startTransition for non-critical updates
        getCustomMeals(userId, activePetId).then(meals => {
          startTransition(() => {
            setCustomMeals(meals);
          });
        });
      }
    };

    const handleStorageChange = (e: StorageEvent) => {
      // Refresh if custom meals storage was modified (cross-tab/window)
      if (activePetId && e.key === `custom_meals_${userId}_${activePetId}`) {
        // Call getCustomMeals directly to avoid dependency on loadCustomMeals callback
        // Use startTransition for non-critical updates
        getCustomMeals(userId, activePetId).then(meals => {
          startTransition(() => {
            setCustomMeals(meals);
          });
        });
      }
    };

    window.addEventListener('customMealsUpdated', handleCustomMealsUpdated as EventListener);
    window.addEventListener('storage', handleStorageChange);

    return () => {
      window.removeEventListener('customMealsUpdated', handleCustomMealsUpdated as EventListener);
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [userId, activePetId]);

  // Build weekly plan for Plan tab (merge saved recipes + custom meals)
  const allMealsForPlan = useMemo(() => {
    if (!activePet) return [];
    const saved = Array.isArray(activePet.savedRecipes)
      ? activePet.savedRecipes.filter(Boolean) as any[]
      : [];
    const customs = customMeals.map(convertCustomMealToRecipe);
    return [...saved, ...customs];
  }, [activePet, customMeals]);

  useEffect(() => {
    if (allMealsForPlan.length === 0) {
      setPlanWeekly([]);
      return;
    }
    const rotation = buildEvenPlan(allMealsForPlan);
    const nextPlan: { day: string; meals: any[] }[] = [];
    for (let i = 0; i < DAYS.length; i += 1) {
      const breakfastIndex = i * 2;
      const dinnerIndex = breakfastIndex + 1;
      const breakfast = rotation[breakfastIndex];
      let dinner = rotation[dinnerIndex];
      if (dinner.id === breakfast.id) {
        const swapIndex = rotation.findIndex(
          (entry, idx) => idx > dinnerIndex && entry.id !== breakfast.id
        );
        if (swapIndex !== -1) {
          [rotation[dinnerIndex], rotation[swapIndex]] = [
            rotation[swapIndex],
            rotation[dinnerIndex],
          ];
          dinner = rotation[dinnerIndex];
        } else {
          dinner = allMealsForPlan.find((meal) => meal.id !== breakfast.id) || dinner;
        }
      }
      nextPlan.push({ day: DAYS[i], meals: [breakfast, dinner] });
    }
    setPlanWeekly(nextPlan);
  }, [allMealsForPlan]);

  const handleRandomizePlan = () => {
    if (allMealsForPlan.length === 0) return;
    const totalSlots = DAYS.length * 2;
    const rotation = shuffleMealsNoRepeats(allMealsForPlan, totalSlots);
    const nextPlan: { day: string; meals: any[] }[] = [];
    for (let i = 0; i < DAYS.length; i += 1) {
      const breakfastIndex = i * 2;
      const dinnerIndex = breakfastIndex + 1;
      nextPlan.push({ day: DAYS[i], meals: [rotation[breakfastIndex], rotation[dinnerIndex]] });
    }
    setPlanWeekly(nextPlan);
  };

  const handleAddPet = useCallback(
    (newPet: any) => {
      // Ensure names array is properly formatted and has at least one name
      // First, try to get names from names array
      let cleanedNames = Array.isArray(newPet.names)
        ? newPet.names.filter((n: string) => n && n.trim() !== '')
        : [];
      
      // If no names array, check for singular name field (from CreatePetModal)
      if (cleanedNames.length === 0 && newPet.name && typeof newPet.name === 'string' && newPet.name.trim() !== '') {
        cleanedNames = [newPet.name.trim()];
      }
      
      // If still no names after cleaning, set a default
      if (cleanedNames.length === 0) {
        cleanedNames.push('Unnamed Pet');
      }
      
      const petWithSavedRecipes = { 
        ...newPet,
        names: cleanedNames, // Use cleaned names
        // Remove singular name field if it exists (we're using names array now)
        name: undefined,
        savedRecipes: newPet.savedRecipes || [] 
      };
      
      // Saving pet with saved recipes
      
      setPets((prevPets) => {
        const isEditing = prevPets.some((p) => p.id === petWithSavedRecipes.id);
        let updatedPets: Pet[];

        if (isEditing) {
          updatedPets = prevPets.map((p) =>
            p.id === petWithSavedRecipes.id ? petWithSavedRecipes : p
          );
        } else {
          updatedPets = [...prevPets, petWithSavedRecipes];
        }

        // Save each pet async
        updatedPets.forEach(pet => {
          savePet(userId, pet).catch(err => console.error('Failed to save pet:', err));
        });
        
        return updatedPets;
      });
    },
    [userId]
  );

  const handleEditPet = useCallback((pet: Pet) => {
    setEditingPet(pet);
    setIsModalOpen(true);
  }, []);

  // Memoize modal handlers to prevent re-renders
  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
  }, []);

  const handleSubmitPet = useCallback((pet: Pet) => {
    handleAddPet(pet);
    setEditingPet(null);
  }, [handleAddPet]);

  const handleDeletePet = useCallback((petId: string) => {
    const pet = pets.find(p => p.id === petId);
    const petName = pet ? getPrimaryName(pet.names || []) : 'this pet';
    
    setConfirmModal({
      isOpen: true,
      title: 'Delete Pet',
      message: `Are you sure you want to delete ${petName}? This action cannot be undone.`,
      onConfirm: async () => {
        await deletePet(userId, petId);
        
        setPets(prevPets => {
          const updatedPets = prevPets.filter(p => p.id !== petId);
          if (activePetId === petId) {
            setActivePetId(null);
            setActiveTab('bio');
          }
          return updatedPets;
        });
      },
    });
  }, [userId, activePetId, pets]);

  const handleRemoveSavedMeal = useCallback(async (recipeId: string) => {
    if (!activePetId) return;
    
    // If it's a custom meal, also delete it from custom meals storage
    if (recipeId.startsWith('custom_')) {
      const { deleteCustomMeal } = await import('@/lib/utils/customMealStorage');
      await deleteCustomMeal(userId, activePetId, recipeId);
      // Update local custom meals state
      setCustomMeals(prev => prev.filter(m => m.id !== recipeId));
    }
    
    const petToUpdate = pets.find(p => p.id === activePetId);
    if (petToUpdate) {
      const updatedPet = {
        ...petToUpdate,
        savedRecipes: (petToUpdate.savedRecipes || []).filter(id => id !== recipeId)
      };
      
      await savePet(userId, updatedPet);
      
      setPets(prevPets => prevPets.map(p => 
        p.id === activePetId ? updatedPet : p
      ));
      
      // Check badges after recipe is removed
      if (activePet) {
        const uniqueMealIds = new Set<string>();
        planWeekly.forEach(day => {
          day.meals.forEach(meal => {
            if (meal && meal.id) uniqueMealIds.add(meal.id);
          });
        });
        const mealPlanCount = uniqueMealIds.size;
        const savedRecipesCount = updatedPet.savedRecipes?.length || 0;
        const weeklyPlanCompleted = false;
        
        checkAllBadges(userId, activePet.id, {
          action: 'recipe_removed',
          mealPlanCount,
          savedRecipesCount,
          weeklyPlanCompleted,
        }).catch(err => {
          console.error('Failed to check badges:', err);
        });
      }
    }
  }, [userId, activePetId, pets, planWeekly, activePet]);

  // Component to buy all ingredients from meal plan
  const BuyAllMealPlanIngredientsButton = ({ weeklyPlan, petId }: { weeklyPlan: { day: string; meals: (string | null)[] }[]; petId: string }) => {
    const [isOpening, setIsOpening] = useState(false);
    const [openedCount, setOpenedCount] = useState(0);

    const handleBuyAll = async () => {
      alert('Meal plans are now generated dynamically. Please navigate to individual meals to purchase ingredients.');
    };

    const totalIngredients = 0;

    if (totalIngredients === 0) {
      return null;
    }

    return (
      <button
        onClick={handleBuyAll}
        disabled={isOpening}
        className={`w-full py-3 px-6 rounded-lg font-bold text-base transition-all ${
          isOpening
            ? 'bg-gray-600 cursor-wait text-gray-300'
            : 'bg-gradient-to-r from-[#FF9900] to-[#F08804] hover:from-[#F08804] hover:to-[#E07704] text-black shadow-lg hover:shadow-xl'
        } flex items-center justify-center gap-2`}
      >
        {isOpening ? (
          <>
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            Opening...
          </>
        ) : (
          <>
            <ShoppingCart size={20} />
            Buy All
          </>
        )}
      </button>
    );
  };

  if (!isClient) {
    return (
      <div className="min-h-screen bg-background text-foreground flex items-center justify-center">
        <div className="text-center py-12">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-800 mx-auto"></div>
          <p className="text-gray-400 mt-4">Loading your pets...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background text-foreground py-6">
      <div className="max-w-6xl mx-auto px-4 space-y-6">
        <header className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 className="text-3xl font-extrabold">My Pets</h1>
            {pets.length > 0 && (
              <p className="text-sm text-gray-400 mt-1">
                Choose a pet to view details, saved meals, and meal plans.
              </p>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => {
                setEditingPet(null);
                setIsModalOpen(true);
              }}
              className="btn btn-success btn-sm btn-ripple"
            >
              <Plus size={16} className="mr-1" />
              Add Pet
            </button>
          </div>
        </header>

        {pets.length === 0 ? (
          <div className="text-center py-14 px-6 bg-surface rounded-2xl border border-surface-highlight shadow-lg">
            <div className="text-4xl mb-3">üêæ</div>
            <h2 className="text-2xl font-bold mb-2">No Pets Yet</h2>
            <p className="text-gray-400 mb-6">
              Add your first pet to start building personalized meals and plans.
            </p>
            <button
              onClick={() => {
                setEditingPet(null);
                setIsModalOpen(true);
              }}
              className="btn btn-success btn-md btn-ripple"
            >
              <Plus size={18} className="mr-2" />
              Add Your First Pet
            </button>
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-4 lg:gap-6 items-start">
            <div className="bg-surface border border-surface-highlight rounded-2xl shadow-lg p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-semibold">Pets</h3>
                  <span className="text-xs text-gray-400">{pets.length} total</span>
                </div>
                <div className="space-y-2">
                  {pets.map((pet) => {
                    if (!pet?.id) return null;
                    const name = getPrimaryName(pet.names || []) || 'Unnamed Pet';
                  return (
                    <button
                      key={pet.id}
                      onClick={() => {
                        setActivePetId(pet.id);
                        setActiveTab('bio');
                        // Persist selection to localStorage
                        if (typeof window !== 'undefined') {
                          localStorage.setItem(`active_pet_id_${userId}`, pet.id);
                        }
                      }}
                      className={`w-full flex items-center gap-3 rounded-xl px-3 py-2 text-left transition-all duration-200 ease-out ${
                        activePetId === pet.id
                          ? 'bg-green-900/20 text-white'
                          : 'bg-surface-highlight/60 text-foreground hover:bg-surface-highlight hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg'
                      }`}
                      style={{
                        border: activePetId === pet.id ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)'
                      }}
                    >
                      <div className="w-10 h-10 rounded-full overflow-hidden border border-white/10 bg-surface flex items-center justify-center flex-shrink-0">
                        <Image
                          src={getMascotFaceForPetType(pet.type as PetCategory)}
                          alt={`${name} mascot`}
                          width={40}
                          height={40}
                          className="object-cover"
                          unoptimized
                        />
                      </div>
                      <div className="min-w-0 flex-1">
                        <div className="text-sm font-semibold truncate">{name}</div>
                        <div className="text-xs text-gray-400 capitalize truncate">
                          {pet.type}
                          {pet.age ? ` ‚Ä¢ ${pet.age}` : ''}
                        </div>
                      </div>
                    </button>
                  );
                  })}
                </div>
            </div>

            {activePet ? (
              <div className="bg-surface border border-surface-highlight rounded-2xl shadow-xl p-5">
                      <div className="flex items-start justify-between gap-3 flex-wrap">
                        <div className="flex-1 min-w-0">
                          <div className="relative float-left mr-4 mb-2" style={{ shapeOutside: 'circle(50%)', width: '168px', height: '168px' }}>
                            <svg className="absolute -top-8 left-0 pointer-events-none" width="168" height="40" style={{ overflow: 'visible' }}>
                              <defs>
                                <path id={`textPath-${activePet.id}`} d="M 10,35 Q 84,15 158,35" fill="none" />
                              </defs>
                              <text className="text-xs" fill="#9ca3af" fontSize="12">
                                <textPath href={`#textPath-${activePet.id}`} startOffset="50%">
                                  <tspan textAnchor="middle">Click to upload photo</tspan>
                                </textPath>
                              </text>
                            </svg>
                            <label className="w-42 h-42 rounded-full overflow-hidden border border-white/10 bg-surface-highlight flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity group" style={{ width: '168px', height: '168px' }}>
                              <input
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={(e) => {
                                  const file = e.target.files?.[0];
                                  if (file) {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                      const imageDataUrl = reader.result as string;
                                      const updatedPet = { ...activePet, image: imageDataUrl };
                                      savePet(userId, updatedPet);
                                      setPets(prevPets => prevPets.map(p => p.id === activePet.id ? updatedPet : p));
                                    };
                                    reader.readAsDataURL(file);
                                  }
                                }}
                              />
                              {activePet.image ? (
                                <img
                                  src={activePet.image}
                                  alt={getPrimaryName(activePet.names || []) || 'Pet'}
                                  className="w-full h-full object-cover"
                                />
                              ) : (
                                <Image
                                  src={getProfilePictureForPetType(activePet.type as PetCategory)}
                                  alt={`${getPrimaryName(activePet.names || []) || 'Pet'} mascot`}
                                  width={168}
                                  height={168}
                                  className="object-cover"
                                  unoptimized
                                  style={activePet.type === 'cats' || activePet.type === 'cat' ? { transform: 'scale(1.5)', transformOrigin: 'center', objectPosition: 'center' } : undefined}
                                />
                              )}
                            </label>
                          </div>
                        </div>
                        <div className="flex flex-col gap-3">
                          {/* Pet name and Edit/Delete buttons row */}
                          <div className="flex items-center justify-between gap-3 w-[600px]">
                            <h2 className="text-3xl font-bold">
                              {getPrimaryName(activePet.names || []) || 'Unnamed Pet'}
                            </h2>
                            {activeTab === 'bio' && (
                              <div className="flex flex-wrap gap-2">
                                <button
                                  onClick={() => handleEditPet(activePet)}
                                  className="btn btn-success btn-sm"
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => handleDeletePet(activePet.id)}
                                  className="btn btn-darkgreen btn-sm"
                                >
                                  Delete
                                </button>
                              </div>
                            )}
                          </div>
                          {/* Badges Section - moved to far right, maintaining current height */}
                          <div className="p-4 border border-surface-highlight rounded-lg bg-surface-highlight/30 min-h-[140px] w-[600px]">
                            <div className="flex items-center justify-between mb-3">
                              <Tooltip 
                                content={`Available Badges:\n\n1. Perfect Match\n   Awarded when you hit a 100% compatibility score.\n\n2. Feast Architect\n   Unlocked by building a layered or multi‚Äëstep meal plan.\n\n3. Week Whisker (Progressive)\n   Bronze: Complete 1 weekly plan\n   Silver: Complete 10 weekly plans\n   Gold: Complete 50 weekly plans\n\n4. Purchase Champion (Progressive)\n   Bronze: 1 purchase\n   Silver: 10 purchases\n   Gold: 20 purchases\n   Platinum: 30 purchases\n   Diamond: 40 purchases\n   Sultan: 50+ purchases`}
                                wide={true}
                              >
                                <div className="text-sm font-semibold text-gray-400 cursor-help hover:text-gray-300 transition-colors">Badges</div>
                              </Tooltip>
                            </div>
                            <PetBadges key={badgeRefreshKey} petId={activePet.id} userId={userId} />
                            <BadgeToggle 
                              petId={activePet.id} 
                              userId={userId} 
                              onBadgeChange={() => setBadgeRefreshKey((prev: number) => prev + 1)}
                            />
                          </div>
                        </div>
                      </div>

                    <div className="mt-4">
                      <div className="flex gap-0 border-b-2 border-surface-highlight">
                        {['bio', 'saved', 'plan'].map((tab) => {
                          const label = tab === 'bio' ? 'Bio' : tab === 'saved' ? 'Saved Meals' : 'Meal Plan';
                          const isActive = activeTab === tab;
                          return (
                            <button
                              key={tab}
                              onClick={() => {
                                setActiveTab(tab as any);
                                // Refresh pets when switching to saved tab to ensure latest data
                                if (tab === 'saved') {
                                  loadPets();
                                }
                              }}
                              className={`relative px-6 py-3 text-sm font-semibold transition-all duration-200 ${
                                isActive
                                  ? 'text-orange-400 border-b-3 border-orange-400 bg-transparent'
                                  : 'text-gray-400 hover:text-gray-300 bg-transparent border-b-3 border-transparent'
                              }`}
                              style={isActive ? { borderBottomWidth: '3px' } : { borderBottomWidth: '3px' }}
                              aria-selected={isActive}
                              role="tab"
                            >
                              {label}
                            </button>
                          );
                        })}
                      </div>

                      <div className="mt-3">
                        {activeTab === 'bio' && (
                          <div className="flex gap-6">
                            {/* Bio Column */}
                            <div className="flex-1 min-w-0">
                              <div className="grid grid-cols-1 gap-y-1 text-sm text-gray-300">
                                {activePet.breed && (
                                  <div className="flex items-start gap-1.5">
                                    <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                                    <span><strong className="text-gray-200">Breed:</strong> {activePet.breed}</span>
                                  </div>
                                )}
                                {activePet.age && (
                                  <div className="flex items-start gap-1.5">
                                    <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                                    <span><strong className="text-gray-200">Age:</strong> {activePet.age}</span>
                                  </div>
                                )}
                                {(activePet.weight || activePet.weightKg) && (
                                  <div className="flex items-start gap-1.5">
                                    <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                                    <span><strong className="text-gray-200">Weight:</strong> {activePet.weightKg ? `${activePet.weightKg}kg` : activePet.weight}</span>
                                  </div>
                                )}
                                {(activePet.dietaryRestrictions || []).length > 0 && (
                                  <div className="flex items-start gap-1.5">
                                    <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                                    <span><strong className="text-gray-200">Dietary Restrictions:</strong> {(activePet.dietaryRestrictions || []).join(', ')}</span>
                                  </div>
                                )}
                                {(activePet.dislikes || []).length > 0 && (
                                  <div className="flex items-start gap-1.5">
                                    <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                                    <span><strong className="text-gray-200">Dislikes:</strong> {(activePet.dislikes || []).join(', ')}</span>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Health Concerns Column - Always rendered for consistent layout */}
                            <div className="flex-shrink-0 min-w-[180px]">
                              <h3 className="text-sm font-semibold text-gray-300 mb-2">Health Concerns</h3>
                              <div className="flex flex-col gap-1.5">
                                {(activePet.healthConcerns || []).length > 0 ? (
                                  (activePet.healthConcerns || []).map((concern) => (
                                    <div
                                      key={concern}
                                      className="px-2 py-1 bg-orange-900/40 text-orange-200 border border-orange-700/50 text-xs rounded"
                                    >
                                      {concern.replace(/-/g, ' ')}
                                    </div>
                                  ))
                                ) : (
                                  <div className="px-2 py-1 text-gray-500 text-xs italic">
                                    None
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Allergies Column - Always rendered for consistent layout */}
                            <div className="flex-shrink-0 min-w-[180px]">
                              <h3 className="text-sm font-semibold text-gray-300 mb-2">Allergies</h3>
                              <div className="flex flex-col gap-1.5">
                                {(activePet.allergies || []).length > 0 ? (
                                  (activePet.allergies || []).map((allergy) => (
                                    <div
                                      key={allergy}
                                      className="px-2 py-1 bg-orange-900/40 text-orange-200 border border-orange-700/50 text-xs rounded"
                                    >
                                      {allergy.replace(/-/g, ' ')}
                                    </div>
                                  ))
                                ) : (
                                  <div className="px-2 py-1 text-gray-500 text-xs italic">
                                    None
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        )}

                        {activeTab === 'bio' && (
                          <div className="mt-3 flex flex-wrap gap-2">
                            <a href={`/profile/pet/${activePet.id}`} className="btn btn-success btn-sm">Find Meals</a>
                            <a href={`/profile/pet/${activePet.id}/recipe-builder`} className="btn btn-success btn-sm">Create Meal</a>
                          </div>
                        )}

                        {activeTab === 'saved' && (
                          <div className="space-y-2">
                            {(() => {
                              const savedIds = Array.isArray(activePet.savedRecipes) ? activePet.savedRecipes : [];
                              const customIds = customMeals.map((m) => m.id);
                              const combinedIds = Array.from(new Set([...savedIds, ...customIds]));

                              if (combinedIds.length === 0) {
                                return (
                                  <div className="text-gray-400 text-sm">
                                    No saved meals yet. Use "Find Meals" to add some.
                                  </div>
                                );
                              }

                              return (
                                <div className="max-h-[480px] overflow-y-auto pr-2 space-y-2">
                                  {combinedIds.map((rid) => {
                                    const isCustomMeal = rid.startsWith('custom_');
                                    const customMeal = isCustomMeal ? customMeals.find((m) => m.id === rid) : null;
                                    const mealName = isCustomMeal ? customMeal?.name || 'Custom Meal' : getRecipeName(rid);
                                    const mealData = isCustomMeal ? customMeal : null;

                                    // Calculate compatibility score
                                    let compatibilityScore: number | null = null;
                                    if (activePet && mealData) {
                                      try {
                                        const enhancedPet: EnhancedPet = {
                                          id: activePet.id,
                                          name: getPrimaryName(activePet.names || []) || 'Pet',
                                          type: activePet.type === 'dogs' ? 'dog' : activePet.type === 'cats' ? 'cat' : activePet.type === 'birds' ? 'bird' : activePet.type === 'reptiles' ? 'reptile' : 'pocket-pet',
                                          breed: activePet.breed || '',
                                          age: activePet.age === 'baby' ? 0.5 : activePet.age === 'young' ? 2 : activePet.age === 'adult' ? 5 : 10,
                                          weight: activePet.weightKg || 10,
                                          activityLevel: 'moderate',
                                          healthConcerns: activePet.healthConcerns || [],
                                          dietaryRestrictions: activePet.allergies || [],
                                          allergies: activePet.allergies || [],
                                        };
                                        const result = calculateEnhancedCompatibility(mealData as Recipe, enhancedPet);
                                        compatibilityScore = result.overallScore;
                                      } catch (error) {
                                        console.error('Error calculating compatibility:', error);
                                        compatibilityScore = null;
                                      }
                                    }

                                    return (
                                      <div key={rid} className="p-2 rounded border border-white/5 grid grid-cols-[1fr_auto_auto] items-center gap-4">
                                        <div className="min-w-0">
                                          <button
                                            onClick={() => {
                                              window.location.href = `/recipe/${rid}?petId=${activePet.id}`;
                                            }}
                                            className="text-primary-300 hover:text-primary-100 text-sm font-semibold break-words text-left px-3 py-2 rounded transition-colors bg-surface border border-orange-500/50 hover:border-orange-500 hover:bg-surface-highlight/50"
                                          >
                                            {mealName}
                                          </button>
                                        </div>
                                        <div className="flex items-center justify-center min-w-[60px]">
                                          {compatibilityScore !== null && (
                                            <div className={`text-sm font-bold rounded-full w-10 h-10 flex items-center justify-center border-2 ${
                                              compatibilityScore >= 80 
                                                ? 'text-green-400 border-green-400' 
                                                : compatibilityScore >= 60 
                                                ? 'text-yellow-400 border-yellow-400' 
                                                : 'text-red-400 border-red-400'
                                            }`}>
                                              {compatibilityScore}%
                                            </div>
                                          )}
                                        </div>
                                        <div className="flex items-center gap-2 flex-shrink-0">
                                          {mealData && (mealData as any).ingredients && (
                                            <button
                                              onClick={(e) => {
                                                e.preventDefault();
                                                const cartItems = ((mealData as any).ingredients || [])
                                                  .map((ing: any, idx: number) => {
                                                    const genericName = (ing.name || '').toLowerCase().trim();
                                                    const vettedProduct = VETTED_PRODUCTS[genericName];
                                                    const link = vettedProduct ? vettedProduct.purchaseLink : ing.asinLink;
                                                    if (link) {
                                                      const asinMatch = link.match(/\/dp\/([A-Z0-9]{10})/);
                                                      if (asinMatch) {
                                                        return `ASIN.${idx + 1}=${asinMatch[1]}&Quantity.${idx + 1}=1`;
                                                      }
                                                    }
                                                    return null;
                                                  })
                                                  .filter(Boolean);
                                                if (cartItems.length > 0) {
                                                  const cartUrl = ensureCartUrlSellerId(`https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`);
                                                  window.open(cartUrl, '_blank');
                                                } else {
                                                  alert('No ingredient links available for this recipe.');
                                                }
                                              }}
                                              className="inline-flex items-center gap-1 text-sm px-4 py-2 rounded font-semibold transition-all shadow-md hover:shadow-lg bg-gradient-to-r from-[#FF9900] to-[#F08804] hover:from-[#F08804] hover:to-[#E07704] text-black flex-shrink-0"
                                              title="Buy ingredients"
                                            >
                                              <ShoppingCart size={14} />
                                              Buy
                                            </button>
                                          )}
                                          <button
                                            onClick={(e) => {
                                              e.preventDefault();
                                              setConfirmModal({
                                                isOpen: true,
                                                title: 'Remove Meal',
                                                message: `Remove "${mealName}" from saved meals?`,
                                                onConfirm: () => {
                                                  handleRemoveSavedMeal(rid);
                                                },
                                              });
                                            }}
                                            className="btn btn-success btn-sm"
                                            title="Remove meal"
                                          >
                                            Remove
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              );
                            })()}
                            <div className="flex flex-wrap gap-2">
                              <a
                                href={`/profile/pet/${activePet.id}`}
                                className="btn btn-success btn-sm"
                              >
                                Find Meals
                              </a>
                              <a
                                href={`/profile/pet/${activePet.id}/recipe-builder`}
                                className="btn btn-success btn-sm"
                              >
                                Create Meal
                              </a>
                            </div>
                          </div>
                        )}

                        {activeTab === 'plan' && (
                          <div className="space-y-4 text-sm">
                            {planWeekly.length > 0 ? (
                              <>
                                {/* Weekly Nutritional Coverage Summary */}
                                {(() => {
                                  if (!activePet) return null;
                                  
                                  // Calculate weekly nutrition totals
                                  const calculateMealNutrition = (meal: any): { protein: number; fat: number; fiber: number; calcium: number; phosphorus: number; calories: number } => {
                                    // Use calculateRecipeNutrition directly to get actual nutrition values
                                    try {
                                      const nutrition = calculateRecipeNutrition(meal as Recipe);
                                      return {
                                        protein: nutrition.protein || 0,
                                        fat: nutrition.fat || 0,
                                        fiber: nutrition.fiber || 0,
                                        calcium: nutrition.calcium || 0,
                                        phosphorus: nutrition.phosphorus || 0,
                                        calories: nutrition.calories || 0,
                                      };
                                    } catch {
                                      return { protein: 0, fat: 0, fiber: 0, calcium: 0, phosphorus: 0, calories: 0 };
                                    }
                                  };
                                  
                                  const weeklyTotals = planWeekly.reduce((acc, day) => {
                                    day.meals.forEach(meal => {
                                      const nutrition = calculateMealNutrition(meal);
                                      acc.protein += nutrition.protein;
                                      acc.fat += nutrition.fat;
                                      acc.fiber += nutrition.fiber;
                                      acc.calcium += nutrition.calcium;
                                      acc.phosphorus += nutrition.phosphorus;
                                      acc.calories += nutrition.calories;
                                    });
                                    return acc;
                                  }, { protein: 0, fat: 0, fiber: 0, calcium: 0, phosphorus: 0, calories: 0 });
                                  
                                  // Average per day (divide by 7)
                                  const dailyAvg = {
                                    protein: weeklyTotals.protein / 7,
                                    fat: weeklyTotals.fat / 7,
                                    fiber: weeklyTotals.fiber / 7,
                                    calcium: weeklyTotals.calcium / 7,
                                    phosphorus: weeklyTotals.phosphorus / 7,
                                    calories: weeklyTotals.calories / 7,
                                  };
                                  
                                  // Get pet requirements
                                  const petType = activePet.type as keyof typeof nutritionalGuidelines;
                                  const ageGroup = activePet.age === 'baby' ? 'puppy' : activePet.age === 'senior' ? 'senior' : 'adult';
                                  const requirements = nutritionalGuidelines[petType]?.[ageGroup] || nutritionalGuidelines[petType]?.adult;
                                  
                                  if (!requirements) return null;
                                  
                                  // Calculate coverage scores (0-100)
                                  const calculateCoverage = (value: number, min: number, max: number): number => {
                                    if (value < min) return (value / min) * 50; // Below min: 0-50
                                    if (value > max) return 100 - Math.min((value - max) / max * 50, 50); // Above max: 50-100
                                    return 50 + ((value - min) / (max - min)) * 50; // In range: 50-100
                                  };
                                  
                                  const proteinScore = calculateCoverage(dailyAvg.protein, requirements.protein.min, requirements.protein.max);
                                  const fatScore = calculateCoverage(dailyAvg.fat, requirements.fat.min, requirements.fat.max);
                                  const fiberScore = requirements.fiber ? calculateCoverage(dailyAvg.fiber, requirements.fiber.min, requirements.fiber.max) : 100;
                                  const calciumScore = requirements.calcium ? calculateCoverage(dailyAvg.calcium, requirements.calcium.min, requirements.calcium.max) : 100;
                                  const phosphorusScore = requirements.phosphorus ? calculateCoverage(dailyAvg.phosphorus, requirements.phosphorus.min, requirements.phosphorus.max) : 100;
                                  
                                  const overallScore = Math.round((proteinScore + fatScore + fiberScore + calciumScore + phosphorusScore) / 5);
                                  
                                  return (
                                    <div className="mb-4 p-3 bg-surface-highlight rounded-lg border border-surface-highlight flex items-center gap-3">
                                      <h3 className="text-base font-semibold text-foreground">Compatibility score for the week:</h3>
                                      <div className={`text-xl font-bold ${overallScore >= 80 ? 'text-green-400' : overallScore >= 60 ? 'text-yellow-400' : 'text-red-400'}`}>
                                        {overallScore}%
                                      </div>
                                    </div>
                                  );
                                })()}
                                <div className="max-h-[480px] overflow-y-auto pr-2 space-y-3">
                                  {planWeekly.map((dayPlan, index) => {
                                    // Calculate day score for this day's meals
                                    const calculateDayScore = (meals: any[]): number => {
                                      if (!activePet || meals.length === 0) return 0;
                                      
                                      const calculateMealNutrition = (meal: any): { protein: number; fat: number; fiber: number; calcium: number; phosphorus: number } => {
                                        // Use calculateRecipeNutrition directly to get actual nutrition values
                                        try {
                                          const nutrition = calculateRecipeNutrition(meal as Recipe);
                                          return {
                                            protein: nutrition.protein || 0,
                                            fat: nutrition.fat || 0,
                                            fiber: nutrition.fiber || 0,
                                            calcium: nutrition.calcium || 0,
                                            phosphorus: nutrition.phosphorus || 0,
                                          };
                                        } catch {
                                          return { protein: 0, fat: 0, fiber: 0, calcium: 0, phosphorus: 0 };
                                        }
                                      };
                                      
                                      const dayTotals = meals.reduce((acc, meal) => {
                                        const nutrition = calculateMealNutrition(meal);
                                        acc.protein += nutrition.protein;
                                        acc.fat += nutrition.fat;
                                        acc.fiber += nutrition.fiber;
                                        acc.calcium += nutrition.calcium;
                                        acc.phosphorus += nutrition.phosphorus;
                                        return acc;
                                      }, { protein: 0, fat: 0, fiber: 0, calcium: 0, phosphorus: 0 });
                                      
                                      // Average per meal (divide by number of meals)
                                      const mealAvg = {
                                        protein: dayTotals.protein / meals.length,
                                        fat: dayTotals.fat / meals.length,
                                        fiber: dayTotals.fiber / meals.length,
                                        calcium: dayTotals.calcium / meals.length,
                                        phosphorus: dayTotals.phosphorus / meals.length,
                                      };
                                      
                                      const petType = activePet.type as keyof typeof nutritionalGuidelines;
                                      const ageGroup = activePet.age === 'baby' ? 'puppy' : activePet.age === 'senior' ? 'senior' : 'adult';
                                      const requirements = nutritionalGuidelines[petType]?.[ageGroup] || nutritionalGuidelines[petType]?.adult;
                                      
                                      if (!requirements) return 0;
                                      
                                      const calculateCoverage = (value: number, min: number, max: number): number => {
                                        if (value < min) return (value / min) * 50;
                                        if (value > max) return 100 - Math.min((value - max) / max * 50, 50);
                                        return 50 + ((value - min) / (max - min)) * 50;
                                      };
                                      
                                      const proteinScore = calculateCoverage(mealAvg.protein, requirements.protein.min, requirements.protein.max);
                                      const fatScore = calculateCoverage(mealAvg.fat, requirements.fat.min, requirements.fat.max);
                                      const fiberScore = requirements.fiber ? calculateCoverage(mealAvg.fiber, requirements.fiber.min, requirements.fiber.max) : 100;
                                      const calciumScore = requirements.calcium ? calculateCoverage(mealAvg.calcium, requirements.calcium.min, requirements.calcium.max) : 100;
                                      const phosphorusScore = requirements.phosphorus ? calculateCoverage(mealAvg.phosphorus, requirements.phosphorus.min, requirements.phosphorus.max) : 100;
                                      
                                      return Math.round((proteinScore + fatScore + fiberScore + calciumScore + phosphorusScore) / 5);
                                    };
                                    
                                    const dayScore = calculateDayScore(dayPlan.meals);
                                    
                                    return (
                                      <div key={dayPlan.day} className="rounded-lg border border-surface-highlight px-3 py-2">
                                        <div className="text-white font-semibold mb-2 flex items-center gap-2">
                                          {dayPlan.day}
                                          <div className={`text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center border ${
                                            dayScore >= 80 
                                              ? 'text-green-400 border-green-400' 
                                              : dayScore >= 60 
                                              ? 'text-yellow-400 border-yellow-400' 
                                              : 'text-red-400 border-red-400'
                                          }`}>
                                            {dayScore}%
                                          </div>
                                        </div>
                                        <div className="space-y-2">
                                          {dayPlan.meals.map((meal, mealIndex) => (
                                            <div key={meal.id + mealIndex} className="p-2 rounded border border-white/5 grid grid-cols-[1fr_auto] items-center gap-4">
                                              <button
                                                onClick={() => {
                                                  window.location.href = `/recipe/${meal.id}?petId=${activePet.id}`;
                                                }}
                                                className="text-primary-300 hover:text-primary-100 text-sm font-semibold break-words text-left px-3 py-2 rounded transition-colors bg-surface border border-orange-500/50 hover:border-orange-500 hover:bg-surface-highlight/50"
                                              >
                                                {meal.name}
                                              </button>
                                              <div className="flex items-center gap-2 flex-shrink-0">
                                            <button
                                              onClick={(e) => {
                                                e.preventDefault();
                                                const cartItems = (meal.ingredients || [])
                                                  .map((ing: any, idx: number) => {
                                                    const genericName = (ing.name || '').toLowerCase().trim();
                                                    const vettedProduct = VETTED_PRODUCTS[genericName];
                                                    const link = vettedProduct ? vettedProduct.purchaseLink : ing.asinLink;
                                                    if (link) {
                                                      const asinMatch = link.match(/\/dp\/([A-Z0-9]{10})/);
                                                      if (asinMatch) {
                                                        return `ASIN.${idx + 1}=${asinMatch[1]}&Quantity.${idx + 1}=1`;
                                                      }
                                                    }
                                                    return null;
                                                  })
                                                  .filter(Boolean);
                                                if (cartItems.length > 0) {
                                                  const cartUrl = ensureCartUrlSellerId(`https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`);
                                                  window.open(cartUrl, '_blank');
                                                } else {
                                                  alert('No ingredient links available for this recipe.');
                                                }
                                              }}
                                              className="inline-flex items-center gap-1 text-sm px-4 py-2 rounded font-semibold transition-all shadow-md hover:shadow-lg bg-gradient-to-r from-[#FF9900] to-[#F08804] hover:from-[#F08804] hover:to-[#E07704] text-black flex-shrink-0"
                                              title="Buy ingredients"
                                            >
                                              <ShoppingCart size={14} />
                                              Buy
                                            </button>
                                            <button
                                              onClick={(e) => {
                                                e.preventDefault();
                                                setSwapTarget({ dayIdx: index, mealIdx: mealIndex });
                                              }}
                                              className="btn btn-success btn-sm"
                                              title="Edit this slot"
                                            >
                                              Edit
                                            </button>
                                            </div>
                                          </div>
                                        ))}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                                {swapTarget && (
                                  <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center px-4">
                                    <div className="bg-surface rounded-xl border border-surface-highlight shadow-2xl max-w-lg w-full p-5">
                                      <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-lg font-bold text-foreground">Edit Meal Slot</h3>
                                        <button
                                          onClick={() => setSwapTarget(null)}
                                          className="text-gray-400 hover:text-white"
                                          aria-label="Close swap dialog"
                                        >
                                          ‚úï
                                        </button>
                                      </div>
                                      <p className="text-sm text-gray-300 mb-3">Choose a saved or custom meal to place into this slot.</p>
                                      <div className="max-h-72 overflow-y-auto space-y-2">
                                        {allMealsForPlan.map((meal) => (
                                          <button
                                            key={meal.id}
                                            onClick={() => {
                                              if (!swapTarget) return;
                                              setPlanWeekly(prev => {
                                                const copy = prev.map(d => ({ ...d, meals: [...d.meals] }));
                                                copy[swapTarget.dayIdx].meals[swapTarget.mealIdx] = meal;
                                                return copy;
                                              });
                                              setSwapTarget(null);
                                            }}
                                            className="w-full text-left p-3 rounded-lg border border-surface-highlight hover:border-primary-500 hover:bg-surface-highlight transition-colors"
                                          >
                                            <div className="flex justify-between items-center">
                                              <span className="font-semibold text-foreground truncate">{meal.name}</span>
                                              {meal.category === 'custom' && (
                                                <span className="text-xxs text-green-300 bg-green-900/40 px-2 py-0.5 rounded-full">Custom</span>
                                              )}
                                            </div>
                                          </button>
                                        ))}
                                        {allMealsForPlan.length === 0 && (
                                          <p className="text-sm text-gray-400">No meals available to swap.</p>
                                        )}
                                      </div>
                                      <div className="mt-4 flex justify-end">
                                        <button
                                          onClick={() => setSwapTarget(null)}
                                          className="px-4 py-2 text-sm text-gray-200 border border-surface-highlight rounded-lg hover:bg-surface-highlight"
                                        >
                                          Cancel
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="text-gray-400">Add at least one saved or custom meal to generate a weekly plan.</div>
                            )}
                            {planWeekly.length > 0 && (
                              <div className="pt-2 flex gap-2 items-center">
                                <BuyAllMealPlanIngredientsButton weeklyPlan={planWeekly as any} petId={activePet?.id || ''} />
                                <button
                                  onClick={async () => {
                                    if (!activePet) return;
                                    
                                    // Mark plan as completed
                                    const updatedPet = {
                                      ...activePet,
                                      completedMealPlans: (activePet.completedMealPlans || 0) + 1,
                                    };
                                    await savePet(userId, updatedPet);
                                    setPets(prevPets => prevPets.map(p => p.id === activePet.id ? updatedPet : p));
                                    
                                    // Check badges
                                    const uniqueMealIds = new Set<string>();
                                    planWeekly.forEach(day => {
                                      day.meals.forEach(meal => {
                                        if (meal && meal.id) uniqueMealIds.add(meal.id);
                                      });
                                    });
                                    
                                    await checkAllBadges(userId, activePet.id, {
                                      action: 'meal_plan_completed',
                                      mealPlanCount: uniqueMealIds.size,
                                      savedRecipesCount: activePet.savedRecipes?.length || 0,
                                      weeklyPlanCompleted: true,
                                      completionCount: updatedPet.completedMealPlans || 1,
                                    });
                                  }}
                                  className="btn btn-success btn-sm"
                                  title="Mark this weekly plan as completed (saved and locked)"
                                >
                                  ‚úì Lock Plan
                                </button>
                              </div>
                            )}
                            {planWeekly.length > 0 && (
                              <div className="flex flex-wrap gap-2 mt-4">
                                <button
                                  onClick={handleRandomizePlan}
                                  className="btn btn-success btn-sm"
                                >
                                  Randomize Week
                                </button>
                                <Link
                                  href={`/pets/${activePet?.id}/nutrition`}
                                  className="btn btn-success btn-sm"
                                >
                                  View Nutrition Dashboard
                                </Link>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
              </div>
            ) : (
              <div className="bg-surface border border-surface-highlight rounded-2xl shadow-lg p-6 flex items-center justify-center text-center min-h-[280px]">
                <div>
                  <div className="text-3xl mb-2">üêæ</div>
                  <p className="text-lg font-semibold">Select a pet to view details</p>
                  <p className="text-sm text-gray-400 mt-1">Choose a pet from the list on the left.</p>
                </div>
              </div>
            )}
          </div>
        )}

        <AddPetModal
          isOpen={isModalOpen}
          onClose={handleCloseModal}
          onSubmit={handleSubmitPet}
          editingPet={editingPet}
        />

        <ConfirmModal
          isOpen={confirmModal.isOpen}
          onClose={() => setConfirmModal({ ...confirmModal, isOpen: false })}
          onConfirm={confirmModal.onConfirm}
          title={confirmModal.title}
          message={confirmModal.message}
          confirmText="Delete"
          cancelText="Cancel"
          isDeleteModal={true}
        />
      </div>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/custom-meals/[mealId]/page.tsx">
'use client';

import { useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';

export default function CustomMealDetailPage() {
  const params = useParams();
  const router = useRouter();
  const petId = params.id as string;
  const mealId = params.mealId as string;

  useEffect(() => {
    // Redirect to recipe detail page with petId query parameter
    if (mealId && petId) {
      router.replace(`/recipe/${mealId}?petId=${petId}`);
    }
  }, [mealId, petId, router]);

  return (
    <div className="min-h-screen bg-background flex items-center justify-center">
      <p className="text-gray-400">Redirecting...</p>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/custom-meals/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft, Trash2, Edit, Calendar, ChefHat } from 'lucide-react';
import { getCustomMeals, deleteCustomMeal } from '@/lib/utils/customMealStorage';
import { getPets } from '@/lib/utils/petStorage'; // Import async storage
import type { CustomMeal, Pet } from '@/lib/types';

const getCurrentUserId = () => {
  if (typeof window === 'undefined') return 'clerk_simulated_user_id_123';
  return localStorage.getItem('last_user_id') || 'clerk_simulated_user_id_123';
};

const getPetsFromLocalStorage = (userId: string): Pet[] => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  if (!stored) return [];
  try {
    return JSON.parse(stored);
  } catch {
    return [];
  }
};

export default function CustomMealsHistoryPage() {
  const params = useParams();
  const router = useRouter();
  const petId = params.id as string;
  
  const [pet, setPet] = useState<Pet | null>(null);
  const [customMeals, setCustomMeals] = useState<CustomMeal[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadData = async () => {
      const userId = getCurrentUserId();
      try {
        const pets = await getPets(userId);
        const foundPet = pets.find(p => p.id === petId) || null;
        setPet(foundPet);
        
        if (foundPet) {
          const meals = await getCustomMeals(userId, petId);
          // Sort by most recent first
          meals.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
          setCustomMeals(meals);
        }
      } catch (error) {
        console.error('Error loading custom meals:', error);
      }
      setLoading(false);
    };
    loadData();
  }, [petId]);

  const handleDelete = async (mealId: string) => {
    if (!confirm('Are you sure you want to delete this custom meal?')) return;
    
    const userId = getCurrentUserId();
    await deleteCustomMeal(userId, petId, mealId);
    
    // Refresh the list
    const meals = await getCustomMeals(userId, petId);
    meals.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    setCustomMeals(meals);
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600 bg-green-50 border-green-200';
    if (score >= 60) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
    return 'text-red-600 bg-red-50 border-red-200';
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <p className="text-gray-600">Loading custom meals...</p>
      </div>
    );
  }

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white p-8 rounded-xl shadow text-center space-y-4">
          <p className="text-xl font-semibold text-gray-800">Pet not found.</p>
          <Link href="/profile" className="text-green-800 font-semibold">
            Back to Profiles
          </Link>
        </div>
      </div>
    );
  }

  // Get random name from pet's names array
  const petNames = Array.isArray(pet.names) ? pet.names.filter(n => n && n.trim() !== '') : [];
  const petDisplayName = petNames.length > 0 
    ? petNames[Math.floor(Math.random() * petNames.length)]
    : 'Pet';

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Link
                href={`/profile/pet/${petId}`}
                className="p-1.5 hover:bg-gray-100 rounded-md transition-colors"
              >
                <ArrowLeft size={18} className="text-gray-600" />
              </Link>
              <div>
                <h1 className="text-lg font-bold text-gray-900">
                  Custom Meals for {petDisplayName}
                </h1>
                <p className="text-xs text-gray-600 mt-0.5">
                  {pet.breed} ‚Ä¢ {pet.age} ‚Ä¢ {pet.weight}
                </p>
              </div>
            </div>
            <Link
              href={`/profile/pet/${petId}/recipe-builder`}
              className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-800 rounded-md hover:bg-green-900 transition-colors"
            >
              <ChefHat size={16} />
              Create New Meal
            </Link>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-3">
        {customMeals.length === 0 ? (
          <div className="bg-white rounded-lg border border-gray-200 p-12 text-center">
            <ChefHat size={48} className="mx-auto text-gray-400 mb-4" />
            <h2 className="text-xl font-semibold text-gray-900 mb-2">No custom meals yet</h2>
            <p className="text-gray-600 mb-6">
              Create your first custom meal to get started!
            </p>
            <Link
              href={`/profile/pet/${petId}/recipe-builder`}
              className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 transition-colors"
            >
              <ChefHat size={16} />
              Create Your First Meal
            </Link>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {customMeals.map((meal) => (
              <div
                key={meal.id}
                className="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow"
              >
                {/* Meal Header */}
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-gray-900 mb-1">
                      {meal.name}
                    </h3>
                    <div className="flex items-center gap-2 text-sm text-gray-500">
                      <Calendar size={14} />
                      {formatDate(meal.createdAt)}
                    </div>
                  </div>
                  <button
                    onClick={() => handleDelete(meal.id)}
                    className="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                    title="Delete meal"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>

                {/* Compatibility Score */}
                <div className={`mb-4 p-3 rounded-lg border ${getScoreColor(meal.analysis.score)}`}>
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Compatibility Score</span>
                    <span className="text-2xl font-bold">{meal.analysis.score}</span>
                  </div>
                  <div className="w-full bg-white/50 rounded-full h-2 mt-2">
                    <div
                      className={`h-2 rounded-full ${
                        meal.analysis.score >= 80 ? 'bg-green-600' :
                        meal.analysis.score >= 60 ? 'bg-yellow-600' :
                        'bg-red-600'
                      }`}
                      style={{ width: `${meal.analysis.score}%` }}
                    />
                  </div>
                </div>

                {/* Ingredients Summary */}
                <div className="mb-4">
                  <h4 className="text-sm font-medium text-gray-700 mb-2">Ingredients</h4>
                  <div className="space-y-1">
                    {meal.ingredients.slice(0, 3).map((ing, idx) => (
                      <div key={idx} className="text-sm text-gray-600">
                        ‚Ä¢ {ing.key.replace(/_/g, ' ')} ({ing.grams}g)
                      </div>
                    ))}
                    {meal.ingredients.length > 3 && (
                      <div className="text-sm text-gray-500">
                        + {meal.ingredients.length - 3} more
                      </div>
                    )}
                  </div>
                </div>

                {/* Nutritional Summary */}
                <div className="mb-4 text-sm">
                  <div className="flex justify-between mb-1">
                    <span className="text-gray-600">Total Weight:</span>
                    <span className="font-medium">{meal.analysis.totalRecipeGrams}g</span>
                  </div>
                  <div className="flex justify-between mb-1">
                    <span className="text-gray-600">Recommended Serving:</span>
                    <span className="font-medium text-green-800">
                      {meal.analysis.recommendedServingGrams}g
                    </span>
                  </div>
                </div>

                {/* Warnings Summary */}
                {meal.analysis.toxicityWarnings.length > 0 && (
                  <div className="mb-4 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-800">
                    ‚ö†Ô∏è {meal.analysis.toxicityWarnings.length} safety warning(s)
                  </div>
                )}

                {/* Actions */}
                <div className="flex gap-2 pt-4 border-t border-gray-200">
                  <button
                    onClick={() => {
                      // TODO: Implement edit functionality (load meal into builder)
                      router.push(`/profile/pet/${petId}/recipe-builder?mealId=${meal.id}`);
                    }}
                    className="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                  >
                    <Edit size={14} />
                    Edit
                  </button>
                  <button
                    onClick={() => {
                      router.push(`/recipe/${meal.id}?petId=${petId}`);
                    }}
                    className="flex-1 px-3 py-2 text-sm font-medium text-green-800 bg-green-900/10 border border-green-800/30 rounded-md hover:bg-green-900/20 transition-colors"
                  >
                    View Details
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/meal-plan/page.tsx">
'use client';

import { useEffect, useMemo, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft, ShoppingCart } from 'lucide-react';
import type { Recipe, CustomMeal } from '@/lib/types';
import { getProductPrice } from '@/lib/data/product-prices';
import { VETTED_PRODUCTS, getVettedProduct, getVettedProductByAnyIdentifier } from '@/lib/data/vetted-products';
import { getCustomMeals } from '@/lib/utils/customMealStorage';
import { getPets } from '@/lib/utils/petStorage'; // Import async storage
import { ensureCartUrlSellerId } from '@/lib/utils/affiliateLinks';

// Format price for display
const formatPrice = (price: number) => {
  return `$${price.toFixed(2)}`;
};

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

interface PetProfile {
  id: string;
  name: string;
  savedRecipes: string[];
}

const getCurrentUserId = () => {
  if (typeof window === 'undefined') return SIMULATED_USER_ID;
  return localStorage.getItem('last_user_id') || SIMULATED_USER_ID;
};

const getPetsFromLocalStorage = (userId: string): PetProfile[] => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  if (!stored) return [];
  try {
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed)
      ? parsed.map((pet: any) => ({
          id: pet.id,
          name: pet.name,
          savedRecipes: pet.savedRecipes || [],
        }))
      : [];
  } catch {
    return [];
  }
};

const buildEvenPlan = (meals: Recipe[]) => {
  const totalSlots = DAYS.length * 2;
  const rotation: Recipe[] = [];
  while (rotation.length < totalSlots) {
    rotation.push(...meals);
  }
  return rotation.slice(0, totalSlots);
};

const shuffleMealsNoRepeats = (meals: Recipe[], totalSlots: number) => {
  if (meals.length === 0) return [];
  const poolBase = [...meals];
  const rotation: Recipe[] = [];

  const shuffle = (arr: Recipe[]) => {
    for (let i = arr.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  let pool = shuffle([...poolBase]);

  while (rotation.length < totalSlots) {
    if (pool.length === 0) {
      pool = shuffle([...poolBase]);
    }
    const next = pool.pop() as Recipe;
    // Avoid duplicate within the same day (pair of two)
    if (rotation.length % 2 === 1 && rotation[rotation.length - 1].id === next.id) {
      // Put it back to the front and try another
      pool.unshift(next);
      continue;
    }
    rotation.push(next);
  }

  return rotation;
};

export default function MealPlanPage() {
  const params = useParams();
  const router = useRouter();
  const petId = params.id as string;

  const [pet, setPet] = useState<PetProfile | null>(null);
  const [savedMeals, setSavedMeals] = useState<Recipe[]>([]);
  const [customMeals, setCustomMeals] = useState<CustomMeal[]>([]);
  const [weeklyPlan, setWeeklyPlan] = useState<{ day: string; meals: Recipe[] }[]>([]);
  const [loading, setLoading] = useState(true);
  const [swapTarget, setSwapTarget] = useState<{ dayIdx: number; mealIdx: number } | null>(null);

  // Convert custom meal to Recipe format for meal plan
  const convertCustomMealToRecipe = (customMeal: CustomMeal): Recipe => {
    return {
      id: customMeal.id,
      name: customMeal.name,
      category: 'custom', // Mark as custom meal
      ageGroup: ['adult'], // Default, could be enhanced
      healthConcerns: [],
      description: `Custom meal created on ${new Date(customMeal.createdAt).toLocaleDateString()}`,
      ingredients: customMeal.ingredients.map((ing, idx) => ({
        id: `${idx + 1}`,
        name: ing.key.replace(/_/g, ' '),
        amount: `${ing.grams}g`,
      })),
      instructions: [
        'Mix all ingredients according to saved recipe',
        'Serve at recommended portion size',
        `Recommended serving: ${customMeal.analysis.recommendedServingGrams}g`,
      ],
      nutritionalInfo: {
        protein: {
          min: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
          max: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
          unit: '%',
        },
        fat: {
          min: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
          max: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
          unit: '%',
        },
        calories: {
          min: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
          max: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
          unit: 'kcal',
        },
      },
      rating: 0,
      reviews: 0,
      tags: ['custom', 'user-created'],
    };
  };

  useEffect(() => {
    const loadData = async () => {
      const userId = getCurrentUserId();
      try {
        const pets = await getPets(userId);
        const foundPet = pets.find((p: any) => p.id === petId) || null;
        
        if (foundPet) {
          // Normalize pet profile
          setPet({
            id: foundPet.id,
            name: foundPet.name || foundPet.names?.[0] || 'Pet',
            savedRecipes: foundPet.savedRecipes || [],
          });

          // Saved recipes are no longer stored statically
          setSavedMeals([]);
          
          // Load custom meals
          const customMealsList = await getCustomMeals(userId, petId);
          setCustomMeals(customMealsList);
        } else {
          setPet(null);
        }
      } catch (error) {
        console.error('Error loading meal plan data:', error);
      }
      setLoading(false);
    };
    loadData();
  }, [petId]);

  const generatePlan = (meals: Recipe[]) => {
    const rotation = buildEvenPlan(meals);
    const plan: { day: string; meals: Recipe[] }[] = [];
    for (let i = 0; i < DAYS.length; i += 1) {
      const breakfastIndex = i * 2;
      const dinnerIndex = breakfastIndex + 1;
      const breakfast = rotation[breakfastIndex];
      let dinner = rotation[dinnerIndex];
      if (dinner.id === breakfast.id) {
        const swapIndex = rotation.findIndex(
          (entry, idx) => idx > dinnerIndex && entry.id !== breakfast.id
        );
        if (swapIndex !== -1) {
          [rotation[dinnerIndex], rotation[swapIndex]] = [
            rotation[swapIndex],
            rotation[dinnerIndex],
          ];
          dinner = rotation[dinnerIndex];
        } else {
          dinner = meals.find((meal) => meal.id !== breakfast.id) || dinner;
        }
      }
      plan.push({ day: DAYS[i], meals: [breakfast, dinner] });
    }
    return plan;
  };

  const allMeals = useMemo<Recipe[]>(() => {
    return [
      ...savedMeals,
      ...customMeals.map(convertCustomMealToRecipe),
    ];
  }, [savedMeals, customMeals]);

  useEffect(() => {
    if (allMeals.length > 0) {
      setWeeklyPlan(generatePlan(allMeals));
    }
  }, [allMeals]);

  const handleRegenerate = () => {
    setWeeklyPlan(generatePlan(allMeals));
  };

  const handleRandomize = () => {
    const totalSlots = DAYS.length * 2;
    const rotation = shuffleMealsNoRepeats(allMeals, totalSlots);
    const plan: { day: string; meals: Recipe[] }[] = [];
    for (let i = 0; i < DAYS.length; i += 1) {
      const breakfastIndex = i * 2;
      const dinnerIndex = breakfastIndex + 1;
      const breakfast = rotation[breakfastIndex];
      const dinner = rotation[dinnerIndex];
      plan.push({ day: DAYS[i], meals: [breakfast, dinner] });
    }
    setWeeklyPlan(plan);
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <p className="text-gray-600">Loading meal plan...</p>
      </div>
    );
  }

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white p-8 rounded-xl shadow text-center space-y-4">
          <p className="text-xl font-semibold text-gray-800">Pet not found.</p>
          <Link href="/profile" className="text-green-800 font-semibold">
            Back to Profiles
          </Link>
        </div>
      </div>
    );
  }

  const allMealsCount = savedMeals.length + customMeals.length;
  
  if (allMealsCount < 1) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div className="max-w-lg bg-white rounded-xl shadow p-8 text-center space-y-4">
          <div className="text-5xl">üçΩÔ∏è</div>
          <h1 className="text-2xl font-bold text-gray-900">Add more meals first</h1>
          <p className="text-gray-600">
            Save at least two meals (recipes or custom meals) for {pet.name} to build a balanced weekly rotation.
          </p>
          <div className="flex flex-col gap-2">
            <button
              onClick={() => router.push(`/recipes/recommended/${pet.id}`)}
              className="bg-green-800 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-900 transition-colors"
            >
              See Recommended Meals
            </button>
            <button
              onClick={() => router.push(`/profile/pet/${pet.id}/recipe-builder`)}
              className="bg-green-800 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-900 transition-colors"
            >
              Create Custom Meal
            </button>
            <button
              onClick={() => router.push(`/profile/pet/${pet.id}`)}
              className="text-green-800 font-semibold"
            >
              Find More Meals for {pet.name}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-10 px-4">
      <div className="max-w-6xl mx-auto space-y-8">
        <div className="bg-white rounded-xl shadow p-6 flex flex-col gap-4">
          <div className="flex items-center gap-3 text-green-800">
            <button
              onClick={() => router.push('/profile')}
              className="inline-flex items-center gap-2 font-semibold"
            >
              <ArrowLeft size={20} />
              Back to pets
            </button>
          </div>
            <div>
              <p className="text-sm uppercase tracking-wide text-gray-500 font-semibold">
                Weekly Meal Prep
              </p>
              <h1 className="text-3xl font-bold text-gray-900">
                7-Day Meal Plan for {pet.name}
              </h1>
              <p className="text-gray-600 mt-1">
                Two meals per day. No repeats on the same day. Each saved meal gets equal play.
              </p>
            </div>
          </div>
        

        <div className="grid grid-cols-7 gap-2">
          {weeklyPlan.map((dayPlan, index) => (
            <div key={dayPlan.day} className="bg-white rounded-lg shadow p-2">
              <div className="text-center mb-2">
                <p className="text-xs uppercase tracking-wide text-gray-500 font-semibold">
                  {dayPlan.day.slice(0, 3)}
                </p>
              </div>
              <div className="space-y-2">
                {dayPlan.meals.map((meal, mealIndex) => (
                  <div key={meal.id + mealIndex} className="text-center">
                    <Link
                      href={`/recipe/${meal.id}?petId=${petId}`}
                      className="block hover:text-primary-600 transition-colors mb-1"
                    >
                      <p className="font-medium text-gray-900 text-xs leading-tight">
                        {meal.name}
                        {meal.category === 'custom' && (
                          <span className="ml-1 text-xs text-green-800">(Custom)</span>
                        )}
                      </p>
                    </Link>
                    <div className="flex flex-col items-center gap-1">
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          const cartItems = meal.ingredients
                            .map((ing, index) => {
                              const genericName = ing.name.toLowerCase().trim();
                              const vettedProduct = VETTED_PRODUCTS[genericName];
                              const link = vettedProduct ? vettedProduct.purchaseLink : ing.asinLink;
                              if (link) {
                                // Extract ASIN from /dp/ASIN format
                                const asinMatch = link.match(/\/dp\/([A-Z0-9]{10})/);
                                if (asinMatch) {
                                  return `ASIN.${index + 1}=${asinMatch[1]}&Quantity.${index + 1}=1`;
                                }
                              }
                              return null;
                            })
                            .filter(Boolean);

                          if (cartItems.length > 0) {
                            const cartUrl = ensureCartUrlSellerId(`https://www.amazon.com/gp/aws/cart/add.html?${cartItems.join('&')}`);
                            window.open(cartUrl, '_blank');
                          } else {
                            alert('No ingredient links available for this recipe.');
                          }
                        }}
                        className="inline-flex items-center gap-1 text-xs bg-green-600 text-black px-1 py-0.5 rounded hover:bg-green-700 transition-colors"
                        title="Add all vetted ingredients to your Amazon cart"
                      >
                        <ShoppingCart size={8} />
                        Buy
                      </button>
                      {/* Price Display */}
                      {(() => {
                        const mealTotalPrice = meal.ingredients?.reduce((sum, ing) => {
                          const price = getProductPrice(ing.name);
                          if (typeof price === 'number') return sum + price;
                          return sum;
                        }, 0) || 0;
                        return mealTotalPrice > 0 ? (
                          <span className="text-[10px] text-green-700 font-semibold">
                            {formatPrice(mealTotalPrice)}
                          </span>
                        ) : null;
                      })()}
                    </div>
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        setSwapTarget({ dayIdx: index, mealIdx: mealIndex });
                      }}
                    className="mt-2 w-full inline-flex items-center justify-center gap-1 text-xs px-2 py-1 rounded border border-primary-500 text-primary-700 bg-white hover:bg-primary-50 transition-colors"
                      title="Edit this slot"
                    >
                    Edit
                    </button>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        {swapTarget && (
          <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center px-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-5 border border-gray-200">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-bold text-gray-900">Swap Meal</h3>
                <button
                  onClick={() => setSwapTarget(null)}
                  className="text-gray-500 hover:text-gray-700"
                  aria-label="Close swap dialog"
                >
                  ‚úï
                </button>
              </div>
              <p className="text-sm text-gray-600 mb-3">Choose a saved meal to place into this slot.</p>
              <div className="max-h-72 overflow-y-auto space-y-2">
                {allMeals.map((meal) => (
                  <button
                    key={meal.id}
                    onClick={() => {
                      if (!swapTarget) return;
                      const planCopy = weeklyPlan.map((d) => ({ ...d, meals: [...d.meals] }));
                      planCopy[swapTarget.dayIdx].meals[swapTarget.mealIdx] = meal;
                      setWeeklyPlan(planCopy);
                      setSwapTarget(null);
                    }}
                    className="w-full text-left p-3 rounded-lg border border-gray-200 hover:border-green-600 hover:bg-green-50 transition-colors"
                  >
                    <div className="flex justify-between items-center">
                      <span className="font-semibold text-gray-900">{meal.name}</span>
                      {meal.category === 'custom' && (
                        <span className="text-xs text-green-700 bg-green-100 px-2 py-0.5 rounded-full">Custom</span>
                      )}
                    </div>
                  </button>
                ))}
                {allMeals.length === 0 && (
                  <p className="text-sm text-gray-500">No saved meals available.</p>
                )}
              </div>
              <div className="mt-4 flex justify-end gap-2">
                <button
                  onClick={() => setSwapTarget(null)}
                  className="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-bold text-gray-900 mb-2">How rotation works</h3>
          <p className="text-gray-600 text-sm mb-2">
            We loop through every saved meal (recipes and custom meals) equally, then shuffle lightly to keep variety.
            Each day uses two different meals so {pet.name} never sees a repeat on the same day.
          </p>
          <div className="mt-3 pt-3 border-t border-gray-200">
            <p className="text-xs text-gray-500">
              <strong>Meals included:</strong> {savedMeals.length} saved recipe{savedMeals.length !== 1 ? 's' : ''} 
              {customMeals.length > 0 && ` + ${customMeals.length} custom meal${customMeals.length !== 1 ? 's' : ''}`}
            </p>
          </div>
        </div>

        <div className="flex flex-wrap gap-2 mt-4">
          <button
            onClick={handleRandomize}
            className="btn btn-success btn-sm"
          >
            Randomize Week
          </button>
          <Link
            href={`/pets/${petId}/nutrition`}
            className="btn btn-success btn-sm"
          >
            View Nutrition Dashboard
          </Link>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/page.tsx">
'use client';

import { useState, useEffect, useMemo, useRef } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { ArrowLeft, Plus } from 'lucide-react';
import type { ModifiedRecipeResult, Recipe } from '@/lib/types';
import { calculateEnhancedCompatibility, type Pet as EnhancedPet, getGrade } from '@/lib/utils/enhancedCompatibilityScoring';
import { CompatibilityBadge } from '@/components/CompatibilityBadge';
import { getRandomName } from '@/lib/utils/petUtils';
import EmojiIcon from '@/components/EmojiIcon';
import { getPets, savePet } from '@/lib/utils/petStorage'; // Import from storage util
import { useChunkedRecipeScoring } from '@/lib/hooks/useChunkedRecipeScoring';
import ScoringProgress from '@/components/ScoringProgress';
import { calculateMealCountVariation } from '@/lib/utils/mealCountCalculator';
import { makeCountOrganic, getCountMessage, getSubtext } from '@/lib/utils/organicCount';
import { useProgressiveMealCount } from '@/hooks/useProgressiveMealCount';


type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
type AgeGroup = 'baby' | 'young' | 'adult' | 'senior';

interface Pet {
  id: string;
  name?: string; // Legacy field, prefer names array
  names?: string[]; // Array of names
  type: PetCategory;
  breed: string;
  age: AgeGroup;
  healthConcerns?: string[];
  dietaryRestrictions?: string[];
  savedRecipes?: string[];
  allergies?: string[];
  weightKg?: number;
  weight?: string;
  dislikes?: string[];
}

// Same simulated user ID setup as profile and saved-recipes pages
const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

const getCurrentUserId = () => {
  if (typeof window === 'undefined') return SIMULATED_USER_ID;
  return localStorage.getItem('last_user_id') || SIMULATED_USER_ID;
};

// Get custom recipes from localStorage
const getCombinedRecipes = (): Recipe[] => {
  if (typeof window !== 'undefined') {
    try {
      const customRecipes = JSON.parse(localStorage.getItem('custom_recipes') || '[]');
      return customRecipes;
    } catch (error) {
      console.error('Error loading custom recipes:', error);
    }
  }

  return [];
};

export default function RecommendedRecipesPage() {
  const params = useParams();
  const [pet, setPet] = useState<Pet | null>(null);
  const [hoveredRecipe, setHoveredRecipe] = useState<string | null>(null);
  const [engineMeals, setEngineMeals] = useState<ModifiedRecipeResult[] | null>(null);
  const [engineError, setEngineError] = useState<string | null>(null);
  const [loadingMeals, setLoadingMeals] = useState(true);
  const [cardMessage, setCardMessage] = useState<{ id: string; text: string } | null>(null);
  const petId = params.id as string;

  // Get pet display name (use names array if available, fallback to name field) - memoized for stability
  const petDisplayName = useMemo(() => {
    if (!pet) return 'Pet';
    return getRandomName(pet.names || (pet.name ? [pet.name] : ['Unnamed Pet']));
  }, [pet?.id, pet?.names, pet?.name]);

  // Convert pet data to rating system format - memoized to prevent recalculation when only savedRecipes changes
  // Use JSON.stringify for arrays to ensure stable comparison
  const healthConcernsKey = pet ? JSON.stringify(pet.healthConcerns || []) : '';
  const allergiesKey = pet ? JSON.stringify(pet.allergies || []) : '';
  const dislikesKey = pet ? JSON.stringify(pet.dislikes || []) : '';
  
  // Convert pet data to enhanced compatibility format
  const enhancedPet: EnhancedPet | null = useMemo(() => {
    if (!pet) return null;
    const petAge = pet.age === 'baby' ? 0.5 : pet.age === 'young' ? 2 : pet.age === 'adult' ? 5 : 10;
    return {
      id: pet.id,
      name: petDisplayName,
      type: (pet.type === 'dogs' ? 'dog' : pet.type === 'cats' ? 'cat' : pet.type === 'birds' ? 'bird' : pet.type === 'reptiles' ? 'reptile' : 'pocket-pet') as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
      breed: pet.breed,
      age: petAge,
      weight: pet.weightKg || (pet.type === 'dogs' ? 25 : pet.type === 'cats' ? 10 : 5),
      activityLevel: 'moderate' as const,
      healthConcerns: pet.healthConcerns || [],
      dietaryRestrictions: pet.dietaryRestrictions || [],
      allergies: pet.allergies || [],
    };
  }, [pet?.id, pet?.type, pet?.breed, pet?.age, pet?.weightKg, healthConcernsKey, allergiesKey, petDisplayName, pet?.dietaryRestrictions]);


  useEffect(() => {
    const userId = getCurrentUserId();
    if (!userId || !petId) return;

    const loadPet = async () => {
      try {
        // Add 5 second timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout loading pets')), 5000)
        );
        
        const pets = await Promise.race([
          getPets(userId),
          timeoutPromise
        ]) as any[];
        
        // Normalize names when loading
        const normalizedPets = pets.map((p: any) => ({
          ...p,
          names: p.names || (p.name ? [p.name] : []),
          savedRecipes: p.savedRecipes || [],
          healthConcerns: p.healthConcerns || [],
        }));
        
        const foundPet = normalizedPets.find((p: any) => p.id === petId) || null;
        setPet(foundPet);
        
        if (!foundPet) {
          console.warn('Pet not found with id:', petId);
          setLoadingMeals(false); // Stop loading if pet not found
        }
      } catch (error) {
        console.error('Failed to load pet data:', error);
        setPet(null);
        setLoadingMeals(false); // CRITICAL: Stop loading on error
      }
    };
    loadPet();
  }, [petId]); // petId is the only dependency needed

useEffect(() => {
  if (!pet) return;
  let isMounted = true;
  setLoadingMeals(true);
  setEngineError(null);

  (async () => {
    try {
      // First try the new cost-optimized recipe generation API
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      const response = await fetch('/api/recipes/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal,
        body: JSON.stringify({
          species: pet.type,
          count: 50,
          petProfile: {
            name: petDisplayName,
            weight: pet.weight,
            weightKg: pet.weightKg,
            age: pet.age,
            allergies: pet.allergies || [],
            healthConcerns: pet.healthConcerns || [],
          },
        }),
      });
      
      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`Recipe generation failed (${response.status})`);
      }

      const data = await response.json();
      if (!isMounted) return;
      
      if (data?.recipes && data.recipes.length > 0) {
        // Convert generated recipes to ModifiedRecipeResult format
        const generatedMeals = data.recipes.map((recipe: any) => ({
          recipe,
          explanation: `Cost-optimized meal: $${recipe.estimatedCostPerMeal?.toFixed(2) || 'N/A'} per meal`,
        }));
        setEngineMeals(generatedMeals as ModifiedRecipeResult[]);
      } else {
        throw new Error('No recipes generated');
      }
    } catch (error) {
      if (!isMounted) return;
      console.error('Recipe generation error:', error);
      // Fall back to recommendations API if generation fails
      try {
        const concerns = (pet.healthConcerns || []).filter((concern) => concern !== 'none');
        const allergies = pet.allergies?.filter((allergy) => allergy !== 'none') || [];
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch('/api/recommendations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal,
          body: JSON.stringify({
            profile: {
              species: pet.type,
              ageGroup: pet.age,
              breed: pet.breed,
              weightKg: pet.weightKg || 10,
              healthConcerns: concerns,
              allergies,
              petName: petDisplayName,
            },
            limit: 50,
          }),
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Recommendations failed (${response.status})`);
        }

        const data = await response.json();
        if (!isMounted) return;
        
        setEngineMeals((data?.results as ModifiedRecipeResult[]) || []);
      } catch (fallbackError) {
        if (!isMounted) return;
        setEngineMeals(null);
        setEngineError('Unable to load meals‚Äîshowing standard matches.');
      }
    } finally {
      if (isMounted) {
        setLoadingMeals(false);
      }
    }
  })();

  return () => {
    isMounted = false;
  };
}, [pet]);

  // Debug logging (as suggested by DeepSeek) - MUST be after all useState hooks, before early returns
  useEffect(() => {
    // Only log state variables, not computed values
    if (pet) {
      const { getRecommendedRecipes } = require('@/lib/utils/recipeRecommendations');
      const tieredRecommendations = getRecommendedRecipes(pet, 20, true);
      const fallbackCount = tieredRecommendations.length;
      
      // Using engine meals or fallback
    }
  }, [engineMeals, pet]);

  // Import subtype matching
  const { normalizeToSubtype } = require('@/lib/utils/ingredientWhitelists');
  
  // Helper to check species/subtype match
  const matchesSpecies = (recipe: Recipe, currentPet: Pet): boolean => {
    if (recipe.category === currentPet.type) return true;
    
    // Subtype matching for exotics
    const subtype = normalizeToSubtype(currentPet.type as any, currentPet.breed);
    
    if (currentPet.type === 'birds') {
      if (recipe.category === 'birds' || recipe.category === 'bird') return true;
      if (recipe.category === subtype) return true;
    }
    
    if (currentPet.type === 'reptiles') {
      if (recipe.category === 'reptiles' || recipe.category === 'reptile') return true;
      if (recipe.category === subtype) return true;
    }
    
    if (currentPet.type === 'pocket-pets') {
      if (recipe.category === 'pocket-pets' || recipe.category === 'pocket-pet') return true;
      if (recipe.category === subtype) return true;
    }
    
    return false;
  };

  // Use tiered recommendation system to ensure we always have results
  // Only depend on properties that affect recommendations, NOT savedRecipes
  // Use JSON.stringify for arrays to ensure stable comparison
  const tieredHealthConcernsKey = pet ? JSON.stringify(pet.healthConcerns || []) : '';
  const tieredAllergiesKey = pet ? JSON.stringify(pet.allergies || []) : '';

  const tieredRecommendations = useMemo(() => {
    if (!pet) return [];
    const { getRecommendedRecipes } = require('@/lib/utils/recipeRecommendations');
    // Pass combined recipes (base + custom) to the recommendation system
    const combinedRecipes = getCombinedRecipes();
    return getRecommendedRecipes(pet, 20, true, combinedRecipes);
  }, [pet?.id, pet?.type, pet?.breed, pet?.age, tieredHealthConcernsKey, pet?.weightKg, tieredAllergiesKey]);
  
  const buildFallbackExplanation = (recipe: Recipe, currentPet: Pet, tierLabel?: string, warning?: string) => {
    if (warning) {
      return warning;
    }
    if (tierLabel && tierLabel !== 'Best Match') {
      return `${recipe.name} - ${tierLabel}`;
    }
    const concern = (currentPet.healthConcerns || [])[0]?.replace(/-/g, ' ') || 'overall wellness';
    const highlight = recipe.tags?.[0] || (recipe.description || '').split('. ')[0] || recipe.name;
    return `${recipe.name} keeps ${currentPet.name || 'pet'}'s ${concern} on track with ${highlight?.toLowerCase()}.`;
  };

  // Convert tiered recommendations to format expected by UI
  // Only depend on properties that affect meal recommendations, NOT savedRecipes
  const fallbackHealthConcernsKey = pet ? JSON.stringify(pet.healthConcerns || []) : '';
  const fallbackPetName = pet?.name || '';
  
  const fallbackMeals = useMemo(() => {
    if (!pet) return [];
    return tieredRecommendations.map((rec: any) => ({
      recipe: rec.recipe,
      explanation: buildFallbackExplanation(rec.recipe, pet, rec.tierLabel, rec.warning),
      _tierLabel: rec.tierLabel,
      _warning: rec.warning,
      _healthMatch: rec.healthConcernMatch,
      _tier: rec.tier
    }));
  }, [pet?.id, pet?.type, pet?.breed, pet?.age, fallbackHealthConcernsKey, fallbackPetName, tieredRecommendations]);

  // Fix: Properly check for empty array - use fallback if engineMeals is null, undefined, empty, or has too few results
  // Use fallback if API returns fewer than 15 meals (threshold to ensure we get a good selection)
  const MIN_MEALS_THRESHOLD = 15;
  // Memoize mealsToRender to prevent recalculation when only savedRecipes changes
  const mealsToRender: (ModifiedRecipeResult | { recipe: Recipe; explanation: string })[] = useMemo(() => {
    const hasEnoughFromAPI = engineMeals && Array.isArray(engineMeals) && engineMeals.length >= MIN_MEALS_THRESHOLD;
    return hasEnoughFromAPI ? engineMeals : fallbackMeals;
  }, [engineMeals, fallbackMeals]);

  // Use chunked scoring hook for non-blocking performance
  const { scoredMeals, isLoading: isScoring, progress, totalMeals: totalMealsToScore, scoredCount } = useChunkedRecipeScoring(
    mealsToRender,
    null, // ratingPet deprecated - using enhancedPet only
    enhancedPet
  );

  // Store sorted meals (already sorted by the hook, but ensure final sort)
  const sortedMealsToRender = useMemo(() => {
    return [...scoredMeals].sort((a: any, b: any) => {
      const aScore = ('score' in a && typeof a.score === 'number') ? a.score : 0;
      const bScore = ('score' in b && typeof b.score === 'number') ? b.score : 0;
      const scoreDiff = bScore - aScore;
      // If scores differ, sort by score (descending)
      if (Math.abs(scoreDiff) > 0.001) {
        return scoreDiff;
      }
      // If scores are equal, use recipe ID as tiebreaker
      const aId = a.recipe?.id || '';
      const bId = b.recipe?.id || '';
      return aId.localeCompare(bId);
    });
  }, [scoredMeals]);

  // Calculate base meal count (before early returns to ensure hooks are always called)
  const baseTotalMeals = sortedMealsToRender.length;
  
  // Memoize the count calculation - use actual count with minimal organic tweaking
  // Only recalculate when pet profile or base count changes
  const { countMessage, countSubtext, targetDisplayCount } = useMemo(() => {
    // Use the actual count as the base
    const message = getCountMessage(baseTotalMeals, pet?.type);
    const subtext = getSubtext(baseTotalMeals, pet?.type);
    // Use actual count
    const target = baseTotalMeals;
    
    return {
      countMessage: message,
      countSubtext: subtext,
      targetDisplayCount: target,
    };
  }, [baseTotalMeals, pet?.type]);
  
  // Progressive count animation - MUST be called before any early returns
  const { displayCount, isCounting } = useProgressiveMealCount({
    target: targetDisplayCount,
    duration: 1000,
    steps: 20,
  });

  // Track saved recipes separately to avoid triggering meal recalculation
  const [savedRecipeIds, setSavedRecipeIds] = useState<Set<string>>(new Set());

  // Initialize savedRecipeIds from pet when pet loads
  useEffect(() => {
    if (pet?.savedRecipes) {
      setSavedRecipeIds(new Set(pet.savedRecipes));
    }
  }, [pet?.id]); // Only update when pet ID changes, not when savedRecipes changes

  const handleSaveRecipe = async (recipeId: string, recipeName: string) => {
    const userId = getCurrentUserId();
    if (!userId || !pet) return;

    // Check if already saved (using local state)
    if (savedRecipeIds.has(recipeId)) {
      setCardMessage({ id: recipeId, text: 'Already saved for this pet.' });
      setTimeout(() => setCardMessage(null), 2500);
      return;
    }

    // Update via storage util
    const updatedPet = {
      ...pet,
      savedRecipes: [...(pet.savedRecipes || []), recipeId]
    };
    
    await savePet(userId, updatedPet);

    // Update local state to reflect the change immediately
    setPet(updatedPet);
    setSavedRecipeIds(new Set([...savedRecipeIds, recipeId]));
    setCardMessage({ id: recipeId, text: `${recipeName} added to ${petDisplayName}'s meals.` });
    setTimeout(() => setCardMessage(null), 2500);
  };

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background text-foreground">
        <p>Loading...</p>
      </div>
    );
  }

  const usingEngine = Boolean(engineMeals && engineMeals.length > 0);

  const getPetEmoji = (type: PetCategory) => {
    const emojis = {
      dogs: 'üêï',
      cats: 'üêà',
      birds: 'ü¶ú',
      reptiles: 'ü¶é',
      'pocket-pets': 'üê∞',
    };
    return emojis[type];
  };
  
  // Component to render pet emoji as image
  const PetEmojiIcon = ({ type, size = 24 }: { type: PetCategory; size?: number }) => {
    const emoji = getPetEmoji(type);
    return <EmojiIcon emoji={emoji} size={size} />;
  };

  const getHealthCompatibilityScore = (recipe: any, pet: Pet): number => {
    const concerns = pet.healthConcerns || [];
    if (!concerns.length) return 0;
    const overlaps = concerns.filter((c) => (recipe.healthConcerns || []).includes(c));
    if (!overlaps.length) return 0;
    return overlaps.length / concerns.length; // 0..1
  };

  const getHealthMatchBadge = (score: number) => {
    if (score >= 0.67)
      return {
        label: 'Great health match',
        className: 'bg-green-900/50 text-green-200 border border-green-700/50',
      };
    if (score >= 0.34)
      return {
        label: 'Good health match',
        className: 'bg-yellow-900/50 text-yellow-200 border border-yellow-700/50',
      };
    if (score > 0)
      return {
        label: 'Some health benefit',
        className: 'bg-blue-900/50 text-blue-200 border border-blue-700/50',
      };
    return null;
  };

  const getStarStates = (rating: number): boolean[] => {
    const fullStars = Math.round(rating); // 0..5
    return Array.from({ length: 5 }, (_, i) => i < fullStars);
  };

  return (
    <div className="min-h-screen bg-background text-foreground py-4">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <Link
          href="/profile"
          className="inline-flex items-center gap-2 text-gray-400 hover:text-primary-400 mb-6"
        >
          <ArrowLeft className="h-5 w-5" />
          Back to Profile
        </Link>

        <div 
          className="bg-surface rounded-lg shadow-md border border-surface-highlight p-4 mb-3"
        >
          <div className="flex items-start gap-4">
            {/* Left: Turtle Image (twice as large) */}
            <div className="flex-shrink-0">
              <Image
                src="/images/emojis/Mascots/Sherlock Shells/Shell4.jpg"
                alt="Sherlock Shells Detective"
                width={288}
                height={288}
                className="w-72 h-72 object-contain mascot-icon mascot-sherlock-shells"
                unoptimized
              />
            </div>

            {/* Left-Middle: Title and Bio Info in Grid */}
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-foreground mb-6 mt-8">
                Sherlock Shells is detecting meals...
              </h1>
              
              {/* Three Column Layout: Bio, Health Concerns, Allergies */}
              <div className="flex gap-6 mt-8">
                {/* Bio Column */}
                <div className="flex-1 min-w-0">
                  <h3 className="text-sm font-semibold text-gray-300 mb-2">Bio</h3>
                  <div className="grid grid-cols-1 gap-y-1 text-sm text-gray-300">
                    {pet.breed && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Breed:</strong> {pet.breed}</span>
                      </div>
                    )}
                    {pet.age && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Age:</strong> {pet.age}</span>
                      </div>
                    )}
                    {(pet.weightKg || pet.weight) && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Weight:</strong> {pet.weightKg ? `${pet.weightKg}kg` : pet.weight}</span>
                      </div>
                    )}
                    {pet.type && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Type:</strong> {pet.type}</span>
                      </div>
                    )}
                    {pet.savedRecipes && pet.savedRecipes.length > 0 && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Total Meals:</strong> {pet.savedRecipes.length}</span>
                      </div>
                    )}
                    {(pet.dietaryRestrictions || []).length > 0 && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Dietary Restrictions:</strong> {(pet.dietaryRestrictions || []).join(', ')}</span>
                      </div>
                    )}
                    {(pet.dislikes || []).length > 0 && (
                      <div className="flex items-start gap-1.5">
                        <span className="text-orange-400 mt-0.5">‚Ä¢</span>
                        <span><strong className="text-gray-200">Dislikes:</strong> {(pet.dislikes || []).join(', ')}</span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Health Concerns Column - Always rendered for consistent layout */}
                <div className="flex-shrink-0 min-w-[180px]">
                  <h3 className="text-sm font-semibold text-gray-300 mb-2">Health Concerns</h3>
                  <div className="flex flex-col gap-1.5">
                    {(pet.healthConcerns || []).length > 0 ? (
                      (pet.healthConcerns || []).map((concern) => (
                        <div
                          key={concern}
                          className="px-2 py-1 bg-orange-900/40 text-orange-200 border border-orange-700/50 text-xs rounded"
                        >
                          {concern.replace(/-/g, ' ')}
                        </div>
                      ))
                    ) : (
                      <div className="px-2 py-1 text-gray-500 text-xs italic">
                        None
                      </div>
                    )}
                  </div>
                </div>

                {/* Allergies Column - Always rendered for consistent layout */}
                <div className="flex-shrink-0 min-w-[180px]">
                  <h3 className="text-sm font-semibold text-gray-300 mb-2">Allergies</h3>
                  <div className="flex flex-col gap-1.5">
                    {(pet.allergies || []).length > 0 ? (
                      (pet.allergies || []).map((allergy) => (
                        <div
                          key={allergy}
                          className="px-2 py-1 bg-orange-900/40 text-orange-200 border border-orange-700/50 text-xs rounded"
                        >
                          {allergy.replace(/-/g, ' ')}
                        </div>
                      ))
                    ) : (
                      <div className="px-2 py-1 text-gray-500 text-xs italic">
                        None
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {engineError && (
                <p className="mt-4 text-sm text-amber-200 bg-amber-900/30 border border-amber-700/50 px-3 py-2 rounded-lg">
                  {engineError}
                </p>
              )}
            </div>

            {/* Far Right: Number of Meals Found (Larger) */}
            <div className="flex-shrink-0 text-right">
              <div className="text-5xl font-bold text-orange-500">
                {displayCount}{isCounting && <span className="text-3xl">+</span>}
              </div>
              <div className="text-sm text-gray-400 mt-1">
                meals found
                {isCounting && (
                  <span className="text-xs ml-2 text-gray-500">(still searching...)</span>
                )}
              </div>
              {countSubtext && !isCounting && (
                <div className="text-xs text-gray-500 mt-1 max-w-[120px]">
                  {countSubtext}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Show progress indicator while scoring */}
        {isScoring && (
          <ScoringProgress
            progress={progress}
            totalMeals={totalMealsToScore}
            scoredCount={scoredCount}
          />
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {(() => {
            // FINAL SAFETY CHECK: Sort one more time right before rendering to ensure highest to lowest
            const finalRendered = [...sortedMealsToRender].sort((a: any, b: any) => {
              const aScore = ('score' in a && typeof a.score === 'number') ? a.score : 0;
              const bScore = ('score' in b && typeof b.score === 'number') ? b.score : 0;
              return bScore - aScore; // Descending order (highest first)
            });
            return finalRendered;
          })().map((meal) => {
            const recipe = meal.recipe;
            const explanation = meal.explanation;
            const recipeId = recipe.id;
            return (
            <div
              key={recipeId}
              className="relative group"
              onMouseEnter={() => setHoveredRecipe(recipeId)}
              onMouseLeave={() => setHoveredRecipe(null)}
            >
              <Link 
                href={`/recipe/${recipeId}?petId=${petId}`}
                onClick={() => {
                  // Store recipe in session storage for dynamically generated recipes
                  if (typeof window !== 'undefined') {
                    sessionStorage.setItem(`recipe_${recipeId}`, JSON.stringify(recipe));
                  }
                }}
              >
                <div className="bg-surface rounded-lg shadow-md border border-surface-highlight overflow-hidden cursor-pointer hover:shadow-xl hover:border-orange-500/30 hover:-translate-y-1 hover:scale-[1.02] transition-all duration-200 ease-out h-full flex flex-col">
                  <div className="p-6 flex-1 flex flex-col">
                    <div className="mb-3">
                      <h3 className="text-xl font-bold text-foreground text-center">
                        {recipe.name}
                      </h3>
                      {/* Compatibility Rating - Centered under meal name */}
                      {enhancedPet && (
                        <div className="mt-2 flex justify-center">
                          <CompatibilityBadge
                            score={
                              'score' in meal && typeof meal.score === 'number'
                                ? meal.score
                                : (() => {
                                    if (!enhancedPet) return 0;
                                    const enhanced = calculateEnhancedCompatibility(recipe, enhancedPet);
                                    return enhanced.overallScore;
                                  })()
                            }
                          />
                        </div>
                      )}
                    </div>
                    <p className="text-gray-300 text-sm mb-4 flex-1 text-center">
                      {recipe.description}
                    </p>
                    {explanation && (
                      <p className="text-sm text-gray-300 bg-surface-highlight rounded-lg p-3 mb-3 border border-white/5">
                        {explanation}
                      </p>
                    )}
                  </div>
                  <div className="px-6 pb-4 pt-2 border-t border-surface-highlight">
                    {(() => {
                      const isSaved = savedRecipeIds.has(recipeId);
                      return (
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            handleSaveRecipe(recipeId, recipe.name);
                          }}
                          disabled={isSaved}
                          className={`w-full px-4 py-2 rounded-md shadow-md transition-colors flex items-center justify-center gap-2 text-sm font-semibold ${
                            isSaved
                              ? 'bg-green-600 text-white cursor-not-allowed'
                              : 'bg-green-800 text-white hover:bg-green-900'
                          }`}
                        >
                          {isSaved ? '‚úì Added to Saved Meals' : (
                            <>
                              <Plus className="h-4 w-4" /> Add Meal
                            </>
                          )}
                        </button>
                      );
                    })()}
                  </div>
                </div>
              </Link>
            </div>
          )})}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/recipe-builder/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import {
  ChevronLeft,
  X
} from 'lucide-react';
import { generateCustomMealAnalysis } from '@/lib/analyzeCustomMeal';
import { INGREDIENT_COMPOSITIONS } from '@/lib/data/ingredientCompositions';
import { type IngredientSelection, type MealAnalysis } from '@/lib/analyzeCustomMeal';
import { getIngredientsForSpecies, mapIngredientToCompositionKey, ALL_INGREDIENTS, getIngredientDisplayName } from '@/lib/utils/allIngredients';
import { generateIngredientSuggestions } from '@/lib/utils/ingredientSuggestions';
import { getWhitelistForSpecies, isWhitelisted, getSpeciesCoverageLevel, getBlacklistForSpecies } from '@/lib/utils/ingredientWhitelists';
import IngredientPicker from '@/components/IngredientPicker';
import MealCompositionList from '@/components/MealCompositionList';
import CompatibilityPanel from '@/components/CompatibilityPanel';
import SuggestedIngredients from '@/components/SuggestedIngredients';
import MealBuilderWizard from '@/components/MealBuilderWizard';
import MealCompleteView from '@/components/MealCompleteView';
import { getPets } from '@/lib/utils/petStorage'; // Import async storage

// Style mapping for severity levels
const severityStyles = {
  critical: 'bg-red-50 border-red-200 text-red-800',
  major: 'bg-red-50 border-red-200 text-red-700',
  moderate: 'bg-orange-50 border-orange-200 text-orange-700',
};

const getSeverityIcon = (severity: string) => {
  switch (severity) {
    case 'critical':
      return <span className="text-red-600">‚ö†Ô∏è</span>;
    case 'major':
      return <span className="text-red-600">‚ö†Ô∏è</span>;
    default:
      return <span className="text-orange-600">‚ÑπÔ∏è</span>;
  }
};

const getProgressGradientColor = (score: number) => {
  if (score === 0) return '#dc2626'; // red-600
  if (score <= 10) return '#dc2626'; // red-600
  if (score <= 20) return '#ea580c'; // orange-600
  if (score <= 30) return '#d97706'; // amber-600
  if (score <= 40) return '#ca8a04'; // yellow-600
  if (score <= 50) return '#a3a3a3'; // gray-400 (neutral)
  if (score <= 60) return '#84cc16'; // lime-500
  if (score <= 70) return '#65a30d'; // lime-700
  if (score <= 80) return '#16a34a'; // green-600
  if (score <= 90) return '#15803d'; // green-700
  return '#166534'; // green-800
};

interface Pet {
  id: string;
  names: string[];
  type: string;
  breed: string;
  age: string;
  weight: string;
  healthConcerns?: string[];
  dietaryRestrictions?: string[];
  allergies?: string[];
  dislikes?: string[];
  image?: string;
  savedRecipes?: string[];
  weightKg?: number;
}

// Species-appropriate ingredient categories
const SPECIES_INGREDIENT_FILTERS = {
  dogs: {
    allowed: ['chicken_breast', 'ground_turkey', 'chicken_thighs', 'turkey_breast', 'chicken_liver', 'chicken_hearts',
              'salmon_atlantic', 'sardines_water', 'tuna_water',
              'ground_beef_lean', 'beef_liver',
              'eggs_whole',
              'kale_raw', 'spinach_raw', 'carrots_raw', 'sweet_potato', 'broccoli_raw',
              'blueberries_raw', 'bananas_raw',
              'brown_rice_cooked', 'oats', 'quinoa_cooked',
              'fish_oil'], // Meat-focused with some veggies
    disallowed: ['taurine_powder'], // Dogs can synthesize taurine
  },
  cats: {
    allowed: ['chicken_breast', 'ground_turkey', 'turkey_breast', 'chicken_liver', 'chicken_hearts',
              'salmon_atlantic', 'sardines_water', 'tuna_water',
              'eggs_whole',
              'brown_rice_cooked', 'quinoa_cooked',
              'taurine_powder', 'fish_oil'], // Taurine essential for cats, very meat-focused
    disallowed: ['ground_beef_lean', 'beef_liver'], // Many cats allergic/intolerant to beef
  },
  reptiles: {
    allowed: ['kale_raw', 'spinach_raw', 'carrots_raw', 'sweet_potato', 'broccoli_raw', 'celery_raw',
              'blueberries_raw', 'bananas_raw', 'eggs_whole',
              'calcium_carbonate'], // Vegetables and calcium (reptiles are often herbivores/omnivores)
    // Reptiles should use insects like crickets, dubia, etc. but those aren't in our current DB
    disallowed: ['chicken_breast', 'ground_turkey', 'ground_beef_lean', 'beef_liver', 'chicken_liver'],
  },
  birds: {
    allowed: [
      // Protein sources
      'eggs_whole', 'egg (hard-boiled)',
      // Seeds (protein sources for birds)
      'millet (white/red)', 'canary seed', 'niger seed', 'hemp seeds', 'flaxseeds',
      'sesame seeds', 'chia seeds', 'sunflower seeds (small amounts)', 'pumpkin seeds',
      'safflower seeds', 'nyjer seeds', 'amaranth seeds', 'wild bird mix',
      // Insects (for some bird species)
      'crickets', 'mealworms', 'superworms', 'black soldier fly larvae', 'hornworms',
      'dubia roaches', 'pinhead crickets',
      // Cooked lean meats (small amounts for some birds)
      'turkey_breast', 'chicken_breast',
      // Fruits, grains, vegetables, calcium
      'blueberries_raw', 'bananas_raw',
      'brown_rice_cooked', 'oats', 'quinoa_cooked',
      'kale_raw', 'spinach_raw', 'carrots_raw', 'broccoli_raw',
      'calcium_carbonate'
    ],
    disallowed: ['ground_beef_lean', 'beef_liver', 'chicken_liver'], // Raw meat not ideal for birds
  },
  'pocket-pets': {
    allowed: ['oats', 'quinoa_cooked', 'brown_rice_cooked',
              'kale_raw', 'spinach_raw', 'carrots_raw', 'broccoli_raw', 'celery_raw',
              'blueberries_raw', 'bananas_raw',
              'calcium_carbonate'], // Hay/pellet substitutes, veggies, fruits, calcium
    disallowed: ['chicken_breast', 'ground_turkey', 'ground_beef_lean', 'beef_liver', 'salmon_atlantic'],
  },
};

// Normalize pet type to match ALL_INGREDIENTS keys
const normalizeSpecies = (species: string): string => {
  const mapping: Record<string, string> = {
    'dog': 'dogs',
    'cat': 'cats',
    'bird': 'birds',
    'reptile': 'reptiles',
    'pocket-pet': 'pocket-pets',
    'dogs': 'dogs',
    'cats': 'cats',
    'birds': 'birds',
    'reptiles': 'reptiles',
    'pocket-pets': 'pocket-pets'
  };
  return mapping[species.toLowerCase()] || species;
};

// Get filtered ingredients based on pet species - ONLY show species-specific ingredients
const getAvailableIngredients = (species: string, bannedIngredients?: string[]): string[] => {
  const normalizedSpecies = normalizeSpecies(species);
  const filters = SPECIES_INGREDIENT_FILTERS[normalizedSpecies as keyof typeof SPECIES_INGREDIENT_FILTERS];

  // Get species-specific ingredients from scraped data (generate-recipes.js INGREDIENTS object)
  // This contains all the AAFCO and research-based ingredients for this species
  const scrapedIngredients = getIngredientsForSpecies(normalizedSpecies);
  
  // Return ALL scraped ingredient names - don't filter by composition key mapping
  // The composition keys will be looked up when needed for nutritional analysis
  const allIngredientNames = new Set<string>(scrapedIngredients);
  
  // Also include composition keys that are commonly used across species (universal ingredients)
  // but only if they're not explicitly disallowed
  const universalIngredients = [
    'eggs_whole', 'carrots_raw', 'broccoli_raw', 'spinach_raw', 
    'kale_raw', 'celery_raw', 'blueberries_raw', 'bananas_raw',
    'brown_rice_cooked', 'quinoa_cooked', 'sweet_potato', 'oats',
    'fish_oil', 'calcium_carbonate'
  ];
  
  universalIngredients.forEach(key => {
    if (!filters?.disallowed?.includes(key)) {
      // Convert composition key to readable name and add
      const displayName = key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      allIngredientNames.add(displayName);
    }
  });
  
  // Return all ingredient names (scraped names + universal ingredients)
  const mappedKeys = Array.from(allIngredientNames);

  let filtered = mappedKeys;
  
  if (filters) {
    // Filter out disallowed items
    filtered = filtered.filter(ing => !filters.disallowed?.includes(ing));
  }
  
  // Filter out banned ingredients (case-insensitive partial match)
  if (bannedIngredients && bannedIngredients.length > 0) {
    const bannedLower = bannedIngredients.map(b => b.toLowerCase());
    filtered = filtered.filter(ing => {
      const ingLower = ing.toLowerCase();
      return !bannedLower.some(banned => ingLower.includes(banned) || banned.includes(ingLower));
    });
  }

  return Array.from(filtered).sort();
};

// Categorize ingredients
const getCategorizedIngredients = (availableIngredients: string[], species: string) => {
  const normalizedSpecies = normalizeSpecies(species);
  const categories = {
    proteins: {
      name: 'Proteins',
      description: 'Main protein source',
      maxSelections: 999, // No limit - let users experiment
      icon: 'ü•©',
      ingredients: [] as string[]
    },
    greens: {
      name: 'Greens & Veggies',
      description: 'Vitamins and fiber',
      maxSelections: 999,
      icon: 'ü•¨',
      ingredients: [] as string[]
    },
    fruits: {
      name: 'Fruits',
      description: 'Natural sweetness and nutrients',
      maxSelections: 999,
      icon: 'üçé',
      ingredients: [] as string[]
    },
    grains: {
      name: 'Grains & Carbs',
      description: 'Energy source',
      maxSelections: 999,
      icon: 'üåæ',
      ingredients: [] as string[]
    },
    supplements: {
      name: 'Supplements',
      description: 'Essential nutrients',
      maxSelections: 999,
      icon: 'üíä',
      ingredients: [] as string[]
    }
  };

  // Special handling for cats (taurine is specifically marked as essential but can be added to supplements)
  if (normalizedSpecies === 'cats') {
    categories.supplements.description = 'Essential nutrients (taurine recommended)';
  }

  // Special handling for reptiles/herbivores (calcium is essential)
  if (['reptiles', 'pocket-pets'].includes(normalizedSpecies)) {
    categories.supplements.description = 'Essential minerals (calcium recommended)';
  }

  // Get species-specific ingredient categories from scraped data
  const speciesData = ALL_INGREDIENTS[normalizedSpecies as keyof typeof ALL_INGREDIENTS];
  
  if (speciesData) {
    // Map scraped ingredients to composition keys and categorize by species-specific categories
    Object.entries(speciesData).forEach(([categoryName, ingredientList]) => {
      if (Array.isArray(ingredientList)) {
        ingredientList.forEach(ingName => {
          // Use the ingredient name directly (not the composition key) for display
          // Only add if it's in availableIngredients (species-filtered)
          if (availableIngredients.includes(ingName)) {
            // Map category names to our 5 categories based on species
            // Use ingredient name directly (not composition key) for display
            if (categoryName === 'proteins' || categoryName === 'insects' || 
                (normalizedSpecies === 'birds' && categoryName === 'seeds')) {
              // For birds, seeds are protein sources
              if (!categories.proteins.ingredients.includes(ingName)) {
                categories.proteins.ingredients.push(ingName);
              }
            } else if (categoryName === 'vegetables' || categoryName === 'hay') {
              if (!categories.greens.ingredients.includes(ingName)) {
                categories.greens.ingredients.push(ingName);
              }
            } else if (categoryName === 'fruits') {
              if (!categories.fruits.ingredients.includes(ingName)) {
                categories.fruits.ingredients.push(ingName);
              }
            } else if (categoryName === 'carbs' || categoryName === 'seeds' || categoryName === 'pellets' || categoryName === 'hamster_additions') {
              // Seeds go to grains for non-bird species
              if (!categories.grains.ingredients.includes(ingName)) {
                categories.grains.ingredients.push(ingName);
              }
            } else if (categoryName === 'fats' || categoryName === 'fiber_supplements' || categoryName === 'supplements') {
              if (!categories.supplements.ingredients.includes(ingName)) {
                categories.supplements.ingredients.push(ingName);
              }
            }
          }
        });
      }
    });
  }
  
  // Also categorize any remaining ingredients that weren't in scraped data
  availableIngredients.forEach(ingName => {
    // Skip if already categorized
    const allCategorized = [
      ...categories.proteins.ingredients,
      ...categories.greens.ingredients,
      ...categories.fruits.ingredients,
      ...categories.grains.ingredients,
      ...categories.supplements.ingredients
    ];
    if (allCategorized.includes(ingName)) return;
    
    const keyLower = ingName.toLowerCase();
    
    // Proteins: meat, fish, eggs, insects
    if (keyLower.includes('chicken') || keyLower.includes('turkey') || 
        keyLower.includes('beef') || keyLower.includes('liver') || 
        keyLower.includes('hearts') || keyLower.includes('salmon') || 
        keyLower.includes('tuna') || keyLower.includes('sardines') ||
        keyLower.includes('duck') || keyLower.includes('venison') ||
        keyLower.includes('rabbit') || keyLower.includes('quail') ||
        keyLower.includes('pork') || keyLower.includes('giblets') ||
        keyLower.includes('eggs') || keyLower.includes('egg') ||
        keyLower.includes('cricket') || keyLower.includes('roach') ||
        keyLower.includes('worm') || keyLower.includes('insect')) {
      categories.proteins.ingredients.push(ingName);
    } 
    // Greens & Vegetables
    else if (keyLower.includes('kale') || keyLower.includes('spinach') || 
             keyLower.includes('carrot') || keyLower.includes('broccoli') || 
             keyLower.includes('celery') || keyLower.includes('bok') ||
             keyLower.includes('choy') || keyLower.includes('green bean') ||
             keyLower.includes('peas') || keyLower.includes('zucchini') ||
             keyLower.includes('brussels') || keyLower.includes('asparagus') ||
             keyLower.includes('cucumber') || keyLower.includes('lettuce') ||
             keyLower.includes('cabbage') || keyLower.includes('cauliflower') ||
             keyLower.includes('hay')) {
      categories.greens.ingredients.push(ingName);
    } 
    // Fruits
    else if (keyLower.includes('blueberr') || keyLower.includes('banana') ||
             keyLower.includes('apple') || keyLower.includes('berry') ||
             keyLower.includes('mango') || keyLower.includes('papaya') ||
             keyLower.includes('strawberr') || keyLower.includes('grape')) {
      categories.fruits.ingredients.push(ingName);
    } 
    // Grains & Carbs
    else if (keyLower.includes('rice') || keyLower.includes('quinoa') || 
             keyLower.includes('oats') || keyLower.includes('barley') ||
             keyLower.includes('sweet potato') || keyLower.includes('potato') ||
             keyLower.includes('pumpkin') || keyLower.includes('squash') ||
             keyLower.includes('lentil') || keyLower.includes('bean') ||
             keyLower.includes('chickpea') || keyLower.includes('grain') ||
             keyLower.includes('amaranth') || keyLower.includes('buckwheat') ||
             keyLower.includes('millet') || keyLower.includes('sorghum') ||
             keyLower.includes('farro') || keyLower.includes('bulgur') ||
             keyLower.includes('seed') || keyLower.includes('pellet')) {
      categories.grains.ingredients.push(ingName);
    } 
    // Supplements
    else if (keyLower.includes('oil') || keyLower.includes('calcium') || 
             keyLower.includes('taurine') || keyLower.includes('supplement') ||
             keyLower.includes('vitamin') || keyLower.includes('probiotic') ||
             keyLower.includes('psyllium') || keyLower.includes('joint')) {
      categories.supplements.ingredients.push(ingName);
    }
    // Default: add to greens if not categorized
    else {
      categories.greens.ingredients.push(ingName);
    }
  });

  return categories;
};

export default function RecipeBuilderPage() {
  const params = useParams();
  const router = useRouter();
  const petId = params.id as string;

  const [pet, setPet] = useState<Pet | null>(null);
  const [selectedIngredients, setSelectedIngredients] = useState<IngredientSelection[]>([]);
  const [analysis, setAnalysis] = useState<MealAnalysis | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showWizard, setShowWizard] = useState(false);
  const [wizardCompleted, setWizardCompleted] = useState(false);
  const [showAddMore, setShowAddMore] = useState(false);
  const [hasAppliedRecommended, setHasAppliedRecommended] = useState(false);
  const [isFirstCreation, setIsFirstCreation] = useState(false); // Track if this is the first creation
  const [recommendedMeals, setRecommendedMeals] = useState<any[]>([]); // Store recommended meals

  // Get species-appropriate ingredients and categories
  const normalizedSpeciesType = pet ? normalizeSpecies(pet.type) : null;
  const speciesCoverageLevel = normalizedSpeciesType ? getSpeciesCoverageLevel(normalizedSpeciesType as any) : 'limited';
  const blacklist = normalizedSpeciesType ? getBlacklistForSpecies(normalizedSpeciesType as any) : [];
  
  // Filter available ingredients through whitelist
  const allAvailableIngredients = pet ? getAvailableIngredients(pet.type, (pet as any).bannedIngredients) : [];
  const whitelist = normalizedSpeciesType ? getWhitelistForSpecies(normalizedSpeciesType as any) : [];
  const availableIngredients = whitelist.length > 0 
    ? allAvailableIngredients.filter(ing => isWhitelisted(ing, normalizedSpeciesType as any))
    : allAvailableIngredients; // Fallback to all if no whitelist data
  
  const categorizedIngredients = pet ? getCategorizedIngredients(availableIngredients, pet.type) : null;
  
  // Generate base suggestions from static rules
  const baseSuggestedIngredients = pet ? generateIngredientSuggestions({
    type: pet.type,
    age: pet.age,
    healthConcerns: pet.healthConcerns || [],
    breed: pet.breed
  }) : [];
  
  // Extract ingredients from recommended meals and merge with base suggestions
  const suggestedIngredients = (() => {
    if (!pet || recommendedMeals.length === 0) {
      return baseSuggestedIngredients;
    }
    
    // Extract unique ingredients from top 5 recommended meals
    const ingredientsFromMeals = new Map<string, { name: string; reason: string; category: string; fromMeal: boolean }>();
    
    recommendedMeals.slice(0, 5).forEach((meal: any) => {
      const mealIngredients = meal.recipe?.ingredients || meal.adjustedIngredients || [];
      mealIngredients.forEach((ing: any) => {
        const ingName = ing.name || ing.productName || '';
        if (ingName && !ingredientsFromMeals.has(ingName)) {
          // Try to categorize the ingredient
          const nameLower = ingName.toLowerCase();
          let category = 'Other';
          if (nameLower.includes('liver') || nameLower.includes('heart') || nameLower.includes('chicken') || 
              nameLower.includes('turkey') || nameLower.includes('duck') || nameLower.includes('salmon') ||
              nameLower.includes('beef') || nameLower.includes('fish') || nameLower.includes('meat')) {
            category = 'Proteins';
          } else if (nameLower.includes('squash') || nameLower.includes('greens') || nameLower.includes('kale') ||
                     nameLower.includes('spinach') || nameLower.includes('carrot') || nameLower.includes('broccoli') ||
                     nameLower.includes('dandelion') || nameLower.includes('vegetable')) {
            category = 'Greens & Veggies';
          } else if (nameLower.includes('rice') || nameLower.includes('quinoa') || nameLower.includes('oats') ||
                     nameLower.includes('grain') || nameLower.includes('carb')) {
            category = 'Grains & Carbs';
          } else if (nameLower.includes('oil') || nameLower.includes('supplement') || nameLower.includes('powder') ||
                     nameLower.includes('currant') || nameLower.includes('vitamin')) {
            category = 'Supplements';
          } else if (nameLower.includes('berry') || nameLower.includes('apple') || nameLower.includes('banana') ||
                     nameLower.includes('fruit')) {
            category = 'Fruits';
          }
          
          ingredientsFromMeals.set(ingName, {
            name: ingName,
            reason: `Found in your top recommended meals - ${meal.recipe?.name || 'recommended meal'}`,
            category,
            fromMeal: true
          });
        }
      });
    });
    
    // Merge with base suggestions, prioritizing ingredients from meals
    const merged = new Map<string, { name: string; reason: string; category: string }>();
    
    // First add ingredients from recommended meals (higher priority)
    ingredientsFromMeals.forEach((ing) => {
      merged.set(ing.name, { name: ing.name, reason: ing.reason, category: ing.category });
    });
    
    // Then add base suggestions (if not already present)
    baseSuggestedIngredients.forEach((ing) => {
      if (!merged.has(ing.name)) {
        merged.set(ing.name, ing);
      }
    });
    
    return Array.from(merged.values()).slice(0, 12); // Limit to 12 total suggestions
  })();
  
  // Extract recommended ingredient names for wizard
  const recommendedIngredientNames = suggestedIngredients.map(s => s.name);
  
  // Debug logging (remove in production)
  useEffect(() => {
    if (pet && availableIngredients.length > 0) {
      // Debug logging removed for production
    }
  }, [pet, availableIngredients.length, categorizedIngredients]);

  // Load pet data and fetch recommended meals
  useEffect(() => {
    const loadPetData = async () => {
      if (typeof window !== 'undefined') {
        const userId = localStorage.getItem('last_user_id') || 'clerk_simulated_user_id_123';
        
        try {
          const pets = await getPets(userId);
          const foundPet = pets.find((p: any) => p.id === petId);
          
          if (foundPet) {
            setPet(foundPet as unknown as Pet);
            // Show wizard on initial load if no ingredients selected
            if (selectedIngredients.length === 0 && !wizardCompleted) {
              setShowWizard(true);
            }
            
            // Fetch recommended meals... (rest of logic)
            const concerns = (foundPet.healthConcerns || []).filter((concern: string) => concern !== 'none');
            const allergies = (foundPet as any).allergies?.filter((allergy: string) => allergy !== 'none') || [];
            // Use random name from pet's names array
            const petNames = Array.isArray(foundPet.names) ? foundPet.names.filter((n: string) => n && n.trim() !== '') : [];
            const petDisplayName = petNames.length > 0 
              ? petNames[Math.floor(Math.random() * petNames.length)]
              : 'Your Pet';
            
            try {
              const response = await fetch('/api/recommendations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  profile: {
                    species: foundPet.type,
                    ageGroup: foundPet.age,
                    breed: foundPet.breed,
                    weightKg: parseFloat(foundPet.weight?.replace(/[^0-9.]/g, '') || '10'),
                    healthConcerns: concerns,
                    allergies,
                    petName: petDisplayName,
                  },
                  limit: 5, // Only need top 5 for ingredient extraction
                }),
              });

              if (response.ok) {
                const data = await response.json();
                if (data?.results && Array.isArray(data.results)) {
                  setRecommendedMeals(data.results);
                }
              }
            } catch (error) {
              // Failed to fetch recommended meals
            }
          }
        } catch (error) {
          console.error("Error loading pet:", error);
        }
      }
    };

    loadPetData();
  }, [petId]);

  // Handle wizard completion
  const handleWizardComplete = (selections: { [category: string]: string[] }) => {
    // Convert wizard selections to IngredientSelection format
    const ingredients: IngredientSelection[] = [];
    
    Object.entries(selections).forEach(([category, ingredientNames]) => {
      if (ingredientNames && ingredientNames.length > 0) {
        // Start with a reasonable default based on category
        let defaultGrams = 50;
        if (category === 'proteins') defaultGrams = 100; // More protein
        else if (category === 'grains') defaultGrams = 60;
        else if (category === 'greens') defaultGrams = 40;
        else if (category === 'fruits') defaultGrams = 20;
        else if (category === 'supplements') defaultGrams = 5;
        
        // Add all selected ingredients from this category
        ingredientNames.forEach(ingredientName => {
          ingredients.push({
            key: ingredientName,
            grams: defaultGrams
          });
        });
      }
    });

    setSelectedIngredients(ingredients);
    setWizardCompleted(true);
    setShowWizard(false);
    setIsFirstCreation(true); // Mark as first creation to show popup
    
    // Analysis will be triggered automatically by the useEffect when ingredients change
    // After analysis completes, we can update to recommended amounts
  };

  // Handle start over
  const handleStartOver = () => {
    setSelectedIngredients([]);
    setAnalysis(null);
    setWizardCompleted(false);
    setShowWizard(true);
    setShowAddMore(false);
    setHasAppliedRecommended(false);
    setIsFirstCreation(false); // Reset first creation flag
  };

  // Handle add more ingredients
  const handleAddMore = () => {
    setShowAddMore(true);
  };

  // Auto-analyze recipe when ingredients change
  useEffect(() => {
    const analyzeRecipe = async () => {
      if (selectedIngredients.length > 0 && pet) {
        setIsAnalyzing(true);
        try {
          const petProfile = {
            id: pet.id,
            name: pet.names[0] || 'Pet',
            species: pet.type as any,
            lifeStage: pet.age as any, // Maps to 'adult', 'juvenile', etc.
            weightKg: parseFloat(pet.weight?.replace(/[^0-9.]/g, '')) || 5,
            allergies: [],
            activity: 'moderate' as const, // Default activity level
          };

          // Map ingredient display names to composition keys for analysis
          const mappedIngredients = selectedIngredients.map(sel => {
            const compositionKey = mapIngredientToCompositionKey(sel.key) || sel.key.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            return {
              key: compositionKey,
              grams: sel.grams
            };
          });
          
          const result = generateCustomMealAnalysis(petProfile, mappedIngredients);
          setAnalysis(result);
          
          // After first analysis from wizard, auto-apply recommended amounts once
          if (result.recommendedServingGrams > 0 && selectedIngredients.length > 0 && wizardCompleted && !hasAppliedRecommended) {
            const currentTotal = selectedIngredients.reduce((sum, s) => sum + s.grams, 0);
            if (currentTotal > 0) {
              const recommendedTotal = result.recommendedServingGrams;
              const updatedIngredients = selectedIngredients.map(ing => {
                const ratio = ing.grams / currentTotal;
                return {
                  ...ing,
                  grams: Math.round(recommendedTotal * ratio)
                };
              });
              setSelectedIngredients(updatedIngredients);
              setHasAppliedRecommended(true);
            }
          }
        } catch (error) {
          // Analysis error - handled by error state
        } finally {
          setIsAnalyzing(false);
        }
      } else {
        setAnalysis(null);
      }
    };

    const debounceTimer = setTimeout(analyzeRecipe, 500);
    return () => clearTimeout(debounceTimer);
  }, [selectedIngredients, pet]);

  const addIngredient = (ingredientKey: string) => {
    // Check if ingredient is whitelisted for this species
    if (normalizedSpeciesType && whitelist.length > 0) {
      // ingredientKey might be a display name already, try both
      const displayName = ingredientKey; // Assume it's already a display name from the picker
      if (!isWhitelisted(displayName, normalizedSpeciesType as any)) {
        // Show warning but allow (user can override with vet approval)
        const confirmed = window.confirm(
          `${displayName} is not in the recommended whitelist for ${pet?.type}.\n\n` +
          `This ingredient may not be safe for this species. Please check with your vet before using.\n\n` +
          `Do you want to add it anyway?`
        );
        if (!confirmed) return;
      }
    }
    
    const existing = selectedIngredients.find(s => s.key === ingredientKey);
    if (existing) {
      setSelectedIngredients(prev =>
        prev.map(s =>
          s.key === ingredientKey
            ? { ...s, grams: s.grams + 50 }
            : s
        )
      );
    } else {
      setSelectedIngredients(prev => [...prev, { key: ingredientKey, grams: 50 }]);
    }
  };

  const removeIngredient = (ingredientKey: string) => {
    setSelectedIngredients(prev => prev.filter(s => s.key !== ingredientKey));
  };

  const updateIngredientGrams = (ingredientKey: string, grams: number) => {
    if (grams <= 0) {
      removeIngredient(ingredientKey);
      return;
    }

    setSelectedIngredients(prev =>
      prev.map(s =>
        s.key === ingredientKey
          ? { ...s, grams: Math.round(grams) }
          : s
      )
    );
  };

  const totalGrams = selectedIngredients.reduce((sum, s) => sum + s.grams, 0);

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#0f2c0f' }}>
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-400"></div>
        <span className="ml-3 text-gray-300">Loading pet data...</span>
      </div>
    );
  }

  // Prepare categories for wizard
  const proteinRequired = !['pocket-pets', 'reptiles'].includes((normalizedSpeciesType || '').toLowerCase());

  const wizardCategories = categorizedIngredients ? {
    proteins: {
      ...categorizedIngredients.proteins,
      required: proteinRequired && categorizedIngredients.proteins.ingredients.length > 0
    },
    grains: {
      ...categorizedIngredients.grains,
      required: false
    },
    greens: {
      ...categorizedIngredients.greens,
      required: false
    },
    fruits: {
      ...categorizedIngredients.fruits,
      required: false
    },
    supplements: {
      ...categorizedIngredients.supplements,
      required: false
    }
  } : null;

  // Show wizard if not completed and no ingredients
  if (showWizard && wizardCategories) {
    return (
      <>
        {/* Species Coverage Badge */}
        {normalizedSpeciesType && (
          <div className="border-b px-4 py-2" style={{ backgroundColor: '#1a3d2e', borderColor: '#2d5a47' }}>
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-300">Ingredient Coverage:</span>
                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                  speciesCoverageLevel === 'full' ? 'bg-green-100 text-green-800' :
                  speciesCoverageLevel === 'beta' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-800'
                }`}>
                  {speciesCoverageLevel === 'full' ? '‚úì Full Coverage' :
                   speciesCoverageLevel === 'beta' ? 'Œ≤ Beta (Expanding)' :
                   '‚ö† Limited Data'}
                </span>
                {blacklist.length > 0 && (
                  <span className="text-xs text-gray-500">
                    ({blacklist.length} ingredients to avoid)
                  </span>
                )}
              </div>
            </div>
          </div>
        )}
        <MealBuilderWizard
          isOpen={showWizard}
          onClose={() => setShowWizard(false)}
          onComplete={handleWizardComplete}
          categories={wizardCategories}
          petName={pet.names[0] || 'Pet'}
          petType={normalizedSpeciesType || pet.type}
          recommendedIngredients={recommendedIngredientNames}
        />
        <div className="min-h-screen" style={{ backgroundColor: '#0f2c0f' }} />
      </>
    );
  }

  // Show meal complete view after wizard or if ingredients exist
  if (wizardCompleted || selectedIngredients.length > 0) {
    return (
      <>
        <MealCompleteView
          petName={pet.names[0] || 'Pet'}
          petBreed={pet.breed}
          petAge={pet.age}
          petWeight={pet.weight}
          petId={petId}
          userId={localStorage.getItem('last_user_id') || 'clerk_simulated_user_id_123'}
          selectedIngredients={selectedIngredients}
          analysis={analysis}
          isAnalyzing={isAnalyzing}
          onUpdateAmount={updateIngredientGrams}
          onRemove={removeIngredient}
          onAddMore={handleAddMore}
          onStartOver={handleStartOver}
          petType={pet.type}
          getIngredientDisplayName={(key) => {
            // Normalize key to match vetted products
            const normalized = key
              .toLowerCase()
              .replace(/_/g, ' ')      // chicken_breast ‚Üí chicken breast
              .replace(/-/g, ' ')      // chicken-breast ‚Üí chicken breast
              .trim();
            
            // Try to find display name in vetted products
            const product = require('@/lib/data/vetted-products').getVettedProduct(normalized);
            return product?.productName || normalized;
          }}
          isFirstCreation={isFirstCreation}
          getCompatibilityIndicator={(key) => {
            if (!analysis) return null;
            const hasToxicityWarning = analysis.toxicityWarnings.some(w => 
              w.ingredientKey === key || (w.ingredientName && w.ingredientName.toLowerCase().includes(key.toLowerCase()))
            );
            if (hasToxicityWarning) return 'blocked';
            const hasAllergyWarning = analysis.allergyWarnings.some(w => 
              (typeof w === 'string' ? w : w.message).toLowerCase().includes(key.toLowerCase())
            );
            if (hasAllergyWarning) return 'warning';
            return 'safe';
          }}
        />

        {/* Add More Ingredients Modal/View */}
        {showAddMore && categorizedIngredients && (
          <div className="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto">
              <div className="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 className="text-xl font-bold text-gray-100">Add More Ingredients</h2>
                <button
                  onClick={() => setShowAddMore(false)}
                  className="p-2 hover:opacity-80 rounded-full transition-colors"
                  style={{ backgroundColor: '#2d5a47' }}
                >
                  <X size={20} className="text-gray-200" />
                </button>
              </div>
              <div className="p-6">
                {/* Recommended Ingredients Quick Add */}
                {suggestedIngredients.length > 0 && (
                  <div className="mb-6">
                    <div className="flex items-center gap-2 mb-3">
                      <span className="text-sm font-semibold text-gray-200">Recommended Additions:</span>
                      <span className="text-xs text-gray-400">Click to add quickly</span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {suggestedIngredients
                        .filter(sug => !selectedIngredients.some(sel => sel.key === sug.name))
                        .slice(0, 12)
                        .map((suggestion, idx) => {
                          // Check if this ingredient comes from recommended meals
                          const fromMeal = recommendedMeals.some((meal: any) => {
                            const mealIngredients = meal.recipe?.ingredients || meal.adjustedIngredients || [];
                            return mealIngredients.some((ing: any) => 
                              (ing.name || ing.productName || '').toLowerCase() === suggestion.name.toLowerCase()
                            );
                          });
                          
                          return (
                            <button
                              key={idx}
                              onClick={() => {
                                addIngredient(suggestion.name);
                              }}
                              className={`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium transition-opacity ${
                                fromMeal
                                  ? 'bg-green-50 border border-green-300 text-green-900 hover:opacity-80'
                                  : 'bg-blue-50 border border-blue-200 text-blue-900 hover:opacity-80'
                              }`}
                              title={suggestion.reason}
                            >
                              <span>{fromMeal ? '‚ú®' : '‚≠ê'}</span>
                              <span>{suggestion.name}</span>
                              {fromMeal && (
                                <span className="text-xs opacity-75">(from meals)</span>
                              )}
                            </button>
                          );
                        })}
                    </div>
                    {suggestedIngredients.filter(sug => !selectedIngredients.some(sel => sel.key === sug.name)).length === 0 && (
                      <p className="text-xs text-gray-500 italic">All recommended ingredients have been added</p>
                    )}
                  </div>
                )}

                {/* Search Bar */}
                <div className="mb-4">
                  <IngredientPicker
                    ingredients={availableIngredients.map(name => {
                      let category = 'Other';
                      for (const [catKey, cat] of Object.entries(categorizedIngredients)) {
                        if (cat.ingredients.includes(name)) {
                          category = cat.name;
                          break;
                        }
                      }
                      return { name, category };
                    })}
                    categories={categorizedIngredients}
                    onSelect={(ingredientName) => {
                      addIngredient(ingredientName);
                    }}
                    disabled={isAnalyzing}
                  />
                </div>
              </div>
            </div>
          </div>
        )}
      </>
    );
  }

  // Fallback: show original builder (shouldn't reach here normally)
  return (
    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#0f2c0f' }}>
      <div className="text-center">
        <p className="text-gray-300 mb-4">Starting meal builder...</p>
        <button
          onClick={() => setShowWizard(true)}
          className="px-4 py-2 text-white rounded-md hover:opacity-90"
          style={{ backgroundColor: '#16a34a' }}
        >
          Start Wizard
        </button>
      </div>
    </div>
  );
}
</file>

<file path="app/profile/pet/[id]/saved-recipes/page.tsx">
'use client';

import React, { useState, useEffect, useMemo } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { HeartOff, ArrowLeft, Utensils, Clock, Trash2 } from 'lucide-react';
import { getCustomMeals, deleteCustomMeal } from '@/lib/utils/customMealStorage';
import { getPets, savePet } from '@/lib/utils/petStorage'; // Import async storage
import type { CustomMeal, Pet } from '@/lib/types';

// Same simulated user ID setup as profile/page.tsx
const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

const getCurrentUserId = () => {
  if (typeof window === 'undefined') return SIMULATED_USER_ID;
  return localStorage.getItem('last_user_id') || SIMULATED_USER_ID;
};

export default function SavedRecipesPage() {
  const { id: petId } = useParams();
  const router = useRouter();
  const [pet, setPet] = useState<Pet | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [userId, setUserId] = useState<string | null>(null);
  const [customMeals, setCustomMeals] = useState<CustomMeal[]>([]);

  // Load pet and custom meals - async function
  const loadData = async () => {
    const uid = getCurrentUserId();
    setUserId(uid);

    if (!petId) {
      setIsLoading(false);
      return;
    }

    const resolvedPetId = Array.isArray(petId) ? petId[0] : petId;
    
    try {
      // Load pets and find the current pet
      const pets = await getPets(uid);
      const foundPet = pets.find((p) => p.id === resolvedPetId);
      setPet(foundPet || null);
      
      // Load custom meals for this pet
      const meals = await getCustomMeals(uid, resolvedPetId);
      setCustomMeals(meals);
    } catch (error) {
      console.error('Error loading pet data:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Load pet and custom meals from storage
  useEffect(() => {
    loadData();
  }, [petId]);

  // Listen for updates to pets and custom meals
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const handlePetsUpdated = (e: CustomEvent) => {
      // Refresh if pets were updated
      if (e.detail?.userId === getCurrentUserId()) {
        loadData();
      }
    };

    const handleStorageChange = (e: StorageEvent) => {
      // Refresh if pets or custom meals storage was modified (cross-tab/window)
      const uid = getCurrentUserId();
      if (e.key === `pets_${uid}` || e.key?.startsWith(`custom_meals_${uid}_`)) {
        loadData();
      }
    };

    window.addEventListener('petsUpdated', handlePetsUpdated as EventListener);
    window.addEventListener('storage', handleStorageChange);

    return () => {
      window.removeEventListener('petsUpdated', handlePetsUpdated as EventListener);
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [petId]);

  // Map saved recipe IDs and custom meals to display format
  const savedRecipeDetails = useMemo(() => {
    const allMeals: {
      id: string;
      name: string;
      dateAdded?: number;
      isCustom?: boolean;
      compatibilityScore?: number;
    }[] = [];
    
    // Add custom meals (with compatibility score)
    customMeals.forEach((meal) => {
      allMeals.push({
        id: meal.id,
        name: meal.name,
        dateAdded: meal.createdAt ? new Date(meal.createdAt).getTime() : undefined,
        isCustom: true,
        compatibilityScore: meal.analysis?.score,
      });
    });
    
    return allMeals;
  }, [pet, customMeals]);

  const handleRemoveRecipe = async (recipeIdToRemove: string, isCustom: boolean = false) => {
    if (!userId || !pet) return;

    if (isCustom) {
      // Remove custom meal
      await deleteCustomMeal(userId, pet.id, recipeIdToRemove);
      setCustomMeals(prev => prev.filter(m => m.id !== recipeIdToRemove));
    } else {
      // Update the pet's savedRecipes array
      const updatedPet: Pet = {
        ...pet,
        savedRecipes: (pet.savedRecipes || []).filter(id => id !== recipeIdToRemove),
      };

      await savePet(userId, updatedPet);
      setPet(updatedPet);
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <p className="text-xl text-green-800 font-medium">Loading pet profile...</p>
      </div>
    );
  }

  if (!pet) {
    return (
      <div className="max-w-4xl mx-auto py-12 px-4 text-center">
        <HeartOff className="w-16 h-16 text-red-500 mx-auto mb-4" />
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Pet Not Found</h1>
        <p className="text-gray-600">
          We couldn't find a pet with the ID:{' '}
          <span className="font-mono bg-gray-100 p-1 rounded text-sm">{String(petId)}</span>.
        </p>
        <Link
          href="/profile"
          className="mt-6 inline-flex items-center text-green-800 hover:text-green-900 transition-colors font-medium"
        >
          <ArrowLeft className="w-5 h-5 mr-2" /> Back to Pet Profiles
        </Link>
      </div>
    );
  }

  const hasSaved = savedRecipeDetails.length > 0;

  // Get random name from pet's names array
  const petNames = Array.isArray((pet as any).names) ? (pet as any).names.filter((n: string) => n && n.trim() !== '') : [];
  const petDisplayName = petNames.length > 0 
    ? petNames[Math.floor(Math.random() * petNames.length)]
    : (pet.name || 'Your Pet');

  return (
    <div className="min-h-screen bg-gray-50 py-4">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <Link
          href="/profile"
          className="inline-flex items-center text-gray-500 hover:text-green-800 transition-colors mb-3 text-sm"
        >
          <ArrowLeft className="w-4 h-4 mr-1" /> Back to Pet Profiles
        </Link>

        <header className="mb-4 p-3 bg-white rounded-lg shadow border-l-4 border-primary-600">
          <h1 className="text-xl font-bold text-gray-900 flex items-center">
            <Utensils className="w-5 h-5 mr-2 text-primary-600" />
            Saved Meals for {petDisplayName}
          </h1>
          <p className="text-sm text-gray-600 mt-1">
            A curated collection for your <span className="capitalize font-medium">{pet.type}</span>, the {pet.breed}.
          </p>
        </header>

        {hasSaved && (
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
            <p className="text-sm text-gray-600">
              {savedRecipeDetails.length} meals saved for {petDisplayName}.
            </p>
            <button
              onClick={() => router.push(`/profile/pet/${pet.id}/meal-plan`)}
              disabled={savedRecipeDetails.length < 2}
              className={`px-5 py-3 rounded-lg font-semibold transition-colors ${
                savedRecipeDetails.length < 2
                  ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                  : 'bg-green-800 text-white hover:bg-green-900'
              }`}
            >
              Create Meal Plan
            </button>
          </div>
        )}

        <div className="space-y-4">
          {hasSaved ? (
            savedRecipeDetails.map((recipe) => (
              <div
                key={recipe.id}
                className="flex items-center p-4 bg-white rounded-xl shadow hover:shadow-md transition-shadow justify-between"
              >
                <Link
                  href={`/recipe/${recipe.id}?petId=${pet.id}`}
                  className="flex items-center flex-grow group"
                >
                  <div className="ml-0 flex-1">
                    <div className="flex items-center gap-2 flex-wrap">
                      <p className="text-lg font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">
                        {recipe.name}
                      </p>
                      {recipe.isCustom && (
                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-medium">
                          Custom
                        </span>
                      )}
                      {recipe.isCustom && recipe.compatibilityScore !== undefined && (
                        <div className="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-gray-100">
                          <span className="text-xs font-medium text-gray-600">Score:</span>
                          <span className={`text-xs font-bold ${
                            recipe.compatibilityScore >= 80 ? 'text-green-600' :
                            recipe.compatibilityScore >= 60 ? 'text-yellow-600' :
                            'text-red-600'
                          }`}>
                            {recipe.compatibilityScore}
                          </span>
                        </div>
                      )}
                    </div>
                    {recipe.dateAdded && (
                      <div className="flex items-center text-sm text-gray-500 mt-1">
                        <Clock className="w-3 h-3 mr-1" />
                        <span>
                          Saved: {new Date(recipe.dateAdded).toLocaleDateString()}
                        </span>
                      </div>
                    )}
                  </div>
                </Link>

                <button
                  onClick={() => handleRemoveRecipe(recipe.id, recipe.isCustom)}
                  className="ml-4 p-2 text-red-500 hover:bg-red-50 rounded-full transition-colors"
                  aria-label={`Remove ${recipe.name}`}
                >
                  <Trash2 className="w-5 h-5" />
                </button>
              </div>
            ))
          ) : (
            <div className="text-center p-10 bg-white rounded-xl shadow-inner border border-gray-200">
              <HeartOff className="w-12 h-12 text-gray-400 mx-auto mb-3" />
              <p className="text-xl font-medium text-gray-700">No Saved Meals Yet!</p>
              <p className="text-gray-500 mt-2">
                Start by browsing our catalog to find the perfect meal for {petDisplayName}.
              </p>
              <Link
                href={`/profile/pet/${pet.id}`}
                className="mt-4 inline-block px-6 py-2 bg-green-800 text-white rounded-lg hover:bg-green-900 transition-colors font-medium shadow-md"
              >
                Find Meals
              </Link>
            </div>
          )}
        </div>
      </div>

      <p className="fixed bottom-4 right-4 text-xs text-gray-400">
        Current User ID: {userId || 'Unknown'} (Pet ID: {String(petId)})
      </p>
    </div>
  );
}
</file>

<file path="app/recipe/[id]/page.tsx">
'use client';

import { useState, useEffect, useCallback, useMemo } from 'react';
import { useParams, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import {
  Clock,
  User,
  Star,
  ChevronLeft,
  X,
  ShoppingCart,
} from 'lucide-react';

import { loadRecipeById, loadAllRecipes } from '@/lib/data/recipes-index';
import type { Recipe, ModifiedRecipeResult } from '@/lib/types';
import { applyModifiers } from '@/lib/applyModifiers';
import { getVettedProduct, getVettedProductByAnyIdentifier, VETTED_PRODUCTS, getGenericIngredientName } from '@/lib/data/vetted-products';
import { petSupplements } from '@/lib/data/supplements';
import Tooltip from '@/components/Tooltip';
import { RecipeRatingSection } from '@/components/RecipeRatingSection';
import { calculateEnhancedCompatibility, type Pet as EnhancedPet } from '@/lib/utils/enhancedCompatibilityScoring';
import RecipeScoreModal from '@/components/RecipeScoreModal';
import { getRandomName, type Pet } from '@/lib/utils/petUtils';
import OneClickCheckoutModal from '@/components/OneClickCheckoutModal';
import { ShoppingList } from '@/components/ShoppingList';
import { CostComparison } from '@/components/CostComparison';
import { calculateMealsFromGroceryList } from '@/lib/utils/mealEstimation';
import { getCustomMeal } from '@/lib/utils/customMealStorage';
import { convertCustomMealToRecipe } from '@/lib/utils/convertCustomMealToRecipe';
import { getRecommendationsForRecipe, type RecommendedSupplement } from '@/lib/utils/nutritionalRecommendations';
import { checkAllBadges } from '@/lib/utils/badgeChecker';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';
import { getProductPrice } from '@/lib/data/product-prices';

// =================================================================
// 1. CONSTANTS
// =================================================================

type CategoryType = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

const NUTRITION_GUIDELINES: Record<
  CategoryType,
  { protein: string; fat: string; fiber: string }
> = {
  dogs: { protein: '25-35%', fat: '10-20%', fiber: '2-5%' },
  cats: { protein: '40-50%', fat: '25-35%', fiber: '1-3%' },
  birds: { protein: '15-20%', fat: '5-10%', fiber: '3-8%' },
  reptiles: { protein: '20-40%', fat: '5-15%', fiber: '5-10%' },
  'pocket-pets': { protein: '12-18%', fat: '3-6%', fiber: '15-25%' },
};

const HEALTH_CONCERN_MAP: Record<string, string> = {
  'allergy-support': 'allergies',
  allergies: 'allergies',
  'weight-management': 'weight-management',
  obesity: 'weight-management',
  'joint-&-mobility': 'joint-health',
  'joint-health': 'joint-health',
  arthritis: 'joint-health',
  'digestive-health': 'digestive',
  digestive: 'digestive',
  'sensitive-stomach': 'digestive',
  'kidney/urinary-support': 'kidney',
  kidney: 'kidney',
  'urinary-health': 'urinary-health',
  'skin-&-coat': 'skin-coat',
  diabetes: 'diabetes',
  hyperthyroidism: 'hyperthyroidism',
  pancreatitis: 'pancreatitis',
  'hairball-issues': 'hairball',
  hairball: 'hairball',
};

const normalizeConcern = (concern: string) => {
  const key = (concern || '').trim().toLowerCase().replace(/[^a-z0-9]/g, '-');
  return HEALTH_CONCERN_MAP[key] || key;
};

const formatIngredientNameForDisplay = (value: string): string => {
  return String(value)
    .trim()
    .replace(/[-_]+/g, ' ')
    .split(' ')
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
};

// =================================================================
// 2. TYPES & LOCAL STORAGE HELPERS
// =================================================================

interface RecipeDetailPet {
  id: string;
  names: string[];
  type: string;
  breed: string;
  age: string;
  healthConcerns: string[];
  allergies?: string[];
  weight: string;
  mealPlan: string[];
  savedRecipes: string[];
}

const getPetsFromLocalStorage = (userId: string): RecipeDetailPet[] => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  if (!stored) return [];

  try {
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed)
      ? parsed.map((p: any) => ({
          ...p,
          names: p.names || (p.name ? [p.name] : []),
          savedRecipes: p.savedRecipes || [],
          mealPlan: p.mealPlan || [],
          healthConcerns: p.healthConcerns || [],
        }))
      : [];
  } catch {
    return [];
  }
};

const savePetsToLocalStorage = (userId: string, pets: RecipeDetailPet[]) => {
  if (typeof window !== 'undefined') {
    localStorage.setItem(`pets_${userId}`, JSON.stringify(pets));
  }
};

const getSavedRecipes = (userId: string): string[] => {
  const pets = getPetsFromLocalStorage(userId);
  return [...new Set(pets.flatMap((p) => p.savedRecipes || []))];
};

const getStarStates = (rating: number): boolean[] => {
  const fullStars = Math.round(rating);
  return Array.from({ length: 5 }, (_, i) => i < fullStars);
};

const setRecipeSavedState = (
  userId: string,
  recipeId: string,
  isSaving: boolean
): RecipeDetailPet[] => {
  const pets = getPetsFromLocalStorage(userId);
  const updatedPets = pets.map((pet) => {
    if (!pet.savedRecipes) pet.savedRecipes = [];
    if (isSaving && !pet.savedRecipes.includes(recipeId)) {
      pet.savedRecipes.push(recipeId);
    } else if (!isSaving && pet.savedRecipes.includes(recipeId)) {
      pet.savedRecipes = pet.savedRecipes.filter((id) => id !== recipeId);
    }
    return pet;
  });

  savePetsToLocalStorage(userId, updatedPets);
  
  // Check badges after saving/removing recipe
  if (isSaving) {
    updatedPets.forEach(async (pet) => {
      if (pet.savedRecipes.includes(recipeId)) {
        // Get meal plan count and weekly plan completion status
        // Note: We'll need to check this from the profile page context
        // For now, just check saved recipes count
        const savedRecipesCount = pet.savedRecipes.length;
        
        checkAllBadges(userId, pet.id, {
          action: 'recipe_saved',
          savedRecipesCount,
          mealPlanCount: 0, // Will be updated from profile page
          weeklyPlanCompleted: false,
        }).catch(err => {
          console.error('Failed to check badges:', err);
        });
      }
    });
  }
  
  return updatedPets;
};

// For now we use last_user_id the same way as profile page
const getCurrentUserId = () => {
  if (typeof window === 'undefined') return '';
  return localStorage.getItem('last_user_id') || '';
};


// Helper function to extract ASIN from Amazon URL
const extractASIN = (url: string): string | undefined => {
  if (!url) return undefined;
  // Try /dp/ASIN pattern
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})/);
  if (dpMatch) return dpMatch[1];
  
  // Try /gp/product/ASIN pattern
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})/);
  if (gpMatch) return gpMatch[1];
  
  // Try ASIN parameter
  try {
    const urlObj = new URL(url);
    const asinParam = urlObj.searchParams.get('ASIN');
    if (asinParam) return asinParam;
  } catch (e) {
    // Invalid URL, try regex
  }
  
  return undefined;
};

// Helper function to derive species from recipe category
const getSpeciesFromRecipeCategory = (category?: string): string | undefined => {
  if (!category) return undefined;
  // recipe.category is like 'dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'
  // This matches the species parameter format
  return category;
};

// Helper function to vet recipe ingredients even without a pet selected
const vetRecipeIngredients = (recipe: Recipe): Recipe => {
  if (!recipe) return recipe;
  
  // Derive species from recipe category
  const species = getSpeciesFromRecipeCategory(recipe.category);
  
  return {
    ...recipe,
    ingredients: recipe.ingredients.map((ing) => {
      // Remove old amazonLink property
      const { amazonLink, ...ingWithoutOldLink } = ing as any;

      const existingLink = ing.asinLink || amazonLink;
      
      const genericKey = getGenericIngredientName((ing as any).productName || ing.name);
      const displayName = genericKey ? formatIngredientNameForDisplay(genericKey) : ing.name;
      
      // Try to find vetted product using the ingredient name
      // If the name is a product name (from applyModifiers), try to reverse-lookup
      // by checking if there's an id that might be the original name
      const lookupName = genericKey || ing.name;
      
      // Pass species for species-aware product matching
      let vettedProduct = getVettedProduct(lookupName, species);
      
      // If lookup by name/id failed and we have a productName, the ingredient was already vetted
      // Try to find the original generic name by searching VETTED_PRODUCTS for matching productName
      if (!vettedProduct && (ing as any).productName) {
        // Search VETTED_PRODUCTS for an entry with matching productName
        const matchingKey = Object.keys(VETTED_PRODUCTS).find(key => 
          VETTED_PRODUCTS[key].productName === (ing as any).productName
        );
        if (matchingKey) {
          vettedProduct = VETTED_PRODUCTS[matchingKey];
        }
      }
      
      if (vettedProduct) {
        const vettedLink = (vettedProduct.asinLink || vettedProduct.purchaseLink);
        return {
          ...ingWithoutOldLink,
          productName: vettedProduct.productName,
          name: displayName,
          asinLink: ensureSellerId(vettedLink), // Prefer vetted product link over existing link
        };
      }
      // If no vetted product found, keep ingredient but no ASIN link
      return {
        ...ingWithoutOldLink,
        name: displayName,
        asinLink: existingLink ? ensureSellerId(existingLink) : undefined,
      };
    }),
    // Also vet supplements if they exist
    supplements: (recipe as any).supplements?.map((supplement: any) => {
      // Remove old amazonLink property
      const { amazonLink, ...supplementWithoutOldLink } = supplement;

      const existingLink = supplement.asinLink || amazonLink;

      const genericKey = getGenericIngredientName(supplement.productName || supplement.name);
      const displayName = genericKey ? formatIngredientNameForDisplay(genericKey) : supplement.name;
      
      // Derive species from recipe category (re-derive here since we're in map scope)
      const species = getSpeciesFromRecipeCategory(recipe.category);
      // Pass species for species-aware product matching
      const lookupName = genericKey || supplement.name;
      const vettedProduct = getVettedProduct(lookupName, species);
      if (vettedProduct) {
        const vettedLink = (vettedProduct.asinLink || vettedProduct.purchaseLink);
        return {
          ...supplementWithoutOldLink,
          productName: vettedProduct.productName,
          name: displayName,
          asinLink: ensureSellerId(vettedLink), // Prefer vetted product link over existing link
        };
      }
      // Keep supplement but no ASIN link if no vetted product found
      return {
        ...supplementWithoutOldLink,
        name: displayName,
        asinLink: existingLink ? ensureSellerId(existingLink) : undefined,
      };
    }),
  };
};

// =================================================================
// 3. MAIN COMPONENT
// =================================================================

export default function RecipeDetailPage() {
  const params = useParams();
  const id = params?.id as string | undefined;

  const [recipe, setRecipe] = useState<Recipe | null>(null);
  const [pets, setPets] = useState<RecipeDetailPet[]>([]);
  const [selectedPetId, setSelectedPetId] = useState('');
  const [message, setMessage] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [petWeight, setPetWeight] = useState('');
  const [petAllergies, setPetAllergies] = useState('');
  const [isPersonalizing, setIsPersonalizing] = useState(false);
  const [modifierError, setModifierError] = useState<string | null>(null);
  const [modifierResult, setModifierResult] = useState<ModifiedRecipeResult | null>(null);
  const [activeTab, setActiveTab] = useState<'ingredients' | 'supplements'>('ingredients');
  const [isMealAdded, setIsMealAdded] = useState(false);
  const [isAddingMeal, setIsAddingMeal] = useState(false);
  const [isScoreModalOpen, setIsScoreModalOpen] = useState(false);
  const [vettedRecipe, setVettedRecipe] = useState<Recipe | null>(null);
  const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
  const [modifiedRecipe, setModifiedRecipe] = useState<Recipe | null>(null);
  const [recommendedSupplements, setRecommendedSupplements] = useState<RecommendedSupplement[]>([]);
  const [modifiedScore, setModifiedScore] = useState<number | null>(null);
  const [animatedScore, setAnimatedScore] = useState<number | null>(null);

  const userId = getCurrentUserId();

  const searchParams = useSearchParams();
  const queryPetId = searchParams?.get('petId') || '';

  const scoreForQueryPet = useMemo(() => {
    if (!recipe || !queryPetId) return null;
    const pet = getPetsFromLocalStorage(userId).find((p) => p.id === queryPetId);
    if (!pet) return null;

    // Use enhanced scoring
    try {
      const petAge = pet.age === 'baby' ? 0.5 : pet.age === 'young' ? 2 : pet.age === 'adult' ? 5 : 10;
      const enhancedPet: EnhancedPet = {
        id: pet.id,
        name: getRandomName(pet.names),
        type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
        breed: pet.breed,
        age: petAge,
        weight: parseFloat(pet.weight) || (pet.type === 'dogs' ? 25 : pet.type === 'cats' ? 10 : 5),
        activityLevel: 'moderate' as const,
        healthConcerns: pet.healthConcerns || [],
        dietaryRestrictions: pet.allergies || [],
        allergies: pet.allergies || [],
      };
      const enhanced = calculateEnhancedCompatibility(recipe, enhancedPet);
      // Convert to compatible format
      // Generate reason text that includes issues for better keyword matching
      const getReasonWithIssues = (factor: typeof enhanced.factors.ingredientSafety) => {
        if (factor.issues.length > 0) {
          return factor.issues.join('; ') + (factor.reasoning ? ` (${factor.reasoning})` : '');
        }
        return factor.reasoning || '';
      };

      // Get recommendations for nutritional gaps
      const supplementRecommendations = getRecommendationsForRecipe(
        enhanced.detailedBreakdown.nutritionalGaps,
        pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
        pet.healthConcerns || []
      );

      // Check badges if score is 100% (Nutrient Navigator)
      if (enhanced.overallScore === 100 && queryPetId && userId) {
        checkAllBadges(userId, queryPetId, {
          action: 'recipe_viewed',
          compatibilityScore: enhanced.overallScore,
        }).catch(err => {
          console.error('Failed to check badges:', err);
        });
      }

      // Generate summary reasoning from enhanced breakdown
      const summaryReasoning = enhanced.detailedBreakdown.recommendations.length > 0
        ? enhanced.detailedBreakdown.recommendations.join('. ')
        : enhanced.detailedBreakdown.healthBenefits.length > 0
        ? enhanced.detailedBreakdown.healthBenefits.join('. ')
        : 'Recipe evaluated for compatibility with your pet.';

      return {
        overallScore: enhanced.overallScore,
        compatibility: enhanced.grade === 'A+' || enhanced.grade === 'A' ? 'excellent' :
                       enhanced.grade === 'B+' || enhanced.grade === 'B' ? 'good' :
                       enhanced.grade === 'C+' || enhanced.grade === 'C' ? 'fair' : 'poor',
        summaryReasoning: summaryReasoning,
        explainRecommendations: enhanced.detailedBreakdown.recommendations || [],
        nutritionalGaps: enhanced.detailedBreakdown.nutritionalGaps,
        supplementRecommendations: supplementRecommendations,
        breakdown: {
          petTypeMatch: { 
            score: enhanced.factors.ingredientSafety.score,
            weightedContribution: Math.round(enhanced.factors.ingredientSafety.score * enhanced.factors.ingredientSafety.weight),
            weight: enhanced.factors.ingredientSafety.weight,
            reason: getReasonWithIssues(enhanced.factors.ingredientSafety)
          },
          ageAppropriate: { 
            score: enhanced.factors.lifeStageFit.score,
            weightedContribution: Math.round(enhanced.factors.lifeStageFit.score * enhanced.factors.lifeStageFit.weight),
            weight: enhanced.factors.lifeStageFit.weight,
            reason: getReasonWithIssues(enhanced.factors.lifeStageFit)
          },
          nutritionalFit: { 
            score: enhanced.factors.nutritionalAdequacy.score,
            weightedContribution: Math.round(enhanced.factors.nutritionalAdequacy.score * enhanced.factors.nutritionalAdequacy.weight),
            weight: enhanced.factors.nutritionalAdequacy.weight,
            reason: getReasonWithIssues(enhanced.factors.nutritionalAdequacy),
            recommendations: supplementRecommendations // Add recommendations to nutritional fit
          } as any, // Type assertion needed because recommendations is added dynamically
          healthCompatibility: { 
            score: enhanced.factors.healthAlignment.score,
            weightedContribution: Math.round(enhanced.factors.healthAlignment.score * enhanced.factors.healthAlignment.weight),
            weight: enhanced.factors.healthAlignment.weight,
            reason: getReasonWithIssues(enhanced.factors.healthAlignment)
          },
          activityFit: {
            score: enhanced.factors.activityFit.score,
            weightedContribution: Math.round(enhanced.factors.activityFit.score * enhanced.factors.activityFit.weight),
            weight: enhanced.factors.activityFit.weight,
            reason: getReasonWithIssues(enhanced.factors.activityFit)
          },
          allergenSafety: { 
            score: enhanced.factors.allergenSafety.score,
            weightedContribution: Math.round(enhanced.factors.allergenSafety.score * enhanced.factors.allergenSafety.weight),
            weight: enhanced.factors.allergenSafety.weight,
            reason: getReasonWithIssues(enhanced.factors.allergenSafety)
          },
        },
        warnings: enhanced.detailedBreakdown.warnings,
        strengths: enhanced.detailedBreakdown.healthBenefits,
        recommendations: enhanced.detailedBreakdown.recommendations,
      };
    } catch (error) {
      // Fallback to original scoring
    console.error('Error calculating compatibility:', error);
    return null;
    }
  }, [recipe, queryPetId, userId]);

  const modifierResultForQueryPet = (() => {
    if (!recipe || !queryPetId) return null;
    const pet = getPetsFromLocalStorage(userId).find((p) => p.id === queryPetId);
    if (!pet) return null;
    return applyModifiers(recipe, pet as any);
  })();

  // Load recipe by dynamic route id (handles custom meals, generated recipes, and regular recipes)
  useEffect(() => {
    if (!id) {
      setIsLoading(false);
      return;
    }

    setIsLoading(true);
    
    // Check if this is a custom meal (starts with "custom_")
    const isCustomMeal = id.startsWith('custom_');
    
    if (isCustomMeal && queryPetId) {
      // Load custom meal
      getCustomMeal(userId, queryPetId, id)
        .then((customMeal) => {
          if (customMeal) {
            const recipe = convertCustomMealToRecipe(customMeal);
            // Always vet the recipe ingredients to ensure all have purchase links
            const vetted = vetRecipeIngredients(recipe);
            setRecipe(vetted);
            setVettedRecipe(vetted);
          } else {
            setRecipe(null);
            setVettedRecipe(null);
          }
          setIsLoading(false);
        })
        .catch((error) => {
          console.error('Error loading custom meal:', error);
          setRecipe(null);
          setVettedRecipe(null);
          setIsLoading(false);
        });
    } else {
      // Try to load from session storage first (for dynamically generated recipes)
      let sessionRecipe = null;
      if (typeof window !== 'undefined') {
        const sessionData = sessionStorage.getItem(`recipe_${id}`);
        if (sessionData) {
          try {
            sessionRecipe = JSON.parse(sessionData);
          } catch (e) {
            console.warn('Failed to parse session recipe:', e);
          }
        }
      }

      if (sessionRecipe) {
        // Use recipe from session storage
        const vetted = vetRecipeIngredients(sessionRecipe);
        setRecipe(vetted);
        setVettedRecipe(vetted);
        setIsLoading(false);
      } else {
        // Try to load from static recipes (fallback)
        loadRecipeById(id)
          .then((foundRecipe) => {
            if (foundRecipe) {
              // Always vet the recipe ingredients to ensure all have purchase links
              const vetted = vetRecipeIngredients(foundRecipe);
              setRecipe(vetted);
              // Always set vettedRecipe so ShoppingList can use vetted products
              setVettedRecipe(vetted);
            } else {
              // Recipe not found
              setRecipe(null);
              setVettedRecipe(null);
            }
            setIsLoading(false);
          })
          .catch((error) => {
            console.error('Error loading recipe:', error);
            setRecipe(null);
            setVettedRecipe(null);
            setIsLoading(false);
          });
      }
    }
  }, [id, queryPetId, userId]); // Reload when ID, petId, or userId changes

  // Update recommendations when score changes
  useEffect(() => {
    if (scoreForQueryPet && 'supplementRecommendations' in scoreForQueryPet) {
      const recs = (scoreForQueryPet as any).supplementRecommendations || [];
      setRecommendedSupplements(recs);
    } else {
      setRecommendedSupplements([]);
    }
  }, [scoreForQueryPet]);

  // Initialize modified recipe
  useEffect(() => {
    if (recipe && !modifiedRecipe) {
      setModifiedRecipe(JSON.parse(JSON.stringify(recipe)));
    }
  }, [recipe, modifiedRecipe]);

  // Load pets & saved state
  useEffect(() => {
    if (!userId || !id) return;

    try {
      const loadedPets = getPetsFromLocalStorage(userId);
      setPets(loadedPets);
    } catch (error) {
      // Handle error gracefully - show empty pets array
      console.error('Failed to load pets:', error);
      setPets([]);
    }
  }, [userId, id]);

  useEffect(() => {
    // Auto-select pet from URL parameter if available
    if (queryPetId && pets.length > 0 && !selectedPetId) {
      setSelectedPetId(queryPetId);
    }
  }, [queryPetId, pets, selectedPetId]);

  useEffect(() => {
    // Check if meal is already added for the current pet (check both mealPlan and savedRecipes)
    const currentPet = selectedPetId ? pets.find(p => p.id === selectedPetId) : (queryPetId ? pets.find(p => p.id === queryPetId) : null);
    if (currentPet && recipe) {
      const inMealPlan = currentPet.mealPlan?.includes(recipe.id) || false;
      const inSavedRecipes = currentPet.savedRecipes?.includes(recipe.id) || false;
      setIsMealAdded(inMealPlan || inSavedRecipes);
    } else {
      setIsMealAdded(false);
    }
  }, [selectedPetId, queryPetId, pets, recipe]);

  useEffect(() => {
    if (!selectedPetId || !recipe) {
      setPetWeight('');
      setPetAllergies('');
      setModifierResult(null);
      setModifierError(null);
      setIsMealAdded(false);
      // DON'T set vettedRecipe to null - keep the vetted recipe so ingredients show properly
      // setVettedRecipe(null); // REMOVED - this was causing ingredients to disappear
      return;
    }

    const pet = pets.find((p) => p.id === selectedPetId);
    if (!pet) return;
    setPetWeight(pet.weight || '');
    setPetAllergies(pet.allergies?.join(', ') || '');
    setModifierResult(null);
    setModifierError(null);
    const inMealPlan = pet.mealPlan?.includes(recipe.id) || false;
    const inSavedRecipes = pet.savedRecipes?.includes(recipe.id) || false;
    setIsMealAdded(inMealPlan || inSavedRecipes);

    // Apply modifiers, then vet all ingredients to ensure purchase links
    const { modifiedRecipe } = applyModifiers(recipe, pet);
    const vetted = vetRecipeIngredients(modifiedRecipe);
    setVettedRecipe(vetted);
  }, [selectedPetId, pets, recipe]);

  // Function to add supplement to recipe
  const handleAddSupplement = useCallback((supplement: RecommendedSupplement) => {
    if (!modifiedRecipe) return;

    const newRecipe = JSON.parse(JSON.stringify(modifiedRecipe));
    
    // Initialize supplements array if it doesn't exist
    if (!newRecipe.supplements) {
      newRecipe.supplements = [];
    }

    // Check if supplement already exists
    const exists = newRecipe.supplements.some((s: any) => 
      s.name === supplement.name || s.productName === supplement.productName
    );

    if (exists) {
      setMessage('This supplement is already in the recipe');
      setTimeout(() => setMessage(null), 3000);
      return;
    }

    // Add supplement
    const supplementToAdd: any = {
      id: `supplement-${Date.now()}`,
      name: supplement.name,
      productName: supplement.productName || supplement.name,
      amount: supplement.defaultAmount,
      notes: supplement.benefits,
      asinLink: supplement.asinLink || supplement.amazonLink,
    };

    newRecipe.supplements.push(supplementToAdd);
    setModifiedRecipe(newRecipe);

    // Recalculate score
    if (queryPetId && scoreForQueryPet) {
      const pet = getPetsFromLocalStorage(userId).find((p) => p.id === queryPetId);
      if (pet) {
        const petAge = pet.age === 'baby' ? 0.5 : pet.age === 'young' ? 2 : pet.age === 'adult' ? 5 : 10;
        const enhancedPet: EnhancedPet = {
          id: pet.id,
          name: getRandomName(pet.names),
          type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
          breed: pet.breed,
          age: petAge,
          weight: parseFloat(pet.weight) || (pet.type === 'dogs' ? 25 : pet.type === 'cats' ? 10 : 5),
          activityLevel: 'moderate' as const,
          healthConcerns: pet.healthConcerns || [],
          dietaryRestrictions: pet.allergies || [],
          allergies: pet.allergies || [],
        };

        try {
          const newScore = calculateEnhancedCompatibility(newRecipe, enhancedPet);
          const oldScore = scoreForQueryPet.overallScore;
          const scoreDiff = newScore.overallScore - oldScore;

          if (scoreDiff > 0) {
            // Animate score change
            animateScoreChange(oldScore, newScore.overallScore);
          }

          setModifiedScore(newScore.overallScore);
          setMessage(`${supplement.name} added! Score improved by ${scoreDiff > 0 ? '+' : ''}${scoreDiff.toFixed(0)} points.`);
          setTimeout(() => setMessage(null), 5000);
        } catch (error) {
          console.error('Error recalculating score:', error);
          setMessage(`${supplement.name} added to recipe.`);
          setTimeout(() => setMessage(null), 3000);
        }
      }
    }
  }, [modifiedRecipe, queryPetId, scoreForQueryPet, userId]);

  // Score animation function
  const animateScoreChange = useCallback((from: number, to: number) => {
    const duration = 1500; // 1.5 seconds
    const steps = 60;
    const increment = (to - from) / steps;
    let current = from;
    let step = 0;

    const animate = () => {
      step++;
      current = from + (increment * step);
      
      if (step < steps) {
        setAnimatedScore(Math.round(current));
        requestAnimationFrame(animate);
      } else {
        setAnimatedScore(to);
      }
    };

    animate();
  }, []);

  const handleAddToMealPlan = useCallback(async () => {
    if (!recipe || !userId) {
      setMessage('Please select a pet.');
      setTimeout(() => setMessage(null), 2500);
      return;
    }

    const currentPetId = selectedPetId || queryPetId;
    if (!currentPetId) {
      setMessage('Please select a pet.');
      setTimeout(() => setMessage(null), 2500);
      return;
    }

    const currentPet = pets.find(p => p.id === currentPetId);
    if (!currentPet) {
      setMessage('Pet not found.');
      setTimeout(() => setMessage(null), 2500);
      return;
    }

    // Check if already added (check both mealPlan and savedRecipes)
    if (currentPet.mealPlan?.includes(recipe.id) || currentPet.savedRecipes?.includes(recipe.id)) {
      setIsMealAdded(true);
      return;
    }

    setIsAddingMeal(true);
    
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 300));

    const updatedPets = pets.map((pet) => {
      if (pet.id === currentPetId) {
        if (!pet.mealPlan) pet.mealPlan = [];
        if (!pet.mealPlan.includes(recipe.id)) {
          pet.mealPlan.push(recipe.id);
          setIsMealAdded(true);
        }
      }
      return pet;
    });

    savePetsToLocalStorage(userId, updatedPets);
    setPets(updatedPets);
    setIsAddingMeal(false);
  }, [recipe, selectedPetId, queryPetId, pets, userId]);

  const selectedPet = selectedPetId
    ? pets.find((pet) => pet.id === selectedPetId)
    : null;

  const handlePersonalizeRecipe = async () => {
    if (!recipe) return;

    const currentPet = selectedPet || (queryPetId ? pets.find(p => p.id === queryPetId) : null);
    if (!currentPet) {
      setModifierError('Select a pet profile first.');
      return;
    }

    const parsedWeight = parseFloat(petWeight);
    if (!parsedWeight || parsedWeight <= 0) {
      setModifierError('Enter a valid weight in kilograms.');
      return;
    }

    setIsPersonalizing(true);
    setModifierError(null);

    const healthConcerns = (currentPet.healthConcerns || [])
      .filter((concern) => concern && concern !== 'none')
      .map(normalizeConcern);

    const allergiesArray = petAllergies
      .split(',')
      .map((item) => item.trim())
      .filter(Boolean);

    try {
      const response = await fetch('/api/recommendations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          profile: {
            species: currentPet.type,
            ageGroup: currentPet.age,
            breed: currentPet.breed,
            weightKg: parsedWeight,
            healthConcerns,
            allergies: allergiesArray,
          },
          recipeIds: [recipe.id],
          limit: 1,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to personalize recipe.');
      }

      const data = await response.json();
      const result = data.results?.[0] || null;
      setModifierResult(result);
      if (!result) {
        setModifierError('No modifier rules matched for this profile.');
      }
    } catch (error) {
      // Error handled by error state
      setModifierError('Unable to personalize this meal right now.');
      setModifierResult(null);
    } finally {
      setIsPersonalizing(false);
    }
  };

  // Calculate all shopping items and meal estimate for sidebar (MUST be before early returns)
  const { allShoppingItems, mealEstimate } = useMemo(() => {
    const sourceRecipe = vettedRecipe || recipe;
    if (!sourceRecipe) {
      return { allShoppingItems: [], mealEstimate: null };
    }

    const allIngredients = sourceRecipe.ingredients || [];

    const ingredientsEnrichedWithLinks = allIngredients.map((ing: any) => {
      const existingLink = ing?.asinLink || ing?.amazonLink;
      if (existingLink) return ing;

      const lookupName = getGenericIngredientName(ing?.productName || ing?.name) || ing?.name;
      if (!lookupName) return ing;

      const product = getVettedProduct(lookupName, sourceRecipe.category);
      const productLink = product?.asinLink || product?.purchaseLink;
      if (!productLink) return ing;

      const enrichedLink = ensureSellerId(productLink);
      return {
        ...ing,
        productName: ing?.productName || product.productName,
        amazonLink: enrichedLink,
        asinLink: enrichedLink
      };
    });

    const ingredientsWithASINs = ingredientsEnrichedWithLinks.filter((ing: any) => ing.asinLink || ing.amazonLink);
    const supplementsWithASINs = (modifiedRecipe as any)?.supplements?.filter((s: any) => s.asinLink || s.amazonLink) || [];

    const shoppingItems = [
      ...ingredientsWithASINs.map((ing: any) => ({
        id: ing.id,
        name: ing.name,
        amount: ing.amount || '',
        asinLink: ensureSellerId(ing.asinLink || ing.amazonLink)
      })),
      ...supplementsWithASINs.map((supplement: any) => ({
        id: supplement.id || supplement.name,
        name: supplement.name,
        amount: supplement.amount || supplement.defaultAmount || '',
        asinLink: ensureSellerId(supplement.asinLink || supplement.amazonLink)
      }))
    ];

    const totalCost = shoppingItems.reduce((sum: number, item: any) => {
      const price = getProductPrice(item.name);
      if (typeof price === 'number') return sum + price;
      return sum;
    }, 0);

    let estimate = null;
    if (shoppingItems.length > 0) {
      try {
        const shoppingListItems = shoppingItems.map((item: any) => {
          const genericName = getGenericIngredientName(item.name) || item.name.toLowerCase();
          const vettedProduct = getVettedProduct(genericName, sourceRecipe.category);
          return {
            id: item.id,
            name: item.name,
            amount: item.amount,
            category: vettedProduct?.category || 'other'
          };
        });

        estimate = calculateMealsFromGroceryList(shoppingListItems, undefined, sourceRecipe.category);
      } catch (error) {
        estimate = null;
      }
    }

    return { allShoppingItems: shoppingItems, mealEstimate: estimate };
  }, [vettedRecipe, recipe, modifiedRecipe]);

  const guidelines =
    NUTRITION_GUIDELINES[recipe?.category as CategoryType] ||
    ({ protein: 'N/A', fat: 'N/A', fiber: 'N/A' } as const);

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-xl font-semibold text-gray-400 bg-background">
        Loading meal...
      </div>
    );
  }

  if (!recipe) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center space-y-4 bg-background">
        <h1 className="text-3xl font-bold text-red-500">Meal not found</h1>
        <p className="text-gray-400">We couldn't find a meal for this link.</p>
        <Link
          href="/profile"
          className="text-secondary-400 font-semibold hover:text-secondary-300"
        >
          Go to My Pets
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background py-12 font-sans text-foreground">
      {/* Message Toast */}
      {message && (
        <div className="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50">
          {message}
        </div>
      )}

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Breadcrumb */}
        <Link
          href="/profile"
          className="inline-flex items-center text-gray-400 hover:text-primary-400 mb-6 font-medium transition-colors"
        >
          <ChevronLeft className="w-5 h-5 mr-1" />
          Back to My Pets
        </Link>

        <div className="grid grid-cols-1 lg:grid-cols-5 gap-10">
          <main className="lg:col-span-3">
            {/* Recipe Info Card */}
            <div className="bg-surface rounded-2xl shadow-xl overflow-hidden mb-8 border border-surface-highlight">
              <div className="p-8">
                <h1 className="text-4xl font-extrabold text-foreground mb-2 tracking-tight">
                  <div className="flex items-center gap-3">
                    <span>{recipe.name}</span>
                    {(recipe.needsReview === true || (scoreForQueryPet && 'usesFallbackNutrition' in scoreForQueryPet && (scoreForQueryPet as any).usesFallbackNutrition)) && (
                      <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-900/40 text-amber-200 border border-amber-700/50">
                        ‚ö†Ô∏è Experimental / Topper Only
                      </span>
                    )}
                  </div>
                </h1>
                {/* Pet Compatibility Rating - Using NEW system */}
                
                {queryPetId && scoreForQueryPet && (
                  <div className="mb-4 flex items-center gap-3">
                    <button
                      onClick={() => setIsScoreModalOpen(true)}
                      className="flex items-center cursor-pointer hover:opacity-80 transition-opacity"
                    >
                      <div className="flex items-center">
                        {Array.from({ length: 5 }).map((_, i) => (
                          <Star
                            key={i}
                            className={`w-5 h-5 ${i < Math.round(scoreForQueryPet.overallScore / 20) ? 'text-yellow-500 fill-yellow-500' : 'text-gray-600'}`}
                          />
                        ))}
                      </div>
                      <div className="text-sm text-gray-300 ml-2">
                        Compatibility Score: <strong>{scoreForQueryPet.overallScore}%</strong>
                        <span className="text-xs text-gray-400 ml-2">(weighted average)</span>
                      </div>
                    </button>
                    <Tooltip
                      content={`Compatibility: ${scoreForQueryPet.compatibility}\n\n${scoreForQueryPet.strengths.length > 0 ? 'Strengths:\n‚Ä¢ ' + scoreForQueryPet.strengths.join('\n‚Ä¢ ') + '\n' : ''}${scoreForQueryPet.warnings.length > 0 ? '\nWarnings:\n‚Ä¢ ' + scoreForQueryPet.warnings.join('\n‚Ä¢ ') : ''}`}
                    >
                      <div className="text-xs text-gray-500 cursor-help hover:text-gray-300">
                        Why
                      </div>
                    </Tooltip>
                  </div>
                )}

                {scoreForQueryPet && 'explainRecommendations' in scoreForQueryPet && (scoreForQueryPet as any).explainRecommendations && (scoreForQueryPet as any).explainRecommendations.length > 0 && (
                  <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg mb-4">
                    <div className="flex items-start gap-2">
                      <span className="text-lg">üí°</span>
                      <div className="flex-1">
                        <h4 className="font-semibold text-amber-900 mb-2">Suggestions:</h4>
                        <ul className="text-sm text-amber-800 space-y-1">
                          {(scoreForQueryPet as any).explainRecommendations.map((rec: string, i: number) => (
                            <li key={i}>‚Ä¢ {rec}</li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                )}

                {/* Pet Reviews - Positioned directly under meal title */}
                <div className="mb-6">
                  <RecipeRatingSection
                    recipeId={id || ''}
                    recipeName={recipe.name}
                    userId={userId}
                  />
                </div>

                <div className="mb-8">
                  <p className="text-gray-300 leading-relaxed text-lg">
                    {recipe.description}
                  </p>
                  {(recipe.needsReview === true || (scoreForQueryPet && 'usesFallbackNutrition' in scoreForQueryPet && (scoreForQueryPet as any).usesFallbackNutrition)) && (
                    <div className="mt-3 p-3 bg-amber-900/20 border border-amber-700/50 rounded-lg">
                      <p className="text-sm text-amber-200">
                        <strong>‚ö†Ô∏è Note:</strong> This recipe uses estimated nutrition data. Consult your veterinarian before feeding as a complete meal.
                      </p>
                    </div>
                  )}
                </div>

                <div className="flex flex-wrap gap-2 mb-8">
                  {recipe.tags?.map((tag) => (
                    <span
                      key={tag}
                      className="bg-surface-highlight text-gray-300 px-3 py-1 rounded-full text-sm font-medium border border-surface-highlight"
                    >
                      {tag}
                    </span>
                  ))}
                </div>

              </div>
            </div>

            {/* Ingredients & Supplements Tabs */}
            <div className="bg-surface rounded-2xl shadow-lg p-8 mb-8 border border-surface-highlight">
              {/* Tab Navigation */}
              <div className="flex border-b border-surface-highlight mb-6">
                <button
                  onClick={() => setActiveTab('ingredients')}
                  className={`px-6 py-3 font-semibold text-sm border-b-2 transition-colors ${
                    activeTab === 'ingredients'
                      ? 'border-orange-500 text-orange-400'
                      : 'border-transparent text-gray-500 hover:text-gray-300'
                  }`}
                >
                  Ingredients
                </button>
                <button
                  onClick={() => setActiveTab('supplements')}
                  className={`px-6 py-3 font-semibold text-sm border-b-2 transition-colors ${
                    activeTab === 'supplements'
                      ? 'border-orange-500 text-orange-400'
                      : 'border-transparent text-gray-500 hover:text-gray-300'
                  }`}
                >
                  Supplements
                </button>
              </div>

              {/* Tab Content */}
              {activeTab === 'ingredients' && (
                <div className="relative">
                  {(() => {
                    const allIngredients = vettedRecipe?.ingredients || recipe.ingredients || [];
                    
                    const ingredientsWithASINs = allIngredients.filter((ing: any) => ing.asinLink);
                    // Filter out ingredients with old amazonLink - only show truly missing ASINs
                    const ingredientsWithoutASINs = allIngredients.filter((ing: any) => !ing.asinLink && !ing.amazonLink);
                    
                    // Get recommended ingredients (from recommendations where isIngredient === true)
                    const recommendedIngredients = recommendedSupplements.filter((rec: any) => rec.isIngredient === true);
                    
                    return (
                      <div className="space-y-6">
                        {/* Recommended Ingredients Section */}
                        {recommendedIngredients.length > 0 && (
                          <div className="bg-orange-900/20 border border-orange-700/50 rounded-lg p-6">
                            <h3 className="text-lg font-semibold text-orange-200 mb-4 flex items-center gap-2">
                              <span>‚ú®</span>
                              Recommended Ingredients
                            </h3>
                            <p className="text-sm text-gray-400 mb-4">
                              These ingredients can help address nutritional deficiencies in this recipe:
                            </p>
                            <div className="space-y-3">
                              {recommendedIngredients.map((ingredient: any, index: number) => (
                                <div key={index} className="bg-surface rounded-lg p-4 border border-orange-700/30">
                                  <div className="flex items-start justify-between gap-4">
                                    <div className="flex-1">
                                      <h5 className="font-semibold text-gray-200">{ingredient.name}</h5>
                                      <p className="text-sm text-gray-400 mt-1">{ingredient.description}</p>
                                      <p className="text-xs text-orange-300 mt-2">
                                        Addresses: {ingredient.addressesDeficiency}
                                      </p>
                                      <p className="text-sm text-gray-300 mt-2">
                                        <strong>Benefits:</strong> {ingredient.benefits}
                                      </p>
                                      <p className="text-sm text-gray-400 mt-1">
                                        <strong>Suggested Amount:</strong> {ingredient.defaultAmount}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Ingredients with ASIN links - show buy buttons */}
                        {allShoppingItems.length > 0 && (
                          <div className="space-y-6">
                            <h3 className="text-lg font-semibold text-foreground mb-4">
                              Recipe Ingredients & Supplements
                            </h3>
                            <ShoppingList
                              ingredients={allShoppingItems}
                              recipeName={recipe.name}
                              userId={userId}
                            />
                          </div>
                        )}
                        
                        {/* Ingredients without ASIN links - just display them */}
                        {ingredientsWithoutASINs.length > 0 && (
                          <div className="bg-surface-lighter rounded-lg border border-surface-highlight p-6">
                            <h3 className="text-lg font-semibold text-foreground mb-4">
                              Additional Ingredients
                            </h3>
                            <div className="space-y-2">
                              {ingredientsWithoutASINs.map((ing: any, index: number) => (
                                <div
                                  key={ing.id || index}
                                  className="flex items-center justify-between p-3 bg-surface rounded-lg border border-surface-highlight"
                                >
                                  <div className="flex-1">
                                    <div className="font-medium text-gray-200">{ing.name}</div>
                                    {ing.amount && (
                                      <div className="text-sm text-gray-400">{ing.amount}</div>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              )}

              {activeTab === 'supplements' && (
                <div className="relative space-y-6">
                  {/* Recommended Supplements Section */}
                  {(() => {
                    // Filter out ingredients - only show supplements
                    const recommendedSupplementsOnly = recommendedSupplements.filter((rec: any) => !rec.isIngredient);
                    
                    if (recommendedSupplementsOnly.length === 0) return null;
                    
                    return (
                      <div className="bg-orange-900/20 border border-orange-700/50 rounded-lg p-6">
                        <h3 className="text-lg font-semibold text-orange-200 mb-4 flex items-center gap-2">
                          <span>üíä</span>
                          Recommended Supplements
                        </h3>
                        <p className="text-sm text-gray-400 mb-4">
                          These supplements can help address nutritional deficiencies in this recipe:
                        </p>
                        <div className="space-y-3">
                          {recommendedSupplementsOnly.map((supplement, index) => {
                            const isAlreadyAdded = ((modifiedRecipe || recipe) as any)?.supplements?.some((s: any) => 
                              s.name === supplement.name || s.productName === supplement.productName
                            ) || false;
                            
                            return (
                              <div key={index} className="bg-surface rounded-lg p-4 border border-orange-700/30">
                                <div className="flex items-start justify-between gap-4">
                                  <div className="flex-1">
                                    <h5 className="font-semibold text-gray-200">{supplement.name}</h5>
                                    <p className="text-sm text-gray-400 mt-1">{supplement.description}</p>
                                    <p className="text-xs text-orange-300 mt-2">
                                      Addresses: {supplement.addressesDeficiency}
                                    </p>
                                    <p className="text-sm text-gray-300 mt-2">
                                      <strong>Benefits:</strong> {supplement.benefits}
                                    </p>
                                    <p className="text-sm text-gray-400 mt-1">
                                      <strong>Amount:</strong> {supplement.defaultAmount}
                                    </p>
                                  </div>
                                  <button
                                    onClick={() => handleAddSupplement(supplement)}
                                    disabled={isAlreadyAdded}
                                    className={`px-4 py-2 rounded-md text-sm font-semibold transition-colors whitespace-nowrap ${
                                      isAlreadyAdded
                                        ? 'bg-green-600 text-white cursor-not-allowed opacity-50'
                                        : 'bg-orange-600 text-white hover:bg-orange-700'
                                    }`}
                                  >
                                    {isAlreadyAdded ? '‚úì Added' : '+ Add to Recipe'}
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })()}

                  {/* Existing Recipe Supplements */}
                  {(() => {
                    const supplementsWithASINs = ((modifiedRecipe || recipe) as any)?.supplements?.filter((s: any) => s.asinLink) || [];
                    if (supplementsWithASINs.length > 0) {
                      return (
                        <div>
                          <h3 className="text-lg font-semibold text-gray-200 mb-4">
                            Recipe Supplements
                          </h3>
                          <ShoppingList
                            ingredients={supplementsWithASINs.map((supplement: any) => ({
                              id: supplement.id || supplement.name,
                              name: supplement.name,
                              amount: supplement.amount || '',
                              asinLink: ensureSellerId(supplement.asinLink)
                            }))}
                            recipeName={`${recipe.name} supplements`}
                            userId={userId}
                          />
                        </div>
                      );
                    } else {
                      const recipeSupplements = ((modifiedRecipe || recipe) as any)?.supplements || [];
                      if (recipeSupplements.length === 0 && recommendedSupplements.length === 0) {
                        return (
                          <div>
                            <h3 className="text-2xl font-bold text-foreground mb-6">
                              Recipe Supplements
                            </h3>
                            <div className="text-center py-8 text-gray-500">
                              <p>This recipe doesn't include specific supplements.</p>
                              <p className="text-sm mt-2">Check the ingredients tab for all components.</p>
                            </div>
                          </div>
                        );
                      } else if (recipeSupplements.length > 0) {
                        return (
                          <div>
                            <h3 className="text-2xl font-bold text-foreground mb-6">
                              Recipe Supplements
                            </h3>
                            <div className="space-y-4">
                              {recipeSupplements.map((supplement: any, index: number) => (
                                <div key={index} className="bg-surface-lighter rounded-lg p-4 border border-surface-highlight">
                                  <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                      <h5 className="font-semibold text-gray-200">{supplement.name}</h5>
                                      {supplement.productName && supplement.productName !== supplement.name && (
                                        <div className="text-sm text-gray-400 mt-1">
                                          (Generic: {supplement.name})
                                        </div>
                                      )}
                                      <p className="text-sm text-gray-400 mt-1">{supplement.notes || 'Health supplement for optimal nutrition'}</p>
                                    </div>
                                    <div className="flex items-center gap-4 ml-4">
                                      {supplement.amount && (
                                        <span className="text-orange-400 font-bold">
                                          {supplement.amount}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      }
                    }
                  })()}
                </div>
              )}
            </div>

            {modifierResultForQueryPet && modifierResultForQueryPet.addedIngredients.length > 0 && (
              <div className="bg-surface rounded-2xl shadow-lg p-8 mb-8 border border-surface-highlight">
                <h3 className="text-2xl font-bold text-foreground mb-6 border-b border-surface-highlight pb-4">
                  Recommended Additions
                </h3>
                <ul className="space-y-4">
                  {modifierResultForQueryPet.addedIngredients.map((add) => (
                    <li
                      key={add.name}
                      className="flex justify-between items-center p-3 bg-green-900/20 rounded-lg transition-colors border border-green-800/30"
                    >
                      <div>
                        <span className="text-gray-200 font-medium text-lg">
                          {add.name}
                        </span>
                        <p className="text-sm text-gray-400">{add.benefit}</p>
                        <p className="text-xs text-green-400">Added for {add.forConcern}</p>
                      </div>
                      <a
                        href={ensureSellerId(add.amazon)}
                        target="_blank"
                        rel="noreferrer"
                        className="inline-flex items-center gap-2 px-4 py-2 bg-[#FF9900] hover:bg-[#E07704] text-black rounded-lg transition-all duration-200 text-sm font-semibold whitespace-nowrap hover:shadow-md"
                      >
                        <ShoppingCart size={16} />
                        Buy
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

          </main>

          <aside className="lg:col-span-2 space-y-8">
            {/* Health Breakdown Panel - Moved to top */}
            {scoreForQueryPet && (
              <div className="bg-surface rounded-2xl shadow-lg p-6 border-l-4 border-green-500 border border-surface-highlight">
                <h4 className="text-lg font-bold mb-4 flex items-center justify-center text-gray-200">
                  <span className="text-2xl mr-2">üè•</span>
                  Health Analysis
                </h4>
                <div className="mb-4 flex justify-center">
                  <Image
                    src="/images/emojis/Mascots/Proffessor Purfessor/PUrfessorDesk.jpg"
                    alt="Professor Purfessor"
                    width={280}
                    height={210}
                    className="rounded-lg object-contain"
                    unoptimized
                  />
                </div>
                <p className="text-xs text-gray-400 mb-4">
                  Proffessor Purfessor has found these individual factors that contribute to the overall compatibility score
                </p>
                <div className="space-y-3">
                  {Object.entries(scoreForQueryPet.breakdown).map(([key, factor]) => {
                    const f = factor as { score: number; weightedContribution?: number; weight: number; reason?: string };
                    const score = f.score || 0;
                    const weightedContribution = f.weightedContribution ?? Math.round(score * (f.weight || 0));
                    const weight = f.weight || 0;

                    // Always show all health factors with appropriate colors
                    let bgColor = 'bg-green-900/20 border-green-700/50';
                    let icon = '‚úÖ';
                    let textColor = 'text-green-200';

                    if (score < 70) {
                      bgColor = 'bg-yellow-900/20 border-yellow-700/50';
                      icon = '‚ö†Ô∏è';
                      textColor = 'text-yellow-200';
                    }
                    if (score < 40) {
                      bgColor = 'bg-red-900/20 border-red-700/50';
                      icon = '‚ùå';
                      textColor = 'text-red-200';
                    }

                    // Format factor name
                    const factorName = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                    // Format tooltip content with better structure and spacing
                    const formattedFactorName = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    
                    // Get recommendations for this factor
                    let recommendationText = '';
                    const factorWithRecommendations = f as typeof f & { recommendations?: any[] };
                    if (key === 'nutritionalFit' && factorWithRecommendations.recommendations && factorWithRecommendations.recommendations.length > 0) {
                      recommendationText += '\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nüíä Recommendations:\n';
                      const supplements = factorWithRecommendations.recommendations.filter((r: any) => !r.isIngredient);
                      const ingredients = factorWithRecommendations.recommendations.filter((r: any) => r.isIngredient);
                      
                      if (supplements.length > 0) {
                        recommendationText += `\nCheck Supplements tab for: ${supplements.map((r: any) => r.productName || r.name).join(', ')}`;
                      }
                      if (ingredients.length > 0) {
                        recommendationText += `\nCheck Ingredients tab for: ${ingredients.map((r: any) => r.name).join(', ')}`;
                      }
                    }
                    
                    const tooltipContent = `üìä ${formattedFactorName}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nRaw Score: ${score}%\nWeight: ${(weight * 100).toFixed(0)}%\nContribution: ${weightedContribution} points\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n${f.reason ? `üí° ${f.reason}` : 'No additional details available'}${recommendationText}`;

                    return (
                      <Tooltip key={key} content={tooltipContent} wide={key === 'nutritionalFit'}>
                        <div className={`flex items-center justify-between p-3 ${bgColor} rounded-lg border cursor-help hover:opacity-80 transition-colors`}>
                          <div className="flex items-center gap-2">
                            <span className="text-sm">{icon}</span>
                            <span className={`text-sm font-medium capitalize ${textColor}`}>
                              {factorName}
                            </span>
                          </div>
                          <div className="flex flex-col items-end">
                            <span className={`text-sm font-bold ${textColor}`}>
                              {score}%
                            </span>
                            <span className="text-xs text-gray-400">
                              +{weightedContribution} pts
                            </span>
                          </div>
                        </div>
                      </Tooltip>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Cost Comparison */}
            {allShoppingItems.length > 0 && mealEstimate && mealEstimate.estimatedMeals > 0 && mealEstimate.costPerMeal > 0 && (
              <CostComparison 
                costPerMeal={mealEstimate.costPerMeal}
                totalCost={mealEstimate.totalCost}
                estimatedMeals={mealEstimate.estimatedMeals}
                exceedsBudget={mealEstimate.exceedsBudget || false}
              />
            )}



            {/* Action Buttons */}
            {!isMealAdded && (
              <div className="bg-surface rounded-2xl shadow-lg p-6 space-y-4 border border-surface-highlight">
                <button
                  onClick={handleAddToMealPlan}
                  disabled={isAddingMeal}
                  className={`btn btn-success btn-lg btn-full ${
                    isAddingMeal 
                      ? 'btn-loading' 
                      : 'btn-ripple'
                  }`}
                >
                  {isAddingMeal ? 'Adding...' : '+Add Meal'}
                </button>
              </div>
            )}

            {/* Preparation Instructions */}
            <div className="bg-surface rounded-2xl shadow-lg p-6 border border-surface-highlight">
              <h3 className="text-xl font-bold text-foreground mb-4 border-b border-surface-highlight pb-3">
                üë®‚Äçüç≥ Preparation
              </h3>
              <ol className="space-y-4">
                {recipe.instructions?.map((step, index) => (
                  <li key={index} className="flex items-start">
                    <span className="flex-shrink-0 w-6 h-6 bg-secondary-900/50 border border-secondary-700 text-secondary-200 rounded-full flex items-center justify-center font-bold mr-3 mt-1 text-sm">
                      {index + 1}
                    </span>
                    <span className="text-gray-300 text-base leading-relaxed">
                      {step}
                    </span>
                  </li>
                ))}
              </ol>
            </div>
          </aside>
        </div>
      </div>

      {/* Recipe Score Modal */}
      {isScoreModalOpen && scoreForQueryPet && (
        <RecipeScoreModal
          recipe={recipe}
          pet={(() => {
            const pet = getPetsFromLocalStorage(userId).find((p) => p.id === queryPetId);
            if (!pet) return null;
            return {
              id: pet.id,
              name: getRandomName(pet.names),
              type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
              breed: pet.breed,
              age: pet.age === 'baby' ? 0.5 : pet.age === 'young' ? 2 : pet.age === 'adult' ? 5 : 10,
              weight: parseFloat(pet.weight) || (pet.type === 'dogs' ? 25 : pet.type === 'cats' ? 10 : 5),
              activityLevel: 'moderate' as const,
              healthConcerns: pet.healthConcerns || [],
              dietaryRestrictions: pet.allergies || []
            };
          })()}
          onClose={() => setIsScoreModalOpen(false)}
        />
      )}

      {/* One-Click Checkout Modal */}
      {recipe && (
        <OneClickCheckoutModal
          isOpen={isCheckoutOpen}
          onClose={() => setIsCheckoutOpen(false)}
          items={(vettedRecipe?.ingredients || recipe.ingredients || [])
            .filter((ing: any) => ing.asinLink)
            .map((ing: any) => ({
              id: ing.id,
              name: ing.name,
              asinLink: ensureSellerId(ing.asinLink),
              amount: ing.amount,
              asin: extractASIN(ing.asinLink)
            }))}
          recipeName={recipe.name}
          userId={userId}
        />
      )}
    </div>
  );
}
</file>

<file path="app/recipes/recommended/[id]/page.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';
import type { Recipe, Pet } from '@/lib/types';
import RecipeCard from '@/components/RecipeCard';
import {
  calculateEnhancedCompatibility,
  calibrateScoresForPet,
  type Pet as EnhancedPet,
} from '@/lib/utils/enhancedCompatibilityScoring';

const SIMULATED_USER_ID = 'clerk_simulated_user_id_123';

interface Pet {
  id: string;
  name: string;
  type: string;
  breed: string;
  age: string;
  healthConcerns: string[];
  mealPlan: string[];
  savedRecipes?: string[];
  names?: string[];
  weight?: string | number;
  weightKg?: number;
  dietaryRestrictions?: string[];
  allergies?: string[];
  dislikes?: string[];
}

const getPetsFromLocalStorage = (userId: string): Pet[] => {
  if (typeof window === 'undefined') return [];
  const stored = localStorage.getItem(`pets_${userId}`);
  if (!stored) return [];
  try {
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
};

export default function RecommendedRecipesPage() {
  const params = useParams();
  const petId = params.id as string;

  const [pet, setPet] = useState<Pet | null>(null);
  const [loading, setLoading] = useState(true);

  // Convert pet data to enhanced compatibility format
  const enhancedPet: EnhancedPet | null = pet ? {
    id: pet.id,
    name: pet.name,
    type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
    breed: pet.breed,
    age: pet.age === 'baby' ? 0.5 : pet.age === 'young' ? 2 : pet.age === 'adult' ? 5 : 10, // Convert to years
    weight: 25, // Default to 25 lbs since weight isn't stored in this format
    activityLevel: 'moderate' as const, // Default activity level
    healthConcerns: pet.healthConcerns || [],
    dietaryRestrictions: [] // Not available in current pet format
  } : null;

  useEffect(() => {
    if (petId) {
      const userId = SIMULATED_USER_ID;
      const pets = getPetsFromLocalStorage(userId);
      const foundPet = pets.find((p) => p.id === petId) || null;
      setPet(foundPet);
      setLoading(false);
    }
  }, [petId]);

  const scoredRecipes = useMemo(() => {
    if (!pet) return [];

    // Debug logging removed - use logger if needed

    // Calculate compatibility scores for all recipes against this pet using enhanced scoring
    const scored = recipes.map((recipe) => {
      if (!enhancedPet) return { recipe, score: null };
      
      try {
        const enhanced = calculateEnhancedCompatibility(recipe, enhancedPet);
        return {
          recipe,
          score: {
            compatibilityScore: enhanced.overallScore,
            stars: Math.round(enhanced.overallScore / 20),
            reasoning: {
              goodMatches: enhanced.detailedBreakdown.healthBenefits,
              conflicts: enhanced.detailedBreakdown.warnings,
            },
            enhancedScore: enhanced, // keep for detail view
          }
        };
      } catch (error) {
        console.error('Error calculating compatibility:', error);
        return { recipe, score: null };
      }
    });

    // Apply per-pet calibration to normalize scores
    // This ensures 100% is rare and meaningful, and scores are spread across the range
    const validScored = scored.filter(s => s.score !== null && enhancedPet);
    if (validScored.length > 0 && enhancedPet) {
      
      const recipesToCalibrate = validScored.map(s => s.recipe);
      const calibratedScores = calibrateScoresForPet(recipesToCalibrate, enhancedPet);
      
      // Update scores with calibrated values
      validScored.forEach((item) => {
        const calibratedScore = calibratedScores.get(item.recipe.id);
        if (calibratedScore !== undefined && item.score) {
          item.score.compatibilityScore = calibratedScore;
          item.score.stars = Math.round(calibratedScore / 20);
          // Update enhanced score if it exists
          if (item.score.enhancedScore) {
            item.score.enhancedScore.overallScore = calibratedScore;
          }
        }
      });
    }

    // Debug logging removed - use logger if needed

    // Sort by compatibility score (highest first)
    const sorted = scored.sort((a, b) => {
      if (!a.score || !b.score) return 0;
      return b.score.compatibilityScore - a.score.compatibilityScore;
    });

    // Debug logging removed - use logger if needed

    return sorted;
  }, [pet]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <p className="text-gray-600">Loading recommended recipes...</p>
      </div>
    );
  }

  if (!pet) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white p-8 rounded-xl shadow text-center space-y-4">
          <p className="text-xl font-semibold text-gray-800">Pet not found.</p>
          <Link href="/profile" className="text-primary-600 font-semibold">
            Back to Profiles
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      <div className="max-w-7xl mx-auto px-4">
        <div className="flex items-center gap-4 mb-8">
          <Link
            href={`/profile/pet/${pet.id}/meal-plan`}
            className="inline-flex items-center gap-2 text-gray-600 hover:text-primary-600 font-medium"
          >
            <ArrowLeft size={20} />
            Back to Meal Plan
          </Link>
        </div>

        <div className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Best Matches for {pet.name}
          </h1>
          <p className="text-gray-600 mb-4">
            Recipes ranked by how well they match {pet.name}'s nutritional needs, breed, age, and health concerns.
            Higher compatibility scores indicate better suitability.
          </p>

          {/* Debug Info */}
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <h3 className="font-semibold text-yellow-800 mb-2">Debug Info:</h3>
            <p className="text-sm text-yellow-700">
              Pet Type: <strong>{pet.type}</strong> |
              Total Recipes: <strong>{recipes?.length || 0}</strong> |
              Scored Recipes: <strong>{scoredRecipes.length}</strong> |
              Recipes with Score {'>'} 0: <strong>{scoredRecipes.filter(s => s.score?.compatibilityScore && s.score.compatibilityScore > 0).length}</strong>
            </p>
            {scoredRecipes.length > 0 && (
              <p className="text-sm text-yellow-700 mt-1">
                Top Score: <strong>{scoredRecipes[0]?.score?.compatibilityScore || 0}%</strong> |
                Sample Recipe: <strong>{scoredRecipes[0]?.recipe?.name} ({scoredRecipes[0]?.recipe?.category})</strong>
              </p>
            )}
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {scoredRecipes.slice(0, 50).map(({ recipe }) => (
            <RecipeCard
              key={recipe.id}
              recipe={recipe}
              pet={pet}
            />
          ))}
        </div>

        {scoredRecipes.length > 50 && (
          <div className="text-center mt-8">
            <p className="text-gray-600">
              Showing top 50 best compatibility matches. There are {scoredRecipes.length - 50} more recipes available.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/robots.ts">
import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  const baseUrl = 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app';
  
  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: [
          '/api/',
          '/profile/',
          '/sign-in/',
          '/sign-up/',
          '/_next/',
          '/admin/',
          '*.json',
          '/dashboard/private',
        ],
      },
      {
        userAgent: 'Googlebot',
        allow: '/',
        disallow: ['/api/', '/profile/', '/sign-in/', '/sign-up/'],
      },
      {
        userAgent: 'Googlebot-Image',
        allow: '/',
      },
    ],
    sitemap: `${baseUrl}/sitemap.xml`,
    host: baseUrl,
  };
}
</file>

<file path="app/sign-in/[[...sign-in]]/page.tsx">
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-50">
      <SignIn />
    </div>
  );
}
</file>

<file path="app/sign-up/[[...sign-up]]/page.tsx">
import { SignUp } from "@clerk/nextjs";

export default function Page() {
  return (
    <div className="flex items-center justify-center min-h-screen">
      <SignUp />
    </div>
  );
}
</file>

<file path="app/sitemap.ts">
import { MetadataRoute } from 'next';

// Dynamic sitemap generation for Next.js
export default function sitemap(): MetadataRoute.Sitemap {
  const baseUrl = 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app';
  
  // Static pages
  const routes = [
    '',
    '/about',
    '/contact',
    '/faq',
    '/privacy',
    '/subscribe',
    '/nutrition-guide',
    '/meal-plans',
    '/forum',
    '/forum/gallery',
    '/blog',
    '/dashboard',
  ].map((route) => ({
    url: `${baseUrl}${route}`,
    lastModified: new Date(),
    changeFrequency: route === '' ? 'daily' as const : 'weekly' as const,
    priority: route === '' ? 1.0 : 0.8,
  }));

  // Pet category pages
  const categories = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'].map((category) => ({
    url: `${baseUrl}/category/${category}`,
    lastModified: new Date(),
    changeFrequency: 'weekly' as const,
    priority: 0.9,
  }));

  // Blog posts (if you have them)
  const blogPosts = [
    'homemade-dog-food-recipes',
    'cat-nutrition-guide',
    'bird-diet-essentials',
    'reptile-meal-prep',
    'small-pet-feeding-tips',
  ].map((slug) => ({
    url: `${baseUrl}/blog/${slug}`,
    lastModified: new Date(),
    changeFrequency: 'monthly' as const,
    priority: 0.7,
  }));

  return [...routes, ...categories, ...blogPosts];
}
</file>

<file path="app/subscribe/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { Mail, CheckCircle } from 'lucide-react';

export default function SubscribePage() {
  const [email, setEmail] = useState('');
  const [petType, setPetType] = useState('');
  const [submitted, setSubmitted] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // Here you would send to your backend/email service
    setSubmitted(true);
  };

  if (submitted) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
          <CheckCircle className="text-green-600 mx-auto mb-4" size={64} />
          <h2 className="text-3xl font-bold text-gray-900 mb-4">
            You're Subscribed!
          </h2>
          <p className="text-gray-600 mb-6">
            Check your inbox for a welcome email with exclusive recipes and tips.
          </p>
          <Link
            href="/"
            className="inline-block px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors"
          >
            Back to Home
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-primary-600 to-primary-800 text-white py-16 px-4">
        <div className="max-w-4xl mx-auto text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            Subscribe to ThePetPantry
          </h1>
          <p className="text-xl text-primary-100">
            Get exclusive recipes, nutrition tips, and special offers
          </p>
        </div>
      </div>

      <div className="max-w-2xl mx-auto px-4 py-12">
        {/* Benefits */}
        <div className="bg-white rounded-lg shadow-md p-8 mb-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
            What You'll Get
          </h2>
          <ul className="space-y-4">
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-600 flex-shrink-0 mt-1" size={24} />
              <div>
                <h3 className="font-bold text-gray-900">Weekly Recipe Updates</h3>
                <p className="text-gray-600">New recipes delivered to your inbox every week</p>
              </div>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-600 flex-shrink-0 mt-1" size={24} />
              <div>
                <h3 className="font-bold text-gray-900">Nutrition Tips</h3>
                <p className="text-gray-600">Expert advice on pet nutrition and health</p>
              </div>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-600 flex-shrink-0 mt-1" size={24} />
              <div>
                <h3 className="font-bold text-gray-900">Exclusive Discounts</h3>
                <p className="text-gray-600">Subscriber-only deals on meal plans</p>
              </div>
            </li>
            <li className="flex items-start gap-3">
              <CheckCircle className="text-primary-600 flex-shrink-0 mt-1" size={24} />
              <div>
                <h3 className="font-bold text-gray-900">Early Access</h3>
                <p className="text-gray-600">Be first to try new recipes and features</p>
              </div>
            </li>
          </ul>
        </div>

        {/* Subscribe Form */}
        <div className="bg-white rounded-lg shadow-md p-8">
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label htmlFor="email" className="block text-sm font-semibold text-gray-700 mb-2">
                Email Address
              </label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                <input
                  type="email"
                  id="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="your.email@example.com"
                  className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                />
              </div>
            </div>

            <div>
              <label htmlFor="petType" className="block text-sm font-semibold text-gray-700 mb-2">
                What type of pet do you have?
              </label>
              <select
                id="petType"
                required
                value={petType}
                onChange={(e) => setPetType(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                <option value="">Select your pet type</option>
                <option value="dog">Dog</option>
                <option value="cat">Cat</option>
                <option value="bird">Bird</option>
                <option value="reptile">Reptile</option>
                <option value="pocket-pet">Pocket Pet</option>
                <option value="multiple">Multiple Pets</option>
              </select>
            </div>

            <button
              type="submit"
              className="w-full px-6 py-4 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors text-lg"
            >
              Subscribe Now
            </button>

            <p className="text-sm text-gray-500 text-center">
              We respect your privacy. Unsubscribe anytime. No spam, we promise! üêæ
            </p>
          </form>
        </div>

        {/* Social Proof */}
        <div className="mt-12 text-center">
          <p className="text-gray-600 mb-4">
            Join <strong>10,000+</strong> pet parents who trust ThePetPantry
          </p>
          <div className="flex justify-center gap-2">
            {[1, 2, 3, 4, 5].map((star) => (
              <svg
                key={star}
                className="w-6 h-6 text-yellow-400 fill-current"
                viewBox="0 0 20 20"
              >
                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
              </svg>
            ))}
          </div>
          <p className="text-sm text-gray-600 mt-2">
            4.9/5 average rating from our community
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="check-package-sizes.mjs">
// Check all package sizes in product-prices.json for unrealistic values
import fs from 'fs';

const data = JSON.parse(fs.readFileSync('./data/product-prices.json', 'utf8'));

console.log('=== CHECKING PACKAGE SIZES ===\n');

// Convert quantity to grams for comparison
function quantityToGrams(quantity) {
  if (!quantity) return null;
  
  const match = quantity.match(/(\d+(?:\.\d+)?)\s*(\w+)/);
  if (!match) return null;
  
  const amount = parseFloat(match[1]);
  const unit = match[2].toLowerCase();
  
  if (unit === 'oz' || unit === 'ounce' || unit === 'ounces') {
    return amount * 28.3495;
  }
  if (unit === 'lb' || unit === 'pound' || unit === 'pounds') {
    return amount * 453.592;
  }
  if (unit === 'g' || unit === 'gram' || unit === 'grams') {
    return amount;
  }
  if (unit === 'kg' || unit === 'kilogram' || unit === 'kilograms') {
    return amount * 1000;
  }
  
  // For non-weight units (head, bunch, etc.), return a flag
  return -1;
}

// Group by size categories
const verySmall = []; // < 50g
const small = []; // 50-200g
const medium = []; // 200-500g
const large = []; // > 500g
const nonWeight = []; // head, bunch, etc.

data.forEach(item => {
  const grams = quantityToGrams(item.quantity);
  
  if (grams === null) {
    console.log(`‚ö†Ô∏è  ${item.ingredient}: No quantity specified`);
  } else if (grams === -1) {
    nonWeight.push({ ingredient: item.ingredient, quantity: item.quantity });
  } else if (grams < 50) {
    verySmall.push({ ingredient: item.ingredient, quantity: item.quantity, grams });
  } else if (grams < 200) {
    small.push({ ingredient: item.ingredient, quantity: item.quantity, grams });
  } else if (grams < 500) {
    medium.push({ ingredient: item.ingredient, quantity: item.quantity, grams });
  } else {
    large.push({ ingredient: item.ingredient, quantity: item.quantity, grams });
  }
});

console.log('\nüî¥ VERY SMALL PACKAGES (< 50g) - LIKELY ISSUES:');
console.log('='.repeat(60));
verySmall.sort((a, b) => a.grams - b.grams).forEach(item => {
  console.log(`  ${item.ingredient.padEnd(30)} ${item.quantity.padEnd(15)} (${item.grams.toFixed(1)}g)`);
});

console.log('\nüü° SMALL PACKAGES (50-200g) - CHECK THESE:');
console.log('='.repeat(60));
small.sort((a, b) => a.grams - b.grams).forEach(item => {
  console.log(`  ${item.ingredient.padEnd(30)} ${item.quantity.padEnd(15)} (${item.grams.toFixed(1)}g)`);
});

console.log('\nüü¢ MEDIUM PACKAGES (200-500g):');
console.log('='.repeat(60));
console.log(`  ${medium.length} items`);

console.log('\n‚úÖ LARGE PACKAGES (> 500g):');
console.log('='.repeat(60));
console.log(`  ${large.length} items`);

console.log('\nüì¶ NON-WEIGHT UNITS (head, bunch, etc.):');
console.log('='.repeat(60));
nonWeight.forEach(item => {
  console.log(`  ${item.ingredient.padEnd(30)} ${item.quantity}`);
});

console.log('\n\n=== SUMMARY ===');
console.log(`Total items: ${data.length}`);
console.log(`Very small (< 50g): ${verySmall.length} ‚ö†Ô∏è`);
console.log(`Small (50-200g): ${small.length}`);
console.log(`Medium (200-500g): ${medium.length}`);
console.log(`Large (> 500g): ${large.length}`);
console.log(`Non-weight units: ${nonWeight.length}`);

if (verySmall.length > 0) {
  console.log('\n‚ö†Ô∏è  WARNING: Found very small packages that may cause meal estimation issues!');
}
</file>

<file path="components/ABTestDashboard.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { BarChart3, RefreshCw, Trophy, TrendingUp } from 'lucide-react';
import { getConversionStats, type ButtonVariant } from '@/lib/utils/abTesting';

// Admin dashboard to view A/B test results in-app
export default function ABTestDashboard() {
  const [stats, setStats] = useState<any>(null);
  const [isVisible, setIsVisible] = useState(false);

  const loadStats = () => {
    setStats(getConversionStats());
  };

  useEffect(() => {
    loadStats();
  }, []);

  if (!isVisible) {
    return (
      <button
        onClick={() => setIsVisible(true)}
        className="fixed bottom-4 right-4 bg-green-700 hover:bg-green-600 text-white p-3 rounded-full shadow-lg z-40 border-2 border-orange-500"
        title="View A/B Test Results"
      >
        <BarChart3 size={24} />
      </button>
    );
  }

  if (!stats) {
    return null;
  }

  // Calculate totals and winner
  const variants = Object.entries(stats) as [ButtonVariant, any][];
  const totalClicks = variants.reduce((sum, [_, data]) => sum + data.total, 0);
  const winner = variants.reduce((best, current) => 
    current[1].total > best[1].total ? current : best
  );

  const getVariantLabel = (id: ButtonVariant) => {
    const labels = {
      'shop-now': 'Shop Now',
      'buy-amazon': 'Buy on Amazon',
      'get-ingredients': 'Get Ingredients'
    };
    return labels[id] || id;
  };

  const getPercentage = (count: number) => {
    if (totalClicks === 0) return 0;
    return ((count / totalClicks) * 100).toFixed(1);
  };

  return (
    <div className="fixed bottom-4 right-4 bg-surface border-2 border-orange-500/50 rounded-2xl shadow-2xl p-6 w-96 z-50 max-h-[80vh] overflow-y-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-4 pb-3 border-b border-surface-highlight">
        <h3 className="text-xl font-bold text-white flex items-center gap-2">
          <BarChart3 className="text-orange-400" size={24} />
          A/B Test Results
        </h3>
        <div className="flex gap-2">
          <button
            onClick={loadStats}
            className="text-gray-400 hover:text-white p-1"
            title="Refresh"
          >
            <RefreshCw size={20} />
          </button>
          <button
            onClick={() => setIsVisible(false)}
            className="text-gray-400 hover:text-white p-1"
            title="Close"
          >
            √ó
          </button>
        </div>
      </div>

      {/* Summary */}
      <div className="mb-6 p-4 bg-green-900/20 border border-green-700/30 rounded-lg">
        <div className="text-center">
          <div className="text-3xl font-black text-green-400 mb-1">
            {totalClicks}
          </div>
          <div className="text-sm text-gray-400">Total Clicks Tracked</div>
        </div>
      </div>

      {/* Winner Badge */}
      {totalClicks > 10 && (
        <div className="mb-4 p-3 bg-gradient-to-r from-orange-500/20 to-yellow-500/20 border border-orange-500/50 rounded-lg">
          <div className="flex items-center gap-2 text-orange-400 font-bold text-sm">
            <Trophy size={20} />
            <span>Current Leader: {getVariantLabel(winner[0])}</span>
          </div>
          <div className="text-xs text-gray-400 mt-1">
            {winner[1].total} clicks ({getPercentage(winner[1].total)}%)
          </div>
        </div>
      )}

      {/* Variant Breakdown */}
      <div className="space-y-3">
        {variants.map(([variant, data]) => {
          const percentage = getPercentage(data.total);
          const isWinner = variant === winner[0] && totalClicks > 10;
          
          return (
            <div
              key={variant}
              className={`p-4 rounded-lg border-2 transition-all ${
                isWinner
                  ? 'bg-orange-900/20 border-orange-500/50'
                  : 'bg-surface-highlight border-surface-highlight'
              }`}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold text-white flex items-center gap-2">
                  {isWinner && <Trophy size={16} className="text-orange-400" />}
                  {getVariantLabel(variant)}
                </div>
                <div className="text-lg font-bold text-orange-400">
                  {data.total}
                </div>
              </div>
              
              {/* Progress Bar */}
              <div className="w-full bg-surface rounded-full h-2 mb-2">
                <div
                  className={`h-2 rounded-full transition-all ${
                    isWinner ? 'bg-orange-500' : 'bg-gray-600'
                  }`}
                  style={{ width: `${percentage}%` }}
                />
              </div>
              
              <div className="flex items-center justify-between text-xs text-gray-400">
                <span>{percentage}% of total clicks</span>
                {isWinner && (
                  <span className="flex items-center gap-1 text-orange-400">
                    <TrendingUp size={12} />
                    Leading
                  </span>
                )}
              </div>
              
              {/* Context Breakdown */}
              {Object.keys(data.byContext).length > 0 && (
                <div className="mt-2 pt-2 border-t border-surface text-xs">
                  <div className="text-gray-500 mb-1">By context:</div>
                  <div className="flex gap-2 flex-wrap">
                    {Object.entries(data.byContext).map(([context, count]: [string, any]) => (
                      <span
                        key={context}
                        className="bg-surface px-2 py-1 rounded text-gray-400"
                      >
                        {context}: {count}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Action Buttons */}
      <div className="mt-6 pt-4 border-t border-surface-highlight space-y-2">
        <button
          onClick={() => {
            if (confirm('Reset all A/B test data?')) {
              localStorage.removeItem('ab_button_clicks');
              loadStats();
            }
          }}
          className="w-full py-2 px-4 bg-red-600/20 hover:bg-red-600/30 border border-red-500/50 text-red-400 rounded-lg text-sm font-semibold transition-colors"
        >
          Reset Test Data
        </button>
        
        <button
          onClick={() => {
            if (confirm('Change your variant? (will refresh page)')) {
              localStorage.removeItem('ab_button_variant');
              window.location.reload();
            }
          }}
          className="w-full py-2 px-4 bg-green-600/20 hover:bg-green-600/30 border border-green-500/50 text-green-400 rounded-lg text-sm font-semibold transition-colors"
        >
          Change My Variant
        </button>
      </div>

      {/* Instructions */}
      <div className="mt-4 p-3 bg-surface-lighter rounded-lg">
        <p className="text-xs text-gray-500 leading-relaxed">
          <strong className="text-gray-400">How it works:</strong> Each visitor is randomly assigned one of 3 button text variants. 
          We track which variant gets more clicks to find the best performing copy.
        </p>
        <p className="text-xs text-gray-500 mt-2">
          <strong className="text-gray-400">Console:</strong> Run <code className="bg-surface px-1 rounded">logABTestResults()</code> for details.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="components/BadgeToggle.tsx">
// components/BadgeToggle.tsx
// Badge toggle component for demonstrating badges in pet profile

'use client';

import { useState, useEffect } from 'react';
import { BadgeType, BadgeTier, type PetBadges } from '@/lib/types/badges';
import { getPetBadges, unlockBadge, removeBadge } from '@/lib/utils/badgeStorage';
import { BADGE_DEFINITIONS } from '@/lib/data/badgeDefinitions';
import Image from 'next/image';

interface BadgeToggleProps {
  petId: string;
  userId: string;
  onBadgeChange?: () => void;
}

export default function BadgeToggle({ petId, userId, onBadgeChange }: BadgeToggleProps) {
  const [badges, setBadges] = useState<PetBadges>({ badges: [] });
  const [isExpanded, setIsExpanded] = useState(false);

  useEffect(() => {
    if (!petId || !userId) return;
    const loadedBadges = getPetBadges(userId, petId);
    setBadges(loadedBadges);
  }, [petId, userId]);

  const handleToggleBadge = (badgeType: BadgeType, tier?: BadgeTier) => {
    const existingBadge = badges.badges.find(b => b.type === badgeType);
    
    if (existingBadge) {
      // Remove badge
      removeBadge(userId, petId, badgeType);
    } else {
      // Add badge
      unlockBadge(userId, petId, badgeType, tier);
    }
    
    // Refresh badges
    const updatedBadges = getPetBadges(userId, petId);
    setBadges(updatedBadges);
    
    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('badgesUpdated'));
    
    // Trigger refresh in parent
    if (onBadgeChange) {
      onBadgeChange();
    }
  };

  const handleToggleTier = (badgeType: BadgeType, tier: BadgeTier) => {
    const existingBadge = badges.badges.find(b => b.type === badgeType);
    
    if (existingBadge && existingBadge.tier === tier) {
      // Remove badge if clicking the same tier
      removeBadge(userId, petId, badgeType);
    } else {
      // Unlock with specific tier
      unlockBadge(userId, petId, badgeType, tier);
    }
    
    // Refresh badges
    const updatedBadges = getPetBadges(userId, petId);
    setBadges(updatedBadges);
    
    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('badgesUpdated'));
    
    if (onBadgeChange) {
      onBadgeChange();
    }
  };

  const hasBadge = (badgeType: BadgeType, tier?: BadgeTier): boolean => {
    const badge = badges.badges.find(b => b.type === badgeType);
    if (!badge) return false;
    if (tier) {
      return badge.tier === tier;
    }
    return true;
  };

  return (
    <div className="mt-3">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="text-xs text-orange-400 hover:text-orange-300 underline mb-2"
      >
        {isExpanded ? '‚ñº Hide Badge Demo' : '‚ñ∂ Demo Badges'}
      </button>
      
      {isExpanded && (
        <div className="mt-2 space-y-3 p-3 bg-surface rounded border border-surface-highlight">
          <p className="text-xs text-gray-400 mb-2">Toggle badges on/off to see them displayed:</p>
          
          {Object.values(BADGE_DEFINITIONS).map((def) => {
            const badge = badges.badges.find(b => b.type === def.type);
            const isUnlocked = badge !== undefined;
            
            if (def.isProgressive && def.tiers) {
              // Progressive badge with tiers
              return (
                <div key={def.type} className="pb-2 border-b border-surface-highlight last:border-b-0">
                  <div className="flex items-center gap-2 mb-2">
                    <input
                      type="checkbox"
                      checked={isUnlocked}
                      onChange={() => handleToggleBadge(def.type)}
                      className="w-4 h-4"
                    />
                    <label className="text-xs font-semibold text-gray-300 flex-1">
                      {def.name}
                    </label>
                    {isUnlocked && (
                      <span className="text-xs text-gray-500">
                        ({badge?.tier || 'bronze'})
                      </span>
                    )}
                  </div>
                  
                  {isUnlocked && (
                    <div className="ml-6 space-y-1">
                      <p className="text-xs text-gray-400 mb-1">Tiers:</p>
                      <div className="flex flex-wrap gap-2">
                        {def.tiers.map((tierDef) => (
                          <button
                            key={tierDef.tier}
                            onClick={() => handleToggleTier(def.type, tierDef.tier)}
                            className={`flex items-center gap-1 px-2 py-1 rounded text-xs border transition-colors ${
                              hasBadge(def.type, tierDef.tier)
                                ? 'bg-orange-900/30 border-orange-500/50 text-orange-300'
                                : 'bg-surface-highlight border-surface-highlight text-gray-400 hover:border-gray-500'
                            }`}
                          >
                            <div className="w-4 h-4 rounded bg-surface-highlight border border-white/10 flex items-center justify-center">
                              {hasBadge(def.type, tierDef.tier) && (
                                <span className="text-xs">‚úì</span>
                              )}
                            </div>
                            {tierDef.name}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            } else {
              // Single-tier badge
              return (
                <div key={def.type} className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={isUnlocked}
                    onChange={() => handleToggleBadge(def.type)}
                    className="w-4 h-4"
                  />
                  <div className="w-6 h-6 rounded bg-surface-highlight border border-white/10 flex items-center justify-center flex-shrink-0">
                    <Image
                      src={def.iconPath}
                      alt={def.name}
                      width={20}
                      height={20}
                      className="object-contain no-invert-badge"
                      unoptimized
                      onError={(e) => {
                        (e.target as HTMLImageElement).style.display = 'none';
                      }}
                    />
                  </div>
                  <label className="text-xs text-gray-300 flex-1 cursor-pointer">
                    {def.name}
                  </label>
                </div>
              );
            }
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/CompatibilityBadge.tsx">
import React from 'react';

import { getScoreTier, type ScoreTier } from '@/lib/utils/enhancedCompatibilityScoring';

interface CompatibilityBadgeProps {
  compatibility?: 'excellent' | 'good' | 'fair' | 'poor';
  score: number;
  className?: string;
  isGoldStandard?: boolean;
  hasPerfectMatches?: boolean;
}

export const CompatibilityBadge: React.FC<CompatibilityBadgeProps> = ({
  compatibility,
  score,
  className = '',
  isGoldStandard = false,
  hasPerfectMatches = true
}) => {
  // Use scoring tier system for better UX
  const tier = getScoreTier(score);
  
  // Determine compatibility from score if not provided
  const effectiveCompatibility = compatibility || (
    score >= 95 ? 'excellent' :
    score >= 85 ? 'good' :
    score >= 70 ? 'fair' : 'poor'
  );
  
  const getBadgeStyles = () => {
    switch (effectiveCompatibility) {
      case 'excellent':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'good':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'fair':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'poor':
        return 'bg-red-100 text-red-800 border-red-200';
      default:
        return 'bg-gray-100 text-gray-800 border-gray-200';
    }
  };

  const getCompatibilityLabel = (): string => {
    if (score >= 95 && isGoldStandard) {
      return 'Perfect Match';
    } else if (score >= 90) {
      return 'Excellent Match';
    } else if (score >= 85) {
      return 'Great Match';
    } else if (score >= 80) {
      return 'Good Match';
    } else if (score >= 70) {
      return 'Acceptable Match';
    } else {
      return hasPerfectMatches 
        ? 'Below Average Match'
        : 'Best Available Match';
    }
  };

  const getScoreSubtext = (): string => {
    if (!hasPerfectMatches && score < 90) {
      return ' (no perfect matches for this profile yet)';
    }
    if (isGoldStandard) {
      return ' (meets all requirements)';
    }
    return '';
  };

  return (
    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${getBadgeStyles()} ${className}`}>
      <span>{score}% {getCompatibilityLabel()}{getScoreSubtext()}</span>
    </div>
  );
};
</file>

<file path="components/CompatibilityPanel.tsx">
'use client';

import { AlertTriangle, CheckCircle, XCircle, Target, Info } from 'lucide-react';
import { MealAnalysis } from '@/lib/analyzeCustomMeal';

interface CompatibilityPanelProps {
  analysis: MealAnalysis | null;
  isAnalyzing: boolean;
  totalGrams: number;
  ingredientCount: number;
}

export default function CompatibilityPanel({
  analysis,
  isAnalyzing,
  totalGrams,
  ingredientCount
}: CompatibilityPanelProps) {
  if (isAnalyzing) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <div className="flex items-center justify-center gap-3">
          <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"></div>
          <span className="text-gray-600 text-sm">Analyzing...</span>
        </div>
      </div>
    );
  }

  if (!analysis) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <div className="text-center text-gray-400 text-sm">
          <Info size={24} className="mx-auto mb-2 opacity-50" />
          <p>Add ingredients to see compatibility score</p>
        </div>
      </div>
    );
  }

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600 bg-green-50 border-green-200';
    if (score >= 60) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
    return 'text-red-600 bg-red-50 border-red-200';
  };

  const getScoreIcon = (score: number) => {
    if (score >= 80) return <CheckCircle size={20} className="text-green-600" />;
    if (score >= 60) return <AlertTriangle size={20} className="text-yellow-600" />;
    return <XCircle size={20} className="text-red-600" />;
  };

  return (
    <div className="space-y-4">
      {/* Compatibility Score */}
      <div className={`bg-white rounded-lg border-2 p-6 ${getScoreColor(analysis.score)}`}>
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            {getScoreIcon(analysis.score)}
            <h3 className="font-semibold text-lg">Compatibility Score</h3>
          </div>
          <div className="text-3xl font-bold">{analysis.score}/100</div>
        </div>
        
        {/* Progress Bar */}
        <div className="w-full bg-white/50 rounded-full h-3 mb-2">
          <div
            className={`h-3 rounded-full transition-[width] duration-500 ease-out will-change-[width] ${
              analysis.score >= 80 ? 'bg-green-600' :
              analysis.score >= 60 ? 'bg-yellow-600' :
              'bg-red-600'
            }`}
            style={{ width: `${analysis.score}%` }}
          />
        </div>

        <div className="text-xs opacity-75 mt-2">
          {analysis.score >= 80 && '‚úì Excellent match for your pet'}
          {analysis.score >= 60 && analysis.score < 80 && '‚ö† Good, but could be improved'}
          {analysis.score < 60 && '‚úó Needs adjustments for safety'}
        </div>
      </div>

      {/* Warnings & Safety Alerts */}
      {(analysis.toxicityWarnings.length > 0 || analysis.allergyWarnings.length > 0) && (
        <div className="bg-red-50 rounded-lg border border-red-200 p-4">
          <div className="flex items-center gap-2 mb-2">
            <AlertTriangle size={16} className="text-red-600" />
            <h4 className="font-semibold text-red-900 text-sm">Safety Alerts</h4>
          </div>
          <div className="space-y-1">
            {analysis.toxicityWarnings.slice(0, 3).map((warning, idx) => (
              <div key={idx} className="text-xs text-red-800">
                ‚ö†Ô∏è {warning.message}
              </div>
            ))}
            {analysis.allergyWarnings.slice(0, 2).map((warning, idx) => (
              <div key={idx} className="text-xs text-red-800">
                ‚ö†Ô∏è {typeof warning === 'string' ? warning : warning.message}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Safe Choices Indicator */}
      {analysis.score >= 60 && (
        <div className="bg-green-50 rounded-lg border border-green-200 p-4">
          <div className="flex items-center gap-2 mb-2">
            <CheckCircle size={16} className="text-green-600" />
            <h4 className="font-semibold text-green-900 text-sm">Safe Choices</h4>
          </div>
          <div className="text-xs text-green-800">
            ‚úì All selected ingredients are safe for your pet
          </div>
        </div>
      )}

      {/* Quick Nutrition Summary */}
      <div className="bg-white rounded-lg border border-gray-200 p-4">
        <h4 className="font-semibold text-gray-900 text-sm mb-3">Quick Summary</h4>
        <div className="space-y-2 text-xs">
          <div className="flex justify-between">
            <span className="text-gray-600">Total:</span>
            <span className="font-medium">{totalGrams}g ‚Ä¢ {ingredientCount} ingredients</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Calories:</span>
            <span className="font-medium">
              {((analysis.nutrients as any).kcal ?? (analysis.nutrients as any).calories_kcal ?? (analysis.nutrients as any).energy_kcal ?? 0).toFixed(0)} kcal
            </span>
          </div>
          {analysis.caToPratio && (
            <div className="flex justify-between">
              <span className="text-gray-600">Ca:P Ratio:</span>
              <span className="font-medium">{analysis.caToPratio.toFixed(1)}</span>
            </div>
          )}
        </div>
      </div>

      {/* Suggestions */}
      {analysis.suggestions.length > 0 && (
        <div className="bg-blue-50 rounded-lg border border-blue-200 p-4">
          <h4 className="font-semibold text-blue-900 text-sm mb-2">Suggestions</h4>
          <div className="space-y-1">
            {analysis.suggestions.slice(0, 2).map((suggestion, idx) => (
              <div key={idx} className="text-xs text-blue-800">
                üí° {typeof suggestion === 'string' ? suggestion : suggestion.message}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/ConfirmModal.tsx">
import React from 'react';
import Image from 'next/image';
import { X, AlertTriangle } from 'lucide-react';

interface ConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  message?: string;
  confirmText?: string;
  cancelText?: string;
  isDeleteModal?: boolean;
}

export default function ConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title = 'Confirm Action',
  message = 'Are you sure you want to proceed?',
  confirmText = 'Confirm',
  cancelText = 'Cancel',
  isDeleteModal = false,
}: ConfirmModalProps) {
  
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
      <div 
        className={`rounded-xl shadow-2xl border-3 w-full ${isDeleteModal ? 'border-orange-500 max-w-2xl' : 'border-surface-highlight max-w-md'}`}
        style={isDeleteModal ? { backgroundColor: '#143424' } : {}}
      >
        <div className={`${isDeleteModal ? 'p-10' : 'p-6'}`}>
          <div className="flex items-start gap-6">
            {isDeleteModal && (
              <div className="flex-shrink-0">
                <Image
                  src="/images/emojis/Mascots/Harvest Hamster/HHReaper.jpg"
                  alt="Harvest Hamster"
                  width={240}
                  height={240}
                  className="w-[240px] h-[240px] object-contain mascot-icon mascot-farmer-fluff"
                  unoptimized
                />
              </div>
            )}
            {!isDeleteModal && (
              <div className="flex-shrink-0">
                <AlertTriangle className="w-6 h-6 text-yellow-500" />
              </div>
            )}
            <div className="flex-1">
              <h3 className="text-lg font-semibold text-foreground mb-2">{title}</h3>
              <p className="text-sm text-gray-400">{message}</p>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="flex gap-3 mt-6">
            <button
              onClick={onClose}
              className="flex-1 px-4 py-2 bg-surface-highlight text-foreground rounded-lg hover:bg-surface-lighter transition-colors"
            >
              {cancelText}
            </button>
            <button
              onClick={() => {
                onConfirm();
                onClose();
              }}
              className={`flex-1 px-4 py-2 rounded-lg transition-colors ${
                isDeleteModal
                  ? 'bg-orange-500 text-white hover:bg-orange-600'
                  : 'bg-primary-600 text-white hover:bg-primary-700'
              }`}
            >
              {confirmText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/CostComparison.tsx">
'use client';

interface CostComparisonProps {
  costPerMeal: number;
  totalCost?: number;
  estimatedMeals?: number;
  className?: string;
  exceedsBudget?: boolean; // True if costPerMeal > 4.50
}

export function CostComparison({ costPerMeal, totalCost, estimatedMeals, className = '', exceedsBudget = false }: CostComparisonProps) {
  const commercialCost = 4.50; // Average commercial pet food per meal
  const savings = commercialCost - costPerMeal;
  const savingsPercent = savings > 0 ? Math.round((savings / commercialCost) * 100) : 0;
  
  // Don't render if invalid data
  if (!costPerMeal || costPerMeal <= 0) {
    return null;
  }
  
  return (
    <div className={`bg-gradient-to-r from-green-700/35 to-emerald-700/35 rounded-xl p-6 border-2 border-green-500/65 ${className}`}>
      <h4 className="font-bold text-lg text-green-200 mb-4">üí∞ Cost Comparison</h4>
      
      {/* Budget Warning Banner */}
      {exceedsBudget && (
        <div className="mb-4 bg-yellow-900/60 border-2 border-yellow-500/70 rounded-lg p-3">
          <p className="text-sm font-semibold text-yellow-200">
            ‚ö†Ô∏è This meal exceeds the $4.50 target (${costPerMeal.toFixed(2)}/meal)
          </p>
          <p className="text-xs text-yellow-300 mt-1">
            Consider choosing cheaper ingredient alternatives to reduce cost.
          </p>
        </div>
      )}
      
      <div className="grid md:grid-cols-2 gap-4">
        {/* Homemade */}
        <div className="bg-surface rounded-lg p-4 border border-green-700/30">
          <p className="text-sm text-gray-400 mb-2">Homemade (Your Cost)</p>
          <p className="text-3xl font-bold text-green-400">${costPerMeal.toFixed(2)}/meal</p>
          <div className="mt-2 space-y-1">
            <p className="text-xs text-green-300">‚úì Fresh ingredients</p>
            <p className="text-xs text-green-300">‚úì Full control</p>
            <p className="text-xs text-green-300">‚úì Custom nutrition</p>
          </div>
        </div>
        
        {/* Commercial */}
        <div className="bg-surface rounded-lg p-4 border border-gray-700/30">
          <p className="text-sm text-gray-400 mb-2">Commercial Pet Food</p>
          <p className="text-3xl font-bold text-gray-400">${commercialCost.toFixed(2)}/meal</p>
          <p className="text-xs text-gray-500 mt-2">Typical premium brand</p>
        </div>
      </div>
      
      {savings > 0 && (
        <div className="mt-4 bg-green-900/40 border-2 border-green-500/50 rounded-lg p-4 text-center">
          <p className="text-lg font-bold text-green-300">
            You save ${savings.toFixed(2)} per meal ({savingsPercent}%)
          </p>
          <p className="text-sm text-green-200 mt-1">
            That's ${(savings * 30).toFixed(2)} per month!
          </p>
          {estimatedMeals && (
            <p className="text-xs text-green-300 mt-1">
              Total savings from this shopping trip: ${(savings * estimatedMeals).toFixed(2)}
            </p>
          )}
        </div>
      )}
      
      {savings < 0 && (
        <div className="mt-4 bg-yellow-900/40 border-2 border-yellow-500/50 rounded-lg p-4 text-center">
          <p className="text-sm text-yellow-200">
            Your homemade meals cost ${Math.abs(savings).toFixed(2)} more per meal, but you get fresh, customized nutrition!
          </p>
        </div>
      )}
      
      {/* Monthly Projection / Value Breakdown */}
      {totalCost && estimatedMeals && (
        <div className="mt-4 bg-surface rounded-lg p-4 border border-surface-highlight">
          <p className="text-xs font-semibold text-gray-300 mb-3">üìä Value Breakdown:</p>
          <div className="grid grid-cols-3 gap-3 text-xs">
            <div className="text-center">
              <p className="text-gray-400 mb-1">Estimated Meals</p>
              <p className="font-bold text-lg text-green-400">{estimatedMeals}</p>
              <p className="text-gray-500 text-[10px] mt-0.5">from these packages</p>
            </div>
            <div className="text-center">
              <p className="text-gray-400 mb-1">Total Cost</p>
              <p className="font-bold text-lg text-blue-400">${totalCost.toFixed(2)}</p>
              <p className="text-gray-500 text-[10px] mt-0.5">one-time purchase</p>
            </div>
            <div className="text-center">
              <p className="text-gray-400 mb-1">Cost Per Meal</p>
              <p className="font-bold text-lg text-green-400">${costPerMeal.toFixed(2)}</p>
              <p className="text-gray-500 text-[10px] mt-0.5">average</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/CreatePetModal.tsx">
'use client';

import { useState, useEffect, useMemo, useCallback, memo } from 'react';
import { X, Check, ChevronLeft, ChevronRight } from 'lucide-react';
import { getMascotFaceForPetType } from '@/lib/utils/emojiMapping';
import { getBreedNamesForSpecies } from '@/lib/data/speciesBreeds';
import { getHealthConcernsForSpecies } from '@/lib/data/health-concerns';
import type { Pet } from '@/lib/types';

// --- Type Definitions ---
type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
type HealthConcern = string; // Now dynamic based on species
type HealthConcernWithNone = 'none' | HealthConcern;
type ActivityLevel = 'high' | 'medium' | 'low';

interface FormData {
  name: string;
  type: PetCategory | '';
  breed: string;
  weight?: string;
  activityLevel: ActivityLevel | undefined;
  healthConcerns: HealthConcernWithNone[];
  allergies: string[];
  customAllergies: string;
}

interface AddPetModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (pet: Pet) => void;
  editingPet?: Pet | null;
}

// --- Static Data ---
// Health concerns will be dynamically generated based on species

const initialFormData: FormData = {
  name: '',
  type: '',
  breed: '',
  weight: '',
  activityLevel: undefined as ActivityLevel | undefined,
  healthConcerns: [],
  allergies: [],
  customAllergies: '',
};

// --- Species-Specific Allergen Options ---
function getAllergenOptionsForSpecies(species: PetCategory | ''): Array<{ value: string; label: string }> {
  if (!species) return [];

  const allergens: Record<PetCategory, Array<{ value: string; label: string }>> = {
    'dogs': [
      { value: 'chicken', label: 'Chicken' },
      { value: 'beef', label: 'Beef' },
      { value: 'pork', label: 'Pork' },
      { value: 'fish', label: 'Fish' },
      { value: 'lamb', label: 'Lamb' },
      { value: 'turkey', label: 'Turkey' },
      { value: 'duck', label: 'Duck' },
      { value: 'rabbit', label: 'Rabbit' },
      { value: 'venison', label: 'Venison' },
      { value: 'dairy', label: 'Dairy' },
      { value: 'egg', label: 'Eggs' },
      { value: 'wheat', label: 'Wheat' },
      { value: 'corn', label: 'Corn' },
      { value: 'soy', label: 'Soy' },
      { value: 'rice', label: 'Rice' },
      { value: 'peanut', label: 'Peanuts' },
    ],
    'cats': [
      { value: 'chicken', label: 'Chicken' },
      { value: 'beef', label: 'Beef' },
      { value: 'pork', label: 'Pork' },
      { value: 'fish', label: 'Fish' },
      { value: 'lamb', label: 'Lamb' },
      { value: 'turkey', label: 'Turkey' },
      { value: 'duck', label: 'Duck' },
      { value: 'rabbit', label: 'Rabbit' },
      { value: 'dairy', label: 'Dairy' },
      { value: 'egg', label: 'Eggs' },
      { value: 'wheat', label: 'Wheat' },
      { value: 'corn', label: 'Corn' },
      { value: 'soy', label: 'Soy' },
    ],
    'birds': [
      { value: 'peanut', label: 'Peanuts' },
      { value: 'sunflower-seeds', label: 'Sunflower Seeds' },
      { value: 'millet', label: 'Millet' },
      { value: 'corn', label: 'Corn' },
      { value: 'wheat', label: 'Wheat' },
      { value: 'soy', label: 'Soy' },
      { value: 'egg', label: 'Eggs' },
      { value: 'dairy', label: 'Dairy' },
      { value: 'chocolate', label: 'Chocolate' },
      { value: 'avocado', label: 'Avocado' },
    ],
    'reptiles': [
      { value: 'crickets', label: 'Crickets' },
      { value: 'mealworms', label: 'Mealworms' },
      { value: 'waxworms', label: 'Waxworms' },
      { value: 'superworms', label: 'Superworms' },
      { value: 'dubia-roaches', label: 'Dubia Roaches' },
      { value: 'spinach', label: 'Spinach' },
      { value: 'kale', label: 'Kale' },
      { value: 'collard-greens', label: 'Collard Greens' },
      { value: 'dandelion-greens', label: 'Dandelion Greens' },
    ],
    'pocket-pets': [
      { value: 'alfalfa', label: 'Alfalfa' },
      { value: 'timothy-hay', label: 'Timothy Hay' },
      { value: 'wheat', label: 'Wheat' },
      { value: 'corn', label: 'Corn' },
      { value: 'soy', label: 'Soy' },
      { value: 'peanuts', label: 'Peanuts' },
      { value: 'sunflower-seeds', label: 'Sunflower Seeds' },
      { value: 'dairy', label: 'Dairy' },
      { value: 'chocolate', label: 'Chocolate' },
    ],
  };

  return allergens[species] || [];
}

// --- Button Components (Defined Outside) ---
const PetTypeButton = memo(({ petType, isSelected, onClick, mascotSrc, label }: { 
  petType: PetCategory; 
  isSelected: boolean; 
  onClick: () => void;
  mascotSrc: string;
  label: string;
}) => (
  <button
    type="button"
    onClick={onClick}
    className={`flex flex-col items-center justify-center p-3 rounded-xl transition-colors duration-150 ${
      isSelected 
        ? 'bg-primary-900/30 shadow-md' 
        : 'bg-surface-lighter hover:bg-surface-highlight'
    }`}
    style={{ 
      contain: 'layout style paint',
      border: isSelected ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)'
    }}
  >
    <div className="w-12 h-12 rounded-full overflow-hidden mb-2 flex-shrink-0">
      <img
        src={mascotSrc}
        alt={`${petType} mascot`}
        width={48}
        height={48}
        className="w-full h-full object-cover"
        loading="eager"
      />
    </div>
    <span className={`text-xs font-medium ${isSelected ? 'text-primary-400' : 'text-gray-400'}`}>
      {label}
    </span>
  </button>
));
PetTypeButton.displayName = 'PetTypeButton';

const BreedButton = memo(({ breed, isSelected, onClick }: { 
  breed: string; 
  isSelected: boolean; 
  onClick: () => void;
}) => (
  <button
    type="button"
    onClick={onClick}
    className={`p-3 rounded-xl text-sm text-left transition-colors duration-150 ${
      isSelected
        ? 'bg-primary-900/30 text-primary-200 shadow-md'
        : 'bg-surface-lighter text-gray-300 hover:bg-surface-highlight'
    }`}
    style={{ 
      contain: 'layout style paint',
      border: isSelected ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)'
    }}
  >
    {breed}
  </button>
));
BreedButton.displayName = 'BreedButton';

const ActivityButton = memo(({ level, label, isSelected, onClick }: { 
  level: ActivityLevel;
  label: string;
  isSelected: boolean; 
  onClick: () => void;
}) => (
  <button
    type="button"
    onClick={onClick}
    className={`p-3 rounded-xl transition-colors duration-150 ${
      isSelected
        ? 'bg-primary-900/30 text-primary-200 shadow-md'
        : 'bg-surface-lighter text-gray-300 hover:bg-surface-highlight'
    }`}
    style={{ 
      contain: 'layout style paint',
      border: isSelected ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)'
    }}
  >
    {label}
  </button>
));
ActivityButton.displayName = 'ActivityButton';

const HealthConcernButton = memo(({ option, isSelected, isDisabled, onClick }: { 
  option: { value: string; label: string };
  isSelected: boolean;
  isDisabled: boolean;
  onClick: () => void;
}) => (
  <button
    type="button"
    onClick={(e) => {
      e.preventDefault();
      e.stopPropagation();
      if (!isDisabled) {
        onClick();
      }
    }}
    disabled={isDisabled}
    className={`flex items-center justify-between p-4 rounded-xl text-left transition-colors duration-150 ${
      isDisabled ? 'bg-surface text-gray-600 cursor-not-allowed opacity-50' : 'cursor-pointer'
    } ${
      isSelected 
        ? 'bg-primary-900/30 text-primary-200 shadow-md' 
        : 'bg-surface-lighter text-gray-300 hover:bg-surface-highlight'
    }`}
    style={{ 
      contain: 'layout style paint',
      border: isDisabled ? '3px solid rgba(249, 115, 22, 0.2)' : isSelected ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)',
      pointerEvents: isDisabled ? 'none' : 'auto'
    }}
  >
    <span className="font-medium text-sm">{option.label}</span>
    <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${
      isSelected ? 'bg-primary-600 border-primary-600' : 'bg-surface border-gray-500'
    }`}>
      {isSelected && <Check className="w-3 h-3 text-white" />}
    </div>
  </button>
));
HealthConcernButton.displayName = 'HealthConcernButton';

const AllergyButton = memo(({ allergen, isSelected, onClick }: { 
  allergen: { value: string; label: string };
  isSelected: boolean;
  onClick: () => void;
}) => (
  <button
    type="button"
    onClick={onClick}
    className={`flex items-center justify-between p-3 rounded-xl text-left transition-colors duration-150 ${
      isSelected 
        ? 'bg-primary-900/30 text-primary-200 shadow-md' 
        : 'bg-surface-lighter text-gray-300 hover:bg-surface-highlight'
    }`}
    style={{ 
      contain: 'layout style paint',
      border: isSelected ? '3px solid #f97316' : '3px solid rgba(249, 115, 22, 0.5)'
    }}
  >
    <span className="font-medium text-sm">{allergen.label}</span>
    <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${
      isSelected ? 'bg-primary-600 border-primary-600' : 'bg-surface border-gray-500'
    }`}>
      {isSelected && <Check className="w-3 h-3 text-white" />}
    </div>
  </button>
));
AllergyButton.displayName = 'AllergyButton';

// --- Step Components (Defined Outside with Props) ---
const Step1 = memo(({ 
  formData, 
  error,
  typeLabels,
  mascotPaths,
  petTypeHandlers,
  onNameChange,
  onPrevious
}: {
  formData: FormData;
  error: string | null;
  typeLabels: Record<PetCategory, string>;
  mascotPaths: Record<PetCategory, string>;
  petTypeHandlers: Record<PetCategory, () => void>;
  onNameChange: (value: string) => void;
  onPrevious?: () => void;
}) => (
  <div className="space-y-6">
    <h3 className="text-xl font-semibold text-foreground">1. Basic Info</h3>
    
    <div className="space-y-2">
      <label htmlFor="name" className="text-sm font-medium text-gray-300 block">Pet's Name</label>
      <input
        id="name"
        name="name"
        type="text"
        value={formData.name}
        onChange={(e) => onNameChange(e.target.value)}
        placeholder="e.g., Buster"
        autoFocus
        className="w-full px-4 py-2 border border-surface-highlight bg-surface-lighter text-foreground rounded-xl focus:ring-primary-500 focus:border-primary-500 transition duration-150"
        required
      />
    </div>

    <div className="space-y-2">
      <label className="text-sm font-medium text-gray-300 block">Pet Type</label>
      <div className="grid grid-cols-5 gap-3">
        {(['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'] as PetCategory[]).map((petType) => (
          <PetTypeButton
            key={petType}
            petType={petType}
            isSelected={formData.type === petType}
            onClick={petTypeHandlers[petType]}
            mascotSrc={mascotPaths[petType]}
            label={typeLabels[petType]}
          />
        ))}
      </div>
      {!formData.type && (
        <p className="text-xs text-gray-500 mt-1">Please select a pet type</p>
      )}
    </div>

    {error && <p className="text-red-400 text-sm mt-4">{error}</p>}

    {onPrevious && (
      <div className="flex justify-start pt-6 border-t border-surface-highlight">
        <button
          type="button"
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            onPrevious();
          }}
          className="flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-xl hover:bg-gray-700 transition-colors duration-150"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          Previous
        </button>
      </div>
    )}
  </div>
));
Step1.displayName = 'Step1';

const Step2 = memo(({ 
  formData,
  error,
  sortedBreeds,
  onBreedSelect,
  onPrevious
}: {
  formData: FormData;
  error: string | null;
  sortedBreeds: string[];
  onBreedSelect: (breed: string) => void;
  onPrevious?: () => void;
}) => (
  <div className="space-y-6">
    <h3 className="text-xl font-semibold text-foreground">2. Choose Breed</h3>
    <p className="text-sm text-gray-400">Pick the closest match. If unsure, pick "Mixed".</p>

    <div className="grid grid-cols-1 gap-3 max-h-[320px] overflow-y-auto pr-1">
      {sortedBreeds.map((breed) => (
        <BreedButton
          key={breed}
          breed={breed}
          isSelected={formData.breed === breed}
          onClick={() => onBreedSelect(breed)}
        />
      ))}
    </div>

    {error && <p className="text-red-400 text-sm mt-4">{error}</p>}

    {onPrevious && (
      <div className="flex justify-start pt-6 border-t border-surface-highlight">
        <button
          type="button"
          onClick={onPrevious}
          className="flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-xl hover:bg-gray-700 transition-colors duration-150"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          Previous
        </button>
      </div>
    )}
  </div>
));
Step2.displayName = 'Step2';

const Step3 = memo(({ 
  formData,
  onWeightChange,
  onActivitySelect,
  onPrevious
}: {
  formData: FormData;
  onWeightChange: (value: string) => void;
  onActivitySelect: (level: ActivityLevel) => void;
  onPrevious?: () => void;
}) => (
  <div className="space-y-6">
    <h3 className="text-xl font-semibold text-foreground">3. Weight & Activity</h3>
    <p className="text-sm text-gray-400">These are informational only and not yet used for calculations.</p>

    <div className="space-y-2">
      <label htmlFor="weight" className="text-sm font-medium text-gray-300 block">Weight (any format)</label>
      <input
        id="weight"
        name="weight"
        type="text"
        value={formData.weight || ''}
        onChange={(e) => onWeightChange(e.target.value)}
        placeholder="e.g., 2.3 kg or 5 lbs"
        className="w-full px-4 py-2 border border-surface-highlight bg-surface-lighter text-foreground rounded-xl focus:ring-primary-500 focus:border-primary-500 transition duration-150"
      />
    </div>

    <div className="space-y-3">
      <p className="text-sm font-medium text-gray-300">Activity Level</p>
      <div className="grid grid-cols-3 gap-3">
        {(['low', 'medium', 'high'] as ActivityLevel[]).map((level) => (
          <ActivityButton
            key={level}
            level={level}
            label={level === 'low' ? 'Low' : level === 'medium' ? 'Medium' : 'High'}
            isSelected={formData.activityLevel === level}
            onClick={() => onActivitySelect(level)}
          />
        ))}
      </div>
    </div>

    {onPrevious && (
      <div className="flex justify-start pt-6 border-t border-surface-highlight">
        <button
          type="button"
          onClick={onPrevious}
          className="flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-xl hover:bg-gray-700 transition-colors duration-150"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          Previous
        </button>
      </div>
    )}
  </div>
));
Step3.displayName = 'Step3';

const Step4 = memo(({ 
  formData,
  error,
  healthConcernOptions,
  onHealthConcernToggle,
  onSubmit,
  editingPet,
  onPrevious,
  onNext
}: {
  formData: FormData;
  error: string | null;
  healthConcernOptions: Array<{ value: string; label: string }>;
  onHealthConcernToggle: (concern: HealthConcernWithNone) => void;
  onSubmit: () => void;
  editingPet?: Pet | null;
  onPrevious?: () => void;
  onNext?: () => void;
}) => (
  <div className="space-y-6">
    <h3 className="text-xl font-semibold text-foreground">4. Health Concerns</h3>
    <p className="text-sm text-gray-400">Select any concerns your pet currently has. This will tailor their meal plan recommendations.</p>
    
    <div className="grid grid-cols-2 gap-4" style={{ pointerEvents: 'auto' }}>
      {healthConcernOptions.map(option => {
        const isSelected = formData.healthConcerns.includes(option.value as HealthConcernWithNone);
        const isDisabled = option.value !== 'none' && formData.healthConcerns.includes('none');
        
        return (
          <HealthConcernButton
            key={option.value}
            option={option}
            isSelected={isSelected}
            isDisabled={isDisabled}
            onClick={() => onHealthConcernToggle(option.value as HealthConcernWithNone)}
          />
        );
      })}
    </div>

    {error && <p className="text-red-400 text-sm mt-4">{error}</p>}

    {(onPrevious || onNext) && (
      <div className="flex justify-between pt-6 border-t border-surface-highlight">
        {onPrevious && (
          <button
            type="button"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onPrevious();
            }}
            className="flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-xl hover:bg-gray-700 transition-colors duration-150"
          >
            <ChevronLeft className="w-5 h-5 mr-2" />
            Previous
          </button>
        )}
        {onNext && (
          <button
            type="button"
            onClick={onNext}
            className="flex items-center px-6 py-3 bg-primary-600 text-white font-medium rounded-xl hover:bg-primary-700 transition-colors duration-150 ml-auto"
          >
            Next
            <ChevronRight className="w-5 h-5 ml-2" />
          </button>
        )}
      </div>
    )}
  </div>
));
Step4.displayName = 'Step4';

const Step5 = memo(({ 
  formData,
  error,
  allergenOptions,
  onAllergyToggle,
  onCustomAllergiesChange,
  onSubmit,
  editingPet,
  onPrevious
}: {
  formData: FormData;
  error: string | null;
  allergenOptions: Array<{ value: string; label: string }>;
  onAllergyToggle: (allergen: string) => void;
  onCustomAllergiesChange: (value: string) => void;
  onSubmit: () => void;
  editingPet?: Pet | null;
  onPrevious?: () => void;
}) => {
  // Get custom allergies (those not in the predefined list)
  const predefinedAllergyValues = allergenOptions.map(o => o.value);
  const customAllergies = formData.allergies.filter(a => !predefinedAllergyValues.includes(a));
  const selectedPredefined = formData.allergies.filter(a => predefinedAllergyValues.includes(a));
  
  return (
  <div className="space-y-6">
    <h3 className="text-xl font-semibold text-foreground">5. Allergies</h3>
    <p className="text-sm text-gray-400">Select any foods your pet is allergic to. Recipes containing these ingredients will be excluded from recommendations.</p>
    
    <div className="grid grid-cols-2 gap-3">
      {allergenOptions.map(allergen => {
        const isSelected = formData.allergies.includes(allergen.value);
        
        return (
          <AllergyButton
            key={allergen.value}
            allergen={allergen}
            isSelected={isSelected}
            onClick={() => onAllergyToggle(allergen.value)}
          />
        );
      })}
    </div>

    <div className="space-y-2">
      <label htmlFor="customAllergies" className="text-sm font-medium text-gray-300 block">Other:</label>
      <input
        id="customAllergies"
        name="customAllergies"
        type="text"
        value={formData.customAllergies}
        onChange={(e) => onCustomAllergiesChange(e.target.value)}
        placeholder="e.g., venison, rabbit, duck (comma-separated)"
        className="w-full px-4 py-2 border border-surface-highlight bg-surface-lighter text-foreground rounded-xl focus:ring-primary-500 focus:border-primary-500 transition duration-150"
      />
      <p className="text-xs text-gray-500">Enter any additional allergies not listed above, separated by commas</p>
    </div>

    {(selectedPredefined.length > 0 || customAllergies.length > 0) && (
      <div className="mt-4 p-3 bg-yellow-900/20 border border-yellow-800/30 rounded-lg">
        <p className="text-sm text-yellow-200">
          <strong>Selected:</strong> {
            [
              ...selectedPredefined.map(a => allergenOptions.find(o => o.value === a)?.label).filter(Boolean),
              ...customAllergies
            ].join(', ')
          }
        </p>
      </div>
    )}

    {error && <p className="text-red-400 text-sm mt-4">{error}</p>}

    <div className="flex justify-between pt-6 border-t border-surface-highlight">
      {onPrevious && (
        <button
          type="button"
          onClick={onPrevious}
          className="flex items-center px-6 py-3 bg-gray-600 text-white font-medium rounded-xl hover:bg-gray-700 transition-colors duration-150"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          Previous
        </button>
      )}
      <div className={onPrevious ? '' : 'ml-auto'}>
        <button
          type="button"
          onClick={onSubmit}
          className="flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition-colors duration-150 shadow-lg"
        >
          <Check className="w-5 h-5 mr-2" />
          {editingPet ? 'Save Changes' : 'Create Pet Profile'}
        </button>
      </div>
    </div>
  </div>
  );
});
Step5.displayName = 'Step5';

// --- Main Component ---
const AddPetModal = memo(function AddPetModal({ isOpen, onClose, onSubmit, editingPet }: AddPetModalProps) {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState<FormData>(initialFormData);
  const [error, setError] = useState<string | null>(null);

  // Memoize static data - created once, never recreated
  const typeLabels = useMemo(() => ({
    'dogs': 'Dogs',
    'cats': 'Cats',
    'birds': 'Birds',
    'reptiles': 'Reptiles',
    'pocket-pets': 'Pocket Pets'
  }), []);

  const mascotPaths = useMemo(() => {
    const paths: Record<PetCategory, string> = {} as Record<PetCategory, string>;
    (['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'] as PetCategory[]).forEach((petType) => {
      paths[petType] = getMascotFaceForPetType(petType);
    });
    return paths;
  }, []);

  // Memoize sorted breeds - only recalculate when pet type changes
  const sortedBreeds = useMemo(() => {
    if (!formData.type) return ['Mixed'];
    const breeds = getBreedNamesForSpecies(formData.type);
    return breeds.length ? [...breeds].sort() : ['Mixed'];
  }, [formData.type]);

  // Generate species-specific health concerns dynamically
  const healthConcernOptions = useMemo(() => {
    const options = [{ value: 'none', label: 'None' }];
    
    if (!formData.type) {
      return options;
    }

    // Get species-specific concerns (with breed if available)
    const concerns = getHealthConcernsForSpecies(formData.type, formData.breed || undefined);
    
    // Convert to the format needed by the component
    const concernOptions = concerns.map(concern => ({
      value: concern.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
      label: concern
    }));

    return [...options, ...concernOptions];
  }, [formData.type, formData.breed]);

  // Generate species-specific allergen options dynamically
  const allergenOptions = useMemo(() => {
    return getAllergenOptionsForSpecies(formData.type);
  }, [formData.type]);

  // Stable handlers - useCallback to prevent recreation
  const petTypeHandlers = useMemo(() => {
    const handlers: Record<PetCategory, () => void> = {} as Record<PetCategory, () => void>;
    (['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'] as PetCategory[]).forEach((petType) => {
      handlers[petType] = () => {
        setFormData(prev => ({ 
          ...prev, 
          type: petType, 
          breed: '', 
          healthConcerns: [], // Don't default to 'none'
          allergies: [] // Clear allergies when species changes (they're species-specific)
        }));
      };
    });
    return handlers;
  }, []);

  const handleNameChange = useCallback((value: string) => {
    setFormData(prev => ({ ...prev, name: value }));
  }, []);

  const handleBreedSelect = useCallback((breed: string) => {
    setFormData(prev => ({ ...prev, breed }));
  }, []);

  const handleWeightChange = useCallback((value: string) => {
    setFormData(prev => ({ ...prev, weight: value }));
  }, []);

  const handleActivitySelect = useCallback((level: ActivityLevel) => {
    setFormData(prev => ({ ...prev, activityLevel: level }));
  }, []);

  const handleHealthConcernToggle = useCallback((concern: HealthConcernWithNone) => {
    console.log('Health concern toggle clicked:', concern); // Debug log
    if (concern === 'none') {
      setFormData(prev => ({ 
        ...prev, 
        healthConcerns: prev.healthConcerns.includes('none') ? [] : ['none'] 
      }));
    } else {
      setFormData(prev => {
        const currentConcerns = prev.healthConcerns.filter(c => c !== 'none') as HealthConcern[];
        let newConcerns: HealthConcernWithNone[];
        
        if (currentConcerns.includes(concern as HealthConcern)) {
          newConcerns = currentConcerns.filter(c => c !== concern) as HealthConcernWithNone[];
        } else {
          newConcerns = [...currentConcerns, concern as HealthConcern] as HealthConcernWithNone[];
        }
        
        // Don't auto-add 'none' if list is empty - let user choose
        return { ...prev, healthConcerns: newConcerns };
      });
    }
  }, []);

  const handleAllergyToggle = useCallback((allergen: string) => {
    setFormData(prev => {
      const currentAllergies = prev.allergies || [];
      if (currentAllergies.includes(allergen)) {
        return { ...prev, allergies: currentAllergies.filter(a => a !== allergen) };
      } else {
        return { ...prev, allergies: [...currentAllergies, allergen] };
      }
    });
  }, []);

  const handleCustomAllergiesChange = useCallback((value: string) => {
    setFormData(prev => {
      // Get predefined allergy values (use current species-specific options)
      const currentAllergenOptions = getAllergenOptionsForSpecies(prev.type);
      const predefinedValues = currentAllergenOptions.map(o => o.value);
      // Remove any existing custom allergies (those not in predefined list)
      const existingPredefined = prev.allergies.filter(a => predefinedValues.includes(a));
      // Parse new custom allergies from the input (comma-separated, trim whitespace)
      const newCustomAllergies = value
        .split(',')
        .map(a => a.trim())
        .filter(a => a.length > 0);
      // Combine predefined and custom allergies
      return { 
        ...prev, 
        customAllergies: value,
        allergies: [...existingPredefined, ...newCustomAllergies]
      };
    });
  }, []);

  const handlePrevious = useCallback(() => {
    setError(null);
    setStep(prev => Math.max(1, prev - 1));
  }, []);

  const handleSubmitInternal = useCallback(() => {
    setError(null);

    // Map activityLevel from local type to shared Pet type
    const mapActivityLevel = (level: ActivityLevel): 'sedentary' | 'moderate' | 'active' | 'very-active' | undefined => {
      if (level === 'high') return 'very-active';
      if (level === 'medium') return 'moderate';
      if (level === 'low') return 'sedentary';
      return undefined;
    };

    // Convert name to names array for consistency
    const namesArray = formData.name.trim() 
      ? [formData.name.trim()] 
      : (editingPet?.names && Array.isArray(editingPet.names) && editingPet.names.length > 0
          ? editingPet.names 
          : ['Unnamed Pet']);

    const newPet: Pet = {
      ...formData,
      id: editingPet?.id || crypto.randomUUID(),
      type: formData.type as string,
      name: formData.name.trim() || undefined,
      names: namesArray,
      age: (editingPet?.age as string) || 'adult',
      breed: formData.breed || (editingPet?.breed as string) || 'Mixed',
      mealPlan: editingPet?.mealPlan || [],
      activityLevel: formData.activityLevel ? mapActivityLevel(formData.activityLevel) : undefined,
      healthConcerns: formData.healthConcerns.filter(c => c !== 'none') as string[],
      allergies: formData.allergies || [],
      savedRecipes: editingPet?.savedRecipes || [],
    };

    onSubmit(newPet);
    onClose();
  }, [formData, editingPet, onSubmit, onClose]);

  // Reset form when modal opens/closes
  useEffect(() => {
    if (isOpen) {
      setError(null);
      setStep(1);
      if (editingPet) {
      setFormData({
        name: editingPet.name || editingPet.names?.[0] || '',
        type: editingPet.type as PetCategory,
        breed: editingPet.breed || '',
        weight: editingPet.weight || '',
        activityLevel: (editingPet.activityLevel ? (editingPet.activityLevel as ActivityLevel) : undefined),
        healthConcerns: (editingPet.healthConcerns?.length ? (editingPet.healthConcerns as HealthConcernWithNone[]) : []) || [],
        allergies: editingPet.allergies || [],
        customAllergies: (() => {
          // Separate custom allergies (not in predefined list) from predefined ones
          const currentAllergenOptions = getAllergenOptionsForSpecies(editingPet.type as PetCategory);
          const predefinedValues = currentAllergenOptions.map(o => o.value);
          const custom = (editingPet.allergies || []).filter(a => !predefinedValues.includes(a));
          return custom.join(', ');
        })(),
      });
      } else {
        setFormData(initialFormData);
      }
    }
  }, [isOpen, editingPet]);

  // Combined auto-advance logic - single effect instead of multiple
  useEffect(() => {
    if (!isOpen) return;
    
    let timer: NodeJS.Timeout;
    
    if (step === 1 && formData.name.trim() && formData.type) {
      timer = setTimeout(() => {
        setStep(2);
        setError(null);
      }, 300);
    } else if (step === 2 && formData.breed) {
      timer = setTimeout(() => {
        setStep(3);
        setError(null);
      }, 300);
    } else if (step === 3 && formData.activityLevel) {
      timer = setTimeout(() => {
        setStep(4);
        setError(null);
      }, 500);
    } else if (step === 4 && formData.healthConcerns && formData.healthConcerns.length > 0 && false) {
      // Auto-advance disabled - users can select multiple health concerns before proceeding
      timer = setTimeout(() => {
        setStep(5);
        setError(null);
      }, 500);
    }
    
    return () => {
      if (timer) clearTimeout(timer);
    };
  }, [step, formData.name, formData.type, formData.breed, formData.activityLevel, formData.healthConcerns, isOpen]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 z-50 overflow-y-auto flex items-center justify-center p-4"
      style={{ backgroundColor: 'rgba(15, 44, 15, 0.85)' }}
      onClick={(e) => {
        if (e.target === e.currentTarget) onClose();
      }}
    >
      <div 
        className="rounded-2xl w-full max-w-lg shadow-xl border relative" 
        style={{ backgroundColor: '#1a3d2e', borderColor: '#2d5a47', borderWidth: '2px' }}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="p-6 sm:p-8">
          <div className="flex justify-between items-center mb-6 border-b border-surface-highlight pb-4">
            <h2 className="text-2xl font-bold text-foreground">
              {editingPet ? 'Edit Pet Profile' : 'Create New Pet Profile'}
            </h2>
            <button
              onClick={onClose}
              className="p-2 rounded-full text-gray-400 hover:bg-surface-highlight hover:text-white transition-colors"
              aria-label="Close modal"
            >
              <X className="w-6 h-6" />
            </button>
          </div>

          <div>
            {step === 1 && (
              <Step1
                formData={formData}
                error={error}
                typeLabels={typeLabels}
                mascotPaths={mascotPaths}
                petTypeHandlers={petTypeHandlers}
                onNameChange={handleNameChange}
                onPrevious={step > 1 ? handlePrevious : undefined}
              />
            )}
            {step === 2 && (
              <Step2
                formData={formData}
                error={error}
                sortedBreeds={sortedBreeds}
                onBreedSelect={handleBreedSelect}
                onPrevious={handlePrevious}
              />
            )}
            {step === 3 && (
              <Step3
                formData={formData}
                onWeightChange={handleWeightChange}
                onActivitySelect={handleActivitySelect}
                onPrevious={handlePrevious}
              />
            )}
            {step === 4 && (
              <Step4
                formData={formData}
                error={error}
                healthConcernOptions={healthConcernOptions}
                onHealthConcernToggle={handleHealthConcernToggle}
                onSubmit={handleSubmitInternal}
                editingPet={editingPet}
                onPrevious={handlePrevious}
                onNext={() => setStep(5)}
              />
            )}
            {step === 5 && (
              <Step5
                formData={formData}
                error={error}
                allergenOptions={allergenOptions}
                onAllergyToggle={handleAllergyToggle}
                onCustomAllergiesChange={handleCustomAllergiesChange}
                onSubmit={handleSubmitInternal}
                editingPet={editingPet}
                onPrevious={handlePrevious}
              />
            )}
          </div>

          <div className="flex justify-center mt-6">
            {[1, 2, 3, 4, 5].map((s) => (
              <div 
                key={s} 
                className={`w-8 h-1 rounded-full mx-1 transition-colors ${
                  step === s ? 'bg-primary-600' : 'bg-gray-600'
                }`}
              />
            ))}
          </div>
        </div>
      </div>
    </div>
  );
});

AddPetModal.displayName = 'AddPetModal';

export default AddPetModal;
</file>

<file path="components/EmailCaptureModal.tsx">
'use client';

import React, { useState } from 'react';
import { X, Mail, Download, Sparkles } from 'lucide-react';
import { Pet } from '@/lib/types';

interface EmailCaptureModalProps {
  isOpen: boolean;
  onClose: () => void;
  petType?: string;
  mealCount?: number;
  trigger?: 'exit-intent' | 'meal-view' | 'plan-generated';
}

export default function EmailCaptureModal({
  isOpen,
  onClose,
  petType = 'your pet',
  mealCount = 5,
  trigger = 'meal-view'
}: EmailCaptureModalProps) {
  const [email, setEmail] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }

    setIsSubmitting(true);

    try {
      // Store email in localStorage for now (later: send to email service)
      if (typeof window !== 'undefined') {
        const leads = JSON.parse(localStorage.getItem('email_leads') || '[]');
        leads.push({
          email,
          petType,
          trigger,
          timestamp: new Date().toISOString(),
          mealCount
        });
        localStorage.setItem('email_leads', JSON.stringify(leads));
      }

      // TODO: Send to email service (Mailchimp, ConvertKit, etc.)
      // await fetch('/api/subscribe', {
      //   method: 'POST',
      //   body: JSON.stringify({ email, petType, trigger })
      // });

      setIsSubmitted(true);
      
      // Close after 2 seconds
      setTimeout(() => {
        onClose();
        // Reset state after close animation
        setTimeout(() => {
          setIsSubmitted(false);
          setEmail('');
        }, 300);
      }, 2000);

    } catch (error) {
      console.error('Email capture error:', error);
      alert('Something went wrong. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!isOpen) return null;

  if (isSubmitted) {
    return (
      <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div className="bg-gradient-to-br from-green-600 to-green-700 border-2 border-green-400 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
          <div className="text-6xl mb-4 animate-bounce">üéâ</div>
          <h3 className="text-2xl font-bold text-white mb-2">You're In!</h3>
          <p className="text-green-100">
            Check your email for your free meal plan PDF and exclusive tips!
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="bg-surface border-2 border-orange-500/50 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-5 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
              <Sparkles className="text-white" size={24} />
            </div>
            <div>
              <h2 className="text-2xl font-bold text-white">
                Wait! Get Your Free Meal Plan
              </h2>
              <p className="text-orange-100 text-sm">
                Instant PDF + Weekly nutrition tips
              </p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="text-white/70 hover:text-white transition-colors p-1"
          >
            <X size={24} />
          </button>
        </div>

        {/* Content */}
        <div className="p-8">
          <div className="mb-6">
            <h3 className="text-xl font-semibold text-white mb-3">
              Get {mealCount}+ Personalized Meal Recipes for {petType}
            </h3>
            
            {/* Benefits */}
            <div className="space-y-3 mb-6">
              {[
                'üìß Instant delivery to your inbox',
                'ü•ó Vet-approved, nutritionally balanced',
                'üõí Direct Amazon shopping links',
                'üí∞ 100% FREE - No credit card required',
                'üéÅ BONUS: Weekly nutrition tips'
              ].map((benefit, idx) => (
                <div key={idx} className="flex items-start gap-3">
                  <div className="text-lg mt-0.5">{benefit.split(' ')[0]}</div>
                  <p className="text-gray-300 text-sm">
                    {benefit.split(' ').slice(1).join(' ')}
                  </p>
                </div>
              ))}
            </div>
          </div>

          {/* Email Form */}
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-300 mb-2">
                Email Address
              </label>
              <input
                type="email"
                id="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="your@email.com"
                required
                className="w-full px-4 py-3 bg-surface-highlight border-2 border-surface-highlight focus:border-orange-500 rounded-lg text-white placeholder-gray-500 focus:outline-none transition-colors"
              />
            </div>

            <button
              type="submit"
              disabled={isSubmitting}
              className={`w-full py-4 px-6 rounded-lg font-bold text-lg transition-all transform ${
                isSubmitting
                  ? 'bg-gray-600 cursor-wait text-gray-300 scale-95'
                  : 'bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white shadow-xl hover:shadow-2xl hover:scale-105 border-3 border-green-400'
              }`}
            >
              {isSubmitting ? (
                <span className="flex items-center justify-center gap-2">
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  Sending...
                </span>
              ) : (
                <span className="flex items-center justify-center gap-2">
                  <Download size={20} />
                  Get My Free Meal Plan
                </span>
              )}
            </button>
          </form>

          {/* Privacy Note */}
          <p className="text-xs text-gray-500 text-center mt-4">
            We respect your privacy. Unsubscribe anytime. No spam, ever.
          </p>
        </div>

        {/* Trust Footer */}
        <div className="bg-surface-lighter px-6 py-4 border-t border-surface-highlight">
          <div className="flex items-center justify-center gap-6 text-xs text-gray-400">
            <span className="flex items-center gap-1">
              <span className="text-green-400">‚úì</span> 100% Free
            </span>
            <span className="flex items-center gap-1">
              <span className="text-green-400">‚úì</span> No Credit Card
            </span>
            <span className="flex items-center gap-1">
              <span className="text-green-400">‚úì</span> Instant Access
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}

// Exit intent detector hook
export function useExitIntent(onExitIntent: () => void) {
  React.useEffect(() => {
    let hasShown = false;

    const handleMouseLeave = (e: MouseEvent) => {
      // Detect mouse leaving viewport at top (exit intent)
      if (e.clientY <= 10 && !hasShown) {
        hasShown = true;
        onExitIntent();
      }
    };

    document.addEventListener('mouseleave', handleMouseLeave);

    return () => {
      document.removeEventListener('mouseleave', handleMouseLeave);
    };
  }, [onExitIntent]);
}
</file>

<file path="components/EmojiIcon.tsx">
// components/EmojiIcon.tsx
// Component to replace emojis with custom emoji images
// 
// This component takes a Unicode emoji and displays the corresponding custom image
// from the emoji mapping system. All emojis are mapped in lib/utils/emojiMapping.ts
// which uses the "best" set (4x4 grid) for primary pet and status emojis, with
// fallbacks to amojis (8x10 grid) and copilot_emojis (10x11 grid) sets.

import Image from 'next/image';
import { getEmojiImage } from '@/lib/utils/emojiMapping';

interface EmojiIconProps {
  emoji: string;
  size?: number;
  className?: string;
}

export default function EmojiIcon({ emoji, size = 24, className = '' }: EmojiIconProps) {
  const imagePath = getEmojiImage(emoji);
  
  return (
    <span 
      className={`inline-block align-middle ${className}`}
      style={{ 
        display: 'inline-block', 
        verticalAlign: 'middle',
      }}
    >
      <Image
        src={imagePath}
        alt={emoji}
        width={size}
        height={size}
        className="inline-block align-middle"
        style={{ 
          display: 'inline-block', 
          verticalAlign: 'middle',
          imageRendering: 'crisp-edges',
        }}
        unoptimized
      />
    </span>
  );
}
</file>

<file path="components/ErrorBoundary.tsx">
// components/ErrorBoundary.tsx
// Global error boundary for catching React errors

'use client';

import React, { Component, ReactNode } from 'react';
import { AlertTriangle } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
    
    // Log to error tracking service (e.g., Sentry)
    // trackError(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
            <div className="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
              <AlertTriangle className="w-8 h-8 text-red-600" />
            </div>
            
            <h2 className="text-2xl font-bold text-gray-900 text-center mb-2">
              Something went wrong
            </h2>
            
            <p className="text-gray-600 text-center mb-6">
              We're sorry, but something unexpected happened. Please try refreshing the page.
            </p>
            
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details className="mb-4">
                <summary className="text-sm text-gray-500 cursor-pointer hover:text-gray-700">
                  Error details (dev only)
                </summary>
                <pre className="mt-2 text-xs bg-gray-100 p-3 rounded overflow-auto max-h-40">
                  {this.state.error.toString()}
                  {'\n'}
                  {this.state.error.stack}
                </pre>
              </details>
            )}
            
            <div className="flex gap-3">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
              >
                Refresh Page
              </button>
              <button
                onClick={() => window.location.href = '/'}
                className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
              >
                Go Home
              </button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
</file>

<file path="components/ErrorBoundaryWrapper.tsx">
// components/ErrorBoundaryWrapper.tsx
// Client component wrapper for ErrorBoundary

'use client';

import { ErrorBoundary } from './ErrorBoundary';

export default function ErrorBoundaryWrapper({ children }: { children: React.ReactNode }) {
  return (
    <ErrorBoundary>
      {children}
    </ErrorBoundary>
  );
}
</file>

<file path="components/FeedingLogger.tsx">
'use client';

import { useState } from 'react';
import { logMealFed, normalizeIngredientNames } from '@/lib/utils/diversityTracker';

interface FeedingLoggerProps {
  petId: string;
  recipeId: string;
  recipeName: string;
  ingredients: (string | { name?: string; id?: string })[];
  onClose: () => void;
  onLogged?: () => void;
}

export default function FeedingLogger({
  petId,
  recipeId,
  recipeName,
  ingredients,
  onClose,
  onLogged,
}: FeedingLoggerProps) {
  const [fedAt, setFedAt] = useState(() => new Date().toISOString().slice(0, 16));
  const [portion, setPortion] = useState<'all' | 'most' | 'some' | 'none'>('all');

  const handleSubmit = () => {
    const entryDate = fedAt ? new Date(fedAt) : new Date();
    logMealFed({
      petId,
      recipeId,
      recipeName,
      ingredients: normalizeIngredientNames(ingredients as any),
      fedAt: entryDate,
    });
    onLogged?.();
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center px-4">
      <div className="bg-surface rounded-xl shadow-2xl border border-surface-highlight w-full max-w-md p-5 space-y-4">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-foreground">Mark as Fed</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-white text-sm">
            ‚úï
          </button>
        </div>
        <div className="space-y-3 text-sm">
          <div>
            <label className="block text-xs text-gray-400 mb-1">Meal</label>
            <div className="text-foreground font-medium">{recipeName}</div>
          </div>
          <div>
            <label className="block text-xs text-gray-400 mb-1" htmlFor="fedAt">
              Date / Time
            </label>
            <input
              id="fedAt"
              type="datetime-local"
              value={fedAt}
              onChange={(e) => setFedAt(e.target.value)}
              className="w-full px-3 py-2 rounded-lg bg-surface-highlight border border-surface-highlight text-foreground text-sm"
            />
          </div>
          <div>
            <label className="block text-xs text-gray-400 mb-1">Portion eaten</label>
            <div className="flex flex-wrap gap-2">
              {(['all', 'most', 'some', 'none'] as const).map((p) => (
                <button
                  key={p}
                  onClick={() => setPortion(p)}
                  className={`px-3 py-2 rounded-lg border text-xs ${
                    portion === p
                      ? 'bg-primary-600 text-white border-primary-500'
                      : 'bg-surface-highlight text-gray-300 border-surface-highlight hover:border-gray-500'
                  }`}
                >
                  {p.charAt(0).toUpperCase() + p.slice(1)}
                </button>
              ))}
            </div>
          </div>
        </div>
        <div className="flex justify-end gap-2">
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm rounded-lg border border-surface-highlight text-gray-300 hover:bg-surface-highlight"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            className="px-4 py-2 text-sm rounded-lg bg-primary-600 text-white hover:bg-primary-700"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/FireworksAnimation.tsx">
'use client';

import { useEffect, useState } from 'react';

export default function FireworksAnimation() {
  const [particles, setParticles] = useState<Array<{ id: number; x: number; y: number; colorClass: string; delay: number; duration: number }>>([]);

  useEffect(() => {
    // Generate 30 particles in a circle pattern
    const newParticles = Array.from({ length: 30 }, (_, i) => {
      const angle = (i / 30) * Math.PI * 2;
      const distance = 100 + Math.random() * 50;
      const x = Math.cos(angle) * distance;
      const y = Math.sin(angle) * distance;
      const colorClasses = ['bg-yellow-400', 'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'];
      const colorClass = colorClasses[Math.floor(Math.random() * colorClasses.length)];
      
      return {
        id: i,
        x,
        y,
        colorClass,
        delay: Math.random() * 0.2,
        duration: 0.6 + Math.random() * 0.4,
      };
    });
    
    setParticles(newParticles);
  }, []);

  return (
    <>
      <style dangerouslySetInnerHTML={{
        __html: particles.map(particle => `
          @keyframes firework-${particle.id} {
            0% {
              transform: translate(-50%, -50%) scale(0);
              opacity: 1;
            }
            50% {
              opacity: 1;
            }
            100% {
              transform: translate(calc(-50% + ${particle.x}px), calc(-50% + ${particle.y}px)) scale(1.5);
              opacity: 0;
            }
          }
        `).join('\n')
      }} />
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {particles.map((particle) => (
          <div
            key={particle.id}
            className={`absolute w-2 h-2 rounded-full ${particle.colorClass}`}
            style={{
              left: '50%',
              top: '50%',
              transform: 'translate(-50%, -50%)',
              animation: `firework-${particle.id} ${particle.duration}s ease-out forwards`,
              animationDelay: `${particle.delay}s`,
            }}
          />
        ))}
      </div>
    </>
  );
}
</file>

<file path="components/Footer.tsx">
import Link from 'next/link';
import MascotIcon from './MascotIcon';

export default function Footer() {
  return (
    <footer className="bg-gray-900 text-white">
      <div className="max-w-7xl mx-auto px-4 py-12">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          {/* Brand */}
          <div>
            <div className="text-2xl font-bold mb-4">üêæ Paw & Plate</div>
            <p className="text-gray-400">
              Fresh, personalized meal prep for all your pets. Based on AAFCO and WSAVA guidelines.
            </p>
          </div>

          {/* Quick Links */}
          <div>
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <MascotIcon mascot="robin-redroute" size={16} />
              Quick Links
            </h3>
            <ul className="space-y-2">
              <li>
                <Link href="/" className="text-gray-400 hover:text-white transition-colors">
                  Home
                </Link>
              </li>
              <li>
                <Link href="/profile" className="text-gray-400 hover:text-white transition-colors">
                  My Pets
                </Link>
              </li>
              <li>
                <Link href="/meal-plans" className="text-gray-400 hover:text-white transition-colors">
                  Meal Plans
                </Link>
              </li>
              <li>
                <Link href="/about" className="text-gray-400 hover:text-white transition-colors">
                  About Us
                </Link>
              </li>
            </ul>
          </div>

          {/* Pet Categories */}
          <div>
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <MascotIcon mascot="puppy-prepper" size={16} />
              Pet Categories
            </h3>
            <ul className="space-y-2">
              <li>
                <Link href="/category/dogs" className="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                  <MascotIcon mascot="puppy-prepper" size={14} /> Dogs
                </Link>
              </li>
              <li>
                <Link href="/category/cats" className="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                  <MascotIcon mascot="professor-purrfessor" size={14} /> Cats
                </Link>
              </li>
              <li>
                <Link href="/category/birds" className="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                  <MascotIcon mascot="robin-redroute" size={14} /> Birds
                </Link>
              </li>
              <li>
                <Link href="/category/reptiles" className="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                  <MascotIcon mascot="sherlock-shells" size={14} /> Reptiles
                </Link>
              </li>
              <li>
                <Link href="/category/pocket-pets" className="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                  <MascotIcon mascot="farmer-fluff" size={14} /> Pocket Pets
                </Link>
              </li>
            </ul>
          </div>

          {/* Support */}
          <div>
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <MascotIcon mascot="professor-purrfessor" size={16} />
              Support
            </h3>
            <ul className="space-y-2">
              <li>
                <Link href="/contact" className="text-gray-400 hover:text-white transition-colors">
                  Contact Us
                </Link>
              </li>
              <li>
                <Link href="/faq" className="text-gray-400 hover:text-white transition-colors">
                  FAQ
                </Link>
              </li>
              <li>
                <Link href="/nutrition-guide" className="text-gray-400 hover:text-white transition-colors">
                  Nutrition Guide
                </Link>
              </li>
              <li>
                <Link href="/privacy" className="text-gray-400 hover:text-white transition-colors">
                  Privacy Policy
                </Link>
              </li>
            </ul>
          </div>
        </div>

        <div className="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
          <p>
            &copy; {new Date().getFullYear()} Paw & Plate. All rights reserved.
            Nutritional guidelines based on AAFCO and WSAVA standards.
          </p>
        </div>
      </div>
    </footer>
  );
}
</file>

<file path="components/HealthConcernsDropdown.tsx">
// components/HealthConcernsDropdown.tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { getHealthConcernsForSpecies } from '@/lib/data/health-concerns';
import { X } from 'lucide-react';

interface HealthConcernsDropdownProps {
  species: string;
  breed?: string;
  selectedConcerns: string[];
  onConcernsChange: (concerns: string[]) => void;
  maxSelections?: number;
  className?: string;
}

export default function HealthConcernsDropdown({
  species,
  breed,
  selectedConcerns,
  onConcernsChange,
  maxSelections = 5,
  className = ''
}: HealthConcernsDropdownProps) {
  const [availableConcerns, setAvailableConcerns] = useState<string[]>([]);
  const prevSpeciesRef = useRef<string>('');
  const prevBreedRef = useRef<string>('');

  // Load concerns when species or breed changes
  useEffect(() => {
    if (species && species.trim()) {
      const concerns = getHealthConcernsForSpecies(species, breed);
      setAvailableConcerns(concerns);
      
      // Clear concerns if species or breed actually changed (not on initial mount)
      // This prevents clearing concerns when editing an existing pet
      const speciesChanged = prevSpeciesRef.current && prevSpeciesRef.current !== species;
      const breedChanged = prevBreedRef.current && prevBreedRef.current !== (breed || '');
      
      if (speciesChanged || breedChanged) {
        onConcernsChange([]);
      }
      
      prevSpeciesRef.current = species;
      prevBreedRef.current = breed || '';
    } else {
      setAvailableConcerns([]);
      prevSpeciesRef.current = '';
      prevBreedRef.current = '';
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [species, breed]); // Depend on both species and breed

  const toggleConcern = (concern: string) => {
    if (selectedConcerns.includes(concern)) {
      onConcernsChange(selectedConcerns.filter(c => c !== concern));
    } else {
      // Enforce max selections
      if (selectedConcerns.length >= maxSelections) {
        return; // Don't add if at max
      }
      onConcernsChange([...selectedConcerns, concern]);
    }
  };

  if (!species || !species.trim()) {
    return (
      <div className={`p-4 bg-gray-50 rounded-lg ${className}`}>
        <p className="text-gray-500">Select a pet species first to see health concerns</p>
      </div>
    );
  }
  
  if (availableConcerns.length === 0) {
    return (
      <div className={`p-4 bg-yellow-50 rounded-lg border border-yellow-200 ${className}`}>
        <p className="text-yellow-700 text-sm">
          No health concerns found for "{species}". Please check the species selection.
        </p>
      </div>
    );
  }

  const fieldsetId = `health-concerns-${species || 'none'}`;
  
  const removeConcern = (concern: string) => {
    onConcernsChange(selectedConcerns.filter(c => c !== concern));
  };
  
  return (
    <fieldset className={`space-y-3 border-0 p-0 m-0 ${className}`} id={fieldsetId}>
      <legend className="mb-1 w-full">
        <h3 className="text-xs font-medium text-gray-700">Health Concerns</h3>
      </legend>

      {/* Side by side layout: Selected concerns on left, checkboxes on right */}
      <div className="grid grid-cols-[300px_1fr] gap-4">
        {/* Selected concerns - Static list with remove buttons */}
        <div className="space-y-2">
          {selectedConcerns.length > 0 ? (
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium text-gray-700">
                  Selected ({selectedConcerns.length})
                </span>
              </div>
              <ul className="space-y-2">
                {selectedConcerns.map(concern => (
                  <li
                    key={concern}
                    className="flex items-center justify-between bg-white border border-gray-200 rounded-md px-2 py-1.5 hover:border-gray-300 transition-colors"
                  >
                    <span className="text-xs text-gray-900 font-medium truncate flex-1">{concern}</span>
                    <button
                      type="button"
                      onClick={() => removeConcern(concern)}
                      className="ml-2 flex-shrink-0 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full p-0.5 transition-colors"
                      aria-label={`Remove ${concern}`}
                      title={`Remove ${concern}`}
                    >
                      <X size={14} />
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
              <p className="text-xs text-gray-500">No health concerns selected</p>
            </div>
          )}
        </div>

        {/* Concerns checkboxes */}
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1.5">
        {availableConcerns.map(concern => {
          const isSelected = selectedConcerns.includes(concern);
          const inputId = `health-concern-${concern.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;

          return (
            <label
              key={concern}
              htmlFor={inputId}
              className={`
                flex items-center p-1.5 border rounded cursor-pointer text-xs
                transition-colors duration-150
                ${isSelected 
                  ? 'border-blue-500 bg-blue-50' 
                  : 'border-gray-200 hover:bg-gray-50'
                }
              `}
            >
              <input
                id={inputId}
                name={`health-concern-${species}`}
                type="checkbox"
                checked={isSelected}
                onChange={() => toggleConcern(concern)}
                className="mr-1.5 h-3 w-3 text-blue-600 rounded"
                aria-label={`Select ${concern} health concern`}
              />
              <span className={`${isSelected ? 'font-medium' : ''} text-xs leading-tight`}>
                {concern}
              </span>
            </label>
          );
        })}
        </div>
      </div>

      {/* Optional: Select all/none */}
      <div className="flex gap-2 pt-1">
        <button
          type="button"
          onClick={() => onConcernsChange(availableConcerns)}
          className="text-xs text-blue-600 hover:text-blue-800"
        >
          Select All
        </button>
        <span className="text-gray-300">|</span>
        <button
          type="button"
          onClick={() => onConcernsChange([])}
          className="text-xs text-gray-600 hover:text-gray-800"
        >
          Clear All
        </button>
      </div>
    </fieldset>
  );
}
</file>

<file path="components/Image.tsx">
import NextImage from 'next/image';
import { ImageData } from '@/lib/types';
import { getHealthConcernStyle, getPetCategoryStyle } from '@/lib/utils/imageMapping';
import { getMascotImageForCategory } from '@/lib/utils/mascotImageMapping';

interface ImageProps {
  src?: ImageData | string; // Support both ImageData object and string URL
  variant?: 'thumbnail' | 'card' | 'hero' | 'icon' | 'banner';
  alt?: string;
  className?: string;
  priority?: boolean;
  fallbackSrc?: string;
  healthConcern?: string;
  petCategory?: string;
  showOverlays?: boolean;
}

export default function Image({
  src,
  variant = 'card',
  alt = '',
  className = '',
  priority = false,
  fallbackSrc,
  healthConcern,
  petCategory,
  showOverlays = true
}: ImageProps) {
  // Handle string URLs (legacy support)
  const imageUrl = typeof src === 'string' ? src : src?.url;
  const imageAlt = typeof src === 'string' ? alt : src?.alt || alt;
  const imageWidth = typeof src === 'string' ? undefined : src?.width;
  const imageHeight = typeof src === 'string' ? undefined : src?.height;

  // Determine fallback: use mascot image if petCategory provided, otherwise use provided fallback or default
  const mascotFallback = petCategory ? getMascotImageForCategory(petCategory) : null;
  const effectiveFallback = fallbackSrc || mascotFallback || '/images/emojis/Mascots/Mascot-Emoji-Faces.png';

  if (!imageUrl && !effectiveFallback) {
    return (
      <div className={`bg-gray-200 flex items-center justify-center ${className}`}>
        <span className="text-gray-400 text-sm">No image</span>
      </div>
    );
  }

  const getSizes = (variant: string) => {
    switch (variant) {
      case 'thumbnail':
        return '(max-width: 640px) 150px, 300px';
      case 'card':
        return '(max-width: 640px) 300px, 600px';
      case 'hero':
        return '(max-width: 768px) 800px, 1200px';
      case 'icon':
        return '128px';
      case 'banner':
        return '800px';
      default:
        return '600px';
    }
  };

  const getDefaultDimensions = (variant: string) => {
    switch (variant) {
      case 'thumbnail':
        return { width: 300, height: 300 };
      case 'card':
        return { width: 600, height: 400 };
      case 'hero':
        return { width: 1200, height: 600 };
      case 'icon':
        return { width: 128, height: 128 };
      case 'banner':
        return { width: 800, height: 200 };
      default:
        return { width: 600, height: 400 };
    }
  };

  const healthStyle = healthConcern ? getHealthConcernStyle(healthConcern) : null;
  const categoryStyle = petCategory ? getPetCategoryStyle(petCategory) : null;

  const finalUrl = imageUrl || effectiveFallback;
  const dimensions = imageWidth && imageHeight 
    ? { width: imageWidth, height: imageHeight }
    : getDefaultDimensions(variant);

  return (
    <div className={`relative ${className}`}>
      <NextImage
        src={finalUrl}
        alt={imageAlt}
        width={dimensions.width}
        height={dimensions.height}
        className="w-full h-full object-cover"
        sizes={getSizes(variant)}
        priority={priority}
        placeholder="blur"
        blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAhEAACAQMDBQAAAAAAAAAAAAABAgMABAUGIWGRkqGx0f/EABUBAQEAAAAAAAAAAAAAAAAAAAMF/8QAGhEAAgIDAAAAAAAAAAAAAAAAAAECEgMRkf/aAAwDAQACEQMRAD8AltJagyeH0AthI5xdrLcNM91BF5pX2HaH9bcfaSXWGaRmknyJckliyjqTzSlT54b6bk+h0R+IRjWjBqO6O2mhP//Z"
        onError={(e) => {
          const target = e.target as HTMLImageElement;
          // Try mascot image if available, otherwise use effective fallback
          if (mascotFallback && !target.src.includes('Mascots')) {
            target.src = mascotFallback;
          } else if (effectiveFallback && target.src !== effectiveFallback) {
            target.src = effectiveFallback;
          }
        }}
      />

      {/* Health Concern Overlay */}
      {showOverlays && healthStyle && (
        <div className="absolute top-2 right-2 bg-white/90 backdrop-blur-sm rounded-full p-1 shadow-sm">
          <span
            className="text-sm"
            style={{ color: healthStyle.color }}
            title={`Health concern: ${healthConcern}`}
          >
            {healthStyle.symbol}
          </span>
        </div>
      )}

      {/* Pet Category Frame */}
      {showOverlays && categoryStyle && variant === 'card' && (
        <div
          className="absolute inset-0 rounded-lg border-4 pointer-events-none"
          style={{ borderColor: categoryStyle.color + '40' }}
        />
      )}
    </div>
  );
}
</file>

<file path="components/IngredientPicker.tsx">
'use client';

import { useState } from 'react';
import { Search, X } from 'lucide-react';

interface Ingredient {
  name: string;
  category: string;
}

interface IngredientPickerProps {
  ingredients: Ingredient[];
  categories: {
    [key: string]: {
      name: string;
      icon: string;
      ingredients: string[];
    };
  };
  onSelect: (ingredientName: string) => void;
  disabled?: boolean;
}

export default function IngredientPicker({
  ingredients,
  categories,
  onSelect,
  disabled = false
}: IngredientPickerProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [isOpen, setIsOpen] = useState(false);

  // Filter ingredients by search and category
  const filteredIngredients = ingredients.filter(ing => {
    const matchesSearch = ing.name.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = !selectedCategory || 
      categories[selectedCategory]?.ingredients.includes(ing.name);
    return matchesSearch && matchesCategory;
  });

  const categoryKeys = Object.keys(categories);

  return (
    <div className="relative">
      {/* Search Input & Dropdown Toggle */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
        <input
          type="text"
          placeholder="Search ingredients..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          onFocus={() => setIsOpen(true)}
          className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          disabled={disabled}
        />
        {searchQuery && (
          <button
            onClick={() => setSearchQuery('')}
            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
          >
            <X size={16} />
          </button>
        )}
      </div>

      {/* Category Filters */}
      {isOpen && (
        <div className="mt-2 flex flex-wrap gap-2">
          <button
            onClick={() => setSelectedCategory(null)}
            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
              selectedCategory === null
                ? 'bg-primary-100 text-primary-700 border border-primary-300'
                : 'bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200'
            }`}
          >
            All
          </button>
          {categoryKeys.map(catKey => (
            <button
              key={catKey}
              onClick={() => setSelectedCategory(catKey)}
              className={`px-3 py-1 rounded-full text-xs font-medium transition-colors flex items-center gap-1 ${
                selectedCategory === catKey
                  ? 'bg-primary-100 text-primary-700 border border-primary-300'
                  : 'bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200'
              }`}
            >
              <span>{categories[catKey].icon}</span>
              {categories[catKey].name}
            </button>
          ))}
        </div>
      )}

      {/* Dropdown Results */}
      {isOpen && filteredIngredients.length > 0 && (
        <div className="absolute z-50 w-full mt-2 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto">
          {filteredIngredients.map((ing, idx) => (
            <button
              key={idx}
              onClick={() => {
                onSelect(ing.name);
                setSearchQuery('');
                setIsOpen(false);
              }}
              className="w-full px-4 py-2 text-left hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0"
            >
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-900">{ing.name}</span>
                <span className="text-xs text-gray-500">{ing.category}</span>
              </div>
            </button>
          ))}
        </div>
      )}

      {/* Click outside to close */}
      {isOpen && (
        <div
          className="fixed inset-0 z-40"
          onClick={() => setIsOpen(false)}
        />
      )}
    </div>
  );
}
</file>

<file path="components/InteractiveStarRating.tsx">
import React, { useState } from 'react';
import { Star } from 'lucide-react';

interface InteractiveStarRatingProps {
  currentRating?: number;
  onRatingChange: (rating: number) => void;
  size?: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  className?: string;
}

export const InteractiveStarRating: React.FC<InteractiveStarRatingProps> = ({
  currentRating = 0,
  onRatingChange,
  size = 'md',
  disabled = false,
  className = ''
}) => {
  const [hoverRating, setHoverRating] = useState(0);

  const sizeClasses = {
    sm: 'w-5 h-5',
    md: 'w-6 h-6',
    lg: 'w-8 h-8'
  };

  const handleStarClick = (rating: number) => {
    if (disabled) return;
    onRatingChange(rating);
  };

  const handleStarHover = (rating: number) => {
    if (disabled) return;
    setHoverRating(rating);
  };

  const handleMouseLeave = () => {
    if (disabled) return;
    setHoverRating(0);
  };

  const getStarClass = (starIndex: number) => {
    const rating = hoverRating || currentRating;
    const baseClass = `${sizeClasses[size]} cursor-pointer transition-colors`;

    if (disabled) {
      return `${baseClass} text-gray-300 cursor-not-allowed`;
    }

    if (starIndex <= rating) {
      return `${baseClass} text-yellow-400 fill-yellow-400`;
    }

    return `${baseClass} text-gray-300 hover:text-yellow-400`;
  };

  return (
    <div
      className={`flex items-center gap-1 ${className}`}
      onMouseLeave={handleMouseLeave}
      role="radiogroup"
      aria-label="Rate this recipe"
    >
      {[1, 2, 3, 4, 5].map((star) => (
        <button
          key={star}
          type="button"
          className={getStarClass(star)}
          onClick={() => handleStarClick(star)}
          onMouseEnter={() => handleStarHover(star)}
          disabled={disabled}
          aria-label={`Rate ${star} star${star !== 1 ? 's' : ''}`}
          aria-pressed={star <= currentRating}
        >
          <Star />
        </button>
      ))}
      {currentRating > 0 && !disabled && (
        <span className="ml-2 text-sm text-gray-600">
          {currentRating} star{currentRating !== 1 ? 's' : ''}
        </span>
      )}
    </div>
  );
};
</file>

<file path="components/LoadingSpinner.tsx">
// components/LoadingSpinner.tsx
// Reusable loading spinner component

'use client';

import React from 'react';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg' | 'xl';
  message?: string;
  fullScreen?: boolean;
}

const sizeClasses = {
  sm: 'h-4 w-4',
  md: 'h-8 w-8',
  lg: 'h-12 w-12',
  xl: 'h-16 w-16',
};

export function LoadingSpinner({ 
  size = 'md', 
  message,
  fullScreen = false 
}: LoadingSpinnerProps) {
  const spinner = (
    <div className="flex flex-col items-center justify-center gap-3">
      <div className={`animate-spin rounded-full border-b-2 border-primary-600 ${sizeClasses[size]}`} />
      {message && (
        <p className="text-gray-600 text-sm font-medium">{message}</p>
      )}
    </div>
  );

  if (fullScreen) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        {spinner}
      </div>
    );
  }

  return spinner;
}

export default LoadingSpinner;
</file>

<file path="components/MascotAvatar.tsx">
// components/MascotAvatar.tsx
// Component for displaying medium-size mascot avatars
// Used in compatibility panels, recipe results, ingredient detail pages

import Image from 'next/image';
import { getMascotFaceImage } from '@/lib/utils/emojiMapping';

export type MascotName = 
  | 'puppy-prepper' 
  | 'professor-purrfessor' 
  | 'sherlock-shells' 
  | 'farmer-fluff' 
  | 'robin-redroute';

interface MascotAvatarProps {
  mascot: MascotName;
  size?: number;
  className?: string;
  showLabel?: boolean;
  label?: string;
}

/**
 * Medium-size mascot avatar for compatibility panels, recipe results, etc.
 * Larger than MascotIcon, used for more prominent displays
 */
export default function MascotAvatar({ 
  mascot, 
  size = 48, 
  className = '',
  showLabel = false,
  label
}: MascotAvatarProps) {
  const imagePath = getMascotFaceImage(mascot);
  
  const mascotLabels: Record<MascotName, string> = {
    'puppy-prepper': 'Puppy Prepper',
    'professor-purrfessor': 'Professor Purrfessor',
    'sherlock-shells': 'Sherlock Shells',
    'farmer-fluff': 'Farmer Fluff',
    'robin-redroute': 'Robin Redroute',
  };
  
  const displayLabel = label || mascotLabels[mascot];
  
  if (!imagePath) {
    // Fallback to emoji if image not found
    const emojiMap: Record<MascotName, string> = {
      'puppy-prepper': 'üêï',
      'professor-purrfessor': 'üê±',
      'sherlock-shells': 'üê¢',
      'farmer-fluff': 'üêπ',
      'robin-redroute': 'üê¶',
    };
    return (
      <div className={`flex flex-col items-center ${className}`}>
        <span className="text-4xl">{emojiMap[mascot]}</span>
        {showLabel && <span className="text-xs text-gray-600 mt-1">{displayLabel}</span>}
      </div>
    );
  }
  
  return (
    <div className={`flex flex-col items-center ${className}`}>
      <span
        style={{ 
          display: 'inline-block', 
          verticalAlign: 'middle',
        }}
      >
        <Image
          src={imagePath}
          alt={`${displayLabel} mascot`}
          width={size}
          height={size}
          className="inline-block align-middle"
          style={{ 
            display: 'inline-block', 
            verticalAlign: 'middle',
            imageRendering: 'crisp-edges',
          }}
          unoptimized
        />
      </span>
      {showLabel && (
        <span className="text-xs text-gray-600 mt-1 text-center">{displayLabel}</span>
      )}
    </div>
  );
}
</file>

<file path="components/MascotIcon.tsx">
// components/MascotIcon.tsx
// Component for displaying tiny mascot face icons (emoji-style)
// Used in navigation, tooltips, ingredient lists, etc.

import Image from 'next/image';
import { getMascotFaceImage } from '@/lib/utils/emojiMapping';

export type MascotName = 
  | 'puppy-prepper' 
  | 'professor-purrfessor' 
  | 'sherlock-shells' 
  | 'farmer-fluff' 
  | 'robin-redroute';

interface MascotIconProps {
  mascot: MascotName;
  size?: number;
  className?: string;
}

/**
 * Tiny mascot face icon for navigation, tooltips, etc.
 * Uses the mascot face images (not full illustrations)
 */
export default function MascotIcon({ 
  mascot, 
  size = 20, 
  className = '' 
}: MascotIconProps) {
  const imagePath = getMascotFaceImage(mascot);
  
  if (!imagePath) {
    // Fallback to emoji if image not found
    const emojiMap: Record<MascotName, string> = {
      'puppy-prepper': 'üêï',
      'professor-purrfessor': 'üê±',
      'sherlock-shells': 'üê¢',
      'farmer-fluff': 'üêπ',
      'robin-redroute': 'üê¶',
    };
    return <span className={className}>{emojiMap[mascot]}</span>;
  }
  
  return (
    <span 
      className={`inline-block align-middle ${className}`}
      style={{ 
        display: 'inline-block', 
        verticalAlign: 'middle',
      }}
    >
      <Image
        src={imagePath}
        alt={`${mascot} mascot`}
        width={size}
        height={size}
        className={`inline-block align-middle mascot-icon mascot-${mascot}`}
        style={{ 
          display: 'inline-block', 
          verticalAlign: 'middle',
          imageRendering: 'crisp-edges',
        }}
        unoptimized
      />
    </span>
  );
}
</file>

<file path="components/mascots/FarmerFluff.tsx">
'use client';

import React from 'react';
import MascotAnimation from './MascotAnimation';

export interface FarmerFluffProps {
  size?: number;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Farmer Fluff - Ingredient Provider & Farm Manager
 * Role: Grows, gathers, and secures all ingredients, manages supply flow & freshness
 * Accessories: Gardening hoe, suspenders, little basket (NO hat per brand bible)
 * Personality: ADHD, upbeat, impulsive, very productive in bursts
 * Color: Dark brown
 * Activity: Rapid harvesting, organizing
 */
export default function FarmerFluff({
  size = 120,
  activity = 'idle',
  className = ''
}: FarmerFluffProps) {
  return (
    <MascotAnimation
      activity={activity}
      personality="hyperactive"
      className={className}
    >
      <div
        className="relative"
        style={{ width: size, height: size }}
        role="img"
        aria-label="Farmer Fluff, the hamster farmer mascot"
      >
        {/* Hamster body - round, fluffy */}
        <div
          className="absolute inset-0 rounded-full"
          style={{
            background: 'linear-gradient(135deg, #D2B48C 0%, #BC9A6A 100%)',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
          }}
        />
        
        {/* Suspenders */}
        <div
          className="absolute"
          style={{
            top: size * 0.3,
            left: size * 0.2,
            width: size * 0.1,
            height: size * 0.4,
            background: '#8B4513',
            borderRadius: '2px',
            boxShadow: '0 1px 2px rgba(0,0,0,0.2)'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.3,
            right: size * 0.2,
            width: size * 0.1,
            height: size * 0.4,
            background: '#8B4513',
            borderRadius: '2px',
            boxShadow: '0 1px 2px rgba(0,0,0,0.2)'
          }}
        />
        {/* Suspenders cross */}
        <div
          className="absolute"
          style={{
            top: size * 0.3,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.2,
            height: size * 0.1,
            background: '#8B4513',
            borderRadius: '2px'
          }}
        />
        
        {/* Eyes - bright, energetic */}
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            left: size * 0.3,
            width: size * 0.1,
            height: size * 0.1,
            background: '#000',
            borderRadius: '50%'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            right: size * 0.3,
            width: size * 0.1,
            height: size * 0.1,
            background: '#000',
            borderRadius: '50%'
          }}
        />
        
        {/* Nose */}
        <div
          className="absolute"
          style={{
            top: size * 0.45,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.08,
            height: size * 0.06,
            background: '#FF69B4',
            borderRadius: '50%'
          }}
        />
        
        {/* Mouth - happy, energetic */}
        <div
          className="absolute"
          style={{
            top: size * 0.52,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.2,
            height: size * 0.1,
            borderBottom: '3px solid #000',
            borderRadius: '0 0 50% 50%'
          }}
        />
        
        {/* Garden hoe - when active */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              top: size * 0.4,
              right: -size * 0.1,
              width: size * 0.15,
              height: size * 0.4,
              background: '#654321',
              borderRadius: '2px',
              transform: 'rotate(-15deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            <div
              className="absolute top-0 left-1/2 transform -translate-x-1/2"
              style={{
                width: size * 0.2,
                height: size * 0.08,
                background: '#C0C0C0',
                clipPath: 'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)',
                borderRadius: '2px'
              }}
            />
          </div>
        )}
        
        {/* Basket - when active */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              bottom: -size * 0.05,
              left: size * 0.1,
              width: size * 0.3,
              height: size * 0.2,
              background: '#8B4513',
              borderRadius: '50% 50% 0 0',
              border: '2px solid #654321',
              transform: 'rotate(-10deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            {/* Basket handle */}
            <div
              className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1"
              style={{
                width: size * 0.15,
                height: size * 0.08,
                border: '2px solid #654321',
                borderRadius: '50%',
                background: 'transparent'
              }}
            />
            {/* Basket contents */}
            <div
              className="absolute bottom-2 left-2 right-2"
              style={{
                height: size * 0.1,
                background: 'linear-gradient(135deg, #90EE90 0%, #228B22 100%)',
                borderRadius: '4px'
              }}
            />
          </div>
        )}
      </div>
    </MascotAnimation>
  );
}
</file>

<file path="components/mascots/MascotAnimation.tsx">
'use client';

import React from 'react';
import { useSpring, animated, config } from '@react-spring/web';

export interface MascotAnimationProps {
  children: React.ReactNode;
  activity?: 'idle' | 'active';
  personality?: 'stern' | 'anxious' | 'excitable' | 'thoughtful' | 'hyperactive';
  className?: string;
}

/**
 * Base animation component for mascots
 * Handles idle and activity states with React Spring animations
 * Uses GPU-accelerated transforms for performance
 */
export default function MascotAnimation({
  children,
  activity = 'idle',
  personality = 'thoughtful',
  className = ''
}: MascotAnimationProps) {
  // Breathing animation for idle state
  const breathing = useSpring({
    from: { scale: 1 },
    to: { scale: 1.02 },
    loop: { reverse: true },
    config: { duration: 2000 },
    pause: activity !== 'idle'
  });

  // Activity animations based on personality
  const getActivityProps = () => {
    switch (personality) {
      case 'stern':
        return {
          from: { y: 0, rotate: 0 },
          to: [
            { y: -2, rotate: -1 },
            { y: 0, rotate: 0 },
            { y: -2, rotate: 1 },
            { y: 0, rotate: 0 }
          ],
          config: { duration: 1000 }
        };
      case 'anxious':
        return {
          from: { x: 0, y: 0 },
          to: [
            { x: -1, y: -1 },
            { x: 1, y: 0 },
            { x: -1, y: -1 },
            { x: 0, y: 0 }
          ],
          config: { duration: 600 }
        };
      case 'excitable':
        return {
          from: { y: 0, scale: 1 },
          to: [
            { y: -4, scale: 1.05 },
            { y: 0, scale: 1 },
            { y: -4, scale: 1.05 },
            { y: 0, scale: 1 }
          ],
          config: { duration: 800 }
        };
      case 'thoughtful':
        return {
          from: { y: 0, rotate: 0 },
          to: [
            { y: -1, rotate: -0.5 },
            { y: 0, rotate: 0 },
            { y: -1, rotate: 0.5 },
            { y: 0, rotate: 0 }
          ],
          config: { duration: 2000 }
        };
      case 'hyperactive':
        return {
          from: { y: 0, rotate: 0, scale: 1 },
          to: [
            { y: -3, rotate: -2, scale: 1.03 },
            { y: 0, rotate: 2, scale: 1 },
            { y: -3, rotate: -2, scale: 1.03 },
            { y: 0, rotate: 0, scale: 1 }
          ],
          config: { duration: 500 }
        };
      default:
        return { from: {}, to: {} };
    }
  };

  const activityAnim = useSpring({
    ...getActivityProps(),
    loop: true,
    pause: activity !== 'active'
  });

  // Build transform string based on activity
  if (activity === 'idle') {
    return (
      <animated.div
        style={{
          scale: breathing.scale,
          willChange: 'transform',
          transformOrigin: 'center center'
        }}
        className={`inline-block ${className}`}
      >
        {children}
      </animated.div>
    );
  }

  // Activity animations - use optional chaining and provide defaults
  const style: any = {
    willChange: 'transform',
    transformOrigin: 'center center'
  };

  if ('y' in activityAnim) style.y = activityAnim.y;
  if ('x' in activityAnim) style.x = activityAnim.x;
  if ('rotate' in activityAnim) style.rotate = activityAnim.rotate;
  if ('scale' in activityAnim) style.scale = activityAnim.scale;
  if (!('scale' in activityAnim)) style.scale = 1;

  return (
    <animated.div
      style={style}
      className={`inline-block ${className}`}
    >
      {children}
    </animated.div>
  );
}
</file>

<file path="components/mascots/ProfessorPurrfessor.tsx">
'use client';

import React from 'react';
import MascotAnimation from './MascotAnimation';

export interface ProfessorPurrfessorProps {
  size?: number;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Professor Purrfessor - The Researcher & Recipe Tester
 * Role: Tests ingredients, analyzes compatibility, develops new formulas
 * Accessories: Lab coat, glasses, clipboard
 * Personality: Nerdy, anxious, brilliant, catastrophizes constantly
 * Color: Black/charcoal
 * Activity: Writing notes, examining ingredients
 */
export default function ProfessorPurrfessor({
  size = 120,
  activity = 'idle',
  className = ''
}: ProfessorPurrfessorProps) {
  return (
    <MascotAnimation
      activity={activity}
      personality="anxious"
      className={className}
    >
      <div
        className="relative"
        style={{ width: size, height: size }}
        role="img"
        aria-label="Professor Purrfessor, the cat scientist mascot"
      >
        {/* Cat body - angular, sleek */}
        <div
          className="absolute inset-0"
          style={{
            background: 'linear-gradient(135deg, #8B7355 0%, #6B5B4D 100%)',
            borderRadius: '50% 50% 50% 50% / 60% 60% 40% 40%',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
          }}
        />
        
        {/* Lab coat */}
        <div
          className="absolute bottom-0 left-0 right-0"
          style={{
            height: size * 0.6,
            background: 'white',
            borderRadius: '50% 50% 0 0',
            border: '2px solid #E0E0E0',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
          }}
        />
        
        {/* Glasses */}
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.5,
            height: size * 0.15,
            border: '3px solid #333',
            borderRadius: '20%',
            background: 'rgba(200, 200, 200, 0.3)'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.2,
            height: size * 0.15,
            borderRight: '2px solid #333'
          }}
        />
        
        {/* Eyes - anxious, wide */}
        <div
          className="absolute"
          style={{
            top: size * 0.38,
            left: size * 0.28,
            width: size * 0.1,
            height: size * 0.1,
            background: '#4A90E2',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.38,
            right: size * 0.28,
            width: size * 0.1,
            height: size * 0.1,
            background: '#4A90E2',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        />
        
        {/* Nose */}
        <div
          className="absolute"
          style={{
            top: size * 0.5,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.08,
            height: size * 0.06,
            background: '#FF69B4',
            borderRadius: '50%'
          }}
        />
        
        {/* Mouth - anxious expression */}
        <div
          className="absolute"
          style={{
            top: size * 0.58,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.15,
            height: size * 0.08,
            borderBottom: '2px solid #000',
            borderRadius: '0 0 50% 50%'
          }}
        />
        
        {/* Clipboard - held in front */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              top: size * 0.5,
              left: size * 0.65,
              width: size * 0.2,
              height: size * 0.35,
              background: '#FFF',
              border: '2px solid #333',
              borderRadius: '4px',
              transform: 'rotate(-10deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            {/* Clipboard lines */}
            {[0, 1, 2].map(i => (
              <div
                key={i}
                className="absolute left-1 right-1"
                style={{
                  top: `${20 + i * 25}%`,
                  height: '2px',
                  background: '#E0E0E0'
                }}
              />
            ))}
            {/* Clipboard clip */}
            <div
              className="absolute top-0 left-1/2 transform -translate-x-1/2"
              style={{
                width: size * 0.08,
                height: size * 0.05,
                background: '#C0C0C0',
                borderRadius: '2px'
              }}
            />
          </div>
        )}
      </div>
    </MascotAnimation>
  );
}
</file>

<file path="components/mascots/PuppyPreper.tsx">
'use client';

import React from 'react';
import MascotAnimation, { MascotAnimationProps } from './MascotAnimation';

export interface PuppyPreperProps {
  size?: number;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Puppy Prepper - The Chef & Meal-Prep Lead
 * Role: Cooks meals, assembles final bowls, oversees kitchen operations
 * Accessories: Chef hat, wooden spoon, metal mixing bowl
 * Personality: Serious chef energy, impatient, slightly Gordon Ramsay; secretly soft-hearted
 * Color: Light gold
 * Activity: Cooking/stirring motion
 */
export default function PuppyPreper({
  size = 120,
  activity = 'idle',
  className = ''
}: PuppyPreperProps) {
  return (
    <MascotAnimation
      activity={activity}
      personality="stern"
      className={className}
    >
      <div
        className="relative"
        style={{ width: size, height: size }}
        role="img"
        aria-label="Puppy Prepper, the chef & meal-prep lead mascot"
      >
        {/* Dog body - rounded, friendly shape */}
        <div
          className="absolute inset-0 rounded-full"
          style={{
            background: 'linear-gradient(135deg, #F4A460 0%, #D2691E 100%)',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
          }}
        />
        
        {/* Chef hat */}
        <div
          className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2"
          style={{
            width: size * 0.6,
            height: size * 0.3,
            background: 'white',
            borderRadius: '50% 50% 0 0',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
          }}
        />
        <div
          className="absolute top-0 left-1/2 transform -translate-x-1/2"
          style={{
            width: size * 0.5,
            height: size * 0.15,
            background: 'white',
            borderRadius: '50%'
          }}
        />
        
        {/* Eyes - intense, focused */}
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            left: size * 0.3,
            width: size * 0.08,
            height: size * 0.08,
            background: '#000',
            borderRadius: '50%'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.35,
            right: size * 0.3,
            width: size * 0.08,
            height: size * 0.08,
            background: '#000',
            borderRadius: '50%'
          }}
        />
        
        {/* Nose */}
        <div
          className="absolute"
          style={{
            top: size * 0.45,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.1,
            height: size * 0.08,
            background: '#000',
            borderRadius: '50%'
          }}
        />
        
        {/* Mouth - stern expression */}
        <div
          className="absolute"
          style={{
            top: size * 0.55,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.2,
            height: size * 0.05,
            borderBottom: '2px solid #000',
            borderRadius: '0 0 50% 50%'
          }}
        />
        
        {/* Spoon - held in front */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              top: size * 0.6,
              left: size * 0.7,
              width: size * 0.15,
              height: size * 0.3,
              background: '#C0C0C0',
              borderRadius: '2px',
              transform: 'rotate(-20deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            <div
              className="absolute top-0 left-1/2 transform -translate-x-1/2"
              style={{
                width: size * 0.08,
                height: size * 0.08,
                background: '#C0C0C0',
                borderRadius: '50%'
              }}
            />
          </div>
        )}
        
        {/* Mixing bowl - on ground */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              bottom: -size * 0.1,
              left: '50%',
              transform: 'translateX(-50%)',
              width: size * 0.4,
              height: size * 0.15,
              background: '#E8E8E8',
              borderRadius: '0 0 50% 50%',
              border: '2px solid #C0C0C0',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          />
        )}
      </div>
    </MascotAnimation>
  );
}
</file>

<file path="components/mascots/RobinRedroute.tsx">
'use client';

import React from 'react';
import MascotAnimation from './MascotAnimation';

export interface RobinRedrouteProps {
  size?: number;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Robin Redroute - Packaging & Delivery Specialist
 * Role: Packs orders, prints labels, organizes deliveries, handles inventory and logistics
 * Accessories: Delivery satchel, goggles, tiny pilot cap
 * Personality: Hyper, chatty, easily excited
 * Color: Red
 * Activity: Flying/delivering packages
 */
export default function RobinRedroute({
  size = 120,
  activity = 'idle',
  className = ''
}: RobinRedrouteProps) {
  return (
    <MascotAnimation
      activity={activity}
      personality="excitable"
      className={className}
    >
      <div
        className="relative"
        style={{ width: size, height: size }}
        role="img"
        aria-label="Robin Redroute, the bird delivery mascot"
      >
        {/* Bird body - round, compact */}
        <div
          className="absolute inset-0 rounded-full"
          style={{
            background: 'linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%)',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
          }}
        />
        
        {/* Hat */}
        <div
          className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1"
          style={{
            width: size * 0.5,
            height: size * 0.2,
            background: '#4A4A4A',
            borderRadius: '50% 50% 0 0',
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
          }}
        />
        <div
          className="absolute top-0 left-1/2 transform -translate-x-1/2"
          style={{
            width: size * 0.4,
            height: size * 0.12,
            background: '#4A4A4A',
            borderRadius: '50%'
          }}
        />
        
        {/* Goggles */}
        <div
          className="absolute"
          style={{
            top: size * 0.3,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.4,
            height: size * 0.12,
            background: '#1A1A1A',
            borderRadius: '50%',
            border: '2px solid #333'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.32,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.35,
            height: size * 0.1,
            background: 'rgba(100, 150, 200, 0.3)',
            borderRadius: '50%'
          }}
        />
        
        {/* Eyes - excited, wide */}
        <div
          className="absolute"
          style={{
            top: size * 0.33,
            left: size * 0.3,
            width: size * 0.08,
            height: size * 0.08,
            background: '#FFF',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        >
          <div
            className="absolute inset-0"
            style={{
              background: '#000',
              borderRadius: '50%',
              transform: 'scale(0.6)'
            }}
          />
        </div>
        <div
          className="absolute"
          style={{
            top: size * 0.33,
            right: size * 0.3,
            width: size * 0.08,
            height: size * 0.08,
            background: '#FFF',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        >
          <div
            className="absolute inset-0"
            style={{
              background: '#000',
              borderRadius: '50%',
              transform: 'scale(0.6)'
            }}
          />
        </div>
        
        {/* Beak */}
        <div
          className="absolute"
          style={{
            top: size * 0.45,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.12,
            height: size * 0.08,
            background: '#FFA500',
            clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)'
          }}
        />
        
        {/* Wings - spread when active */}
        {activity === 'active' && (
          <>
            <div
              className="absolute"
              style={{
                top: size * 0.4,
                left: -size * 0.15,
                width: size * 0.3,
                height: size * 0.2,
                background: 'linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%)',
                borderRadius: '50%',
                transform: 'rotate(-20deg)',
                boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
              }}
            />
            <div
              className="absolute"
              style={{
                top: size * 0.4,
                right: -size * 0.15,
                width: size * 0.3,
                height: size * 0.2,
                background: 'linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%)',
                borderRadius: '50%',
                transform: 'rotate(20deg)',
                boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
              }}
            />
          </>
        )}
        
        {/* Messenger bag */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              bottom: size * 0.2,
              left: size * 0.6,
              width: size * 0.25,
              height: size * 0.3,
              background: '#8B4513',
              borderRadius: '4px',
              border: '2px solid #654321',
              transform: 'rotate(10deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            <div
              className="absolute top-0 left-1/2 transform -translate-x-1/2"
              style={{
                width: size * 0.15,
                height: size * 0.08,
                background: '#654321',
                borderRadius: '2px'
              }}
            />
          </div>
        )}
      </div>
    </MascotAnimation>
  );
}
</file>

<file path="components/mascots/SherlockShells.tsx">
'use client';

import React from 'react';
import MascotAnimation from './MascotAnimation';

export interface SherlockShellsProps {
  size?: number;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Sherlock Shells - Explorer & Risk Inspector
 * Role: Discovers existing recipes, catalogs new meals, inspects ingredients for problems
 * Accessories: Deerstalker hat, monocle, magnifying glass
 * Personality: Soft-spoken, melancholy, overly thoughtful
 * Color: Green
 * Activity: Slow investigation, examining
 */
export default function SherlockShells({
  size = 120,
  activity = 'idle',
  className = ''
}: SherlockShellsProps) {
  return (
    <MascotAnimation
      activity={activity}
      personality="thoughtful"
      className={className}
    >
      <div
        className="relative"
        style={{ width: size, height: size }}
        role="img"
        aria-label="Sherlock Shells, the turtle detective mascot"
      >
        {/* Turtle shell - rounded, textured */}
        <div
          className="absolute inset-0 rounded-full"
          style={{
            background: 'linear-gradient(135deg, #228B22 0%, #006400 100%)',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
            border: '3px solid #2F4F2F'
          }}
        />
        
        {/* Shell pattern */}
        {[0, 1, 2, 3, 4].map(i => (
          <div
            key={i}
            className="absolute"
            style={{
              top: '50%',
              left: '50%',
              transform: `translate(-50%, -50%) rotate(${i * 72}deg)`,
              width: size * 0.3,
              height: '2px',
              background: '#2F4F2F'
            }}
          />
        ))}
        
        {/* Head */}
        <div
          className="absolute"
          style={{
            top: -size * 0.15,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.4,
            height: size * 0.3,
            background: 'linear-gradient(135deg, #8B7355 0%, #6B5B4D 100%)',
            borderRadius: '50%',
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
          }}
        />
        
        {/* Deerstalker hat */}
        <div
          className="absolute"
          style={{
            top: -size * 0.2,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.5,
            height: size * 0.15,
            background: '#4A4A4A',
            borderRadius: '50%',
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
          }}
        />
        <div
          className="absolute"
          style={{
            top: -size * 0.25,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.4,
            height: size * 0.1,
            background: '#4A4A4A',
            borderRadius: '50%'
          }}
        />
        {/* Hat flaps */}
        <div
          className="absolute"
          style={{
            top: -size * 0.15,
            left: -size * 0.1,
            width: size * 0.15,
            height: size * 0.2,
            background: '#4A4A4A',
            borderRadius: '50%',
            transform: 'rotate(-20deg)'
          }}
        />
        <div
          className="absolute"
          style={{
            top: -size * 0.15,
            right: -size * 0.1,
            width: size * 0.15,
            height: size * 0.2,
            background: '#4A4A4A',
            borderRadius: '50%',
            transform: 'rotate(20deg)'
          }}
        />
        
        {/* Monocle */}
        <div
          className="absolute"
          style={{
            top: size * 0.05,
            right: size * 0.15,
            width: size * 0.12,
            height: size * 0.12,
            border: '3px solid #333',
            borderRadius: '50%',
            background: 'rgba(200, 200, 200, 0.3)',
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
          }}
        />
        <div
          className="absolute"
          style={{
            top: size * 0.05,
            right: size * 0.15,
            width: size * 0.12,
            height: size * 0.12,
            borderRight: '2px solid #333'
          }}
        />
        
        {/* Eye in monocle */}
        <div
          className="absolute"
          style={{
            top: size * 0.08,
            right: size * 0.18,
            width: size * 0.06,
            height: size * 0.06,
            background: '#4A90E2',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        />
        
        {/* Other eye */}
        <div
          className="absolute"
          style={{
            top: size * 0.08,
            left: size * 0.2,
            width: size * 0.06,
            height: size * 0.06,
            background: '#4A90E2',
            borderRadius: '50%',
            border: '2px solid #000'
          }}
        />
        
        {/* Mouth - thoughtful expression */}
        <div
          className="absolute"
          style={{
            top: size * 0.2,
            left: '50%',
            transform: 'translateX(-50%)',
            width: size * 0.15,
            height: size * 0.05,
            borderBottom: '2px solid #000',
            borderRadius: '0 0 50% 50%'
          }}
        />
        
        {/* Magnifying glass - when active */}
        {activity === 'active' && (
          <div
            className="absolute"
            style={{
              top: size * 0.1,
              right: -size * 0.1,
              width: size * 0.2,
              height: size * 0.2,
              border: '3px solid #654321',
              borderRadius: '50%',
              background: 'rgba(200, 200, 200, 0.2)',
              transform: 'rotate(-10deg)',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            <div
              className="absolute bottom-0 right-0"
              style={{
                width: size * 0.15,
                height: size * 0.05,
                background: '#654321',
                borderRadius: '2px',
                transform: 'rotate(45deg) translate(20%, -20%)'
              }}
            />
          </div>
        )}
      </div>
    </MascotAnimation>
  );
}
</file>

<file path="components/MealBuilderWizard.tsx">
'use client';

import { useState, useMemo } from 'react';
import { X, ChevronRight, ChevronLeft, Check, Star, ArrowUp } from 'lucide-react';
import { createPortal } from 'react-dom';
import Image from 'next/image';
import { INGREDIENT_COMPOSITIONS, getIngredientComposition, type IngredientComposition } from '@/lib/data/ingredientCompositions';
import { getFallbackNutrition } from '@/lib/utils/nutritionFallbacks';

interface Category {
  name: string;
  description: string;
  icon: string;
  ingredients: string[];
  required: boolean;
}

interface MealBuilderWizardProps {
  isOpen: boolean;
  onClose: () => void;
  onComplete: (selections: { [category: string]: string[] }) => void;
  categories: {
    proteins: Category;
    grains: Category;
    greens: Category;
    fruits: Category;
    supplements: Category;
  };
  petName: string;
  petType?: string; // Pet species type (dogs, cats, pocket-pets, etc.)
  recommendedIngredients?: string[]; // List of recommended ingredient names
}

const CATEGORY_ORDER = ['proteins', 'grains', 'greens', 'fruits', 'supplements'] as const;

/**
 * Get the highest nutrient value for an ingredient
 * Returns the nutrient name and a normalized value for comparison
 */
function getTopNutrients(ingredientName: string, count: number = 3): Array<{ name: string; value: number }> {
  // Normalize ingredient name
  const normalized = ingredientName.toLowerCase()
    .trim()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '')
    .replace(/_+/g, '_');
  
  // Try to get composition
  let composition: IngredientComposition | null = INGREDIENT_COMPOSITIONS[normalized] || null;
  if (!composition) {
    composition = getIngredientComposition(ingredientName) || null;
  }
  if (!composition) {
    // Try fallback
    composition = getFallbackNutrition(ingredientName);
  }
  
  if (!composition) return [];
  
  // Define nutrients to check with their display names and normalization factors
  const nutrients = [
    { key: 'protein', name: 'Protein', value: composition.protein || 0, factor: 1 },
    { key: 'fat', name: 'Fat', value: composition.fat || 0, factor: 1 },
    { key: 'fiber', name: 'Fiber', value: composition.fiber || 0, factor: 1 },
    { key: 'calcium', name: 'Calcium', value: (composition.calcium || 0) / 100, factor: 100 }, // Convert mg to g for comparison
    { key: 'omega3', name: 'Omega-3', value: composition.omega3 || 0, factor: 1 },
    { key: 'taurine', name: 'Taurine', value: (composition.taurine || 0) / 100, factor: 100 }, // Convert mg to g
    { key: 'vitaminA', name: 'Vitamin A', value: (composition.vitaminA || 0) / 1000, factor: 1000 }, // Convert IU to thousands
    { key: 'vitaminC', name: 'Vitamin C', value: (composition.vitaminC || 0) / 100, factor: 100 }, // Convert mg to g
  ];
  
  // Calculate normalized values and filter out insignificant ones
  const nutrientsWithNormalized = nutrients
    .map(nutrient => ({
      ...nutrient,
      normalizedValue: nutrient.value * nutrient.factor
    }))
    .filter(nutrient => nutrient.normalizedValue > 0.1); // Only include significant values
  
  // Sort by normalized value (descending) and take top N
  const topNutrients = nutrientsWithNormalized
    .sort((a, b) => b.normalizedValue - a.normalizedValue)
    .slice(0, count)
    .map(nutrient => ({
      name: nutrient.name,
      value: nutrient.value
    }));
  
  return topNutrients;
}

export default function MealBuilderWizard({
  isOpen,
  onClose,
  onComplete,
  categories,
  petName,
  petType,
  recommendedIngredients = []
}: MealBuilderWizardProps) {
  const skipProteins = !categories.proteins.required || categories.proteins.ingredients.length === 0;
  const skipFruits = petType && ['dogs', 'cats', 'dog', 'cat'].includes(petType.toLowerCase());
  const stepOrder = CATEGORY_ORDER.filter((key) => {
    if (skipProteins && key === 'proteins') return false;
    if (skipFruits && key === 'fruits') return false;
    return true;
  });

  const [currentStep, setCurrentStep] = useState(0);
  const [selections, setSelections] = useState<{ [key: string]: string[] }>({
    proteins: [],
    grains: [],
    greens: [],
    fruits: [],
    supplements: []
  });

  if (!isOpen) return null;

  const currentCategoryKey = stepOrder[currentStep];
  const currentCategory = categories[currentCategoryKey];
  const isRequired = currentCategory.required;
  const currentSelections = selections[currentCategoryKey] || [];
  const hasSelection = currentSelections.length > 0;
  const hasIngredients = currentCategory.ingredients.length > 0;
  // Allow proceeding if: not required, OR has selection, OR required but no ingredients available
  const canProceed = !isRequired || hasSelection || !hasIngredients;
  const isLastStep = currentStep === stepOrder.length - 1;

  const handleSelect = (ingredient: string) => {
    setSelections(prev => {
      const current = prev[currentCategoryKey] || [];
      const isSelected = current.includes(ingredient);
      return {
        ...prev,
        [currentCategoryKey]: isSelected 
          ? current.filter(ing => ing !== ingredient)
          : [...current, ingredient]
      };
    });
  };

  const handleNext = () => {
    if (isLastStep) {
      onComplete(selections);
      handleClose();
    } else {
      setCurrentStep(prev => prev + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    }
  };

  const handleClose = () => {
    setCurrentStep(0);
    setSelections({
      proteins: [],
      grains: [],
      greens: [],
      fruits: [],
      supplements: []
    });
    onClose();
  };

  const wizardContent = (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: '#0f2c0f' }}>
      <div className="rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col" style={{ backgroundColor: '#143424' }}>
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: '#2d5a47' }}>
          <div>
            <h2 className="text-2xl font-bold text-gray-100">
              Create Meal for {petName}
            </h2>
            <p className="text-sm text-gray-300 mt-1">
              Step {currentStep + 1} of {stepOrder.length}
            </p>
          </div>
          <button
            onClick={handleClose}
            className="p-2 hover:opacity-80 rounded-full transition-colors"
            style={{ backgroundColor: '#2d5a47' }}
          >
            <X size={20} className="text-gray-200" />
          </button>
        </div>

        {/* Progress Bar */}
        <div className="px-6 py-4 border-b" style={{ backgroundColor: '#143424', borderColor: '#2d5a47' }}>
          <div className="flex gap-2">
            {stepOrder.map((key, index) => {
              const category = categories[key];
              const isActive = index === currentStep;
              const isCompleted = (selections[key] || []).length > 0;
              const isPast = index < currentStep;

              return (
                <div key={key} className="flex-1">
                  <div className="flex items-center gap-2">
                    <div
                      className={`flex-1 h-2 rounded-full transition-colors ${
                        isActive
                          ? 'bg-primary-600'
                          : isCompleted || isPast
                          ? 'bg-green-500'
                          : 'bg-gray-200'
                      }`}
                    />
                    {isCompleted && !isActive && (
                      <Check size={16} className="text-green-400 flex-shrink-0" />
                    )}
                  </div>
                  <div className="text-xs text-gray-300 mt-1 truncate">
                    {category.icon} {category.name}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Category Content */}
        <div className="flex-1 overflow-y-auto p-6">
          <div className="text-center mb-6">
            {currentStep === 0 && (
              <div className="mb-4 flex justify-center">
                <Image
                  src="/images/emojis/Mascots/PrepPuppy/PrepPuppyKitchen.jpg"
                  alt="Puppy Prepper"
                  width={240}
                  height={240}
                  className="w-[240px] h-[240px] object-contain"
                  unoptimized
                />
              </div>
            )}
            <div className="text-4xl mb-2">{currentCategory.icon}</div>
            <h3 className="text-xl font-semibold text-gray-100 mb-1">
              {currentCategory.name}
            </h3>
            <p className="text-sm text-gray-300">{currentCategory.description}</p>
            {isRequired && hasIngredients && (
              <p className="text-xs text-red-400 mt-2">* Required</p>
            )}
            {isRequired && !hasIngredients && (
              <p className="text-xs text-yellow-400 mt-2">‚ö† No ingredients available - you can skip this step</p>
            )}
          </div>

          {/* Ingredient List */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {currentCategory.ingredients.length === 0 ? (
              <div className="col-span-2 text-center py-8 text-gray-400">
                No ingredients available in this category for this pet.
              </div>
            ) : (() => {
              // Separate recommended and regular ingredients
              const recommended = currentCategory.ingredients.filter(ing => 
                recommendedIngredients.includes(ing)
              );
              const regular = currentCategory.ingredients.filter(ing => 
                !recommendedIngredients.includes(ing)
              );
              
              // Sort: recommended first, then regular
              const sortedIngredients = [...recommended, ...regular];
              
              return sortedIngredients.map(ingredient => {
                const isSelected = currentSelections.includes(ingredient);
                const isRecommended = recommendedIngredients.includes(ingredient);
                const topNutrients = getTopNutrients(ingredient, 3);
                
                return (
                  <button
                    key={ingredient}
                    onClick={() => handleSelect(ingredient)}
                    className="p-4 rounded-lg text-left transition-colors duration-200 relative"
                    style={{
                      border: isSelected ? '3px solid #f97316' : isRecommended ? '3px solid #fb923c' : '3px solid rgba(249, 115, 22, 0.5)',
                      backgroundColor: isSelected ? '#2d5a47' : isRecommended ? '#3d4a2e' : '#143424',
                      color: '#e5e7eb'
                    }}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2 flex-1 min-w-0">
                        {isRecommended && (
                          <Star size={16} className="text-yellow-400 fill-yellow-400 flex-shrink-0" />
                        )}
                        <span className="text-sm font-medium truncate text-gray-100">
                          {ingredient}
                        </span>
                      </div>
                      {isSelected && (
                        <Check size={18} className="text-green-400 flex-shrink-0 ml-2" />
                      )}
                    </div>
                    <div className="flex items-center justify-between mt-2 flex-wrap gap-2">
                      {isRecommended && (
                        <div className="text-xs text-yellow-300">
                          Recommended
                        </div>
                      )}
                      {topNutrients.length > 0 && (
                        <div className="flex items-center gap-2 ml-auto flex-wrap">
                          {topNutrients.map((nutrient, idx) => (
                            <div key={idx} className="flex items-center gap-1 text-xs text-orange-300">
                              <ArrowUp size={12} className="text-orange-400" />
                              <span>{nutrient.name}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </button>
                );
              });
            })()}
          </div>
        </div>

        {/* Footer Actions */}
        <div className="flex items-center justify-between p-6 border-t" style={{ borderColor: '#2d5a47', backgroundColor: '#143424' }}>
          <button
            onClick={handleBack}
            disabled={currentStep === 0}
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            style={{
              backgroundColor: '#2d5a47',
              border: '3px solid #f97316',
              color: '#e5e7eb'
            }}
          >
            <ChevronLeft size={16} />
            Back
          </button>

          <div className="flex gap-3">
            <button
              onClick={handleNext}
              disabled={!canProceed}
              className="flex items-center gap-2 px-6 py-2 text-sm font-medium text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              style={{
                backgroundColor: '#16a34a',
                border: '3px solid #f97316'
              }}
            >
              {isLastStep ? 'Complete' : 'Next'}
              {!isLastStep && <ChevronRight size={16} />}
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  // Use portal to render modal at root level
  if (typeof window !== 'undefined') {
    return createPortal(wizardContent, document.body);
  }

  return null;
}
</file>

<file path="components/MealCompleteView.tsx">
'use client';

import { useState, useEffect, useRef, useMemo } from 'react';
import { CheckCircle, AlertTriangle, XCircle, Info, Plus, Save, ShoppingCart, Star, ChevronLeft } from 'lucide-react';
import { MealAnalysis, IngredientSelection } from '@/lib/analyzeCustomMeal';
import MealCompositionList from '@/components/MealCompositionList';
import { generateMealName } from '@/lib/utils/mealNameGenerator';
import { saveCustomMeal } from '@/lib/utils/customMealStorage';
import { calculateEnhancedCompatibility, type Pet as EnhancedPet } from '@/lib/utils/enhancedCompatibilityScoring';
import type { Recipe } from '@/lib/types';
import Image from 'next/image';
import Tooltip from '@/components/Tooltip';
import { getPets } from '@/lib/utils/petStorage';
import { getRecommendationsForRecipe } from '@/lib/utils/nutritionalRecommendations';
import { logger } from '@/lib/utils/logger';
import { getProductByIngredient, getProductPrice, getProductUrl } from '@/lib/data/product-prices';
import { ShoppingList } from '@/components/ShoppingList';
import { CostComparison } from '@/components/CostComparison';
import { calculateMealsFromGroceryList } from '@/lib/utils/mealEstimation';
import Link from 'next/link';
import { checkAllBadges } from '@/lib/utils/badgeChecker';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';

interface MealCompleteViewProps {
  petName: string;
  petBreed: string;
  petAge: string;
  petWeight: string;
  petId: string;
  userId: string;
  selectedIngredients: IngredientSelection[];
  analysis: MealAnalysis | null;
  isAnalyzing: boolean;
  onUpdateAmount: (key: string, grams: number) => void;
  onRemove: (key: string) => void;
  onAddMore: () => void;
  onStartOver: () => void;
  getIngredientDisplayName: (key: string) => string;
  getCompatibilityIndicator?: (key: string) => 'safe' | 'warning' | 'blocked' | null;
  isFirstCreation?: boolean; // New prop to indicate if this is the first time creating the meal
  petType?: string; // Pet type (dog, cat, etc.)
}

export default function MealCompleteView({
  petName,
  petBreed,
  petAge,
  petWeight,
  petId,
  userId,
  selectedIngredients,
  analysis,
  isAnalyzing,
  onUpdateAmount,
  onRemove,
  onAddMore,
  onStartOver,
  getIngredientDisplayName,
  getCompatibilityIndicator,
  isFirstCreation = false,
  petType = 'dog' // Default to dog if not provided
}: MealCompleteViewProps) {
  const totalGrams = selectedIngredients.reduce((sum, s) => sum + s.grams, 0);
  const [mealName, setMealName] = useState<string>('');
  const [isSaving, setIsSaving] = useState(false);
  const [isSaved, setIsSaved] = useState(false);
  const [pet, setPet] = useState<any>(null);
  const [healthAnalysis, setHealthAnalysis] = useState<any>(null);
  const [isCalculatingHealthAnalysis, setIsCalculatingHealthAnalysis] = useState(false);
  const [activeTab, setActiveTab] = useState<'ingredients' | 'supplements'>('ingredients');

  const handleSaveMeal = async () => {
    if (!analysis || !mealName.trim()) {
      return;
    }

    setIsSaving(true);
    try {
      await saveCustomMeal(userId, petId, mealName.trim(), selectedIngredients, analysis);
      setIsSaved(true);
    } catch (error) {
      logger.error('Error saving meal:', error);
      setIsSaved(false);
    } finally {
      setIsSaving(false);
    }
  };

  // Load pet data for health analysis
  useEffect(() => {
    async function loadPet() {
      try {
        const pets = await getPets(userId);
        const foundPet = pets.find((p: any) => p.id === petId);
        if (foundPet) {
          setPet(foundPet);
        }
      } catch (error) {
        console.error('Failed to load pet:', error);
      }
    }
    if (userId && petId) {
      loadPet();
    }
  }, [userId, petId]);

  // Diagnostic logging - MOVED BELOW DECLARATIONS to avoid TDZ error

  // Calculate health analysis when analysis and ingredients are available
  // We can work with pet props directly if pet object isn't loaded yet
  useEffect(() => {
    if (!analysis || selectedIngredients.length === 0) {
      setHealthAnalysis(null);
      setIsCalculatingHealthAnalysis(false);
      return;
    }

    // Set calculating state
    setIsCalculatingHealthAnalysis(true);

    try {
      // Convert custom meal to Recipe format
      const recipe: Recipe = {
        id: `custom-meal-${Date.now()}`,
        name: mealName || 'Custom Meal',
        category: petType || 'dog',
        ageGroup: [petAge === 'baby' ? 'baby' : petAge === 'young' ? 'young' : petAge === 'senior' ? 'senior' : 'adult'],
        healthConcerns: [],
        ingredients: selectedIngredients.map((ing, idx) => ({
          id: `${idx + 1}`,
          name: getIngredientDisplayName(ing.key),
          amount: `${ing.grams}g`,
        })),
        instructions: [],
        nutritionalInfo: analysis.nutrients ? {
          protein: {
            min: (analysis.nutrients.protein_g || 0) / (totalGrams / 100),
            max: (analysis.nutrients.protein_g || 0) / (totalGrams / 100),
            unit: '%',
          },
          fat: {
            min: (analysis.nutrients.fat_g || 0) / (totalGrams / 100),
            max: (analysis.nutrients.fat_g || 0) / (totalGrams / 100),
            unit: '%',
          },
        } : undefined,
        // Add nutritionalCalculation field with actual analysis data for enhanced compatibility scoring
        nutritionalCalculation: analysis.nutrients ? {
          protein_g: analysis.nutrients.protein_g || 0,
          fat_g: analysis.nutrients.fat_g || 0,
          ca_mg: analysis.nutrients.ca_mg || 0,
          p_mg: analysis.nutrients.p_mg || 0,
          calories_kcal: analysis.nutrients.calories_kcal || analysis.nutrients.kcal || analysis.nutrients.energy_kcal || 0,
          fiber_g: analysis.nutrients.fiber_g || 0,
          totalGrams: totalGrams,
        } : undefined,
      } as any;

      // Convert pet to EnhancedPet format
      // Use pet object if available, otherwise use props directly
      const enhancedPet: EnhancedPet = {
        id: pet?.id || petId,
        name: petName,
        type: (petType || pet?.type || 'dog') as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
        breed: petBreed || pet?.breed || '',
        age: petAge === 'baby' ? 0.5 : petAge === 'young' ? 2 : petAge === 'senior' ? 10 : 5,
        weight: parseFloat(petWeight) || pet?.weightKg || 10,
        activityLevel: pet?.activityLevel || 'moderate',
        healthConcerns: pet?.healthConcerns || [],
        dietaryRestrictions: pet?.allergies || [],
        allergies: pet?.allergies || [],
      };

      const enhanced = calculateEnhancedCompatibility(recipe, enhancedPet);
      
      // Get nutritional recommendations
      const nutritionalGaps = enhanced.detailedBreakdown.nutritionalGaps || [];
      const recommendations = getRecommendationsForRecipe(
        nutritionalGaps,
        enhancedPet.type,
        enhancedPet.healthConcerns || []
      );
      
      // Format breakdown similar to recipe detail page
      const getReasonWithIssues = (factor: typeof enhanced.factors.ingredientSafety) => {
        if (factor.issues.length > 0) {
          return factor.issues.join('; ') + (factor.reasoning ? ` (${factor.reasoning})` : '');
        }
        return factor.reasoning || '';
      };

      setHealthAnalysis({
        overallScore: enhanced.overallScore,
        compatibility: enhanced.grade === 'A+' || enhanced.grade === 'A' ? 'excellent' :
                       enhanced.grade === 'B+' || enhanced.grade === 'B' ? 'good' :
                       enhanced.grade === 'C+' || enhanced.grade === 'C' ? 'fair' : 'poor',
        breakdown: {
          petTypeMatch: { 
            score: enhanced.factors.ingredientSafety.score,
            weightedContribution: Math.round(enhanced.factors.ingredientSafety.score * enhanced.factors.ingredientSafety.weight),
            weight: enhanced.factors.ingredientSafety.weight,
            reason: getReasonWithIssues(enhanced.factors.ingredientSafety)
          },
          ageAppropriate: { 
            score: enhanced.factors.lifeStageFit.score,
            weightedContribution: Math.round(enhanced.factors.lifeStageFit.score * enhanced.factors.lifeStageFit.weight),
            weight: enhanced.factors.lifeStageFit.weight,
            reason: getReasonWithIssues(enhanced.factors.lifeStageFit)
          },
          nutritionalFit: { 
            score: enhanced.factors.nutritionalAdequacy.score,
            weightedContribution: Math.round(enhanced.factors.nutritionalAdequacy.score * enhanced.factors.nutritionalAdequacy.weight),
            weight: enhanced.factors.nutritionalAdequacy.weight,
            reason: getReasonWithIssues(enhanced.factors.nutritionalAdequacy),
            recommendations: recommendations // Add recommendations to nutritional fit
          },
          healthCompatibility: { 
            score: enhanced.factors.healthAlignment.score,
            weightedContribution: Math.round(enhanced.factors.healthAlignment.score * enhanced.factors.healthAlignment.weight),
            weight: enhanced.factors.healthAlignment.weight,
            reason: getReasonWithIssues(enhanced.factors.healthAlignment)
          },
          activityFit: {
            score: enhanced.factors.activityFit.score,
            weightedContribution: Math.round(enhanced.factors.activityFit.score * enhanced.factors.activityFit.weight),
            weight: enhanced.factors.activityFit.weight,
            reason: getReasonWithIssues(enhanced.factors.activityFit)
          },
          allergenSafety: { 
            score: enhanced.factors.allergenSafety.score,
            weightedContribution: Math.round(enhanced.factors.allergenSafety.score * enhanced.factors.allergenSafety.weight),
            weight: enhanced.factors.allergenSafety.weight,
            reason: getReasonWithIssues(enhanced.factors.allergenSafety)
          },
        },
        warnings: enhanced.detailedBreakdown.warnings,
        strengths: enhanced.detailedBreakdown.healthBenefits,
        nutritionalGaps: nutritionalGaps,
        recommendations: recommendations,
      });

      // Check badges if score is 100% (Nutrient Navigator)
      if (enhanced.overallScore === 100 && userId && petId) {
        checkAllBadges(userId, petId, {
          action: 'meal_created',
          compatibilityScore: enhanced.overallScore,
        }).catch(err => {
          logger.error('Failed to check badges', err);
        });
      }

      // Successfully calculated
      setIsCalculatingHealthAnalysis(false);
    } catch (error) {
      // Log error but don't hide the compatibility score
      console.error('Error calculating enhanced health analysis:', error);
      logger.error('Error calculating enhanced health analysis', error);
      // Keep existing healthAnalysis if there was one, otherwise null
      // Don't set to null here - let the fallback score show instead
      setIsCalculatingHealthAnalysis(false);
    }
  }, [pet, analysis, selectedIngredients, mealName, petName, petBreed, petAge, petWeight, petType, petId, getIngredientDisplayName, totalGrams, userId]);

  // Generate meal name when ingredients are first set
  useEffect(() => {
    if (selectedIngredients.length > 0 && !mealName) {
      const ingredientKeys = selectedIngredients.map(ing => ing.key);
      
      // Extract nutritional profile from analysis
      const nutritionalProfile = analysis ? {
        protein: analysis.nutrients?.protein_g ? (analysis.nutrients.protein_g / totalGrams) * 100 : undefined,
        fat: analysis.nutrients?.fat_g ? (analysis.nutrients.fat_g / totalGrams) * 100 : undefined,
        fiber: analysis.nutrients?.fiber_g ? (analysis.nutrients.fiber_g / totalGrams) * 100 : undefined,
      } : undefined;
      
      const result = generateMealName(ingredientKeys, {
        petName,
        petBreed,
        petSpecies: petType,
        healthConcerns: pet?.healthConcerns || [],
        nutritionalProfile,
        mealType: 'complete',
        isCustomMeal: true,
      });
      
      setMealName(result.fullName);
    }
  }, [selectedIngredients, mealName, analysis, totalGrams, petName, petBreed, petType, pet]);


  // Calculate recommended amounts per ingredient based on total recommended serving
  const calculateRecommendedAmounts = (): { [key: string]: number } => {
    if (!analysis || !analysis.recommendedServingGrams || analysis.recommendedServingGrams <= 0) {
      return {};
    }

    const recommendedTotal = analysis.recommendedServingGrams;
    const currentTotal = totalGrams;
    
    if (currentTotal <= 0) return {};

    // Distribute recommended total proportionally based on current ingredient ratios
    const recommendedAmounts: { [key: string]: number } = {};
    selectedIngredients.forEach(ing => {
      const ratio = ing.grams / currentTotal;
      recommendedAmounts[ing.key] = Math.round(recommendedTotal * ratio);
    });

    return recommendedAmounts;
  };

  const recommendedAmounts = calculateRecommendedAmounts();

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600 bg-green-50 border-green-200';
    if (score >= 60) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
    return 'text-red-600 bg-red-50 border-red-200';
  };

  const getScoreIcon = (score: number) => {
    if (score >= 80) return <CheckCircle size={24} className="text-green-600" />;
    if (score >= 60) return <AlertTriangle size={24} className="text-yellow-600" />;
    return <XCircle size={24} className="text-red-600" />;
  };

  const getProgressGradientColor = (score: number) => {
    if (score === 0) return '#dc2626'; // red-600
    if (score <= 10) return '#dc2626'; // red-600
    if (score <= 20) return '#ea580c'; // orange-600
    if (score <= 30) return '#d97706'; // amber-600
    if (score <= 40) return '#ca8a04'; // yellow-600
    if (score <= 50) return '#a3a3a3'; // gray-400 (neutral)
    if (score <= 60) return '#84cc16'; // lime-500
    if (score <= 70) return '#65a30d'; // lime-700
    if (score <= 80) return '#16a34a'; // green-600
    if (score <= 90) return '#15803d'; // green-700
    return '#166534'; // green-800
  };


  // Get display score and compatibility
  const displayScore = healthAnalysis?.overallScore ?? (analysis?.score ?? 0);
  const compatibility = healthAnalysis?.compatibility ?? 
    (displayScore >= 80 ? 'excellent' : displayScore >= 60 ? 'good' : displayScore >= 40 ? 'fair' : 'poor');

  // Prepare ingredients for ShoppingList (memoized)
  const ingredientsWithASINs = useMemo(() => {
    console.log('[MealCompleteView] ========== ingredientsWithASINs Calculation ==========');
    console.log('[MealCompleteView] selectedIngredients:', selectedIngredients);
    console.log('[MealCompleteView] selectedIngredients.length:', selectedIngredients.length);
    
    const result = selectedIngredients
      .map((ing, index) => {
        console.log(`[MealCompleteView] Processing ingredient ${index + 1}:`, ing);
        const displayName = getIngredientDisplayName(ing.key);
        console.log(`[MealCompleteView]   Display name from getIngredientDisplayName:`, displayName);
        
        const link = getProductUrl(displayName);
        console.log(`[MealCompleteView]   Product-prices purchase link:`, link);
        
        if (link) {
          const item = {
            id: ing.key,
            name: displayName,
            amount: `${ing.grams}g`,
            asinLink: ensureSellerId(link)
          };
          console.log(`[MealCompleteView]   ‚úÖ Added to ingredientsWithASINs:`, item);
          return item;
        }
        console.log(`[MealCompleteView]   ‚ùå No link found, skipping ingredient`);
        return null;
      })
      .filter(Boolean) as Array<{ id: string; name: string; amount: string; asinLink: string }>;
    
    console.log('[MealCompleteView] Final ingredientsWithASINs array:', result);
    console.log('[MealCompleteView] ingredientsWithASINs.length:', result.length);
    console.log('[MealCompleteView] =====================================================');
    return result;
  }, [selectedIngredients, getIngredientDisplayName]);

  const ingredientsWithoutASINs = useMemo(() => {
    return selectedIngredients
      .filter(ing => {
        const displayName = getIngredientDisplayName(ing.key);
        const link = getProductUrl(displayName);
        return !link;
      })
      .map(ing => ({
        id: ing.key,
        name: getIngredientDisplayName(ing.key),
        amount: `${ing.grams}g`,
      }));
  }, [selectedIngredients, getIngredientDisplayName]);

  // Get recommended supplements
  const recommendedSupplements = healthAnalysis?.recommendations || [];

  // Calculate meal estimate only for CostComparison component
  const mealEstimateForCost = useMemo(() => {
    console.log('[MealCompleteView] Calculating mealEstimateForCost...');
    console.log('[MealCompleteView] ingredientsWithASINs:', ingredientsWithASINs);
    
    if (!ingredientsWithASINs || ingredientsWithASINs.length === 0) {
      console.log('[MealCompleteView] No ingredients with ASINs, returning null');
      return null;
    }
    
    try {
      const shoppingListItems = ingredientsWithASINs.map(ing => {
        return {
          id: ing.id,
          name: ing.name,
          amount: ing.amount,
          category: undefined
        };
      });
      
      console.log('[MealCompleteView] Shopping list items for calculation:', shoppingListItems);
      
      // Calculate total cost using product-prices.json when available, otherwise fall back to package estimates
      const totalCost = ingredientsWithASINs.reduce((sum, item) => {
        const price = getProductPrice(item.name);
        return typeof price === 'number' ? sum + price : sum;
      }, 0);
      
      const result = calculateMealsFromGroceryList(shoppingListItems);
      // Override totalCost with the one calculated from ShoppingList logic to ensure they match
      if (result) {
        result.totalCost = totalCost;
        result.costPerMeal = result.estimatedMeals > 0 ? totalCost / result.estimatedMeals : 0;
      }
      console.log('[MealCompleteView] mealEstimateForCost result:', result);
      return result;
    } catch (error) {
      console.error('[MealCompleteView] Error calculating meal estimate for cost:', error);
      return null;
    }
  }, [ingredientsWithASINs]);

  // Diagnostic logging - NOW AFTER DECLARATIONS
  useEffect(() => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/0b2cb572-34bf-468c-9297-dd079c8c4c2d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'MealCompleteView.tsx:463',message:'Diagnostic useEffect executing',data:{hasIngredientsWithASINs:!!ingredientsWithASINs,length:ingredientsWithASINs?.length,hasMealEstimate:!!mealEstimateForCost},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    console.group('üîç MealCompleteView Diagnostic');
    console.log('selectedIngredients:', selectedIngredients);
    console.log('selectedIngredients.length:', selectedIngredients.length);
    console.log('ingredientsWithASINs:', ingredientsWithASINs);
    console.log('ingredientsWithASINs.length:', ingredientsWithASINs.length);
    if (ingredientsWithASINs.length > 0) {
      const testItem = ingredientsWithASINs[0];
      console.log('First ingredient:', testItem);
      const pricedUrl = getProductUrl(testItem.name);
      console.log('Product-prices url for first ingredient:', pricedUrl);
    }
    console.log('mealEstimateForCost:', mealEstimateForCost);
    console.groupEnd();
  }, [selectedIngredients, ingredientsWithASINs, mealEstimateForCost]);

  return (
    <div className="min-h-screen bg-background py-12 font-sans text-foreground">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Breadcrumb */}
        <Link
          href={`/profile/pet/${petId}`}
          className="inline-flex items-center text-gray-400 hover:text-primary-400 mb-6 font-medium transition-colors"
        >
          <ChevronLeft className="w-5 h-5 mr-1" />
          Back to Pet Profile
        </Link>

        <div className="grid grid-cols-1 lg:grid-cols-5 gap-10">
          <main className="lg:col-span-3">
            {/* Recipe Info Card */}
            <div className="bg-surface rounded-2xl shadow-xl overflow-hidden mb-8 border border-surface-highlight">
              <div className="p-8">
                {/* Meal Name Input */}
                <div className="mb-4">
                  <label className="block text-xs font-medium text-gray-400 mb-2">Meal Name</label>
                  <input
                    type="text"
                    value={mealName}
                    onChange={(e) => setMealName(e.target.value)}
                    className="w-full px-4 py-2 text-4xl font-extrabold text-foreground bg-surface-highlight border border-surface-highlight rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                    placeholder="Enter meal name..."
                  />
            </div>

                {/* Health Concerns */}
                {pet?.healthConcerns && pet.healthConcerns.length > 0 && (
                  <div className="mb-4 flex flex-wrap gap-2">
                    {pet.healthConcerns.map((concern: string) => (
                      <span
                        key={concern}
                        className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-900/40 text-orange-200 border border-orange-700/50"
                      >
                        {concern.replace(/-/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase())}
                      </span>
                    ))}
                  </div>
                )}

                {/* Compatibility Score - Big Progress Bar */}
                {analysis && (
                  <div className={`mb-6 rounded-xl border-2 p-6 ${
                    displayScore >= 80 ? 'bg-green-900/20 border-green-700/50 text-green-200' :
                    displayScore >= 60 ? 'bg-yellow-900/20 border-yellow-700/50 text-yellow-200' :
                    'bg-red-900/20 border-red-700/50 text-red-200'
                  }`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        {displayScore >= 80 ? <CheckCircle size={24} className="text-green-400" /> :
                         displayScore >= 60 ? <AlertTriangle size={24} className="text-yellow-400" /> :
                         <XCircle size={24} className="text-red-400" />}
                        <h3 className="font-semibold text-xl">Compatibility Score</h3>
                      </div>
                      <div className="text-4xl font-bold">{displayScore}/100</div>
                    </div>
                    
                    {/* Progress Bar */}
                    <div className="w-full bg-black/30 rounded-full h-4 mb-3">
                      <div
                        className={`h-4 rounded-full transition-[width] duration-500 ease-out will-change-[width] ${
                          displayScore >= 80 ? 'bg-green-600' :
                          displayScore >= 60 ? 'bg-yellow-600' :
                          'bg-red-600'
                        }`}
                        style={{ width: `${displayScore}%` }}
                      />
                    </div>

                    <div className="text-sm opacity-90">
                      {isCalculatingHealthAnalysis && !healthAnalysis && 'Calculating enhanced score...'}
                      {healthAnalysis && (displayScore >= 80 ? '‚úì Excellent match for your pet' :
                                         displayScore >= 60 ? '‚ö† Good, but could be improved' :
                                         '‚úó Needs adjustments for safety')}
                      {!isCalculatingHealthAnalysis && !healthAnalysis && (displayScore >= 80 ? '‚úì Excellent match for your pet' :
                                         displayScore >= 60 ? '‚ö† Good, but could be improved' :
                                         '‚úó Needs adjustments for safety')}
                    </div>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex gap-3 mb-6">
              {isSaved ? (
                    <div className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-green-600 bg-green-900/40 border border-green-700/50 rounded-md">
                  <CheckCircle size={16} />
                  Meal Saved
                </div>
              ) : (
                <button
                  onClick={handleSaveMeal}
                  disabled={isSaving || !analysis || !mealName.trim()}
                  className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <Save size={16} />
                  {isSaving ? 'Saving...' : 'Save Meal'}
                </button>
              )}
              <button
                onClick={onAddMore}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-300 bg-surface-highlight border border-surface-highlight rounded-md hover:bg-surface-highlight/80 transition-colors"
              >
                <Plus size={16} />
                Add More Ingredients
              </button>
              <button
                onClick={onStartOver}
                className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 transition-colors"
              >
                <Plus size={16} />
                Create New Meal
              </button>
            </div>

                {/* Description placeholder */}
                <p className="text-gray-300 mb-8 leading-relaxed text-lg">
                  Custom meal created for {petName}. Adjust ingredient amounts to optimize nutritional balance.
                </p>

                {/* Tags */}
                <div className="flex flex-wrap gap-2 mb-8">
                  <span className="bg-surface-highlight text-gray-300 px-3 py-1 rounded-full text-sm font-medium border border-surface-highlight">
                    custom
                  </span>
                  <span className="bg-surface-highlight text-gray-300 px-3 py-1 rounded-full text-sm font-medium border border-surface-highlight">
                    user-created
                  </span>
          </div>
        </div>
      </div>

            {/* Ingredients & Supplements Tabs */}
            <div className="bg-surface rounded-2xl shadow-lg p-8 mb-8 border border-surface-highlight">
              {/* Tab Navigation */}
              <div className="flex border-b border-surface-highlight mb-6">
                <button
                  onClick={() => setActiveTab('ingredients')}
                  className={`px-6 py-3 font-semibold text-sm border-b-2 transition-colors ${
                    activeTab === 'ingredients'
                      ? 'border-orange-500 text-orange-400'
                      : 'border-transparent text-gray-500 hover:text-gray-300'
                  }`}
                >
                  Ingredients
                </button>
                <button
                  onClick={() => setActiveTab('supplements')}
                  className={`px-6 py-3 font-semibold text-sm border-b-2 transition-colors ${
                    activeTab === 'supplements'
                      ? 'border-orange-500 text-orange-400'
                      : 'border-transparent text-gray-500 hover:text-gray-300'
                  }`}
                >
                  Supplements
                </button>
              </div>

              {/* Tab Content */}
              {activeTab === 'ingredients' && (
                <div className="relative">
                  <div className="space-y-6">
                    {/* Ingredients with ASIN links */}
                    {ingredientsWithASINs.length > 0 && (
                      <ShoppingList
                        ingredients={ingredientsWithASINs}
                        recipeName={mealName || 'Custom Meal'}
                        userId={userId}
                        selectedIngredients={selectedIngredients}
                        totalGrams={totalGrams}
                        recommendedServingGrams={analysis?.recommendedServingGrams}
                      />
                    )}
                    
                    {/* Ingredients without ASIN links */}
                    {ingredientsWithoutASINs.length > 0 && (
                      <div className="bg-surface-lighter rounded-lg border border-surface-highlight p-6">
                        <h3 className="text-lg font-semibold text-foreground mb-4">
                          Additional Ingredients
                        </h3>
                        <div className="space-y-2">
                          {ingredientsWithoutASINs.map((ing, index) => (
                            <div
                              key={ing.id || index}
                              className="flex items-center justify-between p-3 bg-surface rounded-lg border border-surface-highlight"
                            >
                              <div className="flex-1">
                                <div className="font-medium text-gray-200">{ing.name}</div>
                                <div className="text-sm text-gray-400 mt-1">
                                  {ing.amount}
                                  {recommendedAmounts[ing.id] && recommendedAmounts[ing.id] !== parseFloat(ing.amount.replace('g', '')) && (
                                    <span className="text-orange-400 ml-2">
                                      (Recommended: {recommendedAmounts[ing.id]}g)
                                    </span>
                                  )}
                                </div>
                              </div>
                              <button
                                onClick={() => onRemove(ing.id)}
                                className="p-1.5 rounded hover:bg-red-900/30 text-gray-400 hover:text-red-400 transition-colors ml-2"
                                title="Remove ingredient"
                              >
                                <XCircle size={18} />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {selectedIngredients.length === 0 && (
                      <div className="text-center py-8 text-gray-400 text-sm">
                        No ingredients added yet.
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'supplements' && (
                <div className="relative space-y-6">
                  {/* Recommended Supplements */}
                  {recommendedSupplements.length > 0 && (
                    <div className="bg-orange-900/20 border border-orange-700/50 rounded-lg p-6">
                      <h3 className="text-lg font-semibold text-orange-200 mb-4 flex items-center gap-2">
                        <span>üíä</span>
                        Recommended Supplements
                      </h3>
                      <p className="text-sm text-gray-400 mb-4">
                        These supplements can help address nutritional deficiencies in this meal:
                      </p>
                      <div className="space-y-3">
                        {recommendedSupplements.map((supplement: any, index: number) => (
                          <div key={index} className="bg-surface rounded-lg p-4 border border-surface-highlight">
                            <div className="flex items-start justify-between gap-4">
                              <div className="flex-1">
                                <h5 className="font-semibold text-gray-200">{supplement.productName || supplement.name}</h5>
                                <p className="text-sm text-gray-400 mt-1">{supplement.description}</p>
                                <p className="text-xs text-orange-300 mt-2">
                                  Addresses: {supplement.addressesDeficiency}
                                </p>
                                <p className="text-sm text-gray-300 mt-2">
                                  <strong>Benefits:</strong> {supplement.benefits}
                                </p>
                                <p className="text-sm text-gray-400 mt-1">
                                  <strong>Amount:</strong> {supplement.defaultAmount}
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {recommendedSupplements.length === 0 && (
                    <div className="text-center py-8 text-gray-500">
                      <p>No supplements recommended for this meal.</p>
                      <p className="text-sm mt-2">Check the ingredients tab for all components.</p>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Safety Alerts */}
            {analysis && (analysis.toxicityWarnings.length > 0 || analysis.allergyWarnings.length > 0) && (
              <div className="bg-red-900/20 border border-red-700/50 rounded-lg p-6 mb-8">
                <div className="flex items-center gap-2 mb-4">
                  <AlertTriangle size={20} className="text-red-400" />
                  <h2 className="text-lg font-semibold text-red-200">Safety Alerts</h2>
                </div>
                <div className="space-y-3">
                  {analysis.toxicityWarnings.map((warning, idx) => (
                    <div key={idx} className="text-sm text-red-300">
                      <div className="font-medium">‚ö†Ô∏è {warning.ingredientName || warning.ingredientKey}</div>
                      <div className="text-xs mt-1 opacity-90">{warning.message}</div>
                    </div>
                  ))}
                  {analysis.allergyWarnings.map((warning, idx) => (
                    <div key={idx} className="text-sm text-red-300">
                      <div className="font-medium">‚ö†Ô∏è {typeof warning === 'string' ? warning : warning.message}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Recommendations */}
            {analysis && analysis.suggestions.length > 0 && (
              <div className="bg-blue-900/20 border border-blue-700/50 rounded-lg p-6 mb-8">
                <div className="flex items-center gap-2 mb-4">
                  <Info size={20} className="text-blue-400" />
                  <h2 className="text-lg font-semibold text-blue-200">Recommendations</h2>
                </div>
                <div className="space-y-2">
                  {analysis.suggestions.map((suggestion, idx) => (
                    <div key={idx} className="text-sm text-blue-300">
                      üí° {typeof suggestion === 'string' ? suggestion : suggestion.message}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Cost Comparison */}
            {ingredientsWithASINs.length > 0 && mealEstimateForCost && mealEstimateForCost.costPerMeal > 0 && (
              <div className="mb-8">
                <CostComparison 
                  costPerMeal={mealEstimateForCost.costPerMeal}
                  totalCost={mealEstimateForCost.totalCost}
                  estimatedMeals={mealEstimateForCost.estimatedMeals}
                  exceedsBudget={mealEstimateForCost.exceedsBudget || false}
                />
              </div>
            )}
          </main>

          {/* Sidebar */}
          <aside className="lg:col-span-2 space-y-6">
            {/* Health Analysis Panel */}
            {healthAnalysis && (
              <div className="bg-surface rounded-2xl shadow-lg p-6 border-l-4 border-green-500 border border-surface-highlight">
                <h4 className="text-lg font-bold mb-4 flex items-center justify-center text-gray-200">
                  <span className="text-2xl mr-2">üè•</span>
                  Health Analysis
                </h4>
                <div className="mb-4 flex justify-center">
                  <Image
                    src="/images/emojis/Mascots/Proffessor Purfessor/PUrfessorDesk.jpg"
                    alt="Professor Purfessor"
                    width={280}
                    height={210}
                    className="rounded-lg object-contain"
                    unoptimized
                  />
                </div>
                <p className="text-xs text-gray-400 mb-4">
                  Proffessor Purfessor has found these individual factors that contribute to the overall compatibility score
                </p>
                <div className="space-y-3">
                  {Object.entries(healthAnalysis.breakdown).map(([key, factor]) => {
                    const f = factor as { score: number; weightedContribution?: number; weight: number; reason?: string; recommendations?: any[] };
                    const score = f.score || 0;
                    const weightedContribution = f.weightedContribution ?? Math.round(score * (f.weight || 0));
                    const weight = f.weight || 0;

                    let bgColor = 'bg-green-900/20 border-green-700/50';
                    let icon = '‚úÖ';
                    let textColor = 'text-green-200';

                    if (score < 70) {
                      bgColor = 'bg-yellow-900/20 border-yellow-700/50';
                      icon = '‚ö†Ô∏è';
                      textColor = 'text-yellow-200';
                    }
                    if (score < 40) {
                      bgColor = 'bg-red-900/20 border-red-700/50';
                      icon = '‚ùå';
                      textColor = 'text-red-200';
                    }

                    const factorName = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                    const formattedFactorName = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    
                    let tooltipContent = `üìä ${formattedFactorName}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nRaw Score: ${score}%\nWeight: ${(weight * 100).toFixed(0)}%\nContribution: ${weightedContribution} points\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n${f.reason ? `üí° ${f.reason}` : 'No additional details available'}`;
                    
                    if (key === 'nutritionalFit' && f.recommendations && f.recommendations.length > 0) {
                      tooltipContent += '\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nüíä Recommendations:\n';
                      const supplements = f.recommendations.filter((r: any) => !r.isIngredient);
                      const ingredients = f.recommendations.filter((r: any) => r.isIngredient);
                      
                      if (supplements.length > 0) {
                        tooltipContent += `\nCheck Supplements tab for: ${supplements.map((r: any) => r.productName || r.name).join(', ')}`;
                      }
                      if (ingredients.length > 0) {
                        tooltipContent += `\nCheck Ingredients tab for: ${ingredients.map((r: any) => r.name).join(', ')}`;
                      }
                    }

                    return (
                      <Tooltip key={key} content={tooltipContent} wide={key === 'nutritionalFit'}>
                        <div className={`flex items-center justify-between p-3 ${bgColor} rounded-lg border cursor-help hover:opacity-80 transition-colors`}>
                          <div className="flex items-center gap-2">
                            <span className="text-sm">{icon}</span>
                            <span className={`text-sm font-medium capitalize ${textColor}`}>
                              {factorName}
                            </span>
                          </div>
                          <div className="flex flex-col items-end">
                            <span className={`text-sm font-bold ${textColor}`}>
                              {score}%
                            </span>
                            <span className="text-xs text-gray-400">
                              +{weightedContribution} pts
                            </span>
                          </div>
                        </div>
                      </Tooltip>
                    );
                  })}
                </div>

                {/* Compatibility Score Summary */}
                <div className="mt-4 pt-4 border-t border-surface-highlight">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-300">Compatibility Score:</span>
                    <span className={`text-lg font-bold ${
                      healthAnalysis.overallScore >= 80 ? 'text-green-400' :
                      healthAnalysis.overallScore >= 60 ? 'text-yellow-400' :
                      'text-red-400'
                    }`}>
                      {healthAnalysis.overallScore}%
                    </span>
                  </div>
                  <p className="text-xs text-gray-400 mt-2">
                    {healthAnalysis.overallScore >= 80 ? 'Excellent nutritional balance for your pet!' :
                     healthAnalysis.overallScore >= 60 ? 'Good balance with some areas for improvement.' :
                     'Needs nutritional adjustments for optimal health.'}
                  </p>
                </div>
              </div>
            )}

            {/* Nutritional Summary */}
            {analysis && (
              <div className="bg-surface rounded-lg border border-surface-highlight p-6">
                <h3 className="text-sm font-semibold text-gray-200 mb-3">Nutritional Summary</h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Weight:</span>
                    <span className="font-medium text-gray-200">{totalGrams}g</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Calories:</span>
                    <span className="font-medium text-gray-200">
                      {((analysis.nutrients as any).kcal ?? (analysis.nutrients as any).calories_kcal ?? (analysis.nutrients as any).energy_kcal ?? 0).toFixed(0)} kcal
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Protein:</span>
                    <span className="font-medium text-gray-200">
                      {((analysis.nutrients as any).protein_g ?? 0).toFixed(1)}g
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Fat:</span>
                    <span className="font-medium text-gray-200">
                      {((analysis.nutrients as any).fat_g ?? 0).toFixed(1)}g
                    </span>
                  </div>
                  {analysis.caToPratio && (
                    <div className="flex justify-between">
                      <span className="text-gray-400">Ca:P Ratio:</span>
                      <span className="font-medium text-gray-200">{analysis.caToPratio.toFixed(2)}</span>
                    </div>
                  )}
                  {analysis.recommendedServingGrams > 0 && (
                    <div className="flex justify-between pt-2 border-t border-surface-highlight">
                      <span className="text-gray-300 font-medium">Recommended Serving:</span>
                      <span className="font-semibold text-orange-400">{analysis.recommendedServingGrams}g</span>
                    </div>
                  )}
                </div>
              </div>
            )}
          </aside>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/MealCompositionList.tsx">
'use client';

import { X, ExternalLink } from 'lucide-react';
import { IngredientSelection } from '@/lib/analyzeCustomMeal';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';
import { getProductPriceAmount, getProductPriceUrl } from '@/lib/data/product-prices';

// Format price for display
const formatPrice = (price: number) => {
  return `$${price.toFixed(2)}`;
};

interface MealCompositionListProps {
  ingredients: IngredientSelection[];
  onRemove: (key: string) => void;
  getIngredientDisplayName: (key: string) => string;
  getCompatibilityIndicator?: (key: string) => 'safe' | 'warning' | 'blocked' | null;
  recommendedAmounts?: { [key: string]: number }; // Recommended grams per ingredient
}

export default function MealCompositionList({
  ingredients,
  onRemove,
  getIngredientDisplayName,
  getCompatibilityIndicator,
  recommendedAmounts = {}
}: MealCompositionListProps) {
  return (
    <div className="space-y-4">
      <div className="space-y-2">
        {ingredients.length === 0 ? (
          <div className="text-center py-8 text-gray-400 text-sm">
            No ingredients added yet. Search and select ingredients above.
          </div>
        ) : (
          ingredients.map(ing => {
            const displayName = getIngredientDisplayName(ing.key);
            const indicator = getCompatibilityIndicator?.(ing.key) || null;
            const purchaseLink = getProductPriceUrl(displayName);
            const hasPurchaseLink = !!purchaseLink;
            const price = getProductPriceAmount(displayName);
            
            return (
              <div
                key={ing.key}
                className="flex items-center justify-between gap-3 p-3 bg-surface-lighter rounded-lg border border-surface-highlight hover:border-gray-500 transition-all duration-200"
              >
                <div className="flex items-center gap-3 flex-1 min-w-0">
                  {/* Compatibility Indicator */}
                  {indicator && (
                    <div className={`w-2 h-2 rounded-full flex-shrink-0 ${
                      indicator === 'safe' ? 'bg-green-500' :
                      indicator === 'warning' ? 'bg-yellow-500' :
                      'bg-red-500'
                    }`} />
                  )}

                  {/* Ingredient Name */}
                  <div className="flex-1 min-w-0 pr-2">
                    <div className="font-medium text-gray-200 truncate">
                      {displayName}
                    </div>
                    <div className="flex items-center gap-3 mt-1 text-xs text-gray-400">
                      <span>Current: {ing.grams}g</span>
                      {recommendedAmounts[ing.key] && recommendedAmounts[ing.key] !== ing.grams && (
                        <span className="text-orange-400 font-medium">
                          Recommended: {recommendedAmounts[ing.key]}g
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                {/* Price Display */}
                {price && (
                  <div className="text-right mr-3">
                    <div className="text-lg font-bold text-orange-400">{formatPrice(price)}</div>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex items-center gap-2 flex-shrink-0">
                  {/* Buy Button */}
                  {hasPurchaseLink && (
                    <a
                      href={ensureSellerId(purchaseLink)}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 px-4 py-2 bg-[#FF9900] hover:bg-[#E07704] text-black rounded-lg transition-all duration-200 text-sm font-semibold whitespace-nowrap hover:shadow-md"
                    >
                      Buy
                      <ExternalLink size={14} />
                    </a>
                  )}

                  {/* Delete Button */}
                  <button
                    onClick={() => onRemove(ing.key)}
                    className="p-1.5 rounded hover:bg-red-900/30 text-gray-400 hover:text-red-400 transition-colors"
                    title="Remove ingredient"
                  >
                    <X size={18} />
                  </button>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}
</file>

<file path="components/MultiPetShoppingModal.tsx">
'use client';

import React, { useState, useMemo } from 'react';
import { X, ShoppingCart, Check } from 'lucide-react';
import { Pet } from '@/lib/types';
import { addPurchase } from '@/lib/utils/purchaseTracking';
import { useVillageStore } from '@/lib/state/villageStore';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';
import { getProductPrice } from '@/lib/data/product-prices';

// Format price for display
const formatPrice = (price: number) => {
  return `$${price.toFixed(2)}`;
};

interface MultiPetShoppingModalProps {
  isOpen: boolean;
  onClose: () => void;
  pets: Pet[];
  userId: string;
}

export default function MultiPetShoppingModal({
  isOpen,
  onClose,
  pets,
  userId
}: MultiPetShoppingModalProps) {
  const [selectedPets, setSelectedPets] = useState<Set<string>>(new Set(pets.map(p => p.id)));
  const [isOpening, setIsOpening] = useState(false);
  const { refreshFromLocal } = useVillageStore();

  const togglePet = (petId: string) => {
    const newSelected = new Set(selectedPets);
    if (newSelected.has(petId)) {
      newSelected.delete(petId);
    } else {
      newSelected.add(petId);
    }
    setSelectedPets(newSelected);
  };

  // Aggregate all ingredients from all selected pets' saved meals
  const allIngredients = useMemo(() => {
    const ingredientMap = new Map<string, {
      name: string;
      asinLink: string;
      count: number;
      petNames: string[];
    }>();

    pets.forEach(pet => {
      if (!selectedPets.has(pet.id)) return;
      
      const petName = pet.names?.[0] || 'Pet';
      const savedRecipes = pet.savedRecipes || [];
      
      savedRecipes.forEach(recipeId => {
        const recipe = recipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        recipe.ingredients?.forEach(ing => {
          const link = (ing as any).asinLink || ing.amazonLink;
          if (!link) return;
          
          const key = `${ing.name}-${link}`;
          const existing = ingredientMap.get(key);
          
          if (existing) {
            existing.count++;
            if (!existing.petNames.includes(petName)) {
              existing.petNames.push(petName);
            }
          } else {
            ingredientMap.set(key, {
              name: ing.name,
              asinLink: link,
              count: 1,
              petNames: [petName]
            });
          }
        });
      });
    });

    return Array.from(ingredientMap.values());
  }, [pets, selectedPets]);

  const totalItems = allIngredients.length;
  const selectedPetCount = selectedPets.size;

  // Calculate total price
  const totalPrice = useMemo(() => {
    return allIngredients.reduce((sum, ing) => {
      const price = getProductPrice(ing.name);
      if (typeof price === 'number') return sum + price;
      return sum;
    }, 0);
  }, [allIngredients]);

  const handleBuyAll = async () => {
    setIsOpening(true);

    // Open first tab
    if (allIngredients.length > 0) {
      window.open(ensureSellerId(allIngredients[0].asinLink), '_blank');
      if (userId) {
        addPurchase(userId, allIngredients[0].name, false, allIngredients[0].name);
      }
    }

    // Open remaining tabs
    for (let i = 1; i < allIngredients.length; i++) {
      await new Promise(resolve => setTimeout(resolve, 800));
      window.open(ensureSellerId(allIngredients[i].asinLink), '_blank');
      if (userId) {
        addPurchase(userId, allIngredients[i].name, false, allIngredients[i].name);
      }
    }

    refreshFromLocal();

    setTimeout(() => {
      setIsOpening(false);
      onClose();
    }, 1000);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="bg-surface border-2 border-orange-500/50 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-[#043136] to-[#0f2c0f] px-6 py-5 border-b-2 border-orange-500/30 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
              <ShoppingCart className="text-orange-400" size={28} />
              Shop for All Your Pets
            </h2>
            <p className="text-gray-300 text-sm mt-1">
              Bundle ingredients and save time
            </p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-white transition-colors p-2"
          >
            <X size={28} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto max-h-[calc(85vh-200px)]">
          {/* Pet Selection */}
          <div className="mb-6">
            <h3 className="text-lg font-semibold text-white mb-3">
              Select pets to shop for:
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {pets.map(pet => {
                const petName = pet.names?.[0] || 'Pet';
                const isSelected = selectedPets.has(pet.id);
                
                return (
                  <button
                    key={pet.id}
                    onClick={() => togglePet(pet.id)}
                    className={`p-4 rounded-xl border-2 transition-all ${
                      isSelected
                        ? 'bg-orange-500/20 border-orange-500 text-white'
                        : 'bg-surface-highlight border-surface-highlight text-gray-400 hover:border-gray-500'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <div className={`w-6 h-6 rounded border-2 flex items-center justify-center ${
                        isSelected ? 'bg-orange-500 border-orange-400' : 'bg-transparent border-gray-500'
                      }`}>
                        {isSelected && <Check size={16} className="text-white" />}
                      </div>
                      <div className="text-left">
                        <div className="font-semibold">{petName}</div>
                        <div className="text-xs capitalize">{pet.type}</div>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>

          {/* Summary */}
          {selectedPetCount > 0 && (
            <div className="bg-green-900/20 border border-green-700/30 rounded-xl p-5 mb-6">
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div className="text-3xl font-bold text-orange-400">{selectedPetCount}</div>
                  <div className="text-xs text-gray-400 mt-1">Pets Selected</div>
                </div>
                <div>
                  <div className="text-3xl font-bold text-green-400">{totalItems}</div>
                  <div className="text-xs text-gray-400 mt-1">Ingredients</div>
                </div>
                <div>
                  <div className="text-3xl font-bold text-blue-400">
                    {Math.max(...allIngredients.map(i => i.count))}x
                  </div>
                  <div className="text-xs text-gray-400 mt-1">Max Uses</div>
                </div>
              </div>
            </div>
          )}

          {/* Ingredient Preview */}
          {totalItems > 0 && (
            <div className="mb-6">
              <h3 className="text-sm font-semibold text-gray-400 mb-3">
                Combined Shopping List:
              </h3>
              <div className="max-h-60 overflow-y-auto space-y-2">
                {allIngredients.slice(0, 10).map((ing, idx) => (
                  <div
                    key={idx}
                    className="flex items-center justify-between p-2 bg-surface-highlight rounded-lg text-sm"
                  >
                    <span className="text-gray-300">{ing.name}</span>
                    <span className="text-orange-400 font-semibold">
                      Used in {ing.count} meal{ing.count > 1 ? 's' : ''}
                    </span>
                  </div>
                ))}
                {totalItems > 10 && (
                  <p className="text-xs text-gray-500 text-center py-2">
                    + {totalItems - 10} more ingredients
                  </p>
                )}
              </div>
            </div>
          )}

          {/* Big CTA Button */}
          <button
            onClick={handleBuyAll}
            disabled={isOpening || selectedPetCount === 0}
            className={`w-full py-6 px-8 rounded-xl font-black text-2xl transition-all transform ${
              isOpening || selectedPetCount === 0
                ? 'bg-gray-600 cursor-not-allowed text-gray-400 scale-95'
                : 'bg-gradient-to-r from-[#FF9900] via-[#F08804] to-[#FF9900] hover:from-[#E07704] hover:via-[#D07604] hover:to-[#E07704] text-black shadow-2xl hover:shadow-orange-500/50 hover:scale-105 border-4 border-orange-300 animate-pulse'
            }`}
          >
            {isOpening ? (
              <span className="flex items-center justify-center gap-3">
                <div className="animate-spin rounded-full h-7 w-7 border-b-4 border-white"></div>
                OPENING TABS...
              </span>
            ) : (
              <span className="flex flex-col items-center justify-center gap-1">
                <span className="flex items-center gap-3">
                  <ShoppingCart size={32} />
                  BUY ALL FOR {selectedPetCount} PET{selectedPetCount > 1 ? 'S' : ''}!
                </span>
                {totalPrice > 0 && (
                  <span className="text-2xl font-bold">
                    Total: {formatPrice(totalPrice)}
                  </span>
                )}
              </span>
            )}
          </button>

          {selectedPetCount === 0 && (
            <p className="text-center text-gray-500 text-sm mt-3">
              Select at least one pet to continue
            </p>
          )}
        </div>

        {/* Trust Footer */}
        <div className="bg-surface-lighter px-6 py-4 border-t border-surface-highlight">
          <p className="text-xs text-gray-400 text-center leading-relaxed">
            <span className="font-semibold text-green-400">üåü Smart Shopping:</span> We've combined all ingredients across your pets' meal plans, 
            so you buy each item once. Your price stays the same, and you support free pet nutrition resources!
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/Navigation.tsx">
'use client';

import Link from 'next/link';
import Image from 'next/image';
import { Menu, X } from 'lucide-react';
import { useState } from 'react';
import { useUser, UserButton } from '@clerk/nextjs';

export default function Navigation() {
  const [isOpen, setIsOpen] = useState(false);
  const { isSignedIn, isLoaded } = useUser();

  return (
    <nav className="bg-surface border-b border-surface-highlight sticky top-0 z-50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center h-16">
          <Link href="/" className="flex items-center space-x-2">
            <div className="h-10 w-10 relative">
              <Image
                src="/images/emojis/GREENPAW.jpeg"
                alt="Paw & Plate logo"
                fill
                className="object-contain rounded-md"
                sizes="40px"
                priority
              />
            </div>
            <div className="flex flex-col">
              <span className="text-2xl font-bold text-foreground">Paw & Plate</span>
              <span className="text-xs text-gray-400 -mt-1 leading-tight">Meal prep made easy, for ALL your pets!</span>
            </div>
          </Link>

          <div className="hidden md:flex items-center space-x-8">
            <Link href="/about" className="text-gray-300 hover:text-orange-400 transition-colors">
              About
            </Link>
            <Link href="/blog" className="text-gray-300 hover:text-orange-400 transition-colors">
              Blog
            </Link>
            <Link href="/forum" className="text-gray-300 hover:text-orange-400 transition-colors">
              Community
            </Link>
            
            {isLoaded && (
              <>
                {!isSignedIn ? (
                  <Link
                    href="/sign-in"
                    className="btn btn-primary btn-md btn-ripple"
                  >
                    Sign In
                  </Link>
                ) : (
                  <>
                    <Link href="/profile" className="text-gray-300 hover:text-orange-400 transition-colors">
                      My Pets
                    </Link>
                    <UserButton afterSignOutUrl="/" />
                  </>
                )}
              </>
            )}
          </div>

          <div className="md:hidden">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="btn btn-ghost btn-icon"
            >
              {isOpen ? <X className="h-6 w-6" /> : <Menu className="h-6 w-6" />}
            </button>
          </div>
        </div>

        {isOpen && (
          <div className="md:hidden pb-4">
            <div className="flex flex-col space-y-4">
              <Link href="/about" className="text-gray-300 hover:text-orange-400">
                About
              </Link>
              <Link href="/blog" className="text-gray-300 hover:text-orange-400">
                Blog
              </Link>
              <Link href="/forum" className="text-gray-300 hover:text-orange-400">
                Community
              </Link>
              
              {isLoaded && (
                <>
                  {!isSignedIn ? (
                    <Link
                      href="/sign-in"
                      className="btn btn-primary btn-md btn-ripple"
                    >
                      Sign In
                    </Link>
                  ) : (
                    <>
                      <Link href="/profile" className="text-gray-300 hover:text-orange-400">
                        My Pets
                      </Link>
                      <UserButton afterSignOutUrl="/" />
                    </>
                  )}
                </>
              )}
            </div>
          </div>
        )}
      </div>
    </nav>
  );
}
</file>

<file path="components/NutritionDashboard.tsx">
'use client';

import React from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } from 'recharts';
import { Activity, Target, TrendingUp } from 'lucide-react';
import { DailyNutrition, NutritionTargets } from '@/lib/nutrition/nutritionHistory';

interface NutritionDashboardProps {
  daily: DailyNutrition[];
  targets: NutritionTargets;
  petName: string;
}

export function NutritionDashboard({ daily, targets, petName }: NutritionDashboardProps) {
  const summary = {
    avgCalories: daily.reduce((sum, d) => sum + d.calories, 0) / daily.length || 0,
    avgProtein: daily.reduce((sum, d) => sum + d.protein, 0) / daily.length || 0,
    avgFat: daily.reduce((sum, d) => sum + d.fat, 0) / daily.length || 0,
    avgCarbs: daily.reduce((sum, d) => sum + d.carbs, 0) / daily.length || 0,
    avgFiber: daily.reduce((sum, d) => sum + (d.fiber || 0), 0) / daily.length || 0,
  };

  const getStatusColor = (value: number, range?: [number, number]) => {
    if (!range) return 'text-gray-500';
    if (value >= range[0] && value <= range[1]) return 'text-green-600';
    return 'text-amber-600';
  };

  const getStatusText = (value: number, range?: [number, number]) => {
    if (!range) return 'No target';
    if (value >= range[0] && value <= range[1]) return 'On target';
    return 'Outside range';
  };

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Nutrition Dashboard</h1>
        <p className="text-lg text-gray-600">Weekly nutrition overview for {petName}</p>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="bg-white p-4 rounded-lg shadow border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Calories</p>
              <p className="text-2xl font-bold">{Math.round(summary.avgCalories)}</p>
            </div>
            <Activity className="w-8 h-8 text-orange-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Protein (g)</p>
              <p className={`text-2xl font-bold ${getStatusColor(summary.avgProtein, targets.proteinRange)}`}>
                {summary.avgProtein.toFixed(1)}
              </p>
              <p className="text-xs text-gray-500">{getStatusText(summary.avgProtein, targets.proteinRange)}</p>
            </div>
            <Target className="w-8 h-8 text-blue-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Fat (g)</p>
              <p className={`text-2xl font-bold ${getStatusColor(summary.avgFat, targets.fatRange)}`}>
                {summary.avgFat.toFixed(1)}
              </p>
              <p className="text-xs text-gray-500">{getStatusText(summary.avgFat, targets.fatRange)}</p>
            </div>
            <Target className="w-8 h-8 text-red-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Carbs (g)</p>
              <p className={`text-2xl font-bold ${getStatusColor(summary.avgCarbs, targets.carbsRange)}`}>
                {summary.avgCarbs.toFixed(1)}
              </p>
              <p className="text-xs text-gray-500">{getStatusText(summary.avgCarbs, targets.carbsRange)}</p>
            </div>
            <TrendingUp className="w-8 h-8 text-green-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow border">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Fiber (g)</p>
              <p className={`text-2xl font-bold ${getStatusColor(summary.avgFiber, targets.fiberRange)}`}>
                {summary.avgFiber.toFixed(1)}
              </p>
              <p className="text-xs text-gray-500">{getStatusText(summary.avgFiber, targets.fiberRange)}</p>
            </div>
            <Target className="w-8 h-8 text-orange-500" />
          </div>
        </div>
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Calories Chart */}
        <div className="bg-white p-6 rounded-lg shadow border">
          <h3 className="text-lg font-semibold mb-4">Daily Calories</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={daily}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="day" />
              <YAxis />
              <Tooltip />
              <Line type="monotone" dataKey="calories" stroke="#f97316" strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        </div>

        {/* Protein Chart */}
        <div className="bg-white p-6 rounded-lg shadow border">
          <h3 className="text-lg font-semibold mb-4">Daily Protein</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={daily}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="day" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="protein" fill="#3b82f6" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Fat Chart */}
        <div className="bg-white p-6 rounded-lg shadow border">
          <h3 className="text-lg font-semibold mb-4">Daily Fat</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={daily}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="day" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="fat" fill="#ef4444" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Carbs & Fiber Chart */}
        <div className="bg-white p-6 rounded-lg shadow border">
          <h3 className="text-lg font-semibold mb-4">Daily Carbs & Fiber</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={daily}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="day" />
              <YAxis />
              <Tooltip />
              <Line type="monotone" dataKey="carbs" stroke="#10b981" strokeWidth={2} />
              <Line type="monotone" dataKey="fiber" stroke="#8b5cf6" strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Target Ranges Info */}
      <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
        <h3 className="text-lg font-semibold text-blue-900 mb-3">Target Ranges</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <p className="font-medium">Protein:</p>
            <p className="text-blue-700">
              {targets.proteinRange ? `${targets.proteinRange[0]}-${targets.proteinRange[1]}g` : 'No target'}
            </p>
          </div>
          <div>
            <p className="font-medium">Fat:</p>
            <p className="text-blue-700">
              {targets.fatRange ? `${targets.fatRange[0]}-${targets.fatRange[1]}g` : 'No target'}
            </p>
          </div>
          <div>
            <p className="font-medium">Carbs:</p>
            <p className="text-blue-700">
              {targets.carbsRange ? `${targets.carbsRange[0]}-${targets.carbsRange[1]}g` : 'No target'}
            </p>
          </div>
          <div>
            <p className="font-medium">Fiber:</p>
            <p className="text-blue-700">
              {targets.fiberRange ? `${targets.fiberRange[0]}-${targets.fiberRange[1]}g` : 'No target'}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/OfflineBanner.tsx">
// components/OfflineBanner.tsx
// Banner to show when app is offline

'use client';

import React from 'react';
import { WifiOff } from 'lucide-react';
import { useOfflineDetector } from '@/hooks/useOfflineDetector';

export function OfflineBanner() {
  const { isOffline } = useOfflineDetector();

  if (!isOffline) return null;

  return (
    <div className="fixed top-0 left-0 right-0 z-50 bg-amber-500 text-white px-4 py-2 shadow-lg">
      <div className="max-w-7xl mx-auto flex items-center justify-center gap-2">
        <WifiOff size={18} />
        <span className="text-sm font-medium">
          You're offline. Changes will sync when you reconnect.
        </span>
      </div>
    </div>
  );
}

export default OfflineBanner;
</file>

<file path="components/OneClickCheckoutModal.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { X, ShoppingCart, Check, Loader2 } from 'lucide-react';
import { addPurchase } from '@/lib/utils/purchaseTracking';
import { useVillageStore } from '@/lib/state/villageStore';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';
import { getProductPrice } from '@/lib/data/product-prices';
import { calculateMealsFromShoppingList } from '@/lib/utils/mealCalculator';

// Format price for display
const formatPrice = (price: number) => {
  return `$${price.toFixed(2)}`;
};

interface CheckoutItem {
  id: string;
  name: string;
  asinLink: string;
  amount?: string;
  asin?: string;
}

interface OneClickCheckoutModalProps {
  isOpen: boolean;
  onClose: () => void;
  items: CheckoutItem[];
  recipeName?: string;
  userId?: string; // Optional userId for purchase tracking
  // Optional props for meal calculation
  selectedIngredients?: Array<{ key: string; grams: number }>;
  totalGrams?: number;
  recommendedServingGrams?: number;
}

export default function OneClickCheckoutModal({
  isOpen,
  onClose,
  items,
  recipeName = 'Recipe',
  userId,
  selectedIngredients,
  totalGrams,
  recommendedServingGrams
}: OneClickCheckoutModalProps) {
  // Get userId from localStorage if not provided
  const getUserId = () => {
    if (userId) return userId;
    if (typeof window === 'undefined') return '';
    return localStorage.getItem('last_user_id') || '';
  };
  const { refreshFromLocal } = useVillageStore();
  const [currentStep, setCurrentStep] = useState(0);
  const [addedItems, setAddedItems] = useState<Set<number>>(new Set());
  const [isAdding, setIsAdding] = useState(false);
  const [mode, setMode] = useState<'manual' | 'auto' | null>(null);

  // Reset when modal opens
  useEffect(() => {
    if (isOpen) {
      setCurrentStep(0);
      setAddedItems(new Set());
      setIsAdding(false);
      setMode(null);
    }
  }, [isOpen]);

  // Helper to extract ASIN from URL
  const extractASIN = (url: string): string | undefined => {
    // Try /dp/ASIN pattern
    const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})/);
    if (dpMatch) return dpMatch[1];
    
    // Try /gp/product/ASIN pattern
    const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})/);
    if (gpMatch) return gpMatch[1];
    
    // Try ASIN parameter
    const asinParam = new URL(url).searchParams.get('ASIN');
    if (asinParam) return asinParam;
    
    return undefined;
  };

  // Add item via hidden iframe (most reliable method)
  const addItemViaIframe = async (item: CheckoutItem, index: number): Promise<boolean> => {
    return new Promise((resolve) => {
      const currentUserId = getUserId();
      
      // Track purchase when item is added (pending confirmation)
      if (currentUserId) {
        addPurchase(currentUserId, item.id || item.name, false, item.name);
        refreshFromLocal(); // Update village store
      }
      
      // Extract ASIN from URL if available
      let asin = item.asin;
      if (!asin && item.asinLink) {
        asin = extractASIN(item.asinLink);
      }

      if (asin) {
        // Use Amazon's add-to-cart API
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'position:fixed;top:-10000px;left:-10000px;width:1px;height:1px;opacity:0;pointer-events:none;';
        iframe.src = `https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=${asin}&Quantity.1=1&tag=robinfrench-20`;
        
        iframe.onload = () => {
          setTimeout(() => {
            try {
              document.body.removeChild(iframe);
            } catch (e) {
              // Iframe might already be removed
            }
            resolve(true);
          }, 1500);
        };
        
        iframe.onerror = () => {
          try {
            document.body.removeChild(iframe);
          } catch (e) {}
          resolve(false);
        };
        
        document.body.appendChild(iframe);
      } else {
        // Fallback: open in new tab (ensure seller ID)
        window.open(ensureSellerId(item.asinLink), '_blank');
        resolve(true);
      }
    });
  };

  // Add next item manually
  const addNextItem = async () => {
    if (currentStep >= items.length || isAdding) return;
    
    setIsAdding(true);
    const item = items[currentStep];
    
    const success = await addItemViaIframe(item, currentStep);
    
    if (success) {
      setAddedItems(new Set([...addedItems, currentStep]));
      setCurrentStep(currentStep + 1);
    }
    
    setIsAdding(false);
  };

  // Add all items automatically
  const addAllAutomatically = async () => {
    if (isAdding) return;
    
    setMode('auto');
    setIsAdding(true);
    
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      setCurrentStep(i);
      
      await addItemViaIframe(item, i);
      setAddedItems(new Set([...addedItems, i]));
      
      // Wait between items to avoid rate limiting
      if (i < items.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
    
    setIsAdding(false);
    setCurrentStep(items.length);
  };

  // Open all in new tabs (manual method)
  const openAllInTabs = () => {
    setMode('manual');
    const currentUserId = getUserId();
    items.forEach((item, index) => {
      setTimeout(() => {
        window.open(ensureSellerId(item.asinLink), '_blank');
        // Track purchase when item is opened
        if (currentUserId) {
          addPurchase(currentUserId, item.id || item.name, false, item.name);
        }
        setAddedItems(new Set([...addedItems, index]));
      }, index * 500); // Stagger opens
    });
    if (currentUserId) {
      refreshFromLocal(); // Update village store after all items
    }
    setCurrentStep(items.length);
  };

  if (!isOpen) return null;

  // Safety check for empty items
  if (items.length === 0) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div className="bg-surface rounded-2xl shadow-2xl border border-surface-highlight max-w-md w-full p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-foreground">No Items Available</h2>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-200 transition-colors"
            >
              <X size={24} />
            </button>
          </div>
          <p className="text-gray-400 mb-4">This recipe doesn't have any ingredients with purchase links.</p>
          <button
            onClick={onClose}
            className="w-full bg-primary-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    );
  }

  // Calculate total price
  const totalPrice = useMemo(() => {
    return items.reduce((sum, item) => {
      const price = getProductPrice(item.name);
      if (typeof price === 'number') return sum + price;
      return sum;
    }, 0);
  }, [items]);

  // Calculate how many meals this shopping list will provide
  const mealsCount = useMemo(() => {
    if (selectedIngredients && totalGrams && recommendedServingGrams) {
      return calculateMealsFromShoppingList(
        items.map(item => ({ id: item.id, name: item.name, amount: item.amount || '' })),
        selectedIngredients,
        totalGrams,
        recommendedServingGrams
      );
    }
    return null;
  }, [items, selectedIngredients, totalGrams, recommendedServingGrams]);

  const progress = (currentStep / items.length) * 100;
  const allAdded = currentStep >= items.length;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-surface rounded-2xl shadow-2xl border border-surface-highlight max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-surface border-b border-surface-highlight p-6 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-foreground">One-Click Shopping</h2>
            <p className="text-sm text-gray-400 mt-1">Add all ingredients to your Amazon cart</p>
            {mealsCount !== null && mealsCount > 0 && (
              <p className="text-sm text-orange-400 font-semibold mt-1">
                This shopping list will provide approximately <strong>{mealsCount} meal{mealsCount !== 1 ? 's' : ''}</strong>
              </p>
            )}
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-200 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        {/* Progress Bar */}
        <div className="px-6 pt-6">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-gray-400">
              {currentStep} of {items.length} items
            </span>
            <span className="text-sm font-medium text-gray-400">
              {Math.round(progress)}%
            </span>
          </div>
          <div className="w-full bg-surface-highlight rounded-full h-3 overflow-hidden">
            <div
              className="bg-primary-600 h-full transition-all duration-300 ease-out"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Item List */}
        <div className="px-6 py-4 space-y-2 max-h-96 overflow-y-auto">
          {items.map((item, index) => {
            const isAdded = addedItems.has(index);
            const isCurrent = index === currentStep && isAdding;
            
            return (
              <div
                key={item.id || index}
                className={`flex items-center justify-between p-3 rounded-lg border-2 transition-all ${
                  isAdded
                    ? 'bg-green-900/20 border-green-500/50'
                    : isCurrent
                    ? 'bg-blue-900/20 border-blue-500/50'
                    : 'bg-surface-lighter border-surface-highlight'
                }`}
              >
                <div className="flex-1">
                  <div className="font-medium text-gray-200">{item.name}</div>
                  {item.amount && (
                    <div className="text-sm text-gray-400">{item.amount}</div>
                  )}
                </div>
                {/* Price Display */}
                {(() => {
                  const price = getProductPrice(item.name);
                  return price ? (
                    <div className="text-right mr-3">
                      <div className="text-lg font-bold text-orange-400">{formatPrice(price)}</div>
                    </div>
                  ) : null;
                })()}
                <div className="flex items-center gap-3">
                  {isAdded ? (
                    <div className="flex items-center gap-2 text-green-400">
                      <Check size={20} />
                      <span className="text-sm font-medium">Added</span>
                    </div>
                  ) : isCurrent ? (
                    <div className="flex items-center gap-2 text-blue-400">
                      <Loader2 size={20} className="animate-spin" />
                      <span className="text-sm font-medium">Adding...</span>
                    </div>
                  ) : (
                    <button
                      onClick={() => {
                        setCurrentStep(index);
                        addItemViaIframe(item, index).then(success => {
                          if (success) {
                            setAddedItems(new Set([...addedItems, index]));
                          }
                        });
                      }}
                      className="text-sm text-blue-400 hover:text-blue-300 font-medium"
                      disabled={isAdding}
                    >
                      Add Now
                    </button>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {/* Action Buttons */}
        <div className="sticky bottom-0 bg-surface border-t border-surface-highlight p-6 space-y-3">
          {!allAdded && (
            <div className="flex gap-3">
              <button
                onClick={addNextItem}
                disabled={isAdding || currentStep >= items.length}
                className="flex-1 bg-primary-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isAdding && mode === null ? (
                  <>
                    <Loader2 size={20} className="animate-spin" />
                    Adding...
                  </>
                ) : (
                  <>
                    <ShoppingCart size={20} />
                    Add Next Item
                  </>
                )}
              </button>

              <button
                onClick={addAllAutomatically}
                disabled={isAdding}
                className="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isAdding && mode === 'auto' ? (
                  <>
                    <Loader2 size={20} className="animate-spin" />
                    Adding All...
                  </>
                ) : (
                  <>
                    <ShoppingCart size={20} />
                    Add All Automatically
                  </>
                )}
              </button>
            </div>
          )}

          {allAdded && (
            <a
              href="https://www.amazon.com/gp/cart/view.html"
              target="_blank"
              rel="noopener noreferrer"
              className="block w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-center flex items-center justify-center gap-2"
            >
              <ShoppingCart size={20} />
              Go to Amazon Cart ({items.length} items)
              {totalPrice > 0 && (
                <span className="ml-2 text-xl font-bold">
                  ‚Ä¢ {formatPrice(totalPrice)}
                </span>
              )}
            </a>
          )}

          {/* Alternative: Open all in tabs */}
          {!allAdded && (
            <button
              onClick={openAllInTabs}
              className="w-full text-gray-400 hover:text-gray-300 font-medium py-2 text-sm transition-colors"
            >
              Or open all links in new tabs (manual)
            </button>
          )}

          {/* Instructions */}
          <div className="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-800/30">
            <p className="text-sm text-blue-300 font-medium mb-2">How this works:</p>
            <ol className="text-xs text-blue-200 space-y-1 list-decimal list-inside">
              <li>We add each item to your Amazon cart one by one</li>
              <li>This happens in the background (you may see tabs open/close)</li>
              <li>When complete, click "Go to Amazon Cart" to checkout</li>
            </ol>
          </div>
        </div>
      </div>

    </div>
  );
}
</file>

<file path="components/PetBadges.tsx">
// components/PetBadges.tsx
// Badge display component for pet profile cards

'use client';

import { useEffect, useState } from 'react';
import type { PetBadges as PetBadgesType, BadgeType } from '@/lib/types/badges';
import { getPetBadges } from '@/lib/utils/badgeStorage';
import { getBadgeDefinition, getTierDefinition } from '@/lib/data/badgeDefinitions';
import Image from 'next/image';
import Tooltip from './Tooltip';

interface PetBadgesProps {
  petId: string;
  userId: string;
  className?: string;
}

export default function PetBadges({ petId, userId, className = '' }: PetBadgesProps) {
  const [badges, setBadges] = useState<PetBadgesType>({ badges: [] });

  useEffect(() => {
    if (!petId || !userId) return;
    
    const loadedBadges = getPetBadges(userId, petId);
    setBadges(loadedBadges);
    
    // Listen for badge updates
    const handleBadgeUpdate = () => {
      const updatedBadges = getPetBadges(userId, petId);
      setBadges(updatedBadges);
    };
    
    window.addEventListener('badgesUpdated', handleBadgeUpdate);
    return () => window.removeEventListener('badgesUpdated', handleBadgeUpdate);
  }, [petId, userId]);

  if (!badges.badges || badges.badges.length === 0) {
    return null;
  }

  return (
    <div className={`flex flex-wrap gap-2 ${className}`}>
      {badges.badges.map((badge) => {
        const definition = getBadgeDefinition(badge.type);
        if (!definition) return null;

        // Get icon path (use tier-specific for progressive badges)
        let iconPath = definition.iconPath;
        if (definition.isProgressive && badge.tier) {
          const tierDef = getTierDefinition(badge.type, badge.tier);
          if (tierDef) {
            iconPath = tierDef.iconPath;
          }
        }

        // Get display name
        let displayName = definition.name;
        if (definition.isProgressive && badge.tier) {
          const tierDef = getTierDefinition(badge.type, badge.tier);
          if (tierDef) {
            displayName = tierDef.name;
          }
        }

        // Build tooltip content
        let tooltipContent = `${displayName}\n\n${definition.description}`;
        if (definition.isProgressive && badge.progress !== undefined) {
          tooltipContent += `\n\nProgress: ${badge.progress}`;
          if (badge.nextTierThreshold) {
            tooltipContent += ` / ${badge.nextTierThreshold}`;
          }
        }

        return (
          <Tooltip key={`${badge.type}-${badge.tier || 'single'}`} content={tooltipContent} wide={true}>
            <div className="relative group">
              <div className="w-10 h-10 rounded-full bg-surface-highlight border border-white/10 flex items-center justify-center hover:scale-110 transition-transform cursor-help">
                <Image
                  src={iconPath}
                  alt={displayName}
                  width={32}
                  height={32}
                  className="object-contain no-invert-badge"
                  unoptimized
                  onError={(e) => {
                    // Fallback to placeholder if image doesn't exist
                    (e.target as HTMLImageElement).src = '/images/badges/placeholder.png';
                  }}
                />
              </div>
              {/* Progress indicator for progressive badges */}
              {definition.isProgressive && badge.progress !== undefined && badge.nextTierThreshold && (
                <div className="absolute -bottom-1 left-0 right-0 h-1 bg-gray-700 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-orange-400 transition-all"
                    style={{
                      width: `${Math.min(100, (badge.progress / badge.nextTierThreshold) * 100)}%`,
                    }}
                  />
                </div>
              )}
            </div>
          </Tooltip>
        );
      })}
    </div>
  );
}

/**
 * Badge preview grid component (optional, for profile editor)
 */
export function BadgePreviewGrid({ className = '' }: { className?: string }) {
  const { BADGE_DEFINITIONS } = require('@/lib/data/badgeDefinitions');
  const definitions = Object.values(BADGE_DEFINITIONS);

  return (
    <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 ${className}`}>
      {definitions.map((def: any) => {
        if (def.isProgressive && def.tiers) {
          return def.tiers.map((tier: any) => (
            <div key={`${def.type}-${tier.tier}`} className="text-center">
              <div className="w-16 h-16 mx-auto mb-2 rounded-full bg-surface-highlight border border-white/10 flex items-center justify-center">
                <Image
                  src={tier.iconPath}
                  alt={tier.name}
                  width={48}
                  height={48}
                  className="object-contain opacity-50 no-invert-badge"
                  unoptimized
                  onError={(e) => {
                    (e.target as HTMLImageElement).src = '/images/badges/placeholder.png';
                  }}
                />
              </div>
              <p className="text-xs text-gray-400">{tier.name}</p>
            </div>
          ));
        } else {
          return (
            <div key={def.type} className="text-center">
              <div className="w-16 h-16 mx-auto mb-2 rounded-full bg-surface-highlight border border-white/10 flex items-center justify-center">
                <Image
                  src={def.iconPath}
                  alt={def.name}
                  width={48}
                  height={48}
                  className="object-contain opacity-50 no-invert-badge"
                  unoptimized
                  onError={(e) => {
                    (e.target as HTMLImageElement).src = '/images/badges/placeholder.png';
                  }}
                />
              </div>
              <p className="text-xs text-gray-400">{def.name}</p>
            </div>
          );
        }
      })}
    </div>
  );
}
</file>

<file path="components/PetVillageWidget.tsx">
'use client';

import React, { useState } from 'react';
import { Plus, Minus } from 'lucide-react';

interface PetVillageWidgetProps {
  initialStreak?: number;
  onStreakChange?: (streak: number) => void;
  className?: string;
}

type VillagePhase = 'struggle' | 'suburbs' | 'paradise' | 'utopia' | 'legendary' | 'mythical' | 'eternal' | 'cosmic' | 'infinite' | 'divine';

const PetVillageWidget: React.FC<PetVillageWidgetProps> = ({
  initialStreak = 0,
  onStreakChange,
  className = ''
}) => {
  const [streak, setStreak] = useState(initialStreak);

  // Calculate current phase
  const getCurrentPhase = (currentStreak: number): VillagePhase => {
    if (currentStreak < 10) return 'struggle';
    if (currentStreak < 20) return 'suburbs';
    if (currentStreak < 30) return 'paradise';
    if (currentStreak < 40) return 'utopia';
    if (currentStreak < 50) return 'legendary';
    if (currentStreak < 60) return 'mythical';
    if (currentStreak < 70) return 'eternal';
    if (currentStreak < 80) return 'cosmic';
    if (currentStreak < 90) return 'infinite';
    return 'divine';
  };

  const phase = getCurrentPhase(streak);

  const incrementStreak = () => {
    const newStreak = streak + 1;
    setStreak(newStreak);
    onStreakChange?.(newStreak);
  };

  const decrementStreak = () => {
    const newStreak = Math.max(0, streak - 1);
    setStreak(newStreak);
    onStreakChange?.(newStreak);
  };

  // Get village representation based on phase
  const getVillageDisplay = () => {
    switch (phase) {
      case 'struggle':
        return { emoji: 'üè†', color: 'text-amber-600', bg: 'bg-amber-50' };
      case 'suburbs':
        return { emoji: 'üèòÔ∏è', color: 'text-green-600', bg: 'bg-green-50' };
      case 'paradise':
        return { emoji: 'üè∞', color: 'text-yellow-600', bg: 'bg-yellow-50' };
      case 'utopia':
        return { emoji: 'üèõÔ∏è', color: 'text-purple-600', bg: 'bg-purple-50' };
      case 'legendary':
        return { emoji: '‚öîÔ∏è', color: 'text-red-600', bg: 'bg-red-50' };
      case 'mythical':
        return { emoji: 'üêâ', color: 'text-indigo-600', bg: 'bg-indigo-50' };
      case 'eternal':
        return { emoji: '‚è≥', color: 'text-cyan-600', bg: 'bg-cyan-50' };
      case 'cosmic':
        return { emoji: 'üåå', color: 'text-violet-600', bg: 'bg-violet-50' };
      case 'infinite':
        return { emoji: '‚ôæÔ∏è', color: 'text-pink-600', bg: 'bg-pink-50' };
      case 'divine':
        return { emoji: 'üëë', color: 'text-gold-600', bg: 'bg-yellow-100' };
      default:
        return { emoji: 'üè†', color: 'text-gray-600', bg: 'bg-gray-50' };
    }
  };

  const village = getVillageDisplay();

  return (
    <div className={`flex flex-col items-center justify-center p-2 ${village.bg} rounded-lg border ${className}`}>
      {/* Village Icon */}
      <div className={`text-2xl mb-1 ${village.color}`}>
        {village.emoji}
      </div>

      {/* Streak Counter */}
      <div className="text-center">
        <div className="text-lg font-bold text-gray-800">{streak}</div>
        <div className="text-xs text-gray-600">meals</div>
      </div>

      {/* Phase Indicator */}
      <div className="text-xs font-medium text-gray-700 mt-1 capitalize">
        {phase}
      </div>

      {/* Mini Progress Bar */}
      <div className="w-full bg-gray-200 rounded-full h-1 mt-2">
        <div
          className="bg-primary-600 h-1 rounded-full transition-all duration-300"
          style={{
            width: `${Math.min(((streak % 10) / 10) * 100, 100)}%`
          }}
        />
      </div>

      {/* Control Buttons */}
      <div className="mt-2 flex gap-1">
        <button
          onClick={decrementStreak}
          className="w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors text-xs"
          title="Remove meal"
        >
          <Minus size={10} />
        </button>
        <button
          onClick={incrementStreak}
          className="w-5 h-5 bg-primary-600 text-white rounded-full flex items-center justify-center hover:bg-primary-700 transition-colors text-xs"
          title="Add meal"
        >
          <Plus size={10} />
        </button>
      </div>
    </div>
  );
};

export default PetVillageWidget;
</file>

<file path="components/ProfileSelector.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Plus, User, Dog, Cat, Bird, Fish, Rabbit, X } from 'lucide-react';

const petIcons = {
  dogs: Dog,
  cats: Cat,
  birds: Bird,
  reptiles: Fish,
  'pocket-pets': Rabbit,
};

const petTypes = [
  { id: 'dogs', name: 'Dog', icon: Dog },
  { id: 'cats', name: 'Cat', icon: Cat },
  { id: 'birds', name: 'Bird', icon: Bird },
  { id: 'reptiles', name: 'Reptile', icon: Fish },
  { id: 'pocket-pets', name: 'Pocket Pet', icon: Rabbit },
];

const ageGroups = [
  { id: 'baby', name: 'Baby', description: '0-1 years' },
  { id: 'young', name: 'Young Adult', description: '1-3 years' },
  { id: 'adult', name: 'Adult', description: '3-7 years' },
  { id: 'senior', name: 'Senior', description: '7+ years' },
];

const healthConcernOptions = [
  { id: 'none', name: 'No Special Concerns' },
  { id: 'weight-management', name: 'Weight Management' },
  { id: 'allergies', name: 'Food Allergies' },
  { id: 'joint-health', name: 'Joint Health' },
  { id: 'digestive', name: 'Digestive Issues' },
  { id: 'kidney', name: 'Kidney Support' },
  { id: 'dental', name: 'Dental Health' },
];

import { getBreedNamesForSpecies } from '@/lib/data/speciesBreeds';

// Get breeds from centralized source
const getBreedsByType = () => {
  return {
    dogs: getBreedNamesForSpecies('dogs'),
    cats: getBreedNamesForSpecies('cats'),
    birds: getBreedNamesForSpecies('birds'),
    reptiles: getBreedNamesForSpecies('reptiles'),
    'pocket-pets': getBreedNamesForSpecies('pocket-pets'),
  };
};

const breedsByType = getBreedsByType();

export default function ProfileSelector() {
  const [pets, setPets] = useState([
    { id: '1', name: 'Max', type: 'dogs', breed: 'Labrador', age: 'adult', healthConcerns: ['none'] },
    { id: '2', name: 'Whiskers', type: 'cats', breed: 'Persian', age: 'senior', healthConcerns: ['kidney'] },
  ]);
  
  const [selectedPet, setSelectedPet] = useState(pets[0]?.id || '');
  const [showModal, setShowModal] = useState(false);
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({
    name: '',
    type: 'dogs',
    breed: '',
    age: 'adult',
    healthConcerns: ['none'],
  });

  const handleAddPet = () => {
    const newPet = {
      id: Date.now().toString(),
      ...formData,
    };
    setPets([...pets, newPet]);
    setSelectedPet(newPet.id);
    setShowModal(false);
    setStep(1);
    setFormData({
      name: '',
      type: 'dogs',
      breed: '',
      age: 'adult',
      healthConcerns: ['none'],
    });
  };

  const toggleHealthConcern = (concern: string) => {
    if (concern === 'none') {
      setFormData({ ...formData, healthConcerns: ['none'] });
    } else {
      const filtered = formData.healthConcerns.filter(c => c !== 'none');
      if (filtered.includes(concern)) {
        const updated = filtered.filter(c => c !== concern);
        setFormData({ ...formData, healthConcerns: updated.length ? updated : ['none'] });
      } else {
        setFormData({ ...formData, healthConcerns: [...filtered, concern] });
      }
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-2xl font-bold text-gray-900">My Pets</h2>
        <button 
          onClick={() => setShowModal(true)}
          className="btn btn-md btn-darkgreen"
        >
          <Plus size={20} />
          Add Pet
        </button>
      </div>

      {pets.length === 0 ? (
        <div className="text-center py-12">
          <User size={48} className="mx-auto text-gray-400 mb-4" />
          <p className="text-gray-600 mb-4">No pets added yet</p>
          <button 
            onClick={() => setShowModal(true)}
            className="btn btn-md btn-darkgreen w-full justify-center"
          >
            Add Your First Pet
          </button>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {pets.map((pet) => {
            const Icon = petIcons[pet.type as keyof typeof petIcons];
             return (
              <button
                key={pet.id}
                onClick={() => setSelectedPet(pet.id)}
                className={`p-4 rounded-lg border-2 transition-colors duration-200 text-left ${
                  selectedPet === pet.id
                    ? 'border-orange-600 bg-orange-50'
                    : 'border-gray-200 bg-white hover:border-orange-300'
                }`}
              >
                <div className="flex items-start gap-3">
                  <div className={`p-2 rounded-lg ${selectedPet === pet.id ? 'bg-dark-green' : 'bg-gray-100'}`}>
                    <Icon size={24} className={selectedPet === pet.id ? 'text-orange-400' : 'text-gray-600'} />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-bold text-gray-900">{pet.name}</h3>
                    <p className="text-sm text-gray-600 capitalize">{pet.breed.replace('-', ' ')}</p>
                    <p className="text-xs text-gray-500 mt-1 capitalize">{pet.age}</p>
                  </div>
                </div>
                {selectedPet === pet.id && (
                  <div className="mt-3 pt-3 border-t">
                    <a
                      href={`/category/${pet.type}`}
                      className="text-sm text-orange-600 hover:text-orange-700 font-medium"
                    >
                      View {pet.name}'s Recipes ‚Üí
                    </a>
                  </div>
                )}
              </button>
            );
          })}
        </div>
      )}

      {/* Add Pet Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
              <h2 className="text-2xl font-bold text-gray-900">Add Your Pet</h2>
              <button 
                onClick={() => {
                  setShowModal(false);
                  setStep(1);
                }}
                className="p-2 hover:bg-gray-100 rounded-lg"
              >
                <X size={24} />
              </button>
            </div>

            <div className="p-6">
              {/* Step 1: Pet Type */}
              {step === 1 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-lg font-semibold text-gray-900 mb-4">
                      What type of pet do you have?
                    </label>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                      {petTypes.map((type) => {
                        const Icon = type.icon;
                        return (
                          <button
                            key={type.id}
                            type="button"
                            onClick={() => {
                              setFormData({ ...formData, type: type.id, breed: '' });
                              setStep(2);
                            }}
                            className="p-6 rounded-lg border-2 transition-all hover:border-primary-500 border-gray-200 hover:bg-primary-900/10"
                          >
                            <Icon size={32} className="mx-auto mb-2 text-orange-600" />
                            <div className="font-semibold text-gray-900">{type.name}</div>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}

              {/* Step 2: Name & Breed */}
              {step === 2 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      What's your pet's name?
                    </label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      placeholder="Enter pet name"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Select breed/type
                    </label>
                    <select
                      value={formData.breed}
                      onChange={(e) => setFormData({ ...formData, breed: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                    >
                      <option value="">Choose a breed</option>
                      {breedsByType[formData.type as keyof typeof breedsByType].map((breed) => (
                        <option key={breed} value={breed.toLowerCase().replace(' ', '-')}>
                          {breed}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="flex gap-3">
                    <button
                      type="button"
                      onClick={() => setStep(1)}
                      className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                      Back
                    </button>
                    <button
                      type="button"
                      onClick={() => setStep(3)}
                      disabled={!formData.name || !formData.breed}
                      className="flex-1 btn btn-md btn-darkgreen disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Next
                    </button>
                  </div>
                </div>
              )}

              {/* Step 3: Age */}
              {step === 3 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-lg font-semibold text-gray-900 mb-4">
                      How old is {formData.name}?
                    </label>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {ageGroups.map((age) => (
                        <button
                          key={age.id}
                          type="button"
                          onClick={() => {
                            setFormData({ ...formData, age: age.id });
                            setStep(4);
                          }}
                          className="p-4 rounded-lg border-2 text-left transition-all hover:border-primary-500 border-gray-200 hover:bg-primary-900/10"
                        >
                          <div className="font-bold text-gray-900">{age.name}</div>
                          <div className="text-sm text-gray-600">{age.description}</div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <button
                    type="button"
                    onClick={() => setStep(2)}
                    className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Back
                  </button>
                </div>
              )}

              {/* Step 4: Health Concerns */}
              {step === 4 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-lg font-semibold text-gray-900 mb-4">
                      Any health concerns? (Select all that apply)
                    </label>
                    <div className="space-y-3">
                      {healthConcernOptions.map((concern) => (
                        <label
                          key={concern.id}
                          className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                            formData.healthConcerns.includes(concern.id)
                              ? 'border-primary-500 bg-primary-900/10'
                              : 'border-gray-200 hover:border-primary-300'
                          }`}
                        >
                          <input
                            type="checkbox"
                            checked={formData.healthConcerns.includes(concern.id)}
                            onChange={() => toggleHealthConcern(concern.id)}
                            className="w-5 h-5 text-orange-600 rounded focus:ring-orange-500"
                          />
                          <span className="font-medium text-gray-900">{concern.name}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button
                      type="button"
                      onClick={() => setStep(3)}
                      className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                      Back
                    </button>
                    <button
                      type="button"
                      onClick={handleAddPet}
                      className="flex-1 btn btn-md btn-darkgreen font-semibold"
                    >
                      Add {formData.name}
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/PurchaseConfirmationModal.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { X, CheckCircle, ShoppingCart, Sparkles } from 'lucide-react';
import { confirmPurchaseWithDetails } from '@/lib/utils/purchaseTracking';
import { getNextVillageLevel } from '@/lib/data/villageLevels';
import { useVillageStore, useVillageProgress } from '@/lib/state/villageStore';
import { confirmPetPurchase, getPetPurchaseCount } from '@/lib/utils/petPurchaseTracking';
import { checkAllBadges } from '@/lib/utils/badgeChecker';

export interface PurchaseConfirmationModalProps {
  isOpen: boolean;
  onClose: () => void;
  ingredientId: string;
  ingredientName: string;
  userId?: string;
  amazonOrderId?: string;
  petId?: string; // Optional pet ID for per-pet purchase tracking
}

/**
 * Modal that appears after clicking "Buy" buttons
 * Allows user to confirm purchase manually (fallback)
 * Shows progress toward next village level
 */
export default function PurchaseConfirmationModal({
  isOpen,
  onClose,
  ingredientId,
  ingredientName,
  userId,
  amazonOrderId,
  petId
}: PurchaseConfirmationModalProps) {
  const [confirmed, setConfirmed] = useState(false);
  const { refreshFromLocal, setUserId } = useVillageStore();
  const { count, level, progress, nextLevelThreshold, ingredientsRemaining } = useVillageProgress();

  // Get userId from localStorage if not provided
  const getUserId = () => {
    if (userId) return userId;
    if (typeof window === 'undefined') return '';
    return localStorage.getItem('last_user_id') || '';
  };

  useEffect(() => {
    if (isOpen) {
      const currentUserId = getUserId();
      if (currentUserId) {
        setUserId(currentUserId);
        setConfirmed(false);
      }
    }
  }, [isOpen, userId, setUserId]);

  const handleConfirm = async () => {
    const currentUserId = getUserId();
    if (currentUserId) {
      // Confirm global purchase (for village)
      const result = confirmPurchaseWithDetails(currentUserId, ingredientId, ingredientName, amazonOrderId);
      if (result.success) {
        refreshFromLocal(); // Update village store
        
        // Also track per-pet purchase if petId is provided
        if (petId) {
          await confirmPetPurchase(
            currentUserId,
            petId,
            ingredientId,
            ingredientName,
            undefined, // recipeId - not available here
            amazonOrderId
          );
          
          // Check badges for per-pet purchase
          const purchaseCount = getPetPurchaseCount(currentUserId, petId);
          await checkAllBadges(currentUserId, petId, {
            action: 'purchase_confirmed',
            purchaseCount,
          });
        }
        
        setConfirmed(true);
        
        // Auto-close after 2 seconds
        setTimeout(() => {
          onClose();
        }, 2000);
      }
    }
  };

  const handleSkip = () => {
    onClose();
  };

  if (!isOpen) return null;

  const nextLevel = level ? getNextVillageLevel(level.id) : null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b p-6 flex items-center justify-between rounded-t-2xl">
          <div>
            <h2 className="text-2xl font-bold text-gray-900">Confirm Purchase</h2>
            <p className="text-sm text-gray-600 mt-1">Did you purchase this ingredient?</p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
            aria-label="Close"
          >
            <X size={24} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 space-y-6">
          {/* Ingredient Info */}
          <div className="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
            <div className="flex items-center gap-3">
              <ShoppingCart size={32} className="text-amber-600" />
              <div>
                <h3 className="font-bold text-gray-900 text-lg">{ingredientName}</h3>
                <p className="text-sm text-gray-600">Confirm when you've completed your purchase</p>
              </div>
            </div>
          </div>

          {/* Current Stats */}
          {level && (
            <div className="space-y-4">
              {/* Current Level */}
              <div className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-4 border-2 border-amber-200">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-semibold text-gray-700">Current Village</span>
                  <span className="text-lg font-bold text-gray-900">{level.name}</span>
                </div>
                <div className="text-xs text-gray-600">
                  Level {level.id} ‚Ä¢ {count} ingredients purchased
                </div>
              </div>

              {/* Progress to Next Level */}
              {nextLevel && ingredientsRemaining > 0 && (
                <div className="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                  <div className="flex items-center gap-2 mb-2">
                    <Sparkles size={20} className="text-blue-600" />
                    <span className="text-sm font-semibold text-gray-700">
                      Progress to {nextLevel.name}
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                    <div
                      className="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-[width] duration-500 ease-out will-change-[width]"
                      style={{ width: `${(progress / 10) * 100}%` }}
                    />
                  </div>
                  <div className="text-xs text-gray-600">
                    {ingredientsRemaining} more ingredient{ingredientsRemaining !== 1 ? 's' : ''} to unlock!
                  </div>
                </div>
              )}

              {/* Max Level Reached */}
              {!nextLevel && (
                <div className="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                  <div className="flex items-center gap-2">
                    <CheckCircle size={20} className="text-green-600" />
                    <span className="text-sm font-semibold text-green-900">
                      üéâ Maximum level reached! Your village is complete!
                    </span>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Confirmation Message */}
          {confirmed && (
            <div className="bg-green-50 rounded-lg p-4 border-2 border-green-200">
              <div className="flex items-center gap-2">
                <CheckCircle size={24} className="text-green-600" />
                <span className="font-semibold text-green-900">
                  Purchase confirmed! Your village is growing! üéâ
                </span>
              </div>
            </div>
          )}
        </div>

        {/* Action Buttons */}
        <div className="sticky bottom-0 bg-white border-t p-6 space-y-3 rounded-b-2xl">
          {!confirmed ? (
            <>
              <button
                onClick={handleConfirm}
                className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl"
              >
                <div className="flex items-center justify-center gap-2">
                  <CheckCircle size={20} />
                  Yes, I Purchased This
                </div>
              </button>
              <button
                onClick={handleSkip}
                className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-colors"
              >
                Skip for Now
              </button>
            </>
          ) : (
            <button
              onClick={onClose}
              className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
            >
              Close
            </button>
          )}

          {/* Helper Text */}
          <p className="text-xs text-gray-500 text-center">
            Confirming purchases helps track your village progress. You can always confirm later!
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/QuickPreviewModal.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { X, ShoppingCart, Sparkles, ArrowRight } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
import { getButtonCopy, trackButtonClick, type ButtonCopyVariant } from '@/lib/utils/abTesting';
import { ensureSellerId } from '@/lib/utils/affiliateLinks';
import { getProductByIngredient } from '@/lib/data/product-prices';

// Format price for display
const formatPrice = (price: number) => {
  return `$${price.toFixed(2)}`;
};

type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

interface QuickPreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
}

const PET_TYPES: { id: PetCategory; emoji: string; label: string }[] = [
  { id: 'dogs', emoji: 'üêï', label: 'Dogs' },
  { id: 'cats', emoji: 'üêà', label: 'Cats' },
  { id: 'birds', emoji: 'ü¶ú', label: 'Birds' },
  { id: 'reptiles', emoji: 'ü¶é', label: 'Reptiles' },
  { id: 'pocket-pets', emoji: 'üê∞', label: 'Small Pets' },
];

export default function QuickPreviewModal({ isOpen, onClose }: QuickPreviewModalProps) {
  const [selectedType, setSelectedType] = useState<PetCategory>('dogs');
  const [hoveredRecipe, setHoveredRecipe] = useState<string | null>(null);
  const [recipes, setRecipes] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  
  // A/B Testing: Get assigned button copy
  const [buttonCopy, setButtonCopy] = useState<ButtonCopyVariant | null>(null);
  
  useEffect(() => {
    setButtonCopy(getButtonCopy(false));
  }, []);

  // Fetch recipes when pet type changes
  useEffect(() => {
    if (!isOpen) return;
    
    const fetchRecipes = async () => {
      setIsLoading(true);
      try {
        const response = await fetch('/api/recipes/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            species: selectedType,
            count: 3, // Only need 3 for preview
          }),
        });
        
        if (response.ok) {
          const data = await response.json();
          setRecipes(data.recipes || []);
        } else {
          setRecipes([]);
        }
      } catch (error) {
        console.error('Failed to fetch recipes:', error);
        setRecipes([]);
      } finally {
        setIsLoading(false);
      }
    };
    
    fetchRecipes();
  }, [selectedType, isOpen]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn">
      <div className="bg-[#0f2c0f] border-2 border-orange-500/50 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-[#043136] to-[#0f2c0f] px-6 py-5 border-b-2 border-orange-500/30 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
              <Sparkles className="text-orange-400" size={28} />
              See Perfect Meals for Your Pet
            </h2>
            <p className="text-gray-300 text-sm mt-1">
              No signup required ‚Ä¢ Instant results
            </p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-white transition-colors p-2"
          >
            <X size={28} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
          {/* Pet Type Selector */}
          <div className="mb-6">
            <p className="text-gray-300 text-sm mb-3 text-center">
              üëá Pick your pet type to see example meals
            </p>
            <div className="flex justify-center gap-3 flex-wrap">
              {PET_TYPES.map(type => (
                <button
                  key={type.id}
                  onClick={() => setSelectedType(type.id)}
                  className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${
                    selectedType === type.id
                      ? 'bg-orange-500 text-white shadow-lg scale-105 border-2 border-orange-400'
                      : 'bg-surface-highlight text-gray-300 hover:bg-surface hover:text-white border-2 border-transparent'
                  }`}
                >
                  <span className="text-2xl">{type.emoji}</span>
                  <span>{type.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Recipe Grid or Loading */}
          {isLoading ? (
            <div className="text-center py-12">
              <Sparkles className="text-orange-400 mx-auto mb-4 animate-spin" size={48} />
              <h3 className="text-xl font-bold text-white mb-2">
                Generating Perfect Meals...
              </h3>
              <p className="text-gray-300">
                Creating personalized recipes for your {selectedType.replace('-', ' ')}
              </p>
            </div>
          ) : recipes.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {recipes.map(recipe => {
                // Get ingredients with purchase links
                const ingredientsWithLinks = recipe.ingredients?.filter((ing: any) => 
                  ing.asinLink || ing.amazonLink
                ) || [];
                
                // Calculate total price using our high-quality product-prices system
                const recipeTotalPrice = ingredientsWithLinks.reduce((sum: number, ing: any) => {
                  const product = getProductByIngredient(ing.name);
                  if (product?.price?.amount) {
                    return sum + product.price.amount;
                  }
                  return sum;
                }, 0);
                
                return (
                  <div
                    key={recipe.id}
                    onMouseEnter={() => setHoveredRecipe(recipe.id)}
                    onMouseLeave={() => setHoveredRecipe(null)}
                    className="bg-surface rounded-xl border-2 border-surface-highlight hover:border-orange-500 transition-all shadow-lg hover:shadow-2xl overflow-hidden"
                  >
                    {/* Recipe Image */}
                    {recipe.imageUrl && (
                      <div className="relative w-full h-40 bg-surface-highlight">
                        <Image
                          src={recipe.imageUrl}
                          alt={recipe.name}
                          fill
                          className="object-cover"
                          unoptimized
                        />
                      </div>
                    )}

                    <div className="p-4">
                      <h3 className="text-lg font-bold text-white mb-2 line-clamp-2">
                        {recipe.name}
                      </h3>
                      
                      <p className="text-gray-400 text-sm mb-3 line-clamp-3">
                        {recipe.description}
                      </p>

                      {/* Ingredients Preview */}
                      <div className="mb-4 pb-3 border-b border-surface-highlight">
                        <p className="text-xs text-gray-500 mb-2">Key Ingredients:</p>
                        <div className="flex flex-wrap gap-1">
                          {recipe.ingredients?.slice(0, 4).map((ing: any, idx: number) => (
                            <span
                              key={idx}
                              className="text-xs bg-green-900/40 text-green-300 px-2 py-1 rounded"
                            >
                              {ing.name}
                            </span>
                          ))}
                          {recipe.ingredients && recipe.ingredients.length > 4 && (
                            <span className="text-xs text-gray-500">
                              +{recipe.ingredients.length - 4} more
                            </span>
                          )}
                        </div>
                      </div>

                      {/* CTA Buttons */}
                      <div className="space-y-2">
                        {/* Shop Ingredients Button */}
                        {ingredientsWithLinks.length > 0 && (
                          <button
                            onClick={() => {
                              // Open first ingredient link
                              const firstIng = ingredientsWithLinks[0];
                              const link = firstIng.asinLink || firstIng.amazonLink;
                              if (link) {
                                window.open(ensureSellerId(link), '_blank');
                                // Track affiliate click
                                if (typeof window !== 'undefined') {
                                  localStorage.setItem('last_affiliate_click', JSON.stringify({
                                    recipeId: recipe.id,
                                    timestamp: Date.now(),
                                    source: 'quick-preview-modal'
                                  }));
                                }
                                // A/B Test tracking
                                if (buttonCopy) {
                                  trackButtonClick(buttonCopy.id, 'preview', recipe.name);
                                }
                              }
                            }}
                            className="w-full py-3 px-4 rounded-lg font-bold text-base bg-gradient-to-r from-[#FF9900] to-[#F08804] hover:from-[#F08804] hover:to-[#E07704] text-black shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 border-2 border-orange-400"
                          >
                            <ShoppingCart size={18} />
                            {buttonCopy?.text || 'Shop Ingredients'} ({ingredientsWithLinks.length} items)
                            {recipeTotalPrice > 0 && (
                              <span className="ml-2 text-sm font-normal opacity-90">
                                ‚Ä¢ {formatPrice(recipeTotalPrice)}
                              </span>
                            )}
                          </button>
                        )}

                        {/* View Full Recipe */}
                        <Link
                          href={`/recipe/${recipe.id}`}
                          className="w-full py-2 px-4 rounded-lg font-semibold text-sm bg-surface-highlight hover:bg-surface text-gray-300 hover:text-white transition-colors flex items-center justify-center gap-2 border border-surface-highlight"
                        >
                          View Recipe
                          <ArrowRight size={16} />
                        </Link>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12">
              <Sparkles className="text-orange-400 mx-auto mb-4" size={48} />
              <h3 className="text-xl font-bold text-white mb-2">
                Personalized Meals Await!
              </h3>
              <p className="text-gray-300 mb-6">
                Create a free account to generate cost-optimized meal plans tailored to your {selectedType.replace('-', ' ')}'s specific needs, age, and health concerns.
              </p>
            </div>
          )}

          {/* Bottom CTA */}
          <div className="mt-8 pt-6 border-t-2 border-orange-500/30">
            <div className="bg-gradient-to-r from-orange-500/20 to-green-900/20 rounded-xl p-6 text-center border border-orange-500/30">
              <h3 className="text-2xl font-bold text-white mb-2">
                Want Personalized Recommendations?
              </h3>
              <p className="text-gray-300 mb-4">
                Create a profile for your {selectedType.replace('-', ' ')} and get meals tailored to their specific needs, age, and health concerns.
              </p>
              <Link
                href="/sign-up"
                className="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-green-700 to-green-600 hover:from-green-600 hover:to-green-500 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all border-3 border-orange-500"
              >
                Create Free Account
                <ArrowRight size={20} />
              </Link>
              <p className="text-xs text-gray-500 mt-3">
                Free forever ‚Ä¢ No credit card required
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/RatingBreakdown.tsx">
import React from 'react';
import { CompatibilityRating } from '@/lib/utils/petRatingSystem';

interface RatingBreakdownProps {
  rating: CompatibilityRating;
  className?: string;
}

export const RatingBreakdown: React.FC<RatingBreakdownProps> = ({
  rating,
  className = ''
}) => {
  const getProgressBarColor = (score: number) => {
    if (score >= 80) return 'bg-green-500';
    if (score >= 60) return 'bg-blue-500';
    if (score >= 40) return 'bg-yellow-500';
    return 'bg-red-500';
  };

  const formatFactorName = (key: string) => {
    switch (key) {
      case 'petTypeMatch':
        return 'Pet Type Match';
      case 'ageAppropriate':
        return 'Age Appropriate';
      case 'nutritionalFit':
        return 'Nutritional Fit';
      case 'healthCompatibility':
        return 'Health Compatibility';
      case 'allergenSafety':
        return 'Allergen Safety';
      default:
        return key;
    }
  };

  return (
    <div className={`bg-white rounded-lg shadow-md p-6 ${className}`}>
      <h3 className="text-xl font-bold text-gray-900 mb-6">Compatibility Analysis</h3>

      {/* Overall Score */}
      <div className="mb-6 p-4 bg-gray-50 rounded-lg">
        <div className="flex items-center justify-between mb-2">
          <span className="text-lg font-semibold text-gray-900">Overall Compatibility</span>
          <span className="text-2xl font-bold text-gray-900">{rating.overallScore}%</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-3">
          <div
            className={`h-3 rounded-full transition-all duration-300 ${getProgressBarColor(rating.overallScore)}`}
            style={{ width: `${rating.overallScore}%` }}
          />
        </div>
        <p className="text-sm text-gray-600 mt-2 capitalize">{rating.compatibility} match for your pet</p>
      </div>

      {/* Detailed Breakdown */}
      <div className="space-y-4 mb-6">
        <h4 className="text-lg font-semibold text-gray-900">Detailed Breakdown</h4>
        {Object.entries(rating.breakdown).map(([key, factor]) => (
          <div key={key} className="flex items-center justify-between">
            <div className="flex-1">
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm font-medium text-gray-700">
                  {formatFactorName(key)}
                </span>
                <span className="text-sm text-gray-600">
                  {factor.score}% ({factor.weight}% weight)
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div
                  className={`h-2 rounded-full transition-all duration-300 ${getProgressBarColor(factor.score)}`}
                  style={{ width: `${factor.score}%` }}
                />
              </div>
              <p className="text-xs text-gray-500 mt-1">{factor.reason}</p>
            </div>
          </div>
        ))}
      </div>

      {/* Warnings */}
      {rating.warnings.length > 0 && (
        <div className="mb-6">
          <h4 className="text-lg font-semibold text-red-700 mb-3 flex items-center">
            <span className="mr-2">‚ö†Ô∏è</span>
            Important Considerations
          </h4>
          <ul className="space-y-2">
            {rating.warnings.map((warning, index) => (
              <li key={index} className="flex items-start text-sm text-red-700">
                <span className="mr-2 mt-1">‚Ä¢</span>
                <span>{warning}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Strengths */}
      {rating.strengths.length > 0 && (
        <div className="mb-6">
          <h4 className="text-lg font-semibold text-green-700 mb-3 flex items-center">
            <span className="mr-2">‚úÖ</span>
            Recipe Strengths
          </h4>
          <ul className="space-y-2">
            {rating.strengths.map((strength, index) => (
              <li key={index} className="flex items-start text-sm text-green-700">
                <span className="mr-2 mt-1">‚Ä¢</span>
                <span>{strength}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Recommendations */}
      {rating.recommendations.length > 0 && (
        <div>
          <h4 className="text-lg font-semibold text-blue-700 mb-3 flex items-center">
            <span className="mr-2">üí°</span>
            Recommendations
          </h4>
          <ul className="space-y-2">
            {rating.recommendations.map((recommendation, index) => (
              <li key={index} className="flex items-start text-sm text-blue-700">
                <span className="mr-2 mt-1">‚Ä¢</span>
                <span>{recommendation}</span>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};
</file>

<file path="components/RatingDistribution.tsx">
import React from 'react';

interface RatingDistributionProps {
  distribution: { [key: number]: number };
  totalReviews: number;
  className?: string;
}

export const RatingDistribution: React.FC<RatingDistributionProps> = ({
  distribution,
  totalReviews,
  className = ''
}) => {
  if (totalReviews === 0) {
    return (
      <div className={`text-center py-8 ${className}`}>
        <p className="text-gray-500">No ratings yet</p>
        <p className="text-sm text-gray-400 mt-1">Be the first to rate this recipe!</p>
      </div>
    );
  }

  return (
    <div className={`space-y-2 ${className}`}>
      {[5, 4, 3, 2, 1].map((stars) => {
        const count = distribution[stars] || 0;
        const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;

        return (
          <div key={stars} className="flex items-center gap-3">
            <div className="flex items-center gap-1 min-w-[60px]">
              <span className="text-sm font-medium text-gray-700">{stars}</span>
              <svg className="w-4 h-4 text-yellow-400 fill-yellow-400" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>

            <div className="flex-1 bg-gray-200 rounded-full h-2">
              <div
                className="bg-yellow-400 h-2 rounded-full transition-all duration-300 ease-out"
                style={{ width: `${percentage}%` }}
              />
            </div>

            <div className="min-w-[40px] text-right">
              <span className="text-sm text-gray-600">{count}</span>
            </div>
          </div>
        );
      })}
    </div>
  );
};
</file>

<file path="components/RecipeCard.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { Clock, Users } from 'lucide-react';
import { Recipe } from '@/lib/types';
import { CompatibilityBadge } from './CompatibilityBadge';
import { calculateEnhancedCompatibility, type Pet as EnhancedPet } from '@/lib/utils/enhancedCompatibilityScoring';
import type { Pet } from '@/lib/utils/petRatingSystem';
import RecipeScoreModal from './RecipeScoreModal';


interface RecipeCardProps {
  recipe: Recipe;
  pet?: Pet | null;
}

// Helper to convert grade to compatibility level
function gradeToCompatibility(grade: 'A+' | 'A' | 'B+' | 'B' | 'C+' | 'C' | 'D' | 'F'): 'excellent' | 'good' | 'fair' | 'poor' {
  if (grade === 'A+' || grade === 'A') return 'excellent';
  if (grade === 'B+' || grade === 'B') return 'good';
  if (grade === 'C+' || grade === 'C') return 'fair';
  return 'poor';
}

export default function RecipeCard({ recipe, pet }: RecipeCardProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Calculate compatibility rating if pet is provided
  const enhancedScore = pet ? (() => {
    const enhancedPet: EnhancedPet = {
      id: pet.id,
      name: pet.name,
      type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
      breed: pet.breed,
      age: typeof pet.age === 'string' ? parseFloat(pet.age) || 1 : pet.age || 1,
      weight: pet.weight || pet.weightKg || 10,
      activityLevel: pet.activityLevel,
      healthConcerns: pet.healthConcerns || [],
      dietaryRestrictions: pet.dietaryRestrictions || [],
      allergies: pet.allergies || [],
    };
    return calculateEnhancedCompatibility(recipe, enhancedPet);
  })() : null;
  
  const compatibilityRating = enhancedScore ? {
    overallScore: enhancedScore.overallScore,
    compatibility: gradeToCompatibility(enhancedScore.grade),
    breakdown: enhancedScore.factors,
    warnings: enhancedScore.detailedBreakdown.warnings,
    strengths: enhancedScore.detailedBreakdown.healthBenefits,
    recommendations: enhancedScore.detailedBreakdown.recommendations,
  } : null;

  return (
    <>
      <Link
        href={`/recipe/${recipe.id}${pet ? `?petId=${pet.id}` : ''}`}
        className="group bg-surface rounded-lg shadow-md border border-surface-highlight hover:shadow-lg hover:border-orange-500/50 transition-shadow duration-200 overflow-hidden"
      >
        <div className="bg-surface-highlight px-4 py-3 border-b border-surface-highlight flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="text-xs font-semibold text-foreground uppercase tracking-wide">
              {recipe.category}
            </div>
            {(recipe.needsReview === true || (recipe as any).usesFallbackNutrition) && (
              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-amber-900/40 text-amber-200 border border-amber-700/50">
                ‚ö†Ô∏è Experimental / Topper Only
              </span>
            )}
          </div>
          <div className="text-[11px] text-gray-400">
            {recipe.servings} servings ‚Ä¢ {recipe.prepTime}
          </div>
        </div>
        <div className="p-4">
          <h3 className="text-xl font-bold text-foreground mb-2 group-hover:text-primary-400 transition-colors">
            {recipe.name}
          </h3>
          <p className="text-gray-400 text-sm mb-4 line-clamp-2">
            {recipe.description}
          </p>

          {/* Explainable scoring */}
          {enhancedScore && (
            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4">
              <div className="flex items-start gap-2">
                <span className="text-lg">‚ÑπÔ∏è</span>
                <p className="text-sm text-blue-900">Compatibility score: {enhancedScore.overallScore}% ({enhancedScore.grade})</p>
              </div>
            </div>
          )}
          {compatibilityRating?.recommendations && compatibilityRating.recommendations.length > 0 && (
            <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg mb-4">
              <div className="flex items-start gap-2">
                <span className="text-lg">üí°</span>
                <div className="flex-1">
                  <h4 className="font-semibold text-amber-900 mb-2">Suggestions:</h4>
                  <ul className="text-sm text-amber-800 space-y-1">
                    {compatibilityRating.recommendations.map((rec, i) => (
                      <li key={i}>‚Ä¢ {rec}</li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          )}


          {/* Meta Information */}
          {(recipe as any).meta && (
            <div className="mb-4 space-y-1">
              {(recipe as any).meta.texture && (
                <div className="text-xs text-gray-500">
                  <span className="font-medium">Texture:</span> {(recipe as any).meta.texture}
                </div>
              )}
              {(recipe as any).meta.estimatedCost && (
                <div className="text-xs text-gray-500">
                  <span className="font-medium">Cost:</span> {(recipe as any).meta.estimatedCost}
                </div>
              )}
              {(recipe as any).meta.shelfLife && (
                <div className="text-xs text-gray-500">
                  <span className="font-medium">Storage:</span> {(recipe as any).meta.shelfLife}
                </div>
              )}
              {(recipe as any).meta.season && (recipe as any).meta.season.length > 0 && (
                <div className="text-xs text-gray-500">
                  <span className="font-medium">Season:</span> {(recipe as any).meta.season.join(', ')}
                </div>
              )}
            </div>
          )}
  
          {/* Compatibility Rating Display */}
          {compatibilityRating && (
            <div className="flex items-center gap-2 mb-3">
              <button
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setIsModalOpen(true);
                }}
                className="cursor-pointer"
              >
                <CompatibilityBadge
                  compatibility={compatibilityRating.compatibility}
                  score={compatibilityRating.overallScore}
                />
              </button>
            </div>
          )}

          <div className="flex items-center justify-between text-sm text-gray-500 mb-3">
            <div className="flex items-center gap-1">
              <Clock size={16} />
              <span>{recipe.prepTime}</span>
            </div>
            <div className="flex items-center gap-1">
              <Users size={16} />
              <span>{recipe.servings} servings</span>
            </div>
          </div>
        </div>
      </Link>

      {isModalOpen && (
        <RecipeScoreModal
          recipe={recipe}
          pet={pet}
          onClose={() => setIsModalOpen(false)}
        />
      )}
    </>
  );
}
</file>

<file path="components/RecipeRatingSection.tsx">
import React, { useState, useEffect } from 'react';
import { StarRating } from './StarRating';
import { InteractiveStarRating } from './InteractiveStarRating';
import { RatingDistribution } from './RatingDistribution';
import {
  saveUserRating,
  getUserRating,
  hasUserRated,
  getRecipeRatingData
} from '@/lib/utils/ratings';
import { CheckCircle, X, MessageSquare, ThumbsUp, ThumbsDown } from 'lucide-react';
import { logger } from '@/lib/utils/logger';

interface RecipeRatingSectionProps {
  recipeId: string;
  recipeName: string;
  userId?: string;
  className?: string;
}

export const RecipeRatingSection: React.FC<RecipeRatingSectionProps> = ({
  recipeId,
  recipeName,
  userId,
  className = ''
}) => {
  const [ratingData, setRatingData] = useState({
    averageRating: 0,
    totalReviews: 0,
    distribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } as { [key: number]: number }
  });
  const [userCurrentRating, setUserCurrentRating] = useState<number | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [showLoginPrompt, setShowLoginPrompt] = useState(false);
  const [showDetailedReview, setShowDetailedReview] = useState(false);

  // Enhanced feedback state
  const [petAcceptance, setPetAcceptance] = useState<boolean | null>(null);
  const [prepEase, setPrepEase] = useState<number | null>(null);
  const [nutritionOutcome, setNutritionOutcome] = useState<boolean | null>(null);
  const [valueRating, setValueRating] = useState<number | null>(null);
  const [reviewText, setReviewText] = useState('');
  const [modifications, setModifications] = useState('');

  useEffect(() => {
    loadRatingData();
  }, [recipeId]);

  useEffect(() => {
    if (userId) {
      const userRating = getUserRating(userId, recipeId);
      setUserCurrentRating(userRating);
    } else {
      setUserCurrentRating(null);
    }
  }, [userId, recipeId]);

  const loadRatingData = () => {
    const data = getRecipeRatingData(recipeId);
    setRatingData(data);
  };

  const handleRatingSubmit = async (rating: number) => {
    if (!userId) {
      setShowLoginPrompt(true);
      return;
    }

    setIsSubmitting(true);
    setMessage(null);

    try {
      // Save basic rating
      saveUserRating(userId, recipeId, rating);
      setUserCurrentRating(rating);

      // If detailed review is provided, save it too
      if (showDetailedReview && (petAcceptance !== null || prepEase || nutritionOutcome !== null || valueRating || reviewText.trim() || modifications.trim())) {
        const detailedReview = {
          petAcceptance,
          prepEase,
          nutritionOutcome,
          valueRating,
          reviewText: reviewText.trim(),
          modifications: modifications.trim(),
          timestamp: new Date().toISOString()
        };

        // Save detailed review (we'll implement this storage later)
        const existingReviews = JSON.parse(localStorage.getItem(`recipe_reviews_${recipeId}`) || '[]');
        const userReviewIndex = existingReviews.findIndex((r: any) => r.userId === userId);

        if (userReviewIndex >= 0) {
          existingReviews[userReviewIndex] = { ...detailedReview, userId, rating };
        } else {
          existingReviews.push({ ...detailedReview, userId, rating });
        }

        localStorage.setItem(`recipe_reviews_${recipeId}`, JSON.stringify(existingReviews));
      }

      // Reload rating data to show updated averages
      loadRatingData();

      setMessage('Thank you for your feedback! ‚≠ê');
      setTimeout(() => setMessage(null), 3000);

      // Reset form
      setShowDetailedReview(false);
      setPetAcceptance(null);
      setPrepEase(null);
      setNutritionOutcome(null);
      setValueRating(null);
      setReviewText('');
      setModifications('');
    } catch (error) {
      logger.error('Error saving rating:', error);
      setMessage('Failed to save rating. Please try again.');
      setTimeout(() => setMessage(null), 3000);
    } finally {
      setIsSubmitting(false);
    }
  };

  const hasUserAlreadyRated = userId ? hasUserRated(userId, recipeId) : false;

  return (
    <div className={`bg-surface rounded-2xl shadow-lg p-3 border-l-4 border-green-500 border border-surface-highlight ${className}`}>
      <h3 className="text-base font-bold text-green-300 mb-3">Pet Reviews</h3>

      {/* Overall Rating Summary */}
      <div className="flex items-center gap-3 mb-3 p-2 bg-green-900/20 rounded-lg border border-green-700/30">
        <div className="text-center">
          <div className="text-xl font-bold text-green-300">
            {ratingData.averageRating.toFixed(1)}
          </div>
          <StarRating rating={ratingData.averageRating} size="sm" />
          <div className="text-xs text-green-400 mt-1">
            {ratingData.totalReviews} {ratingData.totalReviews === 1 ? 'review' : 'reviews'}
          </div>
        </div>

        {/* Rating Distribution */}
        <div className="flex-1">
          <RatingDistribution
            distribution={ratingData.distribution}
            totalReviews={ratingData.totalReviews}
          />
        </div>
      </div>

      {/* User Rating Section */}
      <div className="border-t border-surface-highlight pt-4">
        <h4 className="text-sm font-semibold text-gray-300 mb-3">
          {hasUserAlreadyRated ? 'Your Rating' : 'Rate This Recipe'}
        </h4>

        {userId ? (
          <div className="space-y-4">
            {hasUserAlreadyRated ? (
              <div className="flex items-center gap-3">
                <span className="text-gray-300 text-sm">You rated this recipe:</span>
                <InteractiveStarRating
                  currentRating={userCurrentRating || 0}
                  onRatingChange={handleRatingSubmit}
                  disabled={isSubmitting}
                />
              </div>
            ) : (
              <div className="space-y-3">
                <div className="space-y-2">
                  <p className="text-gray-300 text-sm">
                    How would you rate "{recipeName}"?
                  </p>
                  <InteractiveStarRating
                    currentRating={userCurrentRating || 0}
                    onRatingChange={handleRatingSubmit}
                    disabled={isSubmitting}
                    size="lg"
                  />
                </div>

                {/* Detailed Review Toggle */}
                <div className="border-t border-green-700/30 pt-2">
                  <button
                    onClick={() => setShowDetailedReview(!showDetailedReview)}
                    className="flex items-center gap-1.5 text-green-400 hover:text-green-300 font-medium text-xs"
                  >
                    <MessageSquare className="w-3.5 h-3.5" />
                    {showDetailedReview ? 'Hide' : 'Add'} Detailed Review
                  </button>
                  <p className="text-[10px] text-gray-500 mt-0.5">
                    Help improve this recipe for other pet parents
                  </p>
                </div>

                {/* Detailed Review Form */}
                {showDetailedReview && (
                  <div className="border border-gray-200 rounded-lg p-4 bg-gray-50 space-y-4">
                    {/* Pet Acceptance */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Did your pet eat this meal?
                      </label>
                      <div className="flex gap-4">
                        <button
                          onClick={() => setPetAcceptance(true)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                            petAcceptance === true
                              ? 'bg-green-100 border-green-300 text-green-800'
                              : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                          }`}
                        >
                          <ThumbsUp className="w-4 h-4" />
                          Yes, ate it all
                        </button>
                        <button
                          onClick={() => setPetAcceptance(false)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                            petAcceptance === false
                              ? 'bg-red-100 border-red-300 text-red-800'
                              : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                          }`}
                        >
                          <ThumbsDown className="w-4 h-4" />
                          No, refused it
                        </button>
                      </div>
                    </div>

                    {/* Preparation Ease */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        How easy was this to prepare? (1-5 stars)
                      </label>
                      <InteractiveStarRating
                        currentRating={prepEase || 0}
                        onRatingChange={setPrepEase}
                        disabled={false}
                        size="sm"
                      />
                      <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Very difficult</span>
                        <span>Very easy</span>
                      </div>
                    </div>

                    {/* Nutritional Outcome */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Did this meet your nutritional expectations?
                      </label>
                      <div className="flex gap-4">
                        <button
                          onClick={() => setNutritionOutcome(true)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                            nutritionOutcome === true
                              ? 'bg-green-100 border-green-300 text-green-800'
                              : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                          }`}
                        >
                          <CheckCircle className="w-4 h-4" />
                          Yes, very balanced
                        </button>
                        <button
                          onClick={() => setNutritionOutcome(false)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                            nutritionOutcome === false
                              ? 'bg-yellow-100 border-yellow-300 text-yellow-800'
                              : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                          }`}
                        >
                          <X className="w-4 h-4" />
                          Could be improved
                        </button>
                      </div>
                    </div>

                    {/* Value Rating */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Value for money (1-5 stars)
                      </label>
                      <InteractiveStarRating
                        currentRating={valueRating || 0}
                        onRatingChange={setValueRating}
                        disabled={false}
                        size="sm"
                      />
                      <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Poor value</span>
                        <span>Excellent value</span>
                      </div>
                    </div>

                    {/* Modifications Made */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Any modifications you made? (Optional)
                      </label>
                      <textarea
                        value={modifications}
                        onChange={(e) => setModifications(e.target.value)}
                        placeholder="e.g., Added more carrots, reduced protein portion..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                        rows={2}
                      />
                    </div>

                    {/* Review Text */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Additional feedback (Optional)
                      </label>
                      <textarea
                        value={reviewText}
                        onChange={(e) => setReviewText(e.target.value)}
                        placeholder="Share your experience, tips for other pet parents..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                        rows={3}
                      />
                    </div>

                    {/* Submit Button */}
                    <button
                      onClick={() => handleRatingSubmit(userCurrentRating || 0)}
                      disabled={isSubmitting}
                      className="w-full px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 disabled:bg-gray-400 transition-colors"
                    >
                      {isSubmitting ? 'Submitting...' : 'Submit Detailed Review'}
                    </button>
                  </div>
                )}
              </div>
            )}

            {isSubmitting && (
              <div className="text-sm text-blue-600">
                Saving your rating...
              </div>
            )}
          </div>
        ) : (
          <div className="text-center py-6">
            <p className="text-gray-600 mb-4">
              Sign in to rate and review recipes
            </p>
            <button
              onClick={() => setShowLoginPrompt(true)}
              className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
            >
              Sign In to Rate
            </button>
          </div>
        )}

        {/* Success/Error Messages */}
        {message && (
          <div className={`mt-4 p-3 rounded-lg text-sm font-medium ${
            message.includes('Thank you')
              ? 'bg-green-100 text-green-800'
              : 'bg-red-100 text-red-800'
          }`}>
            {message}
          </div>
        )}

        {/* Login Prompt Modal (simple implementation) */}
        {showLoginPrompt && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-xl p-6 max-w-md mx-4">
              <h3 className="text-xl font-bold text-gray-900 mb-4">
                Sign In Required
              </h3>
              <p className="text-gray-600 mb-6">
                You need to be signed in to rate and review recipes. This helps us maintain quality ratings.
              </p>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowLoginPrompt(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  onClick={() => {
                    // Redirect to sign in page
                    window.location.href = '/sign-in';
                  }}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  Sign In
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
</file>

<file path="components/RecipeScoreModal.tsx">
'use client';

import React, { useEffect } from 'react';
import { X, AlertTriangle, CheckCircle, Info, Star } from 'lucide-react';
import type { Pet } from '@/lib/utils/petRatingSystem';
import {
  calculateEnhancedCompatibility,
  type Pet as EnhancedPet,
} from '@/lib/utils/enhancedCompatibilityScoring';
import type { Recipe } from '@/lib/types';
import healthConcerns from '@/lib/data/healthConcerns';
import { actionNeededBeep } from '@/lib/utils/beep';

interface Props {
  recipe: Recipe;
  pet?: Pet | null;
  onClose?: () => void;
}

// simple button style helper (you probably already have similar)
const Btn: React.FC<React.ButtonHTMLAttributes<HTMLButtonElement>> = ({ children, ...p }) => (
  <button {...p} className={`px-3 py-2 rounded-md text-sm font-semibold bg-primary-600 text-white hover:opacity-95 ${p.className ?? ''}`}>
    {children}
  </button>
);

export default function RecipeScoreModal({ recipe, pet, onClose }: Props) {
  // Use improved scoring if available, fallback to original
  let rating: any = null;

  if (pet) {
    try {
      const enhancedPet: EnhancedPet = {
        id: pet.id,
        name: pet.name,
        type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
        breed: pet.breed,
        age: typeof pet.age === 'string' ? parseFloat(pet.age) || 1 : pet.age || 1,
        weight: pet.weight || 10,
        activityLevel: pet.activityLevel,
        healthConcerns: pet.healthConcerns || [],
        dietaryRestrictions: pet.dietaryRestrictions || [],
        allergies: pet.allergies || [],
      };
      const enhancedScore = calculateEnhancedCompatibility(recipe, enhancedPet);
      // Convert enhanced score to expected format
      const stars = Math.round(enhancedScore.overallScore / 20);
      rating = {
        overallScore: enhancedScore.overallScore,
        stars: stars,
        recommendation: enhancedScore.grade === 'A+' || enhancedScore.grade === 'A' ? 'excellent' :
                       enhancedScore.grade === 'B+' || enhancedScore.grade === 'B' ? 'good' :
                       enhancedScore.grade === 'C+' || enhancedScore.grade === 'C' ? 'fair' : 'poor',
        summaryReasoning: `Compatibility score: ${enhancedScore.overallScore}% (${enhancedScore.grade})`,
        compatibility: enhancedScore.grade === 'A+' || enhancedScore.grade === 'A' ? 'excellent' :
                       enhancedScore.grade === 'B+' || enhancedScore.grade === 'B' ? 'good' :
                       enhancedScore.grade === 'C+' || enhancedScore.grade === 'C' ? 'fair' : 'poor',
        breakdown: {
          petTypeMatch: { score: enhancedScore.factors.ingredientSafety.score },
          ageAppropriate: { score: enhancedScore.factors.lifeStageFit.score },
          nutritionalFit: { score: enhancedScore.factors.nutritionalAdequacy.score },
          healthCompatibility: { score: enhancedScore.factors.healthAlignment.score },
          activityFit: { score: enhancedScore.factors.activityFit.score },
          allergenSafety: { score: enhancedScore.factors.allergenSafety.score },
        },
        warnings: enhancedScore.detailedBreakdown.warnings,
        strengths: enhancedScore.detailedBreakdown.healthBenefits,
        recommendations: enhancedScore.detailedBreakdown.recommendations,
      };
    } catch (error) {
      console.error('Error calculating compatibility:', error);
      rating = null;
    }
  }

  if (!rating) {
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/50 backdrop-blur-sm">
        <div className="w-full max-w-2xl bg-surface rounded-xl shadow-lg border border-surface-highlight p-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-foreground">Recipe Compatibility</h3>
            <button onClick={onClose} className="text-gray-400 hover:text-white"><X /></button>
          </div>
          <p className="text-sm text-gray-400">Select a pet to view compatibility details.</p>
        </div>
      </div>
    );
  }

  // Play a short cue when the modal opens to prompt user action.
  useEffect(() => {
    actionNeededBeep();
  }, []);

  const { overallScore, compatibility, breakdown, warnings, strengths, recommendations, stars, summaryReasoning, recommendation } = rating;

  function openAmazon(link: string) {
    if (!link) return;
    // Add affiliate tag to Amazon links
    const affiliateLink = link.includes('amazon.com') && !link.includes('tag=') ?
      link + (link.includes('?') ? '&' : '?') + 'tag=robinfrench-20' : link;
    window.open(affiliateLink, '_blank', 'noopener,noreferrer');
  }

  // Build quick-swap buttons from healthConcerns mapping for relevant pet issues
  const concernRecs = (pet?.healthConcerns || [])
    .map(c => healthConcerns.find(h => h.value === c))
    .filter(Boolean) as (typeof healthConcerns[0])[];

  return (
    <div className="fixed inset-0 z-50 flex items-start justify-center pt-16 px-4 sm:px-6 bg-black/60 backdrop-blur-sm">
      <div className="w-full max-w-3xl bg-surface rounded-xl shadow-2xl overflow-hidden border border-surface-highlight">
        <div className="flex items-start justify-between p-5 border-b border-surface-highlight bg-surface">
          <div>
            <h2 className="text-xl font-bold text-foreground">{recipe.name}</h2>
            <p className="text-sm text-gray-400 mt-1">{recipe.description}</p>
          </div>
          <div className="flex flex-col items-end gap-2">
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-400">Score</span>
              <div className={`px-3 py-1 rounded-md font-semibold ${overallScore >= 85 ? 'bg-green-900/30 text-green-400 border border-green-800' : overallScore >= 70 ? 'bg-amber-900/30 text-amber-400 border border-amber-800' : 'bg-red-900/30 text-red-400 border border-red-800'}`}>
                {overallScore} / 100
              </div>
            </div>
            <div className="flex items-center gap-1 text-yellow-500" aria-label="star rating">
              {[1,2,3,4,5].map(i => (
                <Star key={i} className={`w-4 h-4 ${stars && i <= stars ? 'fill-yellow-400 text-yellow-400' : 'text-gray-600'}`} />
              ))}
              <span className="text-xs text-gray-400 ml-1">{recommendation || compatibility}</span>
            </div>
            <button onClick={onClose} className="p-2 rounded text-gray-400 hover:bg-surface-highlight hover:text-white">
              <X />
            </button>
          </div>
        </div>

        <div className="p-5 grid grid-cols-1 md:grid-cols-3 gap-4 bg-surface">
          {/* Left: Breakdown */}
          <div className="md:col-span-2">
            <div className="flex items-center justify-between mb-3">
              <h4 className="text-sm font-semibold text-gray-200">Why this score</h4>
            </div>
            {summaryReasoning && (
              <div className="mb-3 text-sm text-gray-300 font-semibold italic">
                {summaryReasoning}
              </div>
            )}
            <div className="space-y-2 text-sm text-gray-400">
              <div className="flex items-center justify-between">
                <div>Ingredient Safety</div>
                <div className="font-mono text-gray-300">{breakdown.petTypeMatch.score}%</div>
              </div>
              <div className="flex items-center justify-between">
                <div>Nutritional Adequacy</div>
                <div className="font-mono text-gray-300">{breakdown.nutritionalFit.score}%</div>
              </div>
              <div className="flex items-center justify-between">
                <div>Health Alignment</div>
                <div className="font-mono text-gray-300">{breakdown.healthCompatibility.score}%</div>
              </div>
              <div className="flex items-center justify-between">
                <div>Life Stage Fit</div>
                <div className="font-mono text-gray-300">{breakdown.ageAppropriate.score}%</div>
              </div>
              <div className="flex items-center justify-between">
                <div>Allergen Safety</div>
                <div className="font-mono text-gray-300">{breakdown.allergenSafety.score}%</div>
              </div>
            </div>

            {/* Strengths */}
            {strengths.length > 0 && (
              <div className="mt-4">
                <h5 className="text-sm font-semibold text-green-400">Strengths</h5>
                <ul className="list-disc ml-5 text-sm text-gray-400">
                  {strengths.map((s: string, i: number) => <li key={i}>{s}</li>)}
                </ul>
              </div>
            )}

            {/* Warnings */}
            {warnings.length > 0 && (
              <div className="mt-4">
                <h5 className="text-sm font-semibold text-red-400">Warnings</h5>
                <ul className="list-disc ml-5 text-sm text-red-300/80">
                  {warnings.map((w: string, i: number) => <li key={i}>{w}</li>)}
                </ul>
              </div>
            )}

            {/* Recommendations (generic) */}
            <div className="mt-4">
              <h5 className="text-sm font-semibold text-gray-200">Quick recommendations</h5>
              <div className="flex flex-wrap gap-2 mt-2">
                {concernRecs.map((c) => (
                  <button
                    key={c.value}
                    onClick={() => {
                      const first = c.recommendedProducts?.[0];
                      if (first?.affiliateUrl) openAmazon(first.affiliateUrl);
                    }}
                    className="px-3 py-1 rounded-md border border-surface-highlight text-sm bg-surface-lighter text-gray-300 hover:bg-surface-highlight hover:text-white"
                    title={c.label}
                  >
                    {c.label} ‚Üí Suggested
                  </button>
                ))}

                <button
                  onClick={() => {
                    openAmazon('https://www.amazon.com/s?k=dog+joint+supplement');
                  }}
                  className="px-3 py-1 rounded-md border border-primary-800 text-sm bg-primary-900/20 text-primary-300 hover:bg-primary-900/40"
                >
                  Browse supplements
                </button>
              </div>
            </div>
          </div>

          {/* Right: Quick edits / portion & swaps */}
          <div>
            <h4 className="text-sm font-semibold mb-2 text-gray-200">Quick fixes</h4>

            <div className="space-y-3 text-sm">
              {/* Portion hint */}
              <div className="p-3 border border-surface-highlight rounded-md bg-surface-lighter">
                <div className="flex items-start gap-2">
                  <Info className="w-5 h-5 text-gray-400" />
                  <div>
                    <div className="text-xs text-gray-500">Portion suggestion</div>
                    <div className="font-semibold text-gray-200">{recipe.servings} serving(s) ‚Äî reduce by 10% if weight loss is target</div>
                  </div>
                </div>
              </div>

              {/* Swap protein (example action) */}
              <div className="p-3 border border-surface-highlight rounded-md bg-surface-lighter">
                <div className="text-xs text-gray-500">Swap protein</div>
                <div className="mt-2 flex gap-2">
                  <button
                    onClick={() => openAmazon('https://www.amazon.com/s?k=novel+protein+venison')}
                    className="px-3 py-1 rounded-md border border-surface-highlight text-gray-300 hover:bg-surface-highlight hover:text-white text-sm"
                  >
                    Venison topper
                  </button>
                  <button
                    onClick={() => openAmazon('https://www.amazon.com/s?k=novel+protein=rabbit')}
                    className="px-3 py-1 rounded-md border border-surface-highlight text-gray-300 hover:bg-surface-highlight hover:text-white text-sm"
                  >
                    Rabbit topper
                  </button>
                </div>
              </div>

              {/* Save recipe to pet quick CTA */}
              <div className="p-3 border border-surface-highlight rounded-md bg-surface-lighter">
                <div className="text-xs text-gray-500">Save / Add</div>
                <div className="mt-2 flex gap-2">
                  <Btn onClick={() => {
                    if (!pet) { alert('Select a pet first'); return; }
                    const key = `saved_recipes_${pet.id}`;
                    const existing = localStorage.getItem(key);
                    const arr = existing ? JSON.parse(existing) : [];
                    if (!arr.find((r:any) => r.id === recipe.id)) {
                      arr.push({ id: recipe.id, name: recipe.name, savedAt: new Date().toISOString() });
                      localStorage.setItem(key, JSON.stringify(arr));
                      alert(`Saved to ${pet.name}`);
                    } else {
                      alert('Already saved');
                    }
                  }}>Add to {pet?.name ?? 'Pet'}</Btn>

                  <button onClick={() => {
                    window.location.href = `/recipe/${recipe.id}?petId=${pet?.id ?? ''}`;
                  }} className="px-3 py-1 rounded-md border border-surface-highlight text-gray-300 hover:bg-surface-highlight hover:text-white">View recipe</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="p-5 border-t border-surface-highlight bg-surface flex justify-end gap-3">
          <button onClick={onClose} className="px-3 py-2 rounded-md border border-surface-highlight text-gray-300 hover:bg-surface-highlight hover:text-white">Close</button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/ScoringProgress.tsx">
// components/ScoringProgress.tsx
// Progress indicator for chunked recipe scoring

'use client';

interface ScoringProgressProps {
  progress: number;
  totalMeals: number;
  scoredCount: number;
  currentRecipe?: string;
}

export default function ScoringProgress({
  progress,
  totalMeals,
  scoredCount,
  currentRecipe,
}: ScoringProgressProps) {
  return (
    <div className="bg-surface rounded-lg shadow-md border border-surface-highlight p-6 mb-6">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h3 className="text-lg font-semibold text-foreground">
            Analyzing Recipes
          </h3>
          <p className="text-sm text-gray-400">
            Finding the best matches for your pet
          </p>
        </div>
        <div className="text-right">
          <div className="text-2xl font-bold text-orange-500">
            {progress}%
          </div>
          <div className="text-xs text-gray-500">complete</div>
        </div>
      </div>

      <div className="mb-4">
        <div className="flex justify-between text-sm text-gray-400 mb-1">
          <span>Progress</span>
          <span>{scoredCount}/{totalMeals} recipes</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-3">
          <div
            className="bg-gradient-to-r from-orange-400 to-orange-500 h-3 rounded-full transition-all duration-500 ease-out"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>

      {currentRecipe && (
        <div className="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200">
          <div className="flex items-center">
            <div className="mr-3">
              <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse" />
            </div>
            <div className="flex-1">
              <div className="text-sm font-medium text-gray-800">
                Currently scoring
              </div>
              <div className="text-sm text-gray-600 truncate">
                {currentRecipe}
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="text-xs text-gray-500 text-center">
        Scoring happens in the background ‚Ä¢ You can continue browsing
      </div>
    </div>
  );
}
</file>

<file path="components/SEOHead.tsx">
'use client';

import Head from 'next/head';
import { usePathname } from 'next/navigation';

interface SEOHeadProps {
  title?: string;
  description?: string;
  keywords?: string[];
  structuredData?: any;
  noindex?: boolean;
}

// Client-side SEO component for dynamic pages
export default function SEOHead({ 
  title, 
  description, 
  keywords = [],
  structuredData,
  noindex = false 
}: SEOHeadProps) {
  const pathname = usePathname();
  const baseUrl = 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app';
  const canonicalUrl = `${baseUrl}${pathname}`;

  const fullTitle = title 
    ? `${title} | Paw & Plate` 
    : 'Paw & Plate - Fresh Meal Prep for All Pets';

  return (
    <Head>
      <title>{fullTitle}</title>
      {description && <meta name="description" content={description} />}
      {keywords.length > 0 && (
        <meta name="keywords" content={keywords.join(', ')} />
      )}
      <link rel="canonical" href={canonicalUrl} />
      
      {noindex && <meta name="robots" content="noindex,nofollow" />}
      
      {/* Open Graph */}
      <meta property="og:title" content={fullTitle} />
      {description && <meta property="og:description" content={description} />}
      <meta property="og:url" content={canonicalUrl} />
      
      {/* Twitter Card */}
      <meta name="twitter:title" content={fullTitle} />
      {description && <meta name="twitter:description" content={description} />}
      
      {/* Structured Data */}
      {structuredData && (
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify(structuredData)
          }}
        />
      )}
    </Head>
  );
}
</file>

<file path="components/ShoppingList.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { ShoppingCart, CheckCircle } from 'lucide-react';
import { addPurchase } from '@/lib/utils/purchaseTracking';
import { useVillageStore } from '@/lib/state/villageStore';
import { getButtonCopy, trackButtonClick, type ButtonCopyVariant } from '@/lib/utils/abTesting';
import { getProductByIngredient } from '@/lib/data/product-prices';

interface Ingredient {
  id: string;
  name: string;
  amount: string;
  asinLink?: string;
}

interface ShoppingListProps {
  ingredients: Ingredient[];
  recipeName?: string;
  userId?: string;
}

// Helper to get generic ingredient name
function getGenericIngredientName(name: string): string {
  // Remove brand names and product-specific terms
  return name
    .toLowerCase()
    .replace(/freeze[- ]dried/gi, '')
    .replace(/fresh is best/gi, '')
    .replace(/organic/gi, '')
    .replace(/premium/gi, '')
    .replace(/\s+/g, ' ')
    .trim();
}

// Helper to find product data
function getProductData(ingredientName: string) {
  const genericName = getGenericIngredientName(ingredientName);
  
  // Try exact match first
  let product = getProductByIngredient(genericName);
  
  // Try partial match if exact fails
  if (!product) {
    product = getProductByIngredient(genericName);
  }
  
  return product;
}

export function ShoppingList({ 
  ingredients, 
  recipeName = 'this recipe', 
  userId
}: ShoppingListProps) {
  const [isOpening, setIsOpening] = useState(false);
  const [openedCount, setOpenedCount] = useState(0);
  const { refreshFromLocal } = useVillageStore();
  
  const [buttonCopy, setButtonCopy] = useState<ButtonCopyVariant | null>(null);
  const [buyAllCopy, setBuyAllCopy] = useState<ButtonCopyVariant | null>(null);
  
  useEffect(() => {
    setButtonCopy(getButtonCopy(false));
    setBuyAllCopy(getButtonCopy(true));
  }, []);

  const getUserId = () => {
    if (userId) return userId;
    if (typeof window === 'undefined') return '';
    return localStorage.getItem('last_user_id') || '';
  };

  // Process ingredients - get product data from SINGLE SOURCE OF TRUTH
  const shoppingItems = useMemo(() => {
    return ingredients
      .map(ing => {
        const product = getProductByIngredient(ing.name);
        
        if (!product) return null;
        
        return {
          id: ing.id,
          genericName: product.ingredient,
          recipeAmount: ing.amount,
          packageQuantity: product.quantity || '',
          price: product.price.amount,
          asin: product.asin,
          link: product.url,
        };
      })
      .filter(Boolean) as Array<{
        id: string;
        genericName: string;
        recipeAmount: string;
        packageQuantity: string;
        price: number;
        asin: string;
        link: string;
      }>;
  }, [ingredients]);

  const totalPrice = useMemo(() => {
    return shoppingItems.reduce((sum, item) => sum + item.price, 0);
  }, [shoppingItems]);

  const openAllInTabs = async () => {
    setIsOpening(true);
    setOpenedCount(0);
    const currentUserId = getUserId();

    // Open first tab immediately
    if (shoppingItems.length > 0) {
      window.open(shoppingItems[0].link, '_blank');
      setOpenedCount(1);
      if (currentUserId) {
        addPurchase(currentUserId, shoppingItems[0].id, false, shoppingItems[0].genericName);
        refreshFromLocal();
      }
    }

    // Open remaining tabs with delays
    for (let i = 1; i < shoppingItems.length; i++) {
      await new Promise(resolve => setTimeout(resolve, 800));
      const newWindow = window.open(shoppingItems[i].link, '_blank');
      setOpenedCount(i + 1);
      
      if (currentUserId) {
        addPurchase(currentUserId, shoppingItems[i].id, false, shoppingItems[i].genericName);
        refreshFromLocal();
      }
      
      // Retry if blocked
      if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 1000));
        window.open(shoppingItems[i].link, '_blank');
      }
    }

    setTimeout(() => {
      setIsOpening(false);
      setOpenedCount(0);
    }, 1000);
  };

  if (shoppingItems.length === 0) {
    return (
      <div className="bg-surface rounded-lg border border-surface-highlight p-6">
        <p className="text-gray-400">No products available for purchase at this time.</p>
      </div>
    );
  }

  return (
    <div className="bg-surface rounded-lg border border-surface-highlight p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div>
          <h3 className="text-xl font-bold text-foreground flex items-center gap-2">
            <ShoppingCart size={24} />
            Shopping List
          </h3>
          <p className="text-sm text-gray-400 mt-1">
            {shoppingItems.length} ingredient{shoppingItems.length !== 1 ? 's' : ''} for {recipeName}
          </p>
        </div>
      </div>

      {/* Individual Ingredient List */}
      <div className="space-y-2 mb-6 max-h-96 overflow-y-auto pr-2">
        {shoppingItems.map((item, index) => (
          <div
            key={`${item.id}-${index}`}
            className="flex items-center justify-between gap-3 p-3 bg-surface-lighter rounded-lg border border-surface-highlight hover:border-gray-500 transition-all duration-200"
          >
            <div className="flex-1 min-w-0 pr-2">
              <div className="font-medium text-gray-200 capitalize">{item.genericName}</div>
              <div className="text-sm text-gray-400">
                Recipe needs: {item.recipeAmount}
              </div>
              <div className="text-xs text-gray-500">
                Package size: {item.packageQuantity}
              </div>
            </div>
            
            {/* Price Display */}
            <div className="text-right mr-3">
              <div className="text-lg font-bold text-orange-400">
                ${item.price.toFixed(2)}
              </div>
            </div>
            
            <a
              href={item.link}
              target="_blank"
              rel="noopener noreferrer"
              onClick={() => {
                const currentUserId = getUserId();
                if (currentUserId) {
                  addPurchase(currentUserId, item.id, false, item.genericName);
                  refreshFromLocal();
                }
                if (buttonCopy) {
                  trackButtonClick(buttonCopy.id, 'individual', item.genericName);
                }
              }}
              className="flex items-center gap-2 px-4 py-2 bg-[#FF9900] hover:bg-[#E07704] text-black rounded-lg transition-colors duration-200 text-sm font-semibold whitespace-nowrap"
            >
              <ShoppingCart size={16} />
              {buttonCopy?.text || 'Buy'}
            </a>
          </div>
        ))}
      </div>

      {/* Buy All Button */}
      <div className="border-t border-surface-highlight pt-6">
        <button
          onClick={() => {
            openAllInTabs();
            if (buyAllCopy) {
              trackButtonClick(buyAllCopy.id, 'buy-all');
            }
          }}
          disabled={isOpening}
          className={`w-full py-3 px-6 rounded-lg font-bold text-base transition-colors ${
            isOpening
              ? 'bg-gray-600 cursor-wait text-gray-300'
              : 'bg-[#FF9900] hover:bg-[#E07704] text-black'
          }`}
        >
          {isOpening ? (
            <span className="flex items-center justify-center gap-3">
              <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              Opening {openedCount}/{shoppingItems.length}...
            </span>
          ) : (
            <span className="flex items-center justify-center gap-2">
              <ShoppingCart size={20} />
              Buy All ({shoppingItems.length} items)
              {totalPrice > 0 && (
                <span className="ml-2 text-xl font-bold">
                  ‚Ä¢ ${totalPrice.toFixed(2)}
                </span>
              )}
            </span>
          )}
        </button>
        
        {/* Value Prop */}
        <div className="mt-3 flex items-center justify-center gap-4 text-xs text-gray-400">
          <span>‚úì Prime eligible</span>
          <span>‚úì Free returns</span>
          <span>‚úì Supports Paw & Plate</span>
        </div>

        {/* Helper Text */}
        <div className="mt-4 space-y-2">
          <div className="flex items-start gap-2 text-sm text-gray-400">
            <CheckCircle size={16} className="text-green-500 mt-0.5 flex-shrink-0" />
            <span>
              Opens {shoppingItems.length} Amazon tabs so you can quickly add all ingredients to your cart
            </span>
          </div>
          
          <div className="flex items-start gap-2 text-sm text-gray-400">
            <CheckCircle size={16} className="text-green-500 mt-0.5 flex-shrink-0" />
            <span>
              <strong>Tip:</strong> If your browser blocks pop-ups, click "Always allow" for this site
            </span>
          </div>
        </div>

        {/* Affiliate Disclosure */}
        <div className="mt-6 p-4 bg-green-900/20 border border-green-700/30 rounded-lg">
          <p className="text-xs text-gray-300 text-center leading-relaxed">
            <span className="font-semibold text-green-400">üíö You're supporting independent pet nutrition!</span><br/>
            As an Amazon Associate, we earn a small commission at no extra cost to you.
          </p>
        </div>
      </div>

      {/* Browser Warning */}
      {isOpening && (
        <div className="mt-4 p-4 bg-yellow-900/30 border border-yellow-700/50 rounded-lg">
          <p className="text-sm text-yellow-200">
            <strong>Browser blocking pop-ups?</strong> Look for a blocked pop-up icon in your address bar 
            and click "Always allow pop-ups from this site"
          </p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/ShoppingListSummary.tsx">
'use client';

import { calculateMealsFromGroceryList, type MealEstimate, type ShoppingListItem } from '@/lib/utils/mealEstimation';
import { getProductPrice } from '@/lib/data/product-prices';
import { Info } from 'lucide-react';
import { useState, useMemo } from 'react';

interface ShoppingListSummaryProps {
  shoppingList: ShoppingListItem[];
  className?: string;
}

export function ShoppingListSummary({ shoppingList, className = '' }: ShoppingListSummaryProps) {
  const [showBreakdown, setShowBreakdown] = useState(false);
  
  // Calculate total cost using the same logic as ShoppingList component
  const totalCost = useMemo(() => {
    if (!shoppingList || shoppingList.length === 0) {
      return 0;
    }
    
    return shoppingList.reduce((sum, item) => {
      const price = getProductPrice(item.name);
      if (typeof price === 'number') return sum + price;
      return sum;
    }, 0);
  }, [shoppingList]);

  // Calculate estimate with error handling and memoization
  const estimate = useMemo(() => {
    if (!shoppingList || shoppingList.length === 0) {
      console.log('[ShoppingListSummary] No shopping list provided');
      return null;
    }
    
    console.log('[ShoppingListSummary] Calculating estimate for', shoppingList.length, 'ingredients');
    console.log('[ShoppingListSummary] Shopping list:', shoppingList);
    
    try {
      const result = calculateMealsFromGroceryList(shoppingList);
      console.log('[ShoppingListSummary] Estimate calculated:', result);
      console.log('[ShoppingListSummary] UI totalCost prop (not used):', totalCost);
      return result;
    } catch (error) {
      console.error('[ShoppingListSummary] Error calculating meals:', error);
      return null;
    }
  }, [shoppingList, totalCost]);
  
  // Don't show if no estimate or invalid
  if (!estimate || estimate.estimatedMeals === 0) {
    console.log('[ShoppingListSummary] Showing error fallback - estimate:', estimate, 'estimatedMeals:', estimate?.estimatedMeals);
    // Show fallback message instead of returning null to verify component is being called
    return (
      <div className="bg-red-500 border-2 border-red-700 rounded-xl p-6 text-white">
        <h3 className="text-xl font-bold mb-2">‚ö†Ô∏è Shopping Summary Error</h3>
        <p className="mb-2">Unable to calculate meal estimate</p>
        <details className="text-sm">
          <summary className="cursor-pointer font-semibold mb-2">Debug Info</summary>
          <pre className="bg-red-700 p-2 rounded mt-2 overflow-auto max-h-48 text-xs">
            {JSON.stringify({ 
              estimate, 
              shoppingListLength: shoppingList?.length,
              hasEstimate: !!estimate,
              estimatedMeals: estimate?.estimatedMeals,
              breakdownLength: estimate?.breakdown?.length
            }, null, 2)}
          </pre>
        </details>
        <p className="text-xs mt-2 opacity-90">
          This message indicates the component is rendering but calculation returned {estimate?.estimatedMeals ?? 0} meals.
        </p>
      </div>
    );
  }
  
  return (
    <div className={`bg-gradient-to-r from-green-900/20 to-blue-900/20 rounded-xl p-6 border-2 border-green-700/50 ${className}`}>
      <h3 className="text-2xl font-bold text-green-200 mb-4">Shopping Summary</h3>
      
      <div className="grid md:grid-cols-3 gap-6 mb-4">
        {/* Estimated Meals */}
        <div className="bg-surface rounded-lg p-4 shadow-sm border border-green-700/30">
          <p className="text-sm text-gray-400 mb-1">Estimated Meals</p>
          <p className="text-4xl font-bold text-green-400">{estimate.estimatedMeals}</p>
          <p className="text-xs text-gray-500 mt-1">from these packages</p>
        </div>
        
        {/* Total Cost */}
        <div className="bg-surface rounded-lg p-4 shadow-sm border border-blue-700/30">
          <p className="text-sm text-gray-400 mb-1">Total Cost</p>
          <p className="text-4xl font-bold text-blue-400">${estimate.totalCost.toFixed(2)}</p>
          <p className="text-xs text-gray-500 mt-1">one-time purchase</p>
        </div>
        
        {/* Cost Per Meal */}
        <div className="bg-surface rounded-lg p-4 shadow-sm border border-purple-700/30">
          <p className="text-sm text-gray-400 mb-1">Cost Per Meal</p>
          <p className="text-4xl font-bold text-purple-400">${estimate.costPerMeal.toFixed(2)}</p>
          <p className="text-xs text-gray-500 mt-1">average</p>
        </div>
      </div>
      
      {/* Notes */}
      {estimate.notes && estimate.notes.length > 0 && (
        <div className="bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4">
          <div className="flex items-start gap-2">
            <Info className="text-blue-400 mt-0.5 flex-shrink-0" size={18} />
            <div className="flex-1">
              <p className="text-sm font-semibold text-blue-300 mb-1">Good to know:</p>
              <ul className="text-sm text-blue-200 space-y-1">
                {estimate.notes.map((note, i) => (
                  <li key={i}>‚Ä¢ {note}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}
      
      {/* Breakdown (collapsible) */}
      <details 
        className="mt-4 cursor-pointer"
        onToggle={(e) => setShowBreakdown((e.target as HTMLDetailsElement).open)}
      >
        <summary className="text-sm font-semibold text-gray-300 hover:text-white transition-colors list-none">
          <span className="flex items-center gap-2">
            <span>{showBreakdown ? '‚ñº' : '‚ñ∂'}</span>
            <span>View detailed breakdown</span>
          </span>
        </summary>
        <div className="mt-3 space-y-2">
          {estimate.breakdown && estimate.breakdown.length > 0 ? (
            estimate.breakdown.map((item, i) => (
              <div key={i} className="bg-surface rounded-lg p-3 text-sm border border-surface-highlight">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <p className="font-medium text-gray-200">{item.ingredient}</p>
                    <p className="text-xs text-gray-500 mt-1">
                      Recipe needs {item.recipeAmount.toFixed(1)}g per meal
                    </p>
                    <p className="text-xs text-gray-500">
                      Package contains {item.packageSize}g ({item.packageSize / 453.592 < 1 ? `${(item.packageSize / 28.3495).toFixed(1)} oz` : `${(item.packageSize / 453.592).toFixed(1)} lb`})
                    </p>
                  </div>
                  <div className="text-right ml-4">
                    <p className="font-semibold text-green-400">
                      ~{Math.round(item.mealsFromPackage)} meals
                    </p>
                    <p className="text-xs text-gray-500">${item.packageCost}</p>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div className="text-sm text-gray-400 italic">No breakdown available</div>
          )}
        </div>
      </details>
      
      {/* Disclaimer */}
      <p className="text-xs text-gray-500 mt-4 italic">
        * Estimates based on typical package sizes available online. Actual quantities may vary.
      </p>
    </div>
  );
}
</file>

<file path="components/SocialProof.tsx">
'use client';

import React from 'react';
import { Star, Users, ShoppingBag, TrendingUp } from 'lucide-react';

// Social proof component - builds trust BEFORE signup
export default function SocialProof() {
  // Simulated but believable stats (update with real data later)
  const stats = [
    {
      icon: Users,
      value: '12,847',
      label: 'Meals Generated',
      color: 'text-green-400'
    },
    {
      icon: ShoppingBag,
      value: '3,421',
      label: 'Ingredients Purchased',
      color: 'text-orange-400'
    },
    {
      icon: Star,
      value: '4.8/5',
      label: 'Average Rating',
      color: 'text-yellow-400'
    },
    {
      icon: TrendingUp,
      value: '23%',
      label: 'Healthier Pets*',
      color: 'text-blue-400'
    }
  ];

  return (
    <div className="bg-gradient-to-r from-surface/50 to-surface-highlight/50 backdrop-blur-sm rounded-2xl border border-surface-highlight p-8">
      <h3 className="text-2xl font-bold text-white text-center mb-6">
        Join Thousands of Pet Parents
      </h3>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
        {stats.map((stat, idx) => {
          const Icon = stat.icon;
          return (
            <div key={idx} className="text-center">
              <div className="flex justify-center mb-3">
                <div className="w-14 h-14 bg-surface rounded-full flex items-center justify-center border border-surface-highlight">
                  <Icon size={28} className={stat.color} />
                </div>
              </div>
              <div className={`text-3xl font-black ${stat.color} mb-1`}>
                {stat.value}
              </div>
              <div className="text-sm text-gray-400">
                {stat.label}
              </div>
            </div>
          );
        })}
      </div>

      <p className="text-xs text-gray-500 text-center mt-6">
        *Based on owner-reported health improvements after switching to fresh meal prep
      </p>
    </div>
  );
}

// Testimonial component (for later use)
export function TestimonialSection() {
  const testimonials = [
    {
      name: "Sarah M.",
      petType: "Golden Retriever",
      text: "My dog lost 5 lbs in 2 months using these meal plans. She's more energetic and her coat is shinier!",
      rating: 5
    },
    {
      name: "Mike T.",
      petType: "Tabby Cat",
      text: "Finally found meal plans that work for my cat's kidney issues. The vet was impressed with the nutritional balance.",
      rating: 5
    },
    {
      name: "Jessica L.",
      petType: "African Grey Parrot",
      text: "Can't believe there's finally a meal planner for birds! My parrot's feathers have never looked better.",
      rating: 5
    }
  ];

  return (
    <div className="bg-surface rounded-2xl border border-surface-highlight p-8">
      <h3 className="text-2xl font-bold text-white text-center mb-8">
        What Pet Parents Are Saying
      </h3>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {testimonials.map((testimonial, idx) => (
          <div key={idx} className="bg-surface-highlight rounded-xl p-6 border border-white/5">
            {/* Stars */}
            <div className="flex gap-1 mb-3">
              {[...Array(testimonial.rating)].map((_, i) => (
                <Star key={i} size={16} className="fill-orange-400 text-orange-400" />
              ))}
            </div>
            
            {/* Quote */}
            <p className="text-gray-300 text-sm mb-4 italic leading-relaxed">
              "{testimonial.text}"
            </p>
            
            {/* Author */}
            <div className="border-t border-surface pt-3">
              <p className="text-white font-semibold text-sm">{testimonial.name}</p>
              <p className="text-gray-500 text-xs">{testimonial.petType} owner</p>
            </div>
          </div>
        ))}
      </div>
      
      {/* Trust Badge */}
      <div className="mt-8 pt-6 border-t border-surface-highlight text-center">
        <div className="inline-flex items-center gap-2 bg-green-900/30 border border-green-700/50 rounded-full px-6 py-3">
          <span className="text-2xl">‚úì</span>
          <span className="text-green-400 font-semibold">Vet-Approved Nutrition</span>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/StarRating.tsx">
import React from 'react';
import { Star } from 'lucide-react';

interface StarRatingProps {
  rating: number;
  size?: 'sm' | 'md' | 'lg';
  showValue?: boolean;
  className?: string;
}

export const StarRating: React.FC<StarRatingProps> = ({
  rating,
  size = 'md',
  showValue = false,
  className = ''
}) => {

  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-5 h-5',
    lg: 'w-6 h-6'
  };

  const textSizeClasses = {
    sm: 'text-sm',
    md: 'text-base',
    lg: 'text-lg'
  };

  const renderStars = () => {
    const stars = [];
    const fullStars = Math.floor(rating);
    const hasPartialStar = rating % 1 !== 0;
    const emptyStars = 5 - Math.ceil(rating);

    // Full stars
    for (let i = 0; i < fullStars; i++) {
      stars.push(
        <Star
          key={i}
          className={`${sizeClasses[size]} text-yellow-400 fill-yellow-400`}
        />
      );
    }

    // Partial star
    if (hasPartialStar) {
      const partialPercentage = (rating - fullStars) * 100;
      stars.push(
        <div key="partial" className="relative">
          <Star className={`${sizeClasses[size]} text-gray-300`} />
          <div
            className="absolute top-0 left-0 overflow-hidden"
            style={{ width: `${partialPercentage}%` }}
          >
            <Star className={`${sizeClasses[size]} text-yellow-400 fill-yellow-400`} />
          </div>
        </div>
      );
    }

    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
      stars.push(
        <Star
          key={`empty-${i}`}
          className={`${sizeClasses[size]} text-gray-300`}
        />
      );
    }

    return stars;
  };

  return (
    <div className={`flex items-center gap-1 ${className}`}>
      <div className="flex items-center gap-0.5">
        {renderStars()}
      </div>
      {showValue && (
        <span className={`${textSizeClasses[size]} font-semibold text-gray-700 ml-1`}>
          {rating.toFixed(1)}
        </span>
      )}
    </div>
  );
};
</file>

<file path="components/SuggestedIngredients.tsx">
'use client';

import { Info } from 'lucide-react';

interface SuggestedIngredient {
  name: string;
  reason: string;
  category: string;
}

interface SuggestedIngredientsProps {
  suggestions: SuggestedIngredient[];
  onSelect: (ingredientName: string) => void;
  selectedIngredients: string[];
}

export default function SuggestedIngredients({
  suggestions,
  onSelect,
  selectedIngredients
}: SuggestedIngredientsProps) {
  if (suggestions.length === 0) {
    return null;
  }

  // Filter out already selected ingredients
  const availableSuggestions = suggestions.filter(
    sug => !selectedIngredients.includes(sug.name)
  );

  if (availableSuggestions.length === 0) {
    return null;
  }

  return (
    <div className="bg-blue-50 rounded-lg border border-blue-200 p-6">
      <div className="flex items-center gap-2 mb-4">
        <Info size={18} className="text-blue-600" />
        <h3 className="font-semibold text-blue-900 text-lg">Suggested Ingredients</h3>
      </div>
      <p className="text-sm text-blue-800 mb-4">
        These ingredients are recommended for your pet based on their profile:
      </p>
      <div className="space-y-3">
        {availableSuggestions.map((suggestion, idx) => (
          <button
            key={idx}
            onClick={() => onSelect(suggestion.name)}
            className="w-full text-left bg-white rounded-lg border border-blue-200 p-4 hover:border-blue-400 hover:shadow-sm transition-all group"
          >
            <div className="flex items-start justify-between gap-3">
              <div className="flex-1">
                <div className="font-medium text-gray-900 mb-1 group-hover:text-blue-700">
                  {suggestion.name}
                </div>
                <div className="text-xs text-gray-600 leading-relaxed">
                  {suggestion.reason}
                </div>
              </div>
              <div className="flex-shrink-0">
                <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                  {suggestion.category}
                </span>
              </div>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="components/Tooltip.tsx">
import { ReactNode } from 'react';
import MascotIcon, { MascotName } from './MascotIcon';

interface TooltipProps {
  content: string;
  children: ReactNode;
  className?: string;
  mascot?: MascotName; // Optional mascot face in tooltip header
  wide?: boolean; // Make tooltip extra wide (for nutritional fit, etc.)
}

export default function Tooltip({ content, children, className = '', mascot, wide = false }: TooltipProps) {
  const widthClass = wide ? 'max-w-4xl w-[500px]' : 'max-w-2xl';
  return (
    <div className={`relative group ${className}`}>
      {children}
      {/* Tooltip positioned below the element to avoid cutoff at top */}
      <div className={`absolute top-full left-1/2 transform -translate-x-1/2 mt-2 ${wide ? 'px-4 py-3' : 'px-5 py-4'} bg-surface text-foreground ${wide ? 'text-xs' : 'text-sm'} rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 ${widthClass} shadow-2xl border-2 border-surface-highlight`}>
        {mascot && (
          <div className="flex items-center gap-2 mb-3 pb-3 border-b border-surface-highlight">
            <MascotIcon mascot={mascot} size={14} />
            <span className="font-semibold text-xs text-foreground">
              {mascot === 'puppy-prepper' && 'Puppy Prepper says'}
              {mascot === 'professor-purrfessor' && 'Professor Purrfessor says'}
              {mascot === 'sherlock-shells' && 'Sherlock Shells says'}
              {mascot === 'farmer-fluff' && 'Farmer Fluff says'}
              {mascot === 'robin-redroute' && 'Robin Redroute says'}
            </span>
          </div>
        )}
        <div className={mascot ? 'text-xs leading-tight text-gray-300' : wide ? 'text-xs leading-tight text-gray-200' : 'text-sm leading-relaxed text-gray-200'} style={{ whiteSpace: 'pre-line' }}>{content}</div>
        {/* Arrow pointing up to the element */}
        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-surface-highlight"></div>
      </div>
    </div>
  );
}
</file>

<file path="components/TrustBadges.tsx">
'use client';

import React from 'react';
import { Shield, Award, Heart, CheckCircle } from 'lucide-react';

export default function TrustBadges() {
  const badges = [
    {
      icon: Shield,
      title: 'AAFCO Compliant',
      subtitle: 'Meets nutritional standards',
      color: 'text-green-400'
    },
    {
      icon: Award,
      title: 'WSAVA Guidelines',
      subtitle: 'Veterinary approved',
      color: 'text-blue-400'
    },
    {
      icon: Heart,
      title: 'All Pet Types',
      subtitle: 'Dogs, cats, birds, reptiles',
      color: 'text-orange-400'
    },
    {
      icon: CheckCircle,
      title: 'Science-Backed',
      subtitle: 'Evidence-based nutrition',
      color: 'text-green-400'
    }
  ];

  return (
    <div className="flex flex-wrap justify-center gap-4 py-6">
      {badges.map((badge, idx) => {
        const Icon = badge.icon;
        return (
          <div
            key={idx}
            className="flex items-center gap-3 bg-surface-highlight border border-surface rounded-lg px-4 py-3 hover:border-orange-500/50 transition-colors"
          >
            <Icon className={`${badge.color} flex-shrink-0`} size={24} />
            <div>
              <div className="font-semibold text-white text-sm">{badge.title}</div>
              <div className="text-xs text-gray-400">{badge.subtitle}</div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="components/ValidationMessages.tsx">
// components/ValidationMessages.tsx
'use client';

import { AlertCircle, AlertTriangle, CheckCircle } from 'lucide-react';

interface ValidationMessagesProps {
  errors?: string[];
  warnings?: string[];
  success?: string[];
  className?: string;
}

export default function ValidationMessages({
  errors = [],
  warnings = [],
  success = [],
  className = ''
}: ValidationMessagesProps) {
  if (errors.length === 0 && warnings.length === 0 && success.length === 0) {
    return null;
  }

  return (
    <div className={`space-y-2 ${className}`}>
      {/* Success Messages */}
      {success.length > 0 && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
          <div className="flex items-start gap-2">
            <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
            <div className="flex-1">
              <h4 className="text-sm font-medium text-green-800 mb-1">Success</h4>
              <ul className="text-sm text-green-700 space-y-1">
                {success.map((msg, index) => (
                  <li key={index}>‚Ä¢ {msg}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}

      {/* Error Messages */}
      {errors.length > 0 && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
          <div className="flex items-start gap-2">
            <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
            <div className="flex-1">
              <h4 className="text-sm font-medium text-red-800 mb-1">Errors</h4>
              <ul className="text-sm text-red-700 space-y-1">
                {errors.map((error, index) => (
                  <li key={index}>‚Ä¢ {error}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}

      {/* Warning Messages */}
      {warnings.length > 0 && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          <div className="flex items-start gap-2">
            <AlertTriangle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
            <div className="flex-1">
              <h4 className="text-sm font-medium text-yellow-800 mb-1">Warnings</h4>
              <ul className="text-sm text-yellow-700 space-y-1">
                {warnings.map((warning, index) => (
                  <li key={index}>‚Ä¢ {warning}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/VillageBackground.tsx">
'use client';

import React from 'react';
import { VillageLevel } from '@/lib/data/villageLevels';

export interface VillageBackgroundProps {
  villageLevel: VillageLevel;
  className?: string;
}

/**
 * Renders background based on village level
 * Handles parallax scrolling effects
 */
export default function VillageBackground({
  villageLevel,
  className = ''
}: VillageBackgroundProps) {
  const { palette, environment } = villageLevel;
  
  // Create gradient from palette colors
  const gradientColors = `${palette.background}, ${palette.accent}, ${palette.neutral}`;
  const backgroundStyle = {
    background: `linear-gradient(135deg, ${gradientColors})`,
    minHeight: '400px'
  };

  return (
    <div
      className={`relative overflow-hidden rounded-2xl ${className}`}
      style={backgroundStyle}
      role="img"
      aria-label={`Village background: ${environment}`}
    >
      {/* Sky gradient */}
      <div
        className="absolute inset-0 opacity-80"
        style={{
          background: `linear-gradient(to bottom, ${palette.accent} 0%, ${palette.background} 100%)`
        }}
      />
      
      {/* Ground/landscape */}
      <div
        className="absolute bottom-0 left-0 right-0 h-1/3"
        style={{
          background: `linear-gradient(to top, ${palette.neutral} 0%, transparent 100%)`
        }}
      />
      
      {/* Environmental features as decorative elements */}
      <div className="absolute inset-0 flex items-end justify-center pb-8">
        <div className="text-center text-white/60 text-sm font-semibold">
          {villageLevel.buildings.map((building, idx) => (
            <span key={idx} className="mx-2">
              {building}
            </span>
          ))}
        </div>
      </div>
      
      {/* Parallax layers for depth */}
      <div
        className="absolute inset-0 opacity-20"
        style={{
          backgroundImage: 'radial-gradient(circle at 20% 50%, rgba(255,255,255,0.3) 0%, transparent 50%)',
          backgroundSize: '200% 200%',
          animation: 'float 20s ease-in-out infinite'
        }}
      />
    </div>
  );
}
</file>

<file path="components/VillageBuildings.tsx">
'use client';

import React from 'react';
import { VillageLevel } from '@/lib/data/villageLevels';
import PuppyPreper from './mascots/PuppyPreper';
import ProfessorPurrfessor from './mascots/ProfessorPurrfessor';
import RobinRedroute from './mascots/RobinRedroute';
import SherlockShells from './mascots/SherlockShells';
import FarmerFluff from './mascots/FarmerFluff';

export interface VillageBuildingsProps {
  villageLevel: VillageLevel;
  activity?: 'idle' | 'active';
  className?: string;
}

/**
 * Renders buildings appropriate for current level
 * Positions mascots near their "work areas"
 */
export default function VillageBuildings({
  villageLevel,
  activity = 'idle',
  className = ''
}: VillageBuildingsProps) {
  const { buildings, mascotStates } = villageLevel;

  // Building positions in a grid layout
  const buildingPositions = [
    { id: 'dog', x: '10%', y: '60%' },
    { id: 'cat', x: '30%', y: '60%' },
    { id: 'bird', x: '50%', y: '50%' },
    { id: 'turtle', x: '70%', y: '60%' },
    { id: 'hamster', x: '90%', y: '60%' }
  ];

  const getMascotComponent = (id: string) => {
    switch (id) {
      case 'dog':
        return <PuppyPreper size={100} activity={activity} />;
      case 'cat':
        return <ProfessorPurrfessor size={100} activity={activity} />;
      case 'bird':
        return <RobinRedroute size={100} activity={activity} />;
      case 'turtle':
        return <SherlockShells size={100} activity={activity} />;
      case 'hamster':
        return <FarmerFluff size={100} activity={activity} />;
      default:
        return null;
    }
  };

  const getBuildingStyle = (level: number) => {
    // Building size and complexity increases with level
    const baseSize = 80 + (level * 10);
    const height = baseSize + (level * 20);
    
    return {
      width: `${baseSize}px`,
      height: `${height}px`,
      borderRadius: level > 2 ? '8px' : '4px',
      boxShadow: level > 1 
        ? '0 8px 16px rgba(0,0,0,0.3)' 
        : '0 4px 8px rgba(0,0,0,0.2)'
    };
  };

  return (
    <div className={`relative w-full h-full ${className}`}>
      {buildingPositions.map((pos) => {
        // Get building type from buildings array (use first building as default)
        const buildingType = buildings[0] || 'strawHut';
        // Get mascot activity state
        const activityDesc = mascotStates[pos.id] || 'idle';
        const level = villageLevel.id;
        
        return (
          <div
            key={pos.id}
            className="absolute"
            style={{
              left: pos.x,
              top: pos.y,
              transform: 'translate(-50%, -50%)'
            }}
          >
            {/* Building structure */}
            <div
              className="relative"
              style={getBuildingStyle(level)}
            >
              {/* Building base */}
              <div
                className="absolute inset-0"
                style={{
                  background: level > 2
                    ? 'linear-gradient(135deg, #8B7355 0%, #6B5B4D 100%)'
                    : level > 0
                    ? 'linear-gradient(135deg, #A0826D 0%, #8B7355 100%)'
                    : 'linear-gradient(135deg, #C4A484 0%, #A0826D 100%)',
                  border: '2px solid rgba(0,0,0,0.2)',
                  borderRadius: level > 2 ? '8px' : '4px'
                }}
              />
              
              {/* Building roof/window details based on level */}
              {level > 0 && (
                <div
                  className="absolute top-0 left-0 right-0"
                  style={{
                    height: '30%',
                    background: level > 2
                      ? 'linear-gradient(135deg, #654321 0%, #4A2C1A 100%)'
                      : 'linear-gradient(135deg, #8B4513 0%, #654321 100%)',
                    borderRadius: level > 2 ? '8px 8px 0 0' : '4px 4px 0 0'
                  }}
                />
              )}
              
              {/* Windows for higher levels */}
              {level > 1 && (
                <>
                  <div
                    className="absolute"
                    style={{
                      top: '40%',
                      left: '20%',
                      width: '20%',
                      height: '20%',
                      background: 'rgba(255, 255, 200, 0.8)',
                      borderRadius: '2px',
                      border: '1px solid rgba(0,0,0,0.2)'
                    }}
                  />
                  <div
                    className="absolute"
                    style={{
                      top: '40%',
                      right: '20%',
                      width: '20%',
                      height: '20%',
                      background: 'rgba(255, 255, 200, 0.8)',
                      borderRadius: '2px',
                      border: '1px solid rgba(0,0,0,0.2)'
                    }}
                  />
                </>
              )}
              
              {/* Mascot positioned in front of building */}
              <div
                className="absolute"
                style={{
                  bottom: '-20px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  zIndex: 10
                }}
                title={activityDesc}
              >
                {getMascotComponent(pos.id)}
              </div>
            </div>
            
            {/* Building label */}
            <div
              className="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-white/80 font-semibold whitespace-nowrap"
              style={{ textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}
            >
              {buildingType.split(' ')[0]} {/* First word of building type */}
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="components/VillagePlaceholder.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { Construction, Sparkles, ShoppingCart } from 'lucide-react';
import { getPurchaseStats } from '@/lib/utils/purchaseTracking';
import { useVillageStore, useVillageProgress } from '@/lib/state/villageStore';

interface VillagePlaceholderProps {
  className?: string;
  userId?: string;
}

export default function VillagePlaceholder({ className = '', userId }: VillagePlaceholderProps) {
  const { setUserId, refreshFromLocal } = useVillageStore();
  const { count, level, progress, nextLevelThreshold, ingredientsRemaining, progressPercent } = useVillageProgress();
  const [isClient, setIsClient] = useState(false);
  const [currentUserId, setCurrentUserId] = useState<string>('');

  // Only access localStorage on client side to prevent hydration mismatch
  useEffect(() => {
    setIsClient(true);
    const id = userId || (typeof window !== 'undefined' ? localStorage.getItem('last_user_id') || '' : '');
    setCurrentUserId(id);
    if (id) {
      setUserId(id);
    }
  }, [userId, setUserId]);

  // Get stats only on client
  const stats = isClient && currentUserId ? getPurchaseStats(currentUserId) : null;

  return (
    <div className={`bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl shadow-lg border-2 border-amber-200 p-8 ${className}`}>
      <div className="flex flex-col items-center justify-center text-center space-y-4">
        <div className="relative">
          <Construction size={64} className="text-amber-600 animate-pulse" />
          <Sparkles 
            size={32} 
            className="absolute -top-2 -right-2 text-yellow-400 animate-spin" 
            style={{ animationDuration: '3s' }}
          />
        </div>
        <div>
          <h3 className="text-2xl font-bold text-gray-900 mb-2">
            {level ? `${level.name} Village` : 'Mascot Village Coming Soon!'}
          </h3>
          <p className="text-gray-700 max-w-md">
            {level 
              ? `${level.name} - ${level.buildings.join(', ')}`
              : 'Watch your village grow as you purchase ingredients! The more you shop, the more your mascots\' village evolves.'
            }
          </p>
        </div>

        {/* Purchase Stats - Only render on client to prevent hydration mismatch */}
        {isClient && currentUserId && (
          <div className="mt-4 w-full max-w-md space-y-3">
            <div className="p-4 bg-white/60 rounded-lg border border-amber-200">
              <div className="flex items-center justify-center gap-2 mb-2">
                <ShoppingCart size={20} className="text-amber-600" />
                <span className="text-lg font-bold text-gray-900">
                  {count} Ingredient{count !== 1 ? 's' : ''} Purchased
                </span>
              </div>
              {stats && stats.pendingPurchases > 0 && (
                <p className="text-sm text-amber-700">
                  {stats.pendingPurchases} pending confirmation
                </p>
              )}
            </div>

            {/* Progress to Next Level */}
            {ingredientsRemaining > 0 && ingredientsRemaining <= 10 && (
              <div className="p-4 bg-white/60 rounded-lg border border-amber-200">
                <p className="text-sm font-semibold text-gray-900 mb-2">
                  Progress to Next Level: {progress}/10
                </p>
                <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                  <div
                    className="bg-gradient-to-r from-amber-500 to-orange-500 h-3 rounded-full transition-all duration-500"
                    style={{ width: `${progressPercent}%` }}
                  />
                </div>
                <p className="text-xs text-gray-600">
                  {ingredientsRemaining} more ingredient{ingredientsRemaining !== 1 ? 's' : ''} to unlock the next level!
                </p>
              </div>
            )}

            {ingredientsRemaining === 0 && (
              <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                <p className="text-sm font-semibold text-green-900">
                  üéâ Maximum level reached! Your village is complete!
                </p>
              </div>
            )}
          </div>
        )}

        <div className="mt-4 p-4 bg-white/60 rounded-lg border border-amber-200">
          <p className="text-sm text-gray-600">
            <strong>How it works:</strong> Each ingredient purchase helps build the village. 
            Purchase 10 ingredients to unlock the next level!
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/VillageScene.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useVillageStore, useVillageProgress } from '@/lib/state/villageStore';
import VillageBackground from './VillageBackground';
import VillageBuildings from './VillageBuildings';

export interface VillageSceneProps {
  userId?: string;
  className?: string;
}

/**
 * Main village component that renders the entire scene
 * Uses Zustand store for reactive state management
 */
export default function VillageScene({
  userId,
  className = ''
}: VillageSceneProps) {
  const { setUserId, refreshFromLocal } = useVillageStore();
  const { count, level, progress } = useVillageProgress();
  const [activity, setActivity] = useState<'idle' | 'active'>('idle');

  // Get userId from localStorage if not provided
  const getUserId = () => {
    if (userId) return userId;
    if (typeof window === 'undefined') return '';
    return localStorage.getItem('last_user_id') || '';
  };

  useEffect(() => {
    const currentUserId = getUserId();
    if (currentUserId) {
      setUserId(currentUserId);
    }
  }, [userId, setUserId]);

  // Alternate between idle and active every 5 seconds
  useEffect(() => {
    const interval = setInterval(() => {
      setActivity(prev => prev === 'idle' ? 'active' : 'idle');
    }, 5000);
    
    return () => clearInterval(interval);
  }, []);

  if (!level) {
    return (
      <div className={`bg-gray-100 rounded-2xl p-8 text-center ${className}`}>
        <p className="text-gray-600">Loading village...</p>
      </div>
    );
  }

  return (
    <div className={`relative ${className}`}>
      {/* Village Level Badge */}
      <div className="absolute top-4 left-4 z-20">
        <div className="bg-white/90 backdrop-blur-sm rounded-lg px-4 py-2 shadow-lg border-2 border-amber-300">
          <div className="text-xs font-semibold text-gray-600 uppercase tracking-wide">
            {level.name} Village
          </div>
          <div className="text-lg font-bold text-gray-900">
            Level {level.id}
          </div>
          <div className="text-xs text-gray-600 mt-1">
            {count} ingredient{count !== 1 ? 's' : ''} purchased
          </div>
        </div>
      </div>

      {/* Progress to Next Level */}
      {progress < 10 && (
        <div className="absolute top-4 right-4 z-20">
          <div className="bg-white/90 backdrop-blur-sm rounded-lg px-4 py-2 shadow-lg border-2 border-amber-300">
            <div className="text-xs font-semibold text-gray-600 mb-1">
              Progress: {progress}/10
            </div>
            <div className="w-32 bg-gray-200 rounded-full h-2">
              <div
                className="bg-gradient-to-r from-amber-500 to-orange-500 h-2 rounded-full transition-[width] duration-500 ease-out will-change-[width]"
                style={{ width: `${(progress / 10) * 100}%` }}
              />
            </div>
          </div>
        </div>
      )}

      {/* Village Background */}
      <VillageBackground villageLevel={level} className="h-96" />

      {/* Village Buildings with Mascots */}
      <div className="absolute inset-0 z-10">
        <VillageBuildings
          villageLevel={level}
          activity={activity}
          className="h-full"
        />
      </div>

      {/* Village Description */}
      <div className="absolute bottom-4 left-4 right-4 z-20">
        <div className="bg-white/90 backdrop-blur-sm rounded-lg px-4 py-3 shadow-lg border-2 border-amber-300">
          <p className="text-sm text-gray-700 font-medium">
            {level.name} - {level.buildings.join(', ')}
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="config/deploy.yml">
name: Deploy Next.js to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build static site
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
</file>

<file path="config/firestore.rules">
// firestore.rules
// Firestore Security Rules for Pet Plates

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidPet(pet) {
      return pet.keys().hasAll(['id', 'names', 'type', 'breed', 'age']) &&
             pet.names is list &&
             pet.names.size() > 0 &&
             pet.type in ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'] &&
             pet.age in ['baby', 'young', 'adult', 'senior'];
    }
    
    function isValidMeal(meal) {
      return meal.keys().hasAll(['id', 'petId', 'userId', 'name', 'ingredients', 'analysis']) &&
             meal.ingredients is list &&
             meal.ingredients.size() > 0;
    }
    
    // App artifacts structure: artifacts/{appId}/users/{userId}
    match /artifacts/{appId}/users/{userId} {
      
      // Pets collection
      match /pets/{petId} {
        // Read: only owner
        allow read: if isOwner(userId);
        
        // Create: only owner, must be valid
        allow create: if isOwner(userId) && isValidPet(request.resource.data);
        
        // Update: only owner, must remain valid
        allow update: if isOwner(userId) && isValidPet(request.resource.data);
        
        // Delete: only owner
        allow delete: if isOwner(userId);
      }
      
      // Custom meals collection
      match /custom_meals/{mealId} {
        // Read: only owner
        allow read: if isOwner(userId);
        
        // Create: only owner, must be valid
        allow create: if isOwner(userId) && 
                         isValidMeal(request.resource.data) &&
                         request.resource.data.userId == userId;
        
        // Update: only owner, must remain valid
        allow update: if isOwner(userId) && 
                         isValidMeal(request.resource.data) &&
                         request.resource.data.userId == userId;
        
        // Delete: only owner
        allow delete: if isOwner(userId);
      }
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
</file>

<file path="config/globals.d.ts">
declare const __app_id: string;
declare const __firebase_config: string;
declare const __initial_auth_token: string;
</file>

<file path="config/next.confi.js">
// next.config.js
const nextConfig = {
  output: 'export',
  basePath: '/ROBINOWITZ420.GITHUB.IO',
  assetPrefix: '/ROBINOWITZ420.GITHUB.IO/',
  env: {
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
  },
};

module.exports = nextConfig;
</file>

<file path="config/next.config.mjs">
/** @type {import('next').NextConfig} */
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const nextConfig = {
  // Ensure Turbopack resolves the correct project root when running in
  // environments where `node_modules` may be hoisted to a parent folder.
  turbopack: {
    root: path.resolve(__dirname),
  },
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      },
      {
        protocol: 'https',
        hostname: 'source.unsplash.com',
      },
    ],
  },
};

export default nextConfig;
</file>

<file path="config/postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="config/tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  safelist: [
    'text-[#0f2c0f]',
  ],
  corePlugins: {
    // Disable filter utilities to prevent any filter-related CSS from being generated
    filter: false,
    backdropFilter: false,
  },
  theme: {
    extend: {
      colors: {
        background: 'rgb(var(--background-start-rgb))',
        foreground: 'rgb(var(--foreground-rgb))',
        'dark-green': '#0f2c0f',
        surface: {
           DEFAULT: '#143424', // Slightly lighter than background (approx rgb(20, 52, 36))
           highlight: '#1e4a36',
           lighter: '#2a6148',
        },
        primary: {
          50: '#f0fdf4',
          100: '#dcfce7',
          200: '#bbf7d0',
          300: '#86efac',
          400: '#4ade80',
          500: '#22c55e',
          600: '#16a34a',
          700: '#15803d',
          800: '#166534',
          900: '#14532d',
        },
        secondary: {
          50: '#fff7ed',
          100: '#ffedd5',
          200: '#fed7aa',
          300: '#fdba74',
          400: '#fb923c',
          500: '#f97316',
          600: '#ea580c',
          700: '#c2410c',
          800: '#9a3412',
          900: '#7c2d12',
        },
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="config/vitest.config.ts">
import { defineConfig } from 'vitest/config';
import path from 'path';

export default defineConfig({
  test: {
    environment: 'jsdom',
    include: ['**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    exclude: ['**/node_modules/**', '**/dist/**', '.{idea,git,cache,output,temp}/**'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
});
</file>

<file path="data/brand-vetted-high-confidence.ts">
// BRAND-BASED VETTED PRODUCTS (high-confidence)
// Review these products and add to lib/data/vetted-products.ts

const brandVettedProducts_high_confidence = {
  'duck_hearts': {
    productName: 'Vital Essentials Duck Hearts',
    amazonLink: 'https://www.amazon.com/s?k=Vital%20Essentials%20Duck%20Hearts&tag=robinfrench-20',
    vetNote: 'Vital Essentials (9/10 quality score). organ meats, grain-free. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Vital Essentials',
    qualityScore: 9
  },
  'kelp_powder': {
    productName: 'Vital Essentials Kelp Powder',
    amazonLink: 'https://www.amazon.com/s?k=Vital%20Essentials%20Kelp%20Powder&tag=robinfrench-20',
    vetNote: 'Vital Essentials (9/10 quality score). organ meats, grain-free. Veterinary recommended brand.',
    category: 'Supplement',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Vital Essentials',
    qualityScore: 9
  },
  'lamb_liver': {
    productName: 'US Wellness Meats Lamb Liver',
    amazonLink: 'https://www.amazon.com/s?k=US%20Wellness%20Meats%20Lamb%20Liver&tag=robinfrench-20',
    vetNote: 'US Wellness Meats (9.1/10 quality score). grass-fed, organic. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'US Wellness Meats',
    qualityScore: 9.1
  },
  'red_cabbage': {
    productName: 'Fresh Is Best Red Cabbage',
    amazonLink: 'https://www.amazon.com/s?k=Fresh%20Is%20Best%20Red%20Cabbage&tag=robinfrench-20',
    vetNote: 'Fresh Is Best (9.2/10 quality score). single-ingredient, human-grade. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Fresh Is Best',
    qualityScore: 9.2
  },
  'oat_bran_small_amounts': {
    productName: 'Grizzly Salmon Oil Oat Bran',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil (9.3/10 quality score). wild-caught salmon, omega-3 concentrate. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Grizzly Salmon Oil',
    qualityScore: 9.3
  },
  'cat_grass_wheatgrass': {
    productName: 'US Wellness Meats Cat Grass',
    amazonLink: 'https://www.amazon.com/s?k=US%20Wellness%20Meats%20Cat%20Grass&tag=robinfrench-20',
    vetNote: 'US Wellness Meats (9.1/10 quality score). grass-fed, organic. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'US Wellness Meats',
    qualityScore: 9.1
  },
  'ground_lamb_lean': {
    productName: 'US Wellness Meats Ground Lamb',
    amazonLink: 'https://www.amazon.com/s?k=US%20Wellness%20Meats%20Ground%20Lamb&tag=robinfrench-20',
    vetNote: 'US Wellness Meats (9.1/10 quality score). grass-fed, organic. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'US Wellness Meats',
    qualityScore: 9.1
  },
  'joint_health_powder': {
    productName: 'Grizzly Salmon Oil Joint Health Powder',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil (9.3/10 quality score). wild-caught salmon, omega-3 concentrate. Veterinary recommended brand.',
    category: 'Supplement',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Grizzly Salmon Oil',
    qualityScore: 9.3
  },
  'amino_acid_supplement': {
    productName: 'Vital Essentials Amino Acid Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Vital%20Essentials%20Amino%20Acid%20Supplement&tag=robinfrench-20',
    vetNote: 'Vital Essentials (9/10 quality score). organ meats, grain-free. Veterinary recommended brand.',
    category: 'Supplement',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Vital Essentials',
    qualityScore: 9
  },
  'calcium_supplement': {
    productName: 'Vital Essentials Calcium Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Vital%20Essentials%20Calcium%20Supplement&tag=robinfrench-20',
    vetNote: 'Vital Essentials (9/10 quality score). organ meats, grain-free. Veterinary recommended brand.',
    category: 'Supplement',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Vital Essentials',
    qualityScore: 9
  },
  'wild_bird_mix': {
    productName: 'Grizzly Salmon Oil Wild Bird Mix',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil (9.3/10 quality score). wild-caught salmon, omega-3 concentrate. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Grizzly Salmon Oil',
    qualityScore: 9.3
  },
  'omega3_oil': {
    productName: 'Grizzly Salmon Oil Omega-3 Oil',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil (9.3/10 quality score). wild-caught salmon, omega-3 concentrate. Veterinary recommended brand.',
    category: 'Oil',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Grizzly Salmon Oil',
    qualityScore: 9.3
  },
  'red_leaf_lettuce': {
    productName: 'Fresh Is Best Red Leaf Lettuce',
    amazonLink: 'https://www.amazon.com/s?k=Fresh%20Is%20Best%20Red%20Leaf%20Lettuce&tag=robinfrench-20',
    vetNote: 'Fresh Is Best (9.2/10 quality score). single-ingredient, human-grade. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Fresh Is Best',
    qualityScore: 9.2
  },
  'oat_hay': {
    productName: 'Grizzly Salmon Oil Oat Hay',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil (9.3/10 quality score). wild-caught salmon, omega-3 concentrate. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'Grizzly Salmon Oil',
    qualityScore: 9.3
  },
  'dried_grass': {
    productName: 'US Wellness Meats Dried Grass',
    amazonLink: 'https://www.amazon.com/s?k=US%20Wellness%20Meats%20Dried%20Grass&tag=robinfrench-20',
    vetNote: 'US Wellness Meats (9.1/10 quality score). grass-fed, organic. Veterinary recommended brand.',
    category: 'Meat',
    commissionRate: 0.03,
    confidence: 0.95,
    source: 'brand_analysis',
    brand: 'US Wellness Meats',
    qualityScore: 9.1
  },
};
</file>

<file path="data/brand-vetted-medium-confidence.ts">
// BRAND-BASED VETTED PRODUCTS (medium-confidence)
// Review these products and add to lib/data/vetted-products.ts

const brandVettedProducts_medium_confidence = {
};
</file>

<file path="data/csv/AMAZON_LINK_VERIFICATION.csv">
Priority,Ingredient,Product Name,ASIN,Issue,Verified,Notes,Link
HIGH,"ground beef (lean)","US Wellness Meats Pet Burger",B07VHR2WNZ,"Beef and venison are different meats",PENDING,,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
HIGH,"ground lamb","Raw Paws Lamb Recipe Rolls",B0082C00P8,"Dead link (HTTP 405) - needs replacement",DEAD,,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
HIGH,"chicken hearts","Vital Essentials Freeze Dried Chicken Hearts",B0BXZ3JJL9,"Chicken and turkey are different poultry",PENDING,,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
HIGH,"sardines (canned in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,"Sardines and herring are different fish",PENDING,,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
HIGH,"turkey giblets","Vital Essentials Freeze Dried Turkey Giblets",B0BXZ3JJL9,"Chicken and turkey are different poultry",PENDING,,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
HIGH,"venison","Fresh Is Best Freeze Dried Venison Bites",B07VHR2WNZ,"Beef and venison are different meats",PENDING,,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
HIGH,"rabbit meat","Evanger's Rabbit Grain Free Cans",B0082C00P8,"Dead link (HTTP 405) - needs replacement",DEAD,,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
HIGH,"endive","Organic Endive Greens",B0006L2XNK,"Dead link (HTTP 405) - needs replacement",DEAD,,https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20
HIGH,"canary seed","Lafeber's Parrot Food Canary Seed",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"niger seed","Lafeber's Parrot Food Niger Seed",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"oat groats","Lafeber's Parrot Food Oat Groats",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"hemp seeds","Lafeber's Parrot Food Hemp Seed",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"flaxseeds","Lafeber's Parrot Food Flax Seed",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"sesame seeds","Lafeber's Parrot Food Sesame Seed",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"chia seeds","Lafeber's Parrot Food Chia Seed",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"rapeseed","Lafeber's Parrot Food Rapeseed",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"sunflower seeds (small amounts)","Lafeber's Parrot Food Sunflower Seed",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"pumpkin seeds","Lafeber's Parrot Food Pumpkin Seed",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"mango","Organic Mango",B00WM6CHFQ,"Mango and chia oil are completely different",PENDING,,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
HIGH,"egg (hard-boiled)","Vital Essentials Freeze Dried Egg Yolk Treats",B0BWBNT8JX,"Eggs and duck hearts are different",PENDING,,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
HIGH,"pellets (fortified)","Lafeber's Parrot Food Pellets",B086211R4H,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
HIGH,"cuttlebone","Lafeber's Parrot Food Cuttlebone",B00027ZVG4,"Multiple seed types - verify if seed mix is appropriate",PENDING,,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
HIGH,"duck hearts","Vital Essentials Freeze Dried Duck Hearts",B0BWBNT8JX,"Eggs and duck hearts are different",PENDING,,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
HIGH,"herring (canned)","Crown Prince Canned Herring",B01FUWYO2M,"Sardines and herring are different fish",PENDING,,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
HIGH,"chia seed oil","Healthworks Organic Chia Seed Oil",B00WM6CHFQ,"Mango and chia oil are completely different",PENDING,,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
HIGH,"sardines (in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,"Sardines and herring are different fish",PENDING,,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
MEDIUM,"ground chicken","Fresh Is Best Freeze Dried Chicken Breast",B0BXZVFN6G,"Shared with: chicken giblets",PENDING,,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
MEDIUM,"chicken giblets","Fresh Is Best Freeze Dried Chicken Giblets",B0BXZVFN6G,"Shared with: ground chicken",PENDING,,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
MEDIUM,"brown rice","Lundberg Family Farms Organic Brown Rice",B072JNNB33,"Shared with: rice (hulled)",PENDING,,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20
MEDIUM,"kale","Earthbound Farm Organic Kale",B09VKDGT39,"Shared with: celery",PENDING,,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
MEDIUM,"celery","Earthbound Farm Organic Celery",B09VKDGT39,"Shared with: kale",PENDING,,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
MEDIUM,"lettuce (romaine)","Organic Girl Romaine Lettuce",B0F3YTY4XQ,"Shared with: romaine lettuce",PENDING,,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20
MEDIUM,"salmon oil","Grizzly Salmon Plus Omega-3 Oil",B09RYYWHH1,"Shared with: omega-3 oil",PENDING,,https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20
MEDIUM,"fish oil","Nordic Naturals Omega-3 Pet",B00CBY93XS,"Shared with: herring oil",PENDING,,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
MEDIUM,"calcium carbonate","NOW Supplements Calcium Carbonate Powder",B004421K68,"Shared with: eggshells (crushed)",PENDING,,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20
MEDIUM,"b-complex","Thorne B-Complex #12",B01INRFW0E,"Shared with: vitamin b complex",PENDING,,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20
MEDIUM,"joint supplement","Cosequin DS Plus MSM for Dogs",B003ULL1NQ,"Shared with: chondroitin sulfate, glucosamine sulfate, joint health supplement",PENDING,,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
MEDIUM,"hairball paste","Tomlyn Laxatone Hairball Remedy",B07B282MR4,"Shared with: hairball control paste",PENDING,,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20
MEDIUM,"chicken broth","Brutus Bone Broth for Dogs No Salt",B07DFNP37Y,"Shared with: bone broth (low sodium)",PENDING,,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20
MEDIUM,"dubia roaches","Josh's Frogs Live Dubia Roaches",B09QD6PBB8,"Shared with: small dubia roaches",PENDING,,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20
MEDIUM,"orchard grass hay","Oxbow Animal Health Orchard Grass Hay",B00S6Y8MHU,"Shared with: bluegrass hay",PENDING,,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
MEDIUM,"romaine lettuce","Organic Girl Romaine Lettuce",B0F3YTY4XQ,"Shared with: lettuce (romaine)",PENDING,,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20
MEDIUM,"black currant oil","NOW Foods Black Currant Seed Oil",B01FXEM0BY,"Shared with: borage oil",PENDING,,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
MEDIUM,"herring oil","Nordic Naturals Pet Herring Oil",B00CBY93XS,"Shared with: fish oil",PENDING,,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
MEDIUM,"borage oil","NOW Foods Borage Oil Softgels",B01FXEM0BY,"Shared with: black currant oil",PENDING,,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
MEDIUM,"avocado oil","Chosen Foods Pure Avocado Oil",B0C3WCRNPN,"Shared with: avocado oil (tiny amounts)",PENDING,,https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20
MEDIUM,"avocado oil (tiny amounts)","Chosen Foods Pure Avocado Oil",B0C3WCRNPN,"Shared with: avocado oil",PENDING,,https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20
MEDIUM,"omega-3 oil","Grizzly Salmon Oil for Pets",B09RYYWHH1,"Shared with: salmon oil",PENDING,,https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20
MEDIUM,"buckwheat","Bob's Red Mill Raw Hulled Buckwheat Groats",B00KQ17MDG,"Shared with: buckwheat (tiny amounts)",PENDING,,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20
MEDIUM,"buckwheat (tiny amounts)","Bob's Red Mill Raw Hulled Buckwheat Groats",B00KQ17MDG,"Shared with: buckwheat",PENDING,,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20
MEDIUM,"sorghum","Bob's Red Mill Whole Grain Sorghum",B0FKBVN6XP,"Shared with: millet, farro, teff seeds, wheat germ",PENDING,,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
MEDIUM,"barley (cooked, minimal)","Bob's Red Mill Hulled Barley Grain",B00QKP257A,"Shared with: barley (hulled)",PENDING,,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20
MEDIUM,"barley (hulled)","Bob's Red Mill Hulled Barley Grain",B00QKP257A,"Shared with: barley (cooked, minimal)",PENDING,,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20
MEDIUM,"millet","Bob's Red Mill Whole Grain Millet",B0FKBVN6XP,"Shared with: sorghum, farro, teff seeds, wheat germ",PENDING,,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
MEDIUM,"farro","Bob's Red Mill Farro Grain",B0FKBVN6XP,"Shared with: sorghum, millet, teff seeds, wheat germ",PENDING,,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
MEDIUM,"amaranth (tiny amounts)","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,"Shared with: amaranth seeds",PENDING,,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
MEDIUM,"amaranth seeds","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,"Shared with: amaranth (tiny amounts)",PENDING,,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
MEDIUM,"teff seeds","Bob's Red Mill Whole Grain Teff Seeds",B0FKBVN6XP,"Shared with: sorghum, millet, farro, wheat germ",PENDING,,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
MEDIUM,"safflower seeds","Wagner's Pure Safflower Seed Bird Food",B0FWLFGG21,"Shared with: wild bird mix",PENDING,,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
MEDIUM,"bok choi","Fresh Baby Bok Choy",B0FN4YGSK6,"Shared with: bok choy (small amounts)",PENDING,,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20
MEDIUM,"bok choy (small amounts)","Fresh Baby Bok Choy",B0FN4YGSK6,"Shared with: bok choi",PENDING,,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20
MEDIUM,"kidney beans (mashed)","Goya Canned Dark Red Kidney Beans Low Sodium",B00552005I,"Shared with: kidney beans (mashed, tiny amounts)",PENDING,,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20
MEDIUM,"kidney beans (mashed, tiny amounts)","Goya Canned Dark Red Kidney Beans Low Sodium",B00552005I,"Shared with: kidney beans (mashed)",PENDING,,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20
MEDIUM,"swiss chard","Fresh Swiss Chard",B07F12P248,"Shared with: swiss chard (cooked, tiny amounts)",PENDING,,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20
MEDIUM,"swiss chard (cooked, tiny amounts)","Fresh Swiss Chard",B07F12P248,"Shared with: swiss chard",PENDING,,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20
MEDIUM,"mulberries","Terrasoul Dried Mulberries Organic",B074153BXC,"Shared with: cranberries",PENDING,,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
MEDIUM,"cranberries","NOW Foods Dried Cranberries Unsweetened",B074153BXC,"Shared with: mulberries",PENDING,,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
MEDIUM,"small dubia roaches","Small Live Dubia Roaches Feeder",B09QD6PBB8,"Shared with: dubia roaches",PENDING,,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20
MEDIUM,"bluegrass hay","Small Pet Select Bluegrass Hay",B00S6Y8MHU,"Shared with: orchard grass hay",PENDING,,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
MEDIUM,"wild bird mix","Lyric Wild Bird Mix No Filler",B0FWLFGG21,"Shared with: safflower seeds",PENDING,,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
MEDIUM,"bone broth (low sodium)","Brutus Bone Broth for Dogs Low Sodium",B07DFNP37Y,"Shared with: chicken broth",PENDING,,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20
MEDIUM,"chicory root","NOW Supplements Inulin Prebiotic Fiber",B08Q7KZYKC,"Shared with: fructooligosaccharides (fos), inulin (prebiotic)",PENDING,,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
MEDIUM,"chondroitin sulfate","Cosequin DS Plus MSM with Chondroitin",B003ULL1NQ,"Shared with: joint supplement, glucosamine sulfate, joint health supplement",PENDING,,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
MEDIUM,"eggshells (crushed)","NOW Supplements Calcium Carbonate Powder",B004421K68,"Shared with: calcium carbonate",PENDING,,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20
MEDIUM,"fish broth (no salt)","Brutus Fish Broth for Dogs No Salt",B07DFQFLJL,"Shared with: turkey broth (no salt)",PENDING,,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20
MEDIUM,"fructooligosaccharides (fos)","NOW Supplements FOS Prebiotic Fiber",B08Q7KZYKC,"Shared with: chicory root, inulin (prebiotic)",PENDING,,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
MEDIUM,"glucosamine sulfate","Cosequin DS Plus MSM Glucosamine",B003ULL1NQ,"Shared with: joint supplement, chondroitin sulfate, joint health supplement",PENDING,,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
MEDIUM,"green beans","Fresh Organic Green Beans",B0DDTC6QNY,"Shared with: green beans (cooked)",PENDING,,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20
MEDIUM,"green beans (cooked)","Fresh Organic Green Beans",B0DDTC6QNY,"Shared with: green beans",PENDING,,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20
MEDIUM,"hairball control paste","Tomlyn Laxatone Hairball Remedy",B07B282MR4,"Shared with: hairball paste",PENDING,,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20
MEDIUM,"inulin (prebiotic)","NOW Supplements Inulin Prebiotic Fiber",B08Q7KZYKC,"Shared with: chicory root, fructooligosaccharides (fos)",PENDING,,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
MEDIUM,"joint health supplement","Cosequin DS Plus MSM for Dogs",B003ULL1NQ,"Shared with: joint supplement, chondroitin sulfate, glucosamine sulfate",PENDING,,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
MEDIUM,"peas","Fresh Organic Green Peas",B07D1NGQ6B,"Shared with: peas (mashed)",PENDING,,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20
MEDIUM,"peas (mashed)","Fresh Organic Green Peas",B07D1NGQ6B,"Shared with: peas",PENDING,,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20
MEDIUM,"rice (hulled)","Lundberg Organic Brown Rice",B072JNNB33,"Shared with: brown rice",PENDING,,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20
MEDIUM,"split peas","Bob's Red Mill Split Peas",B08DVGSW58,"Shared with: split peas (mashed), sugar snap peas, sugar snap peas (mashed)",PENDING,,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
MEDIUM,"split peas (mashed)","Bob's Red Mill Split Peas",B08DVGSW58,"Shared with: split peas, sugar snap peas, sugar snap peas (mashed)",PENDING,,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
MEDIUM,"sugar snap peas","Fresh Organic Sugar Snap Peas",B08DVGSW58,"Shared with: split peas, split peas (mashed), sugar snap peas (mashed)",PENDING,,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
MEDIUM,"sugar snap peas (mashed)","Fresh Organic Sugar Snap Peas",B08DVGSW58,"Shared with: split peas, split peas (mashed), sugar snap peas",PENDING,,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
MEDIUM,"turkey broth (no salt)","Brutus Turkey Broth for Dogs No Salt",B07DFQFLJL,"Shared with: fish broth (no salt)",PENDING,,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20
MEDIUM,"vitamin b complex","Thorne B-Complex #12",B01INRFW0E,"Shared with: b-complex",PENDING,,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20
MEDIUM,"watercress","Fresh Organic Watercress",B0BSK8P8KS,"Shared with: watercress (small amounts)",PENDING,,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20
MEDIUM,"watercress (small amounts)","Fresh Organic Watercress",B0BSK8P8KS,"Shared with: watercress",PENDING,,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20
MEDIUM,"wheat germ","Bob's Red Mill Wheat Germ",B0FKBVN6XP,"Shared with: sorghum, millet, farro, teff seeds",PENDING,,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
</file>

<file path="data/csv/asins-extracted.csv">
Ingredient Name,Product Name,Amazon Link,ASIN,Extraction Method
"ground chicken","Fresh Is Best Freeze Dried Chicken Breast","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Breast&tag=robinfrench-20","B0BXZVFN6G","scrape"
"ground turkey","Diestel Free Range Ground Turkey","https://www.amazon.com/s?k=Diestel+Free+Range+Ground+Turkey&tag=robinfrench-20","B091CCD4T7","scrape"
"ground beef (lean)","US Wellness Meats Pet Burger","https://www.amazon.com/s?k=US+Wellness+Meats+Pet+Burger&tag=robinfrench-20","B07VHR2WNZ","scrape"
"ground lamb","Raw Paws Lamb Recipe Rolls","https://www.amazon.com/s?k=Raw+Paws+Lamb+Recipe&tag=robinfrench-20","B0082C00P8","scrape"
"salmon (boneless)","A Better Treat Freeze Dried Salmon","https://www.amazon.com/s?k=A+Better+Treat+Freeze+Dried+Salmon&tag=robinfrench-20","B08NCDSV82","scrape"
"chicken breast","Bell & Evans Boneless Chicken Breast","https://www.amazon.com/s?k=Bell+%26+Evans+Boneless+Chicken+Breast&tag=robinfrench-20","B0787WTY4C","scrape"
"chicken thighs","Bell & Evans Boneless Chicken Thighs","https://www.amazon.com/s?k=Bell+%26+Evans+Boneless+Chicken+Thighs&tag=robinfrench-20","B0787YFWYB","scrape"
"turkey breast","Fresh Is Best Freeze Dried Turkey Tenders","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Turkey+Tenders&tag=robinfrench-20","B0CZRN7HXT","scrape"
"beef liver","Fresh Is Best Freeze Dried Beef Liver","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Beef+Liver&tag=robinfrench-20","B07G3QFG8N","scrape"
"chicken liver","Fresh Is Best Freeze Dried Chicken Livers","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Livers&tag=robinfrench-20","B07S8JCNTH","scrape"
"chicken hearts","Vital Essentials Freeze Dried Chicken Hearts","https://www.amazon.com/s?k=Vital+Essentials+Chicken+Hearts&tag=robinfrench-20","B0BXZ3JJL9","scrape"
"sardines (canned in water)","Wild Planet Sardines in Water No Salt","https://www.amazon.com/s?k=Wild+Planet+Sardines+in+Water+No+Salt&tag=robinfrench-20","B01FUWYO2M","scrape"
"eggs","Whole Life Pet Freeze Dried Diced Eggs","https://www.amazon.com/s?k=Whole+Life+Pet+Freeze+Dried+Eggs&tag=robinfrench-20","B001DY6U9M","scrape"
"turkey giblets","Vital Essentials Freeze Dried Turkey Giblets","https://www.amazon.com/s?k=Vital+Essentials+Turkey+Giblets&tag=robinfrench-20","B0BXZ3JJL9","scrape"
"chicken giblets","Fresh Is Best Freeze Dried Chicken Giblets","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Giblets&tag=robinfrench-20","B0BXZVFN6G","scrape"
"duck breast","Fresh Is Best Freeze Dried Duck Breast","https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Duck+Breast&tag=robinfrench-20","B01KAOGE5U","scrape"
"venison","Fresh Is Best Freeze Dried Venison Bites","https://www.amazon.com/s?k=Fresh+Is+Best+Venison+Bites&tag=robinfrench-20","B07VHR2WNZ","scrape"
"rabbit meat","Evanger\","https://www.amazon.com/s?k=Evanger%27s+Rabbit+Grain+Free&tag=robinfrench-20","B0082C00P8","scrape"
"quail","Wholesome Beast Freeze Dried Quail Chicks","https://www.amazon.com/s?k=Wholesome+Beast+Freeze+Dried+Quail+Chicks&tag=robinfrench-20","B0DK1SJ2Z7","scrape"
"ground pork (lean)","Momentum Freeze Dried Pork Tenderloin","https://www.amazon.com/s?k=Momentum+Pork+Tenderloin+Freeze+Dried&tag=robinfrench-20","B0CLJW1P6D","scrape"
"turkey necks","Northwest Naturals Freeze Dried Turkey Necks","https://www.amazon.com/s?k=Northwest+Naturals+Freeze+Dried+Turkey+Necks&tag=robinfrench-20","B0FHJ6G2NZ","scrape"
"brown rice","Lundberg Family Farms Organic Brown Rice","https://www.amazon.com/s?k=Lundberg+Organic+Brown+Rice&tag=robinfrench-20","B072JNNB33","scrape"
"white rice","Nishiki Premium Medium Grain White Rice","https://www.amazon.com/s?k=Nishiki+Premium+Medium+Grain+White+Rice&tag=robinfrench-20","B00IDQY2PW","scrape"
"quinoa","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Organic+White+Quinoa&tag=robinfrench-20","B07ZJNYGW4","scrape"
"sweet potato","Farmer\","https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Sweet+Potato+Puree&tag=robinfrench-20","B07D92VQ9C","scrape"
"pumpkin puree","Farmer\","https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Pumpkin+Puree&tag=robinfrench-20","B0062A87HA","scrape"
"butternut squash","Farmer\","https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Butternut+Squash+Puree&tag=robinfrench-20","B000HDCSTG","scrape"
"lentils","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Organic+Red+Lentils&tag=robinfrench-20","B000VDZ2GI","scrape"
"chickpeas","Goya Organic Chickpeas No Salt","https://www.amazon.com/s?k=Goya+Organic+Chickpeas+No+Salt&tag=robinfrench-20","B0BYPF1Y79","scrape"
"black beans","Eden Organic Black Beans No Salt","https://www.amazon.com/s?k=Eden+Organic+Black+Beans+No+Salt&tag=robinfrench-20","B094WYT2BK","scrape"
"green peas","Nature\","https://www.amazon.com/s?k=Nature%27s+Touch+Frozen+Organic+Green+Peas&tag=robinfrench-20","B074H4SHTD","scrape"
"carrots","Nature\","https://www.amazon.com/s?k=Nature%27s+Touch+Frozen+Organic+Carrots&tag=robinfrench-20","B074H64BPW","scrape"
"spinach","Earthbound Farm Organic Spinach Frozen","https://www.amazon.com/s?k=Earthbound+Farm+Organic+Spinach+Frozen&tag=robinfrench-20","B0013ABAJG","scrape"
"broccoli","Cascadian Farm Organic Broccoli Florets","https://www.amazon.com/s?k=Cascadian+Farm+Organic+Broccoli+Florets&tag=robinfrench-20","B07SV522V9","scrape"
"zucchini","Nature\","https://www.amazon.com/s?k=Nature%27s+Touch+Frozen+Organic+Zucchini&tag=robinfrench-20","B07Q9WV1LY","scrape"
"kale","Earthbound Farm Organic Kale","https://www.amazon.com/s?k=Earthbound+Farm+Organic+Kale&tag=robinfrench-20","B09VKDGT39","scrape"
"celery","Earthbound Farm Organic Celery","https://www.amazon.com/s?k=Earthbound+Farm+Organic+Celery&tag=robinfrench-20","B09VKDGT39","scrape"
"brussels sprouts","Cascadian Farm Organic Brussels Sprouts","https://www.amazon.com/s?k=Cascadian+Farm+Organic+Brussels+Sprouts&tag=robinfrench-20","B004DAQPR0","scrape"
"asparagus","Cascadian Farm Organic Asparagus Spears","https://www.amazon.com/s?k=Cascadian+Farm+Organic+Asparagus&tag=robinfrench-20","B07QV5G8HY","scrape"
"parsley","McCormick Culinary Parsley Flakes","https://www.amazon.com/s?k=McCormick+Culinary+Parsley+Flakes&tag=robinfrench-20","B0D8C4N4WY","scrape"
"cucumber","Nature\","https://www.amazon.com/s?k=Nature%27s+Touch+Frozen+Organic+Cucumber&tag=robinfrench-20","B001PLETDC","scrape"
"lettuce (romaine)","Organic Girl Romaine Lettuce","https://www.amazon.com/s?k=Organic+Girl+Romaine+Lettuce&tag=robinfrench-20","B0F3YTY4XQ","scrape"
"arugula","Organic Girl Baby Arugula","https://www.amazon.com/s?k=Organic+Girl+Baby+Arugula&tag=robinfrench-20","B00JXR8RYW","scrape"
"endive","Organic Endive Greens","https://www.amazon.com/s?k=Organic+Endive+Greens&tag=robinfrench-20","B0006L2XNK","scrape"
"escarole","Organic Escarole Greens","https://www.amazon.com/s?k=Organic+Escarole+Greens&tag=robinfrench-20","B084ZVBGQ6","scrape"
"dandelion greens","Organic Dandelion Greens","https://www.amazon.com/s?k=Organic+Dandelion+Greens&tag=robinfrench-20","B000WR4A5M","scrape"
"collard greens","Organic Collard Greens","https://www.amazon.com/s?k=Organic+Collard+Greens&tag=robinfrench-20","B000P6H23W","scrape"
"mustard greens","Organic Mustard Greens","https://www.amazon.com/s?k=Organic+Mustard+Greens&tag=robinfrench-20","B094JT2CCH","scrape"
"turnip greens","Organic Turnip Greens","https://www.amazon.com/s?k=Organic+Turnip+Greens&tag=robinfrench-20","B09HQH6WZT","scrape"
"beet greens","Organic Beet Greens","https://www.amazon.com/s?k=Organic+Beet+Greens&tag=robinfrench-20","B0F9LNFLTK","scrape"
"radish greens","Organic Radish Greens","https://www.amazon.com/s?k=Organic+Radish+Greens&tag=robinfrench-20","B07CHNV4S1","scrape"
"coconut oil","Nutiva Organic Virgin Coconut Oil","https://www.amazon.com/s?k=Nutiva+Organic+Virgin+Coconut+Oil&tag=robinfrench-20","B00UHCJKVG","scrape"
"olive oil","California Olive Ranch Extra Virgin Olive Oil","https://www.amazon.com/s?k=California+Olive+Ranch+Extra+Virgin+Olive+Oil&tag=robinfrench-20","B00GGBLPVU","scrape"
"salmon oil","Grizzly Salmon Plus Omega-3 Oil","https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20","B09RYYWHH1","scrape"
"flaxseed oil","Barlean\","https://www.amazon.com/s?k=Barlean%27s+Organic+Flax+Oil&tag=robinfrench-20","B002VLZ830","scrape"
"fish oil","Nordic Naturals Omega-3 Pet","https://www.amazon.com/s?k=Nordic+Naturals+Omega-3+Pet&tag=robinfrench-20","B00CBY93XS","scrape"
"taurine powder","NOW Supplements Taurine Powder 8 oz","https://www.amazon.com/s?k=NOW+Supplements+Taurine+Powder+8+oz&tag=robinfrench-20","B00VAOKFO6","scrape"
"calcium carbonate","NOW Supplements Calcium Carbonate Powder","https://www.amazon.com/s?k=NOW+Supplements+Calcium+Carbonate+Powder&tag=robinfrench-20","B004421K68","scrape"
"vitamin e","Solgar Vitamin E 400 IU","https://www.amazon.com/s?k=Solgar+Vitamin+E+400+IU&tag=robinfrench-20","B01I5OB3LW","scrape"
"b-complex","Thorne B-Complex #12","https://www.amazon.com/s?k=Thorne+B-Complex+%2312&tag=robinfrench-20","B01INRFW0E","scrape"
"probiotic powder","Purina FortiFlora Probiotic Supplement","https://www.amazon.com/s?k=Purina+FortiFlora+Probiotic+Supplement&tag=robinfrench-20","B0BGV8L7L2","scrape"
"psyllium husk","Organic India Whole Husk Psyllium","https://www.amazon.com/s?k=Organic+India+Whole+Husk+Psyllium&tag=robinfrench-20","B0016AXN7A","scrape"
"joint supplement","Cosequin DS Plus MSM for Dogs","https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Dogs&tag=robinfrench-20","B003ULL1NQ","scrape"
"omega-3 capsules","Nordic Naturals Omega-3 Pet Capsules","https://www.amazon.com/s?k=Nordic+Naturals+Omega-3+Pet+Capsules&tag=robinfrench-20","B004OA5XP4","scrape"
"digestive enzymes","NaturVet Digestive Enzymes Plus Probiotics","https://www.amazon.com/s?k=NaturVet+Digestive+Enzymes+Plus+Probiotics&tag=robinfrench-20","B00O6FINFO","scrape"
"hairball paste","Tomlyn Laxatone Hairball Remedy","https://www.amazon.com/s?k=Tomlyn+Laxatone+Hairball+Remedy&tag=robinfrench-20","B07B282MR4","scrape"
"chicken broth","Brutus Bone Broth for Dogs No Salt","https://www.amazon.com/s?k=Brutus+Bone+Broth+Dogs+No+Salt&tag=robinfrench-20","B07DFNP37Y","scrape"
"vitamin e oil","NOW Solutions Vitamin E Oil","https://www.amazon.com/s?k=NOW+Solutions+Vitamin+E+Oil&tag=robinfrench-20","B0DZ5ZCC85","scrape"
"millet (white/red)","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+White+Millet+Spray&tag=robinfrench-20","B0002DH3FU","scrape"
"canary seed","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Canary+Seed&tag=robinfrench-20","B00027ZVG4","scrape"
"niger seed","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Niger+Seed&tag=robinfrench-20","B086211R4H","scrape"
"oat groats","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Oat+Groats&tag=robinfrench-20","B086211R4H","scrape"
"hemp seeds","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Hemp+Seed&tag=robinfrench-20","B086211R4H","scrape"
"flaxseeds","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Flax+Seed&tag=robinfrench-20","B00027ZVG4","scrape"
"sesame seeds","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Sesame+Seed&tag=robinfrench-20","B086211R4H","scrape"
"chia seeds","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Chia+Seed&tag=robinfrench-20","B086211R4H","scrape"
"quinoa (cooked)","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Cooked+Quinoa&tag=robinfrench-20","B001CCOVB4","scrape"
"rapeseed","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Rapeseed&tag=robinfrench-20","B00027ZVG4","scrape"
"sunflower seeds (small amounts)","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Sunflower+Seed&tag=robinfrench-20","B00027ZVG4","scrape"
"pumpkin seeds","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Pumpkin+Seed&tag=robinfrench-20","B00027ZVG4","scrape"
"bell peppers","Earthbound Farm Organic Bell Peppers","https://www.amazon.com/s?k=Earthbound+Farm+Organic+Bell+Peppers&tag=robinfrench-20","B000P6J14K","scrape"
"corn (fresh)","Cascadian Farm Organic Corn on the Cob","https://www.amazon.com/s?k=Cascadian+Farm+Organic+Corn+on+the+Cob&tag=robinfrench-20","B000REL738","scrape"
"apples (no seeds)","Organic Honeycrisp Apples","https://www.amazon.com/s?k=Organic+Honeycrisp+Apples&tag=robinfrench-20","B00AR0TG44","scrape"
"blueberries","Driscoll\","https://www.amazon.com/s?k=Driscoll%27s+Organic+Blueberries&tag=robinfrench-20","B07Z568Y3N","scrape"
"strawberries","Driscoll\","https://www.amazon.com/s?k=Driscoll%27s+Organic+Strawberries&tag=robinfrench-20","B002B8Z98W","scrape"
"mango","Organic Mango","https://www.amazon.com/s?k=Organic+Mango&tag=robinfrench-20","B00WM6CHFQ","scrape"
"banana","Organic Bananas","https://www.amazon.com/s?k=Organic+Bananas&tag=robinfrench-20","B07ZLFKBFD","scrape"
"grapes (chopped)","Organic Red Seedless Grapes","https://www.amazon.com/s?k=Organic+Red+Seedless+Grapes&tag=robinfrench-20","B000RGYJI6","scrape"
"papaya","Organic Papaya","https://www.amazon.com/s?k=Organic+Papaya&tag=robinfrench-20","B07FZ159ZB","scrape"
"melon","Organic Cantaloupe Melon","https://www.amazon.com/s?k=Organic+Cantaloupe+Melon&tag=robinfrench-20","B000NSGULC","scrape"
"egg (hard-boiled)","Vital Essentials Freeze Dried Egg Yolk Treats","https://www.amazon.com/s?k=Vital+Essentials+Freeze+Dried+Egg+Yolk&tag=robinfrench-20","B0BWBNT8JX","scrape"
"pellets (fortified)","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Pellets&tag=robinfrench-20","B086211R4H","scrape"
"cuttlebone","Lafeber\","https://www.amazon.com/s?k=Lafeber%27s+Parrot+Food+Cuttlebone&tag=robinfrench-20","B00027ZVG4","scrape"
"honey (tiny amounts)","Local Raw Honey","https://www.amazon.com/s?k=Local+Raw+Honey&tag=robinfrench-20","B0791X9GSG","scrape"
"peanut butter (unsalted, tiny amounts)","Teddie All Natural Peanut Butter","https://www.amazon.com/s?k=Teddie+All+Natural+Peanut+Butter&tag=robinfrench-20","B06ZXZ3JPZ","scrape"
"dubia roaches","Josh\","https://www.amazon.com/s?k=Josh%27s+Frogs+Dubia+Roaches&tag=robinfrench-20","B09QD6PBB8","scrape"
"crickets","Fluker\","https://www.amazon.com/s?k=Fluker%27s+Live+Crickets&tag=robinfrench-20","B000YFGS52","scrape"
"mealworms","Fluker\","https://www.amazon.com/s?k=Fluker%27s+Freeze+Dried+Mealworms&tag=robinfrench-20","B07TKDYMMP","scrape"
"superworms","Josh\","https://www.amazon.com/s?k=Josh%27s+Frogs+Superworms&tag=robinfrench-20","B01018SX5Y","scrape"
"black soldier fly larvae","Grubblies Black Soldier Fly Larvae","https://www.amazon.com/s?k=Grubblies+Black+Soldier+Fly+Larvae&tag=robinfrench-20","B0BLZ88Q3R","scrape"
"hornworms","Josh\","https://www.amazon.com/s?k=Josh%27s+Frogs+Hornworms&tag=robinfrench-20","B09Y4RTNK9","scrape"
"acorn squash","Organic Acorn Squash","https://www.amazon.com/s?k=Organic+Acorn+Squash&tag=robinfrench-20","B07FZ34ZS4","scrape"
"figs","Organic Dried Figs","https://www.amazon.com/s?k=Organic+Dried+Figs&tag=robinfrench-20","B08MDKF98D","scrape"
"timothy hay","Oxbow Animal Health Western Timothy Hay","https://www.amazon.com/s?k=Oxbow+Animal+Health+Western+Timothy+Hay&tag=robinfrench-20","B006AYMMRY","scrape"
"meadow hay","Small Pet Select Meadow Hay","https://www.amazon.com/s?k=Small+Pet+Select+Meadow+Hay&tag=robinfrench-20","B07CJ2FRNC","scrape"
"orchard grass hay","Oxbow Animal Health Orchard Grass Hay","https://www.amazon.com/s?k=Oxbow+Animal+Health+Orchard+Grass+Hay&tag=robinfrench-20","B00S6Y8MHU","scrape"
"alfalfa hay","Kaytee Natural Alfalfa Hay","https://www.amazon.com/s?k=Kaytee+Natural+Alfalfa+Hay&tag=robinfrench-20","B0CM34Z4BQ","scrape"
"romaine lettuce","Organic Girl Romaine Lettuce","https://www.amazon.com/s?k=Organic+Girl+Romaine+Lettuce&tag=robinfrench-20","B0F3YTY4XQ","scrape"
"cilantro","Organic Cilantro","https://www.amazon.com/s?k=Organic+Cilantro&tag=robinfrench-20","B07M9FWTRC","scrape"
"basil","Organic Basil","https://www.amazon.com/s?k=Organic+Basil&tag=robinfrench-20","B097F282FC","scrape"
"duck hearts","Vital Essentials Freeze Dried Duck Hearts","https://www.amazon.com/s?k=Vital%20Essentials%20freeze%20dried%20duck%20hearts&tag=robinfrench-20","B0BWBNT8JX","scrape"
"lamb liver","Stella & Chewy\","https://www.amazon.com/s?k=freeze%20dried%20lamb%20liver%20Stella%20%26%20Chewy%27s&tag=robinfrench-20","B0015G862M","scrape"
"duck liver","Vital Essentials Freeze Dried Duck Liver","https://www.amazon.com/s?k=freeze%20dried%20duck%20liver%20Vital%20Essentials&tag=robinfrench-20","B0BWBV5PRJ","scrape"
"chicken necks","Raw Paws Pet Food Raw Chicken Necks","https://www.amazon.com/s?k=Raw%20Paws%20Pet%20Food%20raw%20chicken%20necks&tag=robinfrench-20","B0821PF71M","scrape"
"turkey thighs","Boneless Skinless Turkey Thighs","https://www.amazon.com/s?k=boneless%20skinless%20turkey%20thighs&tag=robinfrench-20","B00AR100NE","scrape"
"ground duck","Raw Paws Pet Food Raw Ground Duck","https://www.amazon.com/s?k=raw%20ground%20duck%20pet%20food&tag=robinfrench-20","B0BY3CNR3Q","scrape"
"ground lamb (lean)","Lean Ground Lamb Meat","https://www.amazon.com/s?k=lean%20ground%20lamb%20meat&tag=robinfrench-20","B088Y2N6WC","scrape"
"ground herring","K9 Natural Hoki Fish Blend","https://www.amazon.com/s?k=K9%20Natural%20Hoki%20fish%20blend&tag=robinfrench-20","B00B3G89MQ","scrape"
"ground mackerel","Northwest Naturals Raw Fish Blend","https://www.amazon.com/s?k=Northwest%20Naturals%20raw%20fish%20blend&tag=robinfrench-20","B079Z4MZTG","scrape"
"mackerel (canned)","Wild Planet Canned Mackerel","https://www.amazon.com/s?k=Wild%20Planet%20canned%20mackerel%20no%20salt&tag=robinfrench-20","B017J9X8IA","scrape"
"herring (canned)","Crown Prince Canned Herring","https://www.amazon.com/s?k=canned%20herring%20no%20salt%20in%20water%20Crown%20Prince&tag=robinfrench-20","B01FUWYO2M","scrape"
"chicken sausage (no additives)","Applegate Naturals Chicken Sausage","https://www.amazon.com/s?k=Applegate%20Naturals%20chicken%20sausage%20no%20nitrates&tag=robinfrench-20","B001JO4O80","scrape"
"turkey sausage (no additives)","Applegate Naturals Turkey Sausage","https://www.amazon.com/s?k=Applegate%20turkey%20sausage%20no%20sugar%20no%20nitrates&tag=robinfrench-20","B00I2VLI5A","scrape"
"ground pork (lean, small amounts)","Lean Ground Pork","https://www.amazon.com/s?k=lean%20ground%20pork%20for%20human%20consumption&tag=robinfrench-20","B01H0AI6J4","scrape"
"regular potato","Fresh Russet Potatoes","https://www.amazon.com/s?k=fresh%20russet%20potatoes&tag=robinfrench-20","B09SHBJWBR","scrape"
"walnut oil","La Tourangelle Walnut Oil","https://www.amazon.com/s?k=La%20Tourangelle%20walnut%20oil%20cold%20pressed&tag=robinfrench-20","B00QGWLZ3C","scrape"
"black currant oil","NOW Foods Black Currant Seed Oil","https://www.amazon.com/s?k=black%20currant%20seed%20oil%20NOW%20Foods&tag=robinfrench-20","B01FXEM0BY","scrape"
"almond oil","Viva Naturals Sweet Almond Oil","https://www.amazon.com/s?k=Viva%20Naturals%20sweet%20almond%20oil%20cold%20pressed%20edible&tag=robinfrench-20","B0BXMMDNJ8","scrape"
"sunflower oil","High Oleic Sunflower Oil Cold Pressed","https://www.amazon.com/s?k=high%20oleic%20sunflower%20oil%20cold%20pressed&tag=robinfrench-20","B00MNTRVPS","scrape"
"chia seed oil","Healthworks Organic Chia Seed Oil","https://www.amazon.com/s?k=organic%20chia%20seed%20oil%20Healthworks&tag=robinfrench-20","B00WM6CHFQ","scrape"
"herring oil","Nordic Naturals Pet Herring Oil","https://www.amazon.com/s?k=Nordic%20Naturals%20pet%20herring%20oil&tag=robinfrench-20","B00CBY93XS","scrape"
"anchovy oil","Carlson Labs Fish Oil Anchovy","https://www.amazon.com/s?k=Carlson%20Labs%20fish%20oil%20anchovy&tag=robinfrench-20","B0FDNB2DVS","scrape"
"evening primrose oil","Nature\","https://www.amazon.com/s?k=evening%20primrose%20oil%20supplement%20Nature%27s%20Way&tag=robinfrench-20","B07FPBQ31W","scrape"
"mackerel oil","Jarrow Formulas Fish Oil Supplement","https://www.amazon.com/s?k=Jarrow%20Formulas%20fish%20oil%20supplement&tag=robinfrench-20","B01NBTJFJB","scrape"
"sardine oil","Zesty Paws Sardine Oil for Dogs","https://www.amazon.com/s?k=Zesty%20Paws%20sardine%20oil%20for%20dogs&tag=robinfrench-20","B0CXKHT5K2","scrape"
"borage oil","NOW Foods Borage Oil Softgels","https://www.amazon.com/s?k=borage%20oil%20softgels%20NOW%20Foods&tag=robinfrench-20","B01FXEM0BY","scrape"
"sesame oil","Spectrum Cold Pressed Sesame Oil","https://www.amazon.com/s?k=cold%20pressed%20sesame%20oil%20Spectrum&tag=robinfrench-20","B0797GTG2C","scrape"
"avocado oil","Chosen Foods Pure Avocado Oil","https://www.amazon.com/s?k=Chosen%20Foods%20avocado%20oil%20pure&tag=robinfrench-20","B0C3WCRNPN","scrape"
"avocado oil (tiny amounts)","Chosen Foods Pure Avocado Oil","https://www.amazon.com/s?k=Chosen%20Foods%20avocado%20oil%20pure&tag=robinfrench-20","B0C3WCRNPN","scrape"
"wheat germ oil","NOW Foods Wheat Germ Oil Liquid","https://www.amazon.com/s?k=wheat%20germ%20oil%20liquid%20NOW%20Foods%20edible&tag=robinfrench-20","B001GAOHK2","scrape"
"krill oil","Kori Krill Oil Pure Supplement","https://www.amazon.com/s?k=Kori%20Krill%20Oil%20pure%20supplement&tag=robinfrench-20","B004HIQ9CY","scrape"
"algae oil (dha)","Nordic Naturals Algae Omega DHA","https://www.amazon.com/s?k=Nordic%20Naturals%20Algae%20Omega%20DHA&tag=robinfrench-20","B079J5YZSS","scrape"
"omega-3 oil","Grizzly Salmon Oil for Pets","https://www.amazon.com/s?k=Grizzly%20Salmon%20Oil%20for%20pets&tag=robinfrench-20","B09RYYWHH1","scrape"
"kelp powder","NOW Foods Organic Kelp Powder","https://www.amazon.com/s?k=NOW%20Foods%20organic%20kelp%20powder&tag=robinfrench-20","B0002JG1GG","scrape"
"joint health powder","Nutramax Dasuquin Joint Health Powder","https://www.amazon.com/s?k=Dasuquin%20joint%20health%20powder%20for%20pets&tag=robinfrench-20","B00PXK1G50","scrape"
"amino acid supplement","Purina Pro Plan Amino Acid Supplement","https://www.amazon.com/s?k=Purina%20Pro%20Plan%20amino%20acid%20supplement&tag=robinfrench-20","B0C2JFLZHF","scrape"
"calcium supplement","Thomas Labs Calcium Carbonate Powder","https://www.amazon.com/s?k=calcium%20carbonate%20powder%20unflavored%20Thomas%20Labs&tag=robinfrench-20","B0CKNK682W","scrape"
"spirulina powder","Vimergy Organic Spirulina Powder","https://www.amazon.com/s?k=organic%20spirulina%20powder%20Vimergy%20high%20purity&tag=robinfrench-20","B08S4982CC","scrape"
"electrolyte powder","ReptoBoost Electrolyte Powder","https://www.amazon.com/s?k=ReptoBoost%20electrolyte%20powder%20for%20reptiles&tag=robinfrench-20","B0FMZHN6M1","scrape"
"vitamin d3 drops","Ddrops Liquid Vitamin D3 Drops","https://www.amazon.com/s?k=Vitamin%20D3%20drops%201000%20IU%20Ddrops&tag=robinfrench-20","B0062QD5LM","scrape"
"s yeast","Bob\","https://www.amazon.com/s?k=brewer%27s%20yeast%20flakes%20unfortified%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B084JL2R77","scrape"
"buckwheat","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20raw%20hulled%20buckwheat%20groats&tag=robinfrench-20","B00KQ17MDG","scrape"
"buckwheat (tiny amounts)","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20raw%20hulled%20buckwheat%20groats&tag=robinfrench-20","B00KQ17MDG","scrape"
"buckwheat (hulled)","Anthony\","https://www.amazon.com/s?k=hulled%20buckwheat%20groats%20Anthony%27s%20Goods&tag=robinfrench-20","B0D15QDVW7","scrape"
"sorghum","Bob\","https://www.amazon.com/s?k=whole%20grain%20sorghum%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B0FKBVN6XP","scrape"
"barley","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20hulled%20barley%20grain&tag=robinfrench-20","B0D481997Z","scrape"
"barley (cooked, minimal)","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20hulled%20barley%20grain&tag=robinfrench-20","B00QKP257A","scrape"
"barley (hulled)","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20hulled%20barley%20grain&tag=robinfrench-20","B00QKP257A","scrape"
"millet","Bob\","https://www.amazon.com/s?k=whole%20grain%20millet%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B0FKBVN6XP","scrape"
"millet (tiny amounts)","Bob\","https://www.amazon.com/s?k=whole%20grain%20millet%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B07XPCWYP2","scrape"
"farro","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20farro%20grain&tag=robinfrench-20","B0FKBVN6XP","scrape"
"bulgur","Bob\","https://www.amazon.com/s?k=fine%20bulgur%20wheat%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B081DQ5NG5","scrape"
"amaranth (tiny amounts)","Bob\","https://www.amazon.com/s?k=whole%20grain%20amaranth%20seed%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B000V1O40U","scrape"
"amaranth seeds","Bob\","https://www.amazon.com/s?k=whole%20grain%20amaranth%20seed%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B000V1O40U","scrape"
"teff seeds","Bob\","https://www.amazon.com/s?k=Bob%27s%20Red%20Mill%20whole%20grain%20teff%20seeds&tag=robinfrench-20","B0FKBVN6XP","scrape"
"wheat (hulled)","Bob\","https://www.amazon.com/s?k=whole%20hulled%20wheat%20berries%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B000YFB5NC","scrape"
"oat bran (small amounts)","Bob\","https://www.amazon.com/s?k=pure%20oat%20bran%20cereal%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B07CC9RF6Y","scrape"
"oatmeal (cooked, small amounts)","Quaker Rolled Oats Old Fashioned","https://www.amazon.com/s?k=Quaker%20rolled%20oats%20old%20fashioned&tag=robinfrench-20","B00CTLAIH8","scrape"
"corn (cracked)","Scratch and Peck Cracked Corn Non-GMO","https://www.amazon.com/s?k=Scratch%20and%20Peck%20cracked%20corn%20non-gmo&tag=robinfrench-20","B01HHGD81C","scrape"
"safflower seeds","Wagner\","https://www.amazon.com/s?k=pure%20safflower%20seed%20bird%20food%20Wagner%27s&tag=robinfrench-20","B0FWLFGG21","scrape"
"nyjer seeds","Wagner\","https://www.amazon.com/s?k=nyjer%20seed%20bird%20food%20Kaytee&tag=robinfrench-20","B0D6688V7C","scrape"
"bok choi","Fresh Baby Bok Choy","https://www.amazon.com/s?k=fresh%20baby%20bok%20choy&tag=robinfrench-20","B0FN4YGSK6","scrape"
"bok choy (small amounts)","Fresh Baby Bok Choy","https://www.amazon.com/s?k=fresh%20baby%20bok%20choy&tag=robinfrench-20","B0FN4YGSK6","scrape"
"navy beans (mashed)","Goya Canned Navy Beans Low Sodium","https://www.amazon.com/s?k=canned%20navy%20beans%20low%20sodium%20Goya&tag=robinfrench-20","B006AZE13G","scrape"
"kidney beans (mashed)","Goya Canned Dark Red Kidney Beans Low Sodium","https://www.amazon.com/s?k=canned%20dark%20red%20kidney%20beans%20low%20sodium&tag=robinfrench-20","B00552005I","scrape"
"kidney beans (mashed, tiny amounts)","Goya Canned Dark Red Kidney Beans Low Sodium","https://www.amazon.com/s?k=canned%20dark%20red%20kidney%20beans%20low%20sodium&tag=robinfrench-20","B00552005I","scrape"
"pinto beans (mashed)","Bush\","https://www.amazon.com/s?k=canned%20pinto%20beans%20low%20sodium%20Bush%27s&tag=robinfrench-20","B0C4G2PR58","scrape"
"purslane","Fresh Purslane Leaves","https://www.amazon.com/s?k=fresh%20purslane%20leaves&tag=robinfrench-20","B09MDXM2YQ","scrape"
"purslane (small amounts)","Fresh Purslane Leaves","https://www.amazon.com/s?k=fresh%20purslane%20leaves&tag=robinfrench-20","B0BWY8JWVL","scrape"
"s lettuce","Miner\","https://www.amazon.com/s?k=miner%27s%20lettuce%20seeds%20for%20planting&tag=robinfrench-20","B0D3J7FZFD","scrape"
"flaxseed (ground)","Bob\","https://www.amazon.com/s?k=organic%20ground%20flaxseed%20meal%20Bob%27s%20Red%20Mill&tag=robinfrench-20","B075XC6C69","scrape"
"fennel","Fresh Fennel Bulb","https://www.amazon.com/s?k=fresh%20fennel%20bulb&tag=robinfrench-20","B00E3J6RC4","scrape"
"delicata squash","Fresh Delicata Squash","https://www.amazon.com/s?k=fresh%20delicata%20squash&tag=robinfrench-20","B07KHH8K4L","scrape"
"yellow squash","Fresh Yellow Summer Squash","https://www.amazon.com/s?k=fresh%20yellow%20summer%20squash&tag=robinfrench-20","B08QVBFGDC","scrape"
"leeks","Fresh Leeks","https://www.amazon.com/s?k=fresh%20leeks&tag=robinfrench-20","B09HQJGQDG","scrape"
"shallots","Fresh Shallots","https://www.amazon.com/s?k=fresh%20shallots&tag=robinfrench-20","B09B2ZWHKQ","scrape"
"tomatoes (small amounts)","Fresh Ripe Vine Tomatoes","https://www.amazon.com/s?k=fresh%20ripe%20vine%20tomatoes&tag=robinfrench-20","B086WX15TH","scrape"
"napa cabbage","Fresh Napa Cabbage","https://www.amazon.com/s?k=fresh%20napa%20cabbage&tag=robinfrench-20","B07FTVYNM3","scrape"
"napa cabbage (small amounts)","Fresh Napa Cabbage","https://www.amazon.com/s?k=fresh%20napa%20cabbage&tag=robinfrench-20","B079VV1K9L","scrape"
"artichokes","Fresh Artichoke Hearts","https://www.amazon.com/s?k=fresh%20artichoke%20hearts&tag=robinfrench-20","B0DF91JXND","scrape"
"frisee","Fresh Frisee Lettuce","https://www.amazon.com/s?k=fresh%20frisee%20lettuce&tag=robinfrench-20","B07FZGKZL4","scrape"
"radicchio","Fresh Radicchio Lettuce","https://www.amazon.com/s?k=fresh%20radicchio%20lettuce&tag=robinfrench-20","B00BJPTZLA","scrape"
"red cabbage","Fresh Red Cabbage Head","https://www.amazon.com/s?k=fresh%20red%20cabbage%20head&tag=robinfrench-20","B000RH1MXK","scrape"
"green cabbage","Fresh Green Cabbage Head","https://www.amazon.com/s?k=fresh%20green%20cabbage%20head&tag=robinfrench-20","B09HQGDCKV","scrape"
"swiss chard","Fresh Swiss Chard","https://www.amazon.com/s?k=fresh%20swiss%20chard&tag=robinfrench-20","B07F12P248","scrape"
"swiss chard (cooked, tiny amounts)","Fresh Swiss Chard","https://www.amazon.com/s?k=fresh%20swiss%20chard&tag=robinfrench-20","B07F12P248","scrape"
"lettuce (romaine, small amounts)","Fresh Romaine Lettuce Hearts","https://www.amazon.com/s?k=fresh%20romaine%20lettuce%20hearts&tag=robinfrench-20","B074H5J9G2","scrape"
"red leaf lettuce","Fresh Red Leaf Lettuce","https://www.amazon.com/s?k=fresh%20red%20leaf%20lettuce&tag=robinfrench-20","B0BX76BG5V","scrape"
"mache","Fresh Mache Lamb\","https://www.amazon.com/s?k=fresh%20mache%20lamb%27s%20lettuce&tag=robinfrench-20","B00AWLAQFG","scrape"
"alfalfa sprouts (small amounts)","Fresh Alfalfa Sprouts","https://www.amazon.com/s?k=fresh%20alfalfa%20sprouts&tag=robinfrench-20","B0DFZTWLTY","scrape"
"cat grass (wheatgrass)","SmartyKat Cat Grass Growing Kit Wheatgrass","https://www.amazon.com/s?k=Cat%20Grass%20growing%20kit%20wheatgrass%20SmartyKat&tag=robinfrench-20","B0D45F9TGG","scrape"
"squash (cooked)","Fresh Butternut Squash","https://www.amazon.com/s?k=fresh%20butternut%20squash&tag=robinfrench-20","B002QY3U5A","scrape"
"s quarters","Lamb\","https://www.amazon.com/s?k=lamb%27s%20quarters%20seeds&tag=robinfrench-20","B0DYPHGW89","scrape"
"amaranth leaves","Fresh Amaranth Leaves","https://www.amazon.com/s?k=fresh%20amaranth%20leaves&tag=robinfrench-20","B0F2YRBGS6","scrape"
"ginger (small amounts)","Simply Organic Fresh Ginger Root","https://www.amazon.com/s?k=organic%20ginger%20root%20fresh&tag=robinfrench-20","B0C6V3416T","scrape"
"turmeric","Simply Organic Pure Turmeric Powder","https://www.amazon.com/s?k=Simply%20Organic%20pure%20turmeric%20powder&tag=robinfrench-20","B018GPDCV4","scrape"
"rosemary","Frontier Co-op Dried Organic Rosemary","https://www.amazon.com/s?k=Frontier%20Co-op%20dried%20organic%20rosemary&tag=robinfrench-20","B004JWLMNY","scrape"
"sage","Simply Organic Dried Sage Leaf","https://www.amazon.com/s?k=Simply%20Organic%20dried%20sage%20leaf&tag=robinfrench-20","B0CH3R9TVY","scrape"
"mint","Fresh Mint Leaves","https://www.amazon.com/s?k=fresh%20mint%20leaves&tag=robinfrench-20","B097F3NT7N","scrape"
"garlic chives","Fresh Garlic Chives","https://www.amazon.com/s?k=fresh%20garlic%20chives&tag=robinfrench-20","B097F3J1PY","scrape"
"raisins (unsweetened)","Sun-Maid Organic Raisins Unsweetened","https://www.amazon.com/s?k=organic%20raisins%20unsweetened%20no%20oil%20Sun-Maid&tag=robinfrench-20","B01GXPRIQY","scrape"
"plums (pitted)","Fresh Plums Pitted","https://www.amazon.com/s?k=fresh%20plums%20pitted&tag=robinfrench-20","B07P6Z8L76","scrape"
"apricots (pitted)","NOW Foods Dried Apricots Unsulphured","https://www.amazon.com/s?k=dried%20apricots%20unsulphured%20no%20sugar%20NOW%20Foods&tag=robinfrench-20","B07FZWBPC5","scrape"
"kiwi","Fresh Kiwi Fruit","https://www.amazon.com/s?k=fresh%20kiwi%20fruit&tag=robinfrench-20","B01LASWK7G","scrape"
"mulberries","Terrasoul Dried Mulberries Organic","https://www.amazon.com/s?k=Terrasoul%20dried%20mulberries%20organic&tag=robinfrench-20","B074153BXC","scrape"
"raspberries","Fresh Raspberries Organic","https://www.amazon.com/s?k=fresh%20raspberries%20organic&tag=robinfrench-20","B000P6G12U","scrape"
"cranberries","NOW Foods Dried Cranberries Unsweetened","https://www.amazon.com/s?k=NOW%20Foods%20dried%20cranberries%20unsweetened&tag=robinfrench-20","B074153BXC","scrape"
"pineapple (small amounts)","Fresh Pineapple Fruit","https://www.amazon.com/s?k=fresh%20pineapple%20fruit&tag=robinfrench-20","B000P6L3V4","scrape"
"pears (no seeds)","Fresh Pears No Seeds","https://www.amazon.com/s?k=fresh%20pears%20no%20seeds&tag=robinfrench-20","B0DYKVQ3XZ","scrape"
"pinhead crickets","Josh\","https://www.amazon.com/s?k=Josh%27s%20Frogs%20live%20pinhead%20crickets&tag=robinfrench-20","B07196FX9W","scrape"
"locusts","Exo Terra Canned Locusts Reptile Food","https://www.amazon.com/s?k=Exo%20Terra%20canned%20locusts%20reptile%20food&tag=robinfrench-20","B000CMKHBS","scrape"
"butterworms","Rainbow Mealworms Live Butterworms","https://www.amazon.com/s?k=Rainbow%20Mealworms%20live%20butterworms&tag=robinfrench-20","B093BD8NXR","scrape"
"grasshoppers","Fluker\","https://www.amazon.com/s?k=Fluker%27s%20dried%20grasshoppers%20reptile%20food&tag=robinfrench-20","B004HSQRG2","scrape"
"small dubia roaches","Small Live Dubia Roaches Feeder","https://www.amazon.com/s?k=small%20live%20dubia%20roaches%20feeder&tag=robinfrench-20","B09QD6PBB8","scrape"
"silkworms","Live Silkworms Reptile Food","https://www.amazon.com/s?k=live%20silkworms%20reptile%20food&tag=robinfrench-20","B08JKNZPSF","scrape"
"earthworms","Uncle Jim\","https://www.amazon.com/s?k=Uncle%20Jim%27s%20live%20earthworms&tag=robinfrench-20","B097PDMK47","scrape"
"wheat hay","Oxbow Wheat Hay Small Animal","https://www.amazon.com/s?k=Oxbow%20wheat%20hay%20small%20animal&tag=robinfrench-20","B0CLC76V98","scrape"
"fescue hay","Small Pet Select Fescue Hay","https://www.amazon.com/s?k=Small%20Pet%20Select%20fescue%20hay&tag=robinfrench-20","B00S6YIF36","scrape"
"oat hay","Oxbow Oat Hay Small Animal","https://www.amazon.com/s?k=Oxbow%20oat%20hay%20small%20animal&tag=robinfrench-20","B000WFKP80","scrape"
"bluegrass hay","Small Pet Select Bluegrass Hay","https://www.amazon.com/s?k=Small%20Pet%20Select%20bluegrass%20hay&tag=robinfrench-20","B00S6Y8MHU","scrape"
"straw (wheat/pine)","Oxbow Wheat Straw Bedding","https://www.amazon.com/s?k=Oxbow%20wheat%20straw%20bedding&tag=robinfrench-20","B0CDQMD1CB","scrape"
"dried grass","Kaytee Dried Natural Grass Small Animal","https://www.amazon.com/s?k=dried%20natural%20grass%20small%20animal%20Kaytee&tag=robinfrench-20","B0002DK8OI","scrape"
"bermuda hay","Standlee Premium Bermuda Hay","https://www.amazon.com/s?k=Standlee%20premium%20bermuda%20hay&tag=robinfrench-20","B0FSVM5P3D","scrape"
"barley hay","Standlee Barley Hay","https://www.amazon.com/s?k=Standlee%20barley%20hay&tag=robinfrench-20","B08YM9VJC5","scrape"
"guinea pig pellets (with vitamin c)","Oxbow Essentials Cavy Cuisine Guinea Pig Pellets","https://www.amazon.com/s?k=Oxbow%20guinea%20pig%20pellets%20vitamin%20c&tag=robinfrench-20","B00E4KT5NA","scrape"
"rabbit pellets (high fiber)","Oxbow Essentials Rabbit Food High Fiber","https://www.amazon.com/s?k=Oxbow%20adult%20rabbit%20pellets%20high%20fiber&tag=robinfrench-20","B0017JANQY","scrape"
"hamster pellets (higher protein)","Oxbow Essentials Hamster Food Higher Protein","https://www.amazon.com/s?k=Oxbow%20hamster%20food%20higher%20protein&tag=robinfrench-20","B0053SYJVA","scrape"
"wild bird mix","Lyric Wild Bird Mix No Filler","https://www.amazon.com/s?k=Lyric%20wild%20bird%20mix%20no%20filler&tag=robinfrench-20","B0FWLFGG21","scrape"
"beta-glucans","NOW Supplements Beta Glucans 60 Capsules","https://www.amazon.com/s?k=NOW+Supplements+Beta+Glucans+60+Capsules&tag=robinfrench-20","B01LWVNL9J","scrape"
"biotin","NOW Supplements Biotin 5000 mcg","https://www.amazon.com/s?k=NOW+Supplements+Biotin+5000+mcg&tag=robinfrench-20","B01AMJCHB8","scrape"
"bone broth (low sodium)","Brutus Bone Broth for Dogs Low Sodium","https://www.amazon.com/s?k=Brutus+Bone+Broth+Dogs+Low+Sodium&tag=robinfrench-20","B07DFNP37Y","scrape"
"cauliflower","Fresh Organic Cauliflower","https://www.amazon.com/s?k=fresh+organic+cauliflower&tag=robinfrench-20","B000P6G0GM","scrape"
"chicory root","NOW Supplements Inulin Prebiotic Fiber","https://www.amazon.com/s?k=NOW+Supplements+Inulin+Prebiotic+Fiber&tag=robinfrench-20","B08Q7KZYKC","scrape"
"chondroitin sulfate","Cosequin DS Plus MSM with Chondroitin","https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Chondroitin&tag=robinfrench-20","B003ULL1NQ","scrape"
"cranberry extract","NOW Supplements Cranberry Extract 5000 mg","https://www.amazon.com/s?k=NOW+Supplements+Cranberry+Extract+5000+mg&tag=robinfrench-20","B01N7KMPU3","scrape"
"curcumin (turmeric extract)","NOW Supplements Curcumin with BioPerine","https://www.amazon.com/s?k=NOW+Supplements+Curcumin+BioPerine&tag=robinfrench-20","B0CK3C31JP","scrape"
"d-mannose","NOW Supplements D-Mannose Powder","https://www.amazon.com/s?k=NOW+Supplements+D-Mannose+Powder&tag=robinfrench-20","B01N6X9YBS","scrape"
"egg yolks","Vital Farms Pasture-Raised Eggs","https://www.amazon.com/s?k=Vital+Farms+Pasture-Raised+Eggs&tag=robinfrench-20","B00M1QWODW","scrape"
"eggplant","Fresh Organic Eggplant","https://www.amazon.com/s?k=fresh+organic+eggplant&tag=robinfrench-20","B001PLGQPQ","scrape"
"eggshells (crushed)","NOW Supplements Calcium Carbonate Powder","https://www.amazon.com/s?k=NOW+Supplements+Calcium+Carbonate+Powder&tag=robinfrench-20","B004421K68","scrape"
"fish broth (no salt)","Brutus Fish Broth for Dogs No Salt","https://www.amazon.com/s?k=Brutus+Fish+Broth+Dogs+No+Salt&tag=robinfrench-20","B07DFQFLJL","scrape"
"fructooligosaccharides (fos)","NOW Supplements FOS Prebiotic Fiber","https://www.amazon.com/s?k=NOW+Supplements+FOS+Prebiotic+Fiber&tag=robinfrench-20","B08Q7KZYKC","scrape"
"glucosamine sulfate","Cosequin DS Plus MSM Glucosamine","https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Glucosamine&tag=robinfrench-20","B003ULL1NQ","scrape"
"green beans","Fresh Organic Green Beans","https://www.amazon.com/s?k=fresh+organic+green+beans&tag=robinfrench-20","B0DDTC6QNY","scrape"
"green beans (cooked)","Fresh Organic Green Beans","https://www.amazon.com/s?k=fresh+organic+green+beans&tag=robinfrench-20","B0DDTC6QNY","scrape"
"hairball control paste","Tomlyn Laxatone Hairball Remedy","https://www.amazon.com/s?k=Tomlyn+Laxatone+Hairball+Remedy&tag=robinfrench-20","B07B282MR4","scrape"
"hyaluronic acid","NOW Supplements Hyaluronic Acid 100 mg","https://www.amazon.com/s?k=NOW+Supplements+Hyaluronic+Acid+100+mg&tag=robinfrench-20","B07XHNCJMC","scrape"
"inulin (prebiotic)","NOW Supplements Inulin Prebiotic Fiber","https://www.amazon.com/s?k=NOW+Supplements+Inulin+Prebiotic+Fiber&tag=robinfrench-20","B08Q7KZYKC","scrape"
"jerusalem artichoke","Fresh Jerusalem Artichoke Sunchokes","https://www.amazon.com/s?k=fresh+Jerusalem+artichoke+sunchokes&tag=robinfrench-20","B0CQK5XCVZ","scrape"
"joint health supplement","Cosequin DS Plus MSM for Dogs","https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Dogs&tag=robinfrench-20","B003ULL1NQ","scrape"
"l-carnitine powder","NOW Supplements L-Carnitine 500 mg","https://www.amazon.com/s?k=NOW+Supplements+L-Carnitine+500+mg&tag=robinfrench-20","B06Y1BTLGK","scrape"
"lysine powder","NOW Supplements L-Lysine 1000 mg","https://www.amazon.com/s?k=NOW+Supplements+L-Lysine+1000+mg&tag=robinfrench-20","B00V3MR88G","scrape"
"malabar spinach","Fresh Malabar Spinach Leaves","https://www.amazon.com/s?k=fresh+Malabar+spinach+leaves&tag=robinfrench-20","B0DLT7BSNJ","scrape"
"mannanoligosaccharides (mos)","NOW Supplements MOS Prebiotic","https://www.amazon.com/s?k=NOW+Supplements+MOS+Prebiotic&tag=robinfrench-20","B0CRFWM2Z6","scrape"
"milk thistle","NOW Supplements Milk Thistle 150 mg","https://www.amazon.com/s?k=NOW+Supplements+Milk+Thistle+150+mg&tag=robinfrench-20","B0019LVFD0","scrape"
"new zealand spinach","Fresh New Zealand Spinach","https://www.amazon.com/s?k=fresh+New+Zealand+spinach&tag=robinfrench-20","B0C8VD126M","scrape"
"niacinamide","NOW Supplements Niacinamide 500 mg","https://www.amazon.com/s?k=NOW+Supplements+Niacinamide+500+mg&tag=robinfrench-20","B0CZMBZPLV","scrape"
"oats (rolled)","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Old+Fashioned+Rolled+Oats&tag=robinfrench-20","B07VCM66N6","scrape"
"peas","Fresh Organic Green Peas","https://www.amazon.com/s?k=fresh+organic+green+peas&tag=robinfrench-20","B07D1NGQ6B","scrape"
"peas (mashed)","Fresh Organic Green Peas","https://www.amazon.com/s?k=fresh+organic+green+peas&tag=robinfrench-20","B07D1NGQ6B","scrape"
"pectin (from apples)","NOW Supplements Apple Pectin Powder","https://www.amazon.com/s?k=NOW+Supplements+Apple+Pectin+Powder&tag=robinfrench-20","B01CO69SYG","scrape"
"pumpkin seed oil","NOW Solutions Pumpkin Seed Oil","https://www.amazon.com/s?k=NOW+Solutions+Pumpkin+Seed+Oil&tag=robinfrench-20","B0FKYLMWYG","scrape"
"quail eggs","Fresh Quail Eggs","https://www.amazon.com/s?k=fresh+quail+eggs&tag=robinfrench-20","B0BSRGV9PR","scrape"
"quercetin","NOW Supplements Quercetin with Bromelain","https://www.amazon.com/s?k=NOW+Supplements+Quercetin+Bromelain&tag=robinfrench-20","B08M5L372P","scrape"
"rice (hulled)","Lundberg Organic Brown Rice","https://www.amazon.com/s?k=Lundberg+Organic+Brown+Rice&tag=robinfrench-20","B072JNNB33","scrape"
"romanesco broccoli","Fresh Romanesco Broccoli","https://www.amazon.com/s?k=fresh+romanesco+broccoli&tag=robinfrench-20","B01I1Q74MQ","scrape"
"s-adenosyl methionine (sam-e)","NOW Supplements SAM-e 200 mg","https://www.amazon.com/s?k=NOW+Supplements+SAM-e+200+mg&tag=robinfrench-20","B000OSSQFY","scrape"
"sardines (in water)","Wild Planet Sardines in Water No Salt","https://www.amazon.com/s?k=Wild+Planet+Sardines+Water+No+Salt&tag=robinfrench-20","B01FUWYO2M","scrape"
"snap peas","Fresh Organic Snap Peas","https://www.amazon.com/s?k=fresh+organic+snap+peas&tag=robinfrench-20","B077L6C7YB","scrape"
"snow peas","Fresh Organic Snow Peas","https://www.amazon.com/s?k=fresh+organic+snow+peas&tag=robinfrench-20","B07MGSDD7L","scrape"
"snow peas (mashed)","Fresh Organic Snow Peas","https://www.amazon.com/s?k=fresh+organic+snow+peas&tag=robinfrench-20","B08KRNKC9G","scrape"
"split peas","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Split+Peas&tag=robinfrench-20","B08DVGSW58","scrape"
"split peas (mashed)","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Split+Peas&tag=robinfrench-20","B08DVGSW58","scrape"
"sugar snap peas","Fresh Organic Sugar Snap Peas","https://www.amazon.com/s?k=fresh+organic+sugar+snap+peas&tag=robinfrench-20","B08DVGSW58","scrape"
"sugar snap peas (mashed)","Fresh Organic Sugar Snap Peas","https://www.amazon.com/s?k=fresh+organic+sugar+snap+peas&tag=robinfrench-20","B08DVGSW58","scrape"
"turkey broth (no salt)","Brutus Turkey Broth for Dogs No Salt","https://www.amazon.com/s?k=Brutus+Turkey+Broth+Dogs+No+Salt&tag=robinfrench-20","B07DFQFLJL","scrape"
"vitamin b complex","Thorne B-Complex #12","https://www.amazon.com/s?k=Thorne+B-Complex+%2312&tag=robinfrench-20","B01INRFW0E","scrape"
"vitamin c (small amounts)","NOW Supplements Vitamin C 1000 mg","https://www.amazon.com/s?k=NOW+Supplements+Vitamin+C+1000+mg&tag=robinfrench-20","B074GCB1ND","scrape"
"watercress","Fresh Organic Watercress","https://www.amazon.com/s?k=fresh+organic+watercress&tag=robinfrench-20","B0BSK8P8KS","scrape"
"watercress (small amounts)","Fresh Organic Watercress","https://www.amazon.com/s?k=fresh+organic+watercress&tag=robinfrench-20","B0BSK8P8KS","scrape"
"wheat germ","Bob\","https://www.amazon.com/s?k=Bob%27s+Red+Mill+Wheat+Germ&tag=robinfrench-20","B0FKBVN6XP","scrape"
"wild rice","Lundberg Organic Wild Rice","https://www.amazon.com/s?k=Lundberg+Organic+Wild+Rice&tag=robinfrench-20","B089CP461X","scrape"
</file>

<file path="data/csv/MANUAL_REVIEW_REQUIRED.csv">
Status,Ingredient,Product Name,ASIN,Confidence,Issues,Notes,Action Needed,Link
NEEDS-REVIEW,"ground chicken","Fresh Is Best Freeze Dried Chicken Breast",B0BXZVFN6G,MEDIUM,"Duplicate ASIN shared with: chicken giblets","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
AUTO-INVALID,"ground beef (lean)","US Wellness Meats Pet Burger",B07VHR2WNZ,LOW,"CRITICAL: Missing required tokens: beef, ground; CRITICAL: Contains forbidden tokens: burger; WARNING: No acceptable form found. Expected one of: raw, frozen, fresh, lean","‚ùå Failed validation - likely wrong product",FIND NEW ASIN,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"ground lamb","Raw Paws Lamb Recipe Rolls",B0082C00P8,HIGH,"Dead link (HTTP 405)","NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"chicken hearts","Vital Essentials Freeze Dried Chicken Hearts",B0BXZ3JJL9,MEDIUM,"WARNING: No acceptable form found. Expected one of: raw, frozen, fresh","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"sardines (canned in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,MEDIUM,"WARNING: No acceptable form found. Expected one of: canned, water packed","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"turkey giblets","Vital Essentials Freeze Dried Turkey Giblets",B0BXZ3JJL9,MEDIUM,"WARNING: No acceptable form found. Expected one of: raw, frozen, fresh","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"chicken giblets","Fresh Is Best Freeze Dried Chicken Giblets",B0BXZVFN6G,MEDIUM,"Duplicate ASIN shared with: ground chicken","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
AUTO-INVALID,"venison","Fresh Is Best Freeze Dried Venison Bites",B07VHR2WNZ,LOW,"CRITICAL: Missing required tokens: deer","‚ùå Failed validation - likely wrong product",FIND NEW ASIN,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"rabbit meat","Evanger's Rabbit Grain Free Cans",B0082C00P8,HIGH,"Dead link (HTTP 405)","NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"brown rice","Lundberg Family Farms Organic Brown Rice",B072JNNB33,MEDIUM,"WARNING: No acceptable form found. Expected one of: whole grain, long grain, short grain","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20
NEEDS-REVIEW,"kale","Earthbound Farm Organic Kale",B09VKDGT39,MEDIUM,"Duplicate ASIN shared with: celery","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
NEEDS-REVIEW,"celery","Earthbound Farm Organic Celery",B09VKDGT39,MEDIUM,"Duplicate ASIN shared with: kale","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
NEEDS-REVIEW,"lettuce (romaine)","Organic Girl Romaine Lettuce",B0F3YTY4XQ,MEDIUM,"Duplicate ASIN shared with: romaine lettuce","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20
AUTO-INVALID,"endive","Organic Endive Greens",B0006L2XNK,HIGH,"Dead link (HTTP 405)","NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20
NEEDS-REVIEW,"salmon oil","Grizzly Salmon Plus Omega-3 Oil",B09RYYWHH1,MEDIUM,"Duplicate ASIN shared with: omega-3 oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20
NEEDS-REVIEW,"fish oil","Nordic Naturals Omega-3 Pet",B00CBY93XS,MEDIUM,"Duplicate ASIN shared with: herring oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"calcium carbonate","NOW Supplements Calcium Carbonate Powder",B004421K68,MEDIUM,"Duplicate ASIN shared with: eggshells (crushed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20
NEEDS-REVIEW,"b-complex","Thorne B-Complex #12",B01INRFW0E,MEDIUM,"Duplicate ASIN shared with: vitamin b complex","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20
NEEDS-REVIEW,"joint supplement","Cosequin DS Plus MSM for Dogs",B003ULL1NQ,MEDIUM,"Duplicate ASIN shared with: chondroitin sulfate, glucosamine sulfate, joint health supplement","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
NEEDS-REVIEW,"hairball paste","Tomlyn Laxatone Hairball Remedy",B07B282MR4,MEDIUM,"Duplicate ASIN shared with: hairball control paste","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20
NEEDS-REVIEW,"chicken broth","Brutus Bone Broth for Dogs No Salt",B07DFNP37Y,MEDIUM,"Duplicate ASIN shared with: bone broth (low sodium)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20
NEEDS-REVIEW,"niger seed","Lafeber's Parrot Food Niger Seed",B086211R4H,MEDIUM,"WARNING: Only 33% of required tokens present","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"oat groats","Lafeber's Parrot Food Oat Groats",B086211R4H,MEDIUM,"Duplicate ASIN shared with: niger seed, hemp seeds, sesame seeds, chia seeds, pellets (fortified)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"sesame seeds","Lafeber's Parrot Food Sesame Seed",B086211R4H,MEDIUM,"Duplicate ASIN shared with: niger seed, oat groats, hemp seeds, chia seeds, pellets (fortified)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"rapeseed","Lafeber's Parrot Food Rapeseed",B00027ZVG4,MEDIUM,"Duplicate ASIN shared with: canary seed, flaxseeds, sunflower seeds (small amounts), pumpkin seeds, cuttlebone","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"sunflower seeds (small amounts)","Lafeber's Parrot Food Sunflower Seed",B00027ZVG4,MEDIUM,"WARNING: No acceptable form found. Expected one of: raw, shelled, unshelled","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"pumpkin seeds","Lafeber's Parrot Food Pumpkin Seed",B00027ZVG4,MEDIUM,"WARNING: No acceptable form found. Expected one of: raw, shelled, pepitas","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"mango","Organic Mango",B00WM6CHFQ,MEDIUM,"Duplicate ASIN shared with: chia seed oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
NEEDS-REVIEW,"egg (hard-boiled)","Vital Essentials Freeze Dried Egg Yolk Treats",B0BWBNT8JX,MEDIUM,"WARNING: No acceptable form found. Expected one of: hard boiled, hard-boiled, boiled, whole","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"pellets (fortified)","Lafeber's Parrot Food Pellets",B086211R4H,MEDIUM,"Duplicate ASIN shared with: niger seed, oat groats, hemp seeds, sesame seeds, chia seeds","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"cuttlebone","Lafeber's Parrot Food Cuttlebone",B00027ZVG4,MEDIUM,"Duplicate ASIN shared with: canary seed, flaxseeds, rapeseed, sunflower seeds (small amounts), pumpkin seeds","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"dubia roaches","Josh's Frogs Live Dubia Roaches",B09QD6PBB8,MEDIUM,"Duplicate ASIN shared with: small dubia roaches","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20
NEEDS-REVIEW,"orchard grass hay","Oxbow Animal Health Orchard Grass Hay",B00S6Y8MHU,MEDIUM,"Duplicate ASIN shared with: bluegrass hay","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"romaine lettuce","Organic Girl Romaine Lettuce",B0F3YTY4XQ,MEDIUM,"Duplicate ASIN shared with: lettuce (romaine)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20
NEEDS-REVIEW,"duck hearts","Vital Essentials Freeze Dried Duck Hearts",B0BWBNT8JX,MEDIUM,"WARNING: No acceptable form found. Expected one of: raw, frozen, fresh","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"black currant oil","NOW Foods Black Currant Seed Oil",B01FXEM0BY,MEDIUM,"Duplicate ASIN shared with: borage oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"herring oil","Nordic Naturals Pet Herring Oil",B00CBY93XS,MEDIUM,"Duplicate ASIN shared with: fish oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"borage oil","NOW Foods Borage Oil Softgels",B01FXEM0BY,MEDIUM,"Duplicate ASIN shared with: black currant oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"avocado oil","Chosen Foods Pure Avocado Oil",B0C3WCRNPN,MEDIUM,"Duplicate ASIN shared with: avocado oil (tiny amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20
NEEDS-REVIEW,"avocado oil (tiny amounts)","Chosen Foods Pure Avocado Oil",B0C3WCRNPN,MEDIUM,"Duplicate ASIN shared with: avocado oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20
NEEDS-REVIEW,"omega-3 oil","Grizzly Salmon Oil for Pets",B09RYYWHH1,MEDIUM,"Duplicate ASIN shared with: salmon oil","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20
NEEDS-REVIEW,"buckwheat","Bob's Red Mill Raw Hulled Buckwheat Groats",B00KQ17MDG,MEDIUM,"Duplicate ASIN shared with: buckwheat (tiny amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20
NEEDS-REVIEW,"buckwheat (tiny amounts)","Bob's Red Mill Raw Hulled Buckwheat Groats",B00KQ17MDG,MEDIUM,"Duplicate ASIN shared with: buckwheat","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20
NEEDS-REVIEW,"sorghum","Bob's Red Mill Whole Grain Sorghum",B0FKBVN6XP,MEDIUM,"Duplicate ASIN shared with: millet, farro, teff seeds, wheat germ","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"barley (cooked, minimal)","Bob's Red Mill Hulled Barley Grain",B00QKP257A,MEDIUM,"Duplicate ASIN shared with: barley (hulled)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20
NEEDS-REVIEW,"barley (hulled)","Bob's Red Mill Hulled Barley Grain",B00QKP257A,MEDIUM,"Duplicate ASIN shared with: barley (cooked, minimal)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20
NEEDS-REVIEW,"millet","Bob's Red Mill Whole Grain Millet",B0FKBVN6XP,MEDIUM,"Duplicate ASIN shared with: sorghum, farro, teff seeds, wheat germ","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"farro","Bob's Red Mill Farro Grain",B0FKBVN6XP,MEDIUM,"Duplicate ASIN shared with: sorghum, millet, teff seeds, wheat germ","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"amaranth (tiny amounts)","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,MEDIUM,"Duplicate ASIN shared with: amaranth seeds","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"amaranth seeds","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,MEDIUM,"Duplicate ASIN shared with: amaranth (tiny amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"teff seeds","Bob's Red Mill Whole Grain Teff Seeds",B0FKBVN6XP,MEDIUM,"Duplicate ASIN shared with: sorghum, millet, farro, wheat germ","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"safflower seeds","Wagner's Pure Safflower Seed Bird Food",B0FWLFGG21,MEDIUM,"Duplicate ASIN shared with: wild bird mix","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"bok choi","Fresh Baby Bok Choy",B0FN4YGSK6,MEDIUM,"Duplicate ASIN shared with: bok choy (small amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20
NEEDS-REVIEW,"bok choy (small amounts)","Fresh Baby Bok Choy",B0FN4YGSK6,MEDIUM,"Duplicate ASIN shared with: bok choi","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20
NEEDS-REVIEW,"kidney beans (mashed)","Goya Canned Dark Red Kidney Beans Low Sodium",B00552005I,MEDIUM,"Duplicate ASIN shared with: kidney beans (mashed, tiny amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20
NEEDS-REVIEW,"kidney beans (mashed, tiny amounts)","Goya Canned Dark Red Kidney Beans Low Sodium",B00552005I,MEDIUM,"Duplicate ASIN shared with: kidney beans (mashed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20
NEEDS-REVIEW,"swiss chard","Fresh Swiss Chard",B07F12P248,MEDIUM,"Duplicate ASIN shared with: swiss chard (cooked, tiny amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20
NEEDS-REVIEW,"swiss chard (cooked, tiny amounts)","Fresh Swiss Chard",B07F12P248,MEDIUM,"Duplicate ASIN shared with: swiss chard","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20
NEEDS-REVIEW,"mulberries","Terrasoul Dried Mulberries Organic",B074153BXC,MEDIUM,"Duplicate ASIN shared with: cranberries","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"cranberries","NOW Foods Dried Cranberries Unsweetened",B074153BXC,MEDIUM,"Duplicate ASIN shared with: mulberries","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"small dubia roaches","Small Live Dubia Roaches Feeder",B09QD6PBB8,MEDIUM,"Duplicate ASIN shared with: dubia roaches","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20
NEEDS-REVIEW,"bluegrass hay","Small Pet Select Bluegrass Hay",B00S6Y8MHU,MEDIUM,"Duplicate ASIN shared with: orchard grass hay","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"wild bird mix","Lyric Wild Bird Mix No Filler",B0FWLFGG21,MEDIUM,"Duplicate ASIN shared with: safflower seeds","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"bone broth (low sodium)","Brutus Bone Broth for Dogs Low Sodium",B07DFNP37Y,MEDIUM,"Duplicate ASIN shared with: chicken broth","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20
NEEDS-REVIEW,"chicory root","NOW Supplements Inulin Prebiotic Fiber",B08Q7KZYKC,MEDIUM,"Duplicate ASIN shared with: fructooligosaccharides (fos), inulin (prebiotic)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
NEEDS-REVIEW,"chondroitin sulfate","Cosequin DS Plus MSM with Chondroitin",B003ULL1NQ,MEDIUM,"Duplicate ASIN shared with: joint supplement, glucosamine sulfate, joint health supplement","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
NEEDS-REVIEW,"eggshells (crushed)","NOW Supplements Calcium Carbonate Powder",B004421K68,MEDIUM,"Duplicate ASIN shared with: calcium carbonate","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20
NEEDS-REVIEW,"fish broth (no salt)","Brutus Fish Broth for Dogs No Salt",B07DFQFLJL,MEDIUM,"Duplicate ASIN shared with: turkey broth (no salt)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20
NEEDS-REVIEW,"fructooligosaccharides (fos)","NOW Supplements FOS Prebiotic Fiber",B08Q7KZYKC,MEDIUM,"Duplicate ASIN shared with: chicory root, inulin (prebiotic)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
NEEDS-REVIEW,"glucosamine sulfate","Cosequin DS Plus MSM Glucosamine",B003ULL1NQ,MEDIUM,"Duplicate ASIN shared with: joint supplement, chondroitin sulfate, joint health supplement","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
NEEDS-REVIEW,"green beans","Fresh Organic Green Beans",B0DDTC6QNY,MEDIUM,"Duplicate ASIN shared with: green beans (cooked)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20
NEEDS-REVIEW,"green beans (cooked)","Fresh Organic Green Beans",B0DDTC6QNY,MEDIUM,"Duplicate ASIN shared with: green beans","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20
NEEDS-REVIEW,"hairball control paste","Tomlyn Laxatone Hairball Remedy",B07B282MR4,MEDIUM,"Duplicate ASIN shared with: hairball paste","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20
NEEDS-REVIEW,"inulin (prebiotic)","NOW Supplements Inulin Prebiotic Fiber",B08Q7KZYKC,MEDIUM,"Duplicate ASIN shared with: chicory root, fructooligosaccharides (fos)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20
NEEDS-REVIEW,"joint health supplement","Cosequin DS Plus MSM for Dogs",B003ULL1NQ,MEDIUM,"Duplicate ASIN shared with: joint supplement, chondroitin sulfate, glucosamine sulfate","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20
NEEDS-REVIEW,"peas","Fresh Organic Green Peas",B07D1NGQ6B,MEDIUM,"Duplicate ASIN shared with: peas (mashed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20
NEEDS-REVIEW,"peas (mashed)","Fresh Organic Green Peas",B07D1NGQ6B,MEDIUM,"Duplicate ASIN shared with: peas","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20
NEEDS-REVIEW,"rice (hulled)","Lundberg Organic Brown Rice",B072JNNB33,MEDIUM,"WARNING: Only 50% of required tokens present","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20
NEEDS-REVIEW,"sardines (in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,MEDIUM,"WARNING: No acceptable form found. Expected one of: canned, water packed","‚ö†Ô∏è Ambiguous - manual review needed",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"split peas","Bob's Red Mill Split Peas",B08DVGSW58,MEDIUM,"Duplicate ASIN shared with: split peas (mashed), sugar snap peas, sugar snap peas (mashed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
NEEDS-REVIEW,"split peas (mashed)","Bob's Red Mill Split Peas",B08DVGSW58,MEDIUM,"Duplicate ASIN shared with: split peas, sugar snap peas, sugar snap peas (mashed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
NEEDS-REVIEW,"sugar snap peas","Fresh Organic Sugar Snap Peas",B08DVGSW58,MEDIUM,"Duplicate ASIN shared with: split peas, split peas (mashed), sugar snap peas (mashed)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
NEEDS-REVIEW,"sugar snap peas (mashed)","Fresh Organic Sugar Snap Peas",B08DVGSW58,MEDIUM,"Duplicate ASIN shared with: split peas, split peas (mashed), sugar snap peas","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20
NEEDS-REVIEW,"turkey broth (no salt)","Brutus Turkey Broth for Dogs No Salt",B07DFQFLJL,MEDIUM,"Duplicate ASIN shared with: fish broth (no salt)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20
NEEDS-REVIEW,"vitamin b complex","Thorne B-Complex #12",B01INRFW0E,MEDIUM,"Duplicate ASIN shared with: b-complex","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20
NEEDS-REVIEW,"watercress","Fresh Organic Watercress",B0BSK8P8KS,MEDIUM,"Duplicate ASIN shared with: watercress (small amounts)","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20
NEEDS-REVIEW,"watercress (small amounts)","Fresh Organic Watercress",B0BSK8P8KS,MEDIUM,"Duplicate ASIN shared with: watercress","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20
NEEDS-REVIEW,"wheat germ","Bob's Red Mill Wheat Germ",B0FKBVN6XP,MEDIUM,"Duplicate ASIN shared with: sorghum, millet, farro, teff seeds","‚ö†Ô∏è Duplicate ASIN - verify if appropriate",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
</file>

<file path="data/csv/PHASE_1_5_MANUAL_REVIEW.csv">
Status,Ingredient,Product Name,ASIN,Confidence,Alias Group,Issues,Notes,Action Needed,Link
NEEDS-REVIEW,"ground chicken","Fresh Is Best Freeze Dried Chicken Breast",B0BXZVFN6G,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
NEEDS-REVIEW,"ground beef (lean)","US Wellness Meats Pet Burger",B07VHR2WNZ,LOW,,"CONFLICT: Conflict detected: venison and beef are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"ground lamb","Raw Paws Lamb Recipe Rolls",B0082C00P8,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"chicken hearts","Vital Essentials Freeze Dried Chicken Hearts",B0BXZ3JJL9,LOW,,"CONFLICT: Conflict detected: turkey and chicken are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"sardines (canned in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"turkey giblets","Vital Essentials Freeze Dried Turkey Giblets",B0BXZ3JJL9,LOW,,"CONFLICT: Conflict detected: turkey and chicken are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"chicken giblets","Fresh Is Best Freeze Dried Chicken Giblets",B0BXZVFN6G,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
NEEDS-REVIEW,"venison","Fresh Is Best Freeze Dried Venison Bites",B07VHR2WNZ,LOW,,"CONFLICT: Conflict detected: venison and beef are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"rabbit meat","Evanger's Rabbit Grain Free Cans",B0082C00P8,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"kale","Earthbound Farm Organic Kale",B09VKDGT39,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
NEEDS-REVIEW,"celery","Earthbound Farm Organic Celery",B09VKDGT39,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
AUTO-INVALID,"endive","Organic Endive Greens",B0006L2XNK,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20
NEEDS-REVIEW,"fish oil","Nordic Naturals Omega-3 Pet",B00CBY93XS,LOW,fish_oil_xbd1qd,"SEMANTIC: Missing 2 required token(s): fish, oil","‚ö†Ô∏è Ambiguous (alias group: fish_oil_xbd1qd)",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"canary seed","Lafeber's Parrot Food Canary Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"niger seed","Lafeber's Parrot Food Niger Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"oat groats","Lafeber's Parrot Food Oat Groats",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"hemp seeds","Lafeber's Parrot Food Hemp Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"flaxseeds","Lafeber's Parrot Food Flax Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"sesame seeds","Lafeber's Parrot Food Sesame Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"chia seeds","Lafeber's Parrot Food Chia Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"rapeseed","Lafeber's Parrot Food Rapeseed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"sunflower seeds (small amounts)","Lafeber's Parrot Food Sunflower Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"pumpkin seeds","Lafeber's Parrot Food Pumpkin Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"mango","Organic Mango",B00WM6CHFQ,LOW,,"CONFLICT: Conflict detected: mango and chia are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
NEEDS-REVIEW,"egg (hard-boiled)","Vital Essentials Freeze Dried Egg Yolk Treats",B0BWBNT8JX,LOW,,"CONFLICT: Conflict detected: egg and duck are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"pellets (fortified)","Lafeber's Parrot Food Pellets",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"cuttlebone","Lafeber's Parrot Food Cuttlebone",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"orchard grass hay","Oxbow Animal Health Orchard Grass Hay",B00S6Y8MHU,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"duck hearts","Vital Essentials Freeze Dried Duck Hearts",B0BWBNT8JX,LOW,,"CONFLICT: Conflict detected: egg and duck are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"herring (canned)","Crown Prince Canned Herring",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"black currant oil","NOW Foods Black Currant Seed Oil",B01FXEM0BY,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"chia seed oil","Healthworks Organic Chia Seed Oil",B00WM6CHFQ,LOW,,"CONFLICT: Conflict detected: mango and chia are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
NEEDS-REVIEW,"herring oil","Nordic Naturals Pet Herring Oil",B00CBY93XS,LOW,fish_oil_xbd1qd,"SEMANTIC: Missing 2 required token(s): fish, oil","‚ö†Ô∏è Ambiguous (alias group: fish_oil_xbd1qd)",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"borage oil","NOW Foods Borage Oil Softgels",B01FXEM0BY,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"sorghum","Bob's Red Mill Whole Grain Sorghum",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"millet","Bob's Red Mill Whole Grain Millet",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"farro","Bob's Red Mill Farro Grain",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"amaranth (tiny amounts)","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"amaranth seeds","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"teff seeds","Bob's Red Mill Whole Grain Teff Seeds",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"safflower seeds","Wagner's Pure Safflower Seed Bird Food",B0FWLFGG21,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"mulberries","Terrasoul Dried Mulberries Organic",B074153BXC,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"cranberries","NOW Foods Dried Cranberries Unsweetened",B074153BXC,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"bluegrass hay","Small Pet Select Bluegrass Hay",B00S6Y8MHU,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"wild bird mix","Lyric Wild Bird Mix No Filler",B0FWLFGG21,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"sardines (in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"wheat germ","Bob's Red Mill Wheat Germ",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
</file>

<file path="data/price-rankings.csv">
rank,ingredient,amount_usd,asin,url,lastUpdated
1,joint supplement,36.97,B003ULL1NQ,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20,2025-12-12T20:51:42.585Z
2,chondroitin sulfate,36.97,B003ULL1NQ,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20,2025-12-12T21:05:53.676Z
3,glucosamine sulfate,36.97,B003ULL1NQ,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20,2025-12-12T21:06:36.710Z
4,joint health supplement,36.97,B003ULL1NQ,https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20,2025-12-12T21:07:09.362Z
5,bermuda hay,36.80,B0FSVM5P3D,https://www.amazon.com/dp/B0FSVM5P3D?tag=robinfrench-20,2025-12-12T21:05:00.772Z
6,plums (pitted),35.99,B07P6Z8L76,https://www.amazon.com/dp/B07P6Z8L76?tag=robinfrench-20,2025-12-12T21:03:22.560Z
7,mackerel (canned),35.52,B017J9X8IA,https://www.amazon.com/dp/B017J9X8IA?tag=robinfrench-20,2025-12-12T20:56:09.986Z
8,orchard grass hay,34.99,B00S6Y8MHU,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20,2025-12-12T20:55:03.558Z
9,anchovy oil,34.99,B0FDNB2DVS,https://www.amazon.com/dp/B0FDNB2DVS?tag=robinfrench-20,2025-12-12T20:57:06.500Z
10,"barley (cooked, minimal)",34.99,B00QKP257A,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20,2025-12-12T20:59:06.108Z
11,barley (hulled),34.99,B00QKP257A,https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20,2025-12-12T20:59:10.692Z
12,bluegrass hay,34.99,B00S6Y8MHU,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20,2025-12-12T21:04:46.822Z
13,mackerel oil,34.95,B01NBTJFJB,https://www.amazon.com/dp/B01NBTJFJB?tag=robinfrench-20,2025-12-12T20:57:16.222Z
14,malabar spinach,34.00,B0DLT7BSNJ,https://www.amazon.com/dp/B0DLT7BSNJ?tag=robinfrench-20,2025-12-12T21:07:23.821Z
15,probiotic powder,33.99,B0BGV8L7L2,https://www.amazon.com/dp/B0BGV8L7L2?tag=robinfrench-20,2025-12-12T20:51:32.894Z
16,algae oil (dha),33.11,B079J5YZSS,https://www.amazon.com/dp/B079J5YZSS?tag=robinfrench-20,2025-12-12T20:57:53.790Z
17,wheat germ oil,30.99,B001GAOHK2,https://www.amazon.com/dp/B001GAOHK2?tag=robinfrench-20,2025-12-12T20:57:44.060Z
18,chicken broth,30.48,B07DFNP37Y,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20,2025-12-12T20:52:02.004Z
19,bone broth (low sodium),30.48,B07DFNP37Y,https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20,2025-12-12T21:05:39.622Z
20,beta-glucans,29.99,B08CXQV9V7,https://www.amazon.com/dp/B08CXQV9V7?tag=robinfrench-20,2025-12-16T03:25:47.431Z
21,black beans,29.99,B094WYT2BK,https://www.amazon.com/dp/B094WYT2BK?tag=robinfrench-20,2025-12-12T20:49:07.346Z
22,omega-3 capsules,29.99,B004OA5XP4,https://www.amazon.com/dp/B004OA5XP4?tag=robinfrench-20,2025-12-16T03:25:47.431Z
23,joint health powder,29.99,B0002APQY2,https://www.amazon.com/dp/B0002APQY2?tag=robinfrench-20,2025-12-16T03:25:47.431Z
24,fescue hay,29.99,B00S6YIF36,https://www.amazon.com/dp/B00S6YIF36?tag=robinfrench-20,2025-12-12T21:04:37.376Z
25,straw (wheat/pine),29.99,B0CDQMD1CB,https://www.amazon.com/dp/B0CDQMD1CB?tag=robinfrench-20,2025-12-12T21:04:51.497Z
26,s-adenosyl methionine (sam-e),29.99,B0002APQVQ,https://www.amazon.com/dp/B0002APQVQ?tag=robinfrench-20,2025-12-16T03:25:47.431Z
27,sardine oil,29.97,B0CXKHT5K2,https://www.amazon.com/dp/B0CXKHT5K2?tag=robinfrench-20,2025-12-12T20:57:20.966Z
28,black soldier fly larvae,29.95,B0BLZ88Q3R,https://www.amazon.com/dp/B0BLZ88Q3R?tag=robinfrench-20,2025-12-12T20:54:35.539Z
29,chicory root,29.95,B08Q7KZYKC,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20,2025-12-12T21:05:48.888Z
30,fructooligosaccharides (fos),29.95,B08Q7KZYKC,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20,2025-12-12T21:06:32.045Z
31,inulin (prebiotic),29.95,B08Q7KZYKC,https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20,2025-12-12T21:07:00.337Z
32,digestive enzymes,29.92,B00O6FINFO,https://www.amazon.com/dp/B00O6FINFO?tag=robinfrench-20,2025-12-12T20:51:52.322Z
33,spirulina powder,29.89,B08S4982CC,https://www.amazon.com/dp/B08S4982CC?tag=robinfrench-20,2025-12-12T20:58:22.564Z
34,butterworms,28.99,B093BD8NXR,https://www.amazon.com/dp/B093BD8NXR?tag=robinfrench-20,2025-12-12T21:04:08.665Z
35,alfalfa hay,28.93,B0CM34Z4BQ,https://www.amazon.com/dp/B0CM34Z4BQ?tag=robinfrench-20,2025-12-12T20:55:08.164Z
36,corn (cracked),27.99,B01HHGD81C,https://www.amazon.com/dp/B01HHGD81C?tag=robinfrench-20,2025-12-12T21:00:03.238Z
37,figs,27.80,B08MDKF98D,https://www.amazon.com/dp/B08MDKF98D?tag=robinfrench-20,2025-12-12T20:54:49.396Z
38,curcumin (turmeric extract),26.99,B0CK3C31JP,https://www.amazon.com/dp/B0CK3C31JP?tag=robinfrench-20,2025-12-12T21:06:03.526Z
39,superworms,25.99,B01018SX5Y,https://www.amazon.com/dp/B01018SX5Y?tag=robinfrench-20,2025-12-12T20:54:30.992Z
40,green beans,25.56,B0DDTC6QNY,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20,2025-12-12T21:06:41.437Z
41,green beans (cooked),25.56,B0DDTC6QNY,https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20,2025-12-12T21:06:46.007Z
42,flaxseed oil,25.19,B002VLZ830,https://www.amazon.com/dp/B002VLZ830?tag=robinfrench-20,2025-12-12T20:51:03.516Z
43,chicken hearts,24.99,B0BXZ3JJL9,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20,2025-12-16T03:25:47.431Z
44,turkey giblets,24.99,B0BXZ3JJL9,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20,2025-12-16T03:25:47.431Z
45,duck breast,24.99,B0BXZ3JJL9,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20,2025-12-16T03:25:47.431Z
46,duck liver,24.99,B0BXZ3JJL9,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20,2025-12-16T03:25:47.431Z
47,buckwheat (hulled),24.99,B0D15QDVW7,https://www.amazon.com/dp/B0D15QDVW7?tag=robinfrench-20,2025-12-12T20:58:51.848Z
48,pinhead crickets,24.99,B07196FX9W,https://www.amazon.com/dp/B07196FX9W?tag=robinfrench-20,2025-12-12T21:03:59.322Z
49,ground chicken,23.99,B0BXZVFN6G,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20,2025-12-12T20:46:50.423Z
50,chicken giblets,23.99,B0BXZVFN6G,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20,2025-12-12T20:47:56.190Z
51,hairball paste,23.99,B07B282MR4,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20,2025-12-12T20:51:57.071Z
52,hairball control paste,23.99,B07B282MR4,https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20,2025-12-12T21:06:50.872Z
53,black currant oil,23.95,B01FXEM0BY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20,2025-12-12T20:56:42.792Z
54,borage oil,23.95,B01FXEM0BY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20,2025-12-12T20:57:25.485Z
55,purslane (small amounts),23.95,B0BWY8JWVL,https://www.amazon.com/dp/B0BWY8JWVL?tag=robinfrench-20,2025-12-12T21:00:49.880Z
56,coconut oil,23.45,B00UHCJKVG,https://www.amazon.com/dp/B00UHCJKVG?tag=robinfrench-20,2025-12-12T20:50:48.628Z
57,pinto beans (mashed),23.32,B0C4G2PR58,https://www.amazon.com/dp/B0C4G2PR58?tag=robinfrench-20,2025-12-12T21:00:40.288Z
58,ground lamb,22.99,B0082C00P8,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
59,chicken necks,22.99,B0821PF71M,https://www.amazon.com/dp/B0821PF71M?tag=robinfrench-20,2025-12-12T20:55:41.686Z
60,jerusalem artichoke,22.99,B0CQK5XCVZ,https://www.amazon.com/dp/B0CQK5XCVZ?tag=robinfrench-20,2025-12-12T21:07:04.838Z
61,salmon oil,21.99,B01N9SSTG8,https://www.amazon.com/dp/B01N9SSTG8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
62,fish oil,21.99,B01N9SSTG8,https://www.amazon.com/dp/B01N9SSTG8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
63,herring oil,21.99,B01N9SSTG8,https://www.amazon.com/dp/B01N9SSTG8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
64,krill oil,21.99,B01N9SSTG8,https://www.amazon.com/dp/B01N9SSTG8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
65,omega-3 oil,21.99,B01N9SSTG8,https://www.amazon.com/dp/B01N9SSTG8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
66,cat grass (wheatgrass),21.99,B0D45F9TGG,https://www.amazon.com/dp/B0D45F9TGG?tag=robinfrench-20,2025-12-12T21:02:30.763Z
67,quail,21.98,B0DK1SJ2Z7,https://www.amazon.com/dp/B0DK1SJ2Z7?tag=robinfrench-20,2025-12-12T20:48:14.932Z
68,pumpkin seed oil,21.98,B0FKYLMWYG,https://www.amazon.com/dp/B0FKYLMWYG?tag=robinfrench-20,2025-12-12T21:08:07.591Z
69,rabbit pellets (high fiber),21.67,B0017JANQY,https://www.amazon.com/dp/B0017JANQY?tag=robinfrench-20,2025-12-12T21:05:15.479Z
70,dandelion greens,21.11,B000WR4A5M,https://www.amazon.com/dp/B000WR4A5M?tag=robinfrench-20,2025-12-12T20:50:21.350Z
71,buckwheat,21.00,B00KQ17MDG,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20,2025-12-12T20:58:42.291Z
72,buckwheat (tiny amounts),21.00,B00KQ17MDG,https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20,2025-12-12T20:58:47.053Z
73,split peas,20.99,B08DVGSW58,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20,2025-12-12T21:08:54.184Z
74,split peas (mashed),20.99,B08DVGSW58,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20,2025-12-12T21:08:58.721Z
75,sugar snap peas,20.99,B08DVGSW58,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20,2025-12-12T21:09:03.193Z
76,sugar snap peas (mashed),20.99,B08DVGSW58,https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20,2025-12-12T21:09:07.623Z
77,cilantro,20.49,B07M9FWTRC,https://www.amazon.com/dp/B07M9FWTRC?tag=robinfrench-20,2025-12-12T20:55:17.766Z
78,oats (rolled),20.44,B07VCM66N6,https://www.amazon.com/dp/B07VCM66N6?tag=robinfrench-20,2025-12-12T21:07:48.631Z
79,bulgur,20.42,B081DQ5NG5,https://www.amazon.com/dp/B081DQ5NG5?tag=robinfrench-20,2025-12-12T20:59:29.455Z
80,silkworms,20.34,B08JKNZPSF,https://www.amazon.com/dp/B08JKNZPSF?tag=robinfrench-20,2025-12-12T21:04:22.952Z
81,ground pork (lean),19.99,B0CLJW1P6D,https://www.amazon.com/dp/B0CLJW1P6D?tag=robinfrench-20,2025-12-12T20:48:19.692Z
82,amino acid supplement,19.99,B0C2JFLZHF,https://www.amazon.com/dp/B0C2JFLZHF?tag=robinfrench-20,2025-12-12T20:58:12.855Z
83,frisee,19.99,B07FZGKZL4,https://www.amazon.com/dp/B07FZGKZL4?tag=robinfrench-20,2025-12-12T21:01:44.839Z
84,wheat hay,19.99,B0CLC76V98,https://www.amazon.com/dp/B0CLC76V98?tag=robinfrench-20,2025-12-12T21:04:32.581Z
85,d-mannose,19.99,B07FC4ZY34,https://www.amazon.com/dp/B07FC4ZY34?tag=robinfrench-20,2025-12-16T03:25:47.431Z
86,peas,19.99,B07D1NGQ6B,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20,2025-12-12T21:07:53.364Z
87,peas (mashed),19.99,B07D1NGQ6B,https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20,2025-12-12T21:07:57.848Z
88,quercetin,19.99,B0742YS3TG,https://www.amazon.com/dp/B0742YS3TG?tag=robinfrench-20,2025-12-16T03:25:47.431Z
89,romanesco broccoli,19.99,B01I1Q74MQ,https://www.amazon.com/dp/B01I1Q74MQ?tag=robinfrench-20,2025-12-12T21:08:26.110Z
90,l-carnitine powder,19.95,B06Y1BTLGK,https://www.amazon.com/dp/B06Y1BTLGK?tag=robinfrench-20,2025-12-12T21:07:14.304Z
91,barley,19.92,B0D481997Z,https://www.amazon.com/dp/B0D481997Z?tag=robinfrench-20,2025-12-12T20:59:01.320Z
92,dubia roaches,19.90,B09QD6PBB8,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20,2025-12-12T20:54:16.800Z
93,small dubia roaches,19.90,B09QD6PBB8,https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20,2025-12-12T21:04:18.331Z
94,wild rice,19.50,B089CP461X,https://www.amazon.com/dp/B089CP461X?tag=robinfrench-20,2025-12-12T21:09:40.679Z
95,amaranth leaves,18.99,B0F2YRBGS6,https://www.amazon.com/dp/B0F2YRBGS6?tag=robinfrench-20,2025-12-12T21:02:44.545Z
96,barley hay,18.99,B07ZYNJ123,https://www.amazon.com/dp/B07ZYNJ123?tag=robinfrench-20,2025-12-16T03:25:47.431Z
97,hyaluronic acid,18.99,B07XHNCJMC,https://www.amazon.com/dp/B07XHNCJMC?tag=robinfrench-20,2025-12-12T21:06:55.692Z
98,vitamin e,18.95,B01I5OB3LW,https://www.amazon.com/dp/B01I5OB3LW?tag=robinfrench-20,2025-12-12T20:51:23.124Z
99,quail eggs,18.95,B0BSRGV9PR,https://www.amazon.com/dp/B0BSRGV9PR?tag=robinfrench-20,2025-12-12T21:08:12.122Z
100,almond oil,18.46,B0BXMMDNJ8,https://www.amazon.com/dp/B0BXMMDNJ8?tag=robinfrench-20,2025-12-12T20:56:47.604Z
101,miner's lettuce,18.39,B0D3J7FZFD,https://www.amazon.com/dp/B0D3J7FZFD?tag=robinfrench-20,2025-12-12T21:00:54.713Z
102,earthworms,17.99,B097PDMK47,https://www.amazon.com/dp/B097PDMK47?tag=robinfrench-20,2025-12-12T21:04:27.764Z
103,psyllium husk,17.97,B0016AXN7A,https://www.amazon.com/dp/B0016AXN7A?tag=robinfrench-20,2025-12-12T20:51:37.725Z
104,evening primrose oil,17.95,B07FPBQ31W,https://www.amazon.com/dp/B07FPBQ31W?tag=robinfrench-20,2025-12-12T20:57:11.379Z
105,vitamin c (small amounts),17.95,B074GCB1ND,https://www.amazon.com/dp/B074GCB1ND?tag=robinfrench-20,2025-12-12T21:09:22.054Z
106,honey (tiny amounts),17.48,B0791X9GSG,https://www.amazon.com/dp/B0791X9GSG?tag=robinfrench-20,2025-12-12T20:54:07.362Z
107,mannanoligosaccharides (mos),17.40,B0CRFWM2Z6,https://www.amazon.com/dp/B0CRFWM2Z6?tag=robinfrench-20,2025-12-12T21:07:28.938Z
108,salmon (boneless),16.99,B08NCDSV82,https://www.amazon.com/dp/B08NCDSV82?tag=robinfrench-20,2025-12-12T20:47:08.804Z
109,broccoli,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
110,kale,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
111,celery,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
112,endive,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
113,escarole,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
114,collard greens,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
115,beet greens,16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
116,canary seed,16.99,B001ODB3YE,https://www.amazon.com/dp/B001ODB3YE?tag=robinfrench-20,2025-12-16T03:25:47.431Z
117,niger seed,16.99,B001ODB3YE,https://www.amazon.com/dp/B001ODB3YE?tag=robinfrench-20,2025-12-16T03:25:47.431Z
118,rapeseed,16.99,B001ODB3YE,https://www.amazon.com/dp/B001ODB3YE?tag=robinfrench-20,2025-12-16T03:25:47.431Z
119,pellets (fortified),16.99,B0002ARAFI,https://www.amazon.com/dp/B0002ARAFI?tag=robinfrench-20,2025-12-16T03:25:47.431Z
120,meadow hay,16.99,B001ODB40G,https://www.amazon.com/dp/B001ODB40G?tag=robinfrench-20,2025-12-16T03:25:47.431Z
121,ground duck,16.99,B0BY3CNR3Q,https://www.amazon.com/dp/B0BY3CNR3Q?tag=robinfrench-20,2025-12-12T20:55:51.155Z
122,mulberries,16.99,B074153BXC,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20,2025-12-12T21:03:36.579Z
123,cranberries,16.99,B074153BXC,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20,2025-12-12T21:03:45.886Z
124,wild bird mix,16.99,B001ODB3YE,https://www.amazon.com/dp/B001ODB3YE?tag=robinfrench-20,2025-12-16T03:25:47.431Z
125,snow peas (mashed),16.99,B07MGZKB9V,https://www.amazon.com/dp/B07MGZKB9V?tag=robinfrench-20,2025-12-16T03:25:47.431Z
126,turmeric,16.95,B018GPDCV4,https://www.amazon.com/dp/B018GPDCV4?tag=robinfrench-20,2025-12-12T21:02:54.163Z
127,fish broth (no salt),16.65,B07DFQFLJL,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20,2025-12-12T21:06:27.442Z
128,turkey broth (no salt),16.65,B07DFQFLJL,https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20,2025-12-12T21:09:12.294Z
129,timothy hay,16.49,B006AYMMRY,https://www.amazon.com/dp/B006AYMMRY?tag=robinfrench-20,2025-12-12T20:54:54.261Z
130,millet (tiny amounts),16.32,B07XPCWYP2,https://www.amazon.com/dp/B07XPCWYP2?tag=robinfrench-20,2025-12-12T20:59:20.051Z
131,chicken liver,16.29,B07S8JCNTH,https://www.amazon.com/dp/B07S8JCNTH?tag=robinfrench-20,2025-12-12T20:47:32.285Z
132,hornworms,15.99,B09Y4RTNK9,https://www.amazon.com/dp/B09Y4RTNK9?tag=robinfrench-20,2025-12-12T20:54:40.038Z
133,ground mackerel,15.99,B079Z4MZTG,https://www.amazon.com/dp/B079Z4MZTG?tag=robinfrench-20,2025-12-12T20:56:05.291Z
134,lamb liver,15.95,B0015G862M,https://www.amazon.com/dp/B0015G862M?tag=robinfrench-20,2025-12-12T20:55:31.989Z
135,rosemary,15.75,B004JWLMNY,https://www.amazon.com/dp/B004JWLMNY?tag=robinfrench-20,2025-12-12T21:02:59.048Z
136,chickpeas,15.68,B0BYPF1Y79,https://www.amazon.com/dp/B0BYPF1Y79?tag=robinfrench-20,2025-12-12T20:49:02.539Z
137,nyjer seeds,15.61,B0D6688V7C,https://www.amazon.com/dp/B0D6688V7C?tag=robinfrench-20,2025-12-12T21:00:12.678Z
138,beef liver,14.99,B07G3QFG8N,https://www.amazon.com/dp/B07G3QFG8N?tag=robinfrench-20,2025-12-12T20:47:27.552Z
139,hemp seeds,14.99,B01N7GJVNH,https://www.amazon.com/dp/B01N7GJVNH?tag=robinfrench-20,2025-12-16T03:25:47.431Z
140,"peanut butter (unsalted, tiny amounts)",14.99,B06ZXZ3JPZ,https://www.amazon.com/dp/B06ZXZ3JPZ?tag=robinfrench-20,2025-12-12T20:54:11.988Z
141,mealworms,14.99,B07TKDYMMP,https://www.amazon.com/dp/B07TKDYMMP?tag=robinfrench-20,2025-12-12T20:54:26.431Z
142,electrolyte powder,14.99,B07X6LNK99,https://www.amazon.com/dp/B07X6LNK99?tag=robinfrench-20,2025-12-16T03:25:47.431Z
143,b-complex,14.95,B01INRFW0E,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20,2025-12-12T20:51:28.041Z
144,biotin,14.95,B01AMJCHB8,https://www.amazon.com/dp/B01AMJCHB8?tag=robinfrench-20,2025-12-12T21:05:34.707Z
145,cranberry extract,14.95,B01N7KMPU3,https://www.amazon.com/dp/B01N7KMPU3?tag=robinfrench-20,2025-12-12T21:05:58.616Z
146,vitamin b complex,14.95,B01INRFW0E,https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20,2025-12-12T21:09:17.134Z
147,oat bran (small amounts),14.74,B07CC9RF6Y,https://www.amazon.com/dp/B07CC9RF6Y?tag=robinfrench-20,2025-12-12T20:59:53.569Z
148,vitamin d3 drops,14.45,B0062QD5LM,https://www.amazon.com/dp/B0062QD5LM?tag=robinfrench-20,2025-12-12T20:58:32.356Z
149,sorghum,14.33,B0FKBVN6XP,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20,2025-12-12T20:58:56.471Z
150,millet,14.33,B0FKBVN6XP,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20,2025-12-12T20:59:15.280Z
151,farro,14.33,B0FKBVN6XP,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20,2025-12-12T20:59:24.562Z
152,teff seeds,14.33,B0FKBVN6XP,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20,2025-12-12T20:59:43.761Z
153,wheat germ,14.33,B0FKBVN6XP,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20,2025-12-12T21:09:35.709Z
154,turkey breast,13.99,B0CZRN7HXT,https://www.amazon.com/dp/B0CZRN7HXT?tag=robinfrench-20,2025-12-12T20:47:22.762Z
155,safflower seeds,13.99,B001ODB3YE,https://www.amazon.com/dp/B001ODB3YE?tag=robinfrench-20,2025-12-16T03:25:47.431Z
156,alfalfa sprouts (small amounts),13.99,B0DFZTWLTY,https://www.amazon.com/dp/B0DFZTWLTY?tag=robinfrench-20,2025-12-12T21:02:25.940Z
157,lysine powder,13.99,B00V3MR88G,https://www.amazon.com/dp/B00V3MR88G?tag=robinfrench-20,2025-12-12T21:07:19.324Z
158,lentils,13.49,B000VDZ2GI,https://www.amazon.com/dp/B000VDZ2GI?tag=robinfrench-20,2025-12-12T20:48:57.775Z
159,kelp powder,13.29,B0002JG1GG,https://www.amazon.com/dp/B0002JG1GG?tag=robinfrench-20,2025-12-12T20:58:03.385Z
160,sweet potato,12.99,B07YNQ6T9Z,https://www.amazon.com/dp/B07YNQ6T9Z?tag=robinfrench-20,2025-12-16T03:25:47.431Z
161,olive oil,12.99,B00GGBLPVU,https://www.amazon.com/dp/B00GGBLPVU?tag=robinfrench-20,2025-12-16T03:25:47.431Z
162,avocado oil,12.99,B00KN93TJU,https://www.amazon.com/dp/B00KN93TJU?tag=robinfrench-20,2025-12-16T03:25:47.431Z
163,avocado oil (tiny amounts),12.99,B00KN93TJU,https://www.amazon.com/dp/B00KN93TJU?tag=robinfrench-20,2025-12-16T03:25:47.431Z
164,guinea pig pellets (with vitamin c),12.99,B001ODB40U,https://www.amazon.com/dp/B001ODB40U?tag=robinfrench-20,2025-12-16T03:25:47.431Z
165,taurine powder,12.95,B00VAOKFO6,https://www.amazon.com/dp/B00VAOKFO6?tag=robinfrench-20,2025-12-12T20:51:13.306Z
166,niacinamide,12.95,B0CZMBZPLV,https://www.amazon.com/dp/B0CZMBZPLV?tag=robinfrench-20,2025-12-12T21:07:43.676Z
167,quinoa,12.49,B000EDG598,https://www.amazon.com/dp/B000EDG598?tag=robinfrench-20,2025-12-16T03:25:47.431Z
168,quinoa (cooked),12.49,B000EDG598,https://www.amazon.com/dp/B000EDG598?tag=robinfrench-20,2025-12-16T03:25:47.431Z
169,millet (white/red),11.98,B0002DH3FU,https://www.amazon.com/dp/B0002DH3FU?tag=robinfrench-20,2025-12-12T20:52:11.566Z
170,ground lamb (lean),11.49,B088Y2N6WC,https://www.amazon.com/dp/B088Y2N6WC?tag=robinfrench-20,2025-12-12T20:55:55.587Z
171,flaxseed (ground),11.42,B075XC6C69,https://www.amazon.com/dp/B075XC6C69?tag=robinfrench-20,2025-12-12T21:00:59.653Z
172,brewer's yeast,11.12,B084JL2R77,https://www.amazon.com/dp/B084JL2R77?tag=robinfrench-20,2025-12-12T20:58:37.396Z
173,sunflower seeds (small amounts),10.99,B07ZXF9876,https://www.amazon.com/dp/B07ZXF9876?tag=robinfrench-20,2025-12-16T03:25:47.431Z
174,egg yolks,10.99,B00M1QWODW,https://www.amazon.com/dp/B00M1QWODW?tag=robinfrench-20,2025-12-12T21:06:12.913Z
175,sesame oil,10.84,B0797GTG2C,https://www.amazon.com/dp/B0797GTG2C?tag=robinfrench-20,2025-12-12T20:57:30.466Z
176,raisins (unsweetened),10.43,B01GXPRIQY,https://www.amazon.com/dp/B01GXPRIQY?tag=robinfrench-20,2025-12-12T21:03:17.641Z
177,milk thistle,10.40,B0019LVFD0,https://www.amazon.com/dp/B0019LVFD0?tag=robinfrench-20,2025-12-12T21:07:33.821Z
178,rabbit meat,10.00,,,2025-12-16T03:25:47.431Z
179,ground turkey,9.99,B091CCD4T7,https://www.amazon.com/dp/B091CCD4T7?tag=robinfrench-20,2025-12-12T20:46:54.959Z
180,calcium carbonate,9.99,B004421K68,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20,2025-12-12T20:51:18.266Z
181,vitamin e oil,9.99,B0DZ5ZCC85,https://www.amazon.com/dp/B0DZ5ZCC85?tag=robinfrench-20,2025-12-12T20:52:06.746Z
182,chia seeds,9.99,B00JL2X3D4,https://www.amazon.com/dp/B00JL2X3D4?tag=robinfrench-20,2025-12-16T03:25:47.431Z
183,pumpkin seeds,9.99,B00JL2X2KW,https://www.amazon.com/dp/B00JL2X2KW?tag=robinfrench-20,2025-12-16T03:25:47.431Z
184,apples (no seeds),9.99,B00AR0TG44,https://www.amazon.com/dp/B00AR0TG44?tag=robinfrench-20,2025-12-12T20:53:16.660Z
185,"ground pork (lean, small amounts)",9.99,B01H0AI6J4,https://www.amazon.com/dp/B01H0AI6J4?tag=robinfrench-20,2025-12-12T20:56:28.611Z
186,eggshells (crushed),9.99,B004421K68,https://www.amazon.com/dp/B004421K68?tag=robinfrench-20,2025-12-12T21:06:22.464Z
187,pectin (from apples),9.99,B01CO69SYG,https://www.amazon.com/dp/B01CO69SYG?tag=robinfrench-20,2025-12-12T21:08:02.860Z
188,chicken sausage (no additives),9.49,B001JO4O80,https://www.amazon.com/dp/B001JO4O80?tag=robinfrench-20,2025-12-12T20:56:19.480Z
189,flaxseeds,8.99,B00JL2X39O,https://www.amazon.com/dp/B00JL2X39O?tag=robinfrench-20,2025-12-16T03:25:47.431Z
190,sesame seeds,8.99,B07ZYNJ43K,https://www.amazon.com/dp/B07ZYNJ43K?tag=robinfrench-20,2025-12-16T03:25:47.431Z
191,walnut oil,8.99,B00QGWLZ3C,https://www.amazon.com/dp/B00QGWLZ3C?tag=robinfrench-20,2025-12-12T20:56:38.038Z
192,sunflower oil,8.99,B00C11W8YW,https://www.amazon.com/dp/B00C11W8YW?tag=robinfrench-20,2025-12-16T03:25:47.431Z
193,wheat (hulled),8.99,B000YFB5NC,https://www.amazon.com/dp/B000YFB5NC?tag=robinfrench-20,2025-12-12T20:59:48.590Z
194,oat hay,8.99,B000WFKP80,https://www.amazon.com/dp/B000WFKP80?tag=robinfrench-20,2025-12-12T21:04:42.190Z
195,grasshoppers,8.98,B004HSQRG2,https://www.amazon.com/dp/B004HSQRG2?tag=robinfrench-20,2025-12-12T21:04:13.583Z
196,pears (no seeds),8.80,B0DYKVQ3XZ,https://www.amazon.com/dp/B0DYKVQ3XZ?tag=robinfrench-20,2025-12-12T21:03:54.777Z
197,artichokes,8.72,B0DF91JXND,https://www.amazon.com/dp/B0DF91JXND?tag=robinfrench-20,2025-12-12T21:01:40.510Z
198,amaranth (tiny amounts),8.49,B00028QE9C,https://www.amazon.com/dp/B00028QE9C?tag=robinfrench-20,2025-12-16T03:25:47.431Z
199,amaranth seeds,8.49,B00028QE9C,https://www.amazon.com/dp/B00028QE9C?tag=robinfrench-20,2025-12-16T03:25:47.431Z
200,oat groats,7.99,B000EDG52O,https://www.amazon.com/dp/B000EDG52O?tag=robinfrench-20,2025-12-16T03:25:47.431Z
201,strawberries,7.99,B002B8Z98W,https://www.amazon.com/dp/B002B8Z98W?tag=robinfrench-20,2025-12-12T20:53:25.843Z
202,"oatmeal (cooked, small amounts)",7.99,B000EDG52O,https://www.amazon.com/dp/B000EDG52O?tag=robinfrench-20,2025-12-16T03:25:47.431Z
203,calcium supplement,7.12,B0CKNK682W,https://www.amazon.com/dp/B0CKNK682W?tag=robinfrench-20,2025-12-12T20:58:17.738Z
204,chicken thighs,6.99,B0787YFWYB,https://www.amazon.com/dp/B0787YFWYB?tag=robinfrench-20,2025-12-12T20:47:17.992Z
205,turkey necks,6.99,B0FHJ6G2NZ,https://www.amazon.com/dp/B0FHJ6G2NZ?tag=robinfrench-20,2025-12-12T20:48:24.343Z
206,sage,6.99,B00BUSL1SO,https://www.amazon.com/dp/B00BUSL1SO?tag=robinfrench-20,2025-12-16T03:25:47.431Z
207,bok choi,6.99,B0FN4YGSK6,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20,2025-12-12T21:00:17.337Z
208,bok choy (small amounts),6.99,B0FN4YGSK6,https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20,2025-12-12T21:00:21.875Z
209,ginger (small amounts),6.99,B0C6V3416T,https://www.amazon.com/dp/B0C6V3416T?tag=robinfrench-20,2025-12-12T21:02:49.197Z
210,locusts,6.62,B000CMKHBS,https://www.amazon.com/dp/B000CMKHBS?tag=robinfrench-20,2025-12-12T21:04:04.065Z
211,lamb's quarters,6.50,B0DYPHGW89,https://www.amazon.com/dp/B0DYPHGW89?tag=robinfrench-20,2025-12-12T21:02:39.924Z
212,mango,6.46,B00WM6CHFQ,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20,2025-12-12T20:53:30.365Z
213,chia seed oil,6.46,B00WM6CHFQ,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20,2025-12-12T20:56:56.757Z
214,chicken breast,6.22,B0787WTY4C,https://www.amazon.com/dp/B0787WTY4C?tag=robinfrench-20,2025-12-12T20:47:13.402Z
215,egg (hard-boiled),5.99,B0BWBNT8JX,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20,2025-12-12T20:53:53.442Z
216,cuttlebone,5.99,B0002AR0I2,https://www.amazon.com/dp/B0002AR0I2?tag=robinfrench-20,2025-12-16T03:25:47.431Z
217,duck hearts,5.99,B0BWBNT8JX,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20,2025-12-12T20:55:27.056Z
218,ground herring,5.99,B001EO5QRM,https://www.amazon.com/dp/B001EO5QRM?tag=robinfrench-20,2025-12-16T03:25:47.431Z
219,herring (canned),5.99,B001EO5QRM,https://www.amazon.com/dp/B001EO5QRM?tag=robinfrench-20,2025-12-16T03:25:47.431Z
220,purslane,5.99,B09MDXM2YQ,https://www.amazon.com/dp/B09MDXM2YQ?tag=robinfrench-20,2025-12-12T21:00:45.040Z
221,radicchio,5.99,B00BJPTZLA,https://www.amazon.com/dp/B00BJPTZLA?tag=robinfrench-20,2025-12-12T21:01:49.536Z
222,corn (fresh),5.79,B000REL738,https://www.amazon.com/dp/B000REL738?tag=robinfrench-20,2025-12-12T20:53:12.176Z
223,parsley,5.77,B0D8C4N4WY,https://www.amazon.com/dp/B0D8C4N4WY?tag=robinfrench-20,2025-12-12T20:49:53.478Z
224,brussels sprouts,5.49,B004DAQPR0,https://www.amazon.com/dp/B004DAQPR0?tag=robinfrench-20,2025-12-12T20:49:44.082Z
225,white rice,5.48,B00IDQY2PW,https://www.amazon.com/dp/B00IDQY2PW?tag=robinfrench-20,2025-12-12T20:48:33.750Z
226,asparagus,5.37,B07QV5G8HY,https://www.amazon.com/dp/B07QV5G8HY?tag=robinfrench-20,2025-12-12T20:49:48.630Z
227,dried grass,5.29,B0002DK8OI,https://www.amazon.com/dp/B0002DK8OI?tag=robinfrench-20,2025-12-12T21:04:56.470Z
228,blueberries,5.00,,,2025-12-16T03:25:47.431Z
229,turkey thighs,4.99,B00AR100NE,https://www.amazon.com/dp/B00AR100NE?tag=robinfrench-20,2025-12-12T20:55:46.270Z
230,cauliflower,4.99,B000P6G0GM,https://www.amazon.com/dp/B000P6G0GM?tag=robinfrench-20,2025-12-12T21:05:44.196Z
231,spinach,4.98,B0013ABAJG,https://www.amazon.com/dp/B0013ABAJG?tag=robinfrench-20,2025-12-12T20:49:21.085Z
232,turkey sausage (no additives),4.97,B00I2VLI5A,https://www.amazon.com/dp/B00I2VLI5A?tag=robinfrench-20,2025-12-12T20:56:24.001Z
233,yellow squash,4.94,B08QVBFGDC,https://www.amazon.com/dp/B08QVBFGDC?tag=robinfrench-20,2025-12-12T21:01:13.363Z
234,mustard greens,4.79,B094JT2CCH,https://www.amazon.com/dp/B094JT2CCH?tag=robinfrench-20,2025-12-12T20:50:30.265Z
235,sardines (canned in water),4.49,B001EO5QW8,https://www.amazon.com/dp/B001EO5QW8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
236,zucchini,4.49,B07Q9WV1LY,https://www.amazon.com/dp/B07Q9WV1LY?tag=robinfrench-20,2025-12-12T20:49:30.767Z
237,lettuce (romaine),4.49,B0F3YTY4XQ,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20,2025-12-12T20:50:02.405Z
238,romaine lettuce,4.49,B0F3YTY4XQ,https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20,2025-12-12T20:55:12.887Z
239,red leaf lettuce,4.49,B0BX76BG5V,https://www.amazon.com/dp/B0BX76BG5V?tag=robinfrench-20,2025-12-12T21:02:16.673Z
240,hamster pellets (higher protein),4.49,B0053SYJVA,https://www.amazon.com/dp/B0053SYJVA?tag=robinfrench-20,2025-12-12T21:05:20.304Z
241,new zealand spinach,4.49,B0C8VD126M,https://www.amazon.com/dp/B0C8VD126M?tag=robinfrench-20,2025-12-12T21:07:38.722Z
242,sardines (in water),4.49,B001EO5QW8,https://www.amazon.com/dp/B001EO5QW8?tag=robinfrench-20,2025-12-16T03:25:47.431Z
243,mint,4.48,B097F3NT7N,https://www.amazon.com/dp/B097F3NT7N?tag=robinfrench-20,2025-12-12T21:03:08.008Z
244,kiwi,4.48,B01LASWK7G,https://www.amazon.com/dp/B01LASWK7G?tag=robinfrench-20,2025-12-12T21:03:31.814Z
245,turnip greens,4.41,B09HQH6WZT,https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20,2025-12-12T20:50:34.689Z
246,mache,4.39,B00AWLAQFG,https://www.amazon.com/dp/B00AWLAQFG?tag=robinfrench-20,2025-12-12T21:02:21.348Z
247,regular potato,4.15,B09SHBJWBR,https://www.amazon.com/dp/B09SHBJWBR?tag=robinfrench-20,2025-12-12T20:56:33.292Z
248,eggs,4.00,,,2025-12-16T03:25:47.431Z
249,apricots (pitted),4.00,,,2025-12-16T03:25:47.431Z
250,arugula,3.99,B00JXR8RYW,https://www.amazon.com/dp/B00JXR8RYW?tag=robinfrench-20,2025-12-12T20:50:06.919Z
251,crickets,3.99,B000YFGS52,https://www.amazon.com/dp/B000YFGS52?tag=robinfrench-20,2025-12-12T20:54:21.586Z
252,leeks,3.99,B09HQJGQDG,https://www.amazon.com/dp/B09HQJGQDG?tag=robinfrench-20,2025-12-12T21:01:17.884Z
253,shallots,3.99,B09B2ZWHKQ,https://www.amazon.com/dp/B09B2ZWHKQ?tag=robinfrench-20,2025-12-12T21:01:22.358Z
254,"lettuce (romaine, small amounts)",3.99,B074H5J9G2,https://www.amazon.com/dp/B074H5J9G2?tag=robinfrench-20,2025-12-12T21:02:12.166Z
255,snap peas,3.99,B077L6C7YB,https://www.amazon.com/dp/B077L6C7YB?tag=robinfrench-20,2025-12-12T21:08:40.695Z
256,watercress,3.99,B0BSK8P8KS,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20,2025-12-12T21:09:26.582Z
257,watercress (small amounts),3.99,B0BSK8P8KS,https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20,2025-12-12T21:09:31.021Z
258,green cabbage,3.98,B09HQGDCKV,https://www.amazon.com/dp/B09HQGDCKV?tag=robinfrench-20,2025-12-12T21:01:58.558Z
259,napa cabbage,3.96,B07FTVYNM3,https://www.amazon.com/dp/B07FTVYNM3?tag=robinfrench-20,2025-12-12T21:01:31.424Z
260,grapes (chopped),3.50,B000RGYJI6,https://www.amazon.com/dp/B000RGYJI6?tag=robinfrench-20,2025-12-12T20:53:39.458Z
261,pineapple (small amounts),3.49,B000P6L3V4,https://www.amazon.com/dp/B000P6L3V4?tag=robinfrench-20,2025-12-12T21:03:50.298Z
262,tomatoes (small amounts),3.06,B086WX15TH,https://www.amazon.com/dp/B086WX15TH?tag=robinfrench-20,2025-12-12T21:01:26.909Z
263,garlic chives,3.00,B097F3J1PY,https://www.amazon.com/dp/B097F3J1PY?tag=robinfrench-20,2025-12-12T21:03:12.540Z
264,brown rice,2.99,B072JNNB33,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20,2025-12-12T20:48:29.023Z
265,green peas,2.99,B074H4SHTD,https://www.amazon.com/dp/B074H4SHTD?tag=robinfrench-20,2025-12-12T20:49:11.915Z
266,carrots,2.99,B074H64BPW,https://www.amazon.com/dp/B074H64BPW?tag=robinfrench-20,2025-12-12T20:49:16.499Z
267,fennel,2.99,B00E3J6RC4,https://www.amazon.com/dp/B00E3J6RC4?tag=robinfrench-20,2025-12-12T21:01:04.302Z
268,swiss chard,2.99,B07F12P248,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20,2025-12-12T21:02:03.086Z
269,"swiss chard (cooked, tiny amounts)",2.99,B07F12P248,https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20,2025-12-12T21:02:07.730Z
270,eggplant,2.99,B001PLGQPQ,https://www.amazon.com/dp/B001PLGQPQ?tag=robinfrench-20,2025-12-12T21:06:17.448Z
271,rice (hulled),2.99,B072JNNB33,https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20,2025-12-12T21:08:21.670Z
272,raspberries,2.59,B000P6G12U,https://www.amazon.com/dp/B000P6G12U?tag=robinfrench-20,2025-12-12T21:03:41.252Z
273,melon,2.57,B000NSGULC,https://www.amazon.com/dp/B000NSGULC?tag=robinfrench-20,2025-12-12T20:53:48.451Z
274,radish greens,2.49,B07CHNV4S1,https://www.amazon.com/dp/B07CHNV4S1?tag=robinfrench-20,2025-12-12T20:50:43.808Z
275,papaya,2.39,B07FZ159ZB,https://www.amazon.com/dp/B07FZ159ZB?tag=robinfrench-20,2025-12-12T20:53:44.000Z
276,cucumber,1.99,B001PLETDC,https://www.amazon.com/dp/B001PLETDC?tag=robinfrench-20,2025-12-12T20:49:57.862Z
277,acorn squash,1.99,B07FZ34ZS4,https://www.amazon.com/dp/B07FZ34ZS4?tag=robinfrench-20,2025-12-12T20:54:44.492Z
278,delicata squash,1.99,B07KHH8K4L,https://www.amazon.com/dp/B07KHH8K4L?tag=robinfrench-20,2025-12-12T21:01:08.746Z
279,napa cabbage (small amounts),1.99,B079VV1K9L,https://www.amazon.com/dp/B079VV1K9L?tag=robinfrench-20,2025-12-12T21:01:35.907Z
280,red cabbage,1.99,B000RH1MXK,https://www.amazon.com/dp/B000RH1MXK?tag=robinfrench-20,2025-12-12T21:01:54.104Z
281,squash (cooked),1.99,B002QY3U5A,https://www.amazon.com/dp/B002QY3U5A?tag=robinfrench-20,2025-12-12T21:02:35.236Z
282,kidney beans (mashed),1.59,B00552005I,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20,2025-12-12T21:00:31.008Z
283,"kidney beans (mashed, tiny amounts)",1.59,B00552005I,https://www.amazon.com/dp/B00552005I?tag=robinfrench-20,2025-12-12T21:00:35.581Z
284,basil,1.50,B097F282FC,https://www.amazon.com/dp/B097F282FC?tag=robinfrench-20,2025-12-12T20:55:22.415Z
285,bell peppers,1.49,B000P6J14K,https://www.amazon.com/dp/B000P6J14K?tag=robinfrench-20,2025-12-12T20:53:07.717Z
286,banana,1.49,B07ZLFKBFD,https://www.amazon.com/dp/B07ZLFKBFD?tag=robinfrench-20,2025-12-12T20:53:34.963Z
287,navy beans (mashed),1.39,B006AZE13G,https://www.amazon.com/dp/B006AZE13G?tag=robinfrench-20,2025-12-12T21:00:26.427Z
</file>

<file path="data/vetted-products-price-updates.ts">
// Price updates for vetted-products.ts
// Generated: 2025-12-12T21:09:40.680Z
// Total products with prices: 292

export const PRICE_UPDATES: Record<string, any> = {
  'ground chicken': {
    price: {
      amount: 23.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:46:50.423Z'
    }
  },
  'ground turkey': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:46:54.959Z'
    }
  },
  'ground beef (lean)': {
    price: {
      amount: 29.9,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:46:59.487Z'
    }
  },
  'ground lamb': {
    price: {
      amount: 37.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:04.185Z'
    }
  },
  'salmon (boneless)': {
    price: {
      amount: 16.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:08.804Z'
    }
  },
  'chicken breast': {
    price: {
      amount: 6.22,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:13.402Z'
    }
  },
  'chicken thighs': {
    price: {
      amount: 6.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:17.992Z'
    }
  },
  'turkey breast': {
    price: {
      amount: 13.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:22.762Z'
    }
  },
  'beef liver': {
    price: {
      amount: 14.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:27.552Z'
    }
  },
  'chicken liver': {
    price: {
      amount: 16.29,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:32.285Z'
    }
  },
  'chicken hearts': {
    price: {
      amount: 47.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:36.945Z'
    }
  },
  'sardines (canned in water)': {
    price: {
      amount: 41.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:41.989Z'
    }
  },
  'eggs': {
    price: {
      amount: 53.19,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:46.815Z'
    }
  },
  'turkey giblets': {
    price: {
      amount: 47.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:51.513Z'
    }
  },
  'chicken giblets': {
    price: {
      amount: 23.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:47:56.190Z'
    }
  },
  'duck breast': {
    price: {
      amount: 41.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:00.969Z'
    }
  },
  'venison': {
    price: {
      amount: 29.9,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:05.490Z'
    }
  },
  'rabbit meat': {
    price: {
      amount: 37.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:10.314Z'
    }
  },
  'quail': {
    price: {
      amount: 21.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:14.932Z'
    }
  },
  'ground pork (lean)': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:19.692Z'
    }
  },
  'turkey necks': {
    price: {
      amount: 6.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:24.343Z'
    }
  },
  'brown rice': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:29.023Z'
    }
  },
  'white rice': {
    price: {
      amount: 5.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:33.750Z'
    }
  },
  'quinoa': {
    price: {
      amount: 74.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:38.310Z'
    }
  },
  'sweet potato': {
    price: {
      amount: 68.35,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:43.264Z'
    }
  },
  'pumpkin puree': {
    price: {
      amount: 43.11,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:48.126Z'
    }
  },
  'butternut squash': {
    price: {
      amount: 52.89,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:52.886Z'
    }
  },
  'lentils': {
    price: {
      amount: 13.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:48:57.775Z'
    }
  },
  'chickpeas': {
    price: {
      amount: 15.68,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:02.539Z'
    }
  },
  'black beans': {
    price: {
      amount: 29.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:07.346Z'
    }
  },
  'green peas': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:11.915Z'
    }
  },
  'carrots': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:16.499Z'
    }
  },
  'spinach': {
    price: {
      amount: 4.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:21.085Z'
    }
  },
  'broccoli': {
    price: {
      amount: 89.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:25.907Z'
    }
  },
  'zucchini': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:30.767Z'
    }
  },
  'kale': {
    price: {
      amount: 82.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:35.263Z'
    }
  },
  'celery': {
    price: {
      amount: 82.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:39.664Z'
    }
  },
  'brussels sprouts': {
    price: {
      amount: 5.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:44.082Z'
    }
  },
  'asparagus': {
    price: {
      amount: 5.37,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:48.630Z'
    }
  },
  'parsley': {
    price: {
      amount: 5.77,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:53.478Z'
    }
  },
  'cucumber': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:49:57.862Z'
    }
  },
  'lettuce (romaine)': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:02.405Z'
    }
  },
  'arugula': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:06.919Z'
    }
  },
  'endive': {
    price: {
      amount: 46.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:11.704Z'
    }
  },
  'escarole': {
    price: {
      amount: 47.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:16.480Z'
    }
  },
  'dandelion greens': {
    price: {
      amount: 21.11,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:21.350Z'
    }
  },
  'collard greens': {
    price: {
      amount: 124.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:25.731Z'
    }
  },
  'mustard greens': {
    price: {
      amount: 4.79,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:30.265Z'
    }
  },
  'turnip greens': {
    price: {
      amount: 4.41,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:34.689Z'
    }
  },
  'beet greens': {
    price: {
      amount: 41.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:39.361Z'
    }
  },
  'radish greens': {
    price: {
      amount: 2.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:43.808Z'
    }
  },
  'coconut oil': {
    price: {
      amount: 23.45,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:48.628Z'
    }
  },
  'olive oil': {
    price: {
      amount: 50.32,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:53.799Z'
    }
  },
  'salmon oil': {
    price: {
      amount: 43.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:50:58.582Z'
    }
  },
  'flaxseed oil': {
    price: {
      amount: 25.19,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:03.516Z'
    }
  },
  'fish oil': {
    price: {
      amount: 39.91,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:08.406Z'
    }
  },
  'taurine powder': {
    price: {
      amount: 12.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:13.306Z'
    }
  },
  'calcium carbonate': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:18.266Z'
    }
  },
  'vitamin e': {
    price: {
      amount: 18.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:23.124Z'
    }
  },
  'b-complex': {
    price: {
      amount: 14.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:28.041Z'
    }
  },
  'probiotic powder': {
    price: {
      amount: 33.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:32.894Z'
    }
  },
  'psyllium husk': {
    price: {
      amount: 17.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:37.725Z'
    }
  },
  'joint supplement': {
    price: {
      amount: 36.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:42.585Z'
    }
  },
  'omega-3 capsules': {
    price: {
      amount: 45.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:47.416Z'
    }
  },
  'digestive enzymes': {
    price: {
      amount: 29.92,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:52.322Z'
    }
  },
  'hairball paste': {
    price: {
      amount: 23.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:51:57.071Z'
    }
  },
  'chicken broth': {
    price: {
      amount: 30.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:02.004Z'
    }
  },
  'vitamin e oil': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:06.746Z'
    }
  },
  'millet (white/red)': {
    price: {
      amount: 11.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:11.566Z'
    }
  },
  'canary seed': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:16.396Z'
    }
  },
  'niger seed': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:21.154Z'
    }
  },
  'oat groats': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:25.839Z'
    }
  },
  'hemp seeds': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:30.495Z'
    }
  },
  'flaxseeds': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:35.165Z'
    }
  },
  'sesame seeds': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:39.810Z'
    }
  },
  'chia seeds': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:44.334Z'
    }
  },
  'quinoa (cooked)': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:49.228Z'
    }
  },
  'rapeseed': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:54.052Z'
    }
  },
  'sunflower seeds (small amounts)': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:52:58.686Z'
    }
  },
  'pumpkin seeds': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:03.279Z'
    }
  },
  'bell peppers': {
    price: {
      amount: 1.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:07.717Z'
    }
  },
  'corn (fresh)': {
    price: {
      amount: 5.79,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:12.176Z'
    }
  },
  'apples (no seeds)': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:16.660Z'
    }
  },
  'blueberries': {
    price: {
      amount: 36.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:21.369Z'
    }
  },
  'strawberries': {
    price: {
      amount: 7.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:25.843Z'
    }
  },
  'mango': {
    price: {
      amount: 6.46,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:30.365Z'
    }
  },
  'banana': {
    price: {
      amount: 1.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:34.963Z'
    }
  },
  'grapes (chopped)': {
    price: {
      amount: 3.5,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:39.458Z'
    }
  },
  'papaya': {
    price: {
      amount: 2.39,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:44.000Z'
    }
  },
  'melon': {
    price: {
      amount: 2.57,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:48.451Z'
    }
  },
  'egg (hard-boiled)': {
    price: {
      amount: 5.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:53.442Z'
    }
  },
  'pellets (fortified)': {
    price: {
      amount: 47.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:53:57.999Z'
    }
  },
  'cuttlebone': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:02.666Z'
    }
  },
  'honey (tiny amounts)': {
    price: {
      amount: 17.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:07.362Z'
    }
  },
  'peanut butter (unsalted, tiny amounts)': {
    price: {
      amount: 14.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:11.988Z'
    }
  },
  'dubia roaches': {
    price: {
      amount: 19.9,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:16.800Z'
    }
  },
  'crickets': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:21.586Z'
    }
  },
  'mealworms': {
    price: {
      amount: 14.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:26.431Z'
    }
  },
  'superworms': {
    price: {
      amount: 25.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:30.992Z'
    }
  },
  'black soldier fly larvae': {
    price: {
      amount: 29.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:35.539Z'
    }
  },
  'hornworms': {
    price: {
      amount: 15.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:40.038Z'
    }
  },
  'acorn squash': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:44.492Z'
    }
  },
  'figs': {
    price: {
      amount: 27.8,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:49.396Z'
    }
  },
  'timothy hay': {
    price: {
      amount: 16.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:54.261Z'
    }
  },
  'meadow hay': {
    price: {
      amount: 36.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:54:58.942Z'
    }
  },
  'orchard grass hay': {
    price: {
      amount: 34.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:03.558Z'
    }
  },
  'alfalfa hay': {
    price: {
      amount: 28.93,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:08.164Z'
    }
  },
  'romaine lettuce': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:12.887Z'
    }
  },
  'cilantro': {
    price: {
      amount: 20.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:17.766Z'
    }
  },
  'basil': {
    price: {
      amount: 1.5,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:22.415Z'
    }
  },
  'duck hearts': {
    price: {
      amount: 5.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:27.056Z'
    }
  },
  'lamb liver': {
    price: {
      amount: 15.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:31.989Z'
    }
  },
  'duck liver': {
    price: {
      amount: 59.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:36.929Z'
    }
  },
  'chicken necks': {
    price: {
      amount: 22.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:41.686Z'
    }
  },
  'turkey thighs': {
    price: {
      amount: 4.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:46.270Z'
    }
  },
  'ground duck': {
    price: {
      amount: 16.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:51.155Z'
    }
  },
  'ground lamb (lean)': {
    price: {
      amount: 11.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:55:55.587Z'
    }
  },
  'ground herring': {
    price: {
      amount: 37.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:00.545Z'
    }
  },
  'ground mackerel': {
    price: {
      amount: 15.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:05.291Z'
    }
  },
  'mackerel (canned)': {
    price: {
      amount: 35.52,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:09.986Z'
    }
  },
  'herring (canned)': {
    price: {
      amount: 41.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:14.974Z'
    }
  },
  'chicken sausage (no additives)': {
    price: {
      amount: 9.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:19.480Z'
    }
  },
  'turkey sausage (no additives)': {
    price: {
      amount: 4.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:24.001Z'
    }
  },
  'ground pork (lean, small amounts)': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:28.611Z'
    }
  },
  'regular potato': {
    price: {
      amount: 4.15,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:33.292Z'
    }
  },
  'walnut oil': {
    price: {
      amount: 8.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:38.038Z'
    }
  },
  'black currant oil': {
    price: {
      amount: 23.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:42.792Z'
    }
  },
  'almond oil': {
    price: {
      amount: 18.46,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:47.604Z'
    }
  },
  'sunflower oil': {
    price: {
      amount: 51.85,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:52.300Z'
    }
  },
  'chia seed oil': {
    price: {
      amount: 6.46,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:56:56.757Z'
    }
  },
  'herring oil': {
    price: {
      amount: 39.91,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:01.793Z'
    }
  },
  'anchovy oil': {
    price: {
      amount: 34.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:06.500Z'
    }
  },
  'evening primrose oil': {
    price: {
      amount: 17.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:11.379Z'
    }
  },
  'mackerel oil': {
    price: {
      amount: 34.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:16.222Z'
    }
  },
  'sardine oil': {
    price: {
      amount: 29.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:20.966Z'
    }
  },
  'borage oil': {
    price: {
      amount: 23.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:25.485Z'
    }
  },
  'sesame oil': {
    price: {
      amount: 10.84,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:30.466Z'
    }
  },
  'avocado oil': {
    price: {
      amount: 40.91,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:34.935Z'
    }
  },
  'avocado oil (tiny amounts)': {
    price: {
      amount: 40.91,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:39.404Z'
    }
  },
  'wheat germ oil': {
    price: {
      amount: 30.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:44.060Z'
    }
  },
  'krill oil': {
    price: {
      amount: 78.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:48.832Z'
    }
  },
  'algae oil (dha)': {
    price: {
      amount: 33.11,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:53.790Z'
    }
  },
  'omega-3 oil': {
    price: {
      amount: 43.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:57:58.533Z'
    }
  },
  'kelp powder': {
    price: {
      amount: 13.29,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:03.385Z'
    }
  },
  'joint health powder': {
    price: {
      amount: 43.8,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:08.122Z'
    }
  },
  'amino acid supplement': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:12.855Z'
    }
  },
  'calcium supplement': {
    price: {
      amount: 7.12,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:17.738Z'
    }
  },
  'spirulina powder': {
    price: {
      amount: 29.89,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:22.564Z'
    }
  },
  'electrolyte powder': {
    price: {
      amount: 37.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:27.368Z'
    }
  },
  'vitamin d3 drops': {
    price: {
      amount: 14.45,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:32.356Z'
    }
  },
  "brewer's yeast": {
    price: {
      amount: 11.12,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:37.396Z'
    }
  },
  'buckwheat': {
    price: {
      amount: 21,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:42.291Z'
    }
  },
  'buckwheat (tiny amounts)': {
    price: {
      amount: 21,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:47.053Z'
    }
  },
  'buckwheat (hulled)': {
    price: {
      amount: 24.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:51.848Z'
    }
  },
  'sorghum': {
    price: {
      amount: 14.33,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:58:56.471Z'
    }
  },
  'barley': {
    price: {
      amount: 19.92,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:01.320Z'
    }
  },
  'barley (cooked, minimal)': {
    price: {
      amount: 34.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:06.108Z'
    }
  },
  'barley (hulled)': {
    price: {
      amount: 34.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:10.692Z'
    }
  },
  'millet': {
    price: {
      amount: 14.33,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:15.280Z'
    }
  },
  'millet (tiny amounts)': {
    price: {
      amount: 16.32,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:20.051Z'
    }
  },
  'farro': {
    price: {
      amount: 14.33,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:24.562Z'
    }
  },
  'bulgur': {
    price: {
      amount: 20.42,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:29.455Z'
    }
  },
  'amaranth (tiny amounts)': {
    price: {
      amount: 44.1,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:34.311Z'
    }
  },
  'amaranth seeds': {
    price: {
      amount: 44.1,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:39.129Z'
    }
  },
  'teff seeds': {
    price: {
      amount: 14.33,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:43.761Z'
    }
  },
  'wheat (hulled)': {
    price: {
      amount: 8.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:48.590Z'
    }
  },
  'oat bran (small amounts)': {
    price: {
      amount: 14.74,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:53.569Z'
    }
  },
  'oatmeal (cooked, small amounts)': {
    price: {
      amount: 59.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T20:59:58.329Z'
    }
  },
  'corn (cracked)': {
    price: {
      amount: 27.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:03.238Z'
    }
  },
  'safflower seeds': {
    price: {
      amount: 41.02,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:07.947Z'
    }
  },
  'nyjer seeds': {
    price: {
      amount: 15.61,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:12.678Z'
    }
  },
  'bok choi': {
    price: {
      amount: 6.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:17.337Z'
    }
  },
  'bok choy (small amounts)': {
    price: {
      amount: 6.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:21.875Z'
    }
  },
  'navy beans (mashed)': {
    price: {
      amount: 1.39,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:26.427Z'
    }
  },
  'kidney beans (mashed)': {
    price: {
      amount: 1.59,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:31.008Z'
    }
  },
  'kidney beans (mashed, tiny amounts)': {
    price: {
      amount: 1.59,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:35.581Z'
    }
  },
  'pinto beans (mashed)': {
    price: {
      amount: 23.32,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:40.288Z'
    }
  },
  'purslane': {
    price: {
      amount: 5.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:45.040Z'
    }
  },
  'purslane (small amounts)': {
    price: {
      amount: 23.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:49.880Z'
    }
  },
  'miner's lettuce': {
    price: {
      amount: 18.39,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:54.713Z'
    }
  },
  'flaxseed (ground)': {
    price: {
      amount: 11.42,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:00:59.653Z'
    }
  },
  'fennel': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:04.302Z'
    }
  },
  'delicata squash': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:08.746Z'
    }
  },
  'yellow squash': {
    price: {
      amount: 4.94,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:13.363Z'
    }
  },
  'leeks': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:17.884Z'
    }
  },
  'shallots': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:22.358Z'
    }
  },
  'tomatoes (small amounts)': {
    price: {
      amount: 3.06,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:26.909Z'
    }
  },
  'napa cabbage': {
    price: {
      amount: 3.96,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:31.424Z'
    }
  },
  'napa cabbage (small amounts)': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:35.907Z'
    }
  },
  'artichokes': {
    price: {
      amount: 8.72,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:40.510Z'
    }
  },
  'frisee': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:44.839Z'
    }
  },
  'radicchio': {
    price: {
      amount: 5.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:49.536Z'
    }
  },
  'red cabbage': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:54.104Z'
    }
  },
  'green cabbage': {
    price: {
      amount: 3.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:01:58.558Z'
    }
  },
  'swiss chard': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:03.086Z'
    }
  },
  'swiss chard (cooked, tiny amounts)': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:07.730Z'
    }
  },
  'lettuce (romaine, small amounts)': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:12.166Z'
    }
  },
  'red leaf lettuce': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:16.673Z'
    }
  },
  'mache': {
    price: {
      amount: 4.39,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:21.348Z'
    }
  },
  'alfalfa sprouts (small amounts)': {
    price: {
      amount: 13.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:25.940Z'
    }
  },
  'cat grass (wheatgrass)': {
    price: {
      amount: 21.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:30.763Z'
    }
  },
  'squash (cooked)': {
    price: {
      amount: 1.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:35.236Z'
    }
  },
  'lamb's quarters': {
    price: {
      amount: 6.5,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:39.924Z'
    }
  },
  'amaranth leaves': {
    price: {
      amount: 18.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:44.545Z'
    }
  },
  'ginger (small amounts)': {
    price: {
      amount: 6.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:49.197Z'
    }
  },
  'turmeric': {
    price: {
      amount: 16.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:54.163Z'
    }
  },
  'rosemary': {
    price: {
      amount: 15.75,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:02:59.048Z'
    }
  },
  'sage': {
    price: {
      amount: 329.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:03.477Z'
    }
  },
  'mint': {
    price: {
      amount: 4.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:08.008Z'
    }
  },
  'garlic chives': {
    price: {
      amount: 3,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:12.540Z'
    }
  },
  'raisins (unsweetened)': {
    price: {
      amount: 10.43,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:17.641Z'
    }
  },
  'plums (pitted)': {
    price: {
      amount: 35.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:22.560Z'
    }
  },
  'apricots (pitted)': {
    price: {
      amount: 39.55,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:27.321Z'
    }
  },
  'kiwi': {
    price: {
      amount: 4.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:31.814Z'
    }
  },
  'mulberries': {
    price: {
      amount: 16.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:36.579Z'
    }
  },
  'raspberries': {
    price: {
      amount: 2.59,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:41.252Z'
    }
  },
  'cranberries': {
    price: {
      amount: 16.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:45.886Z'
    }
  },
  'pineapple (small amounts)': {
    price: {
      amount: 3.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:50.298Z'
    }
  },
  'pears (no seeds)': {
    price: {
      amount: 8.8,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:54.777Z'
    }
  },
  'pinhead crickets': {
    price: {
      amount: 24.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:03:59.322Z'
    }
  },
  'locusts': {
    price: {
      amount: 6.62,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:04.065Z'
    }
  },
  'butterworms': {
    price: {
      amount: 28.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:08.665Z'
    }
  },
  'grasshoppers': {
    price: {
      amount: 8.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:13.583Z'
    }
  },
  'small dubia roaches': {
    price: {
      amount: 19.9,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:18.331Z'
    }
  },
  'silkworms': {
    price: {
      amount: 20.34,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:22.952Z'
    }
  },
  'earthworms': {
    price: {
      amount: 17.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:27.764Z'
    }
  },
  'wheat hay': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:32.581Z'
    }
  },
  'fescue hay': {
    price: {
      amount: 29.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:37.376Z'
    }
  },
  'oat hay': {
    price: {
      amount: 8.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:42.190Z'
    }
  },
  'bluegrass hay': {
    price: {
      amount: 34.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:46.822Z'
    }
  },
  'straw (wheat/pine)': {
    price: {
      amount: 29.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:51.497Z'
    }
  },
  'dried grass': {
    price: {
      amount: 5.29,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:04:56.470Z'
    }
  },
  'bermuda hay': {
    price: {
      amount: 36.8,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:00.772Z'
    }
  },
  'barley hay': {
    price: {
      amount: 39.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:05.786Z'
    }
  },
  'guinea pig pellets (with vitamin c)': {
    price: {
      amount: 36.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:10.639Z'
    }
  },
  'rabbit pellets (high fiber)': {
    price: {
      amount: 21.67,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:15.479Z'
    }
  },
  'hamster pellets (higher protein)': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:20.304Z'
    }
  },
  'wild bird mix': {
    price: {
      amount: 41.02,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:24.990Z'
    }
  },
  'beta-glucans': {
    price: {
      amount: 134.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:29.791Z'
    }
  },
  'biotin': {
    price: {
      amount: 14.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:34.707Z'
    }
  },
  'bone broth (low sodium)': {
    price: {
      amount: 30.48,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:39.622Z'
    }
  },
  'cauliflower': {
    price: {
      amount: 4.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:44.196Z'
    }
  },
  'chicory root': {
    price: {
      amount: 29.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:48.888Z'
    }
  },
  'chondroitin sulfate': {
    price: {
      amount: 36.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:53.676Z'
    }
  },
  'cranberry extract': {
    price: {
      amount: 14.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:05:58.616Z'
    }
  },
  'curcumin (turmeric extract)': {
    price: {
      amount: 26.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:03.526Z'
    }
  },
  'd-mannose': {
    price: {
      amount: 39.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:08.330Z'
    }
  },
  'egg yolks': {
    price: {
      amount: 10.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:12.913Z'
    }
  },
  'eggplant': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:17.448Z'
    }
  },
  'eggshells (crushed)': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:22.464Z'
    }
  },
  'fish broth (no salt)': {
    price: {
      amount: 16.65,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:27.442Z'
    }
  },
  'fructooligosaccharides (fos)': {
    price: {
      amount: 29.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:32.045Z'
    }
  },
  'glucosamine sulfate': {
    price: {
      amount: 36.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:36.710Z'
    }
  },
  'green beans': {
    price: {
      amount: 25.56,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:41.437Z'
    }
  },
  'green beans (cooked)': {
    price: {
      amount: 25.56,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:46.007Z'
    }
  },
  'hairball control paste': {
    price: {
      amount: 23.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:50.872Z'
    }
  },
  'hyaluronic acid': {
    price: {
      amount: 18.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:06:55.692Z'
    }
  },
  'inulin (prebiotic)': {
    price: {
      amount: 29.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:00.337Z'
    }
  },
  'jerusalem artichoke': {
    price: {
      amount: 22.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:04.838Z'
    }
  },
  'joint health supplement': {
    price: {
      amount: 36.97,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:09.362Z'
    }
  },
  'l-carnitine powder': {
    price: {
      amount: 19.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:14.304Z'
    }
  },
  'lysine powder': {
    price: {
      amount: 13.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:19.324Z'
    }
  },
  'malabar spinach': {
    price: {
      amount: 34,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:23.821Z'
    }
  },
  'mannanoligosaccharides (mos)': {
    price: {
      amount: 17.4,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:28.938Z'
    }
  },
  'milk thistle': {
    price: {
      amount: 10.4,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:33.821Z'
    }
  },
  'new zealand spinach': {
    price: {
      amount: 4.49,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:38.722Z'
    }
  },
  'niacinamide': {
    price: {
      amount: 12.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:43.676Z'
    }
  },
  'oats (rolled)': {
    price: {
      amount: 20.44,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:48.631Z'
    }
  },
  'peas': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:53.364Z'
    }
  },
  'peas (mashed)': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:07:57.848Z'
    }
  },
  'pectin (from apples)': {
    price: {
      amount: 9.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:02.860Z'
    }
  },
  'pumpkin seed oil': {
    price: {
      amount: 21.98,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:07.591Z'
    }
  },
  'quail eggs': {
    price: {
      amount: 18.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:12.122Z'
    }
  },
  'quercetin': {
    price: {
      amount: 37.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:16.972Z'
    }
  },
  'rice (hulled)': {
    price: {
      amount: 2.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:21.670Z'
    }
  },
  'romanesco broccoli': {
    price: {
      amount: 19.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:26.110Z'
    }
  },
  's-adenosyl methionine (sam-e)': {
    price: {
      amount: 40.25,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:31.107Z'
    }
  },
  'sardines (in water)': {
    price: {
      amount: 41.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:36.179Z'
    }
  },
  'snap peas': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:40.695Z'
    }
  },
  'snow peas': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:45.145Z'
    }
  },
  'snow peas (mashed)': {
    price: {
      amount: 64.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:49.515Z'
    }
  },
  'split peas': {
    price: {
      amount: 20.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:54.184Z'
    }
  },
  'split peas (mashed)': {
    price: {
      amount: 20.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:08:58.721Z'
    }
  },
  'sugar snap peas': {
    price: {
      amount: 20.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:03.193Z'
    }
  },
  'sugar snap peas (mashed)': {
    price: {
      amount: 20.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:07.623Z'
    }
  },
  'turkey broth (no salt)': {
    price: {
      amount: 16.65,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:12.294Z'
    }
  },
  'vitamin b complex': {
    price: {
      amount: 14.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:17.134Z'
    }
  },
  'vitamin c (small amounts)': {
    price: {
      amount: 17.95,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:22.054Z'
    }
  },
  'watercress': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:26.582Z'
    }
  },
  'watercress (small amounts)': {
    price: {
      amount: 3.99,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:31.021Z'
    }
  },
  'wheat germ': {
    price: {
      amount: 14.33,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:35.709Z'
    }
  },
  'wild rice': {
    price: {
      amount: 19.5,
      currency: 'USD',
      lastUpdated: '2025-12-12T21:09:40.679Z'
    }
  },
};
</file>

<file path="extract_names.py">
import re

# Read the TypeScript file
with open('lib/data/celebrity-pets-complete.ts', 'r') as f:
    content = f.read()

# Find all name: "..." patterns
names = re.findall(r'name: "([^"]*)"', content)

# Write to a file, one per line
with open('celebrity_pet_names.txt', 'w') as f:
    for name in names:
        f.write(name + '\n')

print(f"Extracted {len(names)} names to celebrity_pet_names.txt")
</file>

<file path="fix-small-packages.mjs">
// Fix all small package sizes in product-prices.json
import fs from 'fs';

const data = JSON.parse(fs.readFileSync('./data/product-prices.json', 'utf8'));

console.log('=== FIXING SMALL PACKAGE SIZES ===\n');

const fixes = {
  // Herbs and spices - standard spice jar sizes
  'sage': '2 oz',
  'basil': '2 oz',
  'fennel': '2 oz',
  'ginger (small amounts)': '2 oz',
  'turmeric': '2 oz',
  'rosemary': '2 oz',
  'mint': '2 oz',
  'garlic chives': '2 oz',
  
  // Meats - standard package sizes
  'chicken sausage (no additives)': '12 oz',
  'turkey sausage (no additives)': '12 oz',
  
  // Supplements - standard bottle sizes
  'vitamin d3 drops': '2 oz',
  'cat grass (wheatgrass)': '4 oz'
};

let fixCount = 0;

data.forEach(item => {
  if (fixes[item.ingredient]) {
    const oldQty = item.quantity;
    item.quantity = fixes[item.ingredient];
    console.log(`‚úì ${item.ingredient.padEnd(35)} ${oldQty.padEnd(10)} ‚Üí ${item.quantity}`);
    fixCount++;
  }
});

// Write back to file
fs.writeFileSync('./data/product-prices.json', JSON.stringify(data, null, 2));

console.log(`\n‚úÖ Fixed ${fixCount} package sizes`);
console.log('Updated product-prices.json');
</file>

<file path="hooks/useAsyncOperation.ts">
// hooks/useAsyncOperation.ts
// Custom hook for handling async operations with loading/error states

import { useState, useCallback } from 'react';
import { handleError, getErrorMessage } from '@/lib/utils/errorHandler';

interface AsyncOperationState<T> {
  data: T | null;
  loading: boolean;
  error: string | null;
}

export function useAsyncOperation<T, Args extends any[]>(
  asyncFn: (...args: Args) => Promise<T>
) {
  const [state, setState] = useState<AsyncOperationState<T>>({
    data: null,
    loading: false,
    error: null,
  });

  const execute = useCallback(
    async (...args: Args) => {
      setState({ data: null, loading: true, error: null });
      
      try {
        const result = await asyncFn(...args);
        setState({ data: result, loading: false, error: null });
        return result;
      } catch (error) {
        const appError = handleError(error);
        const errorMessage = getErrorMessage(appError);
        setState({ data: null, loading: false, error: errorMessage });
        throw appError;
      }
    },
    [asyncFn]
  );

  const reset = useCallback(() => {
    setState({ data: null, loading: false, error: null });
  }, []);

  return {
    ...state,
    execute,
    reset,
  };
}
</file>

<file path="hooks/useOfflineDetector.ts">
// hooks/useOfflineDetector.ts
// Hook to detect online/offline status

import { useState, useEffect } from 'react';

export function useOfflineDetector() {
  const [isOnline, setIsOnline] = useState<boolean>(
    typeof window !== 'undefined' ? navigator.onLine : true
  );

  useEffect(() => {
    const handleOnline = () => {
      setIsOnline(true);
      console.log('App is online');
    };

    const handleOffline = () => {
      setIsOnline(false);
      console.log('App is offline');
    };

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return { isOnline, isOffline: !isOnline };
}
</file>

<file path="hooks/useProgressiveMealCount.ts">
import { useState, useEffect } from 'react';

interface UseProgressiveMealCountOptions {
  target: number;
  duration?: number; // Animation duration in milliseconds
  steps?: number; // Number of animation steps
}

interface UseProgressiveMealCountResult {
  displayCount: number;
  isCounting: boolean;
}

/**
 * Hook that animates a count from 0 to target over a specified duration.
 * 
 * This creates an engaging UX where the count appears to be "searching" and
 * counting up in real-time.
 * 
 * @param options Configuration options
 * @returns Current display count and whether counting is in progress
 */
export function useProgressiveMealCount({
  target,
  duration = 1000,
  steps = 20,
}: UseProgressiveMealCountOptions): UseProgressiveMealCountResult {
  const [displayCount, setDisplayCount] = useState(0);
  const [isCounting, setIsCounting] = useState(true);

  useEffect(() => {
    if (target === 0) {
      setDisplayCount(0);
      setIsCounting(false);
      return;
    }

    setIsCounting(true);
    let current = 0;
    const increment = Math.ceil(target / steps);
    const stepDuration = duration / steps;

    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        current = target;
        clearInterval(timer);
        setIsCounting(false);
      }
      setDisplayCount(current);
    }, stepDuration);

    return () => clearInterval(timer);
  }, [target, duration, steps]);

  return { displayCount, isCounting };
}
</file>

<file path="lib/__tests__/analyzeCustomMeal.test.ts">
// lib/__tests__/analyzeCustomMeal.test.ts
// Comprehensive tests for custom meal analysis engine

import { generateCustomMealAnalysis } from '../analyzeCustomMeal';

describe('generateCustomMealAnalysis', () => {
  test('returns proper structure for empty recipe', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    const result = generateCustomMealAnalysis(pet, []);

    expect(result.score).toBe(0);
    expect(result.deficiencies).toContain('No ingredients selected');
    expect(result.toxicityWarnings).toHaveLength(0);
    expect(result.totalWeight_g).toBe(0);
  });

  test('analyzes dog recipe correctly', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    const selections = [
      { key: 'ground_beef_lean', grams: 200 },
      { key: 'brown_rice_cooked', grams: 150 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(result).toHaveProperty('score');
    expect(result).toHaveProperty('nutrients');
    expect(result).toHaveProperty('dmNutrients');
    expect(result.nutrients.protein_g).toBeGreaterThan(0);
    expect(result.totalWeight_g).toBe(350);
    expect(result.dryMatterPercent).toBeLessThan(100);
  });

  test('detects toxic ingredients for dogs', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    const selections = [
      { key: 'chicken_breast', grams: 100 },
      // Note: Currently no INGREDIENT_COMPOSITIONS entries match toxic keys exactly
      // This test will need updating when chocolate is properly added
    ];

    const result = generateCustomMealAnalysis(pet, selections);
    // Should not crash and provide valid analysis
    expect(result.score).toBeGreaterThan(0);
  });

  test('detects allergen warnings', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: ['chicken_breast'], // This should cause a warning
    };

    const selections = [
      { key: 'chicken_breast', grams: 100 },
      { key: 'brown_rice_cooked', grams: 100 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(result.allergyWarnings).toContain('Chicken Breast is listed as an allergen for this pet');
  });

  test('calculates Ca:P ratio correctly', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    // Using ingredients with known calcium and phosphorus
    const selections = [
      { key: 'chicken_breast', grams: 100 }, // 11mg Ca, 196mg P per 100g
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(result.caToPratio).toBeDefined();
    expect(result.caToPratio).toBeCloseTo(11/196, 3); // ~0.056
  });

  test('provides actionable suggestions', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    // Simple recipe
    const selections = [
      { key: 'chicken_breast', grams: 100 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(Array.isArray(result.suggestions)).toBe(true);
    expect(result.suggestions.length).toBeGreaterThan(0);
  });

  test('handles invalid ingredient keys gracefully', () => {
    const pet = {
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: [],
    };

    const selections = [
      { key: 'nonexistent_ingredient', grams: 100 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(result.score).toBe(0);
    expect(result.deficiencies[0]).toContain('Error: Ingredient not found');
  });

  test('works with reptiles (different Ca:P target)', () => {
    const pet = {
      species: 'reptiles' as const,
      lifeStage: 'adult' as const,
      weightKg: 0.25,
      allergies: [],
    };

    const selections = [
      { key: 'chicken_breast', grams: 50 },
      { key: 'kale_raw', grams: 100 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    expect(result).toHaveProperty('score');
    expect(result.species || 'reptiles').toBe('reptiles'); // Ca:P suggestions differ
    expect(result.suggestions.some(s => s.includes('Ca:P') || s.includes('calcium'))).toBe(true);
  });

  test('warns about toxic ingredients for birds', () => {
    const pet = {
      species: 'birds' as const,
      lifeStage: 'adult' as const,
      weightKg: 0.1,
      allergies: [],
    };

    const selections = [
      { key: 'chicken_breast', grams: 10 },
    ];

    const result = generateCustomMealAnalysis(pet, selections);

    // Should still work, even if no toxicity warnings for this ingredient
    expect(result.toxicityWarnings).toHaveLength(0);
    expect(result.score).toBeGreaterThan(0);
  });
});

// Sample test data for documentation
export const sampleTests = {
  dog: {
    pet: {
      id: 'dog-example',
      name: 'Max',
      species: 'dogs' as const,
      lifeStage: 'adult' as const,
      weightKg: 25,
      allergies: ['chicken_breast'],
    },
    recipe: [
      { key: 'ground_beef_lean', grams: 200 },
      { key: 'brown_rice_cooked', grams: 150 },
      { key: 'kale_raw', grams: 50 },
    ],
  },
  reptile: {
    pet: {
      id: 'reptile-example',
      name: 'Spike',
      species: 'reptiles' as const,
      lifeStage: 'adult' as const,
      weightKg: 0.25,
      allergies: [],
    },
    recipe: [
      { key: 'chicken_breast', grams: 25 },
      { key: 'kale_raw', grams: 75 },
    ],
  },
  pocketPet: {
    pet: {
      id: 'pocket-example',
      name: 'Fluffy',
      species: 'pocket-pets' as const,
      lifeStage: 'adult' as const,
      weightKg: 0.05,
      allergies: [],
    },
    recipe: [
      { key: 'oats', grams: 10 },
      { key: 'kale_raw', grams: 5 },
    ],
  },
};
</file>

<file path="lib/__tests__/applyModifiers.test.ts">
import { describe, it, expect } from 'vitest';
import { applyModifiers } from '../applyModifiers';
import { getVettedProduct } from '../data/vetted-products';

describe('applyModifiers', () => {
  const mockRecipe = {
    id: '1',
    name: 'Test Recipe',
    category: 'dogs',
    ageGroup: ['adult'],
    breed: ['labrador'],
    healthConcerns: ['joint-health', 'allergies'],
    ingredients: [
      { id: '1', name: 'Chicken', amount: '100g' },
      { id: '2', name: 'Rice', amount: '50g' },
    ],
  };

  const mockPetAllergies = {
    id: '1',
    name: 'Buddy',
    type: 'dogs',
    breed: 'labrador',
    age: 'adult',
    healthConcerns: ['allergies'],
  };

  const mockPetJoint = {
    id: '2',
    name: 'Max',
    type: 'dogs',
    breed: 'golden',
    age: 'senior',
    healthConcerns: ['joint-health'],
  };

  const mockPetNone = {
    id: '3',
    name: 'Bella',
    type: 'cats',
    breed: 'persian',
    age: 'adult',
    healthConcerns: [],
  };

  it('should add allergy-related ingredients for pet with allergies', () => {
    const result = applyModifiers(mockRecipe as any, mockPetAllergies as any);
    expect(result.addedIngredients.length).toBeGreaterThan(0);
    expect(result.addedIngredients.some((add) => add.forConcern === 'allergies')).toBe(true);
    expect(result.modifiedRecipe.ingredients.length).toBe(mockRecipe.ingredients.length + result.addedIngredients.length);
  });

  it('should add joint-related ingredients for pet with joint issues', () => {
    const result = applyModifiers(mockRecipe as any, mockPetJoint as any);
    expect(result.addedIngredients.length).toBeGreaterThan(0);
    expect(result.addedIngredients.some((add) => add.forConcern === 'joint-health')).toBe(true);
  });

  it('should not add ingredients for non-dog pets', () => {
    const result = applyModifiers(mockRecipe as any, mockPetNone as any);
    expect(result.addedIngredients.length).toBe(0);
  });

  it('should not add ingredients if recipe does not support the concern', () => {
    const recipeNoSupport = { ...mockRecipe, healthConcerns: [] };
    const result = applyModifiers(recipeNoSupport as any, mockPetJoint as any);
    expect(result.addedIngredients.length).toBe(0);
  });
});

describe('getVettedProduct', () => {
  it('should find vetted products for normalized ingredient names', () => {
    // Test exact matches
    expect(getVettedProduct('chicken breast')).toBeDefined();
    expect(getVettedProduct('ground turkey')).toBeDefined();

    // Test normalized matches
    expect(getVettedProduct('Boneless skinless chicken breast')).toBeDefined();
    expect(getVettedProduct('White rice (cooked)')).toBeDefined();
    expect(getVettedProduct('Carrot, diced')).toBeDefined();
    expect(getVettedProduct('Canned pumpkin (no sugar)')).toBeDefined();
    expect(getVettedProduct('Fresh salmon')).toBeDefined();
  });

  it('should return undefined for unknown ingredients', () => {
    expect(getVettedProduct('unknown ingredient')).toBeUndefined();
    expect(getVettedProduct('random food')).toBeUndefined();
  });
});
</file>

<file path="lib/__tests__/ingredientCompositions.test.ts">
import { describe, expect, test } from 'vitest';
import { INGREDIENT_COMPOSITIONS, ConfidenceLevel } from '../data/ingredientCompositions';

const ALLOWED_CONFIDENCE: ConfidenceLevel[] = ['high', 'medium', 'low'];

describe('ingredient compositions metadata', () => {
  test('every ingredient declares confidence values with allowed levels', () => {
    Object.entries(INGREDIENT_COMPOSITIONS).forEach(([name, composition]) => {
      expect(composition.confidenceBySpecies).toBeDefined();
      const confidence = composition.confidenceBySpecies!;

      expect(confidence.dog).toBeDefined();
      expect(confidence.cat).toBeDefined();
      expect(confidence.bird).toBeDefined();
      expect(confidence.reptile).toBeDefined();
      expect(confidence['pocket-pet']).toBeDefined();

      Object.values(confidence).forEach((value) => {
        expect(ALLOWED_CONFIDENCE).toContain(value as ConfidenceLevel);
      });
    });
  });

  test('pocket-pet metadata exists for compatibility, maxima, and notes', () => {
    Object.entries(INGREDIENT_COMPOSITIONS).forEach(([name, composition]) => {
      const pocketCompat = composition.speciesCompatibility?.['pocket-pet'];
      expect(pocketCompat).toBeDefined();

      const pocketMax = composition.maxInclusionPercentBySpecies?.['pocket-pet'];
      expect(pocketMax).not.toBeUndefined();

      const pocketNote = composition.notesBySpecies?.['pocket-pet'];
      expect(pocketNote).toBeDefined();

      if (pocketCompat === 'avoid') {
        expect(pocketMax).toBe(0);
      }
    });
  });
});
</file>

<file path="lib/__tests__/perfect-pet-scoring.test.ts">
// lib/__tests__/perfect-pet-scoring.test.ts
// Integration tests for perfect pet scoring

import { calculateEnhancedCompatibility, isGoldStandardForSimplePet, calibrateScoresForPet, type Pet } from '@/lib/utils/enhancedCompatibilityScoring';
import type { Recipe } from '@/lib/types';

describe('Perfect Pet Scoring', () => {
  const perfectDog: Pet = {
    id: 'test-perfect-dog',
    name: 'Test Dog',
    type: 'dog',
    breed: 'golden-retriever',
    age: 3,
    weight: 15,
    activityLevel: 'moderate',
    healthConcerns: [],
    dietaryRestrictions: [],
    allergies: []
  };
  
  const perfectBird: Pet = {
    id: 'test-perfect-bird',
    name: 'Test Bird',
    type: 'bird',
    breed: 'parrot',
    age: 2,
    weight: 0.5,
    activityLevel: 'moderate',
    healthConcerns: [],
    dietaryRestrictions: [],
    allergies: []
  };
  
  const perfectRecipe: Recipe = {
    id: 'perfect-test-recipe',
    name: 'Perfect Test Recipe',
    category: 'dogs',
    ingredients: [
      { id: '1', name: 'chicken_breast', amount: '70%' },
      { id: '2', name: 'sweet_potato', amount: '20%' },
      { id: '3', name: 'carrots', amount: '8%' },
      { id: '4', name: 'fish_oil', amount: '2%' }
    ],
    nutritionalInfo: {
      protein: { min: 25, max: 30, unit: '%' },
      fat: { min: 12, max: 18, unit: '%' },
      fiber: { min: 3, max: 5, unit: '%' },
      calcium: { min: 1.0, max: 1.5, unit: '%' },
      phosphorus: { min: 0.8, max: 1.2, unit: '%' }
    },
    ageGroup: ['adult'],
    healthConcerns: []
  };
  
  test('Perfect dog should get 95-100% for perfect recipe', () => {
    const score = calculateEnhancedCompatibility(perfectRecipe, perfectDog);
    expect(score.overallScore).toBeGreaterThanOrEqual(95);
  });
  
  test('Perfect recipe should be gold-standard for perfect pet', () => {
    const isGold = isGoldStandardForSimplePet(perfectRecipe, perfectDog);
    expect(isGold).toBe(true);
  });
  
  test('Calibration should scale gold-standard recipe to 100%', () => {
    const recipes = [perfectRecipe];
    const calibrated = calibrateScoresForPet(recipes, perfectDog);
    expect(calibrated.get(perfectRecipe.id)).toBeGreaterThanOrEqual(98);
  });
  
  test('Each factor should be identifiable when preventing 100%', () => {
    const score = calculateEnhancedCompatibility(perfectRecipe, perfectDog);
    if (score.overallScore < 100) {
      const lowFactors = Object.entries(score.factors)
        .filter(([_, factor]) => factor.score < 100)
        .map(([key, factor]) => `${key}: ${factor.score}%`);
      console.log('Factors preventing 100%:', lowFactors);
      // This should help identify the bottleneck
    }
  });
  
  test('Health alignment should return 100% for pets with no concerns', () => {
    const score = calculateEnhancedCompatibility(perfectRecipe, perfectDog);
    expect(score.factors.healthAlignment.score).toBe(100);
  });
  
  test('Allergen safety should return 100% for pets with no allergies', () => {
    const score = calculateEnhancedCompatibility(perfectRecipe, perfectDog);
    expect(score.factors.allergenSafety.score).toBe(100);
  });
});
</file>

<file path="lib/__tests__/recipe-generator-v2.test.ts">
/**
 * Integration tests for refactored recipe generation system
 */

import { describe, it, expect, beforeEach } from 'vitest';
import { generateRecipe, generateBestRecipe, generateRecipes } from '@/lib/recipe-generator-v2';
import type { Pet } from '@/lib/types';

describe('Recipe Generator V2 - Refactored', () => {
  let mockDog: Pet;
  let mockCat: Pet;

  beforeEach(() => {
    mockDog = {
      id: 'dog-1',
      name: 'Max',
      type: 'dogs',
      weightKg: 20,
      age: 'adult',
      healthConcerns: ['joint-health'],
      allergies: [],
      bannedIngredients: [],
    };

    mockCat = {
      id: 'cat-1',
      name: 'Whiskers',
      type: 'cats',
      weightKg: 5,
      age: 'adult',
      healthConcerns: [],
      allergies: [],
      bannedIngredients: [],
    };
  });

  describe('generateRecipe()', () => {
    it('should generate a valid recipe for a dog', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe).toBeDefined();
      expect(recipe?.id).toBeDefined();
      expect(recipe?.name).toBeDefined();
      expect(recipe?.ingredients.length).toBeGreaterThan(0);
      expect(recipe?.nutrition.protein).toBeGreaterThan(0);
      expect(recipe?.score).toBeGreaterThanOrEqual(0);
      expect(recipe?.score).toBeLessThanOrEqual(100);
    });

    it('should generate a valid recipe for a cat', () => {
      const recipe = generateRecipe({ pet: mockCat });

      expect(recipe).toBeDefined();
      expect(recipe?.ingredients.length).toBeGreaterThan(0);
      expect(recipe?.nutrition.kcal).toBeGreaterThan(0);
    });

    it('should respect budget constraint', () => {
      const recipe = generateRecipe({
        pet: mockDog,
        budgetPerMeal: 2.0,
      });

      expect(recipe).toBeDefined();
      expect(recipe?.estimatedCost).toBeLessThanOrEqual(2.0 * 1.5); // Allow 50% overage
    });

    it('should respect target calories', () => {
      const recipe = generateRecipe({
        pet: mockDog,
        targetCalories: 400,
      });

      expect(recipe).toBeDefined();
      expect(recipe?.nutrition.kcal).toBeGreaterThan(300);
      expect(recipe?.nutrition.kcal).toBeLessThan(500);
    });

    it('should include health concern alignment in scoring', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe).toBeDefined();
      expect(recipe?.scoreBreakdown.health).toBeGreaterThanOrEqual(0);
      expect(recipe?.scoreBreakdown.health).toBeLessThanOrEqual(100);
    });

    it('should validate nutrition against AAFCO standards', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe).toBeDefined();
      expect(recipe?.validation).toBeDefined();
      expect(recipe?.validation.score).toBeGreaterThanOrEqual(0);
      expect(recipe?.validation.score).toBeLessThanOrEqual(100);
    });

    it('should generate recipe name based on ingredients', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.name).toBeDefined();
      expect(recipe?.name.length).toBeGreaterThan(0);
      expect(recipe?.name).toContain(mockDog.name);
    });

    it('should include instructions', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.instructions).toBeDefined();
      expect(recipe?.instructions.length).toBeGreaterThan(0);
    });

    it('should calculate portion guidance', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.portionGuidance).toBeDefined();
      expect(recipe?.portionGuidance.servingSize).toBeDefined();
      expect(recipe?.portionGuidance.servingsPerDay).toBeDefined();
      expect(recipe?.portionGuidance.dailyCalories).toBeDefined();
    });

    it('should provide scoring explanation', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.explanation).toBeDefined();
      expect(recipe?.explanation.length).toBeGreaterThan(0);
    });
  });

  describe('generateBestRecipe()', () => {
    it('should return a recipe', () => {
      const recipe = generateBestRecipe({ pet: mockDog });

      expect(recipe).toBeDefined();
      expect(recipe?.score).toBeGreaterThanOrEqual(0);
    });

    it('should return highest scoring recipe from multiple attempts', () => {
      const recipe1 = generateRecipe({ pet: mockDog });
      const recipe2 = generateRecipe({ pet: mockDog });
      const best = generateBestRecipe({ pet: mockDog });

      expect(best).toBeDefined();
      if (recipe1 && recipe2) {
        expect(best?.score).toBeGreaterThanOrEqual(Math.min(recipe1.score, recipe2.score));
      }
    });
  });

  describe('generateRecipes()', () => {
    it('should generate multiple recipes', () => {
      const recipes = generateRecipes({ pet: mockDog }, 3);

      expect(recipes.length).toBeGreaterThan(0);
      expect(recipes.length).toBeLessThanOrEqual(3);
    });

    it('should generate diverse recipes', () => {
      const recipes = generateRecipes({ pet: mockDog }, 5);

      expect(recipes.length).toBeGreaterThan(0);

      // Check that recipes have different ingredients
      const ingredientSets = recipes.map(r =>
        new Set(r.ingredients.map(i => i.name.toLowerCase()))
      );

      // At least some recipes should differ
      const allSame = ingredientSets.every(set =>
        set.size === ingredientSets[0].size &&
        [...set].every(ing => ingredientSets[0].has(ing))
      );

      expect(allSame).toBe(false);
    });

    it('should respect count parameter', () => {
      const recipes = generateRecipes({ pet: mockDog }, 2);

      expect(recipes.length).toBeLessThanOrEqual(2);
    });
  });

  describe('Nutrition validation', () => {
    it('should validate protein levels', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.nutrition.protein).toBeGreaterThan(0);
      expect(recipe?.validation.errors.length).toBeLessThanOrEqual(2); // Allow some errors
    });

    it('should validate calcium/phosphorus ratio', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.nutrition.caPRatio).toBeGreaterThan(0);
      // Optimal is 1.0-2.0
      if (recipe?.validation.isValid) {
        expect(recipe.nutrition.caPRatio).toBeGreaterThanOrEqual(0.8);
        expect(recipe.nutrition.caPRatio).toBeLessThanOrEqual(2.5);
      }
    });

    it('should include warnings for suboptimal nutrition', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.validation.warnings).toBeDefined();
      expect(Array.isArray(recipe?.validation.warnings)).toBe(true);
    });
  });

  describe('Scoring breakdown', () => {
    it('should provide all scoring components', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe?.scoreBreakdown).toBeDefined();
      expect(recipe?.scoreBreakdown.nutrition).toBeDefined();
      expect(recipe?.scoreBreakdown.health).toBeDefined();
      expect(recipe?.scoreBreakdown.cost).toBeDefined();
      expect(recipe?.scoreBreakdown.variety).toBeDefined();
      expect(recipe?.scoreBreakdown.quality).toBeDefined();
    });

    it('should weight nutrition heavily in total score', () => {
      const recipe = generateRecipe({ pet: mockDog });

      expect(recipe).toBeDefined();
      // Nutrition is 35% of score, so it should have significant impact
      const nutritionImpact = (recipe?.scoreBreakdown.nutrition || 0) * 0.35;
      expect(nutritionImpact).toBeGreaterThan(0);
    });

    it('should calculate cost efficiency', () => {
      const recipe = generateRecipe({ pet: mockDog, budgetPerMeal: 4.0 });

      expect(recipe?.scoreBreakdown.cost).toBeGreaterThanOrEqual(0);
      expect(recipe?.scoreBreakdown.cost).toBeLessThanOrEqual(100);
    });
  });

  describe('Edge cases', () => {
    it('should handle pet with allergies', () => {
      const petWithAllergies: Pet = {
        ...mockDog,
        allergies: ['chicken', 'beef'],
      };

      const recipe = generateRecipe({ pet: petWithAllergies });

      if (recipe) {
        const ingredientNames = recipe.ingredients.map(i => i.name.toLowerCase());
        expect(ingredientNames).not.toContain('chicken');
        expect(ingredientNames).not.toContain('beef');
      }
    });

    it('should handle pet with health concerns', () => {
      const petWithConcerns: Pet = {
        ...mockDog,
        healthConcerns: ['joint-health', 'weight-management'],
      };

      const recipe = generateRecipe({ pet: petWithConcerns });

      expect(recipe).toBeDefined();
      expect(recipe?.scoreBreakdown.health).toBeGreaterThanOrEqual(0);
    });

    it('should handle very low budget', () => {
      const recipe = generateRecipe({
        pet: mockDog,
        budgetPerMeal: 0.5,
      });

      // Should still generate something or return null gracefully
      if (recipe) {
        expect(recipe.estimatedCost).toBeLessThanOrEqual(0.5 * 2);
      }
    });

    it('should handle very high target calories', () => {
      const recipe = generateRecipe({
        pet: mockDog,
        targetCalories: 2000,
      });

      if (recipe) {
        expect(recipe.nutrition.kcal).toBeGreaterThan(1500);
      }
    });
  });

  describe('Species handling', () => {
    it('should generate recipes for all species', () => {
      const species = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];

      for (const sp of species) {
        const pet: Pet = {
          id: `pet-${sp}`,
          name: `Test ${sp}`,
          type: sp,
          weightKg: 10,
          age: 'adult',
        };

        const recipe = generateRecipe({ pet });

        // Should either generate a recipe or return null (not crash)
        expect(recipe === null || recipe.id).toBeTruthy();
      }
    });
  });
});
</file>

<file path="lib/__tests__/scoreRecipe.test.ts">
import { describe, it, expect } from 'vitest';
import { scoreRecipe } from '../scoreRecipe';

describe('scoreRecipe', () => {
  const mockRecipe = {
    id: '1',
    name: 'Test Recipe',
    category: 'dogs',
    ageGroup: ['adult'],
    breed: ['labrador'],
    healthConcerns: ['joint-health'],
    tags: ['low-calorie'],
    ingredients: [
      { id: '1', name: 'Chicken', amount: '100g' },
      { id: '2', name: 'Rice', amount: '50g' },
    ],
    nutritionalInfo: { protein: 25, fat: 10 },
  };

  const mockPet = {
    id: '1',
    name: 'Buddy',
    type: 'dogs',
    breed: 'labrador',
    age: 'adult',
    healthConcerns: ['joint-health'],
    weightKg: 25,
    weightStatus: 'ideal',
  };

  it('should return high score for perfect match', () => {
    const result = scoreRecipe(mockRecipe as any, mockPet as any);
    expect(result.matchScore).toBeGreaterThan(80);
    expect(result.stars).toBe(5);
    expect(result.reasoning.goodMatches).toContain('Age group match');
    expect(result.reasoning.goodMatches).toContain('Breed-specific match');
    expect(result.reasoning.goodMatches).toContain('Supports joint-health');
  });

  it('should return 0 for wrong species', () => {
    const wrongSpeciesPet = { ...mockPet, type: 'cats' };
    const result = scoreRecipe(mockRecipe as any, wrongSpeciesPet as any);
    expect(result.matchScore).toBe(0);
    expect(result.stars).toBe(1);
    expect(result.reasoning.conflicts).toContain('Different species - not suitable');
  });

  it('should penalize for allergies', () => {
    const allergicPet = { ...mockPet, healthConcerns: ['allergies'], allergies: ['chicken'] };
    const result = scoreRecipe(mockRecipe as any, allergicPet as any);
    expect(result.matchScore).toBe(0);
    expect(result.reasoning.conflicts).toContain('Contains potential allergen: chicken');
  });

  it('should boost for low-calorie tag on overweight pet', () => {
    const overweightPet = { ...mockPet, weightStatus: 'overweight' };
    const result = scoreRecipe(mockRecipe as any, overweightPet as any);
    expect(result.reasoning.goodMatches).toContain('Low-calorie fit for weight control');
  });

  it('should handle missing nutrition info', () => {
    const noNutritionRecipe = { ...mockRecipe, nutritionalInfo: undefined };
    const result = scoreRecipe(noNutritionRecipe as any, mockPet as any);
    expect(result.matchScore).toBeLessThan(100);
  });
});
</file>

<file path="lib/analyzeCustomMeal.ts">
// lib/analyzeCustomMeal.ts

// Gamified custom meal analysis engine for PetPlates

// - Exports generateCustomMealAnalysis(petProfile, selections)

// - Returns a pet-specific, gamified MealAnalysis (score 0..100)

// - Uses INGREDIENT_COMPOSITIONS for per-100g nutrient values

//

// Replace / extend species rules with your canonical FEDIAF/AAFCO tables when ready.

import { INGREDIENT_COMPOSITIONS, type IngredientComposition } from '@/lib/data/ingredientCompositions';
import { getIngredientDisplayName } from '@/lib/utils/allIngredients';

export type Species =
  | 'dog'
  | 'cat'
  | 'bearded-dragon'
  | 'parrot'
  | 'guinea-pig'
  | 'hamster'
  | string;

export type PetProfile = {
  id?: string;
  name?: string;
  species: Species;
  lifeStage?: string; // e.g., 'adult', 'juvenile', 'pregnant'
  weightKg?: number;
  allergies?: string[]; // ingredient keys or names
  meds?: string[]; // medication identifiers (optional)
  activity?: 'low' | 'moderate' | 'high';
};

export type IngredientSelection = {
  key: string; // composition key or display name (we attempt mapping)
  grams: number;
};

export type WarningItem = {
  id?: string;
  ingredientKey?: string;
  ingredientName?: string;
  message: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
};

export type Suggestion = {
  message: string;
  action?: string; // e.g., "add_calcium", "reduce_liver", "swap_to_bsfl"
  confidence?: 'low' | 'medium' | 'high';
};

export type MealAnalysis = {
  nutrients: Record<string, number>; // totals for entire serving analyzed (mg/g units per chosen keys)
  totalRecipeGrams: number;
  energyDensityKcalPerGram: number;
  recommendedServingGrams: number;
  score: number; // 0..100 gamified
  breakdown: {
    nutrientCoverageScore: number; // 0..100
    toxicityPenalty: number; // 0..100 (penalty applied)
    balanceVarietyScore: number; // 0..100
  };
  toxicityWarnings: WarningItem[];
  allergyWarnings: WarningItem[];
  nutrientWarnings: WarningItem[]; // deficiencies / excesses
  suggestions: Suggestion[];
  // Legacy fields for backward compatibility
  dmNutrients?: Record<string, number>;
  dryMatterPercent?: number;
  totalWeight_g?: number;
  caToPratio?: number;
  deficiencies?: string[];
  excesses?: string[];
  adequacies?: string[];
  scoreBreakdown?: {
    baseScore?: number;
    nutritionPenalty?: number;
    balancePenalty?: number;
  };
};

// ---------- Helper accesses ----------

function safeGetIngredient(key: string) {
  // Try direct key then fallback to slugified match by name
  const direct = (INGREDIENT_COMPOSITIONS as Record<string, any>)[key];
  if (direct) return direct;
  
  const slug = key.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
  const bySlug = (INGREDIENT_COMPOSITIONS as Record<string, any>)[slug];
  if (bySlug) return bySlug;
  
  // Try name match
  const values = Object.values(INGREDIENT_COMPOSITIONS) as any[];
  const found = values.find(v => (v.name || '').toLowerCase() === key.toLowerCase());
  if (found) return found;
  
  // Common fallback mappings for missing ingredients
  const fallbackMappings: Record<string, string> = {
    'salmon_oil': 'fish_oil',
    'herring_oil': 'fish_oil',
    'mackerel_oil': 'fish_oil',
    'sardine_oil': 'fish_oil',
    'cod_liver_oil': 'fish_oil',
    'olive_oil': 'fish_oil',
    'coconut_oil': 'fish_oil',
    'avocado_oil': 'fish_oil',
    'ground_chicken': 'chicken_breast',
    'ground_turkey': 'turkey_breast',
    'ground_beef': 'ground_beef_lean',
    'white_rice': 'brown_rice_cooked',
    'pumpkin_puree': 'sweet_potato',
  };
  
  const fallback = fallbackMappings[slug] || fallbackMappings[key.toLowerCase()];
  if (fallback && (INGREDIENT_COMPOSITIONS as Record<string, any>)[fallback]) {
    return (INGREDIENT_COMPOSITIONS as Record<string, any>)[fallback];
  }
  
  // Return a minimal placeholder instead of throwing - allows scoring to continue
  // Ingredient not found in composition DB - using placeholder
  return {
    protein: 0,
    fat: 0,
    calcium: 0,
    phosphorus: 0,
    moisture: 0,
    kcal: 0,
    name: key
  };
}

// ---------- Basic nutrition math ----------
  
function sumRecipeTotals(selections: IngredientSelection[]) {
  const totals: Record<string, number> = {};
  let totalGrams = 0;
  const ingredientsNotFound: string[] = []; // Track ingredients not in DB
  
  for (const sel of selections) {
    if (!sel || !sel.key || !sel.grams || sel.grams <= 0) continue;
    
    const ing = safeGetIngredient(sel.key);
    
    // Track if ingredient was found in DB (placeholder has name === 'Unknown')
    if (ing.name === 'Unknown' || !ing.name) {
      ingredientsNotFound.push(sel.key);
    }
    
    const factor = sel.grams / 100;
    totalGrams += sel.grams;

    // Map ingredient composition properties to standard nutrient keys
    // Current structure: { protein, fat, calcium, phosphorus, moisture, kcal, etc. }
    // Map to: { protein_g, fat_g, ca_mg, p_mg, moisture_g, calories_kcal, etc. }
    
    const mappings: Record<string, string> = {
      'protein': 'protein_g',
      'fat': 'fat_g',
      'calcium': 'ca_mg',
      'phosphorus': 'p_mg',
      'moisture': 'moisture_g',
      'kcal': 'calories_kcal',
      'omega3': 'omega3_g',
      'vitaminA': 'vit_a_IU',
      'vitaminC': 'vit_c_mg',
      'taurine': 'taurine_mg',
      'fiber': 'fiber_g',
      'carbs': 'carbs_g',
    };
    
    // Try per100g structure first (new format)
    const per100g = (ing as any).per100g || (ing as any).per100g_raw || (ing as any).per100gData;
    if (per100g && typeof per100g === 'object') {
      for (const [k, v] of Object.entries(per100g)) {
        if (typeof v === 'number') {
          const mappedKey = mappings[k] || k;
          totals[mappedKey] = (totals[mappedKey] ?? 0) + v * factor;
        }
      }
    } else {
      // Use direct properties (current format in ingredientCompositions.ts)
      for (const [key, mappedKey] of Object.entries(mappings)) {
        const value = (ing as any)[key];
        if (typeof value === 'number') {
          totals[mappedKey] = (totals[mappedKey] ?? 0) + value * factor;
        }
      }
      
      // Also handle direct property access for any other numeric fields
      for (const [k, v] of Object.entries(ing)) {
        if (k !== 'source' && k !== 'name' && typeof v === 'number' && !mappings[k]) {
          // Preserve original key if not in mappings
          totals[k] = (totals[k] ?? 0) + v * factor;
        }
      }
    }
  }

  return { totals, totalGrams, ingredientsNotFound };
}

function computeEnergyDensityKcalPerGram(nutrients: Record<string, number>) {
  // Expect calories_kcal total per recipe -> kcal per gram
  const kcalTotal = nutrients['calories_kcal'] ?? nutrients['energy_kcal'] ?? 0;
  return kcalTotal;
}

// ---------- Pet energy target (simple, adjustable) ----------

function computeDailyKcalTarget(pet: PetProfile) {
  const weight = Math.max(0.1, pet.weightKg ?? 5);

  // Use simplified MER approximations (not authoritative; replace with FEDIAF/AFFCO later)
  let factor = 1.6; // default moderate
  if (pet.activity === 'low') factor = 1.3;
  if (pet.activity === 'high') factor = 2.0;

  switch ((pet.species || '').toLowerCase()) {
    case 'dog':
      // RER = 70 * kg^0.75, MER ~ RER * factor
      return Math.round(70 * Math.pow(weight, 0.75) * factor);
    case 'cat':
      // cats: more kcal/kg (approx)
      return Math.round(50 * Math.pow(weight, 0.75) * factor);
    case 'bearded-dragon':
      // reptiles: single feeding approach, use simpler target scaled to small kg
      return Math.round(30 * weight * (pet.activity === 'high' ? 1.5 : 1.0));
    case 'guinea-pig':
      return Math.round(80 * weight); // placeholder
    default:
      return Math.round(60 * Math.pow(weight, 0.75));
  }
}

// ---------- Species-specific quick checks ----------

function normalizeSpecies(species: string): 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet' | string {
  const s = (species || '').toLowerCase();
  if (s.includes('dog')) return 'dog';
  if (s.includes('cat')) return 'cat';
  if (s.includes('bird') || s.includes('parrot') || s.includes('finch')) return 'bird';
  if (s.includes('reptile') || s.includes('lizard') || s.includes('bearded') || s.includes('dragon')) return 'reptile';
  if (s.includes('pocket') || s.includes('rabbit') || s.includes('guinea') || s.includes('hamster') || s.includes('gerbil')) return 'pocket-pet';
  return s;
}

function checkToxicityAndAllergies(
  pet: PetProfile,
  selections: IngredientSelection[],
  totalGrams: number,
): { toxicityWarnings: WarningItem[]; allergyWarnings: WarningItem[]; inclusionWarnings: WarningItem[] } {
  const tox: WarningItem[] = [];
  const allergy: WarningItem[] = [];
  const inclusion: WarningItem[] = [];
  const petAllergiesLower = (pet.allergies || []).map(a => a.toLowerCase());
  const normalizedSpecies = normalizeSpecies(pet.species || '');
  
  for (const sel of selections) {
    try {
      const ing = safeGetIngredient(sel.key);
      // FIXED: Use original ingredient name for display, not composition key
      // This ensures warnings show "bok choi" not "kale_raw"
      const displayName = getIngredientDisplayName(sel.key) || sel.key;
      const ingPercent = totalGrams > 0 ? (sel.grams / totalGrams) : 0;

      // Check species compatibility (NEW)
      if (ing.speciesCompatibility && normalizedSpecies) {
        const compat = ing.speciesCompatibility[normalizedSpecies as keyof typeof ing.speciesCompatibility];
        if (compat === 'avoid') {
          tox.push({
            ingredientKey: sel.key,
            ingredientName: displayName,
            message: `${displayName} should be avoided for ${pet.species}. ${ing.notesBySpecies?.[normalizedSpecies as keyof typeof ing.notesBySpecies] || ''}`,
            severity: 'critical',
          });
        } else if (compat === 'limit') {
          tox.push({
            ingredientKey: sel.key,
            ingredientName: displayName,
            message: `${displayName} should be limited for ${pet.species}. ${ing.notesBySpecies?.[normalizedSpecies as keyof typeof ing.notesBySpecies] || ''}`,
            severity: 'medium',
          });
        } else if (compat === 'caution') {
          tox.push({
          ingredientKey: sel.key,
            ingredientName: displayName,
            message: `${displayName} requires caution for ${pet.species}. ${ing.notesBySpecies?.[normalizedSpecies as keyof typeof ing.notesBySpecies] || ''}`,
            severity: 'low',
          });
        }
      }

      // Check max inclusion percentage (NEW)
      if (ing.maxInclusionPercentBySpecies && normalizedSpecies && totalGrams > 0) {
        const maxPercent = ing.maxInclusionPercentBySpecies[normalizedSpecies as keyof typeof ing.maxInclusionPercentBySpecies];
        if (maxPercent !== undefined && ingPercent > maxPercent) {
          const overage = ((ingPercent - maxPercent) * 100).toFixed(1);
          inclusion.push({
            ingredientKey: sel.key,
            ingredientName: displayName,
            message: `${displayName} exceeds recommended maximum (${(maxPercent * 100).toFixed(0)}% of meal). Currently ${(ingPercent * 100).toFixed(1)}% (+${overage}%). ${ing.notesBySpecies?.[normalizedSpecies as keyof typeof ing.notesBySpecies] || ''}`,
            severity: ingPercent > maxPercent * 1.5 ? 'high' : 'medium',
          });
        }
      }

      // Legacy toxicity check
      if (ing.toxicFor && Array.isArray(ing.toxicFor)) {
        const affectsPet = ing.toxicFor.map((s: string) => s.toLowerCase()).includes(normalizedSpecies) || ing.toxicFor.includes('all');
        if (affectsPet) {
          tox.push({
            ingredientKey: sel.key,
            ingredientName: displayName,
            message: `${displayName} flagged as potentially toxic/contraindicated for ${pet.species}`,
            severity: (ing.toxicSeverity as any) ?? 'high',
          });
        }
      }

      // User allergies
      if (petAllergiesLower.length > 0) {
        const nameLower = displayName.toLowerCase();
        for (const a of petAllergiesLower) {
          if (nameLower.includes(a) || sel.key.toLowerCase().includes(a)) {
            allergy.push({
              ingredientKey: sel.key,
              ingredientName: displayName,
              message: `${displayName} matches pet allergy "${a}"`,
              severity: 'high',
            });
          }
        }
      }
    } catch (e) {
      // ignore missing compositions (should be validated earlier)
    }
  }

  return { toxicityWarnings: tox, allergyWarnings: allergy, inclusionWarnings: inclusion };
}

// ---------- Nutrient checks & simple coverage scoring (gamified) ----------

function speciesKey(p: PetProfile) {
  const raw = (p.species || 'unknown').toLowerCase();
  if (raw.includes('pocket') || raw.includes('hamster') || raw.includes('guinea')) return 'pocket-pet';
  if (raw.includes('bird') || raw.includes('parrot')) return 'bird';
  if (raw.includes('reptile') || raw.includes('dragon')) return 'bearded-dragon';
  if (raw.includes('cat')) return 'cat';
  if (raw.includes('dog')) return 'dog';
  return raw;
}

// ---------- Fixed Nutrient checks & lenient coverage scoring ----------

function computeNutrientCoverageAndWarnings(
  pet: PetProfile,
  totals: Record<string, number>,
  totalGrams: number,
  recommendedServingGrams?: number, // NEW: Use recommended serving for warnings
) {
  // Nutritional warnings have been removed - return empty array
  // Keep coverage scores for scoring purposes only
  const warnings: WarningItem[] = [];
  const coverageScores: Record<string, number> = {}; // 0..1 for each tracked nutrient

  const species = speciesKey(pet);

  // Calculate coverage scores for scoring purposes only (no warnings generated)
  const servingGrams = recommendedServingGrams && recommendedServingGrams > 0 
    ? recommendedServingGrams 
    : totalGrams;
  
  // Scale nutrients to per-serving values
  const servingRatio = totalGrams > 0 ? servingGrams / totalGrams : 1;
  const prot = (totals['protein_g'] ?? 0) * servingRatio;
  const fat = (totals['fat_g'] ?? 0) * servingRatio;
  const fiber = (totals['fiber_g'] ?? 0) * servingRatio;
  const ca = (totals['ca_mg'] ?? 0) * servingRatio;
  const p = (totals['p_mg'] ?? 0) * servingRatio;
  const taurine = (totals['taurine_mg'] ?? 0) * servingRatio;

  const targetsBySpecies: Record<string, Record<string, number>> = {
    dog: {
      protein_per_100g: 5,
      fat_per_100g: 2,
      fiber_per_100g: 0.5,
    },
    cat: {
      protein_per_100g: 8,
      fat_per_100g: 3,
      taurine_per_100g: 20,
    },
    'bearded-dragon': {
      ca_p_ratio: 1.0,
      ca_per_100g: 100,
    },
    'guinea-pig': {
      vit_c_per_kg: 5,
    },
    'pocket-pet': {
      protein_per_100g: 4,
      fat_per_100g: 1.2,
      fiber_per_100g: 1.2,
      ca_per_100g: 80,
      p_per_100g: 40,
      ca_p_ratio: 1.5,
    },
    bird: {
      protein_per_100g: 4,
      fat_per_100g: 1.5,
      fiber_per_100g: 0.8,
    },
  };

  const gramsPer100 = servingGrams / 100 || 1;
  const selectedTargets = targetsBySpecies[species] || targetsBySpecies['dog'];

  if (selectedTargets) {
    const t = selectedTargets;

    if (t.protein_per_100g) {
      const expectedProtein = t.protein_per_100g * gramsPer100;
      const ratio = prot / Math.max(1, expectedProtein);
      coverageScores['protein'] = Math.min(1.5, ratio);
    }

    if (t.fat_per_100g) {
      const expectedFat = t.fat_per_100g * gramsPer100;
      const ratio = fat / Math.max(0.1, expectedFat);
      coverageScores['fat'] = Math.min(1.5, ratio);
    }

    if (t.fiber_per_100g) {
      const expectedFiber = t.fiber_per_100g * gramsPer100;
      const ratio = fiber / Math.max(0.1, expectedFiber);
      coverageScores['fiber'] = Math.min(1.2, ratio);
    }

    if (species === 'cat' && t.taurine_per_100g) {
      const expectedTaurine = t.taurine_per_100g * gramsPer100;
      const ratio = taurine / Math.max(1, expectedTaurine);
      coverageScores['taurine'] = Math.min(1.5, ratio);
    }

    if (species === 'bearded-dragon' && typeof p === 'number' && p > 0) {
      const ratio = ca / p;
      const desired = t.ca_p_ratio;
      coverageScores['ca_p'] = Math.min(1.2, (ratio / desired) * 1.2);
    }
  }

  return { coverageScores, warnings };
}

// ---------- FIXED Scoring model (more generous) ----------

function calculateGamifiedScore(
  pet: PetProfile,
  totals: Record<string, number>,
  totalGrams: number,
  toxicityWarnings: WarningItem[],
  allergyWarnings: WarningItem[],
  nutrientWarnings: WarningItem[],
  ingredientsNotFound?: string[],
  totalIngredientCount?: number,
) {
  const { coverageScores } = computeNutrientCoverageAndWarnings(pet, totals, totalGrams);

  const keys = Object.keys(coverageScores);
  const foundIngredientCount = (totalIngredientCount || 0) - (ingredientsNotFound?.length || 0);
  let avgCoverage = 0;
  const presentCats = new Set<string>();
  if ((totals['protein_g'] ?? 0) > 0) presentCats.add('protein');
  if ((totals['fiber_g'] ?? 0) > 0 || (totals['ca_mg'] ?? 0) > 0) presentCats.add('greens');
  if ((totals['carbs_g'] ?? 0) > 0) presentCats.add('carbs');
  if ((totals['fat_g'] ?? 0) > 0) presentCats.add('fat');
  
  if (keys.length > 0) {
    const totalCoverage = Object.values(coverageScores).reduce((a, b) => a + b, 0);
    // FIXED: If some ingredients found, don't penalize as much - align with recipe scoring generosity
    // Recipe scoring gives 50 base + bonuses, so custom meals should be similarly generous
    if (foundIngredientCount > 0) {
      // If we have coverage data, use it (but be generous)
      // If some ingredients missing, still give good score (like recipe scoring does)
      const baseCoverage = totalCoverage / keys.length;
      avgCoverage = ingredientsNotFound && ingredientsNotFound.length > 0 
        ? Math.max(0.75, baseCoverage) // At least 75% if some ingredients found
        : Math.max(0.8, baseCoverage); // Prefer to floor higher when coverage present
    } else {
      avgCoverage = 0.6; // No ingredients found in DB but had coverage map
    }
  } else {
    // More dynamic fallback when we don't have coverage data
    const catCount = presentCats.size;
    if (catCount >= 3) avgCoverage = 0.92;
    else if (catCount === 2) avgCoverage = 0.85;
    else if (catCount === 1) avgCoverage = 0.72;
    else avgCoverage = foundIngredientCount > 0 ? 0.6 : 0.5;
  }
  
  const nutrientCoverageScore = Math.min(100, Math.round(avgCoverage * 100));

  // FIXED: Less harsh toxicity penalties
  let toxPenaltyRaw = 0;
  for (const t of toxicityWarnings) {
    if (t.severity === 'critical' || t.severity === 'high') toxPenaltyRaw += 30; // FIXED: Was 40
    else if (t.severity === 'medium') toxPenaltyRaw += 15; // FIXED: Was 20
    else toxPenaltyRaw += 5; // FIXED: Was 8
  }
  for (const a of allergyWarnings) {
    toxPenaltyRaw += 40; // FIXED: Was 50 (still heavy but not instant kill)
  }
  const toxicityPenalty = Math.min(100, toxPenaltyRaw);

  // FIXED: Give full credit for 2+ categories (most meals have protein + carbs or protein + greens)
  // This aligns with recipe scoring which doesn't require all categories
  const varietyScore = presentCats.size >= 2 ? 1.0 : (presentCats.size / 2); // Full credit at 2+
  const balanceVarietyScore = Math.round(varietyScore * 100);

  // FIXED: Better base score calculation - align with recipe scoring
  // Recipe scoring: 50 base + 15 age + 15 health + 15 nutrition = 95 (very generous)
  // Custom meals should be similarly generous, so weight nutrient coverage more
  const base = Math.max(60, Math.round(nutrientCoverageScore * 0.8 + balanceVarietyScore * 0.2));

  // FIXED: Cap penalty at 40% of base score (more generous than before)
  // Recipe scoring rarely goes below 30, so custom meals should be similar
  const maxPenalty = Math.round(base * 0.4);
  const penaltyApplied = Math.min(maxPenalty, Math.round((toxicityPenalty / 100) * base));
  
  const finalScore = Math.max(20, base - penaltyApplied);
  
  return {
    nutrientCoverageScore,
    toxicityPenalty,
    balanceVarietyScore,
    finalScore,
    base,
    penaltyApplied,
  };
}

// ---------- Suggestion generator (concrete, gamified) ----------

function generatePetSpecificSuggestions(
  pet: PetProfile,
  totals: Record<string, number>,
  totalGrams: number,
  toxicityWarnings: WarningItem[],
  allergyWarnings: WarningItem[],
) {
  const suggestions: Suggestion[] = [];
  const species = speciesKey(pet);

  // If cat and taurine low
  if (species === 'cat') {
    const taurine = totals['taurine_mg'] ?? 0;
    const gramsPer100 = Math.max(1, totalGrams / 100);
    const expectedTaurinePerBatch = 50 * gramsPer100; // placeholder desired mg per batch
    if (taurine < expectedTaurinePerBatch * 0.75) {
      suggestions.push({
        message: 'Taurine is low ‚Äî add 0.1g taurine supplement per 100g serving or include more heart/liver.',
        action: 'add_taurine',
        confidence: 'high',
      });
    }
  }

  // Bearded dragon Ca:P
  if (species === 'bearded-dragon') {
    const ca = totals['ca_mg'] ?? 0;
    const p = totals['p_mg'] ?? 0;
    const ratio = p === 0 ? 0 : ca / p;
    if (ratio < 1.5) {
      // compute delta
      const desiredCa = 1.5 * (p || 1);
      const deltaMg = Math.max(0, desiredCa - ca);
      // grams CaCO3 (400 mg elemental Ca per 1 g CaCO3)
      const gramsCaCO3 = +(deltaMg / 400).toFixed(2);
      suggestions.push({
        message: `Ca:P low (${ratio.toFixed(2)}). Add ~${gramsCaCO3} g calcium carbonate per batch to improve ratio.`,
        action: 'add_calcium',
        confidence: 'high',
      });
    }
  }

  // Guinea pig vitamin C
  if (species === 'guinea-pig') {
    const vitC = totals['vit_c_mg'] ?? 0;
    const weight = pet.weightKg ?? 1;
    const required = 10 * weight; // mg/day placeholder
    if (vitC < required) {
      suggestions.push({
        message: `Vitamin C seems low for this guinea pig. Aim to include vitamin C rich greens or a supplement (target ~${required} mg/day).`,
        action: 'add_vitC',
        confidence: 'medium',
      });
    }
  }

  // Generic: if liver present and vit A high risk
  if ((totals['vit_a_IU'] ?? 0) > 50000) {
    suggestions.push({
      message: 'Batch contains large amounts of vitamin A (from liver). Rotate liver less frequently to avoid excess vitamin A.',
      action: 'reduce_liver_frequency',
      confidence: 'high',
    });
  }

  // Toxicity-driven suggestion examples
  for (const t of toxicityWarnings) {
    // FIXED: Use ingredientName (display name) instead of ingredientKey (composition key)
    const ingDisplayName = t.ingredientName || t.ingredientKey || 'this ingredient';
    suggestions.push({
      message: `Consider removing or reducing ${ingDisplayName}: ${t.message}`,
      action: 'remove_toxic',
      confidence: t.severity === 'high' ? 'high' : 'medium',
    });
  }

  for (const a of allergyWarnings) {
    suggestions.push({
      message: `Ingredient flagged for allergy: ${a.message}. Replace with hypoallergenic alternative (duck, rabbit, or novel protein).`,
      action: 'replace_allergen',
      confidence: 'high',
    });
  }

  // Variety suggestion: if only 1 category present
  const presentCats = new Set<string>();
  if ((totals['protein_g'] ?? 0) > 0) presentCats.add('protein');
  if ((totals['fiber_g'] ?? 0) > 0 || (totals['ca_mg'] ?? 0) > 0) presentCats.add('greens');
  if ((totals['carbs_g'] ?? 0) > 0) presentCats.add('carbs');
  if ((totals['fat_g'] ?? 0) > 0) presentCats.add('fat');

  if (presentCats.size <= 1) {
    suggestions.push({
      message: 'This batch is dominated by a single category. Add a vegetable or healthy fat for balance.',
      action: 'add_variety',
      confidence: 'low',
    });
  }
  
  return suggestions;
}

// ---------- Recommended serving calculation ----------

function computeRecommendedServingGrams(nutrients: Record<string, number>, totalGrams: number, pet: PetProfile) {
  const kcalTotal = nutrients['calories_kcal'] ?? nutrients['energy_kcal'] ?? 0;
  if (kcalTotal <= 0 || totalGrams <= 0) return 0;

  const kcalPerGram = kcalTotal / totalGrams;
  const dailyKcal = computeDailyKcalTarget(pet);

  // meals per day default
  const mealsPerDay = pet.species?.toLowerCase() === 'cat' ? 3 : 2;
  const targetMealKcal = Math.max(40, Math.round(dailyKcal / mealsPerDay)); // lower bound guard
  const serving = Math.round(targetMealKcal / kcalPerGram);

  // Safety cap: do not recommend more than 50% daily kcal in one serving
  const maxSingleMealKcal = Math.max(targetMealKcal * 2, Math.round(dailyKcal * 0.5));
  if (serving * kcalPerGram > maxSingleMealKcal) {
    return Math.round(maxSingleMealKcal / kcalPerGram);
  }

  return Math.max(0, serving);
}

// ---------- Public API: generateCustomMealAnalysis ----------

/**
 * Analyzes a custom meal composition for a specific pet profile.
 * 
 * Calculates nutritional totals, checks for toxicity/allergies, computes compatibility score (0-100),
 * and provides recommendations for improvement.
 * 
 * @param petProfile - Pet profile with species, life stage, weight, allergies, activity level
 * @param selections - Array of ingredient selections with keys (composition keys) and grams
 * @returns MealAnalysis with nutrients, score, warnings, suggestions, and recommended serving size
 * 
 * @example
 * ```ts
 * const analysis = generateCustomMealAnalysis(
 *   { species: 'dog', lifeStage: 'adult', weightKg: 20 },
 *   [{ key: 'chicken_breast', grams: 200 }, { key: 'brown_rice_cooked', grams: 100 }]
 * );
 * console.log(analysis.score); // 85
 * console.log(analysis.recommendedServingGrams); // 350
 * ```
 * 
 * @contract
 * - Input: PetProfile (from localStorage/backend), IngredientSelection[] (from UI)
 * - Output: MealAnalysis with standardized structure
 * - Side effects: None (pure function)
 * - Migration: Compatible with Firebase/Supabase (receives objects, not storage)
 * - Ingredient keys: Must match INGREDIENT_COMPOSITIONS keys (auto-mapped via safeGetIngredient)
 */
export function generateCustomMealAnalysis(petProfile: PetProfile, selections: IngredientSelection[]): MealAnalysis {
  // Defensive: ensure selections are valid
  const safeSelections = (selections || []).filter(s => s && s.key && s.grams && s.grams > 0);
  const { totals, totalGrams, ingredientsNotFound } = sumRecipeTotals(safeSelections);
  
  // Log ingredients not found in DB
  if (ingredientsNotFound && ingredientsNotFound.length > 0) {
    console.warn('Ingredients not found in composition DB:', ingredientsNotFound);
  }

  // Compute energy density
  const kcalTotal = totals['calories_kcal'] ?? totals['energy_kcal'] ?? 0;
  const energyDensity = totalGrams > 0 ? kcalTotal / totalGrams : 0;

  // Toxicity & allergies
  const { toxicityWarnings, allergyWarnings, inclusionWarnings } = checkToxicityAndAllergies(petProfile, safeSelections, totalGrams);

  // Suggested serving (calculate early so we can use it for warnings)
  const recommendedServingGrams = computeRecommendedServingGrams(totals, totalGrams, petProfile);

  // Nutrient warnings from species heuristics (now uses recommended serving size)
  const { coverageScores } = computeNutrientCoverageAndWarnings(petProfile, totals, totalGrams, recommendedServingGrams);

  // Nutritional warnings have been removed - return empty array
  const nutrientWarnings: WarningItem[] = [];

  // Scoring (pass ingredientsNotFound for better scoring)
  const scoreInfo = calculateGamifiedScore(petProfile, totals, totalGrams, toxicityWarnings, allergyWarnings, nutrientWarnings, ingredientsNotFound, safeSelections.length);

  // Suggestions
  const suggestions = generatePetSpecificSuggestions(petProfile, totals, totalGrams, toxicityWarnings, allergyWarnings);

  // Calculate Ca:P ratio for legacy compatibility
  const ca = totals['ca_mg'] ?? 0;
  const p = totals['p_mg'] ?? 0;
  const caToPratio = p > 0 ? ca / p : undefined;

  // Legacy compatibility fields
  const dmNutrients: Record<string, number> = {};
  const moisture = totals['moisture_g'] ?? 0;
  const dryMatter = totalGrams - moisture;
  const dryMatterPercent = totalGrams > 0 ? (dryMatter / totalGrams) * 100 : 0;

  if (dryMatter > 0) {
    for (const [key, value] of Object.entries(totals)) {
      if (key !== 'moisture_g') {
        dmNutrients[`${key}_percent`] = (value / dryMatter) * 100;
      }
    }
  }

  // Convert nutrientWarnings to legacy deficiencies/excesses format
  // (empty since warnings have been removed)
  const deficiencies: string[] = [];
  const excesses: string[] = [];

  // Final MealAnalysis object
  const analysis: MealAnalysis = {
    nutrients: totals,
    totalRecipeGrams: totalGrams,
    energyDensityKcalPerGram: energyDensity,
    recommendedServingGrams,
    score: scoreInfo.finalScore,
    breakdown: {
      nutrientCoverageScore: scoreInfo.nutrientCoverageScore,
      toxicityPenalty: scoreInfo.toxicityPenalty,
      balanceVarietyScore: scoreInfo.balanceVarietyScore,
    },
      toxicityWarnings,
      allergyWarnings,
    nutrientWarnings,
    suggestions,
    // Legacy compatibility fields
    dmNutrients,
    dryMatterPercent,
    totalWeight_g: totalGrams,
    caToPratio,
      deficiencies,
      excesses,
    adequacies: coverageScores['protein'] > 0.8 && coverageScores['fat'] > 0.8 ? ['Protein and fat levels look adequate'] : [],
      scoreBreakdown: {
      baseScore: scoreInfo.base,
      nutritionPenalty: scoreInfo.penaltyApplied,
        balancePenalty: 0,
      },
    };

  return analysis;
}
</file>

<file path="lib/applyModifiers.ts">
import type { Recipe, ModifiedRecipeResult, PetNutritionProfile, PortionPlan, ShoppingListItem, WeeklyPlanEntry, AppliedModifierSummary } from './types';
import { dogModifiers } from './data/nutrition-dog-modifiers';
import { catModifiers } from './data/nutrition-cat-modifiers';
import { scoreRecipeImproved } from './scoreRecipe';
import { getPortionPlan } from './portionCalc';
import { scaleAmount } from './portionCalc';
import { getVettedProduct, getAllAffiliateLinks, getGenericIngredientName } from './data/vetted-products'; // <--- UPDATED to use expanded vetted products with commission optimization
import { matchesSpecies } from './utils/recipeRecommendations';

interface ApplyModifiersResult {
  modifiedRecipe: Recipe;
  addedIngredients: Array<{
    name: string;
    benefit: string;
    amazon: string;
    forConcern: string;
  }>;
}

const concernToModifierKey: Record<string, string> = {
  allergies: 'allergies',
  'joint-health': 'joint_issues',
  'weight-management': 'weight_management',
  digestive: 'gi_issues',
  'gi-issues': 'gi_issues',
  'kidney': 'kidney_support',
  'kidney/urinary-support': 'kidney_support',
  'urinary-health': 'urinary_health',
  diabetes: 'diabetes',
  'skin-coat': 'allergies', // approximate
};

const formatIngredientNameForDisplay = (value: string): string => {
  return String(value)
    .trim()
    .replace(/[-_]+/g, ' ')
    .split(' ')
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
};

export function applyModifiers(recipe: Recipe, pet: any): ApplyModifiersResult & { conflictCount: number; hasHydrationSupport: boolean } {
  const modifiers = pet.type === 'dogs' ? dogModifiers : pet.type === 'cats' ? catModifiers : {};
  const modifiedRecipe: Recipe = JSON.parse(JSON.stringify(recipe)); // Deep clone to modify

  let addedIngredients: ApplyModifiersResult['addedIngredients'] = [];
  let conflictCount = 0;
  let hasHydrationSupport = false;

  // 1. Apply Health Concern Modifiers (Supplements/Additions)
  // Import normalizeHealthConcernForMatching from scoreRecipe (or define locally)
  const normalizeConcern = (c: string): string => {
    const normalized = c.toLowerCase().trim();
    // Map human-readable to normalized format
    const mapping: Record<string, string> = {
      'arthritis/joint pain': 'joint-health',
      'joint pain': 'joint-health',
      'arthritis': 'joint-health',
      'obesity/weight management': 'weight-management',
      'obesity': 'weight-management',
      'weight management': 'weight-management',
      'kidney disease': 'kidney-disease',
      'kidney': 'kidney-disease',
      'urinary problems': 'urinary-health',
      'urinary tract issues': 'urinary-health',
      'dental problems': 'dental-issues',
      'dental disease': 'dental-issues',
      'digestive issues': 'digestive-issues',
      'allergies/skin issues': 'allergies',
      'skin issues': 'allergies',
    };
    return mapping[normalized] || normalized.replace(/[^a-z0-9]+/g, '-');
  };

  for (const concern of pet.healthConcerns || []) {
    const normalizedConcern = normalizeConcern(concern);
    const modKey = concernToModifierKey[normalizedConcern] || concernToModifierKey[concern.toLowerCase()];
    if (modKey && (modifiers as any)[modKey]) {
      const modifier = (modifiers as any)[modKey];

      // Add supplements required by the modifier
      for (const supplement of modifier.add) {
        // Check if there's a vetted product for this supplement (pass pet.type for species filtering, preferBudget=true for cost control)
        const vettedProduct = getVettedProduct(supplement.name, pet.type, true);
        addedIngredients.push({
          name: supplement.name,
          benefit: supplement.benefit,
          amazon: vettedProduct?.asinLink || supplement.amazon, // Use vetted ASIN link if available
          forConcern: concern,
        });
      }

      // Check for conflicts (already handled in scoreRecipe, but kept for full loop)
      const ingredientText = (recipe.ingredients || []).map((i) => i.name.toLowerCase()).join(' ');
      for (const avoid of modifier.avoid) {
          if (ingredientText.includes(avoid.toLowerCase())) {
            conflictCount += 1; // Track conflicts
          }
      }

      // Check for hydration support
      if (concern.includes('kidney') || concern.includes('urinary')) {
          hasHydrationSupport = true;
      }
    }
  }

  // 2. Map Ingredients to Vetted Products (The core fix)
  // This is the new logic that replaces generic ingredients with specific vetted products
  modifiedRecipe.ingredients = modifiedRecipe.ingredients.map(ing => {
    const genericKey = getGenericIngredientName(ing.name);
    const genericName = genericKey ? formatIngredientNameForDisplay(genericKey) : ing.name;
    // Pass pet.type for species-aware product matching, preferBudget=true for cost control
    const vettedProduct = getVettedProduct(genericName, pet.type, true);
    if (vettedProduct) {
        // Overwrite the generic ingredient details with the Vetted Product details
        return {
            ...ing,
            name: genericName,
            productName: vettedProduct.productName,
            asinLink: vettedProduct.asinLink,
            notes: (ing as any).notes ? `${(ing as any).notes} | VET NOTE: ${vettedProduct.vetNote}` : `VET NOTE: ${vettedProduct.vetNote}`,
        };
    }
    // If no vetted product, remove asinLink to ensure only vetted products have buy links
    return {
      ...ing,
      asinLink: undefined,
    };
  });

  // 3. Map Supplements to Vetted Products (ensure all buy links are vetted)
  if ((modifiedRecipe as any).supplements) {
    (modifiedRecipe as any).supplements = (modifiedRecipe as any).supplements.map((supplement: any) => {
      const genericKey = getGenericIngredientName(supplement.name);
      const genericName = genericKey ? formatIngredientNameForDisplay(genericKey) : supplement.name;
      // Pass pet.type for species-aware product matching, preferBudget=true for cost control
      const vettedProduct = getVettedProduct(genericName, pet.type, true);
      if (vettedProduct) {
        return {
          ...supplement,
          name: genericName,
          productName: vettedProduct.productName,
          asinLink: vettedProduct.asinLink,
          notes: supplement.notes ? `${supplement.notes} | VET NOTE: ${vettedProduct.vetNote}` : `VET NOTE: ${vettedProduct.vetNote}`,
        };
      }
      // If no vetted product, remove asinLink to ensure only vetted products have buy links
      return {
        ...supplement,
        asinLink: undefined,
      };
    });
  }

  return {
    modifiedRecipe,
    addedIngredients,
    conflictCount,
    hasHydrationSupport,
  };
}

export function generateModifiedRecommendations({ profile, recipeIds, limit, minCompatibilityScore = 30 }: { profile: PetNutritionProfile, recipeIds: string[], limit: number, minCompatibilityScore?: number }): ModifiedRecipeResult[] {
    console.log('üîç generateModifiedRecommendations called:', {
        species: profile.species,
        ageGroup: profile.ageGroup,
        healthConcerns: profile.healthConcerns,
        limit,
        minCompatibilityScore
    });
    
    // NOTE: 'recipes' is imported from './data/recipes-complete'
    // Use matchesSpecies instead of strict equality to support subtype matching
    const petForMatching = {
        id: '',
        name: '',
        type: profile.species,
        breed: profile.breed || '',
        age: profile.ageGroup,
        healthConcerns: profile.healthConcerns || []
    };
    
    // Use matchesSpecies for sophisticated matching (handles subtypes)
    let allRecipesForCategory = recipes.filter(r => matchesSpecies(r, petForMatching));
    console.log(`üìä Found ${allRecipesForCategory.length} recipes for species "${profile.species}"`);
    
    // Fallback: If no matches, try simple normalization (cat/cats, dog/dogs)
    if (allRecipesForCategory.length === 0) {
        const normalizeSpecies = (species: string) => species.toLowerCase().replace(/s$/, '');
        const normalizedPet = normalizeSpecies(profile.species);
        allRecipesForCategory = recipes.filter(r => {
            const normalizedRecipe = normalizeSpecies(r.category);
            return normalizedPet === normalizedRecipe;
        });
    }
    
    // Log for debugging
    if (allRecipesForCategory.length === 0) {
        console.warn(`No recipes found for species: ${profile.species}, breed: ${profile.breed}, age: ${profile.ageGroup}`);
        console.warn(`Total recipes available: ${recipes.length}`);
        console.warn(`Sample recipe categories: ${recipes.slice(0, 5).map(r => r.category).join(', ')}`);
    }
    
    const targetRecipes = recipeIds.length > 0
        ? allRecipesForCategory.filter(r => recipeIds.includes(r.id))
        : allRecipesForCategory.slice(0, 50); // Use a subset if no IDs provided

    // 1. Score all recipes
    console.log(`üéØ Scoring ${targetRecipes.length} recipes...`);
    const scoredRecipes = targetRecipes.map((recipe, idx) => {
        // Convert PetNutritionProfile to pet object format expected by scoreRecipeImproved
        const petForScoring = {
            id: '',
            name: profile.petName || '',
            type: profile.species,
            breed: profile.breed || '',
            age: profile.ageGroup,
            weight: profile.weightKg,
            weightKg: profile.weightKg,
            activityLevel: undefined,
            healthConcerns: profile.healthConcerns || [],
            dietaryRestrictions: profile.allergies || [],
            allergies: profile.allergies || [],
        };
        const petRating = scoreRecipeImproved(recipe, petForScoring);
        if (idx < 3) { // Log first 3 for debugging
            console.log(`  Recipe "${recipe.name}": ${petRating.compatibilityScore || petRating.matchScore}% (${petRating.reasoning.goodMatches.length} matches, ${petRating.reasoning.conflicts.length} conflicts)`);
        }
        return { recipe, petRating };
    });

    // 2. Filter by minimum compatibility threshold
    const filteredByThreshold = scoredRecipes.filter(({ petRating }) => {
        const score = petRating.compatibilityScore || petRating.matchScore;
        return score >= minCompatibilityScore;
    });
    
    console.log(`üìä Filtered ${scoredRecipes.length} recipes to ${filteredByThreshold.length} above threshold (${minCompatibilityScore}%)`);
    
    // 3. Sort by score and take the top N
    const topScored = filteredByThreshold
        .sort((a, b) => (b.petRating.compatibilityScore || b.petRating.matchScore) - (a.petRating.compatibilityScore || a.petRating.matchScore))
        .slice(0, limit);

    // 4. Apply modifiers to the top N recipes
    const results = topScored.map(({ recipe, petRating }) => {
        // Convert PetNutritionProfile to pet object format expected by applyModifiers
        const petForModifiers = {
            type: profile.species,
            age: profile.ageGroup,
            breed: profile.breed || '',
            healthConcerns: profile.healthConcerns || [],
            allergies: profile.allergies || [],
            weightKg: profile.weightKg,
        };
        // Apply modifiers, which now performs the ingredient vetting lookup (Step 2 in applyModifiers)
        const { modifiedRecipe, addedIngredients, conflictCount, hasHydrationSupport } = applyModifiers(recipe, petForModifiers);

        const portionPlan = getPortionPlan(recipe, profile);

        const shoppingList: ShoppingListItem[] = [
            // 1. Original recipe ingredients (NOW VETTED AND MODIFIED with commission optimization)
            ...modifiedRecipe.ingredients.map(ing => {
                // Find the best affiliate link for this ingredient (prioritizing commission)
                const allLinks = getAllAffiliateLinks(ing.name.toLowerCase());
                const bestLink = allLinks[0]; // Already sorted by commission descending

                // Use vetted product name if available, otherwise keep original
                const vettedProduct = getVettedProduct(ing.name.toLowerCase());

                return {
                    name: vettedProduct?.productName || ing.name,
                    amount: scaleAmount(ing.amount, portionPlan.multiplier) || ing.amount,
                    asinLink: bestLink?.url || ing.asinLink, // Use best commission link
                    notes: (ing as any).notes,
                    category: (ing as any).category,
                };
            }),
            // 2. Added supplements/modifiers
            ...addedIngredients.map(add => ({
                name: add.name,
                amount: '1 dose/day', // Default amount for a supplement
                asinLink: add.amazon,
                notes: `Added for ${add.forConcern} support. Benefit: ${add.benefit}`,
                category: 'Supplement',
            })),
        ];

        // Group the shopping list items by category or name for display... (not implemented here)

        return {
            recipe: modifiedRecipe,
            adjustedIngredients: modifiedRecipe.ingredients,
            appliedRules: [], // TODO: implement applied rules
            nutritionChanges: {}, // TODO: implement nutrition changes
            portionPlan,
            shoppingList,
            explanation: '', // avoid noisy banner text
            weeklyPlan: [], // TODO: implement weekly plan
            score: petRating.compatibilityScore || petRating.matchScore,
        };
    });

    return results;
}
</file>

<file path="lib/audit/RecipeNutritionalAudit.ts">
// Recipe Nutritional Accuracy Audit - Verify portion calculations and nutritional totals
// Tests if recipes meet species-specific requirements and calculations are correct

import { RecipeBuilder, GenerationConstraints } from '../generator/RecipeBuilder';
import type { Species } from '@/lib/data/ingredients';
import { getNutritionalStandard } from '@/lib/data/aafco-standards';
import * as fs from 'fs';
import * as path from 'path';

interface NutritionalAccuracyMetrics {
  species: Species;
  recipesGenerated: number;
  recipesValid: number;
  avgTotalGrams: number;
  avgProteinPercent: number;
  avgFatPercent: number;
  avgCarbsPercent: number;
  avgCalories: number;
  portionSizeIssues: number;
  nutritionalBalanceIssues: number;
  calculationErrors: number;
}

export class RecipeNutritionalAudit {
  private results: Map<Species, NutritionalAccuracyMetrics> = new Map();
  
  async runAudit(): Promise<void> {
    console.log('='.repeat(80));
    console.log('RECIPE NUTRITIONAL ACCURACY AUDIT');
    console.log('='.repeat(80));
    console.log();
    
    const species: Species[] = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
    
    for (const sp of species) {
      console.log(`Testing ${sp}...`);
      await this.testSpeciesNutrition(sp);
    }
    
    this.generateReport();
  }
  
  private async testSpeciesNutrition(species: Species): Promise<void> {
    const testCases = [
      { weight: 2, label: 'very small' },
      { weight: 5, label: 'small' },
      { weight: 15, label: 'medium' },
      { weight: 30, label: 'large' },
      { weight: 50, label: 'very large' },
    ];
    
    let recipesGenerated = 0;
    let recipesValid = 0;
    let totalGrams = 0;
    let totalProtein = 0;
    let totalFat = 0;
    let totalCarbs = 0;
    let totalCalories = 0;
    let portionSizeIssues = 0;
    let nutritionalBalanceIssues = 0;
    let calculationErrors = 0;
    
    for (const testCase of testCases) {
      for (let i = 0; i < 5; i++) {
        const constraints: GenerationConstraints = {
          species,
          lifeStage: 'adult',
          petWeightKg: testCase.weight,
          healthConcerns: [],
          allergies: [],
        };
        
        try {
          const builder = new RecipeBuilder(constraints, 'standard', 'medium');
          const recipe = await builder.generate();
          
          if (recipe && recipe.ingredients.length > 0) {
            recipesGenerated++;
            
            // Calculate nutritional totals
            let recipeProtein = 0;
            let recipeFat = 0;
            let recipeCarbs = 0;
            let recipeCalories = 0;
            let calculatedTotalGrams = 0;
            
            for (const portioned of recipe.ingredients) {
              const grams = portioned.grams;
              calculatedTotalGrams += grams;
              
              const comp = portioned.ingredient.composition;
              recipeProtein += (comp.protein || 0) * grams / 100;
              recipeFat += (comp.fat || 0) * grams / 100;
              recipeCarbs += (comp.carbs || 0) * grams / 100;
              recipeCalories += (comp.kcal || 0) * grams / 100;
            }
            
            // Verify total grams matches
            if (Math.abs(calculatedTotalGrams - recipe.totalGrams) > 0.1) {
              calculationErrors++;
              console.warn(`  Calculation error: ${calculatedTotalGrams.toFixed(1)}g calculated vs ${recipe.totalGrams}g reported`);
            }
            
            // Check portion size appropriateness
            const expectedGramsPerKg = this.getExpectedGramsPerKg(species);
            const expectedTotal = testCase.weight * expectedGramsPerKg;
            const portionDifference = Math.abs(recipe.totalGrams - expectedTotal) / expectedTotal;
            
            if (portionDifference > 0.3) {
              portionSizeIssues++;
            }
            
            // Check nutritional balance
            const proteinPercent = (recipeProtein / recipe.totalGrams) * 100;
            const fatPercent = (recipeFat / recipe.totalGrams) * 100;
            const carbsPercent = (recipeCarbs / recipe.totalGrams) * 100;
            
            const standard = getNutritionalStandard(species, 'adult');
            
            if (standard.protein && (proteinPercent < standard.protein.min || proteinPercent > (standard.protein.max || 100))) {
              nutritionalBalanceIssues++;
            }
            
            if (standard.fat && (fatPercent < standard.fat.min || fatPercent > (standard.fat.max || 100))) {
              nutritionalBalanceIssues++;
            }
            
            recipesValid++;
            totalGrams += recipe.totalGrams;
            totalProtein += proteinPercent;
            totalFat += fatPercent;
            totalCarbs += carbsPercent;
            totalCalories += recipeCalories;
          }
        } catch (error) {
          // Skip failed recipes
        }
      }
    }
    
    this.results.set(species, {
      species,
      recipesGenerated,
      recipesValid,
      avgTotalGrams: recipesValid > 0 ? totalGrams / recipesValid : 0,
      avgProteinPercent: recipesValid > 0 ? totalProtein / recipesValid : 0,
      avgFatPercent: recipesValid > 0 ? totalFat / recipesValid : 0,
      avgCarbsPercent: recipesValid > 0 ? totalCarbs / recipesValid : 0,
      avgCalories: recipesValid > 0 ? totalCalories / recipesValid : 0,
      portionSizeIssues,
      nutritionalBalanceIssues,
      calculationErrors,
    });
  }
  
  private getExpectedGramsPerKg(species: Species): number {
    switch (species) {
      case 'dogs': return 60;
      case 'cats': return 70;
      case 'birds': return 80;
      case 'reptiles': return 50;
      case 'pocket-pets': return 100;
      default: return 60;
    }
  }
  
  private generateReport(): void {
    console.log();
    console.log('='.repeat(80));
    console.log('NUTRITIONAL ACCURACY RESULTS');
    console.log('='.repeat(80));
    console.log();
    
    for (const [species, metrics] of this.results) {
      console.log(`${species.toUpperCase()}`);
      console.log('-'.repeat(80));
      console.log(`Recipes generated: ${metrics.recipesGenerated}`);
      console.log(`Recipes valid: ${metrics.recipesValid}`);
      console.log();
      
      console.log('Average nutritional composition:');
      console.log(`  Total grams: ${metrics.avgTotalGrams.toFixed(1)}g`);
      console.log(`  Protein: ${metrics.avgProteinPercent.toFixed(1)}%`);
      console.log(`  Fat: ${metrics.avgFatPercent.toFixed(1)}%`);
      console.log(`  Carbs: ${metrics.avgCarbsPercent.toFixed(1)}%`);
      console.log(`  Calories: ${metrics.avgCalories.toFixed(0)} kcal`);
      console.log();
      
      // Check against standards
      const standard = getNutritionalStandard(species, 'adult');
      
      console.log('Compliance with standards:');
      if (standard.protein) {
        const proteinOk = metrics.avgProteinPercent >= standard.protein.min && 
                         metrics.avgProteinPercent <= (standard.protein.max || 100);
        console.log(`  Protein: ${proteinOk ? '‚úÖ' : '‚ùå'} ${metrics.avgProteinPercent.toFixed(1)}% (target: ${standard.protein.min}-${standard.protein.max || '‚àû'}%)`);
      }
      
      if (standard.fat) {
        const fatOk = metrics.avgFatPercent >= standard.fat.min && 
                     metrics.avgFatPercent <= (standard.fat.max || 100);
        console.log(`  Fat: ${fatOk ? '‚úÖ' : '‚ùå'} ${metrics.avgFatPercent.toFixed(1)}% (target: ${standard.fat.min}-${standard.fat.max || '‚àû'}%)`);
      }
      
      console.log();
      
      console.log('Issues detected:');
      console.log(`  Portion size issues: ${metrics.portionSizeIssues}`);
      console.log(`  Nutritional balance issues: ${metrics.nutritionalBalanceIssues}`);
      console.log(`  Calculation errors: ${metrics.calculationErrors}`);
      console.log();
      
      if (metrics.calculationErrors > 0) {
        console.log('‚ö†Ô∏è  Calculation errors detected - portion totals may be incorrect');
      }
      
      if (metrics.portionSizeIssues > metrics.recipesValid * 0.2) {
        console.log('‚ö†Ô∏è  Many portion sizes outside expected range - review multipliers');
      }
      
      if (metrics.nutritionalBalanceIssues > 0) {
        console.log('‚ö†Ô∏è  Some recipes outside nutritional standards - review ingredient selection');
      }
      
      console.log();
    }
    
    this.generateRecommendations();
    this.saveDetailedReport();
  }
  
  private generateRecommendations(): void {
    console.log('='.repeat(80));
    console.log('RECOMMENDATIONS');
    console.log('='.repeat(80));
    console.log();
    
    for (const [species, metrics] of this.results) {
      const issues: string[] = [];
      
      if (metrics.calculationErrors > 0) {
        issues.push('Fix calculation errors in portion totaling');
      }
      
      if (metrics.portionSizeIssues > metrics.recipesValid * 0.2) {
        issues.push('Adjust portion multipliers for better sizing');
      }
      
      if (metrics.nutritionalBalanceIssues > metrics.recipesValid * 0.1) {
        issues.push('Review ingredient selection to meet nutritional standards');
      }
      
      const standard = getNutritionalStandard(species, 'adult');
      if (standard.protein && metrics.avgProteinPercent < standard.protein.min) {
        issues.push(`Increase protein content (currently ${metrics.avgProteinPercent.toFixed(1)}%, need ${standard.protein.min}%+)`);
      }
      
      if (standard.fat && metrics.avgFatPercent < standard.fat.min) {
        issues.push(`Increase fat content (currently ${metrics.avgFatPercent.toFixed(1)}%, need ${standard.fat.min}%+)`);
      }
      
      if (issues.length > 0) {
        console.log(`${species}:`);
        issues.forEach(issue => console.log(`  - ${issue}`));
        console.log();
      }
    }
  }
  
  private saveDetailedReport(): void {
    const report = {
      timestamp: new Date().toISOString(),
      results: Array.from(this.results.entries()).map(([species, metrics]) => ({
        species,
        ...metrics,
      })),
    };
    
    const outputPath = path.join(process.cwd(), 'RECIPE_NUTRITIONAL_AUDIT.json');
    fs.writeFileSync(outputPath, JSON.stringify(report, null, 2), 'utf-8');
    
    console.log(`Detailed report saved to: ${outputPath}`);
    console.log();
  }
}

// Run the audit
const audit = new RecipeNutritionalAudit();
audit.runAudit().catch(console.error);
</file>

<file path="lib/audit/RecipePalatabilityAudit.ts">
// Recipe Palatability Audit - Analyze palatability scoring system
// Verifies scores make sense and high-palatability ingredients are preferred

import { getIngredientsForSpecies, type Ingredient, type Species } from '@/lib/data/ingredients';
import { RecipeBuilder, GenerationConstraints } from '../generator/RecipeBuilder';
import * as fs from 'fs';
import * as path from 'path';

interface PalatabilityMetrics {
  species: Species;
  totalIngredients: number;
  avgPalatability: number;
  palatabilityDistribution: {
    veryHigh: number; // 9-10
    high: number;     // 7-8
    medium: number;   // 5-6
    low: number;      // 3-4
    veryLow: number;  // 0-2
  };
  topIngredients: Array<{ name: string; score: number }>;
  bottomIngredients: Array<{ name: string; score: number }>;
  recipePalatabilityScores: number[];
  avgRecipePalatability: number;
}

export class RecipePalatabilityAudit {
  private results: Map<Species, PalatabilityMetrics> = new Map();
  
  async runAudit(): Promise<void> {
    console.log('='.repeat(80));
    console.log('RECIPE PALATABILITY AUDIT');
    console.log('='.repeat(80));
    console.log();
    
    const species: Species[] = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
    
    for (const sp of species) {
      console.log(`Analyzing ${sp}...`);
      await this.analyzeSpeciesPalatability(sp);
    }
    
    this.generateReport();
  }
  
  private async analyzeSpeciesPalatability(species: Species): Promise<void> {
    // Get all ingredients for this species
    const ingredients = getIngredientsForSpecies(species);
    
    // Analyze palatability scores
    const palatabilityScores = ingredients
      .map(ing => ing.palatability?.[species] || 0)
      .filter(score => score > 0);
    
    const avgPalatability = palatabilityScores.reduce((a, b) => a + b, 0) / palatabilityScores.length;
    
    // Distribution
    const distribution = {
      veryHigh: palatabilityScores.filter(s => s >= 9).length,
      high: palatabilityScores.filter(s => s >= 7 && s < 9).length,
      medium: palatabilityScores.filter(s => s >= 5 && s < 7).length,
      low: palatabilityScores.filter(s => s >= 3 && s < 5).length,
      veryLow: palatabilityScores.filter(s => s < 3).length,
    };
    
    // Top and bottom ingredients
    const sorted = ingredients
      .map(ing => ({ name: ing.name, score: ing.palatability?.[species] || 0 }))
      .filter(item => item.score > 0)
      .sort((a, b) => b.score - a.score);
    
    const topIngredients = sorted.slice(0, 10);
    const bottomIngredients = sorted.slice(-10).reverse();
    
    // Generate recipes and check their palatability
    const recipePalatabilityScores = await this.generateAndScoreRecipes(species, 20);
    const avgRecipePalatability = recipePalatabilityScores.reduce((a, b) => a + b, 0) / recipePalatabilityScores.length;
    
    this.results.set(species, {
      species,
      totalIngredients: ingredients.length,
      avgPalatability,
      palatabilityDistribution: distribution,
      topIngredients,
      bottomIngredients,
      recipePalatabilityScores,
      avgRecipePalatability,
    });
  }
  
  private async generateAndScoreRecipes(species: Species, count: number): Promise<number[]> {
    const scores: number[] = [];
    
    for (let i = 0; i < count; i++) {
      const constraints: GenerationConstraints = {
        species,
        lifeStage: 'adult',
        petWeightKg: this.getTypicalWeight(species),
        healthConcerns: [],
        allergies: [],
      };
      
      try {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = await builder.generate();
        
        if (recipe && recipe.ingredients.length > 0) {
          // Calculate recipe palatability (weighted average)
          let totalPalatability = 0;
          let totalWeight = 0;
          
          for (const portioned of recipe.ingredients) {
            const palatability = portioned.ingredient.palatability?.[species] || 5;
            totalPalatability += palatability * portioned.grams;
            totalWeight += portioned.grams;
          }
          
          const avgPalatability = totalWeight > 0 ? totalPalatability / totalWeight : 5;
          scores.push(avgPalatability);
        }
      } catch (error) {
        // Skip failed recipes
      }
    }
    
    return scores;
  }
  
  private getTypicalWeight(species: Species): number {
    switch (species) {
      case 'dogs': return 15;
      case 'cats': return 5;
      case 'birds': return 0.5;
      case 'reptiles': return 0.3;
      case 'pocket-pets': return 1;
      default: return 10;
    }
  }
  
  private generateReport(): void {
    console.log();
    console.log('='.repeat(80));
    console.log('PALATABILITY AUDIT RESULTS');
    console.log('='.repeat(80));
    console.log();
    
    for (const [species, metrics] of this.results) {
      console.log(`${species.toUpperCase()}`);
      console.log('-'.repeat(80));
      console.log(`Total ingredients: ${metrics.totalIngredients}`);
      console.log(`Average palatability: ${metrics.avgPalatability.toFixed(2)}/10`);
      console.log();
      
      console.log('Palatability distribution:');
      console.log(`  Very High (9-10): ${metrics.palatabilityDistribution.veryHigh} (${((metrics.palatabilityDistribution.veryHigh / metrics.totalIngredients) * 100).toFixed(1)}%)`);
      console.log(`  High (7-8):       ${metrics.palatabilityDistribution.high} (${((metrics.palatabilityDistribution.high / metrics.totalIngredients) * 100).toFixed(1)}%)`);
      console.log(`  Medium (5-6):     ${metrics.palatabilityDistribution.medium} (${((metrics.palatabilityDistribution.medium / metrics.totalIngredients) * 100).toFixed(1)}%)`);
      console.log(`  Low (3-4):        ${metrics.palatabilityDistribution.low} (${((metrics.palatabilityDistribution.low / metrics.totalIngredients) * 100).toFixed(1)}%)`);
      console.log(`  Very Low (0-2):   ${metrics.palatabilityDistribution.veryLow} (${((metrics.palatabilityDistribution.veryLow / metrics.totalIngredients) * 100).toFixed(1)}%)`);
      console.log();
      
      console.log('Top 10 most palatable ingredients:');
      metrics.topIngredients.forEach((ing, idx) => {
        console.log(`  ${idx + 1}. ${ing.name}: ${ing.score}/10`);
      });
      console.log();
      
      console.log('Bottom 10 least palatable ingredients:');
      metrics.bottomIngredients.forEach((ing, idx) => {
        console.log(`  ${idx + 1}. ${ing.name}: ${ing.score}/10`);
      });
      console.log();
      
      console.log(`Recipe palatability (${metrics.recipePalatabilityScores.length} recipes tested):`);
      console.log(`  Average: ${metrics.avgRecipePalatability.toFixed(2)}/10`);
      console.log(`  Min: ${Math.min(...metrics.recipePalatabilityScores).toFixed(2)}/10`);
      console.log(`  Max: ${Math.max(...metrics.recipePalatabilityScores).toFixed(2)}/10`);
      console.log();
      
      // Check if recipes favor high-palatability ingredients
      const ingredientAvg = metrics.avgPalatability;
      const recipeAvg = metrics.avgRecipePalatability;
      const difference = recipeAvg - ingredientAvg;
      
      if (difference > 0.5) {
        console.log(`‚úÖ Recipes favor high-palatability ingredients (+${difference.toFixed(2)} vs ingredient avg)`);
      } else if (difference < -0.5) {
        console.log(`‚ö†Ô∏è  Recipes may not prioritize palatability enough (${difference.toFixed(2)} vs ingredient avg)`);
      } else {
        console.log(`‚úì Recipes have balanced palatability (${difference > 0 ? '+' : ''}${difference.toFixed(2)} vs ingredient avg)`);
      }
      
      console.log();
    }
    
    this.generateRecommendations();
    this.saveDetailedReport();
  }
  
  private generateRecommendations(): void {
    console.log('='.repeat(80));
    console.log('RECOMMENDATIONS');
    console.log('='.repeat(80));
    console.log();
    
    for (const [species, metrics] of this.results) {
      const issues: string[] = [];
      
      // Check if palatability scores are well-distributed
      const veryHighPct = metrics.palatabilityDistribution.veryHigh / metrics.totalIngredients;
      const veryLowPct = metrics.palatabilityDistribution.veryLow / metrics.totalIngredients;
      
      if (veryHighPct < 0.1) {
        issues.push('Too few very high palatability ingredients - consider adding more treats/favorites');
      }
      
      if (veryLowPct > 0.3) {
        issues.push('Too many low palatability ingredients - may affect recipe appeal');
      }
      
      // Check if recipes prioritize palatability
      const difference = metrics.avgRecipePalatability - metrics.avgPalatability;
      if (difference < 0) {
        issues.push('Recipes not prioritizing high-palatability ingredients - increase palatability weight in scoring');
      }
      
      // Check palatability range
      if (metrics.avgPalatability < 5) {
        issues.push('Overall palatability too low - review ingredient scores');
      }
      
      if (issues.length > 0) {
        console.log(`${species}:`);
        issues.forEach(issue => console.log(`  - ${issue}`));
        console.log();
      }
    }
  }
  
  private saveDetailedReport(): void {
    const report = {
      timestamp: new Date().toISOString(),
      results: Array.from(this.results.entries()).map(([species, metrics]) => ({
        species,
        totalIngredients: metrics.totalIngredients,
        avgPalatability: metrics.avgPalatability,
        palatabilityDistribution: metrics.palatabilityDistribution,
        topIngredients: metrics.topIngredients,
        bottomIngredients: metrics.bottomIngredients,
        avgRecipePalatability: metrics.avgRecipePalatability,
        recipePalatabilityScores: metrics.recipePalatabilityScores,
      })),
    };
    
    const outputPath = path.join(process.cwd(), 'RECIPE_PALATABILITY_AUDIT.json');
    fs.writeFileSync(outputPath, JSON.stringify(report, null, 2), 'utf-8');
    
    console.log(`Detailed report saved to: ${outputPath}`);
    console.log();
  }
}

// Run the audit
const audit = new RecipePalatabilityAudit();
audit.runAudit().catch(console.error);
</file>

<file path="lib/audit/RecipeVarietyAudit.ts">
// Recipe Variety Audit - Analyze diversity mechanisms across all species
// Tests if recipes actually vary between generations and ingredient rotation

import { RecipeBuilder, GenerationConstraints } from '../generator/RecipeBuilder';
import type { Species } from '@/lib/data/ingredients';
import * as fs from 'fs';
import * as path from 'path';

interface VarietyMetrics {
  species: Species;
  totalRecipes: number;
  uniqueIngredients: Set<string>;
  ingredientFrequency: Map<string, number>;
  uniqueRecipes: number;
  duplicateRecipes: number;
  averageIngredientsPerRecipe: number;
  ingredientRotation: number; // 0-1, higher = better rotation
  diversityScore: number; // 0-100, higher = better variety
}

interface RecipeSignature {
  ingredients: string[];
  hash: string;
}

export class RecipeVarietyAudit {
  private results: Map<Species, VarietyMetrics> = new Map();
  
  async runAudit(): Promise<void> {
    console.log('='.repeat(80));
    console.log('RECIPE VARIETY AUDIT');
    console.log('='.repeat(80));
    console.log();
    
    const species: Species[] = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
    const recipesPerSpecies = 50; // Generate 50 recipes per species
    
    for (const sp of species) {
      console.log(`Testing ${sp}...`);
      await this.testSpeciesVariety(sp, recipesPerSpecies);
    }
    
    this.generateReport();
  }
  
  private async testSpeciesVariety(species: Species, count: number): Promise<void> {
    const recipes: RecipeSignature[] = [];
    const ingredientFrequency = new Map<string, number>();
    const uniqueIngredients = new Set<string>();
    let totalIngredients = 0;
    
    // Generate recipes with different diversity modes
    const diversityModes = ['high', 'medium', 'low', 'none'] as const;
    const recipesPerMode = Math.floor(count / diversityModes.length);
    
    for (const mode of diversityModes) {
      for (let i = 0; i < recipesPerMode; i++) {
        const constraints: GenerationConstraints = {
          species,
          lifeStage: 'adult',
          petWeightKg: this.getTypicalWeight(species),
          healthConcerns: [],
          allergies: [],
        };
        
        try {
          const builder = new RecipeBuilder(constraints, 'standard', mode);
          const recipe = await builder.generate();
          
          if (recipe && recipe.ingredients.length > 0) {
            // Track ingredients
            const ingredientNames = recipe.ingredients.map(ing => ing.ingredient.name).sort();
            const hash = this.hashIngredients(ingredientNames);
            
            recipes.push({ ingredients: ingredientNames, hash });
            totalIngredients += ingredientNames.length;
            
            ingredientNames.forEach(name => {
              uniqueIngredients.add(name);
              ingredientFrequency.set(name, (ingredientFrequency.get(name) || 0) + 1);
            });
          }
        } catch (error) {
          console.error(`  Failed to generate recipe: ${error}`);
        }
      }
    }
    
    // Calculate metrics
    const uniqueHashes = new Set(recipes.map(r => r.hash));
    const uniqueRecipes = uniqueHashes.size;
    const duplicateRecipes = recipes.length - uniqueRecipes;
    const averageIngredientsPerRecipe = totalIngredients / recipes.length;
    
    // Calculate ingredient rotation score
    const rotationScore = this.calculateRotationScore(ingredientFrequency, recipes.length);
    
    // Calculate diversity score
    const diversityScore = this.calculateDiversityScore(
      uniqueRecipes,
      recipes.length,
      uniqueIngredients.size,
      rotationScore
    );
    
    this.results.set(species, {
      species,
      totalRecipes: recipes.length,
      uniqueIngredients,
      ingredientFrequency,
      uniqueRecipes,
      duplicateRecipes,
      averageIngredientsPerRecipe,
      ingredientRotation: rotationScore,
      diversityScore,
    });
  }
  
  private getTypicalWeight(species: Species): number {
    switch (species) {
      case 'dogs': return 15;
      case 'cats': return 5;
      case 'birds': return 0.5;
      case 'reptiles': return 0.3;
      case 'pocket-pets': return 1;
      default: return 10;
    }
  }
  
  private hashIngredients(ingredients: string[]): string {
    return ingredients.join('|');
  }
  
  private calculateRotationScore(
    frequency: Map<string, number>,
    totalRecipes: number
  ): number {
    // Perfect rotation = each ingredient used equally
    // Score 0-1, where 1 = perfect rotation
    
    const frequencies = Array.from(frequency.values());
    const avgFrequency = frequencies.reduce((a, b) => a + b, 0) / frequencies.length;
    
    // Calculate variance
    const variance = frequencies.reduce((sum, freq) => {
      return sum + Math.pow(freq - avgFrequency, 2);
    }, 0) / frequencies.length;
    
    // Lower variance = better rotation
    // Normalize to 0-1 scale
    const maxVariance = Math.pow(totalRecipes, 2);
    const normalizedVariance = Math.min(variance / maxVariance, 1);
    
    return 1 - normalizedVariance;
  }
  
  private calculateDiversityScore(
    uniqueRecipes: number,
    totalRecipes: number,
    uniqueIngredients: number,
    rotationScore: number
  ): number {
    // Weighted score:
    // 40% - Recipe uniqueness
    // 30% - Ingredient variety
    // 30% - Ingredient rotation
    
    const recipeUniqueness = (uniqueRecipes / totalRecipes) * 40;
    const ingredientVariety = Math.min(uniqueIngredients / 20, 1) * 30; // 20+ ingredients = max
    const rotation = rotationScore * 30;
    
    return recipeUniqueness + ingredientVariety + rotation;
  }
  
  private generateReport(): void {
    console.log();
    console.log('='.repeat(80));
    console.log('VARIETY AUDIT RESULTS');
    console.log('='.repeat(80));
    console.log();
    
    let totalScore = 0;
    let count = 0;
    
    for (const [species, metrics] of this.results) {
      console.log(`${species.toUpperCase()}`);
      console.log('-'.repeat(80));
      console.log(`Total recipes generated: ${metrics.totalRecipes}`);
      console.log(`Unique recipes: ${metrics.uniqueRecipes} (${((metrics.uniqueRecipes / metrics.totalRecipes) * 100).toFixed(1)}%)`);
      console.log(`Duplicate recipes: ${metrics.duplicateRecipes}`);
      console.log(`Unique ingredients used: ${metrics.uniqueIngredients.size}`);
      console.log(`Avg ingredients per recipe: ${metrics.averageIngredientsPerRecipe.toFixed(1)}`);
      console.log(`Ingredient rotation score: ${(metrics.ingredientRotation * 100).toFixed(1)}%`);
      console.log(`Overall diversity score: ${metrics.diversityScore.toFixed(1)}/100`);
      
      // Show most/least used ingredients
      const sorted = Array.from(metrics.ingredientFrequency.entries())
        .sort((a, b) => b[1] - a[1]);
      
      console.log();
      console.log(`Most used ingredients:`);
      sorted.slice(0, 5).forEach(([ing, count]) => {
        console.log(`  - ${ing}: ${count} times (${((count / metrics.totalRecipes) * 100).toFixed(1)}%)`);
      });
      
      console.log();
      console.log(`Least used ingredients:`);
      sorted.slice(-5).reverse().forEach(([ing, count]) => {
        console.log(`  - ${ing}: ${count} times (${((count / metrics.totalRecipes) * 100).toFixed(1)}%)`);
      });
      
      console.log();
      
      totalScore += metrics.diversityScore;
      count++;
    }
    
    const avgScore = totalScore / count;
    
    console.log('='.repeat(80));
    console.log('OVERALL ASSESSMENT');
    console.log('='.repeat(80));
    console.log();
    console.log(`Average diversity score: ${avgScore.toFixed(1)}/100`);
    console.log();
    
    if (avgScore >= 80) {
      console.log('‚úÖ EXCELLENT - Recipes show high variety and good rotation');
    } else if (avgScore >= 60) {
      console.log('‚ö†Ô∏è  GOOD - Recipes have decent variety but could be improved');
    } else if (avgScore >= 40) {
      console.log('‚ö†Ô∏è  FAIR - Recipes show some repetition, needs improvement');
    } else {
      console.log('‚ùå POOR - Recipes are too repetitive, major improvements needed');
    }
    
    console.log();
    this.generateRecommendations(avgScore);
    
    // Save detailed report
    this.saveDetailedReport();
  }
  
  private generateRecommendations(avgScore: number): void {
    console.log('RECOMMENDATIONS:');
    console.log('-'.repeat(80));
    
    for (const [species, metrics] of this.results) {
      if (metrics.diversityScore < 60) {
        console.log(`\n${species}:`);
        
        if (metrics.uniqueRecipes / metrics.totalRecipes < 0.7) {
          console.log('  - Too many duplicate recipes - increase randomization');
        }
        
        if (metrics.uniqueIngredients.size < 15) {
          console.log('  - Limited ingredient pool - expand available ingredients');
        }
        
        if (metrics.ingredientRotation < 0.5) {
          console.log('  - Poor ingredient rotation - some ingredients overused');
          
          // Find overused ingredients
          const sorted = Array.from(metrics.ingredientFrequency.entries())
            .sort((a, b) => b[1] - a[1]);
          
          const overused = sorted.filter(([_, count]) => 
            count / metrics.totalRecipes > 0.5
          );
          
          if (overused.length > 0) {
            console.log(`    Overused: ${overused.map(([ing]) => ing).join(', ')}`);
          }
        }
      }
    }
    
    console.log();
  }
  
  private saveDetailedReport(): void {
    const report = {
      timestamp: new Date().toISOString(),
      results: Array.from(this.results.entries()).map(([species, metrics]) => ({
        species,
        totalRecipes: metrics.totalRecipes,
        uniqueRecipes: metrics.uniqueRecipes,
        duplicateRecipes: metrics.duplicateRecipes,
        uniqueIngredients: metrics.uniqueIngredients.size,
        averageIngredientsPerRecipe: metrics.averageIngredientsPerRecipe,
        ingredientRotation: metrics.ingredientRotation,
        diversityScore: metrics.diversityScore,
        ingredientFrequency: Array.from(metrics.ingredientFrequency.entries()),
      })),
    };
    
    const outputPath = path.join(process.cwd(), 'RECIPE_VARIETY_AUDIT.json');
    fs.writeFileSync(outputPath, JSON.stringify(report, null, 2), 'utf-8');
    
    console.log(`Detailed report saved to: ${outputPath}`);
  }
}

// Run the audit
const audit = new RecipeVarietyAudit();
audit.runAudit().catch(console.error);
</file>

<file path="lib/competitors/balanceit-analysis.ts">
// lib/competitors/balanceit-analysis.ts
// Competitive analysis of BalanceIT.com - our main competitor

export interface CompetitorAnalysis {
  strengths: string[];
  weaknesses: string[];
  gapsToExploit: string[];
  pricingStructure: {
    perRecipe?: number;
    annualSubscription?: number;
    supplementSales?: string;
  };
  userPainPoints: string[];
  marketPosition: string;
  targetUsers: string[];
}

export const BALANCEIT_ANALYSIS: CompetitorAnalysis = {
  strengths: [
    "UC Davis veterinary school backing - strong credibility",
    "Supplement-focused approach (easy for vets to understand)",
    "Established since 1999 - long market presence",
    "Simple interface for basic nutritional needs",
    "Good for veterinary practices and professional use"
  ],

  weaknesses: [
    "DOG/CAT ONLY - no exotic pet support (birds, reptiles, small mammals)",
    "$14.95 per recipe (expensive for regular users)",
    "No compatibility scoring or dynamic recommendations",
    "Manual calculations required - not automated",
    "No affiliate/shopping integration - users must source ingredients themselves",
    "Outdated UI (looks like early 2000s web design)",
    "Limited ingredient database compared to modern apps",
    "No meal planning features or weekly meal prep",
    "No user community or recipe sharing",
    "No mobile app - desktop only"
  ],

  gapsToExploit: [
    "Complete exotic pet support (birds, reptiles, pocket pets) - huge market gap",
    "Free tier with affiliate monetization - accessible to all pet owners",
    "Dynamic compatibility scoring with real-time feedback",
    "One-click shopping lists with Amazon affiliate links",
    "Fresh/whole food focus vs expensive supplement approach",
    "Modern, user-friendly interface with mobile-first design",
    "Comprehensive ingredient database with USDA nutritional data",
    "Automated meal planning and portion calculations",
    "Community features and user-generated recipes",
    "Multi-device support with responsive design",
    "Educational content and veterinary-backed resources",
    "Cost-effective alternative to expensive vet consultations"
  ],

  pricingStructure: {
    perRecipe: 14.95,
    annualSubscription: 149,
    supplementSales: "Primary revenue stream through affiliate marketing"
  },

  userPainPoints: [
    "Cost per recipe adds up quickly for multiple pets",
    "No support for exotic pets (birds, reptiles, etc.)",
    "Requires veterinary knowledge to interpret results",
    "No automated meal planning or shopping features",
    "Limited ingredient database forces manual entry",
    "Outdated interface feels unprofessional",
    "No mobile access for on-the-go pet parents",
    "Expensive subscription model vs one-time purchases",
    "No community support or user resources",
    "Time-consuming process for regular meal prep"
  ],

  marketPosition: "Veterinary-focused supplement recommendation tool",

  targetUsers: [
    "Veterinary practices and animal hospitals",
    "Professional animal nutritionists",
    "Pet owners willing to pay premium for vet-backed advice",
    "Dog and cat owners with specific health concerns",
    "Users who prefer supplement-based solutions"
  ]
};

// Key competitive advantages for Paw & Plate
export const PAW_PLATE_ADVANTAGES = {
  exoticSupport: {
    title: "Complete Exotic Pet Coverage",
    description: "While BalanceIT only supports dogs and cats, Paw & Plate covers birds, reptiles, and pocket pets with species-specific nutrition standards.",
    impact: "Captures entire exotic pet market (30% of pet owners)"
  },

  pricingModel: {
    title: "Free Core Features",
    description: "Free recipe generation and meal planning vs $14.95 per recipe.",
    impact: "10x more accessible to average pet owners"
  },

  userExperience: {
    title: "Modern Mobile-First Design",
    description: "Beautiful, responsive interface vs 20-year-old web design.",
    impact: "Higher user engagement and satisfaction"
  },

  automation: {
    title: "One-Click Shopping",
    description: "Automated shopping lists with affiliate links vs manual sourcing.",
    impact: "Saves users 30+ minutes per meal prep"
  },

  community: {
    title: "User Community",
    description: "Recipe sharing and community features vs isolated experience.",
    impact: "Builds user loyalty and engagement"
  }
};

// Market opportunity analysis
export const MARKET_OPPORTUNITY = {
  totalAddressableMarket: "Pet nutrition software market: $2.3B globally",
  balanceitMarketShare: "~5% of dog/cat nutrition market",
  exoticPetGap: "70% of exotic pet owners have no nutrition planning tools",
  pricingAdvantage: "90% cost reduction vs BalanceIT's premium pricing",
  userAcquisition: "Free tier enables viral growth and affiliate monetization",

  projectedMetrics: {
    year1Users: 50000,
    year2Users: 250000,
    revenueModel: "Affiliate commissions + premium features",
    competitiveMoat: "Exotic pet specialization + modern UX"
  }
};
</file>

<file path="lib/data/__tests__/TESTEST.ts">
// test-next-nutrition.js (in project root)
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üß™ Testing Nutrition Integration in Next.js Project\n');

// Check if nutrition file exists
const nutritionFile = path.join(__dirname, 'lib', 'data', 'IngredientNutrition.txt');
console.log(`1. Nutrition file: ${fs.existsSync(nutritionFile) ? '‚úÖ Exists' : '‚ùå Missing'}`);

// Check recipe-generator.ts
const recipeFile = path.join(__dirname, 'lib', 'recipe-generator.ts');
if (fs.existsSync(recipeFile)) {
  const content = fs.readFileSync(recipeFile, 'utf-8');
  
  console.log(`2. recipe-generator.ts: ‚úÖ Exists (${content.length} chars)`);
  
  // Check for key markers
  const hasNutritionFunction = content.includes('calculateNutritionalContribution');
  const hasIngredientBreakdown = content.match(/ingredientBreakdown.*map/);
  const hasHardcodedProtein = content.includes('ing.name.toLowerCase().includes(\'chicken\') ? 20 : 2');
  
  console.log(`   Has calculateNutritionalContribution: ${hasNutritionFunction ? '‚úÖ' : '‚ùå'}`);
  console.log(`   Has ingredientBreakdown mapping: ${hasIngredientBreakdown ? '‚úÖ' : '‚ùå'}`);
  console.log(`   Still has hardcoded protein (20): ${hasHardcodedProtein ? '‚ùå YES - NOT INTEGRATED' : '‚úÖ NO - GOOD'}`);
  
  // Check the actual lines around ingredientBreakdown
  const lines = content.split('\n');
  const breakdownIndex = lines.findIndex(line => line.includes('ingredientBreakdown'));
  
  if (breakdownIndex !== -1) {
    console.log(`\n3. Checking ingredientBreakdown (lines ${breakdownIndex-5} to ${breakdownIndex+10}):`);
    for (let i = Math.max(0, breakdownIndex-5); i < Math.min(lines.length, breakdownIndex+10); i++) {
      console.log(`   ${i+1}: ${lines[i]}`);
    }
  }
  
} else {
  console.log('‚ùå recipe-generator.ts not found!');
}

// Try to run a simple TypeScript check
console.log('\n4. Trying to check TypeScript compilation...');
try {
  // Create a minimal test file
  const testCode = `
import { getRecipeTemplates } from './lib/recipe-generator.ts';
console.log('Test passed - can import recipe generator');
`;
  
  fs.writeFileSync('temp-test.ts', testCode);
  
  // Try to compile it
  execSync('npx tsc --noEmit temp-test.ts', { stdio: 'pipe' });
  console.log('‚úÖ TypeScript compilation check passed');
  fs.unlinkSync('temp-test.ts');
} catch (error) {
  console.log('‚ùå TypeScript compilation error:', error.message);
  try { fs.unlinkSync('temp-test.ts'); } catch {}
}
</file>

<file path="lib/data/__tests__/vetted-products-species.test.ts">
/**
 * Unit tests for species-aware product matching in getVettedProduct
 */

import { getVettedProduct } from '../vetted-products';

describe('getVettedProduct with species filtering', () => {
  describe('Dog-specific products', () => {
    it('should return dog product when species is dogs', () => {
      const product = getVettedProduct('joint supplement', 'dogs');
      expect(product).toBeDefined();
      expect(product?.productName).toContain('Cosequin');
      expect(product?.productName).toContain('Dogs');
    });

    it('should return undefined when species is cats (dog product rejected)', () => {
      const product = getVettedProduct('joint supplement', 'cats');
      // Should be undefined because product has species: 'dogs' and productName contains "for Dogs"
      expect(product).toBeUndefined();
    });

    it('should return dog product for joint health supplement when species is dogs', () => {
      const product = getVettedProduct('joint health supplement', 'dogs');
      expect(product).toBeDefined();
      expect(product?.productName).toContain('Dogs');
    });

    it('should return undefined for joint health supplement when species is cats', () => {
      const product = getVettedProduct('joint health supplement', 'cats');
      expect(product).toBeUndefined();
    });

    it('should reject chicken broth for cats (contains "for Dogs")', () => {
      const product = getVettedProduct('chicken broth', 'cats');
      // Should be undefined because productName contains "for Dogs"
      expect(product).toBeUndefined();
    });

    it('should allow chicken broth for dogs', () => {
      const product = getVettedProduct('chicken broth', 'dogs');
      expect(product).toBeDefined();
      expect(product?.productName).toContain('Dogs');
    });
  });

  describe('Defensive name-based validation', () => {
    it('should reject products with "for Dogs" in name when species is cats', () => {
      // Test with a known dog product
      const product = getVettedProduct('sardine oil', 'cats');
      // Should be undefined because productName contains "Zesty Paws Sardine Oil for Dogs"
      expect(product).toBeUndefined();
    });

    it('should reject products with "Dog Food" in name when species is cats', () => {
      // This test verifies the defensive check works
      // If there were a product with "Dog Food" in the name, it should be rejected for cats
      // We test this indirectly through existing dog products
      const product = getVettedProduct('joint supplement', 'cats');
      expect(product).toBeUndefined();
    });
  });

  describe('Products without species restrictions', () => {
    it('should return product when no species specified (backward compatibility)', () => {
      const product = getVettedProduct('ground beef (lean)');
      expect(product).toBeDefined();
    });

    it('should return product when species matches undefined/no species field', () => {
      // Products without species field should work for any species (backward compatibility)
      const product = getVettedProduct('ground beef (lean)', 'cats');
      expect(product).toBeDefined();
    });
  });

  describe('Species field validation', () => {
    it('should handle products with species: "dogs" correctly', () => {
      const dogProduct = getVettedProduct('joint supplement', 'dogs');
      const catProduct = getVettedProduct('joint supplement', 'cats');
      
      expect(dogProduct).toBeDefined();
      expect(catProduct).toBeUndefined();
    });

    it('should handle products with species: "both" correctly', () => {
      // Note: We don't currently have products with species: 'both' in the test data
      // This test is a placeholder for when such products are added
      // For now, we test that products without species field work for both
      const productDogs = getVettedProduct('ground beef (lean)', 'dogs');
      const productCats = getVettedProduct('ground beef (lean)', 'cats');
      
      // Products without species field should work for both (backward compatibility)
      expect(productDogs).toBeDefined();
      expect(productCats).toBeDefined();
    });
  });
});
</file>

<file path="lib/data/__tests__/vetted-products.test.ts">
// lib/data/__tests__/vetted-products.test.ts
import { describe, it, expect } from 'vitest';
import { VETTED_PRODUCTS, getVettedProduct } from '../vetted-products';
import { hasSellerId, extractASIN } from '@/lib/utils/affiliateLinks';

describe('vetted-products data validation', () => {
  const SELLER_ID = 'robinfrench-20';

  describe('All vetted products have seller ID', () => {
    it('should have seller ID in all asinLink entries', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const missingSellerId: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (product.asinLink && !hasSellerId(product.asinLink)) {
          missingSellerId.push(ingredient);
        }
      });

      expect(missingSellerId).toEqual([]);
    });
  });

  describe('All vetted products use specific ASIN links', () => {
    it('should use /dp/ASIN or /gp/product/ASIN format (not search URLs)', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const genericSearches: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (product.asinLink) {
          // Check if it's a generic search URL
          if (product.asinLink.includes('/s?k=') || product.asinLink.includes('/s?')) {
            genericSearches.push(ingredient);
          }
          // Should have ASIN pattern
          const asin = extractASIN(product.asinLink);
          if (!asin) {
            genericSearches.push(ingredient);
          }
        }
      });

      expect(genericSearches).toEqual([]);
    });

    it('should have valid ASIN format (10 alphanumeric characters)', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const invalidASINs: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (product.asinLink) {
          const asin = extractASIN(product.asinLink);
          if (asin && !/^[A-Z0-9]{10}$/.test(asin)) {
            invalidASINs.push(ingredient);
          }
        }
      });

      expect(invalidASINs).toEqual([]);
    });
  });

  describe('All vetted products have productName', () => {
    it('should have productName for all entries', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const missingProductName: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (!product.productName || product.productName.trim() === '') {
          missingProductName.push(ingredient);
        }
      });

      expect(missingProductName).toEqual([]);
    });

    it('should have non-empty productName', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      
      entries.forEach(([ingredient, product]) => {
        expect(product.productName).toBeTruthy();
        expect(product.productName.trim().length).toBeGreaterThan(0);
      });
    });
  });

  describe('ASIN link format validation', () => {
    it('should use amazon.com domain', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const invalidDomains: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (product.asinLink) {
          if (!product.asinLink.includes('amazon.com')) {
            invalidDomains.push(ingredient);
          }
        }
      });

      expect(invalidDomains).toEqual([]);
    });

    it('should have asinLink or purchaseLink', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const missingLinks: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (!product.asinLink && !product.purchaseLink) {
          missingLinks.push(ingredient);
        }
      });

      // Allow some entries to have only purchaseLink if needed
      // But we expect most to have asinLink
      expect(missingLinks.length).toBeLessThan(entries.length * 0.1); // Less than 10% missing
    });
  });

  describe('getVettedProduct function', () => {
    it('should return product for exact match', () => {
      const testIngredient = Object.keys(VETTED_PRODUCTS)[0];
      const result = getVettedProduct(testIngredient);
      expect(result).toBeDefined();
      expect(result?.productName).toBeDefined();
      expect(result?.asinLink).toBeDefined();
    });

    it('should handle case-insensitive lookup', () => {
      const testIngredient = Object.keys(VETTED_PRODUCTS)[0];
      const upperCase = testIngredient.toUpperCase();
      const result = getVettedProduct(upperCase);
      expect(result).toBeDefined();
    });

    it('should handle whitespace variations', () => {
      const testIngredient = Object.keys(VETTED_PRODUCTS)[0];
      const withSpaces = `  ${testIngredient}  `;
      const result = getVettedProduct(withSpaces);
      expect(result).toBeDefined();
    });

    it('should return undefined for non-existent ingredient', () => {
      const result = getVettedProduct('nonexistent-ingredient-xyz123');
      expect(result).toBeUndefined();
    });
  });

  describe('Data integrity checks', () => {
    it('should have vetNote for all entries', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const missingVetNote: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (!product.vetNote || product.vetNote.trim() === '') {
          missingVetNote.push(ingredient);
        }
      });

      expect(missingVetNote).toEqual([]);
    });

    it('should have category for all entries', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const missingCategory: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (!product.category) {
          missingCategory.push(ingredient);
        }
      });

      // Category is optional, but we should have most entries with it
      expect(missingCategory.length).toBeLessThan(entries.length * 0.2); // Less than 20% missing
    });
  });

  describe('Seller ID format validation', () => {
    it('should use correct seller ID format in all links', () => {
      const entries = Object.entries(VETTED_PRODUCTS);
      const wrongSellerId: string[] = [];

      entries.forEach(([ingredient, product]) => {
        if (product.asinLink) {
          // Check for correct seller ID
          const hasCorrectId = product.asinLink.includes(`tag=${SELLER_ID}`) || 
                              product.asinLink.includes(`AssociateTag=${SELLER_ID}`);
          if (!hasCorrectId && hasSellerId(product.asinLink)) {
            // Has a seller ID but not ours
            wrongSellerId.push(ingredient);
          }
        }
      });

      expect(wrongSellerId).toEqual([]);
    });
  });
});
</file>

<file path="lib/data/aafco-standards.ts">
// lib/data/aafco-standards.ts
// AAFCO (Association of American Feed Control Officials) nutritional standards
// for dog and cat food - based on 2023 guidelines
// Also includes research-based standards for birds, reptiles, and pocket-pets

export interface NutritionalStandard {
  protein: { min: number; max: number }; // % on dry matter basis
  fat: { min: number; max: number }; // % on dry matter basis
  calcium: { min: number; max: number }; // mg per 1000 kcal
  phosphorus: { min: number; max: number }; // mg per 1000 kcal
  caPRatio: { min: number; max: number }; // calcium to phosphorus ratio
  fiber: { min: number; max: number }; // % on dry matter basis
  omega6: { min: number }; // % on dry matter basis
  omega3?: { min: number }; // % on dry matter basis (optional for dogs)
}

export const AAFCO_STANDARDS: {
  dogs: {
    puppy: NutritionalStandard;
    adult: NutritionalStandard;
    senior: NutritionalStandard;
  };
  cats: {
    puppy: NutritionalStandard; // kitten
    adult: NutritionalStandard;
    senior: NutritionalStandard;
  };
} = {
  // Dog Standards
  dogs: {
    // Growth and Reproduction (Puppies, Pregnant/Lactating)
    puppy: {
      protein: { min: 22.5, max: 35 }, // Higher for growth
      fat: { min: 8.5, max: 20 },
      calcium: { min: 1000, max: 2500 }, // mg per 1000 kcal (1.0% - 2.5% DM)
      phosphorus: { min: 800, max: 1600 }, // mg per 1000 kcal (0.8% - 1.6% DM)
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 1.3 },
      omega3: { min: 0.13 },
    },
    
    // Adult Maintenance
    adult: {
      protein: { min: 18, max: 32 },
      fat: { min: 5.5, max: 18 },
      calcium: { min: 500, max: 2500 }, // mg per 1000 kcal (0.5% - 2.5% DM)
      phosphorus: { min: 400, max: 1600 }, // mg per 1000 kcal (0.4% - 1.6% DM)
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 1.1 },
    },
    
    // Senior (same as adult but often lower protein/phosphorus recommended)
    senior: {
      protein: { min: 18, max: 28 }, // Slightly lower max
      fat: { min: 5.5, max: 15 },
      calcium: { min: 500, max: 1800 }, // Lower max for kidney health
      phosphorus: { min: 400, max: 1200 }, // Lower max for kidney health
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 1.1 },
    },
  },

  // Cat Standards
  cats: {
    // Growth and Reproduction (Kittens, Pregnant/Lactating)
    puppy: { // Using 'puppy' key for kittens to match the interface
      protein: { min: 30, max: 45 }, // Cats are obligate carnivores - higher protein
      fat: { min: 9, max: 25 },
      calcium: { min: 1000, max: 2500 }, // mg per 1000 kcal
      phosphorus: { min: 800, max: 1600 }, // mg per 1000 kcal
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 0.6 },
    },
    
    // Adult Maintenance
    adult: {
      protein: { min: 26, max: 40 }, // Higher than dogs
      fat: { min: 9, max: 22 },
      calcium: { min: 600, max: 2500 }, // mg per 1000 kcal
      phosphorus: { min: 500, max: 1600 }, // mg per 1000 kcal
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 0.6 },
    },
    
    // Senior (lower phosphorus for kidney health)
    senior: {
      protein: { min: 26, max: 35 },
      fat: { min: 9, max: 20 },
      calcium: { min: 600, max: 1800 },
      phosphorus: { min: 500, max: 1200 }, // Lower max for kidney health
      caPRatio: { min: 1.0, max: 2.0 },
      fiber: { min: 0, max: 5 },
      omega6: { min: 0.6 },
    },
  },
};

// Species-specific nutritional guidelines (non-AAFCO, research-based)
export const SPECIES_NUTRITIONAL_GUIDELINES = {
  birds: {
    // Based on avian nutrition research
    small: { // Parakeets, canaries, finches
      protein: { min: 12, max: 18 },
      fat: { min: 3, max: 8 },
      fiber: { min: 3, max: 8 },
      calcium: { min: 0.3, max: 1.2 }, // % of diet
    },
    medium: { // Cockatiels, conures
      protein: { min: 14, max: 20 },
      fat: { min: 4, max: 10 },
      fiber: { min: 4, max: 10 },
      calcium: { min: 0.4, max: 1.5 },
    },
    large: { // Macaws, cockatoos, African greys
      protein: { min: 15, max: 22 },
      fat: { min: 5, max: 12 },
      fiber: { min: 5, max: 12 },
      calcium: { min: 0.5, max: 2.0 },
    },
  },

  reptiles: {
    // Based on herpetological nutrition research
    herbivore: { // Iguanas, tortoises
      protein: { min: 15, max: 25 },
      fiber: { min: 20, max: 35 },
      caPRatio: { min: 1.5, max: 2.5 }, // Critical for bone health
      calcium: { min: 0.8, max: 2.0 }, // % of diet
    },
    carnivore: { // Monitors, snakes
      protein: { min: 30, max: 50 },
      fat: { min: 10, max: 25 },
      caPRatio: { min: 1.2, max: 2.0 },
      calcium: { min: 0.6, max: 1.5 },
    },
    omnivore: { // Bearded dragons, blue-tongue skinks
      protein: { min: 20, max: 35 },
      fiber: { min: 10, max: 25 },
      caPRatio: { min: 1.5, max: 2.5 },
      calcium: { min: 0.8, max: 2.0 },
    },
  },

  'pocket-pets': {
    // Based on small mammal nutrition research
    hamster: {
      protein: { min: 16, max: 24 },
      fat: { min: 4, max: 10 },
      fiber: { min: 8, max: 15 },
      caPRatio: { min: 1.5, max: 2.0 },
    },
    'guinea-pig': {
      protein: { min: 16, max: 20 },
      fat: { min: 3, max: 6 },
      fiber: { min: 12, max: 20 }, // High fiber requirement
      caPRatio: { min: 1.5, max: 2.0 },
      vitaminC: { min: 10 }, // mg per kg body weight per day - guinea pigs can't synthesize vitamin C
    },
    rabbit: {
      protein: { min: 14, max: 18 },
      fat: { min: 2, max: 5 },
      fiber: { min: 18, max: 25 }, // Very high fiber requirement
      caPRatio: { min: 1.5, max: 2.0 },
    },
    ferret: {
      protein: { min: 32, max: 38 }, // Obligate carnivores like cats
      fat: { min: 15, max: 20 },
      fiber: { min: 0, max: 3 }, // Low fiber tolerance
      caPRatio: { min: 1.0, max: 2.0 },
    },
  },
};

/**
 * Get the appropriate nutritional standard for a given species and life stage
 */
export function getNutritionalStandard(
  species: string,
  lifeStage: 'puppy' | 'adult' | 'senior' = 'adult',
  subtype?: string // for birds (small/medium/large) or reptiles (herbivore/carnivore/omnivore)
): NutritionalStandard | any {
  if (species === 'dogs' || species === 'cats') {
    return AAFCO_STANDARDS[species][lifeStage];
  }

  if (species === 'birds' && subtype) {
    return SPECIES_NUTRITIONAL_GUIDELINES.birds[subtype as keyof typeof SPECIES_NUTRITIONAL_GUIDELINES.birds];
  }

  if (species === 'reptiles' && subtype) {
    return SPECIES_NUTRITIONAL_GUIDELINES.reptiles[subtype as keyof typeof SPECIES_NUTRITIONAL_GUIDELINES.reptiles];
  }

  if (species === 'pocket-pets' && subtype) {
    return SPECIES_NUTRITIONAL_GUIDELINES['pocket-pets'][subtype as keyof typeof SPECIES_NUTRITIONAL_GUIDELINES['pocket-pets']];
  }

  // Default fallback
  return AAFCO_STANDARDS.dogs.adult;
}

// Legacy exports for backward compatibility
export interface NutrientRange {
  min?: number;
  max?: number;
  unit: string;
  critical?: boolean;
  note?: string;
}

export interface NutrientProfile {
  protein: NutrientRange;
  fat: NutrientRange;
  calcium: NutrientRange;
  phosphorus: NutrientRange;
  CaP_ratio?: NutrientRange;
  linoleic_acid?: NutrientRange;
  arachidonic_acid?: NutrientRange;
  taurine?: NutrientRange;
  omega3?: NutrientRange;
  vitaminE?: NutrientRange;
  vitaminA?: NutrientRange;
  vitaminD?: NutrientRange;
  source: string;
}

export const AAFCO_NUTRIENT_PROFILES = {
  dog: {
    adultMaintenance: {
      protein: { min: 18.0, unit: '% DM', critical: true },
      fat: { min: 5.5, unit: '% DM' },
      calcium: { min: 0.6, max: 2.5, unit: '% DM', critical: true },
      phosphorus: { min: 0.5, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.0, unit: 'ratio', critical: true },
      linoleic_acid: { min: 1.0, unit: '% DM' },
      vitaminE: { min: 50, unit: 'IU/kg' },
      vitaminA: { min: 5000, unit: 'IU/kg' },
      vitaminD: { min: 500, unit: 'IU/kg' },
      source: "AAFCO 2023 Dog Food Nutrient Profiles"
    } as NutrientProfile,

    growthReproduction: {
      protein: { min: 22.0, unit: '% DM', critical: true },
      fat: { min: 8.0, unit: '% DM' },
      calcium: { min: 1.0, max: 1.8, unit: '% DM', critical: true },
      phosphorus: { min: 0.8, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.0, unit: 'ratio', critical: true },
      linoleic_acid: { min: 1.0, unit: '% DM' },
      vitaminE: { min: 50, unit: 'IU/kg' },
      vitaminA: { min: 5000, unit: 'IU/kg' },
      vitaminD: { min: 500, unit: 'IU/kg' },
      source: "AAFCO 2023 Dog Food Nutrient Profiles"
    } as NutrientProfile,

    allLifeStages: {
      protein: { min: 20.0, unit: '% DM', critical: true },
      fat: { min: 8.0, unit: '% DM' },
      calcium: { min: 1.0, max: 1.8, unit: '% DM', critical: true },
      phosphorus: { min: 0.8, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.0, unit: 'ratio', critical: true },
      linoleic_acid: { min: 1.0, unit: '% DM' },
      vitaminE: { min: 50, unit: 'IU/kg' },
      vitaminA: { min: 5000, unit: 'IU/kg' },
      vitaminD: { min: 500, unit: 'IU/kg' },
      source: "AAFCO 2023 Dog Food Nutrient Profiles"
    } as NutrientProfile
  },

  cat: {
    adultMaintenance: {
      protein: { min: 26.0, unit: '% DM', critical: true },
      fat: { min: 9.0, unit: '% DM' },
      calcium: { min: 0.6, unit: '% DM', critical: true },
      phosphorus: { min: 0.5, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.5, unit: 'ratio', critical: true },
      taurine: { min: 0.10, unit: '% DM', critical: true, note: "Essential amino acid" },
      arachidonic_acid: { min: 0.02, unit: '% DM' },
      linoleic_acid: { min: 0.5, unit: '% DM' },
      vitaminE: { min: 30, unit: 'IU/kg' },
      vitaminA: { min: 3333, unit: 'IU/kg' },
      vitaminD: { min: 333, unit: 'IU/kg' },
      source: "AAFCO 2023 Cat Food Nutrient Profiles"
    } as NutrientProfile,

    growthReproduction: {
      protein: { min: 30.0, unit: '% DM', critical: true },
      fat: { min: 9.0, unit: '% DM' },
      calcium: { min: 1.0, unit: '% DM', critical: true },
      phosphorus: { min: 0.8, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.0, unit: 'ratio', critical: true },
      taurine: { min: 0.10, unit: '% DM', critical: true },
      arachidonic_acid: { min: 0.02, unit: '% DM' },
      linoleic_acid: { min: 0.5, unit: '% DM' },
      vitaminE: { min: 30, unit: 'IU/kg' },
      vitaminA: { min: 3333, unit: 'IU/kg' },
      vitaminD: { min: 333, unit: 'IU/kg' },
      source: "AAFCO 2023 Cat Food Nutrient Profiles"
    } as NutrientProfile,

    allLifeStages: {
      protein: { min: 30.0, unit: '% DM', critical: true },
      fat: { min: 9.0, unit: '% DM' },
      calcium: { min: 1.0, unit: '% DM', critical: true },
      phosphorus: { min: 0.8, unit: '% DM', critical: true },
      CaP_ratio: { min: 1.0, max: 2.0, unit: 'ratio', critical: true },
      taurine: { min: 0.10, unit: '% DM', critical: true },
      arachidonic_acid: { min: 0.02, unit: '% DM' },
      linoleic_acid: { min: 0.5, unit: '% DM' },
      vitaminE: { min: 30, unit: 'IU/kg' },
      vitaminA: { min: 3333, unit: 'IU/kg' },
      vitaminD: { min: 333, unit: 'IU/kg' },
      source: "AAFCO 2023 Cat Food Nutrient Profiles"
    } as NutrientProfile
  }
};

export function getAAFCOStandards(species: 'dog' | 'cat', lifeStage: 'adult' | 'growth' | 'all' = 'adult'): NutrientProfile {
  const speciesData = AAFCO_NUTRIENT_PROFILES[species];

  switch (lifeStage) {
    case 'adult':
      return speciesData.adultMaintenance;
    case 'growth':
      return speciesData.growthReproduction;
    case 'all':
      return speciesData.allLifeStages;
    default:
      return speciesData.adultMaintenance;
  }
}

export function validateCriticalNutrients(recipe: any, species: 'dog' | 'cat', lifeStage: 'adult' | 'growth' = 'adult'): {
  isValid: boolean;
  violations: string[];
  warnings: string[];
} {
  const standards = getAAFCOStandards(species, lifeStage);
  const violations: string[] = [];
  const warnings: string[] = [];

  const getNutrientValue = (nutrient: any): number => {
    if (typeof nutrient === 'number') return nutrient;
    if (nutrient?.min) return nutrient.min;
    if (nutrient?.max) return nutrient.max;
    if (nutrient?.value) return nutrient.value;
    return 0;
  };

  const protein = getNutrientValue(recipe.protein);
  const calcium = getNutrientValue(recipe.calcium);
  const phosphorus = getNutrientValue(recipe.phosphorus);
  const fat = getNutrientValue(recipe.fat);
  const fiber = getNutrientValue(recipe.fiber);
  const taurine = getNutrientValue(recipe.taurine);

  if (protein < (standards.protein.min || 0)) {
    violations.push(`Protein too low: ${protein.toFixed(1)}% vs minimum ${standards.protein.min}% (AAFCO requirement)`);
  } else if (protein > (standards.protein.max || 100)) {
    warnings.push(`Protein may be high: ${protein.toFixed(1)}% vs maximum ${standards.protein.max}%`);
  }

  if (fat < (standards.fat?.min || 0)) {
    violations.push(`Fat too low: ${fat.toFixed(1)}% vs minimum ${standards.fat.min}% (AAFCO requirement)`);
  } else if (fat > (standards.fat?.max || 100)) {
    warnings.push(`Fat may be high: ${fat.toFixed(1)}% vs maximum ${standards.fat.max}%`);
  }

  if (calcium < (standards.calcium.min || 0)) {
    violations.push(`Calcium too low: ${calcium.toFixed(1)}% vs minimum ${standards.calcium.min}% (AAFCO requirement)`);
  } else if (calcium > (standards.calcium.max || 999)) {
    violations.push(`Calcium too high: ${calcium.toFixed(1)}% vs maximum ${standards.calcium.max}% (may cause skeletal issues)`);
  }

  if (phosphorus < (standards.phosphorus.min || 0)) {
    violations.push(`Phosphorus too low: ${phosphorus.toFixed(1)}% vs minimum ${standards.phosphorus.min}% (AAFCO requirement)`);
  } else if (phosphorus > (standards.phosphorus.max || 999)) {
    warnings.push(`Phosphorus may be high: ${phosphorus.toFixed(1)}% vs maximum ${standards.phosphorus.max}%`);
  }

  if (phosphorus > 0) {
    const caPRatio = calcium / phosphorus;
    const caPStandard = standards.CaP_ratio;
    if (caPStandard) {
      if (caPRatio < (caPStandard.min || 0)) {
        violations.push(`Ca:P ratio too low: ${caPRatio.toFixed(2)} vs minimum ${caPStandard.min} (may cause bone issues)`);
      } else if (caPRatio > (caPStandard.max || 999)) {
        warnings.push(`Ca:P ratio high: ${caPRatio.toFixed(2)} vs maximum ${caPStandard.max}`);
      }
    }
  }

  if (fiber > 0 && (standards as any).fiber) {
    const fiberStandard = (standards as any).fiber;
    if (fiber < (fiberStandard.min || 0)) {
      warnings.push(`Fiber may be low: ${fiber.toFixed(1)}% vs recommended ${fiberStandard.min}%`);
    } else if (fiber > (fiberStandard.max || 100)) {
      warnings.push(`Fiber may be high: ${fiber.toFixed(1)}% vs maximum ${fiberStandard.max}%`);
    }
  }

  if (species === 'cat' && standards.taurine) {
    const taurineMin = standards.taurine.min || 0;
    if (taurine < taurineMin) {
      violations.push(`Taurine too low: ${taurine.toFixed(3)}% vs minimum ${taurineMin}% (CRITICAL for cats - can cause heart/eye issues)`);
    }
  }

  return {
    isValid: violations.length === 0,
    violations,
    warnings
  };
}
</file>

<file path="lib/data/avian-nutrition-standards.ts">
// lib/data/avian-nutrition-standards.ts
// Avian nutrition standards from veterinary and zoological sources
// Based on Association of Zoos & Aquariums (AZA) and Merck Veterinary Manual

export interface NutrientRequirement {
  min?: number;
  max?: number;
  unit: string;
  source?: string;
  critical?: boolean;
  note?: string;
}

export interface AvianNutritionProfile {
  protein: NutrientRequirement;
  fat: NutrientRequirement;
  calcium: NutrientRequirement;
  phosphorus: NutrientRequirement;
  CaP_ratio: NutrientRequirement;
  vitaminA: NutrientRequirement;
  vitaminD3: NutrientRequirement;
  vitaminE?: NutrientRequirement;
  omega3?: NutrientRequirement;
  fiber?: NutrientRequirement;
}

export interface DeficiencyInfo {
  species: string;
  deficiency: string;
  symptoms: string;
  prevention: string;
  severity: 'mild' | 'moderate' | 'severe' | 'life-threatening';
}

export const AVIAN_NUTRITION_STANDARDS = {
  // AZA (Association of Zoos & Aquariums) Standards
  psittacines: {
    protein: { min: 12, max: 18, unit: '% DM', source: "AZA Parrot TAG" },
    fat: { min: 4, max: 10, unit: '% DM', note: "Higher for large parrots" },
    calcium: { min: 0.5, max: 1.2, unit: '% DM', critical: true },
    phosphorus: { min: 0.3, max: 0.7, unit: '% DM' },
    CaP_ratio: { min: 1.5, max: 2.5, unit: 'ratio', critical: true },
    vitaminA: { min: 5000, unit: 'IU/kg', deficiency: "Common in seed-only diets" },
    vitaminD3: { min: 1000, unit: 'IU/kg', note: "Requires UVB or supplementation" },
    vitaminE: { min: 50, unit: 'IU/kg', note: "Antioxidant support" },
    omega3: { min: 0.1, unit: '% DM', note: "For feather and skin health" },
    fiber: { min: 2, max: 8, unit: '% DM', note: "Digestive health" }
  } as AvianNutritionProfile,

  passerines: {
    protein: { min: 14, max: 20, unit: '% DM', source: "AZA Small Bird TAG" },
    fat: { min: 5, max: 12, unit: '% DM' },
    calcium: { min: 0.8, max: 1.5, unit: '% DM', critical: true },
    phosphorus: { min: 0.4, max: 0.8, unit: '% DM' },
    CaP_ratio: { min: 1.2, max: 2.0, unit: 'ratio', critical: true },
    vitaminA: { min: 8000, unit: 'IU/kg' },
    vitaminD3: { min: 1500, unit: 'IU/kg' }
  } as AvianNutritionProfile,

  raptors: {
    protein: { min: 16, max: 22, unit: '% DM', source: "AZA Raptor TAG" },
    fat: { min: 8, max: 15, unit: '% DM', note: "Higher energy requirements" },
    calcium: { min: 0.6, max: 1.0, unit: '% DM', critical: true },
    phosphorus: { min: 0.5, max: 0.9, unit: '% DM' },
    CaP_ratio: { min: 1.0, max: 1.8, unit: 'ratio', critical: true },
    vitaminA: { min: 6000, unit: 'IU/kg' },
    vitaminD3: { min: 1200, unit: 'IU/kg' }
  } as AvianNutritionProfile,

  // Merck Veterinary Manual Guidelines
  commonDeficiencies: [
    {
      species: "African Grey Parrot",
      deficiency: "Hypocalcemia",
      symptoms: "Seizures, weakness, egg binding",
      prevention: "Daily calcium-rich foods, UVB lighting",
      severity: "life-threatening"
    } as DeficiencyInfo,
    {
      species: "Cockatiel",
      deficiency: "Vitamin A",
      symptoms: "Respiratory issues, poor feather quality",
      prevention: "Orange vegetables, leafy greens",
      severity: "severe"
    } as DeficiencyInfo,
    {
      species: "Budgerigar",
      deficiency: "Iodine",
      symptoms: "Goiter, breathing difficulties",
      prevention: "Iodine blocks, varied diet",
      severity: "moderate"
    } as DeficiencyInfo,
    {
      species: "Amazon Parrot",
      deficiency: "Vitamin D3",
      symptoms: "Metabolic bone disease, weakness",
      prevention: "UVB exposure, vitamin D supplements",
      severity: "severe"
    } as DeficiencyInfo,
    {
      species: "Macaw",
      deficiency: "Omega-3 Fatty Acids",
      symptoms: "Poor feather quality, dry skin",
      prevention: "Fish, flaxseed, walnuts",
      severity: "mild"
    } as DeficiencyInfo
  ],

  // Species-Specific Requirements
  speciesRequirements: {
    african_grey: {
      specialNeeds: "High calcium, mental stimulation foods",
      toxicAvoid: "Avocado, chocolate, caffeine",
      recommended: "Walnuts, almonds, leafy greens, peppers",
      calciumRequirement: "1.0-1.2% DM",
      proteinRange: "12-16% DM"
    },
    cockatiel: {
      specialNeeds: "Lower fat than larger parrots",
      toxicAvoid: "Avocado, onions, alcohol",
      recommended: "Millet, sprouted seeds, cooked eggs",
      calciumRequirement: "0.8-1.0% DM",
      proteinRange: "14-18% DM"
    },
    macaw: {
      specialNeeds: "High-fat nuts for energy",
      toxicAvoid: "Avocado, chocolate, salt",
      recommended: "Brazil nuts, walnuts, palm nuts",
      calciumRequirement: "0.7-1.0% DM",
      proteinRange: "13-17% DM"
    },
    amazon: {
      specialNeeds: "Balanced nutrition, prone to obesity",
      toxicAvoid: "Avocado, chocolate, high-fat seeds",
      recommended: "Mixed vegetables, limited nuts",
      calciumRequirement: "0.8-1.1% DM",
      proteinRange: "12-16% DM"
    },
    budgerigar: {
      specialNeeds: "High metabolism, frequent feeding",
      toxicAvoid: "Avocado, chocolate, caffeine",
      recommended: "Millet, canary seed, vegetables",
      calciumRequirement: "0.9-1.2% DM",
      proteinRange: "15-20% DM"
    },
    cockatoo: {
      specialNeeds: "Destructible toys, fatty foods",
      toxicAvoid: "Avocado, chocolate, high-sodium foods",
      recommended: "Nuts, seeds, destructive foraging toys",
      calciumRequirement: "0.8-1.1% DM",
      proteinRange: "12-16% DM"
    }
  },

  // Critical Nutrient Interactions
  nutrientInteractions: {
    calciumPhosphorus: {
      importance: "Most critical ratio in avian nutrition",
      idealRange: "1.5-2.5:1",
      problems: {
        tooHigh: "Phosphorus excess leads to calcium depletion",
        tooLow: "Calcium excess can cause urinary issues"
      }
    },
    vitaminDVitaminA: {
      importance: "Both fat-soluble, work together for bone health",
      interaction: "Vitamin D helps absorb calcium, Vitamin A supports epithelial health"
    },
    iodineThyroid: {
      importance: "Seed-only diets often deficient",
      sources: "Iodine blocks, seaweed supplements"
    }
  },

  // Feeding Guidelines
  feedingGuidelines: {
    frequency: {
      smallBirds: "Feed 3-4 times daily",
      largeParrots: "Feed 2-3 times daily with foraging opportunities",
      note: "Fresh food should be available at all times"
    },
    portionControl: {
      pellets: "50-70% of diet",
      vegetables: "20-30% of diet",
      fruits: "5-10% of diet",
      treats: "5% or less"
    },
    waterRequirements: {
      fresh: "Always provide fresh, clean water",
      supplementation: "Consider vitamin/mineral supplements in water",
      note: "Change water daily to prevent bacterial growth"
    }
  }
};

// Helper functions for avian nutrition calculations
export function getAvianStandards(species: string): AvianNutritionProfile {
  // Map common species names to standard categories
  const speciesMap: Record<string, keyof typeof AVIAN_NUTRITION_STANDARDS> = {
    'african grey': 'psittacines',
    'cockatiel': 'psittacines',
    'budgerigar': 'passerines',
    'canary': 'passerines',
    'finch': 'passerines',
    'macaw': 'psittacines',
    'amazon': 'psittacines',
    'cockatoo': 'psittacines',
    'conure': 'psittacines',
    'lorikeet': 'psittacines',
    'lovebird': 'passerines',
    'parakeet': 'passerines'
  };

  const category = speciesMap[species.toLowerCase()] || 'psittacines';
  return AVIAN_NUTRITION_STANDARDS[category] as AvianNutritionProfile;
}

export function checkAvianDeficiencies(species: string): DeficiencyInfo[] {
  return AVIAN_NUTRITION_STANDARDS.commonDeficiencies.filter(
    def => def.species.toLowerCase().includes(species.toLowerCase().split(' ')[0])
  );
}
</file>

<file path="lib/data/badgeDefinitions.ts">
// lib/data/badgeDefinitions.ts
// Badge metadata definitions

import { BadgeType, BadgeTier } from '@/lib/types/badges';

export interface BadgeDefinition {
  type: BadgeType;
  name: string;
  description: string;
  category: string;
  iconPath: string; // Base path, will be extended with tier for progressive badges
  designDescription: string;
  isProgressive: boolean;
  tiers?: BadgeTierDefinition[];
}

export interface BadgeTierDefinition {
  tier: BadgeTier;
  name: string;
  threshold: number;
  iconPath: string;
  designDescription: string;
}

/**
 * Badge definitions with metadata
 */
export const BADGE_DEFINITIONS: Record<BadgeType, BadgeDefinition> = {
  [BadgeType.NUTRIENT_NAVIGATOR]: {
    type: BadgeType.NUTRIENT_NAVIGATOR,
    name: 'Perfect Match',
    description: 'Earned when you hit a 100% compatibility score.',
    category: 'The Quality Match',
    iconPath: '/images/ElvenBadges/bowl2-removebg-preview.png',
    designDescription: 'Bowl accessory - Perfect Match for 100% compatibility.',
    isProgressive: false,
  },

  [BadgeType.MASTER_MEAL_PLANNER]: {
    type: BadgeType.MASTER_MEAL_PLANNER,
    name: 'Feast Architect',
    description: 'Unlocked by building a layered or multi‚Äëstep meal plan.',
    category: 'Plan Variety & Engagement',
    iconPath: '/images/ElvenBadges/Spoon2-removebg-preview.png',
    designDescription: 'Spoon accessory - Feast Architect for meal planning achievement.',
    isProgressive: false,
  },

  [BadgeType.PLANNING_VOLUME]: {
    type: BadgeType.PLANNING_VOLUME,
    name: 'Week Whisker',
    description: 'Awarded for completing a full weekly plan.',
    category: 'Planning Volume',
    iconPath: '/images/ElvenBadges/Clipboard2-removebg-preview.png',
    designDescription: 'Clipboard accessory - Week Whisker for completing weekly meal plans.',
    isProgressive: true,
    tiers: [
      {
        tier: 'bronze',
        name: 'Week Whisker',
        threshold: 1,
        iconPath: '/images/ElvenBadges/Clipboard2-removebg-preview.png',
        designDescription: 'Clipboard accessory for completing your first weekly plan.',
      },
      {
        tier: 'silver',
        name: 'Week Whisker (Silver)',
        threshold: 10,
        iconPath: '/images/ElvenBadges/Clipboard2-removebg-preview.png',
        designDescription: 'Clipboard accessory for completing 10 weekly plans.',
      },
      {
        tier: 'gold',
        name: 'Week Whisker (Gold)',
        threshold: 50,
        iconPath: '/images/ElvenBadges/Clipboard2-removebg-preview.png',
        designDescription: 'Clipboard accessory for completing 50 weekly plans.',
      },
    ],
  },

  [BadgeType.PURCHASE_COMMITMENT]: {
    type: BadgeType.PURCHASE_COMMITMENT,
    name: 'Purchase Champion',
    description: 'Triggered by buying meals ‚Äî delivery energy.',
    category: 'Purchase Commitment',
    iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
    designDescription: 'Messenger bag accessory - Purchase Champion for meal purchases.',
    isProgressive: true,
    tiers: [
      {
        tier: 'bronze',
        name: 'Purchase Champion',
        threshold: 1,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for your first meal purchase.',
      },
      {
        tier: 'silver',
        name: 'Purchase Champion (Silver)',
        threshold: 10,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for 10 meal purchases.',
      },
      {
        tier: 'gold',
        name: 'Purchase Champion (Gold)',
        threshold: 20,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for 20 meal purchases.',
      },
      {
        tier: 'platinum',
        name: 'Purchase Champion (Platinum)',
        threshold: 30,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for 30 meal purchases.',
      },
      {
        tier: 'diamond',
        name: 'Purchase Champion (Diamond)',
        threshold: 40,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for 40 meal purchases.',
      },
      {
        tier: 'sultan',
        name: 'Purchase Champion (Sultan)',
        threshold: 50,
        iconPath: '/images/ElvenBadges/MessengerBag2-removebg-preview.png',
        designDescription: 'Messenger bag accessory for 50+ meal purchases.',
      },
    ],
  },
};

/**
 * Get badge definition by type
 */
export function getBadgeDefinition(type: BadgeType): BadgeDefinition {
  return BADGE_DEFINITIONS[type];
}

/**
 * Get tier definition for a progressive badge
 */
export function getTierDefinition(type: BadgeType, tier: BadgeTier): BadgeTierDefinition | null {
  const definition = BADGE_DEFINITIONS[type];
  if (!definition.isProgressive || !definition.tiers) {
    return null;
  }
  return definition.tiers.find(t => t.tier === tier) || null;
}

/**
 * Get tier for a given progress count
 */
export function getTierForProgress(type: BadgeType, progress: number): BadgeTier | null {
  const definition = BADGE_DEFINITIONS[type];
  if (!definition.isProgressive || !definition.tiers) {
    return null;
  }

  // Find the highest tier threshold that progress meets
  let currentTier: BadgeTier | null = null;
  for (const tierDef of definition.tiers) {
    if (progress >= tierDef.threshold) {
      currentTier = tierDef.tier;
    } else {
      break;
    }
  }

  return currentTier;
}

/**
 * Get next tier threshold for progress display
 */
export function getNextTierThreshold(type: BadgeType, currentTier: BadgeTier | null): number | null {
  const definition = BADGE_DEFINITIONS[type];
  if (!definition.isProgressive || !definition.tiers) {
    return null;
  }

  if (!currentTier) {
    // Return first tier threshold
    return definition.tiers[0]?.threshold || null;
  }

  const tierOrder: BadgeTier[] = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'sultan'];
  const currentIndex = tierOrder.indexOf(currentTier);
  
  if (currentIndex < 0 || currentIndex >= definition.tiers.length - 1) {
    return null; // Already at max tier
  }

  return definition.tiers[currentIndex + 1]?.threshold || null;
}
</file>

<file path="lib/data/baseRecipes.ts">
/**
 * Base Recipes Database
 * Real, vet-verified recipes for all pet species
 * Sources: Cats.com, Feline Nutrition Foundation, Reptile Centre, veterinary nutritionists
 */

export type PetSpecies = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

export interface BaseRecipe {
  id: string;
  name: string;
  species: PetSpecies;
  ageGroup: 'baby' | 'young' | 'adult' | 'senior';
  style: 'raw' | 'cooked' | 'mixed' | 'live-food' | 'seed-mix' | 'hay-based';
  description: string;
  source: string;
  sourceUrl?: string;
  ingredients: Array<{
    name: string;
    amount: number;
    unit: 'g' | 'oz' | 'cup' | 'tsp' | 'tbsp' | 'count' | 'ml';
    notes?: string;
  }>;
  supplements?: Array<{
    name: string;
    amount: number;
    unit: 'mg' | 'IU' | 'g' | 'tsp';
  }>;
  instructions: string[];
  servingSize: {
    amount: number;
    unit: 'g' | 'oz';
    frequency: string;
  };
  nutritionalTargets?: {
    protein: { min: number; max: number; unit: '%' | 'g' };
    fat: { min: number; max: number; unit: '%' | 'g' };
    fiber?: { min: number; max: number; unit: '%' | 'g' };
    calories?: number;
  };
  prepTime: number; // minutes
  cookTime?: number; // minutes
  storageInstructions: string;
  notes: string;
}

// ============================================================================
// CAT RECIPES (Vet-Verified from Cats.com & Feline Nutrition Foundation)
// ============================================================================

export const CAT_RECIPES: BaseRecipe[] = [
  {
    id: 'cat-raw-rabbit-alnutrin',
    name: 'Raw Ground Rabbit with Alnutrin',
    species: 'cats',
    ageGroup: 'adult',
    style: 'raw',
    description: 'Complete raw rabbit meal with bone and organs, balanced with Alnutrin premix',
    source: 'Cats.com (Kate Barrington)',
    sourceUrl: 'https://cats.com/homemade-cat-food-recipes',
    ingredients: [
      { name: 'Ground chicken', amount: 300, unit: 'g' },
      { name: 'Chicken liver', amount: 100, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
    ],
    instructions: [
      'Cut meat off rabbit carcass into 1-inch pieces',
      'Crush bones into small pieces',
      'Grind meat, bones, and organs together',
      'Whisk Alnutrin with water',
      'Stir mixture into ground rabbit',
      'Divide into portions and freeze',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 13.5, max: 13.5, unit: 'g' },
      fat: { min: 3.24, max: 3.24, unit: 'g' },
    },
    prepTime: 30,
    storageInstructions: 'Freeze in portions. Thaw in refrigerator before serving.',
    notes: 'Requires whole rabbit with organs. Alnutrin premix ensures complete nutrition.',
  },
  {
    id: 'cat-cooked-turkey-sweet-potato',
    name: 'Turkey Breast & Sweet Potato with Balance IT',
    species: 'cats',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Cooked turkey with sweet potato, balanced with Balance IT Carnivore Blend',
    source: 'Cats.com (Kate Barrington)',
    sourceUrl: 'https://cats.com/homemade-cat-food-recipes',
    ingredients: [
      { name: 'Turkey breast', amount: 150, unit: 'g' },
      { name: 'Sweet potato', amount: 100, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
      { name: 'Taurine powder', amount: 1, unit: 'tsp' },
    ],
    instructions: [
      'Roast turkey breast at 350¬∞F until internal temp reaches 165¬∞F',
      'Bake sweet potato until tender',
      'Scoop flesh from sweet potato',
      'Finely chop turkey breast',
      'Combine turkey and sweet potato',
      'Add supplements and stir well',
      'Divide into meals',
    ],
    servingSize: { amount: 170, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 47.73, max: 47.73, unit: '%' },
      fat: { min: 32.59, max: 32.59, unit: '%' },
    },
    prepTime: 15,
    cookTime: 30,
    storageInstructions: 'Refrigerate in airtight container for 3-4 days or freeze. Add supplements just before feeding.',
    notes: 'High-protein, low-carb option. Balance IT ensures complete nutrition.',
  },
  {
    id: 'cat-cooked-ground-beef-ezcomplete',
    name: 'Ground Beef with EZComplete',
    species: 'cats',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Cooked ground beef balanced with EZComplete Fur Cats premix',
    source: 'Cats.com (Kate Barrington)',
    sourceUrl: 'https://cats.com/homemade-cat-food-recipes',
    ingredients: [
      { name: 'Ground beef lean', amount: 300, unit: 'g' },
      { name: 'Chicken liver', amount: 100, unit: 'g' },
      { name: 'Taurine powder', amount: 2, unit: 'tsp' },
    ],
    instructions: [
      'Place ground meat in slow cooker',
      'Add ¬º cup water per pound of meat',
      'Cook on low for 4-6 hours',
      'Cool and shred or finely chop',
      'Stir in EZComplete until mixed',
      'Divide into portions',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 85, max: 85, unit: '%' },
      fat: { min: 11, max: 11, unit: '%' },
    },
    prepTime: 10,
    cookTime: 360,
    storageInstructions: 'Refrigerate in airtight containers for 3-4 days or freeze.',
    notes: 'EZComplete requires only boneless meat and water. Can be served raw or cooked.',
  },
  {
    id: 'cat-raw-chicken-feline-nutrition',
    name: 'Ground Chicken with Bone & Organs (Feline Nutrition Foundation)',
    species: 'cats',
    ageGroup: 'adult',
    style: 'raw',
    description: 'Raw chicken with bone and organs, supplemented with taurine and vitamins',
    source: 'Feline Nutrition Foundation',
    sourceUrl: 'https://hare-today.com/feline-nutrition/nutrition/making-raw-cat-food-for-do-it-yourselfers',
    ingredients: [
      { name: 'Chicken thighs', amount: 200, unit: 'g' },
      { name: 'Chicken liver', amount: 100, unit: 'g' },
      { name: 'Chicken hearts', amount: 50, unit: 'g' },
      { name: 'Eggs whole', amount: 50, unit: 'g' },
      { name: 'Taurine powder', amount: 2, unit: 'tsp' },
    ],
    supplements: [
      { name: 'Taurine', amount: 2000, unit: 'mg' },
      { name: 'Wild salmon oil capsules', amount: 4000, unit: 'mg' },
      { name: 'Vitamin B Complex', amount: 200, unit: 'mg' },
      { name: 'Vitamin E', amount: 200, unit: 'IU' },
    ],
    instructions: [
      'Remove skin from half the chicken thighs',
      'Remove bone from 20-25% of thighs',
      'Weigh out 4.5 pounds and rinse well',
      'Cut meat and organs into 1-inch pieces',
      'Crush bones as much as possible',
      'Feed through meat grinder with salmon oil capsules',
      'Whisk egg yolk with supplements',
      'Pour over ground ingredients and mix well',
      'Portion into containers and freeze',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 10.3, max: 10.3, unit: 'g' },
      fat: { min: 6.36, max: 6.36, unit: 'g' },
    },
    prepTime: 45,
    storageInstructions: 'Freeze in portions. Thaw in refrigerator before serving.',
    notes: 'Requires meat grinder. Use wild salmon oil, not cod liver oil (too high in vitamin A).',
  },
  {
    id: 'cat-prey-model-raw',
    name: 'Prey Model Raw (PMR+) Diet',
    species: 'cats',
    ageGroup: 'adult',
    style: 'raw',
    description: '80/10/10 model with variety of proteins, organs, and bones',
    source: 'The Little Carnivore (Coline Doebelin)',
    sourceUrl: 'https://thelittlecarnivore.com/en/blog/calculator-prey-model-raw-plus-diet-for-cats',
    ingredients: [
      { name: 'Chicken breast', amount: 150, unit: 'g' },
      { name: 'Ground beef lean', amount: 150, unit: 'g' },
      { name: 'Chicken hearts', amount: 50, unit: 'g' },
      { name: 'Chicken liver', amount: 50, unit: 'g' },
      { name: 'Sardines water', amount: 50, unit: 'g' },
      { name: 'Taurine powder', amount: 2, unit: 'tsp' },
    ],
    supplements: [
      { name: 'Chelated manganese', amount: 0, unit: 'mg' },
      { name: 'Kelp powder (iodine)', amount: 0, unit: 'mg' },
      { name: 'Psyllium husk (fiber)', amount: 0, unit: 'mg' },
      { name: 'Vitamin E', amount: 0, unit: 'IU' },
      { name: 'B-complex vitamins', amount: 0, unit: 'mg' },
      { name: 'Taurine (optional)', amount: 0, unit: 'mg' },
    ],
    instructions: [
      'Chop ingredients into 1-inch pieces',
      'Crush bones if needed for meat grinder',
      'Grind all ingredients in appropriate ratio',
      'Use Little Carnivore calculator for feeding amounts and supplement dosages',
      'Divide into portions and freeze',
      'At mealtime, add supplements and mix before serving',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 11.3, max: 11.3, unit: 'g' },
      fat: { min: 6.2, max: 6.2, unit: 'g' },
    },
    prepTime: 60,
    storageInstructions: 'Freeze in portions. Thaw in refrigerator before serving.',
    notes: 'Highly customizable. Use Little Carnivore calculator for precise supplement dosing based on cat weight.',
  },
  {
    id: 'cat-chicken-rice-kitten',
    name: 'Chicken & Rice Stew for Kittens',
    species: 'cats',
    ageGroup: 'baby',
    style: 'cooked',
    description: 'Simple, nutritious kitten meal with chicken, rice, fish oil and taurine',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Chicken breast', amount: 240, unit: 'g' },
      { name: 'Brown rice', amount: 60, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
      { name: 'Taurine', amount: 1, unit: 'tsp' },
    ],
    instructions: [
      'Combine shredded chicken and brown rice',
      'Add fish oil and crushed taurine supplement',
      'Mix thoroughly and serve warm',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 25, max: 30, unit: '%' },
      fat: { min: 8, max: 12, unit: '%' },
    },
    prepTime: 15,
    cookTime: 20,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Perfect for kittens. Simple and uses common ingredients.',
  },
  {
    id: 'cat-turkey-pumpkin-mash',
    name: 'Pumpkin & Turkey Mash',
    species: 'cats',
    ageGroup: 'baby',
    style: 'cooked',
    description: 'Gentle, digestive-friendly meal for kittens with turkey and pumpkin',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Ground turkey', amount: 240, unit: 'g' },
      { name: 'Pumpkin', amount: 60, unit: 'g' },
      { name: 'Carrots raw', amount: 60, unit: 'g' },
    ],
    instructions: [
      'Cook ground turkey until fully done',
      'Mix with pumpkin puree and mashed peas',
      'Cool and portion into small servings',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 20, max: 25, unit: '%' },
      fat: { min: 8, max: 10, unit: '%' },
    },
    prepTime: 10,
    cookTime: 15,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Pumpkin aids digestion. Good for kittens with sensitive stomachs.',
  },
  {
    id: 'cat-chicken-pumpkin-stew',
    name: 'Chicken & Pumpkin Stew',
    species: 'cats',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Balanced cooked meal with chicken, pumpkin, carrots, and peas',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Chicken breast', amount: 200, unit: 'g' },
      { name: 'Pumpkin', amount: 100, unit: 'g' },
      { name: 'Carrots raw', amount: 80, unit: 'g' },
      { name: 'Broccoli raw', amount: 60, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
      { name: 'Taurine powder', amount: 1, unit: 'tsp' },
    ],
    instructions: [
      'Cook chicken thoroughly, then chop into bite-sized pieces',
      'Steam or boil carrots and peas until soft',
      'Combine all ingredients in a pot, mixing well',
      'Stir in olive oil for added healthy fats',
      'Add taurine supplement',
      'Serve fresh, store leftovers in refrigerator',
    ],
    servingSize: { amount: 150, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 20, max: 25, unit: '%' },
      fat: { min: 8, max: 12, unit: '%' },
    },
    prepTime: 15,
    cookTime: 30,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Balanced combination of protein, fiber, and healthy fats.',
  },
  {
    id: 'cat-turkey-spinach-weight-management',
    name: 'Turkey & Spinach Stir Fry (Weight Management)',
    species: 'cats',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Lean protein meal for weight management with turkey and spinach',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Ground turkey', amount: 200, unit: 'g' },
      { name: 'Spinach raw', amount: 100, unit: 'g' },
      { name: 'Brown rice cooked', amount: 100, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
    ],
    instructions: [
      'Cook turkey thoroughly, draining any excess fat',
      'Add spinach and cook until wilted',
      'Stir in cooked rice and mix well',
      'Drizzle with flaxseed oil before serving',
    ],
    servingSize: { amount: 150, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 25, max: 30, unit: '%' },
      fat: { min: 5, max: 8, unit: '%' },
    },
    prepTime: 15,
    cookTime: 20,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Lean protein and fiber help cats feel fuller longer. Good for weight loss.',
  },
  {
    id: 'cat-mutton-sweet-potato-senior',
    name: 'Mutton & Sweet Potato Mash (Senior)',
    species: 'cats',
    ageGroup: 'senior',
    style: 'cooked',
    description: 'Easily digestible meal for senior cats with mutton and sweet potato',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Ground beef lean', amount: 200, unit: 'g' },
      { name: 'Sweet potato', amount: 100, unit: 'g' },
      { name: 'Carrots raw', amount: 80, unit: 'g' },
      { name: 'Taurine powder', amount: 1, unit: 'tsp' },
    ],
    instructions: [
      'Cook mutton until fully done, chopping into small pieces',
      'Boil or steam sweet potato until soft, then mash',
      'Combine mutton, sweet potato, and peas',
      'Add taurine supplement and mix well',
    ],
    servingSize: { amount: 150, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 22, max: 28, unit: '%' },
      fat: { min: 10, max: 14, unit: '%' },
    },
    prepTime: 15,
    cookTime: 30,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Rich in protein and easily digestible. Ideal for senior cats needing joint support.',
  },
  {
    id: 'cat-fish-quinoa-allergies',
    name: 'Fish & Quinoa Delight (Allergies)',
    species: 'cats',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Hypoallergenic meal for cats with sensitivities',
    source: 'Supertails',
    sourceUrl: 'https://supertails.com/blogs/nutrition/homemade-kitten-food-cat-food-a-guide-to-healthy-recipes',
    ingredients: [
      { name: 'Sardines water', amount: 150, unit: 'g' },
      { name: 'Oats', amount: 80, unit: 'g' },
      { name: 'Carrots raw', amount: 80, unit: 'g' },
      { name: 'Kale raw', amount: 60, unit: 'g' },
    ],
    instructions: [
      'Cook fish thoroughly and break into small pieces',
      'Boil quinoa until tender, then fluff',
      'Combine all ingredients and serve',
    ],
    servingSize: { amount: 150, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 20, max: 25, unit: '%' },
      fat: { min: 8, max: 12, unit: '%' },
    },
    prepTime: 15,
    cookTime: 25,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Hypoallergenic. Perfect for cats with sensitivities or allergies.',
  },
];

// ============================================================================
// REPTILE RECIPES (Bearded Dragons - Vet-Verified)
// ============================================================================

export const REPTILE_RECIPES: BaseRecipe[] = [
  {
    id: 'bearded-dragon-live-food-staple',
    name: 'Live Food Staple Mix (Crickets & Locusts)',
    species: 'reptiles',
    ageGroup: 'adult',
    style: 'live-food',
    description: 'Rotating live food diet with brown crickets and locusts, gut-loaded and dusted',
    source: 'Reptile Centre UK',
    sourceUrl: 'https://www.reptilecentre.com/blogs/reptile-blog/the-best-live-food-for-bearded-dragons',
    ingredients: [
      { name: 'Crickets', amount: 80, unit: 'g' },
      { name: 'Locusts', amount: 50, unit: 'g' },
    ],
    instructions: [
      'Gut-load crickets and locusts 24 hours before feeding',
      'Dust with calcium/vitamin D3 powder',
      'Offer in shallow dish or allow to roam enclosure',
      'Remove uneaten insects after 15 minutes',
      'Alternate between crickets and locusts for variety',
    ],
    servingSize: { amount: 16, unit: 'count', frequency: 'daily for juveniles, 3-4x weekly for adults' },
    nutritionalTargets: {
      protein: { min: 12, max: 15, unit: '%' },
      fat: { min: 3, max: 5, unit: '%' },
    },
    prepTime: 5,
    storageInstructions: 'Keep insects in ventilated containers at 70-75¬∞F. Feed vegetables daily.',
    notes: 'Brown crickets preferred over black (less noisy). Gut-loading and dusting essential for calcium.',
  },
  {
    id: 'bearded-dragon-varied-insects',
    name: 'Varied Insect Diet (Crickets, Waxworms, Mealworms)',
    species: 'reptiles',
    ageGroup: 'adult',
    style: 'live-food',
    description: 'Rotating insect diet with variety for nutritional balance',
    source: 'Reptile Centre UK',
    sourceUrl: 'https://www.reptilecentre.com/blogs/reptile-blog/the-best-live-food-for-bearded-dragons',
    ingredients: [
      { name: 'Crickets', amount: 60, unit: 'g' },
      { name: 'Mealworms', amount: 50, unit: 'g' },
    ],
    instructions: [
      'Gut-load crickets 24 hours before feeding',
      'Dust all insects with calcium/vitamin D3',
      'Offer in shallow dish',
      'Remove uneaten insects after 15 minutes',
      'Rotate insect types throughout week',
    ],
    servingSize: { amount: 22, unit: 'count', frequency: 'daily for juveniles, 3-4x weekly for adults' },
    nutritionalTargets: {
      protein: { min: 12, max: 15, unit: '%' },
      fat: { min: 4, max: 8, unit: '%' },
    },
    prepTime: 10,
    storageInstructions: 'Keep insects in separate ventilated containers. Waxworms and mealworms in cool area.',
    notes: 'Waxworms high in fat - use as treats 1-2x weekly. Mealworms harder to digest - use 1-2x weekly.',
  },
  {
    id: 'bearded-dragon-cricket-collard-salad',
    name: 'Cricket & Collard Salad',
    species: 'reptiles',
    ageGroup: 'adult',
    style: 'live-food',
    description: 'High-protein, calcium-rich meal with crickets and collard greens',
    source: 'Talis US',
    sourceUrl: 'https://talis-us.com/blogs/blog-188/nourishing-bearded-dragon-meal-prep-ideas-for-optimal-health',
    ingredients: [
      { name: 'Crickets', amount: 50, unit: 'g' },
      { name: 'Collard greens', amount: 50, unit: 'g' },
    ],
    instructions: [
      'Gut-load crickets 24 hours before feeding',
      'Dust crickets with calcium/vitamin D3 supplement',
      'Finely chop collard greens',
      'Combine in shallow dish',
      'Offer to bearded dragon',
    ],
    servingSize: { amount: 60, unit: 'g', frequency: '3-4x weekly' },
    nutritionalTargets: {
      protein: { min: 12, max: 15, unit: '%' },
      fat: { min: 3, max: 5, unit: '%' },
    },
    prepTime: 10,
    storageInstructions: 'Keep crickets in ventilated container. Use fresh greens daily.',
    notes: 'Supports bone health and muscle development. Collard greens high in calcium.',
  },
  {
    id: 'bearded-dragon-sweet-potato-kale',
    name: 'Sweet Potato & Kale Puree',
    species: 'reptiles',
    ageGroup: 'adult',
    style: 'mixed',
    description: 'Nutrient-dense vegetable meal with beta carotene and calcium',
    source: 'Talis US',
    sourceUrl: 'https://talis-us.com/blogs/blog-188/nourishing-bearded-dragon-meal-prep-ideas-for-optimal-health',
    ingredients: [
      { name: 'Sweet potato', amount: 100, unit: 'g' },
      { name: 'Kale', amount: 50, unit: 'g' },
    ],
    instructions: [
      'Boil sweet potato until soft',
      'Blend or mash with finely chopped kale',
      'Add calcium supplement',
      'Serve at room temperature',
    ],
    servingSize: { amount: 100, unit: 'g', frequency: '2-3x weekly' },
    nutritionalTargets: {
      protein: { min: 2, max: 4, unit: '%' },
      fat: { min: 0.5, max: 1, unit: '%' },
    },
    prepTime: 15,
    cookTime: 10,
    storageInstructions: 'Refrigerate for 2-3 days. Can be frozen in portions.',
    notes: 'Beta carotene-rich. Natural sweetness provides energy. Kale offers calcium and vitamin K.',
  },
  {
    id: 'bearded-dragon-mixed-greens-bowl',
    name: 'Mixed Leafy Greens Bowl',
    species: 'reptiles',
    ageGroup: 'adult',
    style: 'mixed',
    description: 'Wide spectrum of vitamins and minerals from organic greens',
    source: 'Talis US',
    sourceUrl: 'https://talis-us.com/blogs/blog-188/nourishing-bearded-dragon-meal-prep-ideas-for-optimal-health',
    ingredients: [
      { name: 'Collard greens', amount: 40, unit: 'g' },
      { name: 'Spinach', amount: 40, unit: 'g' },
      { name: 'Broccoli', amount: 30, unit: 'g' },
    ],
    instructions: [
      'Wash all greens thoroughly',
      'Finely chop into manageable pieces',
      'Mix together in shallow dish',
      'Dust with calcium/vitamin D3',
      'Offer fresh daily',
    ],
    servingSize: { amount: 110, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 3, max: 5, unit: '%' },
      fat: { min: 0.5, max: 1, unit: '%' },
    },
    prepTime: 10,
    storageInstructions: 'Use fresh daily. Store unused greens in refrigerator.',
    notes: 'Wide spectrum of vitamins A, D, K and minerals like calcium and magnesium.',
  },
];

// ============================================================================
// POCKET PET RECIPES (Guinea Pigs, Rabbits, Hamsters)
// ============================================================================

export const POCKET_PET_RECIPES: BaseRecipe[] = [
  {
    id: 'guinea-pig-balanced-diet',
    name: 'Guinea Pig Balanced Daily Diet',
    species: 'pocket-pets',
    ageGroup: 'adult',
    style: 'mixed',
    description: 'Complete guinea pig diet with hay, pellets, and fresh vegetables with vitamin C',
    source: 'Animals First Veterinary Hospital',
    sourceUrl: 'https://animalsfirstvethospital.com/2025/10/20/pocket-pet-diet-haddon-township-nj/',
    ingredients: [
      { name: 'Timothy hay', amount: 100, unit: 'g' },
      { name: 'Carrots', amount: 50, unit: 'g' },
      { name: 'Bell pepper', amount: 40, unit: 'g' },
      { name: 'Kale', amount: 20, unit: 'g' },
    ],
    instructions: [
      'Provide unlimited timothy hay throughout day',
      'Offer measured pellets once daily',
      'Provide fresh vegetables twice daily',
      'Rotate vegetable types for variety',
      'Remove uneaten fresh vegetables after 2-4 hours',
      'Ensure fresh water available at all times',
    ],
    servingSize: { amount: 255, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 12, max: 16, unit: '%' },
      fat: { min: 3, max: 6, unit: '%' },
    },
    prepTime: 10,
    storageInstructions: 'Store hay in cool, dry place. Keep pellets in airtight container. Refrigerate fresh vegetables.',
    notes: 'Guinea pigs REQUIRE vitamin C (10-50mg/kg daily). Cannot synthesize it. Introduce vegetables gradually.',
  },
  {
    id: 'rabbit-hay-based-diet',
    name: 'Rabbit Hay-Based Diet',
    species: 'pocket-pets',
    ageGroup: 'adult',
    style: 'hay-based',
    description: 'Hay-focused diet with pellets and fresh greens for adult rabbits',
    source: 'Veterinary Partner',
    sourceUrl: 'http://www.veterinarypartner.com/Content.plx?P=A&S=0&C=0&A=679',
    ingredients: [
      { name: 'Timothy hay', amount: 150, unit: 'g' },
      { name: 'Spinach', amount: 60, unit: 'g' },
      { name: 'Carrots', amount: 30, unit: 'g' },
      { name: 'Kale', amount: 20, unit: 'g' },
    ],
    instructions: [
      'Provide unlimited timothy hay',
      'Offer measured pellets once daily',
      'Provide fresh greens daily (2-3 cups per day)',
      'Limit carrots to 1-2 tablespoons daily (high sugar)',
      'Offer apple occasionally as treat',
      'Ensure fresh water available at all times',
    ],
    servingSize: { amount: 260, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 12, max: 16, unit: '%' },
      fat: { min: 2, max: 5, unit: '%' },
      fiber: { min: 18, max: 24, unit: '%' },
    },
    prepTime: 10,
    storageInstructions: 'Store hay in cool, dry place. Keep pellets in airtight container. Refrigerate fresh greens.',
    notes: 'Hay is essential for digestive health and dental wear. Adult rabbits need 70% hay by weight.',
  },
  {
    id: 'hamster-seed-mix-diet',
    name: 'Hamster Seed Mix with Vegetables',
    species: 'pocket-pets',
    ageGroup: 'adult',
    style: 'seed-mix',
    description: 'Balanced seed mix with fresh vegetables and protein',
    source: 'Veterinary Partner',
    sourceUrl: 'http://www.veterinarypartner.com/Content.plx?P=A&S=0&C=0&A=679',
    ingredients: [
      { name: 'Oats', amount: 15, unit: 'g' },
      { name: 'Carrots', amount: 15, unit: 'g' },
      { name: 'Broccoli', amount: 10, unit: 'g' },
      { name: 'Mealworms', amount: 10, unit: 'g' },
    ],
    instructions: [
      'Offer seed mix once daily',
      'Provide fresh vegetables 3-4x weekly',
      'Offer protein source 2-3x weekly',
      'Remove uneaten fresh food after 24 hours',
      'Ensure fresh water available at all times',
      'Monitor for food hoarding and remove spoiled items',
    ],
    servingSize: { amount: 40, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 12, max: 18, unit: '%' },
      fat: { min: 5, max: 10, unit: '%' },
    },
    prepTime: 5,
    storageInstructions: 'Store seed mix in airtight container. Keep refrigerated fresh vegetables.',
    notes: 'Hamsters hoard food - check for spoiled items daily. Limit fruits due to high sugar.',
  },
];

// ============================================================================
// DOG RECIPES (Placeholder - will be expanded)
// ============================================================================

export const DOG_RECIPES: BaseRecipe[] = [
  {
    id: 'dog-balanced-cooked',
    name: 'Balanced Cooked Dog Meal',
    species: 'dogs',
    ageGroup: 'adult',
    style: 'cooked',
    description: 'Balanced cooked meal with protein, carbs, and vegetables',
    source: 'AAFCO Guidelines',
    ingredients: [
      { name: 'Chicken breast', amount: 150, unit: 'g' },
      { name: 'Brown rice', amount: 100, unit: 'g' },
      { name: 'Carrots', amount: 50, unit: 'g' },
      { name: 'Sweet potato', amount: 50, unit: 'g' },
      { name: 'Fish oil', amount: 5, unit: 'g' },
    ],
    instructions: [
      'Cook chicken breast until done',
      'Cook brown rice according to package',
      'Cook vegetables until soft',
      'Combine all ingredients',
      'Cool before serving',
    ],
    servingSize: { amount: 350, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 18, max: 25, unit: '%' },
      fat: { min: 5, max: 15, unit: '%' },
    },
    prepTime: 20,
    cookTime: 30,
    storageInstructions: 'Refrigerate for 3-4 days or freeze in portions.',
    notes: 'Adjust portions based on dog size and activity level.',
  },
];

// ============================================================================
// BIRD RECIPES (Placeholder - will be expanded)
// ============================================================================

export const BIRD_RECIPES: BaseRecipe[] = [
  {
    id: 'bird-seed-mix',
    name: 'Bird Seed Mix with Vegetables',
    species: 'birds',
    ageGroup: 'adult',
    style: 'seed-mix',
    description: 'Balanced seed mix with fresh vegetables and fruits',
    source: 'Avian Veterinary Guidelines',
    ingredients: [
      { name: 'Oats', amount: 20, unit: 'g' },
      { name: 'Sunflower seeds', amount: 15, unit: 'g' },
      { name: 'Kale', amount: 30, unit: 'g' },
      { name: 'Carrots', amount: 20, unit: 'g' },
    ],
    instructions: [
      'Offer seed mix daily',
      'Provide fresh vegetables daily',
      'Offer fruits 2-3x weekly',
      'Remove uneaten fresh food after 4 hours',
      'Ensure fresh water available',
    ],
    servingSize: { amount: 110, unit: 'g', frequency: 'daily' },
    nutritionalTargets: {
      protein: { min: 10, max: 15, unit: '%' },
      fat: { min: 8, max: 15, unit: '%' },
    },
    prepTime: 5,
    storageInstructions: 'Store seeds in cool, dry place. Refrigerate fresh produce.',
    notes: 'Variety is essential for bird nutrition. Rotate seed types and vegetables.',
  },
];

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

export function getRecipesForSpecies(species: PetSpecies): BaseRecipe[] {
  switch (species) {
    case 'cats':
      return CAT_RECIPES;
    case 'dogs':
      return DOG_RECIPES;
    case 'birds':
      return BIRD_RECIPES;
    case 'reptiles':
      return REPTILE_RECIPES;
    case 'pocket-pets':
      return POCKET_PET_RECIPES;
    default:
      return [];
  }
}

export function getRandomRecipeForSpecies(species: PetSpecies): BaseRecipe | null {
  const recipes = getRecipesForSpecies(species);
  if (recipes.length === 0) return null;
  return recipes[Math.floor(Math.random() * recipes.length)];
}

export function getAllRecipes(): BaseRecipe[] {
  return [
    ...CAT_RECIPES,
    ...DOG_RECIPES,
    ...BIRD_RECIPES,
    ...REPTILE_RECIPES,
    ...POCKET_PET_RECIPES,
  ];
}
</file>

<file path="lib/data/celebrity-pets-complete.ts">
// lib/data/celebrity-pets-complete.ts
// Celebrity Pet Names + Quotes - Updated with new content

export interface CelebrityPet {
  name: string;
  quote: string;
  petType: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
}

// DOGS: The "Paw-llywood" A-List
export const dogCelebrities: CelebrityPet[] = [
  { name: "Bark Obama", quote: "Let me be clear... this is the change my belly has been waiting for.", petType: "dog" },
  { name: "Bark Twain", quote: "The secret of getting ahead is getting started... on this bowl.", petType: "dog" },
  { name: "Bark Ruffalo", quote: "You won't like me when I'm hungry. But I love this.", petType: "dog" },
  { name: "Bark Wahlberg", quote: "This meal? It's wicked good. Say hi to your mother for me.", petType: "dog" },
  { name: "Brad Pitt Bull", quote: "The first rule of Dinner Club: You do not talk about Dinner Club. You just wolf it down.", petType: "dog" },
  { name: "Pooch Clooney", quote: "Sophisticated. Timeless. Delicious. ...What else?", petType: "dog" },
  { name: "Angelina Poo-lee", quote: "I'm a globetrotter, but my favorite destination is right here in this bowl.", petType: "dog" },
  { name: "Corgi Elizabeth II", quote: "One is amused. Highly amused... by the flavor.", petType: "dog" },
  { name: "Chew-barka", quote: "Rrrruuuurrrghhh! (Translation: Seconds, please!)", petType: "dog" },
  { name: "Salvador Dogi", quote: "This flavor is surreal. It's melting like a clock in the sun.", petType: "dog" },
  { name: "Droolius Caesar", quote: "Veni, Vidi, Vici. I came, I saw, I ate it all.", petType: "dog" },
  { name: "Franz Fur-dinand", quote: "Take me out... to dinner!", petType: "dog" },
  { name: "Pup Marley", quote: "Don't worry about a thing... 'cause every little bite is gonna be alright.", petType: "dog" },
  { name: "Pupcasso", quote: "It's not just food... it's a masterpiece of flavor.", petType: "dog" },
  { name: "Billie Howliday", quote: "Summertime... and the livin' is easy (when the bowl is full).", petType: "dog" },
  { name: "Gnaw-msky Chomsky", quote: "The universal grammar of this meal is simply delicious.", petType: "dog" },
  { name: "Kanye Westie", quote: "Imma let you finish, but this is the best bowl of food of all time!", petType: "dog" },
  { name: "Anderson Pooper", quote: "Breaking news: This dinner is officially fantastic.", petType: "dog" },
  { name: "Chris Hemswoofth", quote: "Another! (Smashes bowl happily)", petType: "dog" },
  { name: "Dwayne \"The Wag\" Johnson", quote: "Can you smeeeeelllll what The Wag is eating?!", petType: "dog" },
  { name: "Woofie Goldberg", quote: "This food really speaks to my soul, sister.", petType: "dog" },
  { name: "Collie Parton", quote: "I will always love yoooouuuu (food).", petType: "dog" },
  { name: "Snoop Doggy Dog", quote: "Fo' shizzle, this drizzle... of gravy is off the chain.", petType: "dog" },
  { name: "Mary Puppins", quote: "A spoonful of sugar helps the medicine go down, but this needs no help.", petType: "dog" },
  { name: "Paw McCartney", quote: "All you need is love... and lunch.", petType: "dog" },
  { name: "Ozzy Pawsbourne", quote: "All aboard! Hahahaha! ... The dinner train.", petType: "dog" },
  { name: "Sarah Jessica Barker", quote: "I couldn't help but wonder... is this the perfect meal?", petType: "dog" },
  { name: "Jude Paw", quote: "Hey Jude, don't make it bad... take a sad bowl and make it better.", petType: "dog" },
  { name: "Jimmy Chew", quote: "It's not just food, it's high fashion for my tastebuds.", petType: "dog" },
  { name: "Virginia Woof", quote: "One cannot think well, love well, sleep well, if one has not dined well.", petType: "dog" },
  { name: "Indiana Bones", quote: "It belongs in a museum! But I'm gonna eat it right now.", petType: "dog" },
  { name: "Hairy Pawter", quote: "Accio Dinner!", petType: "dog" },
  { name: "Dumbledog", quote: "Happiness can be found, even in the darkest of times, if one only remembers to turn on the food dispenser.", petType: "dog" },
  { name: "Sirius Bark", quote: "I did my waiting! Twelve years of it! In Azkaban! ...For this bowl!", petType: "dog" },
  { name: "Sherlock Bones", quote: "The game is afoot! And by game, I mean lunch.", petType: "dog" },
];

// CATS: The "Meow-vies" & Music
export const catCelebrities: CelebrityPet[] = [
  { name: "Catrick Swayze", quote: "Nobody puts Dinner in the corner.", petType: "cat" },
  { name: "Leonardo DiCatrio", quote: "I'm the King of the World! ...and this food bowl!", petType: "cat" },
  { name: "Cat Damon", quote: "How do you like them apples? Actually, nevermind, I prefer this.", petType: "cat" },
  { name: "Meowly Cyrus", quote: "I came in like a wrecking ball... straight for the treats.", petType: "cat" },
  { name: "Cate Blanchcat", quote: "The world is changed. I feel it in the water. I feel it in the earth. I smell it in this bowl.", petType: "cat" },
  { name: "Al Pacat-ino", quote: "Say hello to my little friend... the kibble.", petType: "cat" },
  { name: "Jack Nicatson", quote: "Here's Johnny!... and he's hungry!", petType: "cat" },
  { name: "Dustin Pawman", quote: "Definitely, definitely delicious. Yeah.", petType: "cat" },
  { name: "Anthony Pawpkins", quote: "I ate his liver with some fava beans and a nice chianti... just kidding, it's pate.", petType: "cat" },
  { name: "Christopher Clawken", quote: "I got a fever... and the only prescription... is more dinner.", petType: "cat" },
  { name: "Daniel Day-Flewis", quote: "I drink your milkshake! I drink it up! (And your water bowl too).", petType: "cat" },
  { name: "Gary Paw-ldman", quote: "Bring me... EVERYTHING!!!", petType: "cat" },
  { name: "Katy Purry", quote: "I kissed a bowl and I liked it.", petType: "cat" },
  { name: "Cindy Clawford", quote: "I don't get out of bed for less than a premium meal.", petType: "cat" },
  { name: "RuPaw", quote: "If you can't love yourself, how in the hell are you gonna love this meal? Can I get an amen?", petType: "cat" },
  { name: "Cleocatra", quote: "Worship me, and bring me the feast fit for a Queen.", petType: "cat" },
  { name: "Picatso", quote: "Give me a museum and I'll fill it. Give me a bowl and I'll empty it.", petType: "cat" },
  { name: "Fidel Cat-stro", quote: "History will absolve me... for eating this seconds before you put it down.", petType: "cat" },
  { name: "Genghis Cat", quote: "I am the punishment of God... for this empty bowl.", petType: "cat" },
  { name: "Margaret Scratcher", quote: "The lady's not for turning... away from this plate.", petType: "cat" },
  { name: "Chairman Meow", quote: "The revolution will be fed.", petType: "cat" },
  { name: "Purr-tricia", quote: "I don't judge... much. But this food? 10 out of 10.", petType: "cat" },
];

// BIRDS: The "Fly" List
export const birdCelebrities: CelebrityPet[] = [
  { name: "Tweety Mercury", quote: "Don't stop me now... I'm having such a good feed.", petType: "bird" },
  { name: "Taylor Swift-let", quote: "I've got a blank space, baby... and I'll write 'YUM'.", petType: "bird" },
  { name: "Beyonc√© Birdie", quote: "If you liked it then you should have put a seed on it.", petType: "bird" },
  { name: "Adele Sparrow", quote: "Hello from the other side... of the bird feeder.", petType: "bird" },
  { name: "Rihanna Robin", quote: "Please don't stop the music... or the feeding.", petType: "bird" },
  { name: "The Weeknd Warbler", quote: "I can't feel my beak when I'm with you... but I love it.", petType: "bird" },
  { name: "Drake Duckling", quote: "Started from the bottom now we here (at the food bowl).", petType: "bird" },
  { name: "Post Mallard", quote: "Congratulations... to the chef.", petType: "bird" },
  { name: "Meryl Cheep", quote: "This is the best performance by a meal in a leading role.", petType: "bird" },
  { name: "Feather Locklear", quote: "I'm just here for the drama... and the millet.", petType: "bird" },
  { name: "Christopher Squawken", quote: "Walk this way... to the feeder.", petType: "bird" },
  { name: "Marty McFly", quote: "This heavy? No, this is delicious!", petType: "bird" },
  { name: "Sheryl Crow", quote: "All I wanna do is have some fun... and eat this.", petType: "bird" },
  { name: "Crow-nan O'Brien", quote: "Welcome to the show! Tonight's guest: Dinner.", petType: "bird" },
  { name: "Duck Norris", quote: "This meal didn't satisfy my hunger. My hunger surrendered to this meal.", petType: "bird" },
];

// REPTILES: The "Cold-Blooded" Celebs
export const reptileCelebrities: CelebrityPet[] = [
  { name: "Scale-y Cyrus", quote: "It's the climb... to get to the top of the rock for this deliciousness.", petType: "reptile" },
  { name: "Brad Pitthon", quote: "To be honest, I find the concept of 'sharing' this meal elusive.", petType: "reptile" },
  { name: "George Geck-looney", quote: "I'm not just a pretty face. I have a pretty big appetite too.", petType: "reptile" },
  { name: "Sandra Bullfrog", quote: "I love a meal that makes me want to hop for joy.", petType: "reptile" },
  { name: "Scarlett Johansnake", quote: "I have a very specific set of skills. Eating this is one of them.", petType: "reptile" },
  { name: "Natalie Portman-tis", quote: "I will not let this meal die. It is too important.", petType: "reptile" },
  { name: "Lizard McGuire", quote: "This is what dreams are made of.", petType: "reptile" },
  { name: "Chamillionaire", quote: "They see me rollin', they hatin'... cause I'm eatin' dirty.", petType: "reptile" },
  { name: "Kim Komodo", quote: "This is breaking the internet. Or at least my diet.", petType: "reptile" },
  { name: "Reese Slither-spoon", quote: "What, like it's hard? To eat this whole thing?", petType: "reptile" },
  { name: "Snake Gyllenhaal", quote: "I wish I knew how to quit you... delicious food.", petType: "reptile" },
  { name: "Justin Timbersnake", quote: "I'm bringing sexy back. And hunger.", petType: "reptile" },
  { name: "Eddie Izzard", quote: "Cake or death? I'll take the meal, thank you very much.", petType: "reptile" },
];

// POCKET PETS: Pocket Sized Puns (Rodents & Rabbits)
export const pocketPetCelebrities: CelebrityPet[] = [
  { name: "Ham Solo", quote: "Chewie, we're home... for lunch.", petType: "pocket-pet" },
  { name: "Hamela Anderson", quote: "I'm always ready for a slow-motion run... to the food bowl.", petType: "pocket-pet" },
  { name: "Guinea Pig Pitt", quote: "I want you to feed me as hard as you can.", petType: "pocket-pet" },
  { name: "Ferret Fawcett", quote: "It's all about the hair... and the snacks.", petType: "pocket-pet" },
  { name: "Bunny Shapiro", quote: "Facts don't care about your feelings, but they do care about carrots.", petType: "pocket-pet" },
  { name: "Gerbil Streep", quote: "I have doubts. I have such doubts... that there will be any left.", petType: "pocket-pet" },
  { name: "Chinchilla Clinton", quote: "I did not inhale. I swallowed it whole.", petType: "pocket-pet" },
  { name: "Hammy Kimmel", quote: "Coming up next: Me eating this entire thing.", petType: "pocket-pet" },
  { name: "Stephen Hambert", quote: "This is a formidable opponent. But I will conquer it.", petType: "pocket-pet" },
  { name: "Jimmy Ferret-lon", quote: "That is great! That is awesome! Everything is awesome!", petType: "pocket-pet" },
  { name: "Oprah Winferbun", quote: "You get a pellet! And YOU get a pellet! Everybody gets a pellet!", petType: "pocket-pet" },
  { name: "Wolf Blitzhamster", quote: "Happening now: A major development in my stomach.", petType: "pocket-pet" },
  { name: "Rabbit De Niro", quote: "You talkin' to me? You talkin' to me? Then you must be offering food.", petType: "pocket-pet" },
  { name: "Hare-y Styles", quote: "Watermelon sugar... HI! Give me that!", petType: "pocket-pet" },
  { name: "Brittney Ears", quote: "Oops!... I did it again. I ate it all.", petType: "pocket-pet" },
  { name: "Guinea Stefani", quote: "This meal is B-A-N-A-N-A-S.", petType: "pocket-pet" },
];

// COMBINED EXPORT
export const allCelebrityPets = [
  ...dogCelebrities,
  ...catCelebrities,
  ...birdCelebrities,
  ...reptileCelebrities,
  ...pocketPetCelebrities
];

// STATISTICS
export const celebrityStats = {
  total: allCelebrityPets.length,
  dogs: dogCelebrities.length,
  cats: catCelebrities.length,
  birds: birdCelebrities.length,
  reptiles: reptileCelebrities.length,
  pocketPets: pocketPetCelebrities.length
};

// USAGE: Random assignment to recipes
export function getRandomCelebrityByType(petType: string): CelebrityPet {
  const filtered = allCelebrityPets.filter(c => c.petType === petType);
  if (filtered.length === 0) {
    // Fallback to first available if type doesn't match
    return allCelebrityPets[0];
  }
  return filtered[Math.floor(Math.random() * filtered.length)];
}

// USAGE: Assign to specific recipe
export function assignCelebrityToRecipe(recipeId: string, petType: string): CelebrityPet {
  // Deterministic assignment based on recipe ID (same recipe always gets same celebrity)
  const filtered = allCelebrityPets.filter(c => c.petType === petType);
  if (filtered.length === 0) {
    // Fallback to first available if type doesn't match
    return allCelebrityPets[0];
  }
  const hash = recipeId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return filtered[hash % filtered.length];
}
</file>

<file path="lib/data/conditionTemplates.ts">
import type { PetCategory } from '../recipe-generator';

export interface ConditionTemplate {
  id: string;
  name: string;
  category: PetCategory;
  concerns: string[]; // normalized keys (e.g., 'kidney-disease')
  preferred: string[]; // ingredient name keywords to favor
  avoid: string[];     // ingredient name keywords to penalize
}

export const CONDITION_TEMPLATES: ConditionTemplate[] = [
  {
    id: 'kidney-friendly',
    name: 'Kidney-Friendly Bowl',
    category: 'dogs',
    concerns: ['kidney-disease'],
    preferred: ['white fish', 'eggs', 'white rice', 'green beans', 'cauliflower', 'blueberries'],
    avoid: ['liver', 'organ', 'sardines', 'cheese', 'yogurt', 'high-phosphorus'],
  },
  {
    id: 'weight-loss',
    name: 'Lean & Green Bowl',
    category: 'dogs',
    concerns: ['weight-management', 'obesity'],
    preferred: ['turkey breast', 'chicken breast', 'white fish', 'green beans', 'zucchini', 'broccoli', 'pumpkin'],
    avoid: ['high-fat', 'cheese', 'oils'],
  },
  {
    id: 'joint-health',
    name: 'Anti-Inflammatory Bowl',
    category: 'dogs',
    concerns: ['joint-health', 'arthritis'],
    preferred: ['salmon', 'sardines', 'mackerel', 'turmeric', 'sweet potato', 'spinach', 'kale', 'pumpkin'],
    avoid: ['high-fat', 'processed'],
  },
  {
    id: 'low-glycemic',
    name: 'Low-Glycemic Bowl',
    category: 'dogs',
    concerns: ['diabetes'],
    preferred: ['green beans', 'broccoli', 'cauliflower', 'spinach', 'chicken breast', 'turkey', 'white fish', 'eggs', 'pumpkin'],
    avoid: ['corn', 'white potato', 'sugar'],
  },
  {
    id: 'low-fat-pancreatitis',
    name: 'Low-Fat Recovery Bowl',
    category: 'dogs',
    concerns: ['pancreatitis'],
    preferred: ['white fish', 'turkey breast', 'chicken breast', 'rice', 'sweet potato', 'pumpkin', 'green beans'],
    avoid: ['beef', 'pork', 'lamb', 'duck', 'oils', 'cheese', 'high-fat'],
  },
];
</file>

<file path="lib/data/coreProteins.ts">
/**
 * Core Protein Lists - Only Common, Affordable Ingredients
 * 
 * Philosophy: No exotic meats, no expensive specialty items.
 * Only proteins that are widely available, affordable, and nutritionally complete.
 */

import type { Species } from './ingredients';

/**
 * Core proteins for cats and dogs
 * These are all you need for excellent nutrition
 */
export const CORE_PROTEINS_CARNIVORE = [
  // Primary Muscle Meats
  'chicken',
  'chicken breast',
  'ground chicken',
  'turkey',
  'ground turkey',
  'beef',
  'ground beef',
  'ground beef (lean)',
  'pork',
  'ground pork',
  'ground pork (lean)',
  'lamb',
  'ground lamb',
  
  // Organs (Required)
  'chicken liver',
  'chicken heart',
  'beef liver',
  'turkey liver',
  'liver',
  'heart',
  'kidney',
  'gizzard',
  
  // Fish (Secondary)
  'salmon',
  'salmon (boneless)',
  'sardines',
  'sardines (canned in water)',
  'sardines (in water)',
  'mackerel',
  'mackerel (canned)',
  'anchovies',
  'herring',
  'herring (canned)',
  
  // Eggs
  'eggs',
  'egg',
  'egg yolk',
  'egg yolks',
  'whole egg',
  'hard-boiled egg',
  'egg (hard-boiled)',
];

/**
 * Core proteins for seed/plant-forward birds
 */
export const CORE_PROTEINS_BIRD_SEED = [
  // Plant Proteins
  'lentils',
  'chickpeas',
  'mung beans',
  'split peas',
  'quinoa',
  'hemp seeds',
  'pumpkin seeds',
  'sunflower seeds',
  'chia seeds',
  
  // Occasional Animal Protein
  'eggs',
  'egg yolk',
  'hard-boiled egg',
];

/**
 * Core proteins for omnivorous birds
 */
export const CORE_PROTEINS_BIRD_OMNIVORE = [
  // Animal Proteins
  'eggs',
  'chicken',
  'turkey',
  
  // Insects
  'mealworms',
  'crickets',
  'black soldier fly larvae',
  'dubia roaches',
  'silkworms',
];

/**
 * Core proteins for insectivorous birds
 */
export const CORE_PROTEINS_BIRD_INSECTIVORE = [
  'mealworms',
  'crickets',
  'dubia roaches',
  'black soldier fly larvae',
  'silkworms',
  'superworms',
];

/**
 * Core proteins for insectivorous reptiles
 */
export const CORE_PROTEINS_REPTILE_INSECTIVORE = [
  'crickets',
  'dubia roaches',
  'mealworms',
  'superworms',
  'silkworms',
  'black soldier fly larvae',
  'hornworms',
];

/**
 * Core proteins for carnivorous reptiles (whole prey)
 */
export const CORE_PROTEINS_REPTILE_CARNIVORE = [
  'mice',
  'rats',
  'chicks',
  'fish',
];

/**
 * Core proteins for omnivorous reptiles
 */
export const CORE_PROTEINS_REPTILE_OMNIVORE = [
  // Insects
  'crickets',
  'dubia roaches',
  'mealworms',
  'black soldier fly larvae',
  'silkworms',
  
  // Animal Proteins
  'eggs',
  'chicken',
  'turkey',
];

/**
 * Core proteins for herbivorous reptiles
 */
export const CORE_PROTEINS_REPTILE_HERBIVORE = [
  'lentils',
  'split peas',
  // Protein comes mainly from plants
];

/**
 * Core proteins for herbivorous pocket pets
 */
export const CORE_PROTEINS_POCKET_PET_HERBIVORE = [
  'timothy hay',
  'orchard grass hay',
  'meadow hay',
  'alfalfa hay',
  // NO animal protein
];

/**
 * Core proteins for omnivorous pocket pets
 */
export const CORE_PROTEINS_POCKET_PET_OMNIVORE = [
  'eggs',
  'chicken',
  'turkey',
  'lentils',
  'chickpeas',
  'mealworms',
  'crickets',
];

/**
 * Core proteins for insectivorous pocket pets
 */
export const CORE_PROTEINS_POCKET_PET_INSECTIVORE = [
  'mealworms',
  'crickets',
  'black soldier fly larvae',
  'eggs',
  'chicken',
];

/**
 * Exotic/Expensive proteins to EXCLUDE by default
 * These should only be used in advanced/allergy mode
 */
export const EXOTIC_PROTEINS = [
  'quail',
  'venison',
  'goat',
  'elk',
  'bison',
  'ostrich',
  'pheasant',
  'duck',
  'rabbit',
  'kangaroo',
  'alligator',
  'wild boar',
  'emu',
  'reindeer',
  'buffalo',
];

/**
 * Check if an ingredient is a core protein for the given species
 */
export function isCoreProtein(ingredientName: string, species: Species): boolean {
  const normalized = ingredientName.toLowerCase().trim();
  
  // Check if it's an exotic protein (exclude by default)
  if (EXOTIC_PROTEINS.some(exotic => normalized.includes(exotic.toLowerCase()))) {
    return false;
  }
  
  // Check species-specific core proteins
  if (species === 'dogs' || species === 'cats') {
    return CORE_PROTEINS_CARNIVORE.some(core => 
      normalized.includes(core.toLowerCase()) || core.toLowerCase().includes(normalized)
    );
  }
  
  if (species === 'birds') {
    return [
      ...CORE_PROTEINS_BIRD_SEED,
      ...CORE_PROTEINS_BIRD_OMNIVORE,
      ...CORE_PROTEINS_BIRD_INSECTIVORE
    ].some(core => 
      normalized.includes(core.toLowerCase()) || core.toLowerCase().includes(normalized)
    );
  }
  
  if (species === 'reptiles') {
    return [
      ...CORE_PROTEINS_REPTILE_INSECTIVORE,
      ...CORE_PROTEINS_REPTILE_CARNIVORE,
      ...CORE_PROTEINS_REPTILE_OMNIVORE,
      ...CORE_PROTEINS_REPTILE_HERBIVORE
    ].some(core => 
      normalized.includes(core.toLowerCase()) || core.toLowerCase().includes(normalized)
    );
  }
  
  if (species === 'pocket-pets') {
    return [
      ...CORE_PROTEINS_POCKET_PET_HERBIVORE,
      ...CORE_PROTEINS_POCKET_PET_OMNIVORE,
      ...CORE_PROTEINS_POCKET_PET_INSECTIVORE
    ].some(core => 
      normalized.includes(core.toLowerCase()) || core.toLowerCase().includes(normalized)
    );
  }
  
  return false;
}

/**
 * Check if an ingredient is exotic/expensive
 */
export function isExoticProtein(ingredientName: string): boolean {
  const normalized = ingredientName.toLowerCase().trim();
  return EXOTIC_PROTEINS.some(exotic => normalized.includes(exotic.toLowerCase()));
}

/**
 * Get core proteins for a species
 */
export function getCoreProteinsForSpecies(species: Species): string[] {
  if (species === 'dogs' || species === 'cats') {
    return CORE_PROTEINS_CARNIVORE;
  }
  
  if (species === 'birds') {
    return [
      ...CORE_PROTEINS_BIRD_SEED,
      ...CORE_PROTEINS_BIRD_OMNIVORE,
      ...CORE_PROTEINS_BIRD_INSECTIVORE
    ];
  }
  
  if (species === 'reptiles') {
    return [
      ...CORE_PROTEINS_REPTILE_INSECTIVORE,
      ...CORE_PROTEINS_REPTILE_CARNIVORE,
      ...CORE_PROTEINS_REPTILE_OMNIVORE,
      ...CORE_PROTEINS_REPTILE_HERBIVORE
    ];
  }
  
  if (species === 'pocket-pets') {
    return [
      ...CORE_PROTEINS_POCKET_PET_HERBIVORE,
      ...CORE_PROTEINS_POCKET_PET_OMNIVORE,
      ...CORE_PROTEINS_POCKET_PET_INSECTIVORE
    ];
  }
  
  return [];
}
</file>

<file path="lib/data/generatedIngredients.ts">
// lib/data/generatedIngredients.ts
// AUTO-GENERATED - Do not edit manually
// Generated from scraped data on 2025-12-02T22:00:58.798Z
// Run: node scripts/buildIngredients.js to regenerate

export interface GeneratedIngredient {
  id: string;
  name: string;
  category: 'protein' | 'vegetable' | 'fruit' | 'grain' | 'supplement' | 'insect' | 'hay' | 'other';
  subtypeTags: string[];
  confidence: 'high' | 'medium' | 'low';
  scrapedCount: number;
}

export const GENERATED_INGREDIENTS: GeneratedIngredient[] = [
  {
    "id": "pumpkin",
    "name": "pumpkin",
    "category": "grain",
    "subtypeTags": [
      "bird_large",
      "bird_small"
    ],
    "confidence": "low",
    "scrapedCount": 2
  },
  {
    "id": "chinchilla",
    "name": "chinchilla",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "low",
    "scrapedCount": 2
  },
  {
    "id": "ferret",
    "name": "ferret",
    "category": "other",
    "subtypeTags": [
      "pocket_carnivore",
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "low",
    "scrapedCount": 2
  },
  {
    "id": "guinea_guru_popcorn_in_guinea_pig",
    "name": "guinea guru? popcorn in! guinea pig",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "guinea_pig",
    "name": "guinea pig",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "high",
    "scrapedCount": 6
  },
  {
    "id": "guinea_pig_finder_cagetopia_the_original_cc_guinea_pig_cages_store_guinea_pig",
    "name": "guinea pig finder cagetopia - the original c&c guinea pig cages store guinea pig",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "hamster",
    "name": "hamster",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "low",
    "scrapedCount": 2
  },
  {
    "id": "nutrient",
    "name": "nutrient",
    "category": "other",
    "subtypeTags": [],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "pea",
    "name": "pea",
    "category": "other",
    "subtypeTags": [],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "rabbit",
    "name": "rabbit",
    "category": "other",
    "subtypeTags": [
      "pocket_hay",
      "pocket_varied"
    ],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "sweet_potato",
    "name": "sweet potato",
    "category": "other",
    "subtypeTags": [],
    "confidence": "low",
    "scrapedCount": 1
  },
  {
    "id": "uvb",
    "name": "uvb",
    "category": "other",
    "subtypeTags": [
      "reptile_herbivore",
      "reptile_insectivore",
      "reptile_omnivore"
    ],
    "confidence": "low",
    "scrapedCount": 2
  },
  {
    "id": "chicken",
    "name": "chicken",
    "category": "protein",
    "subtypeTags": [],
    "confidence": "medium",
    "scrapedCount": 5
  },
  {
    "id": "heart",
    "name": "heart",
    "category": "protein",
    "subtypeTags": [],
    "confidence": "high",
    "scrapedCount": 8
  },
  {
    "id": "kidney",
    "name": "kidney",
    "category": "protein",
    "subtypeTags": [],
    "confidence": "high",
    "scrapedCount": 8
  },
  {
    "id": "turkey",
    "name": "turkey",
    "category": "protein",
    "subtypeTags": [
      "bird_large",
      "bird_small"
    ],
    "confidence": "high",
    "scrapedCount": 7
  },
  {
    "id": "glucosamine",
    "name": "glucosamine",
    "category": "supplement",
    "subtypeTags": [],
    "confidence": "medium",
    "scrapedCount": 4
  },
  {
    "id": "supplement",
    "name": "supplement",
    "category": "supplement",
    "subtypeTags": [],
    "confidence": "high",
    "scrapedCount": 7
  },
  {
    "id": "vitamin",
    "name": "vitamin",
    "category": "supplement",
    "subtypeTags": [
      "reptile_herbivore",
      "reptile_insectivore",
      "reptile_omnivore"
    ],
    "confidence": "low",
    "scrapedCount": 2
  }
];

// Summary stats
export const GENERATED_INGREDIENTS_STATS = {
  total: 19,
  byCategory: {
    protein: 4,
    vegetable: 0,
    fruit: 0,
    grain: 1,
    supplement: 3,
    insect: 0,
    hay: 0,
    other: 11
  },
  byConfidence: {
    high: 5,
    medium: 7,
    low: 7
  },
  bySubtype: {
    bird_small: 2,
    bird_large: 2,
    reptile_herbivore: 2,
    reptile_insectivore: 2,
    reptile_omnivore: 2,
    reptile_carnivore: 0,
    pocket_hay: 7,
    pocket_varied: 7,
    pocket_carnivore: 1,
    pocket_insectivore: 0
  }
};
</file>

<file path="lib/data/globalIngredients.ts">
// lib/data/globalIngredients.ts
// Global ingredient pool - all ingredients regardless of species
// Each ingredient has speciesCompatibility mapping
// This allows ingredients to be discovered once and mapped to multiple species

import type { IngredientComposition } from './ingredientCompositions';

export interface GlobalIngredient {
  id: string; // e.g., "carrot_raw"
  displayName: string; // e.g., "Carrot (raw)"
  category: 'protein' | 'vegetable' | 'fruit' | 'grain' | 'supplement' | 'insect' | 'hay' | 'other';
  compositionKey?: string; // Reference to INGREDIENT_COMPOSITIONS key
  composition?: IngredientComposition; // Optional: full composition data
  commonNames?: string[]; // Alternative names found in scrapes
  confidenceLevel?: 'high' | 'medium' | 'low'; // Data quality
  lastScraped?: string; // ISO date
  sources?: string[]; // URLs where this was found
  scrapedCount?: number; // How many times found in scrapes
}

// This will be populated from scraped data + manual curation
// Structure: { [ingredientId]: GlobalIngredient }
export const GLOBAL_INGREDIENTS: Record<string, GlobalIngredient> = {
  // Will be populated by processing scraped results
  // For now, we'll seed with existing INGREDIENT_COMPOSITIONS
};

/**
 * Get global ingredient by ID
 */
export function getGlobalIngredient(id: string): GlobalIngredient | undefined {
  return GLOBAL_INGREDIENTS[id];
}

/**
 * Get all global ingredients
 */
export function getAllGlobalIngredients(): GlobalIngredient[] {
  return Object.values(GLOBAL_INGREDIENTS);
}

/**
 * Get global ingredients by category
 */
export function getGlobalIngredientsByCategory(category: GlobalIngredient['category']): GlobalIngredient[] {
  return Object.values(GLOBAL_INGREDIENTS).filter(ing => ing.category === category);
}

/**
 * Search global ingredients by name
 */
export function searchGlobalIngredients(query: string): GlobalIngredient[] {
  const lowerQuery = query.toLowerCase();
  return Object.values(GLOBAL_INGREDIENTS).filter(ing => 
    ing.displayName.toLowerCase().includes(lowerQuery) ||
    ing.id.toLowerCase().includes(lowerQuery) ||
    ing.commonNames?.some(name => name.toLowerCase().includes(lowerQuery))
  );
}
</file>

<file path="lib/data/health-concerns.ts">
// lib/data/health-concerns.ts
// Species-specific and breed-specific health concerns for pet nutrition platform

export const healthConcernsBySpecies = {
  dogs: [
    'Allergies/skin issues',
    'Arthritis/joint pain',
    'Dental problems',
    'Digestive issues',
    'Ear infections',
    'Obesity/weight management',
    'Kidney disease',
    'Heart disease',
    'Urinary problems',
    'Thyroid issues',
    'Pancreatitis',
    'Diabetes',
    'Hip dysplasia',
    'Skin conditions'
  ],

  cats: [
    'Dental disease',
    'Kidney disease',
    'Urinary tract issues',
    'Hyperthyroidism',
    'Diabetes',
    'Inflammatory Bowel Disease',
    'Hairballs',
    'Obesity/weight management',
    'Respiratory issues',
    'Skin allergies',
    'Pancreatitis',
    'Heart disease',
    'Skin conditions'
  ],

  birds: [
    'Feather plucking',
    'Respiratory infection',
    'Beak overgrowth',
    'Vitamin deficiencies',
    'Heavy metal exposure',
    'Egg binding',
    'Fatty liver disease',
    'Nutritional imbalances'
  ],

  reptiles: [
    'Metabolic Bone Disease',
    'Respiratory infection',
    'Parasites',
    'Stuck shed',
    'Impaction',
    'Mouth rot',
    'Thermal burns',
    'Nutritional deficiencies',
    'Tail/foot injuries'
  ],

  'pocket-pets': [
    'Dental problems',
    'Digestive issues',
    'Respiratory infection',
    'Urinary problems',
    'Skin/fur issues',
    'Obesity',
    'Nutritional deficiencies'
  ]
};

// Breed-specific health concerns (fallback to species-level if not specified)
export const healthConcernsByBreed: Record<string, string[]> = {
  // Reptiles
  'Iguana': [
    'Metabolic Bone Disease',
    'Thermal burns',
    'Nutritional deficiencies',
    'Impaction',
    'Tail/foot injuries',
    'Respiratory infection'
  ],
  'Bearded Dragon': [
    'Metabolic Bone Disease',
    'Impaction',
    'Mouth rot (stomatitis)',
    'Respiratory infection',
    'Parasites'
  ],
  'Leopard Gecko': [
    'Metabolic Bone Disease',
    'Stuck shed (dysecdysis)',
    'Impaction',
    'Tail loss',
    'Respiratory infection'
  ],
  'Ball Python': [
    'Respiratory infection',
    'Scale rot',
    'Impaction',
    'Mouth rot',
    'Parasites'
  ],
  'Corn Snake': [
    'Respiratory infection',
    'Scale rot',
    'Impaction',
    'Mouth rot',
    'Parasites'
  ],
  'Red-Eared Slider': [
    'Metabolic Bone Disease',
    'Shell rot',
    'Respiratory infection',
    'Vitamin A deficiency',
    'Impaction'
  ],
  'Crested Gecko': [
    'Metabolic Bone Disease',
    'Stuck shed',
    'Impaction',
    'Respiratory infection'
  ],

  // Dogs
  'Labrador Retriever': [
    'Obesity/weight management',
    'Arthritis/joint pain',
    'Hip dysplasia',
    'Ear infections',
    'Allergies/skin issues'
  ],
  'German Shepherd': [
    'Hip dysplasia',
    'Arthritis/joint pain',
    'Digestive issues',
    'Pancreatitis',
    'Skin conditions'
  ],
  'Golden Retriever': [
    'Hip dysplasia',
    'Arthritis/joint pain',
    'Obesity/weight management',
    'Skin allergies',
    'Ear infections'
  ],
  'French Bulldog': [
    'Respiratory issues',
    'Skin allergies',
    'Obesity/weight management',
    'Dental problems',
    'Digestive issues'
  ],
  'Bulldog': [
    'Respiratory issues',
    'Skin allergies',
    'Obesity/weight management',
    'Hip dysplasia',
    'Dental problems'
  ],
  'Poodle': [
    'Skin allergies',
    'Ear infections',
    'Dental problems',
    'Pancreatitis',
    'Diabetes'
  ],
  'Beagle': [
    'Obesity/weight management',
    'Ear infections',
    'Epilepsy',
    'Hip dysplasia',
    'Allergies/skin issues'
  ],
  'Dachshund': [
    'Intervertebral disc disease',
    'Obesity/weight management',
    'Dental problems',
    'Diabetes',
    'Skin conditions'
  ],
  'Great Dane': [
    'Hip dysplasia',
    'Bloat (GDV)',
    'Heart disease',
    'Arthritis/joint pain',
    'Obesity/weight management'
  ],
  'Siberian Husky': [
    'Hip dysplasia',
    'Eye problems',
    'Skin allergies',
    'Digestive issues',
    'Obesity/weight management'
  ],

  // Cats
  'Persian': [
    'Dental disease',
    'Hairballs',
    'Urinary tract issues (FLUTD)',
    'Respiratory infection',
    'Skin conditions',
    'Eye problems'
  ],
  'Maine Coon': [
    'Hip dysplasia',
    'Heart disease (HCM)',
    'Kidney disease',
    'Obesity/weight management',
    'Dental disease'
  ],
  'Siamese': [
    'Respiratory issues',
    'Dental disease',
    'Amyloidosis',
    'Asthma',
    'Skin allergies'
  ],
  'Ragdoll': [
    'Heart disease (HCM)',
    'Urinary tract issues',
    'Obesity/weight management',
    'Dental disease',
    'Kidney disease'
  ],
  'Bengal': [
    'Hip dysplasia',
    'Progressive retinal atrophy',
    'Hypertrophic cardiomyopathy',
    'Skin allergies',
    'Digestive issues'
  ],
  'British Shorthair': [
    'Obesity/weight management',
    'Heart disease (HCM)',
    'Dental disease',
    'Kidney disease',
    'Urinary tract issues'
  ],
  'Sphynx': [
    'Skin conditions',
    'Heart disease (HCM)',
    'Dental disease',
    'Respiratory issues',
    'Obesity/weight management'
  ],

  // Birds
  'African Grey': [
    'Feather plucking',
    'Calcium deficiency',
    'Respiratory infection',
    'Heavy metal exposure',
    'Vitamin A deficiency'
  ],
  'Cockatiel': [
    'Respiratory infection',
    'Feather plucking',
    'Egg binding',
    'Fatty liver disease',
    'Vitamin deficiencies'
  ],
  'Budgie': [
    'Respiratory infection',
    'Tumors',
    'Feather plucking',
    'Beak overgrowth',
    'Nutritional imbalances'
  ],
  'Macaw': [
    'Feather plucking',
    'Respiratory infection',
    'Heavy metal exposure',
    'Beak overgrowth',
    'Nutritional deficiencies'
  ],

  // Pocket Pets
  'Rabbit': [
    'Dental problems',
    'Digestive issues (GI stasis)',
    'Respiratory infection',
    'Urinary problems',
    'Obesity',
    'Skin/fur issues'
  ],
  'Guinea Pig': [
    'Vitamin C deficiency',
    'Dental problems',
    'Respiratory infection',
    'Urinary problems',
    'Skin conditions',
    'Digestive issues'
  ],
  'Hamster': [
    'Diabetes',
    'Dental problems',
    'Respiratory infection',
    'Skin conditions',
    'Digestive issues'
  ],
  'Chinchilla': [
    'Dental problems',
    'Respiratory infection',
    'Heat stroke',
    'Skin/fur issues',
    'Digestive issues'
  ],
  'Ferret': [
    'Insulinoma',
    'Adrenal disease',
    'Digestive issues',
    'Respiratory infection',
    'Skin conditions'
  ]
};

// Helper function to get concerns for any species (optionally with breed)
export function getHealthConcernsForSpecies(species: string, breed?: string): string[] {
  const normalized = species.toLowerCase().trim();

  // Map aliases
  const speciesMap: Record<string, keyof typeof healthConcernsBySpecies> = {
    'dog': 'dogs',
    'dogs': 'dogs',
    'puppy': 'dogs',
    'cat': 'cats',
    'cats': 'cats',
    'kitten': 'cats',
    'bird': 'birds',
    'birds': 'birds',
    'reptile': 'reptiles',
    'reptiles': 'reptiles',
    'rabbit': 'pocket-pets',
    'rabbits': 'pocket-pets',
    'guinea pig': 'pocket-pets',
    'guinea pigs': 'pocket-pets',
    'hamster': 'pocket-pets',
    'hamsters': 'pocket-pets',
    'gerbil': 'pocket-pets',
    'gerbils': 'pocket-pets',
    'ferret': 'pocket-pets',
    'ferrets': 'pocket-pets',
    'mouse': 'pocket-pets',
    'mice': 'pocket-pets',
    'rat': 'pocket-pets',
    'rats': 'pocket-pets',
    'chinchilla': 'pocket-pets',
    'chinchillas': 'pocket-pets'
  };

  // If breed provided and has specific concerns, return those
  if (breed && breed.trim()) {
    const breedKey = breed.trim();
    if (healthConcernsByBreed[breedKey]) {
      return healthConcernsByBreed[breedKey];
    }
  }

  // Otherwise fall back to species-level concerns
  const key = speciesMap[normalized] || normalized as keyof typeof healthConcernsBySpecies;
  return healthConcernsBySpecies[key] || [
    'Digestive issues',
    'Nutritional concerns',
    'Weight management'
  ];
}
</file>

<file path="lib/data/healthBenefitMap.ts">
import type { HealthConcern } from '../recipe-generator';

// Minimal, high-signal mappings to boost condition-aware selection/scoring.
export const HEALTH_BENEFIT_MAP: Record<string, string[]> = {
  // Joint / anti-inflammatory
  'joint-health': ['salmon', 'sardines', 'mackerel', 'fish oil', 'turmeric', 'sweet potato', 'pumpkin', 'spinach', 'kale'],
  'arthritis': ['salmon', 'sardines', 'fish oil', 'turmeric', 'ginger', 'blueberries', 'sweet potato'],

  // Weight management / low fat
  'weight-management': ['green beans', 'pumpkin', 'zucchini', 'cauliflower', 'broccoli', 'turkey breast', 'chicken breast', 'white fish'],
  'obesity': ['green beans', 'pumpkin', 'carrots', 'celery', 'cucumber', 'turkey', 'chicken', 'white fish'],

  // Digestive
  'digestive-issues': ['pumpkin', 'sweet potato', 'rice', 'bone broth', 'oats', 'bananas'],
  'sensitive-stomach': ['pumpkin', 'sweet potato', 'rice', 'chicken', 'turkey', 'bone broth', 'oats'],

  // Kidney / urinary (lower phosphorus, hydration-friendly)
  'kidney-disease': ['apples', 'blueberries', 'green beans', 'cauliflower', 'white rice', 'eggs', 'white fish'],
  'urinary-health': ['cranberries', 'blueberries', 'pumpkin', 'green beans', 'white fish', 'chicken'],

  // Diabetes / blood sugar (lower glycemic)
  'diabetes': ['green beans', 'broccoli', 'spinach', 'cauliflower', 'chicken breast', 'turkey', 'white fish', 'eggs', 'pumpkin'],

  // Skin / coat
  'skin-coat': ['salmon', 'sardines', 'fish oil', 'flaxseed', 'eggs', 'sweet potato', 'pumpkin', 'spinach'],

  // Pancreatitis (low fat)
  'pancreatitis': ['white fish', 'turkey breast', 'chicken breast', 'rice', 'sweet potato', 'pumpkin', 'green beans'],
};

export const HEALTH_CONTRAINDICATIONS: Record<string, string[]> = {
  'kidney-disease': ['liver', 'organ', 'sardines', 'cheese', 'yogurt', 'high-phosphorus'],
  'pancreatitis': ['beef', 'pork', 'lamb', 'duck', 'oils', 'cheese', 'high-fat'],
  'diabetes': ['corn', 'white potato', 'sugar', 'sweetened'],
};

// Helper to normalize concern keys
export const normalizeConcernKey = (c: string) => c.toLowerCase().replace(/\s+/g, '-');
</file>

<file path="lib/data/healthConcerns.ts">
export type HealthConcernDef = {
  value: string;
  label: string;
  short: string;         // one-liner for badges
  long: string;          // 2-4 sentence explainer for education panels
  recommendedIngredients: { name: string; why: string }[];
  recommendedProducts?: { title: string; affiliateUrl?: string }[]; // first-pass affiliate suggestions
};

const healthConcerns: HealthConcernDef[] = [
  {
    value: 'kidney-disease',
    label: 'Kidney Disease',
    short: 'Low phosphorus, increased moisture',
    long:
      'Kidney disease increases phosphorus burden and reduces the ability to concentrate urine. Dietary changes focus on lowering phosphorus, moderating protein, and increasing moisture to reduce renal workload.',
    recommendedIngredients: [
      { name: 'White fish (cod)', why: 'Lower phosphorus, lean protein source' },
      { name: 'Pumpkin', why: 'Digestive fiber and moisture' },
      { name: 'Potato / rice', why: 'Lower phosphorus carbohydrates' }
    ],
    recommendedProducts: [
      { title: 'Low Phosphorus Supplement (example)', affiliateUrl: 'https://www.amazon.com/s?k=low+phosphorus+dog&tag=robinfrench-20' }
    ]
  },

  {
    value: 'heart-disease',
    label: 'Heart Disease',
    short: 'Moderate sodium, lean protein',
    long:
      'Heart disease management often includes sodium moderation and controlled calories to prevent fluid retention and obesity. Ingredients should favor lean proteins, omega-3s, and high-quality fiber.',
    recommendedIngredients: [
      { name: 'White fish', why: 'Lean protein, lower sodium potential' },
      { name: 'Oats', why: 'Soluble fiber supports cholesterol balance' },
      { name: 'Fish oil', why: 'Omega-3 for anti-inflammatory / cardiac support' }
    ],
    recommendedProducts: [
      { title: 'Fish Oil (example)', affiliateUrl: 'https://www.amazon.com/s?k=dog+fish+oil&tag=robinfrench-20' }
    ]
  },

  {
    value: 'diabetes',
    label: 'Diabetes',
    short: 'Low glycemic, consistent carbs',
    long:
      'Diabetic management emphasizes consistent carbohydrate sources, low glycemic carbs, appropriate protein, and portion control to stabilize blood sugar. High-fiber, low-sugar ingredients are prioritized.',
    recommendedIngredients: [
      { name: 'Sweet potato (in moderation)', why: 'Lower glycemic than some carbs' },
      { name: 'Green beans', why: 'Low-calorie fiber to add bulk' },
      { name: 'Lean poultry', why: 'Stable protein source' }
    ],
    recommendedProducts: [
      { title: 'Gluco-support supplement (example)', affiliateUrl: 'https://www.amazon.com/s?k=dog+glucose+support&tag=robinfrench-20' }
    ]
  },

  {
    value: 'allergies',
    label: 'Food Allergies',
    short: 'Novel proteins & limited ingredients',
    long:
      'Food allergies are often triggered by common proteins (chicken, beef) or certain grains. Management uses novel proteins and limited-ingredient recipes to reduce immune triggers.',
    recommendedIngredients: [
      { name: 'Venison or rabbit', why: 'Novel protein less likely to trigger allergy' },
      { name: 'Sweet potato', why: 'Limited-ingredient carb' },
      { name: 'Quinoa', why: 'Alternative carbohydrate for some pets' }
    ],
    recommendedProducts: [
      { title: 'Hydrolyzed protein topper (example)', affiliateUrl: 'https://www.amazon.com/s?k=hydrolyzed+protein+dog&tag=robinfrench-20' }
    ]
  },

  {
    value: 'obesity',
    label: 'Weight Management/Obesity',
    short: 'Calorie control & high satiety',
    long:
      'Weight management requires calorie control, increased activity, and ingredients that increase satiety (fiber, lean protein). Small portion adjustments and tracking matter most.',
    recommendedIngredients: [
      { name: 'Lean turkey', why: 'High protein, lower fat' },
      { name: 'Pumpkin', why: 'Fiber for satiety' },
      { name: 'Green beans', why: 'Low-calorie bulk' }
    ],
    recommendedProducts: [
      { title: 'Weight management supplement (example)', affiliateUrl: 'https://www.amazon.com/s?k=dog+weight+management&tag=robinfrench-20' }
    ]
  },

  {
    value: 'pancreatitis',
    label: 'Pancreatitis',
    short: 'Low fat, highly digestible',
    long:
      'Pancreatitis is worsened by high-fat diets. Safe recipes prioritize low-fat proteins, avoid fatty organ meats, and use easily digestible carbs to reduce pancreatic stress.',
    recommendedIngredients: [
      { name: 'White fish (cod)', why: 'Low fat protein source' },
      { name: 'Rice', why: 'Easily digestible carbohydrate' },
      { name: 'Boiled potato', why: 'Gentle on digestion' }
    ],
    recommendedProducts: [
      { title: 'Low-fat dog food topper (example)', affiliateUrl: 'https://www.amazon.com/s?k=low+fat+dog+topper&tag=robinfrench-20' }
    ]
  },

  {
    value: 'digestive-issues',
    label: 'Digestive Issues',
    short: 'Soothing fiber & probiotics',
    long:
      'Digestive upset benefits from soluble fiber, hydration, and probiotic support. Gentle carbohydrates and short ingredient lists can reduce gastrointestinal irritation.',
    recommendedIngredients: [
      { name: 'Pumpkin', why: 'Digestive fiber, soothes stool consistency' },
      { name: 'Rice', why: 'Gentle carbohydrate' },
      { name: 'Probiotic powder', why: 'Restores healthy gut flora' }
    ],
    recommendedProducts: [
      { title: 'Probiotic for dogs (example)', affiliateUrl: 'https://www.amazon.com/s?k=dog+probiotic&tag=robinfrench-20' }
    ]
  },

  {
    value: 'joint-health',
    label: 'Joint Problems/Arthritis',
    short: 'Omega-3s & joint support',
    long:
      'Joint support focuses on omega-3 fatty acids, glucosamine, and chondroitin to reduce inflammation and support cartilage. High omega-3 inclusion and targeted supplements help mobility.',
    recommendedIngredients: [
      { name: 'Salmon', why: 'Omega-3 source for inflammation control' },
      { name: 'Ground flaxseed', why: 'Plant-sourced omega-3' },
      { name: 'Sweet potato', why: 'Good carbohydrate + antioxidant support' }
    ],
    recommendedProducts: [
      { title: 'Glucosamine & chondroitin (example)', affiliateUrl: 'https://www.amazon.com/s?k=glucosamine+dog&tag=robinfrench-20' }
    ]
  },

  {
    value: 'dental-issues',
    label: 'Dental Issues',
    short: 'Crunchy textures & cleaning support',
    long:
      'Dental health is supported by crunchy textures that mechanically clean teeth and by supplements that reduce plaque. Avoid sticky, sugary ingredients that adhere to teeth.',
    recommendedIngredients: [
      { name: 'Carrot (raw pieces)', why: 'Crunchy texture helps cleaning' },
      { name: 'Dental chews (as recommended)', why: 'Designed for plaque control' }
    ],
    recommendedProducts: [
      { title: 'Dental chew (example)', affiliateUrl: 'https://www.amazon.com/s?k=dental+chew+dog&tag=robinfrench-20' }
    ]
  },

  {
    value: 'hip-dysplasia',
    label: 'Hip Dysplasia',
    short: 'Joint support & weight control',
    long:
      'Hip dysplasia management pairs weight control with joint support supplements. Lower body weight reduces joint load while omega-3 and joint supplements help tissue health.',
    recommendedIngredients: [
      { name: 'Lean turkey', why: 'Lean protein for weight control' },
      { name: 'Salmon (for omega-3s)', why: 'Reduce inflammation' }
    ],
    recommendedProducts: [
      { title: 'Joint supplement (example)', affiliateUrl: 'https://www.amazon.com/s?k=joint+supplement+dog&tag=robinfrench-20' }
    ]
  },

  {
    value: 'skin-conditions',
    label: 'Skin Conditions',
    short: 'Omega-3s & hypoallergenic options',
    long:
      'Skin issues respond well to omega-3 fatty acids, limited-ingredient diets, and elimination of suspected triggers. Topical care plus dietary steps improves the skin barrier over time.',
    recommendedIngredients: [
      { name: 'Salmon oil', why: 'Omega-3 support for skin' },
      { name: 'Limited-ingredient protein (rabbit/venison)', why: 'Reduce triggers' }
    ],
    recommendedProducts: [
      { title: 'Omega-3 supplement (example)', affiliateUrl: 'https://www.amazon.com/s?k=omega+3+dog&tag=robinfrench-20' }
    ]
  }
];

export default healthConcerns;
</file>

<file path="lib/data/healthConcernTemplates.ts">
// lib/data/healthConcernTemplates.ts
// Health concern templates per subtype
// These allow us to provide recommendations even when species-specific recipes don't exist

import type { Subtype } from '@/lib/utils/ingredientWhitelists';

export interface HealthConcernTemplate {
  id: string;
  name: string;
  subtype: Subtype;
  healthConcern: string;
  description: string;
  rules: {
    preferIngredients?: string[];      // Ingredients to prefer
    avoidIngredients?: string[];       // Ingredients to avoid/reduce
    maxInclusion?: Record<string, number>; // Max percentages for specific ingredients
    nutritionalAdjustments?: {
      reduceCalories?: boolean;
      reduceFat?: boolean;
      reducePhosphorus?: boolean;
      increaseFiber?: boolean;
      increaseProtein?: boolean;
    };
    substitutions?: Record<string, string[]>; // Ingredient substitutions
  };
  warning?: string; // Warning to show user
}

/**
 * Health concern templates by subtype
 * These templates can be applied to any species in that subtype
 */
export const HEALTH_CONCERN_TEMPLATES: HealthConcernTemplate[] = [
  // BIRD TEMPLATES
  {
    id: 'weight-management-bird-small',
    name: 'Weight Management - Small Birds',
    subtype: 'bird_small',
    healthConcern: 'weight-management',
    description: 'Lower calorie diet for small birds prone to obesity',
    rules: {
      preferIngredients: ['pellets_fortified', 'vegetables', 'leafy_greens'],
      avoidIngredients: ['sunflower_seeds', 'high_fat_seeds', 'nuts'],
      maxInclusion: {
        'seeds': 0.10, // Max 10% seeds
        'fruits': 0.15  // Max 15% fruits
      },
      nutritionalAdjustments: {
        reduceCalories: true,
        increaseFiber: true
      }
    },
    warning: 'Generic small bird weight management template - confirm with your vet'
  },
  {
    id: 'weight-management-bird-large',
    name: 'Weight Management - Large Birds',
    subtype: 'bird_large',
    healthConcern: 'weight-management',
    description: 'Lower calorie diet for large parrots prone to obesity',
    rules: {
      preferIngredients: ['pellets_fortified', 'vegetables', 'whole_grains'],
      avoidIngredients: ['nuts', 'high_fat_seeds', 'excessive_fruits'],
      maxInclusion: {
        'nuts': 0.05,
        'fruits': 0.20
      },
      nutritionalAdjustments: {
        reduceCalories: true,
        increaseFiber: true
      }
    },
    warning: 'Generic large bird weight management template - confirm with your vet'
  },
  {
    id: 'heart-disease-bird',
    name: 'Heart Disease Support - Birds',
    subtype: 'bird_large', // Applies to both, but large birds more common
    healthConcern: 'heart',
    description: 'Lower fat, heart-healthy diet for birds with cardiac issues',
    rules: {
      preferIngredients: ['pellets_fortified', 'vegetables', 'leafy_greens'],
      avoidIngredients: ['high_fat_seeds', 'nuts', 'sunflower_seeds'],
      maxInclusion: {
        'seeds': 0.10,
        'fats': 0.05
      },
      nutritionalAdjustments: {
        reduceFat: true,
        increaseFiber: true
      },
      substitutions: {
        'sunflower_seeds': ['millet', 'canary_seed'],
        'nuts': ['pellets_fortified']
      }
    },
    warning: 'Generic bird heart health template - confirm with your vet'
  },
  
  // REPTILE TEMPLATES
  {
    id: 'weight-management-reptile-herbivore',
    name: 'Weight Management - Herbivore Reptiles',
    subtype: 'reptile_herbivore',
    healthConcern: 'weight-management',
    description: 'Lower calorie diet for herbivorous reptiles',
    rules: {
      preferIngredients: ['leafy_greens', 'low_calorie_vegetables'],
      avoidIngredients: ['fruits', 'high_sugar_vegetables'],
      maxInclusion: {
        'fruits': 0.10,
        'squash': 0.15
      },
      nutritionalAdjustments: {
        reduceCalories: true,
        increaseFiber: true
      }
    },
    warning: 'Generic herbivore reptile weight management - applies to bearded dragons, iguanas, etc. Confirm with your vet'
  },
  {
    id: 'metabolic-bone-disease-reptile',
    name: 'Metabolic Bone Disease Support - Reptiles',
    subtype: 'reptile_herbivore',
    healthConcern: 'bone-health',
    description: 'High calcium, proper Ca:P ratio for reptiles with MBD',
    rules: {
      preferIngredients: ['collard_greens', 'mustard_greens', 'dandelion_greens', 'calcium_supplement'],
      avoidIngredients: ['spinach', 'beet_greens', 'swiss_chard'], // High oxalates
      maxInclusion: {
        'spinach': 0.05,
        'oxalate_greens': 0.10
      },
      nutritionalAdjustments: {
        increaseFiber: true // For proper Ca:P
      }
    },
    warning: 'Generic reptile bone health template - ensure proper UVB and calcium supplementation'
  },
  
  // POCKET PET TEMPLATES
  {
    id: 'weight-management-pocket-hay',
    name: 'Weight Management - Hay-Based Pets',
    subtype: 'pocket_hay',
    healthConcern: 'weight-management',
    description: 'Unlimited hay, limited pellets and fruits for rabbits/guinea pigs',
    rules: {
      preferIngredients: ['timothy_hay', 'orchard_grass_hay', 'leafy_greens'],
      avoidIngredients: ['alfalfa_hay', 'pellets', 'fruits', 'carrots'],
      maxInclusion: {
        'pellets': 0.05,
        'fruits': 0.02,
        'carrots': 0.05
      },
      nutritionalAdjustments: {
        reduceCalories: true,
        increaseFiber: true
      }
    },
    warning: 'Generic hay-based pet weight management - unlimited hay, minimal treats'
  },
  {
    id: 'urinary-health-pocket-hay',
    name: 'Urinary Health - Hay-Based Pets',
    subtype: 'pocket_hay',
    healthConcern: 'urinary-health',
    description: 'High moisture, low calcium for urinary issues',
    rules: {
      preferIngredients: ['timothy_hay', 'leafy_greens', 'high_moisture_vegetables'],
      avoidIngredients: ['alfalfa_hay', 'high_calcium_greens'],
      maxInclusion: {
        'alfalfa': 0.0,
        'high_calcium_greens': 0.10
      },
      nutritionalAdjustments: {
        increaseFiber: true // For hydration
      }
    },
    warning: 'Generic urinary health template - ensure adequate hydration'
  },
  {
    id: 'diabetes-pocket-varied',
    name: 'Diabetes Support - Small Mammals',
    subtype: 'pocket_varied',
    healthConcern: 'diabetes',
    description: 'Low sugar, high fiber diet for diabetic hamsters/gerbils',
    rules: {
      preferIngredients: ['pellets', 'vegetables', 'protein'],
      avoidIngredients: ['fruits', 'sweet_vegetables', 'grains'],
      maxInclusion: {
        'fruits': 0.0,
        'sweet_vegetables': 0.05
      },
      nutritionalAdjustments: {
        reduceCalories: true,
        increaseFiber: true,
        increaseProtein: true
      }
    },
    warning: 'Generic diabetes template for small mammals - monitor blood sugar'
  }
];

/**
 * Get health concern templates for a subtype
 */
export function getHealthTemplatesForSubtype(subtype: Subtype, healthConcern?: string): HealthConcernTemplate[] {
  let templates = HEALTH_CONCERN_TEMPLATES.filter(t => t.subtype === subtype);
  
  if (healthConcern) {
    templates = templates.filter(t => t.healthConcern === healthConcern);
  }
  
  return templates;
}

/**
 * Get health concern templates that apply to a species
 */
export function getHealthTemplatesForSpecies(species: string, breed?: string, healthConcern?: string): HealthConcernTemplate[] {
  const { normalizeToSubtype } = require('@/lib/utils/ingredientWhitelists');
  const subtype = normalizeToSubtype(species as any, breed);
  
  return getHealthTemplatesForSubtype(subtype, healthConcern);
}

/**
 * Apply a health template to a recipe/ingredient list
 */
export function applyHealthTemplate(
  ingredients: string[],
  template: HealthConcernTemplate
): {
  adjustedIngredients: string[];
  warnings: string[];
  substitutions: Record<string, string>;
} {
  const adjusted: string[] = [];
  const warnings: string[] = [];
  const substitutions: Record<string, string> = {};
  
  ingredients.forEach(ing => {
    const ingLower = ing.toLowerCase();
    
    // Check if should avoid
    const shouldAvoid = template.rules.avoidIngredients?.some(avoid => 
      ingLower.includes(avoid.toLowerCase())
    );
    
    if (shouldAvoid) {
      // Try to substitute
      let substituted = false;
      for (const [original, replacements] of Object.entries(template.rules.substitutions || {})) {
        if (ingLower.includes(original.toLowerCase())) {
          const replacement = replacements[0]; // Use first replacement
          adjusted.push(replacement);
          substitutions[ing] = replacement;
          substituted = true;
          break;
        }
      }
      
      if (!substituted) {
        warnings.push(`Reduced or removed: ${ing} (not ideal for ${template.name})`);
      }
    } else {
      adjusted.push(ing);
    }
  });
  
  // Add preferred ingredients if missing
  template.rules.preferIngredients?.forEach(pref => {
    if (!adjusted.some(ing => ing.toLowerCase().includes(pref.toLowerCase()))) {
      adjusted.push(pref);
    }
  });
  
  return { adjustedIngredients: adjusted, warnings, substitutions };
}
</file>

<file path="lib/data/imageManifest.ts">
// Image manifest for pet emoji groups and variants
export interface ImageGroup {
  masterIcon: string;
  masterHero: string;
  emojis: string[];
  variants: {
    icon_64: string;
    icon_128: string;
    thumb_150: string;
    thumb_300x200: string;
    recipe_600x384: string;
    recipe_300x192: string;
    banner_800x400: string;
    hero_1200x600: string;
    hero_800x400: string;
  };
}

export interface HealthConcernStyle {
  color: string;
  symbol: string;
  overlayType: 'icon' | 'frame' | 'badge';
}

export const imageManifest: Record<string, ImageGroup> = {
  "dog": {
    "masterIcon": "/assets/images/animals/dog/dog-core-icon-master.png",
    "masterHero": "/assets/images/animals/dog/dog-recipe-hero-master.png",
    "emojis": ["üêï", "üê∂", "üêï‚Äçü¶∫", "ü¶Æ", "üê©"],
    "variants": {
      "icon_64": "dog-icon-64.png",
      "icon_128": "dog-icon-128.png",
      "thumb_150": "dog-thumb-150.png",
      "thumb_300x200": "dog-thumb-300x200.png",
      "recipe_600x384": "dog-recipe-600x384.png",
      "recipe_300x192": "dog-recipe-300x192.png",
      "banner_800x400": "dog-banner-800x400.png",
      "hero_1200x600": "dog-hero-1200x600.png",
      "hero_800x400": "dog-hero-800x400.png"
    }
  },
  "cat": {
    "masterIcon": "/assets/images/animals/cat/cat-core-icon-master.png",
    "masterHero": "/assets/images/animals/cat/cat-recipe-hero-master.png",
    "emojis": ["üêà", "üê±", "üêà‚Äç‚¨õ"],
    "variants": {
      "icon_64": "cat-icon-64.png",
      "icon_128": "cat-icon-128.png",
      "thumb_150": "cat-thumb-150.png",
      "thumb_300x200": "cat-thumb-300x200.png",
      "recipe_600x384": "cat-recipe-600x384.png",
      "recipe_300x192": "cat-recipe-300x192.png",
      "banner_800x400": "cat-banner-800x400.png",
      "hero_1200x600": "cat-hero-1200x600.png",
      "hero_800x400": "cat-hero-800x400.png"
    }
  },
  "bird": {
    "masterIcon": "/assets/images/animals/bird/bird-core-icon-master.png",
    "masterHero": "/assets/images/animals/bird/bird-recipe-hero-master.png",
    "emojis": ["ü¶ú", "üê¶", "ü™∂", "üêì", "üêî", "üê£", "üê§", "üê•", "üêß", "ü¶Ü", "ü¶Ö", "ü¶â", "ü¶á"],
    "variants": {
      "icon_64": "bird-icon-64.png",
      "icon_128": "bird-icon-128.png",
      "thumb_150": "bird-thumb-150.png",
      "thumb_300x200": "bird-thumb-300x200.png",
      "recipe_600x384": "bird-recipe-600x384.png",
      "recipe_300x192": "bird-recipe-300x192.png",
      "banner_800x400": "bird-banner-800x400.png",
      "hero_1200x600": "bird-hero-1200x600.png",
      "hero_800x400": "bird-hero-800x400.png"
    }
  },
  "reptile": {
    "masterIcon": "/assets/images/animals/reptile/reptile-core-icon-master.png",
    "masterHero": "/assets/images/animals/reptile/reptile-recipe-hero-master.png",
    "emojis": ["ü¶é", "üê¢", "üêç", "üêä", "ü¶ñ", "ü¶ï"],
    "variants": {
      "icon_64": "reptile-icon-64.png",
      "icon_128": "reptile-icon-128.png",
      "thumb_150": "reptile-thumb-150.png",
      "thumb_300x200": "reptile-thumb-300x200.png",
      "recipe_600x384": "reptile-recipe-600x384.png",
      "recipe_300x192": "reptile-recipe-300x192.png",
      "banner_800x400": "reptile-banner-800x400.png",
      "hero_1200x600": "reptile-hero-1200x600.png",
      "hero_800x400": "reptile-hero-800x400.png"
    }
  },
  "pocket": {
    "masterIcon": "/assets/images/animals/pocket/pocket-core-icon-master.png",
    "masterHero": "/assets/images/animals/pocket/pocket-recipe-hero-master.png",
    "emojis": ["üê∞", "üêπ", "üê≠", "ü¶î", "üêøÔ∏è"],
    "variants": {
      "icon_64": "pocket-icon-64.png",
      "icon_128": "pocket-icon-128.png",
      "thumb_150": "pocket-thumb-150.png",
      "thumb_300x200": "pocket-thumb-300x200.png",
      "recipe_600x384": "pocket-recipe-600x384.png",
      "recipe_300x192": "pocket-recipe-300x192.png",
      "banner_800x400": "pocket-banner-800x400.png",
      "hero_1200x600": "pocket-hero-1200x600.png",
      "hero_800x400": "pocket-hero-800x400.png"
    }
  },
  "sea": {
    "masterIcon": "/assets/images/animals/sea/sea-core-icon-master.png",
    "masterHero": "/assets/images/animals/sea/sea-recipe-hero-master.png",
    "emojis": ["üêô", "ü¶ë", "ü¶ê", "ü¶û", "ü¶Ä", "üê°", "üê†", "üêü", "üê¨", "üê≥", "üêã", "ü¶à"],
    "variants": {
      "icon_64": "sea-icon-64.png",
      "icon_128": "sea-icon-128.png",
      "thumb_150": "sea-thumb-150.png",
      "thumb_300x200": "sea-thumb-300x200.png",
      "recipe_600x384": "sea-recipe-600x384.png",
      "recipe_300x192": "sea-recipe-300x192.png",
      "banner_800x400": "sea-banner-800x400.png",
      "hero_1200x600": "sea-hero-1200x600.png",
      "hero_800x400": "sea-hero-800x400.png"
    }
  },
  "bug": {
    "masterIcon": "/assets/images/animals/bug/bug-core-icon-master.png",
    "masterHero": "/assets/images/animals/bug/bug-recipe-hero-master.png",
    "emojis": ["üêù", "üêõ", "ü¶ã", "üêå", "üêû", "üêú", "ü¶ó", "üï∑Ô∏è", "ü¶Ç"],
    "variants": {
      "icon_64": "bug-icon-64.png",
      "icon_128": "bug-icon-128.png",
      "thumb_150": "bug-thumb-150.png",
      "thumb_300x200": "bug-thumb-300x200.png",
      "recipe_600x384": "bug-recipe-600x384.png",
      "recipe_300x192": "bug-recipe-300x192.png",
      "banner_800x400": "bug-banner-800x400.png",
      "hero_1200x600": "bug-hero-1200x600.png",
      "hero_800x400": "bug-hero-800x400.png"
    }
  },
  "farm": {
    "masterIcon": "/assets/images/animals/farm/farm-core-icon-master.png",
    "masterHero": "/assets/images/animals/farm/farm-recipe-hero-master.png",
    "emojis": ["üêÉ", "üêÇ", "üêÑ", "üêé", "üêñ", "üêè", "üêë", "ü¶ô", "üêê", "ü¶å"],
    "variants": {
      "icon_64": "farm-icon-64.png",
      "icon_128": "farm-icon-128.png",
      "thumb_150": "farm-thumb-150.png",
      "thumb_300x200": "farm-thumb-300x200.png",
      "recipe_600x384": "farm-recipe-600x384.png",
      "recipe_300x192": "farm-recipe-300x192.png",
      "banner_800x400": "farm-banner-800x400.png",
      "hero_1200x600": "farm-hero-1200x600.png",
      "hero_800x400": "farm-hero-800x400.png"
    }
  },
  "wild": {
    "masterIcon": "/assets/images/animals/wild/wild-core-icon-master.png",
    "masterHero": "/assets/images/animals/wild/wild-recipe-hero-master.png",
    "emojis": ["üêª", "üê®", "üêº", "ü¶ä", "üê∫", "üêó", "üê¥", "üêÖ", "üêÜ", "ü¶ì", "ü¶ç", "ü¶ß", "üêò", "ü¶õ", "ü¶è", "üê™", "üê´", "ü¶í", "ü¶ò"],
    "variants": {
      "icon_64": "wild-icon-64.png",
      "icon_128": "wild-icon-128.png",
      "thumb_150": "wild-thumb-150.png",
      "thumb_300x200": "wild-thumb-300x200.png",
      "recipe_600x384": "wild-recipe-600x384.png",
      "recipe_300x192": "wild-recipe-300x192.png",
      "banner_800x400": "wild-banner-800x400.png",
      "hero_1200x600": "wild-hero-1200x600.png",
      "hero_800x400": "wild-hero-800x400.png"
    }
  },
  "fantasy": {
    "masterIcon": "/assets/images/animals/fantasy/fantasy-core-icon-master.png",
    "masterHero": "/assets/images/animals/fantasy/fantasy-recipe-hero-master.png",
    "emojis": ["ü¶Ñ"],
    "variants": {
      "icon_64": "fantasy-icon-64.png",
      "icon_128": "fantasy-icon-128.png",
      "thumb_150": "fantasy-thumb-150.png",
      "thumb_300x200": "fantasy-thumb-300x200.png",
      "recipe_600x384": "fantasy-recipe-600x384.png",
      "recipe_300x192": "fantasy-recipe-300x192.png",
      "banner_800x400": "fantasy-banner-800x400.png",
      "hero_1200x600": "fantasy-hero-1200x600.png",
      "hero_800x400": "fantasy-hero-800x400.png"
    }
  }
};

export const healthConcernStyles: Record<string, HealthConcernStyle> = {
  "kidney-disease": { color: "#3B82F6", symbol: "ü´ò", overlayType: "icon" },
  "heart-disease": { color: "#EF4444", symbol: "‚ù§Ô∏è", overlayType: "icon" },
  "diabetes": { color: "#8B5CF6", symbol: "üç¨", overlayType: "icon" },
  "allergies": { color: "#F59E0B", symbol: "‚ö†Ô∏è", overlayType: "badge" },
  "obesity": { color: "#F97316", symbol: "‚öñÔ∏è", overlayType: "icon" },
  "pancreatitis": { color: "#92400E", symbol: "üç™", overlayType: "icon" },
  "digestive-issues": { color: "#10B981", symbol: "üçΩÔ∏è", overlayType: "icon" },
  "joint-health": { color: "#3B82F6", symbol: "ü¶¥", overlayType: "icon" },
  "dental-issues": { color: "#FFFFFF", symbol: "ü¶∑", overlayType: "icon" },
  "hip-dysplasia": { color: "#6B7280", symbol: "ü¶µ", overlayType: "icon" },
  "skin-conditions": { color: "#EC4899", symbol: "üß¥", overlayType: "icon" }
};

export const petCategoryStyles: Record<string, { color: string; symbol: string }> = {
  "dogs": { color: "#3B82F6", symbol: "üêï" },
  "cats": { color: "#F59E0B", symbol: "üêà" },
  "birds": { color: "#10B981", symbol: "ü¶ú" },
  "reptiles": { color: "#8B5CF6", symbol: "ü¶é" },
  "pocket-pets": { color: "#EC4899", symbol: "üê∞" }
};
</file>

<file path="lib/data/ingredientCompositions.ts">
// lib/data/ingredientCompositions.ts
// USDA nutrition data for common pet food ingredients
// All values per 100g raw edible portion unless otherwise noted

export type SpeciesCompatibility = 'ok' | 'avoid' | 'limit' | 'caution';
export type ConfidenceLevel = 'high' | 'medium' | 'low';
export type FeedingRole = 'staple' | 'secondary' | 'treat' | 'supplement' | 'forage';

export interface IngredientComposition {
  // Basic info
  name?: string;        // Human-readable name

  // Protein hierarchy (only for protein category)
  proteinRole?: 'primary' | 'secondary';  // PHASE 1.7: Explicit protein role

  // Nutritional data
  protein?: number;     // g per 100g (optional for supplements)
  fat?: number;         // g per 100g (optional for supplements)
  calcium?: number;     // mg per 100g
  phosphorus?: number;  // mg per 100g
  moisture?: number;    // g per 100g
  kcal?: number;        // calories per 100g
  omega3?: number;      // g EPA+DHA per 100g
  CaP_ratio?: number;   // calcium to phosphorus ratio
  vitaminA?: number;    // IU per 100g
  
  // PHASE 2: Micronutrient toxicity tracking
  copper_mg_per_100g?: number;  // mg per 100g
  iodine_mcg_per_100g?: number; // mcg per 100g
  micronutrientConfidence?: 'measured' | 'estimated' | 'assumed_high' | 'assumed_low';
  vitaminC?: number;    // mg per 100g
  taurine?: number;     // mg per 100g (critical for cats)
  fiber?: number;       // g per 100g
  carbs?: number;       // g per 100g
  source?: string;      // data source citation
  
  // Species compatibility (NEW - for multi-species support)
  speciesCompatibility?: {
    dog?: SpeciesCompatibility;
    cat?: SpeciesCompatibility;
    bird?: SpeciesCompatibility;
    reptile?: SpeciesCompatibility;
    'pocket-pet'?: SpeciesCompatibility;
  };
  
  // Data confidence (NEW - communicates evidence strength)
  confidenceBySpecies?: {
    dog?: ConfidenceLevel;
    cat?: ConfidenceLevel;
    bird?: ConfidenceLevel;
    reptile?: ConfidenceLevel;
    'pocket-pet'?: ConfidenceLevel;
  };
  
  // Feeding role (NEW - how this ingredient should be used)
  feedingRole?: FeedingRole;
  
  // Maximum inclusion percentage by species (NEW - prevents overfeeding)
  maxInclusionPercentBySpecies?: {
    dog?: number;       // e.g., 0.30 = max 30% of total meal
    cat?: number;
    bird?: number;
    reptile?: number;
    'pocket-pet'?: number;
  };
  
  // Species-specific notes (NEW - important warnings/guidance)
  notesBySpecies?: {
    dog?: string;
    cat?: string;
    bird?: string;
    reptile?: string;
    'pocket-pet'?: string;
  };
  
  // Legacy flags (keep for backward compatibility)
  allergen?: boolean;
  toxic?: boolean;
  toxicFor?: string[];  // Which species this is toxic for
  needsReview?: boolean; // Flag if nutritional data needs manual review
}

export const INGREDIENT_COMPOSITIONS: Record<string, IngredientComposition> = {
  // Poultry
  "chicken_breast": {
    proteinRole: 'primary', // PRIMARY PROTEIN FOR DOGS
    protein: 31.0,
    fat: 3.6,
    calcium: 11,
    phosphorus: 196,
    moisture: 65,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    copper_mg_per_100g: 0.1, // PHASE 2: Class default for muscle meat
    iodine_mcg_per_100g: 5,   // PHASE 2: Class default for muscle meat
    micronutrientConfidence: 'assumed_high',
    kcal: 165,
    source: "USDA FDC ID: 171116",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'staple', // PRIMARY PROTEIN FOR DOGS
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.60,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds (raptors, corvids). Not suitable for seed-eating birds.',
      reptile: 'Only for omnivorous/carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils except under vet direction.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "ground_turkey": {
    proteinRole: 'secondary',
    protein: 28.6,
    fat: 10.4,
    calcium: 14,
    phosphorus: 206,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    kcal: 189,
    source: "USDA FDC ID: 174036",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'secondary', // Secondary protein for dogs
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.60,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds (raptors, corvids). Not suitable for seed-eating birds.',
      reptile: 'Only for omnivorous/carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils except under vet direction.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "ground_chicken": {
    proteinRole: 'secondary',
    protein: 27.0,
    fat: 7.4,
    calcium: 11,
    phosphorus: 190,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    kcal: 172,
    source: "USDA FDC ID: 171116 (estimated from chicken breast)",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'secondary', // Secondary protein for dogs
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.60,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds (raptors, corvids). Not suitable for seed-eating birds.',
      reptile: 'Only for omnivorous/carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils except under vet direction.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "chicken_thighs": {
    proteinRole: 'secondary',
    protein: 20.6,
    fat: 14.1,
    calcium: 9,
    phosphorus: 170,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    kcal: 209,
    source: "USDA FDC ID: 171450",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'secondary', // Secondary protein for dogs
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.60,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds (raptors, corvids). Not suitable for seed-eating birds.',
      reptile: 'Only for omnivorous/carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils except under vet direction.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "turkey_breast": {
    proteinRole: 'secondary',
    protein: 30.1,
    fat: 1.0,
    calcium: 6,
    phosphorus: 223,
    moisture: 70,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    kcal: 135,
    source: "USDA FDC ID: 171479",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'secondary', // Secondary protein for dogs
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.60,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds (raptors, corvids). Not suitable for seed-eating birds.',
      reptile: 'Only for omnivorous/carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils except under vet direction.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "chicken_liver": {
    protein: 16.9,
    fat: 4.8,
    calcium: 8,
    phosphorus: 241,
    kcal: 119,
    source: "USDA FDC ID: 171060",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.15,
      bird: 0.05,
      reptile: 0.10,
      'pocket-pet': 0
    },
    notesBySpecies: {
      dog: 'High in vitamin A - limit to prevent hypervitaminosis A.',
      cat: 'Excellent source of taurine and vitamin A. Limit to prevent toxicity.',
      bird: 'Only for carnivorous birds. Very high in vitamin A.',
      reptile: 'Only for carnivorous reptiles. High vitamin A content.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils; vitamin A levels are excessive.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "chicken_hearts": {
    protein: 15.9,
    fat: 9.3,
    calcium: 7,
    phosphorus: 204,
    kcal: 153,
    source: "USDA FDC ID: 171059",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.20,
      bird: 0.05,
      reptile: 0.10,
      'pocket-pet': 0
    },
    notesBySpecies: {
      cat: 'Excellent source of taurine for cats.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils; excessive animal protein.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },

  // Fish
  "salmon_atlantic": {
    proteinRole: 'primary', // PRIMARY PROTEIN FOR CATS
    protein: 20.4,
    fat: 13.4,
    omega3: 2.26,
    calcium: 12,
    phosphorus: 200,
    vitaminA: 30, // Fish has low vitamin A (USDA FDC ID: 175168)
    kcal: 208,
    source: "USDA FDC ID: 175168",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'staple', // PRIMARY PROTEIN FOR CATS
    maxInclusionPercentBySpecies: {
      dog: 0.40,
      cat: 0.50,
      bird: 0.10,
      reptile: 0.15,
      'pocket-pet': 0
    },
    notesBySpecies: {
      bird: 'Only for carnivorous birds. High fat content - limit frequency.',
      reptile: 'Only for carnivorous reptiles. Ensure proper Ca:P ratio with supplementation.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets (rabbits, guinea pigs). Avoid for omnivorous hamsters/gerbils due to fat and protein load.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "sardines_water": {
    proteinRole: 'secondary',
    protein: 24.6,
    fat: 13.9,
    omega3: 1.48,
    calcium: 382,
    phosphorus: 490,
    vitaminA: 40, // Fish has low vitamin A
    kcal: 208,
    source: "USDA FDC ID: 175139",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.30,
      cat: 0.40,
      bird: 0.10,
      reptile: 0.15,
      'pocket-pet': 0
    },
    notesBySpecies: {
      dog: 'Excellent source of omega-3 and calcium. High phosphorus - balance with calcium.',
      cat: 'Great source of omega-3 and taurine. High calcium content.',
      bird: 'Only for carnivorous birds. High fat content.',
      reptile: 'Only for carnivorous reptiles. High calcium but also high phosphorus.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets. Avoid for omnivorous hamsters/gerbils; excessive fat and calcium.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "tuna_in_water": {
    protein: 25.5,
    fat: 1.0,
    calcium: 11,
    phosphorus: 208,
    kcal: 86,
    source: "USDA FDC ID: 175160",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.30,
      cat: 0.40,
      bird: 0.10,
      reptile: 0.15,
      'pocket-pet': 0
    },
    notesBySpecies: {
      cat: 'Good source of protein. Limit frequency due to mercury concerns.',
      bird: 'Only for carnivorous birds. Limit due to mercury.',
      reptile: 'Only for carnivorous reptiles. Low fat option.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets. Avoid for omnivorous hamsters/gerbils; mercury risk and protein load.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },

  // Beef
  "ground_beef_lean": {
    protein: 25.6,
    fat: 16.0,
    calcium: 6,
    phosphorus: 179,
    kcal: 230,
    source: "USDA FDC ID: 23547",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'caution',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.50,
      cat: 0.30,
      bird: 0.10,
      reptile: 0.20,
      'pocket-pet': 0
    },
    notesBySpecies: {
      cat: 'Some cats are allergic or intolerant to beef. Monitor for reactions.',
      bird: 'Only for carnivorous birds.',
      reptile: 'Only for carnivorous reptiles.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets. Avoid for omnivorous hamsters/gerbils due to high fat/protein.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "beef_liver": {
    protein: 20.4,
    fat: 3.6,
    calcium: 6,
    phosphorus: 387,
    kcal: 135,
    source: "USDA FDC ID: 169451",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'caution',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.10,
      bird: 0.05,
      reptile: 0.10,
      'pocket-pet': 0
    },
    notesBySpecies: {
      dog: 'Very high in vitamin A - limit to prevent hypervitaminosis A.',
      cat: 'Some cats allergic to beef. High vitamin A - limit to prevent toxicity.',
      bird: 'Only for carnivorous birds. Extremely high in vitamin A.',
      reptile: 'Only for carnivorous reptiles. Very high vitamin A content.',
      'pocket-pet': 'Not suitable for herbivorous pocket pets. Avoid for omnivorous hamsters/gerbils; vitamin A content is excessive.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },

  // Eggs
  "eggs_whole": {
    protein: 12.6,
    fat: 9.5,
    calcium: 56,
    phosphorus: 198,
    kcal: 143,
    source: "USDA FDC ID: 173424",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.20,
      cat: 0.25,
      bird: 0.15,
      reptile: 0.20,
      'pocket-pet': 0.10
    },
    notesBySpecies: {
      dog: 'Excellent protein source. Cook to reduce biotin binding.',
      cat: 'Great source of protein and taurine. Cook thoroughly.',
      bird: 'Excellent for all birds. Cook thoroughly to prevent salmonella.',
      reptile: 'Good protein source for omnivorous reptiles. Cook thoroughly.',
      'pocket-pet': 'Good for hamsters and gerbils. Limit for rabbits and guinea pigs.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'medium'
    }
  },

  // Vegetables for Herbivores
  "kale_raw": {
    protein: 2.9,
    fat: 0.4,
    calcium: 254,
    phosphorus: 55,
    CaP_ratio: 4.6,
    vitaminA: 9990,
    vitaminC: 93.4,
    kcal: 35,
    source: "USDA FDC ID: 168421",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.10,
      bird: 0.20,
      reptile: 0.30,
      'pocket-pet': 0.25
    },
    notesBySpecies: {
      cat: 'High calcium - good for bone health but limit due to oxalates.',
      bird: 'Excellent for parrots. High in vitamin A and calcium.',
      reptile: 'Excellent for herbivorous lizards. High Ca:P ratio is ideal.',
      'pocket-pet': 'Great for rabbits and guinea pigs. High calcium content.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "spinach_raw": {
    protein: 2.9,
    fat: 0.4,
    calcium: 99,
    phosphorus: 49,
    vitaminA: 9377,
    vitaminC: 28.1,
    kcal: 23,
    source: "USDA FDC ID: 168462",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.05,
      bird: 0.15,
      reptile: 0.25,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'High in oxalates - limit to prevent urinary issues.',
      bird: 'Excellent for parrots. High in vitamin A and calcium.',
      reptile: 'Great for herbivorous lizards. Good Ca:P ratio.',
      'pocket-pet': 'Excellent for rabbits and guinea pigs. High calcium.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "carrots_raw": {
    protein: 0.9,
    fat: 0.2,
    calcium: 33,
    phosphorus: 35,
    vitaminA: 16706,
    vitaminC: 5.9,
    kcal: 41,
    source: "USDA FDC ID: 170393",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.10,
      bird: 0.20,
      reptile: 0.20,
      'pocket-pet': 0.15
    },
    notesBySpecies: {
      cat: 'High in beta-carotene. Limit as cats are obligate carnivores.',
      bird: 'Excellent for all birds. High in vitamin A.',
      reptile: 'Good for herbivorous reptiles. High vitamin A content.',
      'pocket-pet': 'Great for all pocket pets. High in vitamin A.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "sweet_potato": {
    protein: 1.6,
    fat: 0.1,
    calcium: 30,
    phosphorus: 47,
    vitaminA: 14187,
    vitaminC: 2.4,
    kcal: 86,
    source: "USDA FDC ID: 168482",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.20,
      cat: 0.10,
      bird: 0.15,
      reptile: 0.25,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'High in carbs - limit as cats are obligate carnivores.',
      bird: 'Good for larger parrots. Cook before feeding.',
      reptile: 'Excellent for herbivorous reptiles. Cook before feeding.',
      'pocket-pet': 'Good for all pocket pets. Cook before feeding.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "pumpkin": {
    protein: 1.0,
    fat: 0.1,
    calcium: 21,
    phosphorus: 44,
    vitaminA: 7384,
    vitaminC: 9.0,
    fiber: 1.5,
    kcal: 26,
    source: "USDA FDC ID: 168448",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.10,
      bird: 0.15,
      reptile: 0.20,
      'pocket-pet': 0.15
    },
    notesBySpecies: {
      cat: 'Good for digestive health. Lower in carbs than sweet potato.',
      bird: 'Good for all birds. High in beta-carotene.',
      reptile: 'Excellent for herbivorous reptiles. High in beta-carotene.',
      'pocket-pet': 'Good for all pocket pets. High in beta-carotene.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "broccoli_raw": {
    protein: 2.8,
    fat: 0.4,
    calcium: 47,
    phosphorus: 66,
    vitaminA: 623,
    vitaminC: 89.2,
    kcal: 34,
    source: "USDA FDC ID: 170379",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.05,
      bird: 0.15,
      reptile: 0.20,
      'pocket-pet': 0.15
    },
    notesBySpecies: {
      cat: 'High in fiber - limit as cats are obligate carnivores.',
      bird: 'Excellent for parrots. High in vitamin C.',
      reptile: 'Good for herbivorous reptiles. High in vitamin C.',
      'pocket-pet': 'Great for rabbits and guinea pigs. High in vitamin C.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "green_beans_raw": {
    protein: 1.8,
    fat: 0.1,
    calcium: 37,
    phosphorus: 38,
    vitaminA: 690,
    vitaminC: 12.2,
    fiber: 2.7,
    kcal: 31,
    source: "USDA FDC ID: 168390",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.05,
      bird: 0.20,
      reptile: 0.25,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Low in phosphorus - good for kidney support, but limit as cats are obligate carnivores.',
      bird: 'Excellent for all birds. Low phosphorus makes it good for kidney health.',
      reptile: 'Excellent for herbivorous reptiles. Low phosphorus, good Ca:P ratio.',
      'pocket-pet': 'Great for rabbits and guinea pigs. Low phosphorus is beneficial.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "celery_raw": {
    protein: 0.7,
    fat: 0.2,
    calcium: 40,
    phosphorus: 24,
    vitaminA: 449,
    vitaminC: 3.1,
    kcal: 16,
    source: "USDA FDC ID: 169988",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.05,
      bird: 0.15,
      reptile: 0.20,
      'pocket-pet': 0.15
    },
    notesBySpecies: {
      cat: 'Low nutritional value for cats. Limit as cats are obligate carnivores.',
      bird: 'Good for all birds. High water content.',
      reptile: 'Excellent for herbivorous reptiles. Good Ca:P ratio.',
      'pocket-pet': 'Great for rabbits and guinea pigs. High water content.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "bok_choy": {
    protein: 1.5,
    fat: 0.2,
    calcium: 105,
    phosphorus: 37,
    CaP_ratio: 2.8,
    vitaminA: 4468,
    vitaminC: 45.0,
    fiber: 1.0,
    kcal: 13,
    source: "USDA FDC ID: 170386",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.15,
      cat: 0.10,
      bird: 0.20,
      reptile: 0.25,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Low in oxalates compared to kale - safer for cats. Good source of calcium.',
      bird: 'Excellent for all birds. Low oxalates, high calcium.',
      reptile: 'Excellent for herbivorous reptiles. Low oxalates, excellent Ca:P ratio.',
      'pocket-pet': 'Great for rabbits and guinea pigs. Low oxalates make it safer than kale.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },

  // Fruits
  "blueberries_raw": {
    protein: 0.7,
    fat: 0.3,
    calcium: 6,
    phosphorus: 12,
    vitaminA: 54,
    vitaminC: 9.7,
    kcal: 57,
    source: "USDA FDC ID: 171711",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.05,
      bird: 0.15,
      reptile: 0.15,
      'pocket-pet': 0.10
    },
    notesBySpecies: {
      cat: 'High in sugar - limit as cats are obligate carnivores.',
      bird: 'Excellent for all birds. High in antioxidants.',
      reptile: 'Good for omnivorous reptiles. High in antioxidants.',
      'pocket-pet': 'Great treat for all pocket pets. High in antioxidants.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "bananas_raw": {
    protein: 1.1,
    fat: 0.3,
    calcium: 5,
    phosphorus: 22,
    vitaminA: 64,
    vitaminC: 8.7,
    kcal: 89,
    source: "USDA FDC ID: 173944",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: {
      dog: 0.10,
      cat: 0.05,
      bird: 0.15,
      reptile: 0.15,
      'pocket-pet': 0.10
    },
    notesBySpecies: {
      cat: 'High in sugar - limit as cats are obligate carnivores.',
      bird: 'Excellent for all birds. High in potassium.',
      reptile: 'Good for omnivorous reptiles. High in potassium.',
      'pocket-pet': 'Great treat for all pocket pets. High in potassium.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'high',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },

  // Grains/Carbs
  "brown_rice_cooked": {
    protein: 2.7,
    fat: 0.9,
    calcium: 10,
    phosphorus: 83,
    kcal: 123,
    source: "USDA FDC ID: 20040",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'limit',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.30,
      cat: 0.10,
      bird: 0.25,
      reptile: 0.15,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Cats are obligate carnivores - grains should be minimal.',
      bird: 'Good for larger parrots. Smaller birds may prefer whole grains.',
      reptile: 'Only for omnivorous species. Not suitable for strict herbivores or carnivores.',
      'pocket-pet': 'Suitable for hamsters, gerbils. Limit for rabbits and guinea pigs.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'medium'
    }
  },
  "white_rice_cooked": {
    protein: 2.7,
    fat: 0.3,
    calcium: 3,
    phosphorus: 8,
    kcal: 130,
    source: "USDA FDC ID: 20036",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'limit',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.30,
      cat: 0.10,
      bird: 0.25,
      reptile: 0.15,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Cats are obligate carnivores - grains should be minimal. White rice is lower in nutrients than brown rice.',
      bird: 'Good for larger parrots. Lower in fiber than brown rice.',
      reptile: 'Only for omnivorous species. Lower in nutrients than brown rice.',
      'pocket-pet': 'Suitable for hamsters, gerbils. Lower in nutrients than brown rice.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'medium'
    }
  },
  "oats": {
    protein: 16.9,
    fat: 6.9,
    calcium: 54,
    phosphorus: 523,
    kcal: 379,
    source: "USDA FDC ID: 169705",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'limit',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.25,
      cat: 0.10,
      bird: 0.20,
      reptile: 0.15,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Cats are obligate carnivores - grains should be minimal.',
      bird: 'Good for larger parrots. Smaller birds prefer whole grains.',
      reptile: 'Only for omnivorous species. Not suitable for strict herbivores or carnivores.',
      'pocket-pet': 'Suitable for hamsters, gerbils. Limit for rabbits and guinea pigs.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'medium'
    }
  },
  "quinoa_cooked": {
    protein: 4.4,
    fat: 1.9,
    calcium: 17,
    phosphorus: 152,
    kcal: 120,
    source: "USDA FDC ID: 20137",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'limit',
      bird: 'ok',
      reptile: 'limit',
      'pocket-pet': 'ok'
    },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: {
      dog: 0.25,
      cat: 0.10,
      bird: 0.20,
      reptile: 0.15,
      'pocket-pet': 0.20
    },
    notesBySpecies: {
      cat: 'Cats are obligate carnivores - grains should be minimal.',
      bird: 'Good for larger parrots. High protein for a grain.',
      reptile: 'Only for omnivorous species. Not suitable for strict herbivores or carnivores.',
      'pocket-pet': 'Suitable for hamsters, gerbils. Limit for rabbits and guinea pigs.'
    },
    confidenceBySpecies: {
      dog: 'medium',
      cat: 'medium',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'medium'
    }
  },

  // Supplements
  "calcium_carbonate": {
    calcium: 40000, // 40% calcium by weight
    phosphorus: 0,
    CaP_ratio: 999, // effectively infinite
    source: "Supplement standard",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'ok',
      reptile: 'ok',
      'pocket-pet': 'ok'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.02,
      cat: 0.02,
      bird: 0.03,
      reptile: 0.05,
      'pocket-pet': 0.03
    },
    notesBySpecies: {
      dog: 'Essential for bone health. Use to balance Ca:P ratio.',
      cat: 'Important for bone health. Ensure proper Ca:P balance.',
      bird: 'Critical for egg-laying females. Prevents egg binding.',
      reptile: 'Essential for herbivorous species. Prevents metabolic bone disease.',
      'pocket-pet': 'Critical for rabbits and guinea pigs. Prevents dental issues.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'high',
      reptile: 'high',
      'pocket-pet': 'high'
    }
  },
  "fish_oil": {
    protein: 0,
    fat: 100,
    omega3: 30, // concentrated EPA+DHA
    kcal: 902,
    source: "Supplement standard",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'limit',
      reptile: 'limit',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.05,
      cat: 0.05,
      bird: 0.02,
      reptile: 0.02,
      'pocket-pet': 0
    },
    notesBySpecies: {
      dog: 'Excellent source of omega-3. Supports skin, coat, and joint health.',
      cat: 'Essential for cats. Supports heart and eye health.',
      bird: 'Only for carnivorous birds. Not needed for seed-eating species.',
      reptile: 'Only for carnivorous reptiles. Not for herbivorous species.',
      'pocket-pet': 'Avoid for rabbits and guinea pigs; fat load and fish proteins are inappropriate for herbivorous pocket pets.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },
  "taurine_powder": {
    protein: 0, // pure amino acid
    source: "Supplement standard",
    speciesCompatibility: {
      dog: 'ok',
      cat: 'ok',
      bird: 'avoid',
      reptile: 'avoid',
      'pocket-pet': 'avoid'
    },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: {
      dog: 0.01,
      cat: 0.02,
      bird: 0,
      reptile: 0,
      'pocket-pet': 0
    },
    notesBySpecies: {
      dog: 'Dogs can synthesize taurine but supplementation can be beneficial.',
      cat: 'CRITICAL for cats. Cats cannot synthesize taurine - deficiency causes blindness and heart failure.',
      bird: 'Avoid for seed-eating birds; unnecessary and unstudied.',
      reptile: 'Avoid for herbivorous reptiles; unnecessary for carnivores when diet is balanced.',
      'pocket-pet': 'Avoid for rabbits and guinea pigs; not part of herbivore requirement.'
    },
    confidenceBySpecies: {
      dog: 'high',
      cat: 'high',
      bird: 'medium',
      reptile: 'medium',
      'pocket-pet': 'high'
    }
  },

  // Additional Proteins
  "ground_lamb": {
    proteinRole: 'secondary',
    protein: 25.0,
    fat: 17.0,
    calcium: 15,
    phosphorus: 180,
    kcal: 250,
    source: "USDA FDC ID: 23195",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.50, cat: 0.30, bird: 0.10, reptile: 0.20, 'pocket-pet': 0 }
  },
  "duck_breast": {
    proteinRole: 'secondary',
    protein: 23.5,
    fat: 9.2,
    calcium: 12,
    phosphorus: 210,
    kcal: 201,
    source: "USDA FDC ID: 171082",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.30, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 }
  },
  "venison": {
    proteinRole: 'secondary',
    protein: 26.0,
    fat: 3.2,
    calcium: 10,
    phosphorus: 200,
    kcal: 158,
    source: "USDA FDC ID: 23671",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.50, cat: 0.40, bird: 0.10, reptile: 0.20, 'pocket-pet': 0 }
  },
  "rabbit_meat": {
    proteinRole: 'secondary',
    protein: 21.0,
    fat: 8.0,
    calcium: 18,
    phosphorus: 180,
    kcal: 173,
    source: "USDA FDC ID: 23672",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 }
  },
  "quail": {
    proteinRole: 'primary', // PRIMARY PROTEIN FOR REPTILES
    protein: 25.0,
    fat: 11.0,
    calcium: 14,
    phosphorus: 220,
    vitaminA: 0, // Muscle meat has negligible vitamin A
    kcal: 226,
    source: "USDA FDC ID: 171125",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' },
    feedingRole: 'staple', // PRIMARY PROTEIN FOR REPTILES
    maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.30, bird: 0.10, reptile: 0.30, 'pocket-pet': 0 }
  },
  "lamb_liver": {
    proteinRole: 'secondary',
    protein: 20.0,
    fat: 6.0,
    calcium: 8,
    phosphorus: 350,
    vitaminA: 36000, // Organ meat: high vitamin A (USDA)
    kcal: 137,
    source: "USDA FDC ID: 23195",
    speciesCompatibility: { dog: 'ok', cat: 'caution', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'supplement', // Organ meat - not staple
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.10, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 }
  },
  "turkey_liver": {
    proteinRole: 'secondary',
    protein: 18.0,
    fat: 5.0,
    calcium: 10,
    phosphorus: 280,
    kcal: 140,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.10, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 }
  },
  "duck_hearts": {
    proteinRole: 'secondary',
    protein: 16.0,
    fat: 10.0,
    calcium: 8,
    phosphorus: 200,
    kcal: 160,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 }
  },
  "mackerel_canned": {
    proteinRole: 'secondary',
    protein: 20.0,
    fat: 13.9,
    omega3: 2.0,
    calcium: 300,
    phosphorus: 250,
    vitaminA: 50, // Fish has low vitamin A
    kcal: 205,
    source: "USDA FDC ID: 175142",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'secondary', // Secondary protein for dogs/cats
    maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 }
  },
  "herring_canned": {
    proteinRole: 'secondary',
    protein: 18.0,
    fat: 12.0,
    omega3: 1.8,
    calcium: 280,
    phosphorus: 240,
    vitaminA: 50, // Fish has low vitamin A
    kcal: 195,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'secondary', // Secondary protein for dogs/cats
    maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 }
  },
  "anchovies_canned": {
    proteinRole: 'secondary',
    protein: 20.0,
    fat: 11.0,
    omega3: 2.4,
    calcium: 380,
    phosphorus: 280,
    vitaminA: 60, // Fish has low vitamin A
    kcal: 210,
    source: "USDA FDC ID: 175134",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'secondary', // Secondary protein for dogs/cats
    maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.30, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 }
  },

  // Additional Vegetables
  "collard_greens": {
    protein: 3.6,
    fat: 0.6,
    calcium: 232,
    phosphorus: 58,
    vitaminA: 10260,
    vitaminC: 35.3,
    kcal: 33,
    source: "USDA FDC ID: 169998",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.20, reptile: 0.30, 'pocket-pet': 0.25 }
  },
  "mustard_greens": {
    protein: 2.7,
    fat: 0.4,
    calcium: 103,
    phosphorus: 44,
    vitaminA: 5560,
    vitaminC: 65.0,
    kcal: 27,
    source: "USDA FDC ID: 169434",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.20, reptile: 0.30, 'pocket-pet': 0.25 }
  },
  "turnip_greens": {
    protein: 1.6,
    fat: 0.3,
    calcium: 190,
    phosphorus: 42,
    vitaminA: 6270,
    vitaminC: 60.0,
    kcal: 32,
    source: "USDA FDC ID: 169512",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.20, reptile: 0.30, 'pocket-pet': 0.25 }
  },
  "dandelion_greens": {
    protein: 2.7,
    fat: 0.7,
    calcium: 187,
    phosphorus: 66,
    vitaminA: 10161,
    vitaminC: 35.0,
    kcal: 45,
    source: "USDA FDC ID: 170416",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.20, reptile: 0.30, 'pocket-pet': 0.25 }
  },
  "swiss_chard": {
    protein: 1.8,
    fat: 0.2,
    calcium: 51,
    phosphorus: 46,
    vitaminA: 4431,
    vitaminC: 30.0,
    kcal: 19,
    source: "USDA FDC ID: 169500",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.20, reptile: 0.25, 'pocket-pet': 0.20 }
  },
  "butternut_squash": {
    protein: 1.0,
    fat: 0.1,
    calcium: 40,
    phosphorus: 33,
    vitaminA: 9040,
    vitaminC: 15.0,
    kcal: 45,
    source: "USDA FDC ID: 168485",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.25, 'pocket-pet': 0.20 }
  },
  "acorn_squash": {
    protein: 1.1,
    fat: 0.1,
    calcium: 45,
    phosphorus: 44,
    vitaminA: 961,
    vitaminC: 11.0,
    kcal: 56,
    source: "USDA FDC ID: 169486",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.25, 'pocket-pet': 0.20 }
  },
  "zucchini": {
    protein: 1.2,
    fat: 0.4,
    calcium: 19,
    phosphorus: 38,
    vitaminA: 393,
    vitaminC: 20.0,
    kcal: 21,
    source: "USDA FDC ID: 169291",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },
  "asparagus": {
    protein: 2.2,
    fat: 0.1,
    calcium: 24,
    phosphorus: 52,
    vitaminA: 756,
    vitaminC: 5.6,
    kcal: 20,
    source: "USDA FDC ID: 169174",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },
  "cauliflower": {
    protein: 1.9,
    fat: 0.4,
    calcium: 22,
    phosphorus: 44,
    vitaminA: 0,
    vitaminC: 46.4,
    kcal: 25,
    source: "USDA FDC ID: 169987",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },
  "bell_pepper": {
    protein: 0.9,
    fat: 0.3,
    calcium: 10,
    phosphorus: 24,
    vitaminA: 3131,
    vitaminC: 80.4,
    kcal: 31,
    source: "USDA FDC ID: 169686",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },
  "cucumber": {
    protein: 0.7,
    fat: 0.2,
    calcium: 16,
    phosphorus: 24,
    vitaminA: 105,
    vitaminC: 2.8,
    kcal: 16,
    source: "USDA FDC ID: 170591",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "lettuce_romaine": {
    protein: 1.2,
    fat: 0.3,
    calcium: 33,
    phosphorus: 30,
    vitaminA: 7371,
    vitaminC: 3.6,
    kcal: 15,
    source: "USDA FDC ID: 170432",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },
  "arugula": {
    protein: 2.6,
    fat: 0.7,
    calcium: 160,
    phosphorus: 44,
    vitaminA: 2373,
    vitaminC: 15.0,
    kcal: 25,
    source: "USDA FDC ID: 169975",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 }
  },

  // Additional Carbs
  "lentils": {
    protein: 9.0,
    fat: 0.4,
    calcium: 38,
    phosphorus: 281,
    kcal: 116,
    source: "USDA FDC ID: 170567",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "chickpeas": {
    protein: 8.9,
    fat: 2.6,
    calcium: 49,
    phosphorus: 168,
    kcal: 119,
    source: "USDA FDC ID: 170562",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "black_beans": {
    protein: 8.9,
    fat: 0.5,
    calcium: 83,
    phosphorus: 140,
    kcal: 132,
    source: "USDA FDC ID: 170561",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "green_peas": {
    protein: 5.4,
    fat: 0.4,
    calcium: 25,
    phosphorus: 108,
    kcal: 81,
    source: "USDA FDC ID: 170572",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "barley": {
    protein: 3.6,
    fat: 0.7,
    calcium: 33,
    phosphorus: 264,
    kcal: 354,
    source: "USDA FDC ID: 170284",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.25, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "millet": {
    protein: 3.7,
    fat: 1.3,
    calcium: 8,
    phosphorus: 285,
    kcal: 378,
    source: "USDA FDC ID: 170591",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.25, reptile: 0.10, 'pocket-pet': 0.15 }
  },
  "wild_rice": {
    protein: 3.3,
    fat: 0.3,
    calcium: 5,
    phosphorus: 243,
    kcal: 101,
    source: "USDA FDC ID: 20044",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0.25, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 }
  },

  // Additional Fruits
  "apple": {
    protein: 0.3,
    fat: 0.2,
    calcium: 6,
    phosphorus: 11,
    vitaminA: 54,
    vitaminC: 4.6,
    kcal: 52,
    source: "USDA FDC ID: 168097",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "strawberry": {
    protein: 0.8,
    fat: 0.3,
    calcium: 16,
    phosphorus: 24,
    vitaminA: 12,
    vitaminC: 58.8,
    kcal: 32,
    source: "USDA FDC ID: 168156",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "mango": {
    protein: 0.8,
    fat: 0.3,
    calcium: 11,
    phosphorus: 14,
    vitaminA: 3894,
    vitaminC: 36.4,
    kcal: 60,
    source: "USDA FDC ID: 168329",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "papaya": {
    protein: 0.6,
    fat: 0.1,
    calcium: 20,
    phosphorus: 10,
    vitaminA: 950,
    vitaminC: 60.9,
    kcal: 43,
    source: "USDA FDC ID: 168355",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "melon": {
    protein: 0.8,
    fat: 0.2,
    calcium: 9,
    phosphorus: 11,
    vitaminA: 3382,
    vitaminC: 36.7,
    kcal: 34,
    source: "USDA FDC ID: 168168",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "pear": {
    protein: 0.4,
    fat: 0.1,
    calcium: 9,
    phosphorus: 11,
    vitaminA: 24,
    vitaminC: 4.3,
    kcal: 57,
    source: "USDA FDC ID: 168348",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "peach": {
    protein: 0.9,
    fat: 0.3,
    calcium: 6,
    phosphorus: 20,
    vitaminA: 326,
    vitaminC: 6.6,
    kcal: 39,
    source: "USDA FDC ID: 168346",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "raspberry": {
    protein: 1.2,
    fat: 0.7,
    calcium: 25,
    phosphorus: 29,
    vitaminA: 12,
    vitaminC: 26.2,
    kcal: 52,
    source: "USDA FDC ID: 168151",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },
  "watermelon": {
    protein: 0.6,
    fat: 0.2,
    calcium: 7,
    phosphorus: 11,
    vitaminA: 303,
    vitaminC: 8.1,
    kcal: 30,
    source: "USDA FDC ID: 168175",
    speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
    feedingRole: 'treat',
    maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 }
  },

  // Additional Fats/Oils
  "coconut_oil": {
    protein: 0,
    fat: 100,
    kcal: 892,
    source: "Supplement standard",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 }
  },
  "olive_oil": {
    protein: 0,
    fat: 100,
    kcal: 884,
    source: "Supplement standard",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 }
  },
  "flaxseed_ground": {
    protein: 18.3,
    fat: 42.2,
    omega3: 22.8,
    calcium: 255,
    phosphorus: 642,
    kcal: 534,
    source: "USDA FDC ID: 170554",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0.05 }
  },
  "hemp_seeds": {
    protein: 10.3,
    fat: 48.3,
    omega3: 8.7,
    calcium: 70,
    phosphorus: 1160,
    kcal: 553,
    source: "USDA FDC ID: 170557",
    speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' },
    feedingRole: 'supplement',
    maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0.05 }
  },

  // Insects for Reptiles
  "crickets": {
    protein: 12.9,
    fat: 5.5,
    calcium: 75,
    phosphorus: 185,
    kcal: 121,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.80, 'pocket-pet': 0 }
  },
  "mealworms": {
    protein: 20.1,
    fat: 5.5,
    calcium: 8,
    phosphorus: 205,
    kcal: 206,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'ok', 'pocket-pet': 'limit' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.60, 'pocket-pet': 0.10 }
  },
  "dubia_roaches": {
    protein: 18.0,
    fat: 8.0,
    calcium: 80,
    phosphorus: 150,
    kcal: 180,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.80, 'pocket-pet': 0 }
  },
  "locusts": {
    protein: 14.0,
    fat: 6.0,
    calcium: 90,
    phosphorus: 170,
    kcal: 140,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.80, 'pocket-pet': 0 }
  },

  // Hay for Pocket Pets
  "timothy_hay": {
    protein: 7.0,
    fat: 2.0,
    calcium: 3500,
    phosphorus: 2200,
    fiber: 35.0,
    kcal: 245,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'avoid', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0, 'pocket-pet': 0.80 }
  },
  "alfalfa_hay": {
    protein: 15.0,
    fat: 2.5,
    calcium: 13000,
    phosphorus: 2200,
    fiber: 32.0,
    kcal: 213,
    source: "USDA estimate",
    speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'limit', reptile: 'avoid', 'pocket-pet': 'ok' },
    feedingRole: 'staple',
    maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0, 'pocket-pet': 0.50 }
  },

  // Additional Proteins
  "ground_pork_lean": { protein: 27.0, fat: 9.0, calcium: 10, phosphorus: 190, kcal: 242, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.30, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "turkey_giblets": { protein: 16.0, fat: 8.0, calcium: 12, phosphorus: 200, kcal: 160, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "chicken_giblets": { protein: 15.0, fat: 7.0, calcium: 10, phosphorus: 180, kcal: 150, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "ground_duck": { protein: 22.0, fat: 11.0, calcium: 12, phosphorus: 200, kcal: 210, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.30, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "turkey_thighs": { protein: 19.0, fat: 11.0, calcium: 12, phosphorus: 170, kcal: 190, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.50, cat: 0.40, bird: 0.10, reptile: 0.20, 'pocket-pet': 0 } },
  "chicken_necks": { protein: 14.0, fat: 8.0, calcium: 100, phosphorus: 150, kcal: 140, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "turkey_necks": { protein: 15.0, fat: 9.0, calcium: 120, phosphorus: 160, kcal: 160, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "ground_venison": { protein: 26.0, fat: 3.0, calcium: 10, phosphorus: 200, kcal: 155, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.50, cat: 0.40, bird: 0.10, reptile: 0.20, 'pocket-pet': 0 } },
  "ground_rabbit": { protein: 21.0, fat: 8.0, calcium: 18, phosphorus: 180, kcal: 170, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "duck_liver": { protein: 18.0, fat: 8.0, calcium: 10, phosphorus: 300, kcal: 150, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.10, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "quail_eggs": { protein: 13.0, fat: 11.0, calcium: 76, phosphorus: 226, kcal: 158, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.10, bird: 0.10, reptile: 0.10, 'pocket-pet': 0.05 } },
  "ground_quail": { protein: 25.0, fat: 11.0, calcium: 14, phosphorus: 220, kcal: 226, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.30, bird: 0.10, reptile: 0.30, 'pocket-pet': 0 } },
  "tuna": { protein: 25.5, fat: 1.0, calcium: 11, phosphorus: 208, kcal: 86, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "ground_mackerel": { protein: 20.0, fat: 13.0, omega3: 2.0, calcium: 280, phosphorus: 240, kcal: 200, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "ground_herring": { protein: 18.0, fat: 12.0, omega3: 1.8, calcium: 260, phosphorus: 220, kcal: 190, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.40, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },
  "turkey_hearts": { protein: 16.0, fat: 9.0, calcium: 8, phosphorus: 190, kcal: 155, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.15, bird: 0.05, reptile: 0.10, 'pocket-pet': 0 } },
  "quail_meat": { protein: 25.0, fat: 11.0, calcium: 14, phosphorus: 220, kcal: 226, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'ok', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.30, bird: 0.10, reptile: 0.30, 'pocket-pet': 0 } },
  "salmon_boneless": { protein: 20.4, fat: 13.4, omega3: 2.26, calcium: 12, phosphorus: 200, kcal: 208, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.40, cat: 0.50, bird: 0.10, reptile: 0.15, 'pocket-pet': 0 } },

  // Vegetables
  "brussels_sprouts": { protein: 3.4, fat: 0.4, calcium: 42, phosphorus: 66, vitaminC: 85.0, kcal: 43, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "parsley": { protein: 3.0, fat: 0.8, calcium: 138, phosphorus: 58, vitaminA: 8424, vitaminC: 133.0, kcal: 36, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "endive": { protein: 1.3, fat: 0.2, calcium: 36, phosphorus: 28, vitaminA: 1080, vitaminC: 6.5, kcal: 17, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "escarole": { protein: 1.3, fat: 0.2, calcium: 52, phosphorus: 28, vitaminA: 3360, vitaminC: 6.5, kcal: 15, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "beet_greens": { protein: 2.2, fat: 0.2, calcium: 117, phosphorus: 40, vitaminA: 6320, vitaminC: 30.0, kcal: 23, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "radish_greens": { protein: 2.4, fat: 0.2, calcium: 224, phosphorus: 61, vitaminA: 2560, vitaminC: 24.0, kcal: 32, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "napa_cabbage": { protein: 1.2, fat: 0.1, calcium: 23, phosphorus: 29, vitaminA: 68, vitaminC: 27.0, kcal: 13, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "red_cabbage": { protein: 1.4, fat: 0.2, calcium: 42, phosphorus: 30, vitaminA: 20, vitaminC: 57.0, kcal: 31, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "green_cabbage": { protein: 1.3, fat: 0.1, calcium: 40, phosphorus: 26, vitaminA: 3, vitaminC: 36.6, kcal: 25, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "romanesco_broccoli": { protein: 3.7, fat: 0.4, calcium: 54, phosphorus: 66, vitaminC: 110.0, kcal: 34, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "snow_peas": { protein: 3.4, fat: 0.2, calcium: 43, phosphorus: 48, vitaminC: 60.0, kcal: 42, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "sugar_snap_peas": { protein: 2.8, fat: 0.2, calcium: 42, phosphorus: 48, vitaminC: 60.0, kcal: 42, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "fennel": { protein: 1.2, fat: 0.2, calcium: 49, phosphorus: 50, vitaminC: 12.0, kcal: 31, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "leeks": { protein: 1.5, fat: 0.3, calcium: 59, phosphorus: 35, vitaminA: 1000, vitaminC: 12.0, kcal: 31, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "shallots": { protein: 1.7, fat: 0.1, calcium: 37, phosphorus: 60, vitaminC: 8.0, kcal: 72, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "artichokes": { protein: 3.3, fat: 0.2, calcium: 53, phosphorus: 90, vitaminC: 11.7, kcal: 47, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "eggplant": { protein: 1.1, fat: 0.2, calcium: 9, phosphorus: 25, vitaminC: 3.5, kcal: 25, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "tomatoes": { protein: 0.9, fat: 0.2, calcium: 12, phosphorus: 24, vitaminA: 833, vitaminC: 13.7, kcal: 18, source: "USDA estimate", speciesCompatibility: { dog: 'limit', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "yellow_squash": { protein: 1.2, fat: 0.4, calcium: 19, phosphorus: 38, vitaminA: 393, vitaminC: 20.0, kcal: 21, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "pattypan_squash": { protein: 1.1, fat: 0.3, calcium: 18, phosphorus: 35, vitaminA: 300, vitaminC: 18.0, kcal: 19, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "radicchio": { protein: 1.2, fat: 0.1, calcium: 36, phosphorus: 40, vitaminA: 100, vitaminC: 8.0, kcal: 23, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "frisee": { protein: 1.2, fat: 0.3, calcium: 100, phosphorus: 40, vitaminA: 3360, vitaminC: 8.0, kcal: 15, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "mache": { protein: 2.3, fat: 0.4, calcium: 38, phosphorus: 34, vitaminA: 4700, vitaminC: 8.0, kcal: 17, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "watercress": { protein: 2.3, fat: 0.1, calcium: 120, phosphorus: 60, vitaminA: 4740, vitaminC: 43.0, kcal: 11, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "purslane": { protein: 1.9, fat: 0.4, calcium: 65, phosphorus: 44, vitaminA: 2000, vitaminC: 21.0, kcal: 20, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },
  "cat_grass": { protein: 2.0, fat: 0.4, calcium: 50, phosphorus: 40, vitaminA: 1000, vitaminC: 10.0, kcal: 25, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.10, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "barley_grass": { protein: 2.0, fat: 0.4, calcium: 50, phosphorus: 40, vitaminA: 1000, vitaminC: 10.0, kcal: 25, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.10, bird: 0.10, reptile: 0.15, 'pocket-pet': 0.10 } },
  "alfalfa_sprouts": { protein: 2.1, fat: 0.2, calcium: 32, phosphorus: 70, vitaminA: 60, vitaminC: 8.4, kcal: 23, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.20, 'pocket-pet': 0.15 } },

  // Carbs
  "regular_potato": { protein: 2.0, fat: 0.1, calcium: 12, phosphorus: 57, kcal: 77, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "amaranth": { protein: 9.3, fat: 5.3, calcium: 159, phosphorus: 557, kcal: 371, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "buckwheat": { protein: 3.4, fat: 1.0, calcium: 18, phosphorus: 282, kcal: 343, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "sorghum": { protein: 3.3, fat: 3.3, calcium: 28, phosphorus: 287, kcal: 329, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "farro": { protein: 3.6, fat: 0.7, calcium: 21, phosphorus: 317, kcal: 335, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "bulgur": { protein: 3.3, fat: 0.4, calcium: 24, phosphorus: 260, kcal: 342, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "split_peas": { protein: 8.0, fat: 0.4, calcium: 27, phosphorus: 200, kcal: 118, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "kidney_beans": { protein: 8.7, fat: 0.5, calcium: 35, phosphorus: 140, kcal: 127, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "pinto_beans": { protein: 8.4, fat: 0.4, calcium: 44, phosphorus: 140, kcal: 122, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "navy_beans": { protein: 8.1, fat: 0.4, calcium: 60, phosphorus: 140, kcal: 127, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "spaghetti_squash": { protein: 0.8, fat: 0.4, calcium: 16, phosphorus: 20, kcal: 31, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.25, 'pocket-pet': 0.20 } },
  "delicata_squash": { protein: 1.1, fat: 0.1, calcium: 20, phosphorus: 30, kcal: 35, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.25, 'pocket-pet': 0.20 } },
  "kabocha_squash": { protein: 1.1, fat: 0.1, calcium: 21, phosphorus: 33, kcal: 34, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.10, bird: 0.15, reptile: 0.25, 'pocket-pet': 0.20 } },

  // Fruits
  "pineapple": { protein: 0.5, fat: 0.1, calcium: 13, phosphorus: 8, vitaminA: 35, vitaminC: 47.8, kcal: 50, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "kiwi": { protein: 1.1, fat: 0.5, calcium: 34, phosphorus: 34, vitaminA: 87, vitaminC: 92.7, kcal: 61, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "blackberry": { protein: 1.4, fat: 0.5, calcium: 29, phosphorus: 22, vitaminA: 12, vitaminC: 21.0, kcal: 43, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "cranberry": { protein: 0.4, fat: 0.1, calcium: 8, phosphorus: 13, vitaminA: 60, vitaminC: 13.3, kcal: 46, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "cherry": { protein: 1.1, fat: 0.3, calcium: 13, phosphorus: 21, vitaminA: 64, vitaminC: 7.0, kcal: 63, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "plum": { protein: 0.7, fat: 0.3, calcium: 6, phosphorus: 16, vitaminA: 345, vitaminC: 9.5, kcal: 46, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "apricot": { protein: 1.4, fat: 0.4, calcium: 13, phosphorus: 23, vitaminA: 1926, vitaminC: 3.6, kcal: 48, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "fig": { protein: 0.8, fat: 0.3, calcium: 35, phosphorus: 14, vitaminA: 7, vitaminC: 1.2, kcal: 74, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "date": { protein: 1.7, fat: 0.2, calcium: 66, phosphorus: 62, vitaminA: 15, vitaminC: 0.0, kcal: 282, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.10, 'pocket-pet': 0.05 } },
  "raisin": { protein: 3.1, fat: 0.5, calcium: 50, phosphorus: 101, vitaminA: 0, vitaminC: 2.3, kcal: 299, source: "USDA estimate", speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'ok', reptile: 'ok', 'pocket-pet': 'avoid' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.10, 'pocket-pet': 0 } },
  "currant": { protein: 1.4, fat: 0.3, calcium: 62, phosphorus: 38, vitaminA: 0, vitaminC: 181.0, kcal: 71, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "goji_berry": { protein: 14.3, fat: 1.5, calcium: 112, phosphorus: 100, vitaminA: 26822, vitaminC: 48.4, kcal: 349, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.10, 'pocket-pet': 0.05 } },
  "mulberry": { protein: 1.4, fat: 0.4, calcium: 39, phosphorus: 38, vitaminA: 25, vitaminC: 36.4, kcal: 43, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "cantaloupe": { protein: 0.8, fat: 0.2, calcium: 9, phosphorus: 12, vitaminA: 3382, vitaminC: 36.7, kcal: 34, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "honeydew": { protein: 0.8, fat: 0.1, calcium: 6, phosphorus: 11, vitaminA: 0, vitaminC: 36.7, kcal: 36, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },
  "grape": { protein: 0.7, fat: 0.2, calcium: 10, phosphorus: 20, vitaminA: 66, vitaminC: 3.2, kcal: 67, source: "USDA estimate", speciesCompatibility: { dog: 'avoid', cat: 'avoid', bird: 'ok', reptile: 'ok', 'pocket-pet': 'avoid' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0, cat: 0, bird: 0.10, reptile: 0.10, 'pocket-pet': 0 } },
  "prune": { protein: 2.2, fat: 0.4, calcium: 43, phosphorus: 69, vitaminA: 781, vitaminC: 0.6, kcal: 240, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.10, 'pocket-pet': 0.05 } },
  "elderberry": { protein: 0.7, fat: 0.5, calcium: 38, phosphorus: 56, vitaminA: 600, vitaminC: 36.0, kcal: 73, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'treat', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.15, reptile: 0.15, 'pocket-pet': 0.10 } },

  // Seeds & Nuts
  "sunflower_seeds": { protein: 20.0, fat: 51.5, calcium: 78, phosphorus: 660, kcal: 584, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.10 } },
  "pumpkin_seeds": { protein: 19.0, fat: 49.0, calcium: 55, phosphorus: 1144, kcal: 541, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.10 } },
  "sesame_seeds": { protein: 17.7, fat: 50.0, calcium: 975, phosphorus: 629, kcal: 565, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.10 } },
  "chia_seeds": { protein: 16.5, fat: 30.7, omega3: 17.8, calcium: 631, phosphorus: 860, kcal: 486, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.10 } },
  "walnut": { protein: 8.7, fat: 65.2, omega3: 9.1, calcium: 98, phosphorus: 346, kcal: 654, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "almond": { protein: 21.2, fat: 49.9, calcium: 264, phosphorus: 441, kcal: 579, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "brazil_nut": { protein: 14.3, fat: 66.4, calcium: 160, phosphorus: 725, kcal: 656, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "pecan": { protein: 9.2, fat: 71.9, calcium: 70, phosphorus: 277, kcal: 691, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "macadamia_nut": { protein: 7.9, fat: 75.8, calcium: 85, phosphorus: 188, kcal: 718, source: "USDA estimate", speciesCompatibility: { dog: 'avoid', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "hazelnut": { protein: 14.0, fat: 60.8, calcium: 114, phosphorus: 290, kcal: 628, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "pine_nut": { protein: 13.7, fat: 68.4, calcium: 16, phosphorus: 575, kcal: 673, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "cashew": { protein: 18.2, fat: 43.9, calcium: 37, phosphorus: 593, kcal: 553, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "pistachio": { protein: 20.3, fat: 45.4, calcium: 107, phosphorus: 490, kcal: 557, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "peanut": { protein: 25.8, fat: 49.2, calcium: 92, phosphorus: 376, kcal: 567, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.05, reptile: 0.02, 'pocket-pet': 0.05 } },
  "millet_seed": { protein: 3.7, fat: 1.3, calcium: 8, phosphorus: 285, kcal: 378, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.25, reptile: 0.10, 'pocket-pet': 0.15 } },
  "canary_seed": { protein: 15.5, fat: 5.0, calcium: 42, phosphorus: 440, kcal: 360, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.10, cat: 0.05, bird: 0.25, reptile: 0.10, 'pocket-pet': 0.10 } },
  "niger_seed": { protein: 19.3, fat: 68.0, calcium: 200, phosphorus: 600, kcal: 680, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.05 } },
  "oat_groats": { protein: 16.9, fat: 6.9, calcium: 54, phosphorus: 523, kcal: 379, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.25, cat: 0.10, bird: 0.20, reptile: 0.15, 'pocket-pet': 0.20 } },
  "rapeseed": { protein: 20.3, fat: 42.2, calcium: 240, phosphorus: 700, kcal: 495, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.10, reptile: 0.05, 'pocket-pet': 0.05 } },
  "safflower_seeds": { protein: 16.0, fat: 50.0, calcium: 111, phosphorus: 660, kcal: 541, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.10 } },
  "nyjer_seeds": { protein: 19.3, fat: 68.0, calcium: 200, phosphorus: 600, kcal: 680, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.02, bird: 0.15, reptile: 0.05, 'pocket-pet': 0.05 } },
  "poppy_seeds": { protein: 20.0, fat: 41.6, calcium: 1438, phosphorus: 870, kcal: 525, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.10, reptile: 0.05, 'pocket-pet': 0.05 } },
  "teff_seeds": { protein: 13.3, fat: 2.4, calcium: 180, phosphorus: 429, kcal: 367, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 } },
  "amaranth_seeds": { protein: 9.3, fat: 5.3, calcium: 159, phosphorus: 557, kcal: 371, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "buckwheat_hulled": { protein: 3.4, fat: 1.0, calcium: 18, phosphorus: 282, kcal: 343, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.15, cat: 0.05, bird: 0.15, reptile: 0.10, 'pocket-pet': 0.15 } },
  "barley_hulled": { protein: 3.6, fat: 0.7, calcium: 33, phosphorus: 264, kcal: 354, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.25, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 } },
  "wheat_hulled": { protein: 10.0, fat: 2.0, calcium: 30, phosphorus: 288, kcal: 340, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 } },
  "rice_hulled": { protein: 2.7, fat: 0.3, calcium: 3, phosphorus: 8, kcal: 130, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.30, cat: 0.10, bird: 0.25, reptile: 0.15, 'pocket-pet': 0.20 } },
  "corn_cracked": { protein: 3.3, fat: 1.2, calcium: 2, phosphorus: 89, kcal: 86, source: "USDA estimate", speciesCompatibility: { dog: 'ok', cat: 'limit', bird: 'ok', reptile: 'limit', 'pocket-pet': 'ok' }, feedingRole: 'staple', maxInclusionPercentBySpecies: { dog: 0.20, cat: 0.05, bird: 0.20, reptile: 0.10, 'pocket-pet': 0.15 } },

  // Oils & Fats
  "avocado_oil": { protein: 0, fat: 100, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "sunflower_oil": { protein: 0, fat: 100, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "sesame_oil": { protein: 0, fat: 100, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "pumpkin_seed_oil": { protein: 0, fat: 100, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "walnut_oil": { protein: 0, fat: 100, omega3: 10.4, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "almond_oil": { protein: 0, fat: 100, kcal: 884, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "cod_liver_oil": { protein: 0, fat: 100, omega3: 18.0, kcal: 902, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "herring_oil": { protein: 0, fat: 100, omega3: 20.0, kcal: 902, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "mackerel_oil": { protein: 0, fat: 100, omega3: 20.0, kcal: 902, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "sardine_oil": { protein: 0, fat: 100, omega3: 20.0, kcal: 902, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  "anchovy_oil": { protein: 0, fat: 100, omega3: 20.0, kcal: 902, source: "Supplement standard", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.05, cat: 0.05, bird: 0.02, reptile: 0.02, 'pocket-pet': 0 } },
  // Calcium supplements (Phase 2 fix: enable Ca:P balancing)
  "eggshell_powder": { protein: 0, fat: 0, calcium: 3800, phosphorus: 20, kcal: 0, source: "Natural supplement", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.02, cat: 0.02, bird: 0.02, reptile: 0.02, 'pocket-pet': 0.02 }, confidenceBySpecies: { dog: 'high', cat: 'high', bird: 'high', reptile: 'high', 'pocket-pet': 'high' } },
  "bone_meal": { protein: 15, fat: 0, calcium: 3000, phosphorus: 1400, kcal: 60, source: "Natural supplement", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'ok', 'pocket-pet': 'limit' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.03, cat: 0.02, bird: 0.01, reptile: 0.02, 'pocket-pet': 0.01 }, confidenceBySpecies: { dog: 'high', cat: 'high', bird: 'medium', reptile: 'high', 'pocket-pet': 'medium' } },
  "calcium_carbonate": { protein: 0, fat: 0, calcium: 4000, phosphorus: 0, kcal: 0, source: "Mineral supplement", speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' }, feedingRole: 'supplement', maxInclusionPercentBySpecies: { dog: 0.02, cat: 0.02, bird: 0.02, reptile: 0.02, 'pocket-pet': 0.02 }, confidenceBySpecies: { dog: 'high', cat: 'high', bird: 'high', reptile: 'high', 'pocket-pet': 'high' } }
};

/**
 * Get nutritional composition for an ingredient
 * @param ingredientName - The ingredient name (normalized)
 * @returns IngredientComposition or undefined if not found
 */

export function getIngredientComposition(ingredientName: string): IngredientComposition | undefined {
  // Normalize the name for lookup
  const normalized = ingredientName.toLowerCase().trim()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');

  return INGREDIENT_COMPOSITIONS[normalized];
}

/**
 * Calculate calcium to phosphorus ratio
 * @param calcium - calcium amount
 * @param phosphorus - phosphorus amount
 * @returns Ca:P ratio or undefined if phosphorus is 0
 */
export function calculateCaPRatio(calcium: number, phosphorus: number): number | undefined {
  return phosphorus > 0 ? calcium / phosphorus : undefined;
}
</file>

<file path="lib/data/ingredients.ts">
/**
 * UNIFIED INGREDIENTS LAYER
 * Re-exports from unifiedIngredientRegistry.ts which consolidates all 300+ ingredients
 * from: ingredientCompositions, allIngredients, vetted-products, vetted-species-map
 */

import {
  getAllIngredients,
  getIngredientsForSpecies as getUnifiedIngredientsForSpecies,
  type UnifiedIngredient,
  type Species as RegistrySpecies,
  type IngredientCategory as RegistryCategory,
} from './unifiedIngredientRegistry';
import { getMicronutrients } from './micronutrientDefaults';

export type Species = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
export type IngredientCategory = 'protein' | 'carb' | 'grain' | 'vegetable' | 'fruit' | 'fat' | 'supplement' | 'seed' | 'nut' | 'insect' | 'hay' | 'pellet';
export type CompatibilityLevel = 'ok' | 'limit' | 'avoid' | 'caution';

export interface Ingredient {
  id: string;
  name: string;
  category: IngredientCategory;
  
  // Protein hierarchy (only for proteins)
  proteinRole?: 'primary' | 'secondary';  // PHASE 1.7: Explicit protein role
  
  // Nutritional data (per 100g)
  composition: {
    protein?: number;
    fat?: number;
    carbs?: number;
    fiber?: number;
    calcium?: number;
    phosphorus?: number;
    kcal?: number;
    vitaminA?: number;
    vitaminC?: number;
    omega3?: number;
    taurine?: number;
    moisture?: number;
    CaP_ratio?: number;
    copper_mg_per_100g?: number;  // PHASE 2: Micronutrient toxicity
    iodine_mcg_per_100g?: number; // PHASE 2: Micronutrient toxicity
  };
  
  // Species compatibility
  compatibility: Record<Species, CompatibilityLevel>;
  
  // Feeding guidelines
  feedingRole: 'staple' | 'secondary' | 'supplement' | 'treat' | 'forage';
  maxInclusionPercent: Record<Species, number>;
  
  // Cost & quality
  pricePerLb?: number;
  qualityScore: number; // 1-10
  
  // Metadata
  source?: string;
}

/**
 * Convert UnifiedIngredient to our Ingredient format
 */
function convertUnifiedToIngredient(unified: UnifiedIngredient): Ingredient {
  // Map registry species to our species format
  const speciesMap: Record<RegistrySpecies, Species> = {
    dog: 'dogs',
    cat: 'cats',
    bird: 'birds',
    reptile: 'reptiles',
    'pocket-pet': 'pocket-pets',
  };

  // Map compatibility
  const compatibility: Record<Species, CompatibilityLevel> = {
    dogs: (unified.speciesCompatibility.dog as CompatibilityLevel) || 'ok',
    cats: (unified.speciesCompatibility.cat as CompatibilityLevel) || 'ok',
    birds: (unified.speciesCompatibility.bird as CompatibilityLevel) || 'ok',
    reptiles: (unified.speciesCompatibility.reptile as CompatibilityLevel) || 'ok',
    'pocket-pets': (unified.speciesCompatibility['pocket-pet'] as CompatibilityLevel) || 'ok',
  };

  // Map max inclusion (default to 0.3 if not specified)
  const maxInclusionPercent: Record<Species, number> = {
    dogs: 0.3,
    cats: 0.3,
    birds: 0.3,
    reptiles: 0.3,
    'pocket-pets': 0.3,
  };

  // Get nutrition data first
  const nutrition = unified.nutrition;

  // Infer category
  let category: IngredientCategory = 'supplement';
  const regCategory = unified.category as string;
  
  if (regCategory === 'protein') category = 'protein';
  else if (regCategory === 'grain') category = 'carb';  // Map 'grain' from registry to 'carb'
  else if (regCategory === 'vegetable') category = 'vegetable';
  else if (regCategory === 'fruit') category = 'fruit';
  else if (regCategory === 'fat') category = 'fat';
  else if (regCategory === 'seed') category = 'seed';
  else if (regCategory === 'nut') category = 'nut';
  else if (regCategory === 'insect') category = 'insect';
  else if (regCategory === 'hay') category = 'hay';
  else if (regCategory === 'pellet') category = 'pellet';
  else if (regCategory === 'supplement') category = 'supplement';

  // PHASE 1.7: Get proteinRole directly from composition data
  let proteinRole: 'primary' | 'secondary' | undefined;
  if (category === 'protein') {
    // Read proteinRole directly from the composition object
    proteinRole = (nutrition as any).proteinRole;
    // PHASE 2.4: Default to 'secondary' if not explicitly set
    if (!proteinRole) {
      proteinRole = 'secondary';
    }
  }

  // PHASE 2: Get micronutrient defaults (copper, iodine)
  const micronutrients = getMicronutrients(unified.primaryDisplayName, (nutrition as any).feedingRole);

  // Estimate quality score (1-10)
  let qualityScore = 5;
  if (nutrition.protein && nutrition.protein > 20) qualityScore += 2;
  if (nutrition.omega3 && nutrition.omega3 > 0.5) qualityScore += 1;
  if (nutrition.fiber && nutrition.fiber > 3) qualityScore += 1;
  if (nutrition.calcium && nutrition.phosphorus) {
    const ratio = nutrition.calcium / nutrition.phosphorus;
    if (ratio >= 1.0 && ratio <= 2.0) qualityScore += 1;
  }
  qualityScore = Math.min(10, Math.max(1, qualityScore));

  return {
    id: unified.id,
    name: unified.primaryDisplayName,
    category,
    proteinRole,  // PHASE 1.7: Explicit protein role
    composition: {
      protein: nutrition.protein,
      fat: nutrition.fat,
      carbs: nutrition.carbs,
      fiber: nutrition.fiber,
      calcium: nutrition.calcium,
      phosphorus: nutrition.phosphorus,
      kcal: nutrition.kcal,
      vitaminA: nutrition.vitaminA,
      vitaminC: nutrition.vitaminC,
      omega3: nutrition.omega3,
      taurine: nutrition.taurine,
      moisture: nutrition.moisture,
      CaP_ratio: nutrition.CaP_ratio,
      copper_mg_per_100g: (nutrition as any).copper_mg_per_100g || micronutrients.copper_mg_per_100g,
      iodine_mcg_per_100g: (nutrition as any).iodine_mcg_per_100g || micronutrients.iodine_mcg_per_100g,
    },
    compatibility,
    feedingRole: (nutrition.feedingRole as any) || 'staple',
    maxInclusionPercent,
    qualityScore,
    source: nutrition.source,
  };
}

/**
 * UNIFIED INGREDIENTS DATABASE
 * Converts all UnifiedIngredients (300+) to our format
 */
export const INGREDIENTS: Record<string, Ingredient> = (() => {
  const result: Record<string, Ingredient> = {};
  
  const allUnified = getAllIngredients();
  for (const unified of allUnified) {
    try {
      result[unified.id] = convertUnifiedToIngredient(unified);
    } catch (error) {
      console.warn(`Failed to convert ingredient ${unified.id}:`, error);
    }
  }
  
  return result;
})();

/**
 * Get all ingredients for a specific species
 * CRITICAL FIX: Species-specific category filtering
 */
export function getIngredientsForSpecies(species: Species): Ingredient[] {
  return Object.values(INGREDIENTS).filter(ing => {
    // Filter by species compatibility
    if (ing.compatibility[species] === 'avoid') return false;
    
    // Species-specific category filtering
    if (species === 'birds') {
      // Birds need: seeds, nuts, fruits, veggies (NOT mammalian proteins)
      if (ing.category === 'protein') {
        // Allow eggs only
        return ing.name.toLowerCase().includes('egg');
      }
      return ['seed', 'nut', 'fruit', 'vegetable', 'supplement'].includes(ing.category);
    }
    
    if (species === 'reptiles') {
      // Reptiles need: insects, veggies, fruits (NO grains/carbs)
      if (ing.category === 'carb') {
        return false; // No grains for reptiles
      }
      return ['insect', 'protein', 'vegetable', 'fruit', 'supplement'].includes(ing.category);
    }
    
    if (species === 'pocket-pets') {
      // Pocket-pets need: hay, veggies, fruits, seeds (NO meat proteins except eggs/insects)
      if (ing.category === 'protein') {
        const name = ing.name.toLowerCase();
        return name.includes('egg') || name.includes('mealworm');
      }
      return ['hay', 'vegetable', 'fruit', 'seed', 'supplement'].includes(ing.category);
    }
    
    // Dogs and cats: accept all categories
    return true;
  });
}

/**
 * Get ingredients by category
 */
export function getIngredientsByCategory(category: IngredientCategory): Ingredient[] {
  return Object.values(INGREDIENTS).filter(ing => ing.category === category);
}

/**
 * Get ingredient by ID
 */
export function getIngredient(id: string): Ingredient | undefined {
  return INGREDIENTS[id];
}

/**
 * Get ingredient by name (case-insensitive)
 */
export function getIngredientByName(name: string): Ingredient | undefined {
  const normalized = name.toLowerCase().trim();
  return Object.values(INGREDIENTS).find(ing => ing.name.toLowerCase() === normalized);
}

/**
 * Get total ingredient count
 */
export function getIngredientCount(): number {
  return Object.keys(INGREDIENTS).length;
}
</file>

<file path="lib/data/ingredientTiers.ts">
// lib/data/ingredientTiers.ts
// Ingredient quality classification for scoring differentiation

export type IngredientTier = 'premium' | 'standard' | 'basic';

/**
 * Premium ingredients: High-quality, fresh, whole foods
 */
export const PREMIUM_INGREDIENTS: string[] = [
  // Premium proteins
  'fresh-salmon', 'wild-caught-fish', 'organic-chicken', 'grass-fed-beef',
  'quail-eggs', 'duck', 'turkey-breast', 'lamb', 'venison', 'bison',
  'goat-milk', 'fresh-eggs', 'whole-fish',
  
  // Premium vegetables/fruits
  'blueberries', 'kale', 'spinach', 'broccoli', 'pumpkin-seeds',
  'sweet-potato', 'carrots', 'green-beans', 'peas', 'asparagus',
  'cranberries', 'apples', 'bananas',
  
  // Premium supplements
  'fish-oil', 'coconut-oil', 'flaxseed', 'chia-seeds',
];

/**
 * Basic/processed ingredients: Lower quality, processed, byproducts
 */
export const BASIC_INGREDIENTS: string[] = [
  // Processed proteins
  'chicken-byproduct', 'meal', 'byproduct-meal', 'animal-fat',
  'meat-meal', 'poultry-byproduct', 'rendered-fat',
  
  // Processed grains/fillers
  'corn-gluten-meal', 'wheat-gluten', 'soybean-meal', 'brewers-rice',
  'corn-syrup', 'artificial-flavors', 'preservatives',
  
  // Low-quality fillers
  'cellulose', 'glycerin', 'carrageenan', 'xanthan-gum',
];

/**
 * Classify an ingredient into a tier
 */
export function classifyIngredientTier(ingredientName: string): IngredientTier {
  const normalized = ingredientName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  
  // Check if premium
  if (PREMIUM_INGREDIENTS.some(premium => 
    normalized.includes(premium) || premium.includes(normalized)
  )) {
    return 'premium';
  }
  
  // Check if basic/processed
  if (BASIC_INGREDIENTS.some(basic => 
    normalized.includes(basic) || basic.includes(normalized)
  )) {
    return 'basic';
  }
  
  // Default to standard
  return 'standard';
}

/**
 * Check if ingredient is fresh (not dried/powdered/processed)
 */
export function isFreshIngredient(ingredientName: string): boolean {
  const normalized = ingredientName.toLowerCase();
  const processedIndicators = ['dried', 'powder', 'meal', 'flour', 'canned', 'processed', 'dehydrated'];
  return !processedIndicators.some(indicator => normalized.includes(indicator));
}

/**
 * Calculate ingredient quality score for a recipe
 */
export function calculateIngredientQualityScore(ingredients: Array<{ name: string } | string>): {
  score: number;
  premiumCount: number;
  basicCount: number;
  freshRatio: number;
} {
  let premiumCount = 0;
  let basicCount = 0;
  let freshCount = 0;
  const totalIngredients = ingredients.length;
  
  if (totalIngredients === 0) {
    return { score: 50, premiumCount: 0, basicCount: 0, freshRatio: 0 };
  }
  
  ingredients.forEach(ing => {
    const name = typeof ing === 'string' ? ing : ing.name;
    const tier = classifyIngredientTier(name);
    
    if (tier === 'premium') premiumCount++;
    else if (tier === 'basic') basicCount++;
    
    if (isFreshIngredient(name)) freshCount++;
  });
  
  const premiumRatio = premiumCount / totalIngredients;
  const basicRatio = basicCount / totalIngredients;
  const freshRatio = freshCount / totalIngredients;
  
  // Calculate score (base 50, bonuses/penalties)
  let score = 50;
  
  // Premium ingredient bonus
  if (premiumRatio > 0.5) score += 20;
  else if (premiumRatio > 0.3) score += 10;
  else if (premiumRatio > 0.1) score += 5;
  
  // Basic ingredient penalty
  if (basicRatio > 0.3) score -= 15;
  else if (basicRatio > 0.2) score -= 10;
  else if (basicRatio > 0.1) score -= 5;
  
  // Fresh ingredient bonus
  if (freshRatio > 0.5) score += 2;
  
  return {
    score: Math.max(0, Math.min(100, Math.round(score))),
    premiumCount,
    basicCount,
    freshRatio,
  };
}
</file>

<file path="lib/data/micronutrientDefaults.ts">
// lib/data/micronutrientDefaults.ts
// PHASE 2: Class-based defaults for copper and iodine
// Conservative estimates for micronutrient toxicity prevention
// Principle: Overestimate for safety, measured values override

export interface MicronutrientDefaults {
  copper_mg_per_100g: number;
  iodine_mcg_per_100g: number;
  micronutrientConfidence: 'measured' | 'estimated' | 'assumed_high' | 'assumed_low';
}

// Ingredient class detection
type IngredientClass = 
  | 'liver'
  | 'organ_meat'
  | 'shellfish'
  | 'seeds'
  | 'whole_grains'
  | 'muscle_meat'
  | 'fish'
  | 'vegetables'
  | 'fruits'
  | 'oils_fats'
  | 'supplements'
  | 'dairy'
  | 'eggs'
  | 'seaweed';

function detectIngredientClass(name: string, feedingRole?: string): IngredientClass {
  const lower = name.toLowerCase();

  // Liver (highest copper)
  if (lower.includes('liver')) return 'liver';

  // Other organs
  if (lower.match(/\b(kidney|heart|brain|tongue|tripe)\b/)) return 'organ_meat';

  // Shellfish (high copper + iodine)
  if (lower.match(/\b(oyster|clam|mussel|shrimp|crab|lobster)\b/)) return 'shellfish';

  // Seeds (high copper)
  if (lower.match(/\b(pumpkin|sunflower|sesame|flax|chia|hemp)\b/)) return 'seeds';

  // Whole grains
  if (lower.match(/\b(oat|barley|quinoa|millet|amaranth|buckwheat|teff)\b/)) return 'whole_grains';

  // Muscle meat (land animals)
  if (lower.match(/\b(chicken|turkey|beef|lamb|pork|duck|venison|rabbit|quail)\b/) && !lower.includes('liver')) {
    return 'muscle_meat';
  }

  // Fish (non-shellfish)
  if (lower.match(/\b(salmon|cod|mackerel|sardine|herring|tuna|trout|halibut|anchovy)\b/)) return 'fish';

  // Seaweed / kelp (very high iodine)
  if (lower.match(/\b(kelp|seaweed|nori|dulse|kombu)\b/)) return 'seaweed';

  // Eggs
  if (lower.match(/\b(egg)\b/)) return 'eggs';

  // Dairy
  if (lower.match(/\b(milk|cheese|yogurt|cottage|whey)\b/)) return 'dairy';

  // Vegetables
  if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|squash|green|collard|mustard|turnip|dandelion|arugula|endive|escarole|bok|cabbage|celery|asparagus|fennel|parsley|zucchini|cucumber|eggplant|leek|shallot|radicchio|frisee|mache|watercress|purslane|swiss|chard|beet|pumpkin)\b/)) {
    return 'vegetables';
  }

  // Fruits
  if (lower.match(/\b(apple|berry|mango|papaya|banana|fruit|grape|melon|cantaloupe|honeydew|watermelon|pineapple|kiwi|raspberry|blackberry|cranberry|cherry|pear|peach|plum|apricot|fig|date|raisin|currant|goji|mulberry|elderberry|strawberry|blueberry)\b/)) {
    return 'fruits';
  }

  // Oils / fats
  if (lower.match(/\b(oil|fat|butter|lard|ghee|tallow)\b/)) return 'oils_fats';

  // Supplements (eggshell powder, calcium carbonate, etc.)
  if (lower.match(/\b(powder|supplement|premix|vitamin|mineral|calcium|phosphorus|eggshell)\b/)) {
    return 'supplements';
  }

  return 'vegetables'; // Safe default
}

// Class-based defaults (conservative, biased toward safety)
const COPPER_DEFAULTS: Record<IngredientClass, number> = {
  liver: 5.0,           // measured-ish: highest copper source
  organ_meat: 2.0,      // estimated: kidneys, hearts have moderate copper
  shellfish: 3.0,       // estimated: oysters, clams high in copper
  seeds: 1.5,           // estimated: pumpkin/sunflower seeds
  whole_grains: 0.4,    // assumed_high: conservative for grains
  muscle_meat: 0.1,     // assumed_high: very low in muscle meat
  fish: 0.1,            // assumed_high: low in fish
  vegetables: 0.05,     // assumed_high: low in vegetables
  fruits: 0.03,         // assumed_high: very low in fruits
  oils_fats: 0.0,       // assumed_low: no copper in pure fats
  supplements: 0.0,     // measured: eggshell, calcium carbonate have no copper
  dairy: 0.02,          // assumed_high: low in dairy
  eggs: 0.08,           // assumed_high: moderate in eggs
  seaweed: 0.5,         // estimated: kelp has moderate copper
};

const IODINE_DEFAULTS: Record<IngredientClass, number> = {
  seaweed: 500,         // PHASE 2: Conservative for recipe context (kelp is high but dangerous)
  shellfish: 25,        // PHASE 2: Conservative estimate for recipe
  fish: 20,             // PHASE 2: Conservative estimate for recipe (marine fish moderate iodine)
  dairy: 10,            // PHASE 2: Conservative estimate for recipe
  eggs: 8,              // PHASE 2: Conservative estimate for recipe
  muscle_meat: 2,       // assumed_high: land animal meat low iodine
  vegetables: 1,        // assumed_high: depends on soil iodine
  whole_grains: 1.5,    // assumed_high: depends on soil iodine
  fruits: 0.5,          // assumed_high: low iodine
  organ_meat: 3,        // estimated: organs have more iodine than muscle
  liver: 4,             // estimated: liver accumulates iodine
  seeds: 0.3,           // assumed_high: seeds low in iodine
  oils_fats: 0,         // assumed_low: no iodine in pure fats
  supplements: 0,       // measured: non-iodized supplements
};

export function getMicronutrientDefaults(ingredientName: string, feedingRole?: string): MicronutrientDefaults {
  const ingredientClass = detectIngredientClass(ingredientName, feedingRole);

  return {
    copper_mg_per_100g: COPPER_DEFAULTS[ingredientClass],
    iodine_mcg_per_100g: IODINE_DEFAULTS[ingredientClass],
    micronutrientConfidence: 'estimated', // Default confidence for class-based values
  };
}

// Measured overrides (high-priority ingredients with actual data)
export const MEASURED_MICRONUTRIENTS: Record<string, MicronutrientDefaults> = {
  // Liver (USDA FDC data)
  'beef_liver': {
    copper_mg_per_100g: 4.6,
    iodine_mcg_per_100g: 8,
    micronutrientConfidence: 'measured',
  },
  'chicken_liver': {
    copper_mg_per_100g: 5.4,
    iodine_mcg_per_100g: 11,
    micronutrientConfidence: 'measured',
  },
  'lamb_liver': {
    copper_mg_per_100g: 4.8,
    iodine_mcg_per_100g: 9,
    micronutrientConfidence: 'measured',
  },
  'turkey_liver': {
    copper_mg_per_100g: 5.2,
    iodine_mcg_per_100g: 10,
    micronutrientConfidence: 'measured',
  },

  // Fish (USDA FDC data)
  'salmon_atlantic': {
    copper_mg_per_100g: 0.12,
    iodine_mcg_per_100g: 80,
    micronutrientConfidence: 'measured',
  },
  'cod_atlantic': {
    copper_mg_per_100g: 0.08,
    iodine_mcg_per_100g: 130,
    micronutrientConfidence: 'measured',
  },
  'mackerel_atlantic': {
    copper_mg_per_100g: 0.11,
    iodine_mcg_per_100g: 100,
    micronutrientConfidence: 'measured',
  },
  'sardines_water': {
    copper_mg_per_100g: 0.13,
    iodine_mcg_per_100g: 120,
    micronutrientConfidence: 'measured',
  },
  'herring_canned': {
    copper_mg_per_100g: 0.10,
    iodine_mcg_per_100g: 110,
    micronutrientConfidence: 'estimated',
  },
  'tuna_canned': {
    copper_mg_per_100g: 0.09,
    iodine_mcg_per_100g: 65,
    micronutrientConfidence: 'estimated',
  },

  // Seeds (USDA FDC data)
  'pumpkin_seed': {
    copper_mg_per_100g: 1.7,
    iodine_mcg_per_100g: 3,
    micronutrientConfidence: 'measured',
  },
  'sunflower_seed': {
    copper_mg_per_100g: 1.8,
    iodine_mcg_per_100g: 2,
    micronutrientConfidence: 'measured',
  },

  // Seaweed (USDA FDC data)
  'kelp': {
    copper_mg_per_100g: 0.6,
    iodine_mcg_per_100g: 2000, // ‚ö†Ô∏è VERY HIGH - conservative estimate
    micronutrientConfidence: 'measured',
  },

  // Eggs (USDA FDC data)
  'egg': {
    copper_mg_per_100g: 0.08,
    iodine_mcg_per_100g: 26,
    micronutrientConfidence: 'measured',
  },
};

export function getMicronutrients(ingredientName: string, feedingRole?: string): MicronutrientDefaults {
  const normalized = ingredientName.toLowerCase().replace(/\s+/g, '_');

  // Check for measured override first
  if (MEASURED_MICRONUTRIENTS[normalized]) {
    return MEASURED_MICRONUTRIENTS[normalized];
  }

  // Fall back to class-based defaults
  return getMicronutrientDefaults(ingredientName, feedingRole);
}
</file>

<file path="lib/data/nutrition-cat-modifiers.ts">
export const catModifiers = {
  kidney_support: {
    add: [
      {
        name: "Omega-3 Fish Oil (EPA/DHA)",
        benefit:
          "Reduces kidney inflammation and slows progression of CKD",
        amazon: "https://www.amazon.com/Zesty-Paws-Omega-Salmon-Supplement/dp/B07P8Z8Z8Z"
      },
      {
        name: "Low-Phosphorus Protein Sources (Rabbit, Egg Whites)",
        benefit:
          "Low renal load improves longevity in kidney disease cats",
        amazon: "https://www.amazon.com/Stella-Schmitt-Freeze-Dried-Rabbit/dp/B08L9Q8Z8Z"
      },
      {
        name: "Hydration Enhancers (Bone Broth)",
        benefit:
          "Improves urine dilution and reduces toxin buildup",
        amazon: "https://www.amazon.com/Open-Farm-Chicken-Free-Surface/dp/B08L9Q8Z8Z"
      }
    ],
    avoid: [
      "High-phosphorus organ meats (liver, kidney)",
      "High-sodium ingredients",
      "Dehydrating kibble-only meals"
    ],
    scoreBoost: 25
  },

  urinary_health: {
    add: [
      {
        name: "DL-Methionine",
        benefit:
          "Maintains acidic urine pH to prevent struvite crystals",
        amazon: "https://www.amazon.com/Vetoquinol-Enzymatic-Tablets-Count-Pack/dp/B004Y4Z4Z4"
      },
      {
        name: "Cranberry Extract (D-Mannose)",
        benefit:
          "Prevents bacterial adhesion and UTIs",
        amazon: "https://www.amazon.com/Nutramax-Cosequin-Cranberry-Supplement-Capsules/dp/B07P8Z8Z8Z"
      },
      {
        name: "Wet Food / Hydration Boosters",
        benefit: "Flushes bladder and prevents stone formation",
        amazon: "https://www.amazon.com/Royal-Canin-Veterinary-Diet-Feline/dp/B004Y4Z4Z4"
      }
    ],
    avoid: [
      "High-magnesium ingredients (peas, legumes)",
      "Dehydrating kibble-only diets",
      "Over-supplemented fish meals"
    ],
    scoreBoost: 20
  },

  diabetes: {
    add: [
      {
        name: "High-Protein, Low-Carb Meat Sources",
        benefit:
          "Stabilizes insulin response and reduces glucose spikes",
        amazon: "https://www.amazon.com/Royal-Canin-Veterinary-Diet-Glycemic/dp/B004Y4Z4Z4"
      },
      {
        name: "Fiber (Pumpkin, Psyllium)",
        benefit:
          "Improves glycemic control and stool regularity",
        amazon: "https://www.amazon.com/Zesty-Paws-Probiotic-Prebiotic-Supplement/dp/B07P8Z8Z8Z"
      }
    ],
    avoid: [
      "Any carbs > 10% dry matter",
      "Sugars, syrups, sweet potatoes",
      "Grain fillers (corn, rice, wheat)"
    ],
    scoreBoost: 15
  },

  allergies: {
    add: [
      {
        name: "Novel Proteins (Duck, Venison)",
        benefit:
          "Reduces skin flare-ups from food allergies",
        amazon: "https://www.amazon.com/Stella-Schmitt-Freeze-Dried-Duck/dp/B08L9Q8Z8Z"
      }
    ],
    avoid: ["Chicken", "Beef", "Fish"],
    scoreBoost: 10
  },

  hairball: {
    add: [
      {
        name: "Hairball Control Supplements",
        benefit: "Helps cats pass hairballs naturally",
        amazon: "https://www.amazon.com/Hartz-Hairball-Control-Tablets-Count/dp/B004Y4Z4Z4"
      },
      {
        name: "Psyllium Husk Fiber",
        benefit: "Promotes healthy digestion and hair passage",
        amazon: "https://www.amazon.com/Zesty-Paws-Probiotic-Prebiotic-Supplement/dp/B07P8Z8Z8Z"
      }
    ],
    avoid: [
      "Excessive fiber that causes diarrhea",
      "Low-quality fillers"
    ],
    scoreBoost: 12
  },

  joint_health: {
    add: [
      {
        name: "Glucosamine for Cats",
        benefit: "Supports joint health and mobility",
        amazon: "https://www.amazon.com/s?k=glucosamine+for+cats"
      },
      {
        name: "Omega-3 Fatty Acids",
        benefit: "Reduces joint inflammation",
        amazon: "https://www.amazon.com/s?k=omega+3+for+cats"
      }
    ],
    avoid: [
      "Excessive calcium supplements",
      "Over-supplementation"
    ],
    scoreBoost: 15
  }
};
</file>

<file path="lib/data/nutrition-dog-modifiers.ts">
export const dogModifiers = {
  allergies: {
    add: [
      {
        name: "Novel Proteins (Duck, Venison, Lamb)",
        benefit: "Lower antigen exposure reduces allergy flare-ups",
        amazon: "https://www.amazon.com/s?k=duck+dog+food"
      },
      {
        name: "Omega-3 Fish Oil",
        benefit: "Improves skin barrier function, reduces itching",
        amazon: "https://www.amazon.com/s?k=omega+3+fish+oil+for+dogs"
      }
    ],
    avoid: [
      "Chicken",
      "Dairy",
      "Wheat",
      "Soy",
      "Artificial colors"
    ],
    scoreBoost: 25 // % buff to recipe rating if supportive
  },

  gi_issues: {
    add: [
      {
        name: "Pumpkin Pur√©e",
        benefit: "Soluble fiber stabilizes digestion",
        amazon: "https://www.amazon.com/s?k=pumpkin+puree+for+dogs"
      },
      {
        name: "Probiotic Supplement",
        benefit: "Restores healthy gut microbiome",
        amazon: "https://www.amazon.com/s?k=probiotic+supplement+for+dogs"
      },
      {
        name: "White Rice",
        benefit: "Highly digestible carbohydrate source",
        amazon: "https://www.amazon.com/s?k=white+rice+for+dogs"
      }
    ],
    avoid: [
      "High-fat meats",
      "Spicy ingredients",
      "Excess vegetables causing gas (broccoli, cauliflower)"
    ],
    scoreBoost: 20
  },

  joint_issues: {
    add: [
      {
        name: "Green Lipped Mussel",
        benefit: "Chondroprotective + anti-inflammatory",
        amazon: "https://www.amazon.com/s?k=green+lipped+mussel+supplement+for+dogs"
      },
      {
        name: "Glucosamine & Chondroitin",
        benefit: "Slows cartilage breakdown",
        amazon: "https://www.amazon.com/s?k=glucosamine+chondroitin+for+dogs"
      },
      {
        name: "Turmeric (Curcumin)",
        benefit: "Supports reduced inflammation",
        amazon: "https://www.amazon.com/s?k=turmeric+curcumin+for+dogs"
      }
    ],
    avoid: [
      "Calorie-dense starchy fillers",
      "Excess phosphorus (cheap organ meat overload)"
    ],
    scoreBoost: 15
  },

  weight_management: {
    add: [
      {
        name: "Lean Protein",
        benefit: "Preserves muscle while reducing calories",
        amazon: "https://www.amazon.com/s?k=lean+protein+dog+food"
      },
      {
        name: "Low-cal Veggies (Zucchini, Green Beans)",
        benefit: "Satiety without calorie load",
        amazon: "https://www.amazon.com/s?k=zucchini+for+dogs"
      }
    ],
    avoid: [
      "Added fats",
      "Cheese",
      "Peanut butter",
      "High-carb kibble mixers"
    ],
    scoreBoost: 10
  },

  kidney_support: {
    add: [
      {
        name: "Low-Phosphorus Dog Food",
        benefit: "Reduces kidney workload",
        amazon: "https://www.amazon.com/s?k=low+phosphorus+dog+food"
      },
      {
        name: "Omega-3 Fish Oil",
        benefit: "Reduces kidney inflammation",
        amazon: "https://www.amazon.com/s?k=omega+3+fish+oil+for+dogs"
      }
    ],
    avoid: [
      "High-phosphorus ingredients",
      "Excess protein",
      "Dehydrating kibble"
    ],
    scoreBoost: 20
  },

  skin_coat: {
    add: [
      {
        name: "Omega-3 Fatty Acids",
        benefit: "Improves skin health and coat quality",
        amazon: "https://www.amazon.com/s?k=omega+3+supplement+for+dogs"
      },
      {
        name: "Biotin Supplement",
        benefit: "Strengthens skin and fur",
        amazon: "https://www.amazon.com/s?k=biotin+for+dogs"
      }
    ],
    avoid: [
      "Excessive grains",
      "Artificial preservatives"
    ],
    scoreBoost: 12
  },

  dental: {
    add: [
      {
        name: "Dental Chews",
        benefit: "Helps clean teeth and freshen breath",
        amazon: "https://www.amazon.com/s?k=dental+chews+for+dogs"
      },
      {
        name: "Enzyme Dental Supplements",
        benefit: "Reduces plaque buildup",
        amazon: "https://www.amazon.com/s?k=dental+enzyme+supplement+for+dogs"
      }
    ],
    avoid: [
      "Sugary treats",
      "Hard bones that can crack teeth"
    ],
    scoreBoost: 8
  }
};
</file>

<file path="lib/data/nutritional-guidelines.ts">
import { NutritionalRequirement, PetCategory } from '../types';

// Based on AAFCO and WSAVA guidelines
export const nutritionalGuidelines: Record<PetCategory, {
  puppy?: NutritionalRequirement;
  adult: NutritionalRequirement;
  senior?: NutritionalRequirement;
}> = {
  dogs: {
    puppy: {
      protein: { min: 22.5, max: 35, unit: '% dry matter' },
      fat: { min: 8.5, max: 20, unit: '% dry matter' },
      fiber: { min: 2, max: 5, unit: '% dry matter' },
      calcium: { min: 1.0, max: 1.8, unit: '% dry matter' },
      phosphorus: { min: 0.8, max: 1.6, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex'],
      calories: { min: 95, max: 110, unit: 'kcal per kg body weight' },
    },
    adult: {
      protein: { min: 18, max: 30, unit: '% dry matter' },
      fat: { min: 5.5, max: 15, unit: '% dry matter' },
      fiber: { min: 2, max: 5, unit: '% dry matter' },
      calcium: { min: 0.5, max: 1.2, unit: '% dry matter' },
      phosphorus: { min: 0.4, max: 1.0, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex'],
      calories: { min: 70, max: 90, unit: 'kcal per kg body weight' },
    },
    senior: {
      protein: { min: 18, max: 25, unit: '% dry matter' },
      fat: { min: 5, max: 12, unit: '% dry matter' },
      fiber: { min: 3, max: 7, unit: '% dry matter' },
      calcium: { min: 0.5, max: 1.0, unit: '% dry matter' },
      phosphorus: { min: 0.4, max: 0.8, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex', 'Joint support'],
      calories: { min: 60, max: 75, unit: 'kcal per kg body weight' },
    },
  },
  cats: {
    puppy: {
      protein: { min: 30, max: 45, unit: '% dry matter' },
      fat: { min: 9, max: 20, unit: '% dry matter' },
      fiber: { min: 1, max: 4, unit: '% dry matter' },
      calcium: { min: 1.0, max: 1.5, unit: '% dry matter' },
      phosphorus: { min: 0.8, max: 1.2, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex', 'Taurine'],
      calories: { min: 200, max: 250, unit: 'kcal per kg body weight' },
    },
    adult: {
      protein: { min: 26, max: 40, unit: '% dry matter' },
      fat: { min: 9, max: 18, unit: '% dry matter' },
      fiber: { min: 1, max: 4, unit: '% dry matter' },
      calcium: { min: 0.6, max: 1.2, unit: '% dry matter' },
      phosphorus: { min: 0.5, max: 1.0, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex', 'Taurine'],
      calories: { min: 60, max: 80, unit: 'kcal per kg body weight' },
    },
    senior: {
      protein: { min: 26, max: 35, unit: '% dry matter' },
      fat: { min: 9, max: 15, unit: '% dry matter' },
      fiber: { min: 2, max: 5, unit: '% dry matter' },
      calcium: { min: 0.6, max: 1.0, unit: '% dry matter' },
      phosphorus: { min: 0.5, max: 0.8, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex', 'Taurine', 'Joint support'],
      calories: { min: 50, max: 70, unit: 'kcal per kg body weight' },
    },
  },
  birds: {
    adult: {
      protein: { min: 12, max: 18, unit: '% dry matter' },
      fat: { min: 3, max: 8, unit: '% dry matter' },
      fiber: { min: 2, max: 5, unit: '% dry matter' },
      calcium: { min: 0.8, max: 1.5, unit: '% dry matter' },
      phosphorus: { min: 0.5, max: 0.8, unit: '% dry matter' },
      vitamins: ['A', 'D3', 'E', 'B-complex'],
      calories: { min: 15, max: 25, unit: 'kcal per 100g body weight' },
    },
  },
  reptiles: {
    adult: {
      protein: { min: 20, max: 40, unit: '% dry matter' },
      fat: { min: 3, max: 10, unit: '% dry matter' },
      fiber: { min: 5, max: 15, unit: '% dry matter' },
      calcium: { min: 1.0, max: 2.0, unit: '% dry matter' },
      phosphorus: { min: 0.5, max: 1.0, unit: '% dry matter' },
      vitamins: ['A', 'D3', 'E', 'B-complex'],
      calories: { min: 10, max: 20, unit: 'kcal per 100g body weight' },
    },
  },
  'pocket-pets': {
    adult: {
      protein: { min: 14, max: 20, unit: '% dry matter' },
      fat: { min: 4, max: 8, unit: '% dry matter' },
      fiber: { min: 10, max: 20, unit: '% dry matter' },
      calcium: { min: 0.6, max: 1.2, unit: '% dry matter' },
      phosphorus: { min: 0.4, max: 0.8, unit: '% dry matter' },
      vitamins: ['A', 'D', 'E', 'B-complex', 'C'],
      calories: { min: 60, max: 80, unit: 'kcal per kg body weight' },
    },
  },
};
</file>

<file path="lib/data/nutritionDatabase.ts">
// Comprehensive nutrition database for all pet food ingredients
// Data from USDA, veterinary sources, and ingredient suppliers

export interface NutritionData {
  protein?: number;      // % or g per 100g
  fat?: number;          // % or g per 100g
  fiber?: number;        // % or g per 100g
  carbs?: number;        // % or g per 100g
  moisture?: number;     // % or g per 100g
  calcium?: number;      // mg per 100g
  phosphorus?: number;   // mg per 100g
  ca_p_ratio?: string;   // e.g., "2.5:1"
  kcal?: number;         // calories per 100g
  omega3?: number;       // g per 100g
  taurine?: number;      // mg per 100g (critical for cats)
}

export const NUTRITION_DATABASE: Record<string, NutritionData> = {
  // PROTEINS - Meat & Fish
  "chicken_breast": { protein: 31, fat: 3.6, calcium: 11, phosphorus: 196, kcal: 165, ca_p_ratio: "0.06:1" },
  "chicken_thigh": { protein: 26, fat: 10.9, kcal: 209 },
  "ground_chicken": { protein: 26, fat: 9, kcal: 165 },
  "ground_beef": { protein: 26, fat: 15, kcal: 217 },
  "ground_turkey": { protein: 29, fat: 1, kcal: 135 },
  "salmon": { protein: 20, fat: 13, omega3: 2.3, kcal: 208 },
  "egg_whole": { protein: 13, fat: 11, kcal: 155 },
  "beef_liver": { protein: 20, fat: 3.6, kcal: 135 },
  "chicken_liver": { protein: 24, fat: 6.5, kcal: 167 },
  "turkey_ground": { protein: 27, fat: 7, kcal: 170 },
  "adult_mouse": { protein: 18.5, fat: 8, moisture: 66, ca_p_ratio: "1.2:1" },
  "adult_rat": { protein: 20, fat: 9.5, moisture: 64, ca_p_ratio: "1.1:1" },
  "day_old_chick": { protein: 16, fat: 6, moisture: 74, ca_p_ratio: "1.8:1" },

  // INSECTS
  "cricket": { protein: 15.4, fat: 3.3, fiber: 2.2, moisture: 77.1, ca_p_ratio: "0.14:1" },
  "mealworm": { protein: 18.7, fat: 13.4, fiber: 2.5, moisture: 61.9, ca_p_ratio: "0.06:1" },
  "dubia_roach": { protein: 21.4, fat: 6.1, fiber: 2.6, moisture: 65.6, ca_p_ratio: "0.3:1" },
  "black_soldier_fly": { protein: 15.5, fat: 9.4, fiber: 2.8, moisture: 66.8, ca_p_ratio: "1.5:1" },
  "waxworm": { protein: 14.1, fat: 24.9, fiber: 3.4, moisture: 58.5, ca_p_ratio: "0.07:1" },

  // GRAINS - Cooked
  "brown_rice_cooked": { protein: 2.6, fat: 0.9, fiber: 1.8, carbs: 23, moisture: 70, kcal: 111 },
  "white_rice_cooked": { protein: 2.7, fat: 0.3, fiber: 0.4, carbs: 28.2, moisture: 68.4, kcal: 130 },
  "oatmeal_cooked": { protein: 2.5, fat: 1.4, fiber: 1.7, carbs: 12, moisture: 84, kcal: 68 },
  "quinoa_cooked": { protein: 4.4, fat: 1.9, fiber: 2.8, carbs: 21.3, moisture: 71.6, kcal: 120 },
  "barley_cooked": { protein: 2.3, fat: 0.4, fiber: 3.8, carbs: 28.2, moisture: 68, kcal: 123 },
  "millet_cooked": { protein: 3.5, fat: 1, fiber: 1.3, carbs: 23.7, moisture: 71, kcal: 119 },

  // VEGETABLES - Cooked
  "sweet_potato_cooked": { protein: 2, fat: 0.1, fiber: 3.3, carbs: 20.7, moisture: 73, kcal: 86 },
  "pumpkin_cooked": { protein: 1, fat: 0.2, fiber: 2.9, carbs: 6.5, moisture: 90, kcal: 26 },
  "carrots_cooked": { protein: 0.9, fat: 0.2, fiber: 2.8, carbs: 8.2, moisture: 87, kcal: 35 },
  "broccoli_cooked": { protein: 3.7, fat: 0.4, fiber: 2.4, carbs: 7.2, moisture: 89, kcal: 34 },
  "spinach_cooked": { protein: 3.6, fat: 0.4, fiber: 2.2, carbs: 3.6, moisture: 91, kcal: 23 },
  "green_beans_cooked": { protein: 1.9, fat: 0.1, fiber: 2.7, carbs: 7, moisture: 90, kcal: 31 },
  "squash_cooked": { protein: 0.9, fat: 0.4, fiber: 2.8, carbs: 8, moisture: 89, kcal: 36 },

  // VEGETABLES - Raw
  "dandelion_greens": { protein: 2.7, fiber: 3.5, ca_p_ratio: "2.8:1" },
  "collard_greens": { protein: 2.5, fiber: 3.6, ca_p_ratio: "1.8:1" },
  "kale": { protein: 2.9, fiber: 2, ca_p_ratio: "2.4:1" },
  "bell_pepper": { protein: 0.9, fiber: 1.7, ca_p_ratio: "0.5:1" },

  // FRUITS
  "apple": { protein: 0.3, fat: 0.2, fiber: 2.4, carbs: 10.4, kcal: 52, ca_p_ratio: "0.5:1" },
  "banana": { protein: 1.1, fat: 0.3, fiber: 2.6, carbs: 12.2, kcal: 89, ca_p_ratio: "0.2:1" },
  "blueberries": { protein: 0.7, fat: 0.3, fiber: 2.4, carbs: 10, kcal: 57, ca_p_ratio: "0.5:1" },
  "papaya": { protein: 0.5, fat: 0.3, fiber: 1.7, carbs: 7.8, kcal: 43, ca_p_ratio: "4.8:1" },
  "fig": { protein: 0.8, fat: 0.3, fiber: 2.9, carbs: 16, kcal: 74, ca_p_ratio: "2.5:1" },

  // SEEDS & NUTS - Raw
  "pumpkin_seeds": { protein: 30.2, fat: 49.1, fiber: 6, carbs: 10.7, kcal: 559 },
  "sunflower_seeds": { protein: 20.8, fat: 51.5, fiber: 8.6, carbs: 20, kcal: 584 },
  "hemp_seeds": { protein: 31.6, fat: 48.8, fiber: 4, carbs: 8.7, kcal: 553 },
  "flaxseed": { protein: 18.3, fat: 42.2, fiber: 27.3, carbs: 28.9, kcal: 534 },
  "chia_seeds": { protein: 16.5, fat: 30.7, fiber: 34.4, carbs: 42.1, kcal: 486 },
  "walnut": { protein: 15.2, fat: 65.2, fiber: 6.7, carbs: 13.7, kcal: 654 },
  "almond": { protein: 21.2, fat: 49.9, fiber: 12.5, carbs: 21.6, kcal: 579 },

  // OILS & FATS
  "salmon_oil": { fat: 100, omega3: 18, kcal: 900 },
  "fish_oil": { fat: 100, omega3: 18, kcal: 900 },
  "coconut_oil": { fat: 100, kcal: 892 },
  "olive_oil": { fat: 100, kcal: 884 },
  "flaxseed_oil": { fat: 100, omega3: 53, kcal: 884 },

  // HAYS
  "timothy_hay": { protein: 7, fat: 1.5, fiber: 32, calcium: 0.4, kcal: 250 },
  "alfalfa_hay": { protein: 17, fat: 1.5, fiber: 24, calcium: 1.3, kcal: 280 },

  // LEGUMES - Cooked
  "lentils_cooked": { protein: 9, fat: 0.4, fiber: 7.9, carbs: 20.1, moisture: 69.7, kcal: 116 },
  "chickpeas_cooked": { protein: 8.9, fat: 2.6, fiber: 7.6, carbs: 27.4, moisture: 60, kcal: 164 },
  "black_beans_cooked": { protein: 8.9, fat: 0.5, fiber: 8.7, carbs: 23.7, moisture: 66, kcal: 132 },
};

// Pet nutritional requirements (daily targets per kg of body weight)
export const PET_NUTRITIONAL_TARGETS: Record<string, Record<string, { min: number; max: number }>> = {
  dogs: {
    protein: { min: 18, max: 35 },      // % of calories
    fat: { min: 5, max: 20 },           // % of calories
    fiber: { min: 1, max: 5 },          // %
    calcium: { min: 0.5, max: 1.5 },    // g per 100g of food
    phosphorus: { min: 0.4, max: 1.0 }, // g per 100g of food
  },
  cats: {
    protein: { min: 30, max: 50 },      // % of calories (obligate carnivore)
    fat: { min: 10, max: 30 },          // % of calories
    fiber: { min: 0, max: 3 },          // %
    calcium: { min: 0.4, max: 1.2 },    // g per 100g of food
    phosphorus: { min: 0.3, max: 0.9 }, // g per 100g of food
    taurine: { min: 400, max: 5000 },   // mg per kg of food
  },
  birds: {
    protein: { min: 12, max: 25 },      // %
    fat: { min: 5, max: 20 },           // %
    fiber: { min: 2, max: 8 },          // %
    calcium: { min: 0.6, max: 2.0 },    // g per 100g of food
  },
  reptiles: {
    protein: { min: 15, max: 50 },      // % (varies by species)
    fat: { min: 3, max: 15 },           // %
    fiber: { min: 1, max: 8 },          // %
    calcium: { min: 0.5, max: 2.0 },    // g per 100g of food
    ca_p_ratio: { min: 1, max: 5 },     // Ca:P ratio (higher is better)
  },
  'pocket-pets': {
    protein: { min: 12, max: 25 },      // %
    fat: { min: 3, max: 10 },           // %
    fiber: { min: 10, max: 30 },        // % (high fiber for digestion)
    calcium: { min: 0.5, max: 1.5 },    // g per 100g of food
  },
};

/**
 * Get nutrition data for an ingredient
 */
export function getNutritionData(ingredientId: string): NutritionData | undefined {
  return NUTRITION_DATABASE[ingredientId.toLowerCase().replace(/\s+/g, '_')];
}

/**
 * Calculate total nutrition for a recipe
 */
export function calculateRecipeNutrition(
  ingredients: Array<{ id: string; amount: number }> // amount in grams
): {
  protein: number;
  fat: number;
  fiber: number;
  carbs: number;
  calcium: number;
  phosphorus: number;
  kcal: number;
  totalWeight: number;
} {
  let protein = 0;
  let fat = 0;
  let fiber = 0;
  let carbs = 0;
  let calcium = 0;
  let phosphorus = 0;
  let kcal = 0;
  let totalWeight = 0;

  for (const ing of ingredients) {
    const nutrition = getNutritionData(ing.id);
    if (!nutrition) continue;

    const grams = ing.amount;
    totalWeight += grams;

    // Convert percentages to grams (assuming % means per 100g)
    protein += ((nutrition.protein || 0) * grams) / 100;
    fat += ((nutrition.fat || 0) * grams) / 100;
    fiber += ((nutrition.fiber || 0) * grams) / 100;
    carbs += ((nutrition.carbs || 0) * grams) / 100;
    calcium += ((nutrition.calcium || 0) * grams) / 100;
    phosphorus += ((nutrition.phosphorus || 0) * grams) / 100;
    kcal += ((nutrition.kcal || 0) * grams) / 100;
  }

  return {
    protein,
    fat,
    fiber,
    carbs,
    calcium,
    phosphorus,
    kcal,
    totalWeight,
  };
}

/**
 * Check if recipe meets nutritional targets for a pet
 */
export function meetsNutritionalTargets(
  nutrition: ReturnType<typeof calculateRecipeNutrition>,
  petType: string,
  petWeightKg: number
): { meets: boolean; gaps: string[] } {
  const targets = PET_NUTRITIONAL_TARGETS[petType];
  if (!targets) return { meets: true, gaps: [] };

  const gaps: string[] = [];
  const proteinPercent = (nutrition.protein / nutrition.kcal) * 100 * 4; // 4 kcal per gram protein
  const fatPercent = (nutrition.fat / nutrition.kcal) * 100 * 9; // 9 kcal per gram fat

  if (targets.protein && (proteinPercent < targets.protein.min || proteinPercent > targets.protein.max)) {
    gaps.push(`Protein: ${proteinPercent.toFixed(1)}% (target: ${targets.protein.min}-${targets.protein.max}%)`);
  }

  if (targets.fat && (fatPercent < targets.fat.min || fatPercent > targets.fat.max)) {
    gaps.push(`Fat: ${fatPercent.toFixed(1)}% (target: ${targets.fat.min}-${targets.fat.max}%)`);
  }

  if (targets.fiber && (nutrition.fiber < targets.fiber.min || nutrition.fiber > targets.fiber.max)) {
    gaps.push(`Fiber: ${nutrition.fiber.toFixed(1)}g (target: ${targets.fiber.min}-${targets.fiber.max}g)`);
  }

  return {
    meets: gaps.length === 0,
    gaps,
  };
}
</file>

<file path="lib/data/packageSizes.ts">
/**
 * Package Size Database
 * Typical Amazon package sizes for common pet food ingredients
 * Used to calculate realistic meal counts from shopping lists
 */

export interface PackageSize {
  category: string;
  typicalSize: number; // in grams
  typicalUnit: string;
  estimatedCost: number; // USD
  notes?: string;
}

export const PACKAGE_SIZES: Record<string, PackageSize> = {
  // SEEDS & GRAINS
  'canary-seed': { 
    category: 'seed', 
    typicalSize: 907, // 2 lb
    typicalUnit: 'lb',
    estimatedCost: 8,
    notes: '2 lb bag typical for bird seed'
  },
  'canary_seed': { 
    category: 'seed', 
    typicalSize: 907, 
    typicalUnit: 'lb',
    estimatedCost: 8
  },
  'millet': { 
    category: 'seed', 
    typicalSize: 907, 
    typicalUnit: 'lb',
    estimatedCost: 6
  },
  'quinoa': { 
    category: 'grain', 
    typicalSize: 680, // 1.5 lb
    typicalUnit: 'lb',
    estimatedCost: 12
  },
  'brown-rice': { 
    category: 'grain', 
    typicalSize: 907, // 2 lb
    typicalUnit: 'lb',
    estimatedCost: 4
  },
  'rice': { 
    category: 'grain', 
    typicalSize: 907, // 2 lb
    typicalUnit: 'lb',
    estimatedCost: 4
  },
  'oats': { 
    category: 'grain', 
    typicalSize: 1361, // 3 lb
    typicalUnit: 'lb',
    estimatedCost: 8
  },
  'oatmeal': { 
    category: 'grain', 
    typicalSize: 1361, 
    typicalUnit: 'lb',
    estimatedCost: 8
  },
  
  // PROTEINS
  'chicken-breast': { 
    category: 'protein', 
    typicalSize: 1361, // 3 lb package
    typicalUnit: 'lb',
    estimatedCost: 18,
    notes: 'Frozen chicken breast packs'
  },
  'ground-turkey': { 
    category: 'protein', 
    typicalSize: 454, // 1 lb
    typicalUnit: 'lb',
    estimatedCost: 6
  },
  'ground-beef': { 
    category: 'protein', 
    typicalSize: 454, // 1 lb
    typicalUnit: 'lb',
    estimatedCost: 8
  },
  'salmon': { 
    category: 'protein', 
    typicalSize: 680, // 1.5 lb
    typicalUnit: 'lb',
    estimatedCost: 15
  },
  'eggs': { 
    category: 'protein', 
    typicalSize: 660, // ~12 eggs
    typicalUnit: 'dozen',
    estimatedCost: 5
  },
  'egg': { 
    category: 'protein', 
    typicalSize: 660, 
    typicalUnit: 'dozen',
    estimatedCost: 5
  },
  
  // VEGETABLES (fresh/frozen)
  'carrots': { 
    category: 'vegetable', 
    typicalSize: 907, // 2 lb bag
    typicalUnit: 'lb',
    estimatedCost: 4
  },
  'carrot': { 
    category: 'vegetable', 
    typicalSize: 907, 
    typicalUnit: 'lb',
    estimatedCost: 4
  },
  'broccoli': { 
    category: 'vegetable', 
    typicalSize: 454, // 1 lb
    typicalUnit: 'lb',
    estimatedCost: 3
  },
  'spinach': { 
    category: 'vegetable', 
    typicalSize: 284, // 10 oz container
    typicalUnit: 'oz',
    estimatedCost: 4
  },
  'sweet-potato': { 
    category: 'vegetable', 
    typicalSize: 1361, // 3 lb bag
    typicalUnit: 'lb',
    estimatedCost: 5
  },
  'sweet_potato': { 
    category: 'vegetable', 
    typicalSize: 1361, 
    typicalUnit: 'lb',
    estimatedCost: 5
  },
  'bell-pepper': { 
    category: 'vegetable', 
    typicalSize: 680, // ~4 peppers
    typicalUnit: 'lb',
    estimatedCost: 6
  },
  'bell_pepper': { 
    category: 'vegetable', 
    typicalSize: 680, 
    typicalUnit: 'lb',
    estimatedCost: 6
  },
  'green-beans': { 
    category: 'vegetable', 
    typicalSize: 454, // 1 lb
    typicalUnit: 'lb',
    estimatedCost: 3
  },
  'peas': { 
    category: 'vegetable', 
    typicalSize: 454, // 1 lb frozen
    typicalUnit: 'lb',
    estimatedCost: 3
  },
  
  // SUPPLEMENTS/POWDERS
  'calcium-powder': { 
    category: 'supplement', 
    typicalSize: 227, // 8 oz
    typicalUnit: 'oz',
    estimatedCost: 12,
    notes: 'Supplement containers'
  },
  'calcium': { 
    category: 'supplement', 
    typicalSize: 227, 
    typicalUnit: 'oz',
    estimatedCost: 12
  },
  'vitamin-powder': { 
    category: 'supplement', 
    typicalSize: 113, // 4 oz
    typicalUnit: 'oz',
    estimatedCost: 15
  },
  'vitamin': { 
    category: 'supplement', 
    typicalSize: 113, 
    typicalUnit: 'oz',
    estimatedCost: 15
  },
  'joint-health': { 
    category: 'supplement', 
    typicalSize: 227, // 8 oz
    typicalUnit: 'oz',
    estimatedCost: 20
  },
  'dasuquin': { 
    category: 'supplement', 
    typicalSize: 227, 
    typicalUnit: 'oz',
    estimatedCost: 43
  },
  
  // OILS
  'olive-oil': { 
    category: 'oil', 
    typicalSize: 500, // 500ml
    typicalUnit: 'ml',
    estimatedCost: 10
  },
  'fish-oil': { 
    category: 'oil', 
    typicalSize: 240, // 8 oz bottle
    typicalUnit: 'oz',
    estimatedCost: 18
  },
  'coconut-oil': { 
    category: 'oil', 
    typicalSize: 454, // 16 oz
    typicalUnit: 'oz',
    estimatedCost: 12
  },
};

// Category defaults for items not in database
export const CATEGORY_DEFAULTS: Record<string, PackageSize> = {
  'seed': { 
    category: 'seed', 
    typicalSize: 907, // 2 lb
    typicalUnit: 'lb',
    estimatedCost: 8
  },
  'grain': { 
    category: 'grain', 
    typicalSize: 907, 
    typicalUnit: 'lb',
    estimatedCost: 6
  },
  'protein': { 
    category: 'protein', 
    typicalSize: 1361, // 3 lb
    typicalUnit: 'lb',
    estimatedCost: 15
  },
  'vegetable': { 
    category: 'vegetable', 
    typicalSize: 454, // 1 lb
    typicalUnit: 'lb',
    estimatedCost: 4
  },
  'fruit': { 
    category: 'fruit', 
    typicalSize: 454, 
    typicalUnit: 'lb',
    estimatedCost: 5
  },
  'supplement': { 
    category: 'supplement', 
    typicalSize: 227, // 8 oz
    typicalUnit: 'oz',
    estimatedCost: 12
  },
  'oil': { 
    category: 'oil', 
    typicalSize: 500, // 500ml
    typicalUnit: 'ml',
    estimatedCost: 10
  },
  'default': { 
    category: 'other', 
    typicalSize: 454, // 1 lb default
    typicalUnit: 'lb',
    estimatedCost: 8
  }
};

/**
 * Get package size information for an ingredient
 * @param ingredientName - The name of the ingredient
 * @returns PackageSize with typical package size and cost
 */
export function getPackageSize(ingredientName: string, category?: string): PackageSize {
  console.log('[getPackageSize] Input - ingredientName:', ingredientName, 'category:', category);
  
  if (!ingredientName) {
    console.log('[getPackageSize] ‚ùå No ingredient name provided, returning default');
    return CATEGORY_DEFAULTS.default;
  }
  
  // Normalize ingredient name
  const normalized = ingredientName.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
  console.log('[getPackageSize] Normalized name:', normalized);
  
  // Check exact match
  if (PACKAGE_SIZES[normalized]) {
    console.log('[getPackageSize] ‚úÖ Exact match found:', PACKAGE_SIZES[normalized]);
    return PACKAGE_SIZES[normalized];
  }
  
  // Check partial matches (key contains name or name contains key)
  for (const [key, value] of Object.entries(PACKAGE_SIZES)) {
    if (normalized.includes(key) || key.includes(normalized)) {
      console.log('[getPackageSize] ‚úÖ Partial match found:', key, value);
      return value;
    }
  }
  
  // If category provided, use category default
  if (category) {
    const categoryLower = category.toLowerCase();
    if (CATEGORY_DEFAULTS[categoryLower]) {
      console.log('[getPackageSize] ‚úÖ Using category default:', categoryLower, CATEGORY_DEFAULTS[categoryLower]);
      return CATEGORY_DEFAULTS[categoryLower];
    }
  }
  
  // Try to guess category from name
  if (normalized.includes('seed')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: seed');
    return CATEGORY_DEFAULTS.seed;
  }
  if (normalized.includes('rice') || normalized.includes('oat') || normalized.includes('grain') || normalized.includes('quinoa')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: grain');
    return CATEGORY_DEFAULTS.grain;
  }
  if (normalized.includes('chicken') || normalized.includes('turkey') || normalized.includes('meat') || normalized.includes('beef') || normalized.includes('salmon') || normalized.includes('fish') || normalized.includes('egg')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: protein');
    return CATEGORY_DEFAULTS.protein;
  }
  if (normalized.includes('carrot') || normalized.includes('broccoli') || normalized.includes('vegetable') || normalized.includes('pepper') || normalized.includes('bean') || normalized.includes('pea') || normalized.includes('spinach')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: vegetable');
    return CATEGORY_DEFAULTS.vegetable;
  }
  if (normalized.includes('oil') || normalized.includes('fat')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: oil');
    return CATEGORY_DEFAULTS.oil;
  }
  if (normalized.includes('powder') || normalized.includes('supplement') || normalized.includes('vitamin') || normalized.includes('calcium') || normalized.includes('joint')) {
    console.log('[getPackageSize] ‚úÖ Guessed category: supplement');
    return CATEGORY_DEFAULTS.supplement;
  }
  
  // Default fallback
  console.log('[getPackageSize] ‚ö†Ô∏è No match found, using default fallback');
  return CATEGORY_DEFAULTS.default;
}
</file>

<file path="lib/data/pets.ts">
import { Breed, AgeGroup, HealthConcern } from '../types';
import { getBreedsForSpecies } from './speciesBreeds';

// Re-export from centralized source for backward compatibility
export const dogBreeds: Breed[] = getBreedsForSpecies('dogs');
export const catBreeds: Breed[] = getBreedsForSpecies('cats');
export const birdTypes: Breed[] = getBreedsForSpecies('birds');
export const reptileTypes: Breed[] = getBreedsForSpecies('reptiles');
export const pocketPetTypes: Breed[] = getBreedsForSpecies('pocket-pets');

export const ageGroups: AgeGroup[] = [
  { value: 'baby', label: 'Baby' },
  { value: 'young', label: 'Young' },
  { value: 'adult', label: 'Adult' },
  { value: 'senior', label: 'Senior' },
];

export const healthConcerns: HealthConcern[] = [
  {
    id: 'weight-management',
    name: 'Weight Management',
    description: 'For overweight pets needing controlled calorie intake',
    dietaryAdjustments: ['Lower fat', 'Higher fiber', 'Controlled portions'],
  },
  {
    id: 'allergies',
    name: 'Food Allergies',
    description: 'For pets with food sensitivities',
    dietaryAdjustments: ['Limited ingredient', 'Novel protein sources', 'Grain-free options'],
  },
  {
    id: 'joint-health',
    name: 'Joint Health',
    description: 'For pets with arthritis or joint issues',
    dietaryAdjustments: ['Glucosamine', 'Omega-3 fatty acids', 'Anti-inflammatory ingredients'],
  },
  {
    id: 'digestive',
    name: 'Digestive Issues',
    description: 'For pets with sensitive stomachs',
    dietaryAdjustments: ['Probiotics', 'Easily digestible proteins', 'Low fat'],
  },
  {
    id: 'kidney',
    name: 'Kidney Support',
    description: 'For pets with kidney concerns',
    dietaryAdjustments: ['Lower protein', 'Lower phosphorus', 'Increased moisture'],
  },
  {
    id: 'dental',
    name: 'Dental Health',
    description: 'For pets needing dental support',
    dietaryAdjustments: ['Crunchy textures', 'Dental-friendly ingredients', 'Natural teeth cleaners'],
  },
  {
    id: 'none',
    name: 'No Special Concerns',
    description: 'General health maintenance',
    dietaryAdjustments: ['Balanced nutrition', 'Age-appropriate'],
  },
];

export const breeds = {
  dogs: dogBreeds,
  cats: catBreeds,
  birds: birdTypes,
  reptiles: reptileTypes,
  'pocket-pets': pocketPetTypes,
};

// Re-export centralized functions for convenience
export { getBreedsForSpecies, getBreedNamesForSpecies, getAllSpecies } from './speciesBreeds';
</file>

<file path="lib/data/product-prices.ts">
// lib/data/product-prices.ts
// SINGLE SOURCE OF TRUTH for all product data

import PRODUCT_PRICES from '../../data/product-prices.json';
import { getAmazonBuyLink } from '@/lib/utils/getAmazonBuyLink';

export interface ProductPrice {
  ingredient: string;
  asin: string;
  url: string;
  quantity?: string;
  productName?: string;
  brand?: string;
  qualityScore?: number;
  researchScore?: number;
  tier?: 'budget' | 'standard' | 'premium';
  notes?: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
  };
}

/**
 * Get product data by ingredient name
 * Handles fuzzy matching for variations
 * Validates Amazon URLs through runtime finalizer
 */
export function getProductByIngredient(ingredientName: string): ProductPrice | null {
  if (!ingredientName) return null;
  
  const normalized = ingredientName.toLowerCase().trim();
  
  // Try exact match first
  let product = PRODUCT_PRICES.find(p => p.ingredient === normalized);
  
  // Try partial match if exact fails
  if (!product) {
    product = PRODUCT_PRICES.find(p => 
      normalized.includes(p.ingredient) || p.ingredient.includes(normalized)
    );
  }
  
  if (!product) return null;
  
  // Validate and finalize Amazon URL through runtime finalizer
  const validatedUrl = getAmazonBuyLink(product.url);
  
  return {
    ...product,
    url: validatedUrl || product.url, // Use validated URL or fallback to original
  } as ProductPrice;
}

/**
 * Get purchase URL for an ingredient
 * Returns Amazon link with affiliate tag
 */
export function getProductUrl(ingredientName: string): string | null {
  const product = getProductByIngredient(ingredientName);
  return product?.url || null;
}

/**
 * Get quality score for an ingredient (0-10, higher is better)
 */
export function getProductQualityScore(ingredientName: string): number {
  const product = getProductByIngredient(ingredientName);
  return product?.qualityScore || product?.researchScore || 5; // Default to 5 if no score
}

/**
 * Get all product options for an ingredient (including budget variants)
 */
export function getProductOptions(ingredientName: string): ProductPrice[] {
  const normalized = ingredientName.toLowerCase().trim();
  return PRODUCT_PRICES.filter(p => 
    p.ingredient === normalized || 
    p.ingredient.includes(normalized) || 
    normalized.includes(p.ingredient)
  ) as ProductPrice[];
}

/**
 * Get best quality product for an ingredient
 */
export function getBestQualityProduct(ingredientName: string): ProductPrice | null {
  const options = getProductOptions(ingredientName);
  if (options.length === 0) return null;
  
  // Sort by quality score descending, then by research score
  return options.sort((a, b) => {
    const scoreA = (a.qualityScore || a.researchScore || 0);
    const scoreB = (b.qualityScore || b.researchScore || 0);
    return scoreB - scoreA;
  })[0];
}

/**
 * Get price for an ingredient (normalized to cost per pound)
 */
export function getProductPrice(ingredientName: string): number | null {
  const product = getProductByIngredient(ingredientName);
  if (!product?.price.amount) return null;
  
  // Normalize to cost per pound
  const quantity = product.quantity?.toLowerCase() || '';
  const totalPrice = product.price.amount;
  
  // Extract weight in pounds from quantity string
  let pounds = 1; // default
  
  if (quantity.includes('lb')) {
    const match = quantity.match(/(\d+(?:\.\d+)?)\s*lbs?/);
    if (match) pounds = parseFloat(match[1]);
  } else if (quantity.includes('oz')) {
    const match = quantity.match(/(\d+(?:\.\d+)?)\s*oz/);
    if (match) pounds = parseFloat(match[1]) / 16;
  } else if (quantity.includes('count')) {
    // For items sold by count (eggs, etc), estimate ~2 oz per unit
    const match = quantity.match(/(\d+)\s*count/);
    if (match) pounds = (parseFloat(match[1]) * 2) / 16;
  }
  
  // Return cost per pound
  return pounds > 0 ? totalPrice / pounds : totalPrice;
}

/**
 * Get quantity/package size for an ingredient
 */
export function getProductQuantity(ingredientName: string): string | null {
  const product = getProductByIngredient(ingredientName);
  return product?.quantity || null;
}

/**
 * Get ASIN for an ingredient
 */
export function getProductAsin(ingredientName: string): string | null {
  const product = getProductByIngredient(ingredientName);
  return product?.asin || null;
}

// Export the full list for direct access if needed
export { PRODUCT_PRICES };
export default PRODUCT_PRICES;
</file>

<file path="lib/data/recipes-index.ts">
// lib/data/recipes-index.ts
// Lightweight recipe index for initial page loads
// Full recipe bodies are lazy-loaded on demand

import type { Recipe } from '../types';

export interface RecipeIndexEntry {
  id: string;
  name: string;
  shortName?: string;
  category: string;
  tags?: string[];
  baseScore?: number; // Precomputed base compatibility score if available
  healthConcerns?: string[];
  ageGroup?: string[];
  imageUrl?: string;
  prepTime?: string;
  servings?: number;
}

/**
 * Generate lightweight index from full recipes
 * This is a build-time helper - actual index should be generated by script
 */
export function generateRecipeIndex(recipes: Recipe[]): RecipeIndexEntry[] {
  return recipes.map(recipe => ({
    id: recipe.id,
    name: recipe.name,
    shortName: recipe.shortName,
    category: recipe.category,
    tags: recipe.tags,
    healthConcerns: recipe.healthConcerns,
    ageGroup: recipe.ageGroup,
    imageUrl: recipe.imageUrl,
    prepTime: recipe.prepTime,
    servings: recipe.servings,
  }));
}

/**
 * Load a single recipe by ID
 * Recipes are now generated dynamically - returns null
 */
export async function loadRecipeById(id: string): Promise<Recipe | null> {
  return null;
}

/**
 * Load multiple recipes by IDs
 * Recipes are now generated dynamically - returns empty array
 */
export async function loadRecipesByIds(ids: string[]): Promise<Recipe[]> {
  return [];
}

/**
 * Load all recipes
 * Recipes are now generated dynamically - returns empty array
 */
export async function loadAllRecipes(): Promise<Recipe[]> {
  return [];
}
</file>

<file path="lib/data/reptile-nutrition.ts">
// lib/data/reptile-nutrition.ts
// Reptile nutrition standards based on veterinary and herpetological research

export interface ReptileNutrientRequirements {
  protein: {
    min: number;
    max: number;
    unit: string;
    source: string;
  };
  fat: {
    min: number;
    max: number;
    unit: string;
  };
  calcium: {
    min: number;
    max?: number;
    unit: string;
    critical: boolean;
  };
  phosphorus: {
    min: number;
    max?: number;
    unit: string;
  };
  CaP_ratio: {
    ideal: number;
    min: number;
    max: number;
    critical: boolean;
  };
  vitaminD3?: {
    min: number;
    unit: string;
  };
  vitaminA?: {
    min: number;
    unit: string;
  };
}

export const REPTILE_NUTRITION_STANDARDS = {
  bearded_dragon: {
    protein: { min: 15, max: 25, unit: '% DM', source: 'Herpetological Nutrition' },
    fat: { min: 3, max: 8, unit: '% DM' },
    calcium: { min: 1.0, max: 1.5, unit: '% DM', critical: true },
    phosphorus: { min: 0.4, max: 0.8, unit: '% DM' },
    CaP_ratio: { ideal: 2.5, min: 2.0, max: 3.0, critical: true },
    vitaminD3: { min: 800, unit: 'IU/kg' },
    vitaminA: { min: 10000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  leopard_gecko: {
    protein: { min: 20, max: 30, unit: '% DM', source: 'Leopard Gecko Care Guidelines' },
    fat: { min: 8, max: 15, unit: '% DM' },
    calcium: { min: 1.2, max: 2.0, unit: '% DM', critical: true },
    phosphorus: { min: 0.5, max: 1.0, unit: '% DM' },
    CaP_ratio: { ideal: 2.0, min: 1.5, max: 2.5, critical: true },
    vitaminD3: { min: 1000, unit: 'IU/kg' },
    vitaminA: { min: 8000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  ball_python: {
    protein: { min: 18, max: 28, unit: '% DM', source: 'Snake Nutrition Research' },
    fat: { min: 5, max: 12, unit: '% DM' },
    calcium: { min: 0.8, max: 1.2, unit: '% DM', critical: true },
    phosphorus: { min: 0.4, max: 0.7, unit: '% DM' },
    CaP_ratio: { ideal: 2.0, min: 1.5, max: 2.5, critical: true },
    vitaminD3: { min: 600, unit: 'IU/kg' },
    vitaminA: { min: 5000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  red_eared_slider: {
    protein: { min: 25, max: 35, unit: '% DM', source: 'Chelonian Nutrition Guidelines' },
    fat: { min: 4, max: 10, unit: '% DM' },
    calcium: { min: 1.5, max: 2.5, unit: '% DM', critical: true },
    phosphorus: { min: 0.6, max: 1.0, unit: '% DM' },
    CaP_ratio: { ideal: 3.0, min: 2.5, max: 4.0, critical: true },
    vitaminD3: { min: 1200, unit: 'IU/kg' },
    vitaminA: { min: 15000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  corn_snake: {
    protein: { min: 20, max: 30, unit: '% DM', source: 'Colubrid Snake Nutrition' },
    fat: { min: 6, max: 12, unit: '% DM' },
    calcium: { min: 0.9, max: 1.4, unit: '% DM', critical: true },
    phosphorus: { min: 0.4, max: 0.8, unit: '% DM' },
    CaP_ratio: { ideal: 2.2, min: 1.8, max: 2.8, critical: true },
    vitaminD3: { min: 700, unit: 'IU/kg' },
    vitaminA: { min: 6000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  green_iguana: {
    protein: { min: 15, max: 25, unit: '% DM', source: 'Iguana Care Guidelines' },
    fat: { min: 2, max: 6, unit: '% DM' },
    calcium: { min: 1.8, max: 3.0, unit: '% DM', critical: true },
    phosphorus: { min: 0.5, max: 0.9, unit: '% DM' },
    CaP_ratio: { ideal: 4.0, min: 3.0, max: 5.0, critical: true },
    vitaminD3: { min: 1500, unit: 'IU/kg' },
    vitaminA: { min: 12000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements,

  chameleon: {
    protein: { min: 18, max: 28, unit: '% DM', source: 'Chameleon Nutrition Research' },
    fat: { min: 3, max: 8, unit: '% DM' },
    calcium: { min: 1.2, max: 2.0, unit: '% DM', critical: true },
    phosphorus: { min: 0.4, max: 0.8, unit: '% DM' },
    CaP_ratio: { ideal: 3.0, min: 2.5, max: 4.0, critical: true },
    vitaminD3: { min: 1000, unit: 'IU/kg' },
    vitaminA: { min: 10000, unit: 'IU/kg' }
  } as ReptileNutrientRequirements
};

// Common reptile deficiencies and their symptoms
export const REPTILE_DEFICIENCIES = {
  metabolic_bone_disease: {
    cause: "Calcium deficiency or improper Ca:P ratio",
    symptoms: ["Soft bones", "Swollen limbs", "Lethargy", "Difficulty walking"],
    prevention: "Proper calcium supplementation, UVB lighting",
    severity: "life-threatening"
  },

  secondary_nutritional_hyperparathyroidism: {
    cause: "Excess phosphorus relative to calcium",
    symptoms: ["Bone deformities", "Muscle weakness", "Fractures"],
    prevention: "Balanced Ca:P ratio (2:1 to 4:1 depending on species)",
    severity: "severe"
  },

  vitamin_a_deficiency: {
    cause: "Insufficient vitamin A in diet",
    symptoms: ["Eye problems", "Skin issues", "Respiratory infections"],
    prevention: "Beta-carotene rich foods, vitamin A supplements",
    severity: "moderate"
  },

  vitamin_d3_deficiency: {
    cause: "Lack of UVB exposure or vitamin D3",
    symptoms: ["Metabolic bone disease", "Weakness"],
    prevention: "UVB lighting or vitamin D3 supplementation",
    severity: "severe"
  }
};

// Feeding guidelines by species type
export const REPTILE_FEEDING_GUIDELINES = {
  insectivores: {
    diet: "70% insects, 20% vegetables, 10% fruits",
    insects: ["Crickets", "Mealworms", "Dubia roaches", "Waxworms"],
    vegetables: ["Collard greens", "Kale", "Squash", "Carrots"],
    calcium: "Dust insects 3x per week",
    frequency: "Daily feeding for juveniles, every other day for adults"
  },

  herbivores: {
    diet: "80% vegetables, 10% fruits, 10% protein",
    vegetables: ["Collard greens", "Kale", "Mustard greens", "Dandelion greens"],
    fruits: ["Figs", "Melons", "Berries"],
    protein: ["Occasional insects or tofu"],
    calcium: "Calcium supplement daily",
    frequency: "Daily fresh greens"
  },

  carnivores: {
    diet: "90% animal protein, 10% vegetables",
    protein: ["Mice", "Fish", "Insects", "Eggs"],
    vegetables: ["Limited leafy greens"],
    calcium: "Bone-in feeding or supplementation",
    frequency: "1-2 meals per week depending on size"
  },

  omnivores: {
    diet: "50% insects/plants, 30% vegetables, 20% fruits",
    protein: ["Insects", "Small mice"],
    vegetables: ["Mixed greens", "Squash", "Carrots"],
    fruits: ["Berries", "Melons"],
    calcium: "Dust insects, supplement as needed",
    frequency: "Daily feeding"
  }
};

// Helper functions
export function getReptileStandards(species: string): ReptileNutrientRequirements | undefined {
  const speciesKey = species.toLowerCase().replace(/\s+/g, '_');
  return REPTILE_NUTRITION_STANDARDS[speciesKey as keyof typeof REPTILE_NUTRITION_STANDARDS];
}

export function calculateReptileCaPRatio(calcium: number, phosphorus: number): number {
  return phosphorus > 0 ? calcium / phosphorus : 0;
}

export function validateReptileNutrition(
  recipe: any,
  species: string
): {
  isValid: boolean;
  violations: string[];
  warnings: string[];
} {
  const standards = getReptileStandards(species);
  if (!standards) {
    return {
      isValid: false,
      violations: [`No nutritional standards found for ${species}`],
      warnings: []
    };
  }

  const violations: string[] = [];
  const warnings: string[] = [];

  // Check calcium
  if (recipe.calcium < standards.calcium.min) {
    violations.push(`Calcium too low: ${recipe.calcium}% vs minimum ${standards.calcium.min}%`);
  }
  if (standards.calcium.max && recipe.calcium > standards.calcium.max) {
    violations.push(`Calcium too high: ${recipe.calcium}% vs maximum ${standards.calcium.max}%`);
  }

  // Check phosphorus
  if (recipe.phosphorus < standards.phosphorus.min) {
    violations.push(`Phosphorus too low: ${recipe.phosphorus}% vs minimum ${standards.phosphorus.min}%`);
  }
  if (standards.phosphorus.max && recipe.phosphorus > standards.phosphorus.max) {
    violations.push(`Phosphorus too high: ${recipe.phosphorus}% vs maximum ${standards.phosphorus.max}%`);
  }

  // Check Ca:P ratio
  const caPRatio = calculateReptileCaPRatio(recipe.calcium, recipe.phosphorus);
  if (caPRatio < standards.CaP_ratio.min || caPRatio > standards.CaP_ratio.max) {
    violations.push(`Ca:P ratio out of range: ${caPRatio.toFixed(2)} vs ${standards.CaP_ratio.min}-${standards.CaP_ratio.max}`);
  }

  // Check protein
  if (recipe.protein < standards.protein.min) {
    violations.push(`Protein too low: ${recipe.protein}% vs minimum ${standards.protein.min}%`);
  }
  if (recipe.protein > standards.protein.max) {
    warnings.push(`Protein may be too high: ${recipe.protein}% vs maximum ${standards.protein.max}%`);
  }

  return {
    isValid: violations.length === 0,
    violations,
    warnings
  };
}
</file>

<file path="lib/data/safe-ingredient-library.ts">
// lib/data/safe-ingredient-library.ts
// Curated, species-safe ingredient pools and toxic lists to drive deterministic recipe generation.

export type SpeciesKey = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

export interface SafePool {
  proteins?: string[];
  fish?: string[];
  organMeats?: string[];
  vegetables?: string[];
  fruits?: string[];
  grains?: string[];
  fats?: string[];
  seeds?: string[];
  supplements?: string[];
  hay?: string[];
  legumes?: string[];
}

export const SAFE_INGREDIENT_LIBRARY: Record<string, SafePool> = {
  dog: {
    proteins: [
      'chicken breast', 'chicken thighs', 'turkey', 'beef', 'lamb', 
      'salmon', 'whitefish', 'duck', 'venison', 'bison', 'pork',
      'anchovies', 'cod', 'herring', // Budget fish alternatives
      'eggs', 'cottage cheese', 'greek yogurt', 'sardines', 'mackerel',
      'quail', 'rabbit', 'turkey liver', 'chicken liver', 'beef liver',
      'chicken hearts', 'beef heart', 'turkey hearts', 'pork liver', // Budget organ meats
      'beef kidney', 'green tripe' // Budget probiotic protein source
    ],
    vegetables: [
      'sweet potato', 'pumpkin', 'carrots', 'green beans', 'peas',
      'broccoli', 'spinach', 'kale', 'zucchini', 'butternut squash',
      'brussels sprouts', 'cauliflower', 'celery', 'cucumber',
      'asparagus', 'beets', 'bok choy', 'cabbage', 'collard greens',
      'parsnips', 'turnips', 'bell peppers', 'swiss chard', // Budget vegetable options
      'parsley', 'cilantro', 'basil'
    ],
    fruits: [
      'blueberries', 'strawberries', 'apples', 'bananas', 'watermelon',
      'cantaloupe', 'cranberries', 'raspberries', 'blackberries',
      'pears', 'mangoes', 'peaches', 'pineapple'
    ],
    grains: [
      'brown rice', 'white rice', 'oats', 'quinoa', 'barley',
      'sweet potato', 'regular potato', 'buckwheat', 'millet'
    ],
    fats: [
      'olive oil', 'coconut oil', 'fish oil', 'flaxseed oil',
      'sunflower oil', 'salmon oil'
    ],
    supplements: [
      'bone broth', 'kelp powder', 'turmeric', 'spirulina',
      'eggshells (crushed)', 'chia seeds', 'pumpkin seeds'
    ]
  },
  
  cat: {
    proteins: [ // Cats need MORE protein, less carbs
      'chicken breast', 'chicken thighs', 'turkey', 'duck',
      'salmon', 'tuna', 'sardines', 'mackerel', 'whitefish',
      'anchovies', 'herring', // Budget fish options, high in omega-3 and taurine
      'beef', 'lamb', 'rabbit', 'quail', 'venison',
      'chicken liver', 'chicken hearts', 'turkey liver', 'turkey hearts', // Budget taurine sources
      'beef heart', 'pork heart', // Critical budget taurine sources (cats need 10%+ heart muscle)
      'beef spleen', 'pork kidney', // Budget organ variety
      'eggs', 'cottage cheese'
    ],
    vegetables: [ // Cats need VERY LITTLE, but safe options:
      'pumpkin', 'carrots', 'green beans', 'peas',
      'spinach', 'zucchini', 'broccoli (small amounts)'
    ],
    fruits: [ // Minimal for cats
      'blueberries (small amounts)', 'cranberries (small amounts)'
    ],
    grains: [ // Optional, cats are obligate carnivores
      'brown rice (small amounts)', 'oats (small amounts)'
    ],
    fats: [
      'fish oil', 'salmon oil', 'chicken fat', 'olive oil (small amounts)'
    ],
    supplements: [
      'taurine powder', 'bone broth', 'kelp powder',
      'eggshells (crushed)', 'fish oil'
    ]
  },
  
  bird: {
    seeds: [
      'millet', 'canary seed', 'oats', 'quinoa', 'buckwheat',
      'flax seeds', 'chia seeds', 'hemp seeds', 'sunflower seeds (limited)',
      'pumpkin seeds', 'sesame seeds', 'niger seed', 'nyjer seed' // Budget seed options
    ],
    vegetables: [
      'leafy greens', 'kale', 'collard greens', 'mustard greens',
      'dandelion greens', 'carrots', 'sweet potato', 'squash',
      'bell peppers', 'broccoli', 'cauliflower', 'peas',
      'green beans', 'corn', 'beets', 'cucumber'
    ],
    fruits: [
      'apples', 'berries', 'melons', 'papaya', 'mango',
      'grapes (limited)', 'pomegranate', 'oranges', 'bananas',
      'cherries (no pits)', 'peaches', 'pears'
    ],
    proteins: [
      'cooked eggs', 'cooked chicken (small amounts)',
      'cooked fish (small amounts)', 'mealworms', 'crickets',
      'waxworms', 'silkworms' // Budget insect protein options
    ],
    legumes: [
      'lentils (cooked)', 'chickpeas (cooked)', 'black beans (cooked)',
      'kidney beans (cooked)'
    ],
    supplements: [
      'cuttlebone', 'mineral block', 'calcium powder', 'oyster shell', // Budget calcium alternative
      'spirulina', 'bee pollen'
    ]
  },
  
  reptile: {
    // Note: Reptiles are split by type in the generator, but we define pools here
    vegetables: [
      'collard greens', 'mustard greens', 'turnip greens',
      'dandelion greens', 'kale', 'bok choy', 'endive',
      'escarole', 'butternut squash', 'acorn squash',
      'bell peppers', 'green beans', 'snap peas',
      'mulberry leaves' // Budget leafy green option
    ],
    fruits: [
      'papaya', 'mango', 'berries', 'figs', 'melon',
      'prickly pear', 'hibiscus flowers'
    ],
    proteins: [
        'crickets', 'dubia roaches', 'mealworms', 'superworms',
        'silkworms', 'hornworms', 'black soldier fly larvae', // Budget feeder option
        'cooked chicken (small amounts)', 'cooked eggs', 'whole prey (mice, rats)', 
        'ground turkey', 'beef heart'
    ],
    supplements: [
      'calcium powder', 'vitamin D3', 'cuttlebone'
    ]
  },
  
  'pocket-pet': {
      proteins: [
        'mealworms', 'crickets', 'cooked chicken (small amounts)',
        'cooked eggs', 'tofu (small amounts)'
      ],
      vegetables: [
        'carrots', 'broccoli', 'cucumber', 'bell peppers',
        'spinach', 'cauliflower', 'peas', 'corn', 'kale', 'parsley',
        'romaine lettuce', 'cilantro', 'green beans', 'arugula', 'bok choy', 'mint',
        'radicchio', 'watercress' // Budget leafy green options
      ],
      fruits: [
        'apples', 'bananas', 'berries', 'melon', 'grapes (limited)', 
        'oranges', 'strawberries', 'kiwi', 'papaya'
      ],
      grains: [
        'oats', 'barley', 'wheat', 'millet', 'brown rice'
      ],
      seeds: [
        'sunflower seeds', 'pumpkin seeds', 'flax seeds'
      ],
      hay: [
        'timothy hay', 'orchard grass', 'meadow hay', 'oat hay',
        'alfalfa hay' // For young rabbits/guinea pigs, common and affordable
      ],
      supplements: [
        'vitamin C drops', 'rose hips' // Budget vitamin C source for guinea pigs
      ]
  }
};

// Add TOXIC ingredients to AVOID
export const TOXIC_INGREDIENTS: Record<string, string[]> = {
  dog: [
    'chocolate', 'grapes', 'raisins', 'onions', 'garlic', 'xylitol',
    'avocado', 'macadamia nuts', 'alcohol', 'caffeine', 'raw yeast dough',
    'hops', 'moldy food', 'nutmeg', 'chives', 'leeks'
  ],
  cat: [
    'chocolate', 'grapes', 'raisins', 'onions', 'garlic', 'xylitol',
    'alcohol', 'caffeine', 'raw dough', 'chives', 'leeks',
    'lilies (plants)', 'raw fish (large amounts)', 'milk (adult cats)'
  ],
  bird: [
    'avocado', 'chocolate', 'salt', 'caffeine', 'alcohol',
    'onions', 'garlic', 'apple seeds', 'stone fruit pits',
    'raw beans', 'mushrooms'
  ],
  reptile: [
    'avocado', 'rhubarb', 'spinach (large amounts)', 'iceberg lettuce',
    'fireflies', 'wild-caught insects'
  ],
  'pocket-pet': [
    'chocolate', 'onions', 'garlic', 'raw beans', 'potato leaves',
    'rhubarb', 'avocado', 'apple seeds'
  ]
};
</file>

<file path="lib/data/speciesBreeds.ts">
import { Breed, PetCategory } from '../types';

export interface SpeciesBreedData {
  species: PetCategory;
  breeds: Breed[];
}

// Initial data with common breeds and requested additions
export const SPECIES_BREEDS_DATA: SpeciesBreedData[] = [
  {
    species: 'dogs',
    breeds: [
      { id: 'golden-retriever', name: 'Golden Retriever', category: 'dogs' },
      { id: 'labrador', name: 'Labrador Retriever', category: 'dogs' },
      { id: 'german-shepherd', name: 'German Shepherd', category: 'dogs' },
      { id: 'bulldog', name: 'Bulldog', category: 'dogs' },
      { id: 'poodle', name: 'Poodle', category: 'dogs' },
      { id: 'beagle', name: 'Beagle', category: 'dogs' },
      { id: 'rottweiler', name: 'Rottweiler', category: 'dogs' },
      { id: 'yorkie', name: 'Yorkshire Terrier', category: 'dogs' },
      { id: 'boxer', name: 'Boxer', category: 'dogs' },
      { id: 'dachshund', name: 'Dachshund', category: 'dogs' },
      { id: 'mixed-dog', name: 'Mixed Breed', category: 'dogs' },
      { id: 'other-dog', name: 'Other', category: 'dogs' },
    ],
  },
  {
    species: 'cats',
    breeds: [
      { id: 'domestic-shorthair', name: 'Domestic Shorthair', category: 'cats' },
      { id: 'persian', name: 'Persian', category: 'cats' },
      { id: 'maine-coon', name: 'Maine Coon', category: 'cats' },
      { id: 'siamese', name: 'Siamese', category: 'cats' },
      { id: 'ragdoll', name: 'Ragdoll', category: 'cats' },
      { id: 'bengal', name: 'Bengal', category: 'cats' },
      { id: 'sphynx', name: 'Sphynx', category: 'cats' },
      { id: 'british-shorthair', name: 'British Shorthair', category: 'cats' },
      { id: 'abyssinian', name: 'Abyssinian', category: 'cats' },
      { id: 'mixed-cat', name: 'Mixed Breed', category: 'cats' },
      { id: 'other-cat', name: 'Other', category: 'cats' },
    ],
  },
  {
    species: 'birds',
    breeds: [
      { id: 'parakeet', name: 'Parakeet (Budgie)', category: 'birds' },
      { id: 'cockatiel', name: 'Cockatiel', category: 'birds' },
      { id: 'canary', name: 'Canary', category: 'birds' },
      { id: 'finch', name: 'Finch', category: 'birds' },
      { id: 'african-grey', name: 'African Grey', category: 'birds' },
      { id: 'macaw', name: 'Macaw', category: 'birds' },
      { id: 'quaker-parakeet', name: 'Quaker Parakeet', category: 'birds' },
      { id: 'cockatoo', name: 'Cockatoo', category: 'birds' },
      { id: 'conure', name: 'Conure', category: 'birds' },
      { id: 'lovebird', name: 'Lovebird', category: 'birds' },
      { id: 'other-bird', name: 'Other', category: 'birds' },
    ],
  },
  {
    species: 'reptiles',
    breeds: [
      { id: 'bearded-dragon', name: 'Bearded Dragon', category: 'reptiles' },
      { id: 'leopard-gecko', name: 'Leopard Gecko', category: 'reptiles' },
      { id: 'turtle', name: 'Turtle (Aquatic)', category: 'reptiles' },
      { id: 'tortoise', name: 'Tortoise', category: 'reptiles' },
      { id: 'crested-gecko', name: 'Crested Gecko', category: 'reptiles' },
      { id: 'iguana', name: 'Iguana', category: 'reptiles' },
      { id: 'chameleon', name: 'Chameleon', category: 'reptiles' },
      { id: 'other-reptile', name: 'Other', category: 'reptiles' },
    ],
  },
  {
    species: 'pocket-pets',
    breeds: [
      { id: 'hamster', name: 'Hamster', category: 'pocket-pets' },
      { id: 'guinea-pig', name: 'Guinea Pig', category: 'pocket-pets' },
      { id: 'rabbit', name: 'Rabbit', category: 'pocket-pets' },
      { id: 'rat', name: 'Rat', category: 'pocket-pets' },
      { id: 'mouse', name: 'Mouse', category: 'pocket-pets' },
      { id: 'gerbil', name: 'Gerbil', category: 'pocket-pets' },
      { id: 'ferret', name: 'Ferret', category: 'pocket-pets' },
      { id: 'chinchilla', name: 'Chinchilla', category: 'pocket-pets' },
      { id: 'sugar-glider', name: 'Sugar Glider', category: 'pocket-pets' },
      { id: 'hedgehog', name: 'Hedgehog', category: 'pocket-pets' },
      { id: 'other-pocket-pet', name: 'Other', category: 'pocket-pets' },
    ],
  },
];

export function getBreedsForSpecies(species: string): Breed[] {
  const data = SPECIES_BREEDS_DATA.find(s => s.species === species);
  return data ? data.breeds : [];
}

export function getBreedNamesForSpecies(species: string): string[] {
  const breeds = getBreedsForSpecies(species);
  return breeds.map(b => b.name);
}

export function getAllSpecies(): string[] {
  return SPECIES_BREEDS_DATA.map(s => s.species);
}

export function addBreed(species: PetCategory, breedName: string): Breed {
  const data = SPECIES_BREEDS_DATA.find(s => s.species === species);
  if (!data) {
    throw new Error(`Species ${species} not found`);
  }

  const id = breedName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  
  // Check if breed already exists
  const existing = data.breeds.find(b => b.id === id || b.name.toLowerCase() === breedName.toLowerCase());
  if (existing) {
    return existing;
  }

  const newBreed: Breed = {
    id,
    name: breedName,
    category: species
  };

  // Insert before "Other" if it exists, otherwise at the end
  const otherIndex = data.breeds.findIndex(b => b.id.startsWith('other-'));
  if (otherIndex !== -1) {
    data.breeds.splice(otherIndex, 0, newBreed);
  } else {
    data.breeds.push(newBreed);
  }

  return newBreed;
}

export function removeBreed(species: PetCategory, breedId: string): boolean {
  const data = SPECIES_BREEDS_DATA.find(s => s.species === species);
  if (!data) return false;

  const index = data.breeds.findIndex(b => b.id === breedId);
  if (index !== -1) {
    data.breeds.splice(index, 1);
    return true;
  }
  return false;
}
</file>

<file path="lib/data/supplements.ts">
export interface Supplement {
  name: string;
  description: string;
  benefits: string;
  amazonLink?: string;
}

export interface HealthConcernSupplements {
  [concern: string]: Supplement[];
}

export interface PetSupplements {
  [species: string]: HealthConcernSupplements;
}

export const petSupplements: PetSupplements = {
  dogs: {
    'allergy-support': [
      {
        name: 'Omega-3 Fatty Acids',
        description: 'Fish oil or krill oil supplements',
        benefits: 'Reduces inflammation and supports immune response',
        amazonLink: 'https://www.amazon.com/Zesty-Paws-Omega-Bites-Salmon-Supplement/dp/B07P9Q7Z8Z'
      },
      {
        name: 'Quercetin',
        description: 'Natural antihistamine supplement',
        benefits: 'Helps manage allergic reactions and inflammation',
        amazonLink: 'https://www.amazon.com/s?k=dog+quercetin+supplement'
      },
      {
        name: 'Curcumin (Turmeric)',
        description: 'Turmeric extract with enhanced bioavailability',
        benefits: 'Powerful anti-inflammatory properties',
        amazonLink: 'https://www.amazon.com/s?k=dog+curcumin+supplement'
      },
      {
        name: 'Probiotics',
        description: 'Gut health supplements for dogs',
        benefits: 'Supports digestive health and immune function',
        amazonLink: 'https://www.amazon.com/s?k=dog+probiotics'
      }
    ],
    'weight-management': [
      {
        name: 'L-Carnitine',
        description: 'Amino acid supplement for metabolism',
        benefits: 'Supports fat metabolism and energy production',
        amazonLink: 'https://www.amazon.com/s?k=dog+l+carnitine+supplement'
      },
      {
        name: 'Fiber Supplements',
        description: 'Psyllium husk or other fiber sources',
        benefits: 'Promotes satiety and digestive health',
        amazonLink: 'https://www.amazon.com/s?k=dog+fiber+supplement'
      }
    ],
    'digestive-health': [
      {
        name: 'Probiotics',
        description: 'Beneficial bacteria supplements',
        benefits: 'Restores gut microbiome balance',
        amazonLink: 'https://www.amazon.com/s?k=dog+probiotics'
      },
      {
        name: 'Digestive Enzymes',
        description: 'Enzyme supplements for better digestion',
        benefits: 'Aids in breaking down food components',
        amazonLink: 'https://www.amazon.com/s?k=dog+digestive+enzymes'
      },
      {
        name: 'Pumpkin Powder',
        description: 'Natural fiber source',
        benefits: 'Supports digestive regularity',
        amazonLink: 'https://www.amazon.com/s?k=dog+pumpkin+powder'
      }
    ],
    'joint-mobility': [
      {
        name: 'Glucosamine & Chondroitin',
        description: 'Joint health supplements',
        benefits: 'Supports cartilage health and joint mobility',
        amazonLink: 'https://www.amazon.com/s?k=dog+glucosamine+chondroitin'
      },
      {
        name: 'Green-Lipped Mussel',
        description: 'Natural joint supplement',
        benefits: 'Provides omega-3s and glycosaminoglycans',
        amazonLink: 'https://www.amazon.com/s?k=dog+green+lipped+mussel'
      },
      {
        name: 'MSM (Methylsulfonylmethane)',
        description: 'Sulfur compound for joints',
        benefits: 'Supports connective tissue health',
        amazonLink: 'https://www.amazon.com/s?k=dog+msm+supplement'
      }
    ],
    'skin-coat': [
      {
        name: 'Salmon Oil',
        description: 'Omega-3 rich fish oil',
        benefits: 'Promotes healthy skin and shiny coat',
        amazonLink: 'https://www.amazon.com/s?k=dog+salmon+oil'
      },
      {
        name: 'Biotin',
        description: 'Vitamin B7 supplement',
        benefits: 'Supports hair growth and coat quality',
        amazonLink: 'https://www.amazon.com/s?k=dog+biotin+supplement'
      },
      {
        name: 'Vitamin E',
        description: 'Antioxidant vitamin',
        benefits: 'Protects skin cells and supports healing',
        amazonLink: 'https://www.amazon.com/s?k=dog+vitamin+e'
      }
    ],
    'dental-health': [
      {
        name: 'Dental Chews',
        description: 'Enzymatic dental treats',
        benefits: 'Reduces plaque and tartar buildup',
        amazonLink: 'https://www.amazon.com/s?k=dog+dental+chews'
      },
      {
        name: 'Oral Probiotics',
        description: 'Probiotics for oral health',
        benefits: 'Maintains healthy oral microbiome',
        amazonLink: 'https://www.amazon.com/s?k=dog+oral+probiotics'
      }
    ],
    'kidney-urinary': [
      {
        name: 'Kidney Support Supplements',
        description: 'Antioxidant blends for kidney health',
        benefits: 'Supports kidney function and urinary health',
        amazonLink: 'https://www.amazon.com/s?k=dog+kidney+support+supplement'
      },
      {
        name: 'Cranberry Extract',
        description: 'Urinary tract support',
        benefits: 'Promotes urinary tract health',
        amazonLink: 'https://www.amazon.com/s?k=dog+cranberry+supplement'
      }
    ]
  },
  cats: {
    'allergy-support': [
      {
        name: 'Omega-3 Fatty Acids',
        description: 'Fish oil supplements for cats',
        benefits: 'Reduces inflammation and supports skin health',
        amazonLink: 'https://www.amazon.com/s?k=cat+omega+3+supplements'
      },
      {
        name: 'Quercetin',
        description: 'Natural antihistamine for cats',
        benefits: 'Helps manage allergic reactions',
        amazonLink: 'https://www.amazon.com/s?k=cat+quercetin+supplement'
      },
      {
        name: 'Curcumin',
        description: 'Turmeric extract for cats',
        benefits: 'Anti-inflammatory properties',
        amazonLink: 'https://www.amazon.com/s?k=cat+curcumin+supplement'
      }
    ],
    'weight-management': [
      {
        name: 'L-Carnitine',
        description: 'Metabolism support for cats',
        benefits: 'Supports fat metabolism',
        amazonLink: 'https://www.amazon.com/s?k=cat+l+carnitine+supplement'
      },
      {
        name: 'Fiber Supplements',
        description: 'Cat-safe fiber sources',
        benefits: 'Promotes healthy weight management',
        amazonLink: 'https://www.amazon.com/s?k=cat+fiber+supplement'
      }
    ],
    'digestive-health': [
      {
        name: 'Cat Probiotics',
        description: 'Probiotic supplements for cats',
        benefits: 'Supports digestive and immune health',
        amazonLink: 'https://www.amazon.com/s?k=cat+probiotics'
      },
      {
        name: 'Hairball Remedies',
        description: 'Hairball control supplements',
        benefits: 'Prevents and manages hairballs',
        amazonLink: 'https://www.amazon.com/s?k=cat+hairball+supplement'
      },
      {
        name: 'Digestive Enzymes',
        description: 'Enzyme supplements for cats',
        benefits: 'Aids in food digestion',
        amazonLink: 'https://www.amazon.com/s?k=cat+digestive+enzymes'
      }
    ],
    'joint-mobility': [
      {
        name: 'Glucosamine for Cats',
        description: 'Joint supplements formulated for cats',
        benefits: 'Supports joint health and mobility',
        amazonLink: 'https://www.amazon.com/s?k=cat+glucosamine+supplement'
      },
      {
        name: 'Chondroitin',
        description: 'Cartilage support supplement',
        benefits: 'Maintains joint cartilage',
        amazonLink: 'https://www.amazon.com/s?k=cat+chondroitin+supplement'
      }
    ],
    'skin-coat': [
      {
        name: 'Salmon Oil for Cats',
        description: 'Omega-3 supplements for cats',
        benefits: 'Promotes healthy skin and coat',
        amazonLink: 'https://www.amazon.com/s?k=cat+salmon+oil'
      },
      {
        name: 'Vitamin E',
        description: 'Antioxidant for skin health',
        benefits: 'Supports skin healing and coat quality',
        amazonLink: 'https://www.amazon.com/s?k=cat+vitamin+e+supplement'
      },
      {
        name: 'Biotin',
        description: 'Vitamin B7 for cats',
        benefits: 'Supports hair growth and skin health',
        amazonLink: 'https://www.amazon.com/s?k=cat+biotin+supplement'
      }
    ],
    'dental-health': [
      {
        name: 'Cat Dental Chews',
        description: 'Dental treats for cats',
        benefits: 'Reduces plaque and promotes oral health',
        amazonLink: 'https://www.amazon.com/s?k=cat+dental+chews'
      },
      {
        name: 'Oral Probiotics for Cats',
        description: 'Oral health probiotics',
        benefits: 'Maintains healthy oral microbiome',
        amazonLink: 'https://www.amazon.com/s?k=cat+oral+probiotics'
      }
    ],
    'kidney-urinary': [
      {
        name: 'Kidney Support for Cats',
        description: 'Supplements for feline kidney health',
        benefits: 'Supports kidney function with appropriate nutrients',
        amazonLink: 'https://www.amazon.com/s?k=cat+kidney+support+supplement'
      },
      {
        name: 'Cranberry Extract for Cats',
        description: 'Urinary tract support',
        benefits: 'Promotes urinary tract health',
        amazonLink: 'https://www.amazon.com/s?k=cat+cranberry+supplement'
      }
    ]
  },
  birds: {
    'digestive-health': [
      {
        name: 'Avian Probiotics',
        description: 'Probiotics formulated for birds',
        benefits: 'Supports digestive health and nutrient absorption',
        amazonLink: 'https://www.amazon.com/s?k=bird+probiotics'
      },
      {
        name: 'Calcium Supplements',
        description: 'Calcium for egg-laying birds',
        benefits: 'Supports bone health and eggshell quality',
        amazonLink: 'https://www.amazon.com/s?k=bird+calcium+supplement'
      }
    ],
    'skin-coat': [
      {
        name: 'Feather Supplements',
        description: 'Molt support with vitamins',
        benefits: 'Supports feather health and molting',
        amazonLink: 'https://www.amazon.com/s?k=bird+feather+supplement'
      },
      {
        name: 'Omega Fatty Acids',
        description: 'Essential fatty acids for birds',
        benefits: 'Promotes healthy skin and feather condition',
        amazonLink: 'https://www.amazon.com/s?k=bird+omega+supplement'
      }
    ],
    'dental-health': [
      {
        name: 'Cuttlebone',
        description: 'Natural calcium source',
        benefits: 'Supports beak health and calcium intake',
        amazonLink: 'https://www.amazon.com/s?k=bird+cuttlebone'
      },
      {
        name: 'Mineral Blocks',
        description: 'Mineral supplements for birds',
        benefits: 'Provides essential minerals for beak maintenance',
        amazonLink: 'https://www.amazon.com/s?k=bird+mineral+block'
      }
    ]
  },
  reptiles: {
    'digestive-health': [
      {
        name: 'Reptile Probiotics',
        description: 'Probiotic supplements for reptiles',
        benefits: 'Supports digestive health and gut flora',
        amazonLink: 'https://www.amazon.com/s?k=reptile+probiotics'
      },
      {
        name: 'Gut Load Supplements',
        description: 'Supplements for feeder insects',
        benefits: 'Provides nutrition to reptile food sources',
        amazonLink: 'https://www.amazon.com/s?k=gut+load+supplement'
      }
    ],
    'joint-mobility': [
      {
        name: 'Calcium with Vitamin D3',
        description: 'Calcium supplements for reptiles',
        benefits: 'Supports bone health and prevents metabolic bone disease',
        amazonLink: 'https://www.amazon.com/s?k=reptile+calcium+vitamin+d3'
      },
      {
        name: 'Vitamin A Supplements',
        description: 'Vitamin A for reptiles',
        benefits: 'Supports tissue health and immune function',
        amazonLink: 'https://www.amazon.com/s?k=reptile+vitamin+a+supplement'
      }
    ],
    'skin-coat': [
      {
        name: 'Vitamin A',
        description: 'Vitamin A supplements',
        benefits: 'Supports skin shedding and tissue health',
        amazonLink: 'https://www.amazon.com/s?k=reptile+vitamin+a'
      },
      {
        name: 'Humidity Supplements',
        description: 'Products to support humidity needs',
        benefits: 'Aids in proper shedding and skin health',
        amazonLink: 'https://www.amazon.com/s?k=reptile+humidity+supplement'
      }
    ]
  },
  'pocket-pets': {
    'digestive-health': [
      {
        name: 'Rodent Probiotics',
        description: 'Probiotics for small pets',
        benefits: 'Supports digestive health and gut microbiome',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+probiotics'
      },
      {
        name: 'Soluble Fiber',
        description: 'Fiber supplements like oat bran',
        benefits: 'Promotes digestive regularity',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+fiber+supplement'
      }
    ],
    'skin-coat': [
      {
        name: 'Omega Fatty Acids',
        description: 'Essential fatty acids for small pets',
        benefits: 'Supports healthy skin and coat',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+omega+supplement'
      },
      {
        name: 'Vitamin E',
        description: 'Antioxidant vitamin',
        benefits: 'Supports skin health and healing',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+vitamin+e'
      },
      {
        name: 'Biotin',
        description: 'Vitamin B7 supplement',
        benefits: 'Supports hair growth and coat quality',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+biotin'
      }
    ],
    'dental-health': [
      {
        name: 'Mineral Blocks',
        description: 'Chewable mineral supplements',
        benefits: 'Supports dental health through natural chewing',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+mineral+block'
      },
      {
        name: 'Chew Toys',
        description: 'Dental chews and toys',
        benefits: 'Promotes dental wear and oral health',
        amazonLink: 'https://www.amazon.com/s?k=small+pet+chew+toys'
      }
    ]
  }
};
</file>

<file path="lib/data/unifiedIngredientRegistry.ts">
// lib/data/unifiedIngredientRegistry.ts
// Unified Ingredient Registry - Single source of truth for all ingredient data
// Consolidates: ingredientCompositions, allIngredients, vetted-species-map, vetted-products

import { INGREDIENT_COMPOSITIONS, type IngredientComposition, type SpeciesCompatibility } from './ingredientCompositions';
import { VETTED_PRODUCTS } from './vetted-products';
import { VETTED_SPECIES_MAP } from './vetted-species-map';
import { ALL_INGREDIENTS } from '../utils/allIngredients';
import { getFallbackNutrition } from '../utils/nutritionFallbacks';

export type Species = 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
export type IngredientCategory = 'protein' | 'grain' | 'vegetable' | 'fruit' | 'supplement' | 'fat' | 'insect' | 'hay' | 'pellet' | 'seed' | 'nut';

/**
 * Unified ingredient structure - single source of truth
 */
export interface UnifiedIngredient {
  // Canonical ID (primary key) - snake_case format
  id: string; // e.g., 'chicken_breast'
  
  // Display names (all variations found across the system)
  displayNames: string[]; // ['Chicken Breast', 'chicken breast', 'Chicken breast', 'Ground Chicken']
  
  // Primary display name (most common)
  primaryDisplayName: string;
  
  // Nutrition data (from ingredientCompositions or fallback)
  nutrition: IngredientComposition;
  
  // Species compatibility (consolidated from multiple sources)
  speciesCompatibility: Record<Species, SpeciesCompatibility | null>;
  
  // Species availability (from vetted-species-map)
  availableForSpecies: Species[];
  
  // Vetted product links (from vetted-products)
  vettedProducts?: Array<{
    productName: string;
    asinLink: string;
    purchaseLink?: string;
    chewyLink?: string;
    specialtyLink?: string;
    vetNote?: string;
    category?: string;
  }>;
  
  // Category for meal builder (detected from usage)
  category: IngredientCategory;
  
  // Categories by species (from allIngredients)
  categoriesBySpecies?: Record<Species, IngredientCategory[]>;
  
  // Confidence level for nutrition data
  nutritionConfidence: 'high' | 'medium' | 'low';
  
  // Whether this uses fallback nutrition
  usesFallbackNutrition: boolean;
}

/**
 * Normalize ingredient name to canonical ID format
 */
function normalizeToId(name: string): string {
  return name
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '');
}

/**
 * Detect category from ingredient name
 */
function detectCategory(name: string, species?: Species): IngredientCategory {
  const lower = name.toLowerCase();
  
  // Protein detection
  if (lower.match(/\b(chicken|turkey|beef|lamb|fish|salmon|tuna|meat|protein|pork|duck|organ|heart|liver|kidney|venison|rabbit|quail)\b/)) {
    return 'protein';
  }
  
  // Insect detection
  if (lower.match(/\b(cricket|mealworm|roach|dubia|insect|superworm|hornworm|silkworm|waxworm|phoenix|black.*soldier.*fly|bsfl)\b/)) {
    return 'insect';
  }
  
  // Vegetable detection
  if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|squash|vegetable|green|collard|mustard|turnip|dandelion|arugula|endive|escarole|bok.*choy|cabbage|celery|asparagus|fennel|parsley|zucchini|cucumber|eggplant|leek|shallot|radicchio|frisee|mache|watercress|purslane|swiss.*chard|beet.*green)\b/)) {
    return 'vegetable';
  }
  
  // Fruit detection
  if (lower.match(/\b(apple|berry|mango|papaya|banana|fruit|grape|melon|cantaloupe|honeydew|watermelon|pineapple|kiwi|raspberry|blackberry|cranberry|cherry|pear|peach|plum|apricot|fig|date|raisin|currant|goji|mulberry|elderberry|strawberry|blueberry)\b/)) {
    return 'fruit';
  }
  
  // Nut detection (before seeds, as nuts are more specific)
  if (lower.match(/\b(almond|walnut|pecan|cashew|hazelnut|pistachio|macadamia|brazil.*nut|pine.*nut|chestnut|peanut|nut)\b/)) {
    return 'nut';
  }
  
  // Seed detection (for birds/pocket-pets - NOT grains)
  if (lower.match(/\b(millet|canary.*seed|niger|nyjer|hemp.*seed|flax.*seed|chia.*seed|sesame.*seed|sunflower.*seed|pumpkin.*seed|safflower|poppy.*seed|seed)\b/)) {
    return 'seed';
  }
  
  // Grain detection (carbs for mammals)
  if (lower.match(/\b(rice|oats|quinoa|barley|wheat|grain|amaranth|buckwheat|teff|corn|maize|groat)\b/)) {
    return 'grain';
  }
  
  // Hay detection
  if (lower.match(/\b(hay|timothy|alfalfa|grass|meadow|orchard|bermuda|bluegrass|fescue|ryegrass|straw|dried.*grass)\b/)) {
    return 'hay';
  }
  
  // Pellet detection
  if (lower.match(/\b(pellet|fortified.*pellet)\b/)) {
    return 'pellet';
  }
  
  // Supplement detection (includes fish oils only)
  if (lower.match(/\b(supplement|vitamin|calcium|taurine|fortified|cuttlebone|grit|probiotic|enzyme|glucosamine|chondroitin|omega|epa|dha|antioxidant|spirulina|kelp|brewer.*yeast|electrolyte|amino.*acid|joint.*health|fish.*oil|salmon.*oil|anchovy.*oil|mackerel.*oil|krill.*oil|cod.*liver.*oil|sardine.*oil|tuna.*oil|herring.*oil)\b/)) {
    return 'supplement';
  }
  
  // Fat/Oil detection (non-fish oils)
  if (lower.match(/\b(oil|fat|coconut.*oil|olive.*oil|flax.*oil|hemp.*oil|algae.*oil|wheat.*germ.*oil|canola.*oil|sunflower.*oil|safflower.*oil|avocado.*oil|lard|tallow|schmaltz|suet)\b/)) {
    return 'fat';
  }
  
  return 'protein'; // Default fallback
}

/**
 * Get species compatibility from multiple sources
 */
function getSpeciesCompatibility(id: string, displayNames: string[]): Record<Species, SpeciesCompatibility | null> {
  const compat: Record<Species, SpeciesCompatibility | null> = {
    dog: null,
    cat: null,
    bird: null,
    reptile: null,
    'pocket-pet': null,
  };
  
  // First, check ingredientCompositions
  const composition = INGREDIENT_COMPOSITIONS[id];
  if (composition?.speciesCompatibility) {
    Object.assign(compat, composition.speciesCompatibility);
  }
  
  // Then, check vetted-species-map (which uses display names)
  for (const displayName of displayNames) {
    const vettedKey = displayName.toLowerCase();
    const vettedSpecies = VETTED_SPECIES_MAP[vettedKey];
    if (vettedSpecies) {
      // If in vetted map, assume 'ok' for those species
      vettedSpecies.forEach(species => {
        if (compat[species as Species] === null) {
          compat[species as Species] = 'ok';
        }
      });
    }
  }
  
  return compat;
}

/**
 * Get available species from vetted-species-map
 */
function getAvailableSpecies(displayNames: string[]): Species[] {
  const speciesSet = new Set<Species>();
  
  for (const displayName of displayNames) {
    const vettedKey = displayName.toLowerCase();
    const vettedSpecies = VETTED_SPECIES_MAP[vettedKey];
    if (vettedSpecies) {
      vettedSpecies.forEach(s => speciesSet.add(s as Species));
    }
  }
  
  return Array.from(speciesSet);
}

/**
 * Get vetted products for ingredient
 */
function getVettedProducts(displayNames: string[]): UnifiedIngredient['vettedProducts'] {
  const products: UnifiedIngredient['vettedProducts'] = [];
  
  for (const displayName of displayNames) {
    const vettedKey = displayName.toLowerCase();
    const vetted = VETTED_PRODUCTS[vettedKey];
    if (vetted) {
      products.push({
        productName: vetted.productName,
        asinLink: vetted.asinLink,
        purchaseLink: vetted.purchaseLink,
        chewyLink: vetted.chewyLink,
        specialtyLink: vetted.specialtyLink,
        vetNote: vetted.vetNote,
        category: vetted.category,
      });
    }
  }
  
  return products.length > 0 ? products : undefined;
}

/**
 * Get categories by species from allIngredients
 */
function getCategoriesBySpecies(id: string, displayNames: string[]): Record<Species, IngredientCategory[]> | undefined {
  const categoriesBySpecies: Record<Species, IngredientCategory[]> = {
    dog: [],
    cat: [],
    bird: [],
    reptile: [],
    'pocket-pet': [],
  };
  
  let hasCategories = false;
  
  // Check allIngredients structure
  Object.entries(ALL_INGREDIENTS).forEach(([species, speciesData]) => {
    // Normalize species key from ALL_INGREDIENTS (plural) to Species type (singular)
    let normalizedSpecies: Species;
    if (species === 'dogs') {
      normalizedSpecies = 'dog';
    } else if (species === 'cats') {
      normalizedSpecies = 'cat';
    } else if (species === 'birds') {
      normalizedSpecies = 'bird';
    } else if (species === 'reptiles') {
      normalizedSpecies = 'reptile';
    } else if (species === 'pocket-pets') {
      normalizedSpecies = 'pocket-pet';
    } else {
      normalizedSpecies = species as Species;
    }
    
    Object.entries(speciesData).forEach(([categoryName, ingredientList]) => {
      if (Array.isArray(ingredientList)) {
        const matches = ingredientList.filter(ing => {
          const normalizedIng = normalizeToId(ing);
          return normalizedIng === id || displayNames.some(dn => normalizeToId(dn) === normalizedIng);
        });
        
        if (matches.length > 0) {
          // Map category names to IngredientCategory
          let category: IngredientCategory = 'protein';
          if (categoryName === 'proteins' || categoryName === 'insects') {
            category = categoryName === 'insects' ? 'insect' : 'protein';
          } else if (categoryName === 'vegetables' || categoryName === 'hay') {
            category = categoryName === 'hay' ? 'hay' : 'vegetable';
          } else if (categoryName === 'fruits') {
            category = 'fruit';
          } else if (categoryName === 'seeds') {
            category = 'seed';
          } else if (categoryName === 'nuts') {
            category = 'nut';
          } else if (categoryName === 'carbs') {
            category = 'grain';  // Maps to 'carb' in final ingredient type
          } else if (categoryName === 'pellets') {
            category = 'pellet';
          } else if (categoryName === 'fats') {
            category = 'fat';
          } else if (categoryName === 'supplements' || categoryName === 'fiber_supplements') {
            category = 'supplement';
          }
          
          if (categoriesBySpecies[normalizedSpecies] && !categoriesBySpecies[normalizedSpecies].includes(category)) {
            categoriesBySpecies[normalizedSpecies].push(category);
            hasCategories = true;
          }
        }
      }
    });
  });
  
  return hasCategories ? categoriesBySpecies : undefined;
}

/**
 * Build unified ingredient from all sources
 */
function buildUnifiedIngredient(
  id: string,
  displayNames: string[],
  primaryDisplayName: string
): UnifiedIngredient {
  // Get nutrition data
  const composition = INGREDIENT_COMPOSITIONS[id];
  let nutrition: IngredientComposition;
  let usesFallback = false;
  let nutritionConfidence: 'high' | 'medium' | 'low' = 'high';
  
  if (composition) {
    nutrition = composition;
    // Check confidence from composition
    if (composition.confidenceBySpecies) {
      const confidences = Object.values(composition.confidenceBySpecies);
      if (confidences.includes('low')) {
        nutritionConfidence = 'low';
      } else if (confidences.includes('medium')) {
        nutritionConfidence = 'medium';
      }
    }
  } else {
    // Try fallback
    const fallback = getFallbackNutrition(primaryDisplayName);
    if (fallback) {
      nutrition = fallback;
      usesFallback = true;
      nutritionConfidence = 'low';
    } else {
      // Last resort: minimal placeholder
      nutrition = {
        protein: 0,
        fat: 0,
        calcium: 0,
        phosphorus: 0,
        moisture: 0,
        kcal: 0,
        source: 'placeholder',
        needsReview: true,
      };
      usesFallback = true;
      nutritionConfidence = 'low';
    }
  }
  
  // Get species compatibility
  const speciesCompatibility = getSpeciesCompatibility(id, displayNames);
  
  // Get available species
  const availableForSpecies = getAvailableSpecies(displayNames);
  
  // Get vetted products
  const vettedProducts = getVettedProducts(displayNames);
  
  // Detect category
  const category = detectCategory(primaryDisplayName);
  
  // Get categories by species
  const categoriesBySpecies = getCategoriesBySpecies(id, displayNames);
  
  return {
    id,
    displayNames,
    primaryDisplayName,
    nutrition,
    speciesCompatibility,
    availableForSpecies,
    vettedProducts,
    category,
    categoriesBySpecies,
    nutritionConfidence,
    usesFallbackNutrition: usesFallback,
  };
}

/**
 * Build unified registry from all sources
 * This is a one-time migration that consolidates all ingredient data
 */
function buildRegistry(): Map<string, UnifiedIngredient> {
  const registry = new Map<string, UnifiedIngredient>();
  const nameToIdMap = new Map<string, string>(); // Map display names to IDs
  
  // Step 1: Collect all ingredient names from allIngredients
  const allIngredientNames = new Set<string>();
  Object.values(ALL_INGREDIENTS).forEach(speciesData => {
    Object.values(speciesData).forEach(ingredientList => {
      if (Array.isArray(ingredientList)) {
        ingredientList.forEach(ing => allIngredientNames.add(ing));
      }
    });
  });
  
  // Step 2: Collect from ingredientCompositions
  Object.keys(INGREDIENT_COMPOSITIONS).forEach(id => {
    const comp = INGREDIENT_COMPOSITIONS[id];
    if (comp.name) {
      allIngredientNames.add(comp.name);
    }
    allIngredientNames.add(id.replace(/_/g, ' ')); // Add display version of ID
  });
  
  // Step 3: Collect from vetted-products and vetted-species-map
  Object.keys(VETTED_PRODUCTS).forEach(name => allIngredientNames.add(name));
  Object.keys(VETTED_SPECIES_MAP).forEach(name => allIngredientNames.add(name));
  
  // Step 4: Group names by canonical ID
  const idToNames = new Map<string, Set<string>>();
  
  allIngredientNames.forEach(name => {
    const id = normalizeToId(name);
    if (!idToNames.has(id)) {
      idToNames.set(id, new Set());
    }
    idToNames.get(id)!.add(name);
    nameToIdMap.set(name.toLowerCase(), id);
  });
  
  // Step 5: Build unified ingredients
  idToNames.forEach((names, id) => {
    const nameArray = Array.from(names);
    const primaryName = nameArray[0] || id.replace(/_/g, ' ');
    const unified = buildUnifiedIngredient(id, nameArray, primaryName);
    registry.set(id, unified);
  });
  
  return registry;
}

// Build registry on module load (cached)
let _registry: Map<string, UnifiedIngredient> | null = null;
let _nameToIdMap: Map<string, string> | null = null;

function getRegistry(): Map<string, UnifiedIngredient> {
  if (!_registry) {
    console.log('[Registry] Building ingredient registry...');
    _registry = buildRegistry();
    console.log(`[Registry] Built ${_registry.size} ingredients`);
    
    // Log category breakdown
    const byCategory: Record<string, number> = {};
    _registry.forEach(ing => {
      byCategory[ing.category] = (byCategory[ing.category] || 0) + 1;
    });
    console.log('[Registry] By category:', byCategory);
  }
  return _registry;
}

function getNameToIdMap(): Map<string, string> {
  if (!_nameToIdMap) {
    _nameToIdMap = new Map<string, string>();
    getRegistry().forEach((ing, id) => {
      ing.displayNames.forEach(name => {
        _nameToIdMap!.set(name.toLowerCase(), id);
      });
    });
  }
  return _nameToIdMap;
}

/**
 * Get ingredient by canonical ID
 */
export function getIngredientById(id: string): UnifiedIngredient | null {
  const registry = getRegistry();
  return registry.get(id) || null;
}

/**
 * Get ingredient by display name (fuzzy match)
 */
export function getIngredientByName(name: string): UnifiedIngredient | null {
  const nameMap = getNameToIdMap();
  const normalized = name.toLowerCase().trim();
  const id = nameMap.get(normalized);
  
  if (id) {
    return getIngredientById(id);
  }
  
  // Try fuzzy match - normalize the input
  const normalizedId = normalizeToId(name);
  return getIngredientById(normalizedId);
}

/**
 * Normalize ingredient name to canonical ID
 */
export function normalizeIngredientName(name: string): string {
  const nameMap = getNameToIdMap();
  const normalized = name.toLowerCase().trim();
  const id = nameMap.get(normalized);
  
  if (id) {
    return id;
  }
  
  // Fallback to normalized version
  return normalizeToId(name);
}

/**
 * Get ingredients available for a species, optionally filtered by category
 */
export function getIngredientsForSpecies(
  species: Species,
  category?: IngredientCategory
): UnifiedIngredient[] {
  const registry = getRegistry();
  const ingredients: UnifiedIngredient[] = [];
  
  registry.forEach(ing => {
    // Check if available for species
    const isAvailable = ing.availableForSpecies.includes(species) ||
                       ing.speciesCompatibility[species] === 'ok' ||
                       ing.speciesCompatibility[species] === 'limit' ||
                       ing.speciesCompatibility[species] === 'caution';
    
    if (isAvailable) {
      // Filter by category if specified
      if (!category || ing.category === category || ing.categoriesBySpecies?.[species]?.includes(category)) {
        ingredients.push(ing);
      }
    }
  });
  
  return ingredients;
}

/**
 * Get all ingredients in a category
 */
export function getIngredientsByCategory(category: IngredientCategory): UnifiedIngredient[] {
  const registry = getRegistry();
  const ingredients: UnifiedIngredient[] = [];
  
  registry.forEach(ing => {
    if (ing.category === category) {
      ingredients.push(ing);
    }
  });
  
  return ingredients;
}

/**
 * Get all ingredients in the registry
 */
export function getAllIngredients(): UnifiedIngredient[] {
  return Array.from(getRegistry().values());
}

/**
 * Search ingredients by name (fuzzy)
 */
export function searchIngredients(query: string): UnifiedIngredient[] {
  const registry = getRegistry();
  const results: UnifiedIngredient[] = [];
  const queryLower = query.toLowerCase();
  
  registry.forEach(ing => {
    // Check if query matches any display name or ID
    const matches = ing.displayNames.some(name => name.toLowerCase().includes(queryLower)) ||
                   ing.id.includes(queryLower) ||
                   ing.primaryDisplayName.toLowerCase().includes(queryLower);
    
    if (matches) {
      results.push(ing);
    }
  });
  
  return results;
}
</file>

<file path="lib/data/verification-state.ts">
// Generated verification state - 2025-12-15T19:43:36.903Z
// High-confidence products are auto-verified, others need manual review

export interface VerificationState {
  ingredient: string;
  verified: boolean;
  needsReview: boolean;
  autoVerified: boolean;
}

export const INITIAL_VERIFICATION_STATE: VerificationState[] = [
  {
    "ingredient": "ground chicken",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground turkey",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground beef (lean)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "ground lamb",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "salmon (boneless)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken breast",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken thighs",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turkey breast",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "beef liver",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken liver",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken hearts",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sardines (canned in water)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "eggs",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turkey giblets",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken giblets",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "duck breast",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "venison",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "rabbit meat",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "quail",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground pork (lean)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "turkey necks",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "brown rice",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "white rice",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "quinoa",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sweet potato",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pumpkin puree",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "butternut squash",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "lentils",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "chickpeas",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "black beans",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "green peas",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "carrots",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "spinach",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "broccoli",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "zucchini",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "kale",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "celery",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "brussels sprouts",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "asparagus",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "parsley",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cucumber",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "lettuce (romaine)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "arugula",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "endive",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "escarole",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "dandelion greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "collard greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "mustard greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turnip greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "beet greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "radish greens",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "coconut oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "olive oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "salmon oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "flaxseed oil",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "fish oil",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "taurine powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "calcium carbonate",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "vitamin e",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "b-complex",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "probiotic powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "psyllium husk",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "joint supplement",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "omega-3 capsules",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "digestive enzymes",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "hairball paste",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken broth",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "vitamin e oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "millet (white/red)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "canary seed",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "niger seed",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "oat groats",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "hemp seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "flaxseeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sesame seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "chia seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "quinoa (cooked)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "rapeseed",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sunflower seeds (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pumpkin seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "bell peppers",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "corn (fresh)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "apples (no seeds)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "blueberries",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "strawberries",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "mango",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "banana",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "grapes (chopped)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "papaya",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "melon",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "egg (hard-boiled)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "pellets (fortified)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "cuttlebone",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "honey (tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "peanut butter (unsalted, tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "dubia roaches",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "crickets",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "mealworms",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "superworms",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "black soldier fly larvae",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "hornworms",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "acorn squash",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "figs",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "timothy hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "meadow hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "orchard grass hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "alfalfa hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "romaine lettuce",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cilantro",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "basil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "duck hearts",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "lamb liver",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "duck liver",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken necks",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turkey thighs",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground duck",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground lamb (lean)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground herring",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "ground mackerel",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "mackerel (canned)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "herring (canned)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicken sausage (no additives)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turkey sausage (no additives)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ground pork (lean, small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "regular potato",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "walnut oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "black currant oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "almond oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sunflower oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chia seed oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "herring oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "anchovy oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "evening primrose oil",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "mackerel oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sardine oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "borage oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sesame oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "avocado oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "avocado oil (tiny amounts)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "wheat germ oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "krill oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "algae oil (dha)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "omega-3 oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "kelp powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "joint health powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "amino acid supplement",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "calcium supplement",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "spirulina powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "electrolyte powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "vitamin d3 drops",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "buckwheat",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "buckwheat (tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "buckwheat (hulled)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sorghum",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "barley",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "barley (cooked, minimal)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "barley (hulled)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "millet",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "millet (tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "farro",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "bulgur",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "amaranth (tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "amaranth seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "teff seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "wheat (hulled)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "oat bran (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "oatmeal (cooked, small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "corn (cracked)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "safflower seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "nyjer seeds",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "bok choi",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "bok choy (small amounts)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "navy beans (mashed)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "kidney beans (mashed)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "kidney beans (mashed, tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pinto beans (mashed)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "purslane",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "purslane (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "flaxseed (ground)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "fennel",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "delicata squash",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "yellow squash",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "leeks",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "shallots",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "tomatoes (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "napa cabbage",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "napa cabbage (small amounts)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "artichokes",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "frisee",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "radicchio",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "red cabbage",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "green cabbage",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "swiss chard",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "swiss chard (cooked, tiny amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "lettuce (romaine, small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "red leaf lettuce",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "mache",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "alfalfa sprouts (small amounts)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cat grass (wheatgrass)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "squash (cooked)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "amaranth leaves",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "ginger (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "turmeric",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "rosemary",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sage",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "mint",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "garlic chives",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "raisins (unsweetened)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "plums (pitted)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "apricots (pitted)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "kiwi",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "mulberries",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "raspberries",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cranberries",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "pineapple (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pears (no seeds)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pinhead crickets",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "locusts",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "butterworms",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "grasshoppers",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "small dubia roaches",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "silkworms",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "earthworms",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "wheat hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "fescue hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "oat hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "bluegrass hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "straw (wheat/pine)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "dried grass",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "bermuda hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "barley hay",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "guinea pig pellets (with vitamin c)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "rabbit pellets (high fiber)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "hamster pellets (higher protein)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "wild bird mix",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "beta-glucans",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "biotin",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "bone broth (low sodium)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cauliflower",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "chicory root",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "chondroitin sulfate",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "cranberry extract",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "curcumin (turmeric extract)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "d-mannose",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "egg yolks",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "eggplant",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "eggshells (crushed)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "fish broth (no salt)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "fructooligosaccharides (fos)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "glucosamine sulfate",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "green beans",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "green beans (cooked)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "hairball control paste",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "hyaluronic acid",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "inulin (prebiotic)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "jerusalem artichoke",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "joint health supplement",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "l-carnitine powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "lysine powder",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "malabar spinach",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "mannanoligosaccharides (mos)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "milk thistle",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "new zealand spinach",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "niacinamide",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "oats (rolled)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "peas",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "peas (mashed)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "pectin (from apples)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "pumpkin seed oil",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "quail eggs",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "quercetin",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "rice (hulled)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "romanesco broccoli",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "s-adenosyl methionine (sam-e)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sardines (in water)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "snap peas",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "snow peas",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "snow peas (mashed)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "split peas",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "split peas (mashed)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "sugar snap peas",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "sugar snap peas (mashed)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "turkey broth (no salt)",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "vitamin b complex",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "vitamin c (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "watercress",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  },
  {
    "ingredient": "watercress (small amounts)",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "wheat germ",
    "verified": false,
    "needsReview": true,
    "autoVerified": false
  },
  {
    "ingredient": "wild rice",
    "verified": true,
    "needsReview": false,
    "autoVerified": true
  }
];
</file>

<file path="lib/data/vetted-products-generic.ts">
// lib/data/vetted-products.ts
// Comprehensive veterinarian-vetted product mappings for all recipe ingredients
// Each ingredient maps to a specific, high-quality product with direct Amazon ASIN link

interface VettedProduct {
  // The specific, branded name to display on the shopping list
  productName: string;
  // The direct Amazon search link using the specific product name
  amazonLink: string;
  // Chewy affiliate link (when available)
  chewyLink?: string;
  // Specialty vendor link (raw food, subscription services)
  specialtyLink?: string;
  // Primary purchase link (usually Amazon)
  purchaseLink?: string;
  // A short note explaining *why* this product was chosen (for the user)
  vetNote: string;
  // Category for shopping list grouping
  category?: 'Meat' | \\'supplement' | 'Carb' | 'Vegetable' | 'Oil' | \\'seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';
  // Commission rate estimate for prioritization
  commissionRate?: number;
}

// Map: [Generic Ingredient Name (lowercase)] -> VettedProduct
export const VETTED_PRODUCTS: Record<string, VettedProduct> = {
  // === PROTEINS (Dogs & Cats) ===
  'ground chicken': {
    productName: 'Ground chicken (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/fresh-is-best-freeze-dried-chicken/dp/148916',
    vetNote: 'High-quality, human-grade chicken breast that maintains nutritional value through freeze-drying.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground turkey': {
    productName: 'Ground turkey (Free Range)',
    amazonLink: 'https://www.amazon.com/dp/B091CCD4T7?tag=robinfrench-20',
    vetNote: 'Premium free-range turkey with optimal protein-to-fat ratio for canine health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground beef (lean)': {
    productName: 'Ground beef (lean)',
    amazonLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Grass-fed, human-grade beef with controlled fat content for weight management.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground lamb': {
    productName: 'Ground lamb (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Novel protein source ideal for dogs with chicken or beef allergies.',
    category: 'Meat',
    commissionRate: 0.03
  },
  \\'salmon (boneless)': {
    productName: \\'salmon (boneless) (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B08NCDSV82?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/better-treat-freeze-dried-salmon/dp/155916',
    vetNote: 'Wild-caught salmon providing essential omega-3 fatty acids for skin, coat, and joint health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken breast': {
    productName: 'Chicken breast',
    amazonLink: 'https://www.amazon.com/dp/B0787WTY4C?tag=robinfrench-20',
    vetNote: 'Air-chilled chicken breast with superior moisture retention and protein quality.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken thighs': {
    productName: 'Chicken thighs',
    amazonLink: 'https://www.amazon.com/dp/B0787YFWYB?tag=robinfrench-20',
    vetNote: 'Higher fat content than breast meat, providing more calories and flavor.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey breast': {
    productName: 'Turkey breast (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0CZRN7HXT?tag=robinfrench-20',
    vetNote: 'Lean turkey breast maintaining natural nutrients through gentle freeze-drying.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'beef liver': {
    productName: 'Beef liver (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B07G3QFG8N?tag=robinfrench-20',
    vetNote: 'Rich source of vitamin A, iron, and B vitamins essential for canine health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken liver': {
    productName: 'Chicken liver (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B07S8JCNTH?tag=robinfrench-20',
    vetNote: 'Concentrated nutrition with high vitamin content and natural enzymes.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken hearts': {
    productName: 'Chicken hearts (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Excellent taurine source and natural chews for dental health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  \\'sardines (canned in water)': {
    productName: \\'sardines (canned in water)',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Omega-3 rich fish with edible bones providing natural calcium and phosphorus.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'eggs': {
    productName: 'Eggs (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B001DY6U9M?tag=robinfrench-20',
    vetNote: 'Complete protein source with all essential amino acids and natural vitamins.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey giblets': {
    productName: 'Turkey giblets (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Natural organ meat mix providing comprehensive nutrition and enzymes.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken giblets': {
    productName: 'Chicken giblets (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    vetNote: 'Traditional organ meat blend with heart, liver, and gizzard for complete nutrition.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'duck breast': {
    productName: 'Duck breast (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B01KAOGE5U?tag=robinfrench-20',
    vetNote: 'Novel protein with healthy fat profile and rich flavor dogs love.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'venison': {
    productName: 'Venison (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Lean game meat ideal for dogs with allergies or weight management needs.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'rabbit meat': {
    productName: 'Rabbit meat (Grain Free)',
    amazonLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Hypoallergenic novel protein perfect for elimination diet trials.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'quail': {
    productName: 'Quail (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0DK1SJ2Z7?tag=robinfrench-20',
    vetNote: \\'small game bird providing novel protein and natural calcium from bones.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground pork (lean)': {
    productName: 'Ground pork (lean) (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0CLJW1P6D?tag=robinfrench-20',
    vetNote: 'Lean pork alternative for dogs that tolerate it, with good palatability.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey necks': {
    productName: 'Turkey necks (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0FHJ6G2NZ?tag=robinfrench-20',
    vetNote: 'Natural chews providing dental benefits and natural nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },

  // === CARBS, VEGETABLES & FATS (Dogs & Cats) ===
  'brown rice': {
    productName: 'Brown rice (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain rice providing complex carbohydrates and fiber for digestive health.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'white rice': {
    productName: 'White rice',
    amazonLink: 'https://www.amazon.com/dp/B00IDQY2PW?tag=robinfrench-20',
    vetNote: 'Easily digestible carbohydrate source for dogs with sensitive stomachs.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'quinoa': {
    productName: 'Quinoa (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07ZJNYGW4?tag=robinfrench-20',
    vetNote: 'Complete protein grain with all essential amino acids and gluten-free.',
    category: 'Carb',
    commissionRate: 0.03
  },
  \\'sweet potato': {
    productName: \\'sweet potato puree (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07D92VQ9C?tag=robinfrench-20',
    vetNote: 'Complex carbohydrate with beta-carotene and fiber for digestive health.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'pumpkin puree': {
    productName: 'Pumpkin puree (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0062A87HA?tag=robinfrench-20',
    vetNote: 'Natural soluble fiber for digestive health and stool regulation.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'butternut squash': {
    productName: 'Butternut squash puree (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000HDCSTG?tag=robinfrench-20',
    vetNote: 'Low-glycemic carbohydrate with beta-carotene and antioxidants.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'lentils': {
    productName: 'Red lentils (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000VDZ2GI?tag=robinfrench-20',
    vetNote: 'Plant-based protein and fiber source for balanced nutrition.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'chickpeas': {
    productName: 'Chickpeas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0BYPF1Y79?tag=robinfrench-20',
    vetNote: 'Protein-rich legume providing complex carbohydrates and minerals.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'black beans': {
    productName: 'Black beans (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B094WYT2BK?tag=robinfrench-20',
    vetNote: 'High-fiber legume with antioxidants and plant-based protein.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'green peas': {
    productName: 'Green peas (Frozen, Organic)',
    amazonLink: 'https://www.amazon.com/dp/B074H4SHTD?tag=robinfrench-20',
    vetNote: 'Natural source of plant protein and digestive fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'carrots': {
    productName: 'Carrots (Frozen, Organic)',
    amazonLink: 'https://www.amazon.com/dp/B074H64BPW?tag=robinfrench-20',
    vetNote: 'Beta-carotene rich vegetable supporting immune and vision health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'spinach': {
    productName: \\'spinach (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0013ABAJG?tag=robinfrench-20',
    vetNote: 'Iron-rich leafy green providing vitamins K, A, and folate.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'broccoli': {
    productName: 'Broccoli (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07SV522V9?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with antioxidants and vitamin C.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'zucchini': {
    productName: 'Zucchini (Frozen, Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07Q9WV1LY?tag=robinfrench-20',
    vetNote: 'Low-calorie vegetable providing hydration and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kale': {
    productName: 'Kale (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Nutrient-dense leafy green with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'celery': {
    productName: 'Celery (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Low-calorie crunchy vegetable providing hydration and fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'brussels sprouts': {
    productName: 'Brussels sprouts (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B004DAQPR0?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with sulforaphane for antioxidant support.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'asparagus': {
    productName: 'Asparagus (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07QV5G8HY?tag=robinfrench-20',
    vetNote: 'Diuretic vegetable supporting urinary tract health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'parsley': {
    productName: 'Parsley',
    amazonLink: 'https://www.amazon.com/dp/B0D8C4N4WY?tag=robinfrench-20',
    vetNote: 'Fresh herb providing chlorophyll and natural breath freshening.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cucumber': {
    productName: 'Cucumber (Frozen, Organic)',
    amazonLink: 'https://www.amazon.com/dp/B001PLETDC?tag=robinfrench-20',
    vetNote: 'Hydrating vegetable with natural electrolytes.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lettuce (romaine)': {
    productName: 'Lettuce (romaine) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Leafy green providing hydration and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'arugula': {
    productName: 'Arugula (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B00JXR8RYW?tag=robinfrench-20',
    vetNote: 'Peppery leafy green with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'endive': {
    productName: 'Endive (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20',
    vetNote: 'Bitter leafy green supporting liver health and digestion.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'escarole': {
    productName: 'Escarole (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B084ZVBGQ6?tag=robinfrench-20',
    vetNote: 'Mild leafy green providing folate and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'dandelion greens': {
    productName: 'Dandelion greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000WR4A5M?tag=robinfrench-20',
    vetNote: 'Natural diuretic supporting kidney and liver health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'collard greens': {
    productName: 'Collard greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000P6H23W?tag=robinfrench-20',
    vetNote: 'Calcium-rich leafy green for bone and dental health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mustard greens': {
    productName: 'Mustard greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B094JT2CCH?tag=robinfrench-20',
    vetNote: \\'spicy leafy green with antioxidants and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turnip greens': {
    productName: 'Turnip greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20',
    vetNote: 'Nutrient-dense greens with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'beet greens': {
    productName: 'Beet greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0F9LNFLTK?tag=robinfrench-20',
    vetNote: 'Iron-rich greens supporting red blood cell production.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'radish greens': {
    productName: 'Radish greens (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07CHNV4S1?tag=robinfrench-20',
    vetNote: 'Peppery greens providing vitamin C and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'coconut oil': {
    productName: 'Coconut oil (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B00UHCJKVG?tag=robinfrench-20',
    vetNote: 'Medium-chain triglycerides for quick energy and cognitive support.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'olive oil': {
    productName: 'Olive oil',
    amazonLink: 'https://www.amazon.com/dp/B00GGBLPVU?tag=robinfrench-20',
    vetNote: 'Monounsaturated fats with antioxidants for skin and coat health.',
    category: 'Oil',
    commissionRate: 0.03
  },
  \\'salmon oil': {
    productName: \\'salmon oil',
    amazonLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/grizzly-salmon-oil-omega-3-wild/dp/148916',
    vetNote: 'Concentrated omega-3 fatty acids for joint, skin, and heart health.',
    category: 'Oil',
    commissionRate: 0.08
  },
  'flaxseed oil': {
    productName: "Flaxseed oil\\'s Organic Flax Oil",
    amazonLink: 'https://www.amazon.com/dp/B002VLZ830?tag=robinfrench-20',
    vetNote: 'Plant-based omega-3 source for skin and coat conditioning.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'fish oil': {
    productName: 'Fish oil',
    amazonLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Purified fish oil with optimal EPA/DHA ratio for canine health.',
    category: 'Oil',
    commissionRate: 0.03
  },

  // === SUPPLEMENTS (Dogs & Cats) ===
  'taurine powder': {
    productName: 'Taurine powder',
    amazonLink: 'https://www.amazon.com/dp/B00VAOKFO6?tag=robinfrench-20',
    vetNote: 'Essential amino acid for heart health and vision support in cats.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'calcium carbonate': {
    productName: 'Calcium carbonate',
    amazonLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Highly bioavailable calcium source for bone health and metabolic balance.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'vitamin e': {
    productName: 'Vitamin e',
    amazonLink: 'https://www.amazon.com/dp/B01I5OB3LW?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and skin health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'b-complex': {
    productName: 'B-complex',
    amazonLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism and nervous system health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'probiotic powder': {
    productName: 'Probiotic powder',
    amazonLink: 'https://www.amazon.com/dp/B0BGV8L7L2?tag=robinfrench-20',
    vetNote: 'Veterinarian-recommended probiotic for digestive health and immune support.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'psyllium husk': {
    productName: 'Psyllium husk (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0016AXN7A?tag=robinfrench-20',
    vetNote: \\'soluble fiber for digestive health and hairball prevention in cats.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'joint supplement': {
    productName: 'Joint supplement',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine supplement for joint health and mobility.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'omega-3 capsules': {
    productName: 'Omega-3 capsules',
    amazonLink: 'https://www.amazon.com/dp/B004OA5XP4?tag=robinfrench-20',
    vetNote: 'Purified fish oil capsules providing EPA/DHA for skin, coat, and joint health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'digestive enzymes': {
    productName: 'Digestive enzymes',
    amazonLink: 'https://www.amazon.com/dp/B00O6FINFO?tag=robinfrench-20',
    vetNote: 'Enzyme blend supporting digestion of proteins, fats, and carbohydrates.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'hairball paste': {
    productName: 'Hairball paste',
    amazonLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'chicken broth': {
    productName: 'Chicken broth',
    amazonLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'vitamin e oil': {
    productName: 'Vitamin e oil',
    amazonLink: 'https://www.amazon.com/dp/B0DZ5ZCC85?tag=robinfrench-20',
    vetNote: 'Natural vitamin E oil for topical skin health and antioxidant support.',
    category: 'Oil',
    commissionRate: 0.03
  },

  // === BIRDS ===
  'millet (white/red)': {
    productName: "Millet (white/red)\\'s Parrot Food White Millet Spray",
    amazonLink: 'https://www.amazon.com/dp/B0002DH3FU?tag=robinfrench-20',
    vetNote: 'High-quality millet spray for parrots and hookbills.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'canary seed': {
    productName: "Millet (white/red)\\'s Parrot Food Canary Seed",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Traditional canary seed mix for small birds.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'niger seed': {
    productName: "Millet (white/red)\\'s Parrot Food Niger Seed",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Thistle seed attracting finches and small songbirds.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'oat groats': {
    productName: "Millet (white/red)\\'s Parrot Food Oat Groats",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Whole oat groats for larger parrots and hookbills.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'hemp seeds': {
    productName: "Millet (white/red)\\'s Parrot Food Hemp Seed",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Nutrient-rich hemp seeds for feather health.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'flaxseeds': {
    productName: "Millet (white/red)\\'s Parrot Food Flax Seed",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Omega-3 rich flax seeds for skin and feather health.',
    category: \\'seed',
    commissionRate: 0.03
  },
  \\'sesame seeds': {
    productName: "Millet (white/red)\\'s Parrot Food Sesame Seed",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Calcium-rich sesame seeds for bone health.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'chia seeds': {
    productName: "Millet (white/red)\\'s Parrot Food Chia Seed",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Hydrating chia seeds providing omega-3s and fiber.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'quinoa (cooked)': {
    productName: "Millet (white/red)\\'s Parrot Food Cooked Quinoa",
    amazonLink: 'https://www.amazon.com/dp/B001CCOVB4?tag=robinfrench-20',
    vetNote: 'Complete protein grain for avian nutrition.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'rapeseed': {
    productName: "Millet (white/red)\\'s Parrot Food Rapeseed",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Canola/rapeseed for additional dietary variety.',
    category: \\'seed',
    commissionRate: 0.03
  },
  \\'sunflower seeds (small amounts)': {
    productName: "Millet (white/red)\\'s Parrot Food Sunflower Seed",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'High-fat seeds to be fed in moderation.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'pumpkin seeds': {
    productName: "Millet (white/red)\\'s Parrot Food Pumpkin Seed",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Nutrient-dense seeds with natural deworming properties.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'bell peppers': {
    productName: 'Bell peppers (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000P6J14K?tag=robinfrench-20',
    vetNote: 'Vitamin C rich peppers for immune health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'corn (fresh)': {
    productName: 'Corn (fresh) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000REL738?tag=robinfrench-20',
    vetNote: 'Fresh corn providing carbohydrates and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'apples (no seeds)': {
    productName: 'Apples (no seeds) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B00AR0TG44?tag=robinfrench-20',
    vetNote: 'Vitamin-rich fruit providing natural sugars and fiber.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'blueberries': {
    productName: "Blueberries\\'s Organic Blueberries",
    amazonLink: 'https://www.amazon.com/dp/B07Z568Y3N?tag=robinfrench-20',
    vetNote: 'Antioxidant-rich berries for immune and cognitive health.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  \\'strawberries': {
    productName: "Blueberries\\'s Organic Strawberries",
    amazonLink: 'https://www.amazon.com/dp/B002B8Z98W?tag=robinfrench-20',
    vetNote: 'Vitamin C rich berries providing natural hydration.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'mango': {
    productName: 'Mango (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Tropical fruit providing beta-carotene and vitamin C.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'banana': {
    productName: 'Banana (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07ZLFKBFD?tag=robinfrench-20',
    vetNote: 'Potassium-rich fruit for electrolyte balance.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'grapes (chopped)': {
    productName: 'Grapes (chopped) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000RGYJI6?tag=robinfrench-20',
    vetNote: 'Hydrating fruit providing natural antioxidants.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'papaya': {
    productName: 'Papaya (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07FZ159ZB?tag=robinfrench-20',
    vetNote: 'Digestive enzyme-rich fruit for gut health.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'melon': {
    productName: 'Melon (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000NSGULC?tag=robinfrench-20',
    vetNote: 'High-water content fruit for hydration.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'egg (hard-boiled)': {
    productName: 'Egg (hard-boiled) (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Calcium and protein-rich egg treats for birds.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'pellets (fortified)': {
    productName: "Millet (white/red)\\'s Parrot Food Pellets",
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Complete nutrition pellets formulated for avian health.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'cuttlebone': {
    productName: "Millet (white/red)\\'s Parrot Food Cuttlebone",
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Natural calcium source for beak and bone health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'honey (tiny amounts)': {
    productName: 'Honey (tiny amounts) (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B0791X9GSG?tag=robinfrench-20',
    vetNote: 'Natural sweetener and antimicrobial properties (use sparingly).',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'peanut butter (unsalted, tiny amounts)': {
    productName: 'Peanut butter (unsalted, tiny amounts)',
    amazonLink: 'https://www.amazon.com/dp/B06ZXZ3JPZ?tag=robinfrench-20',
    vetNote: 'Healthy fat source for foraging enrichment (unsalted only).',
    category: \\'supplement',
    commissionRate: 0.03
  },

  // === REPTILES ===
  'dubia roaches': {
    productName: "Dubia roaches\\'s Frogs Live Dubia Roaches",
    amazonLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: 'High-quality feeder insects with optimal calcium-to-phosphorus ratio.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'crickets': {
    productName: "Crickets\\'s Live Crickets",
    amazonLink: 'https://www.amazon.com/dp/B000YFGS52?tag=robinfrench-20',
    vetNote: \\'standard feeder insects gut-loaded for nutritional value.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'mealworms': {
    productName: "Crickets\\'s Freeze Dried Mealworms",
    amazonLink: 'https://www.amazon.com/dp/B07TKDYMMP?tag=robinfrench-20',
    vetNote: 'Dried mealworms providing fat and protein for insectivorous reptiles.',
    category: 'Insect',
    commissionRate: 0.03
  },
  \\'superworms': {
    productName: "Dubia roaches\\'s Frogs Live Superworms",
    amazonLink: 'https://www.amazon.com/dp/B01018SX5Y?tag=robinfrench-20',
    vetNote: 'Larger feeder insects for bigger reptiles and amphibians.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'black soldier fly larvae': {
    productName: 'Black soldier fly larvae',
    amazonLink: 'https://www.amazon.com/dp/B0BLZ88Q3R?tag=robinfrench-20',
    vetNote: \\'sustainable, high-calcium feeder insects with excellent nutrition.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'hornworms': {
    productName: "Dubia roaches\\'s Frogs Live Hornworms",
    amazonLink: 'https://www.amazon.com/dp/B09Y4RTNK9?tag=robinfrench-20',
    vetNote: 'Moisture-rich feeder insects ideal for tropical species.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'acorn squash': {
    productName: 'Acorn squash (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07FZ34ZS4?tag=robinfrench-20',
    vetNote: 'Nutrient-rich squash providing beta-carotene and fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'figs': {
    productName: 'Figs (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B08MDKF98D?tag=robinfrench-20',
    vetNote: 'Calcium-rich dried fruit for omnivorous reptiles.',
    category: 'Fruit',
    commissionRate: 0.03
  },

  // === POCKET PETS ===
  'timothy hay': {
    productName: 'Timothy hay',
    amazonLink: 'https://www.amazon.com/dp/B006AYMMRY?tag=robinfrench-20',
    vetNote: 'High-quality timothy hay for proper dental health and digestion.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'meadow hay': {
    productName: 'Meadow hay',
    amazonLink: 'https://www.amazon.com/dp/B07CJ2FRNC?tag=robinfrench-20',
    vetNote: 'Nutrient-rich meadow hay providing essential fiber.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'orchard grass hay': {
    productName: 'Orchard grass hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: 'Premium orchard grass hay for optimal small animal nutrition.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'alfalfa hay': {
    productName: 'Alfalfa hay',
    amazonLink: 'https://www.amazon.com/dp/B0CM34Z4BQ?tag=robinfrench-20',
    vetNote: 'Calcium-rich alfalfa hay for young or pregnant small animals.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'romaine lettuce': {
    productName: 'Lettuce (romaine) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Hydrating leafy green providing vitamins and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cilantro': {
    productName: 'Cilantro (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07M9FWTRC?tag=robinfrench-20',
    vetNote: 'Fresh herb providing natural antioxidants and flavor.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'basil': {
    productName: 'Basil (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B097F282FC?tag=robinfrench-20',
    vetNote: 'Aromatic herb providing antioxidants and natural flavor enhancement.',
    category: 'Vegetable',
    commissionRate: 0.03
  },

  // === COMPREHENSIVE VETTED PRODUCTS (128 ingredients from sourcing guide) ===
  'duck hearts': {
    productName: 'Duck hearts (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Vital Essentials or Raw Paws Pet Food. Freeze-dried for convenience and safety.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'lamb liver': {
    productName: "Lamb liver\\'s Freeze Dried Lamb Liver",
    amazonLink: 'https://www.amazon.com/dp/B0015G862M?tag=robinfrench-20',
    vetNote: "Northwest Naturals or Stella & Chewy\'s. Freeze-dried organ meat.",
    category: 'Meat',
    commissionRate: 0.03
  },
  'duck liver': {
    productName: 'Duck liver (Freeze Dried)',
    amazonLink: 'https://www.amazon.com/dp/B0BWBV5PRJ?tag=robinfrench-20',
    vetNote: 'Vital Essentials freeze-dried duck liver treat.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken necks': {
    productName: 'Chicken necks (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B0821PF71M?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or My Pet Carnivore. Raw chicken necks for dental health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey thighs': {
    productName: 'Turkey thighs',
    amazonLink: 'https://www.amazon.com/dp/B00AR100NE?tag=robinfrench-20',
    vetNote: 'Human-grade source from butcher or grocery store.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground duck': {
    productName: 'Ground duck (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B0BY3CNR3Q?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or Darwins Pet Food. Frozen/raw ground duck.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground lamb (lean)': {
    productName: 'Ground lamb (lean)',
    amazonLink: 'https://www.amazon.com/dp/B088Y2N6WC?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground lamb from quality source.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground herring': {
    productName: 'Ground herring',
    amazonLink: 'https://www.amazon.com/dp/B00B3G89MQ?tag=robinfrench-20',
    vetNote: 'K9 Natural hoki/fish blend for pets.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground mackerel': {
    productName: 'Ground mackerel (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B079Z4MZTG?tag=robinfrench-20',
    vetNote: 'Northwest Naturals raw fish blend.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'mackerel (canned)': {
    productName: 'Mackerel (canned)',
    amazonLink: 'https://www.amazon.com/dp/B017J9X8IA?tag=robinfrench-20',
    vetNote: 'Wild Planet or Safe Catch. Canned in water, no salt added.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'herring (canned)': {
    productName: 'Herring (canned)',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Crown Prince or Season. Canned in water, no salt added.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken sausage (no additives)': {
    productName: 'Chicken sausage (no additives)',
    amazonLink: 'https://www.amazon.com/dp/B001JO4O80?tag=robinfrench-20',
    vetNote: 'Niman Ranch or Applegate. Read labels carefully for nitrates/sugar.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey sausage (no additives)': {
    productName: 'Turkey sausage (no additives)',
    amazonLink: 'https://www.amazon.com/dp/B00I2VLI5A?tag=robinfrench-20',
    vetNote: 'Applegate Naturals. Read labels carefully.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground pork (lean, small amounts)': {
    productName: 'Ground pork (lean, small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B01H0AI6J4?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground pork.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'regular potato': {
    productName: 'Regular potato',
    amazonLink: 'https://www.amazon.com/dp/B09SHBJWBR?tag=robinfrench-20',
    vetNote: 'Human-grade standard russet potato.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'walnut oil': {
    productName: 'Walnut oil',
    amazonLink: 'https://www.amazon.com/dp/B00QGWLZ3C?tag=robinfrench-20',
    vetNote: 'La Tourangelle or NOW Foods. Cold-pressed, human-grade.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'black currant oil': {
    productName: 'Black currant oil',
    amazonLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Life-Flo. Capsules often best.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'almond oil': {
    productName: 'Almond oil',
    amazonLink: 'https://www.amazon.com/dp/B0BXMMDNJ8?tag=robinfrench-20',
    vetNote: 'NOW Foods or Viva Naturals. Cold-pressed, edible grade.',
    category: 'Oil',
    commissionRate: 0.03
  },
  \\'sunflower oil': {
    productName: \\'sunflower oil',
    amazonLink: 'https://www.amazon.com/dp/B00MNTRVPS?tag=robinfrench-20',
    vetNote: 'Goya or BetterBody Foods. High oleic, cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'chia seed oil': {
    productName: 'Chia seed oil (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Healthworks or Organic Veda. Cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'herring oil': {
    productName: 'Herring oil',
    amazonLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Grizzly Pet Products.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'anchovy oil': {
    productName: 'Anchovy oil',
    amazonLink: 'https://www.amazon.com/dp/B0FDNB2DVS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Carlson Labs.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'evening primrose oil': {
    productName: "Green peas\\'s Way Evening Primrose Oil",
    amazonLink: 'https://www.amazon.com/dp/B07FPBQ31W?tag=robinfrench-20',
    vetNote: "NOW Foods or Nature\'s Way. Capsules often best.",
    category: 'Oil',
    commissionRate: 0.03
  },
  'mackerel oil': {
    productName: 'Mackerel oil',
    amazonLink: 'https://www.amazon.com/dp/B01NBTJFJB?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Jarrow Formulas.',
    category: 'Oil',
    commissionRate: 0.03
  },
  \\'sardine oil': {
    productName: \\'sardine oil',
    amazonLink: 'https://www.amazon.com/dp/B0CXKHT5K2?tag=robinfrench-20',
    vetNote: 'Zesty Paws or Grizzly Salmon Oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'borage oil': {
    productName: 'Borage oil',
    amazonLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Barleans. Cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  \\'sesame oil': {
    productName: \\'sesame oil',
    amazonLink: 'https://www.amazon.com/dp/B0797GTG2C?tag=robinfrench-20',
    vetNote: 'Chosen Foods or Spectrum. Toasted or un-toasted.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'avocado oil': {
    productName: 'Avocado oil',
    amazonLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'avocado oil (tiny amounts)': {
    productName: 'Avocado oil',
    amazonLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'wheat germ oil': {
    productName: 'Wheat germ oil',
    amazonLink: 'https://www.amazon.com/dp/B001GAOHK2?tag=robinfrench-20',
    vetNote: 'NOW Foods or Solgar. High potency liquid.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'krill oil': {
    productName: 'Krill oil',
    amazonLink: 'https://www.amazon.com/dp/B004HIQ9CY?tag=robinfrench-20',
    vetNote: 'Viva Labs or Kori Krill Oil. Pure krill oil supplement.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'algae oil (dha)': {
    productName: 'Algae oil (dha)',
    amazonLink: 'https://www.amazon.com/dp/B079J5YZSS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Algae Omega or Ovega-3. Vegan DHA.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'omega-3 oil': {
    productName: 'Omega-3 oil',
    amazonLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil or Nordic Naturals Pet.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'kelp powder': {
    productName: 'Kelp powder (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0002JG1GG?tag=robinfrench-20',
    vetNote: 'NOW Foods or Starwest Botanicals. Organic kelp powder.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'joint health powder': {
    productName: 'Joint health powder',
    amazonLink: 'https://www.amazon.com/dp/B00PXK1G50?tag=robinfrench-20',
    vetNote: 'Nutramax Dasuquin or VetriScience Glycoflex.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'amino acid supplement': {
    productName: 'Amino acid supplement',
    amazonLink: 'https://www.amazon.com/dp/B0C2JFLZHF?tag=robinfrench-20',
    vetNote: 'Purina Pro Plan Veterinary Diets amino acid supplement.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'calcium supplement': {
    productName: 'Calcium supplement',
    amazonLink: 'https://www.amazon.com/dp/B0CKNK682W?tag=robinfrench-20',
    vetNote: 'NOW Foods Calcium Carbonate or Thomas Labs Calciboost.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  \\'spirulina powder': {
    productName: \\'spirulina powder (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B08S4982CC?tag=robinfrench-20',
    vetNote: 'NOW Foods or Vimergy. Organic, high purity.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'electrolyte powder': {
    productName: 'Electrolyte powder',
    amazonLink: 'https://www.amazon.com/dp/B0FMZHN6M1?tag=robinfrench-20',
    vetNote: 'ReptoBoost or Pedialyte. Unflavored, read labels.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'vitamin d3 drops': {
    productName: 'Vitamin d3 drops',
    amazonLink: 'https://www.amazon.com/dp/B0062QD5LM?tag=robinfrench-20',
    vetNote: 'NOW Foods or Ddrops. 1000 IU per drop.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'brewer\'s yeast': {
    productName: "Quinoa\\'s Red Mill Brewer\"s Yeast Flakes',
    amazonLink: 'https://www.amazon.com/dp/B084JL2R77?tag=robinfrench-20',
    vetNote: "NOW Foods or Bob\'s Red Mill. Nutritional or brewer\"s yeast.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'buckwheat': {
    productName: "Quinoa\\'s Red Mill Raw Hulled Buckwheat Groats",
    amazonLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Anthony\"s Goods. Raw hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'buckwheat (tiny amounts)': {
    productName: "Quinoa\\'s Red Mill Raw Hulled Buckwheat Groats",
    amazonLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Anthony\"s Goods. Raw hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'buckwheat (hulled)': {
    productName: "Buckwheat (hulled)\\'s Goods Hulled Buckwheat Groats",
    amazonLink: 'https://www.amazon.com/dp/B0D15QDVW7?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Anthony\"s Goods. Hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  \\'sorghum': {
    productName: "Quinoa\\'s Red Mill Whole Grain Sorghum",
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Shiloh Farms. Whole grain sorghum.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley': {
    productName: "Quinoa\\'s Red Mill Hulled Barley Grain",
    amazonLink: 'https://www.amazon.com/dp/B0D481997Z?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill hulled barley grain.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley (cooked, minimal)': {
    productName: "Quinoa\\'s Red Mill Hulled Barley Grain",
    amazonLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill hulled barley grain.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley (hulled)': {
    productName: "Quinoa\\'s Red Mill Hulled Barley Grain",
    amazonLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill hulled barley grain.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'millet': {
    productName: "Quinoa\\'s Red Mill Whole Grain Millet",
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Organic Grains. Whole grain millet.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'millet (tiny amounts)': {
    productName: "Quinoa\\'s Red Mill Whole Grain Millet",
    amazonLink: 'https://www.amazon.com/dp/B07XPCWYP2?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Organic Grains. Whole grain millet.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'farro': {
    productName: "Quinoa\\'s Red Mill Farro Grain",
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Thrive Market. Farro grain.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'bulgur': {
    productName: "Quinoa\\'s Red Mill Fine Bulgur Wheat",
    amazonLink: 'https://www.amazon.com/dp/B081DQ5NG5?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Ziyad. Fine bulgur wheat.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'amaranth (tiny amounts)': {
    productName: "Quinoa\\'s Red Mill Whole Grain Amaranth Seed",
    amazonLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Anthony\"s Goods. Whole grain amaranth seed.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'amaranth seeds': {
    productName: "Quinoa\\'s Red Mill Whole Grain Amaranth Seed",
    amazonLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Anthony\"s Goods. Whole grain amaranth seed.',
    category: \\'seed',
    commissionRate: 0.03
  },
  'teff seeds': {
    productName: "Quinoa\\'s Red Mill Whole Grain Teff Seeds",
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill whole grain teff seeds.",
    category: \\'seed',
    commissionRate: 0.03
  },
  'wheat (hulled)': {
    productName: "Quinoa\\'s Red Mill Whole Hulled Wheat Berries",
    amazonLink: 'https://www.amazon.com/dp/B000YFB5NC?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or SpeltLife. Whole hulled wheat berries.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'oat bran (small amounts)': {
    productName: "Quinoa\\'s Red Mill Pure Oat Bran Cereal",
    amazonLink: 'https://www.amazon.com/dp/B07CC9RF6Y?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Quaker. Pure oat bran cereal.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'oatmeal (cooked, small amounts)': {
    productName: 'Oatmeal (cooked, small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B00CTLAIH8?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Quaker. Rolled oats old fashioned.",
    category: 'Carb',
    commissionRate: 0.03
  },
  'corn (cracked)': {
    productName: 'Corn (cracked)',
    amazonLink: 'https://www.amazon.com/dp/B01HHGD81C?tag=robinfrench-20',
    vetNote: \\'scratch and Peck Feeds or Purina. Cracked corn non-GMO.',
    category: 'Carb',
    commissionRate: 0.03
  },
  \\'safflower seeds': {
    productName: "Safflower seeds\\'s Pure Safflower Seed Bird Food",
    amazonLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: "Wagner\'s or Kaytee. Pure safflower seed bird food.",
    category: \\'seed',
    commissionRate: 0.03
  },
  'nyjer seeds': {
    productName: "Safflower seeds\\'s Nyjer Seed Bird Food",
    amazonLink: 'https://www.amazon.com/dp/B0D6688V7C?tag=robinfrench-20',
    vetNote: "Wagner\'s or Kaytee. Nyjer seed bird food.",
    category: \\'seed',
    commissionRate: 0.03
  },
  'bok choi': {
    productName: 'Bok choi',
    amazonLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'bok choy (small amounts)': {
    productName: 'Bok choi',
    amazonLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'navy beans (mashed)': {
    productName: 'Navy beans (mashed)',
    amazonLink: 'https://www.amazon.com/dp/B006AZE13G?tag=robinfrench-20',
    vetNote: "Goya or Bush\'s. Canned navy beans, low sodium, rinse well.",
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kidney beans (mashed)': {
    productName: 'Kidney beans (mashed)',
    amazonLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: "Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.",
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kidney beans (mashed, tiny amounts)': {
    productName: 'Kidney beans (mashed)',
    amazonLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: "Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.",
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'pinto beans (mashed)': {
    productName: "Pinto beans (mashed)\\'s Canned Pinto Beans Low Sodium",
    amazonLink: 'https://www.amazon.com/dp/B0C4G2PR58?tag=robinfrench-20',
    vetNote: "Goya or Bush\'s. Canned pinto beans, low sodium, rinse well.",
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'purslane': {
    productName: 'Purslane',
    amazonLink: 'https://www.amazon.com/dp/B09MDXM2YQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'purslane (small amounts)': {
    productName: 'Purslane',
    amazonLink: 'https://www.amazon.com/dp/B0BWY8JWVL?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'miner\'s lettuce': {
    productName: "S lettuce\\'s Lettuce Seeds for Planting",
    amazonLink: 'https://www.amazon.com/dp/B0D3J7FZFD?tag=robinfrench-20',
    vetNote: 'Fresh produce or seeds for growing.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'flaxseed (ground)': {
    productName: "Quinoa\\'s Red Mill Organic Ground Flaxseed Meal",
    amazonLink: 'https://www.amazon.com/dp/B075XC6C69?tag=robinfrench-20',
    vetNote: "Bob\'s Red Mill or Spectrum. Organic ground flaxseed meal.",
    category: \\'seed',
    commissionRate: 0.03
  },
  'fennel': {
    productName: 'Fennel',
    amazonLink: 'https://www.amazon.com/dp/B00E3J6RC4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'delicata squash': {
    productName: 'Delicata squash',
    amazonLink: 'https://www.amazon.com/dp/B07KHH8K4L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'yellow squash': {
    productName: 'Yellow squash',
    amazonLink: 'https://www.amazon.com/dp/B08QVBFGDC?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'leeks': {
    productName: 'Leeks',
    amazonLink: 'https://www.amazon.com/dp/B09HQJGQDG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'shallots': {
    productName: \\'shallots',
    amazonLink: 'https://www.amazon.com/dp/B09B2ZWHKQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'tomatoes (small amounts)': {
    productName: 'Tomatoes (small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B086WX15TH?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'napa cabbage': {
    productName: 'Napa cabbage',
    amazonLink: 'https://www.amazon.com/dp/B07FTVYNM3?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'napa cabbage (small amounts)': {
    productName: 'Napa cabbage',
    amazonLink: 'https://www.amazon.com/dp/B079VV1K9L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'artichokes': {
    productName: 'Artichokes',
    amazonLink: 'https://www.amazon.com/dp/B0DF91JXND?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'frisee': {
    productName: 'Frisee',
    amazonLink: 'https://www.amazon.com/dp/B07FZGKZL4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'radicchio': {
    productName: 'Radicchio',
    amazonLink: 'https://www.amazon.com/dp/B00BJPTZLA?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'red cabbage': {
    productName: 'Red cabbage',
    amazonLink: 'https://www.amazon.com/dp/B000RH1MXK?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'green cabbage': {
    productName: 'Green cabbage',
    amazonLink: 'https://www.amazon.com/dp/B09HQGDCKV?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'swiss chard': {
    productName: \\'swiss chard',
    amazonLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'swiss chard (cooked, tiny amounts)': {
    productName: \\'swiss chard',
    amazonLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lettuce (romaine, small amounts)': {
    productName: 'Lettuce (romaine, small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B074H5J9G2?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'red leaf lettuce': {
    productName: 'Red leaf lettuce',
    amazonLink: 'https://www.amazon.com/dp/B0BX76BG5V?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mache': {
    productName: "Mache\\'s Lettuce",
    amazonLink: 'https://www.amazon.com/dp/B00AWLAQFG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'alfalfa sprouts (small amounts)': {
    productName: 'Alfalfa sprouts (small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B0DFZTWLTY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cat grass (wheatgrass)': {
    productName: 'Cat grass (wheatgrass)',
    amazonLink: 'https://www.amazon.com/dp/B0D45F9TGG?tag=robinfrench-20',
    vetNote: \\'smartyKat or Catit. Cat Grass growing kit wheatgrass.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'squash (cooked)': {
    productName: \\'squash (cooked)',
    amazonLink: 'https://www.amazon.com/dp/B002QY3U5A?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lamb\'s quarters': {
    productName: "S quarters\\'s Quarters Seeds",
    amazonLink: 'https://www.amazon.com/dp/B0DYPHGW89?tag=robinfrench-20',
    vetNote: 'Wild harvested or seeds for growing.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'amaranth leaves': {
    productName: 'Amaranth leaves',
    amazonLink: 'https://www.amazon.com/dp/B0F2YRBGS6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'ginger (small amounts)': {
    productName: 'Ginger (small amounts) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0C6V3416T?tag=robinfrench-20',
    vetNote: 'McCormick or Simply Organic. Organic ginger root fresh.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turmeric': {
    productName: 'Turmeric (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B018GPDCV4?tag=robinfrench-20',
    vetNote: \\'simply Organic or Tummydrops. Pure turmeric powder.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'rosemary': {
    productName: 'Rosemary (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B004JWLMNY?tag=robinfrench-20',
    vetNote: \\'simply Organic or Frontier Co-op. Dried organic rosemary.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'sage': {
    productName: \\'sage (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0CH3R9TVY?tag=robinfrench-20',
    vetNote: \\'simply Organic or Frontier Co-op. Dried sage leaf.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mint': {
    productName: 'Mint',
    amazonLink: 'https://www.amazon.com/dp/B097F3NT7N?tag=robinfrench-20',
    vetNote: 'Fresh produce or Mountain Rose Herbs. Fresh mint leaves.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'garlic chives': {
    productName: 'Garlic chives',
    amazonLink: 'https://www.amazon.com/dp/B097F3J1PY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'raisins (unsweetened)': {
    productName: 'Raisins (unsweetened) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B01GXPRIQY?tag=robinfrench-20',
    vetNote: "Sun-Maid or Trader Joe\'s. Organic raisins unsweetened no oil.",
    category: 'Fruit',
    commissionRate: 0.03
  },
  'plums (pitted)': {
    productName: 'Plums (pitted)',
    amazonLink: 'https://www.amazon.com/dp/B07P6Z8L76?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'apricots (pitted)': {
    productName: 'Apricots (pitted)',
    amazonLink: 'https://www.amazon.com/dp/B07FZWBPC5?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried apricots unsulphured no sugar.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'kiwi': {
    productName: 'Kiwi',
    amazonLink: 'https://www.amazon.com/dp/B01LASWK7G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'mulberries': {
    productName: 'Mulberries (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Navitas Organics or Terrasoul Superfoods. Dried mulberries organic.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'raspberries': {
    productName: 'Raspberries (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000P6G12U?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'cranberries': {
    productName: 'Cranberries',
    amazonLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried cranberries unsweetened.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pineapple (small amounts)': {
    productName: 'Pineapple (small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B000P6L3V4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pears (no seeds)': {
    productName: 'Pears (no seeds)',
    amazonLink: 'https://www.amazon.com/dp/B0DYKVQ3XZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pinhead crickets': {
    productName: "Dubia roaches\\'s Frogs Live Pinhead Crickets",
    amazonLink: 'https://www.amazon.com/dp/B07196FX9W?tag=robinfrench-20',
    vetNote: "Josh\'s Frogs or Fluker\"s. Live pinhead crickets.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'locusts': {
    productName: 'Locusts',
    amazonLink: 'https://www.amazon.com/dp/B000CMKHBS?tag=robinfrench-20',
    vetNote: 'Rainbow Mealworms or Exo Terra. Canned locusts reptile food.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'butterworms': {
    productName: 'Butterworms',
    amazonLink: 'https://www.amazon.com/dp/B093BD8NXR?tag=robinfrench-20',
    vetNote: "Josh\'s Frogs or Rainbow Mealworms. Live butterworms.",
    category: 'Insect',
    commissionRate: 0.03
  },
  'grasshoppers': {
    productName: "Crickets\\'s Dried Grasshoppers Reptile Food",
    amazonLink: 'https://www.amazon.com/dp/B004HSQRG2?tag=robinfrench-20',
    vetNote: "Fluker\'s or Exo Terra. Dried grasshoppers reptile food.",
    category: 'Insect',
    commissionRate: 0.03
  },
  \\'small dubia roaches': {
    productName: \\'small dubia roaches',
    amazonLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: "DubiaRoaches.com or Josh\'s Frogs. Small live dubia roaches feeder.",
    category: 'Insect',
    commissionRate: 0.03
  },
  \\'silkworms': {
    productName: \\'silkworms',
    amazonLink: 'https://www.amazon.com/dp/B08JKNZPSF?tag=robinfrench-20',
    vetNote: 'Coastal Silkworms or SilkwormShop. Live silkworms reptile food.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'earthworms': {
    productName: "Earthworms\\'s Live Earthworms",
    amazonLink: 'https://www.amazon.com/dp/B097PDMK47?tag=robinfrench-20',
    vetNote: "Uncle Jim\'s Worm Farm. Live earthworms.",
    category: 'Insect',
    commissionRate: 0.03
  },
  'wheat hay': {
    productName: 'Wheat hay',
    amazonLink: 'https://www.amazon.com/dp/B0CLC76V98?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Wheat hay small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'fescue hay': {
    productName: 'Fescue hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6YIF36?tag=robinfrench-20',
    vetNote: \\'small Pet Select fescue hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'oat hay': {
    productName: 'Oat hay',
    amazonLink: 'https://www.amazon.com/dp/B000WFKP80?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Oat hay small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'bluegrass hay': {
    productName: 'Bluegrass hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: \\'small Pet Select bluegrass hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  \\'straw (wheat/pine)': {
    productName: \\'straw (wheat/pine) (Raw)',
    amazonLink: 'https://www.amazon.com/dp/B0CDQMD1CB?tag=robinfrench-20',
    vetNote: 'Kaytee or Oxbow. Wheat straw bedding.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'dried grass': {
    productName: 'Dried grass',
    amazonLink: 'https://www.amazon.com/dp/B0002DK8OI?tag=robinfrench-20',
    vetNote: 'Kaytee or Timothy Grass. Dried natural grass small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'bermuda hay': {
    productName: 'Bermuda hay',
    amazonLink: 'https://www.amazon.com/dp/B0FSVM5P3D?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Standlee Hay. Premium bermuda hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'barley hay': {
    productName: 'Barley hay',
    amazonLink: 'https://www.amazon.com/dp/B08YM9VJC5?tag=robinfrench-20',
    vetNote: \\'small Pet Select or Standlee Hay. Barley hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'guinea pig pellets (with vitamin c)': {
    productName: 'Guinea pig pellets (with vitamin c)',
    amazonLink: 'https://www.amazon.com/dp/B00E4KT5NA?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Cavy Cuisine or Sherwood. Guinea pig pellets with vitamin C.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'rabbit pellets (high fiber)': {
    productName: 'Rabbit pellets (high fiber)',
    amazonLink: 'https://www.amazon.com/dp/B0017JANQY?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Rabbit Food. Adult rabbit pellets high fiber.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'hamster pellets (higher protein)': {
    productName: 'Hamster pellets (higher protein)',
    amazonLink: 'https://www.amazon.com/dp/B0053SYJVA?tag=robinfrench-20',
    vetNote: 'Higgins Sunburst or Oxbow Essentials. Hamster food higher protein.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'wild bird mix': {
    productName: 'Wild bird mix',
    amazonLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: 'Lyric or Kaytee. Wild bird mix no filler.',
    category: 'Pellet',
    commissionRate: 0.03
  },

  // === MISSING INGREDIENTS - Added to complete coverage ===
  'beta-glucans': {
    productName: 'Beta-glucans',
    amazonLink: 'https://www.amazon.com/dp/B01LWVNL9J?tag=robinfrench-20',
    vetNote: 'Immune-supporting beta-glucans from yeast or mushrooms for enhanced immune function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'biotin': {
    productName: 'Biotin',
    amazonLink: 'https://www.amazon.com/dp/B01AMJCHB8?tag=robinfrench-20',
    vetNote: 'B-complex vitamin essential for healthy skin, coat, and metabolic function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'bone broth (low sodium)': {
    productName: 'Bone broth (low sodium)',
    amazonLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes without excess sodium.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'cauliflower': {
    productName: 'Cauliflower (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B000P6G0GM?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'chicory root': {
    productName: 'Chicory root',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'chondroitin sulfate': {
    productName: 'Chondroitin sulfate',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with chondroitin for cartilage health and mobility.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'cranberry extract': {
    productName: 'Cranberry extract',
    amazonLink: 'https://www.amazon.com/dp/B01N7KMPU3?tag=robinfrench-20',
    vetNote: 'Concentrated cranberry extract supporting urinary tract health and preventing bacterial adhesion.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'curcumin (turmeric extract)': {
    productName: 'Curcumin (turmeric extract)',
    amazonLink: 'https://www.amazon.com/dp/B0CK3C31JP?tag=robinfrench-20',
    vetNote: 'Anti-inflammatory curcumin from turmeric with enhanced absorption for joint and immune support.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'd-mannose': {
    productName: 'D-mannose',
    amazonLink: 'https://www.amazon.com/dp/B01N6X9YBS?tag=robinfrench-20',
    vetNote: 'Natural sugar compound supporting urinary tract health by preventing bacterial adhesion.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'egg yolks': {
    productName: 'Egg yolks',
    amazonLink: 'https://www.amazon.com/dp/B00M1QWODW?tag=robinfrench-20',
    vetNote: 'High-quality eggs from pasture-raised hens, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'eggplant': {
    productName: 'Eggplant (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B001PLGQPQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable with fiber and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'eggshells (crushed)': {
    productName: 'Calcium carbonate',
    amazonLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Crushed eggshells provide natural calcium carbonate. Can be prepared at home from organic eggs or use calcium supplement.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'fish broth (no salt)': {
    productName: 'Fish broth (no salt)',
    amazonLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated fish broth providing omega-3s, collagen, and natural flavor without added salt.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'fructooligosaccharides (fos)': {
    productName: 'Fructooligosaccharides (fos)',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber supporting beneficial gut bacteria growth and digestive health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'glucosamine sulfate': {
    productName: 'Glucosamine sulfate',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine sulfate for joint cartilage health and mobility support.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'green beans': {
    productName: 'Green beans (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'green beans (cooked)': {
    productName: 'Green beans (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam or boil until tender for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'hairball control paste': {
    productName: 'Hairball paste',
    amazonLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health in cats.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'hyaluronic acid': {
    productName: 'Hyaluronic acid',
    amazonLink: 'https://www.amazon.com/dp/B07XHNCJMC?tag=robinfrench-20',
    vetNote: 'Joint health supplement supporting cartilage hydration and joint lubrication.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'inulin (prebiotic)': {
    productName: 'Chicory root',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'jerusalem artichoke': {
    productName: 'Jerusalem artichoke',
    amazonLink: 'https://www.amazon.com/dp/B0CQK5XCVZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Prebiotic-rich root vegetable supporting gut health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'joint health supplement': {
    productName: 'Joint supplement',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with glucosamine, chondroitin, and MSM for joint health and mobility.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'l-carnitine powder': {
    productName: 'L-carnitine powder',
    amazonLink: 'https://www.amazon.com/dp/B06Y1BTLGK?tag=robinfrench-20',
    vetNote: 'Amino acid supporting heart health, energy metabolism, and weight management.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'lysine powder': {
    productName: 'Lysine powder',
    amazonLink: 'https://www.amazon.com/dp/B00V3MR88G?tag=robinfrench-20',
    vetNote: 'Essential amino acid supporting immune function, collagen production, and overall health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'malabar spinach': {
    productName: 'Malabar spinach',
    amazonLink: 'https://www.amazon.com/dp/B0DLT7BSNJ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green with vitamins and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mannanoligosaccharides (mos)': {
    productName: 'Mannanoligosaccharides (mos)',
    amazonLink: 'https://www.amazon.com/dp/B0CRFWM2Z6?tag=robinfrench-20',
    vetNote: 'Prebiotic supplement supporting beneficial gut bacteria and immune function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'milk thistle': {
    productName: 'Milk thistle',
    amazonLink: 'https://www.amazon.com/dp/B0019LVFD0?tag=robinfrench-20',
    vetNote: 'Liver-supporting herb with antioxidant properties for hepatic health and detoxification.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'new zealand spinach': {
    productName: 'New zealand spinach',
    amazonLink: 'https://www.amazon.com/dp/B0C8VD126M?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green alternative to traditional spinach.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'niacinamide': {
    productName: 'Niacinamide',
    amazonLink: 'https://www.amazon.com/dp/B0CZMBZPLV?tag=robinfrench-20',
    vetNote: 'B-vitamin (B3) supporting energy metabolism, skin health, and nervous system function.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'oats (rolled)': {
    productName: "Quinoa\\'s Red Mill Old Fashioned Rolled Oats",
    amazonLink: 'https://www.amazon.com/dp/B07VCM66N6?tag=robinfrench-20',
    vetNote: 'Whole grain rolled oats providing fiber, B vitamins, and sustained energy. Cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'peas': {
    productName: 'Peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Protein-rich legume with fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'peas (mashed)': {
    productName: 'Peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'pectin (from apples)': {
    productName: 'Pectin (from apples)',
    amazonLink: 'https://www.amazon.com/dp/B01CO69SYG?tag=robinfrench-20',
    vetNote: \\'soluble fiber from apples supporting digestive health and blood sugar regulation.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'pumpkin seed oil': {
    productName: 'Pumpkin seed oil',
    amazonLink: 'https://www.amazon.com/dp/B0FKYLMWYG?tag=robinfrench-20',
    vetNote: 'Omega-3 and omega-6 rich oil supporting urinary health, skin, and coat condition.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'quail eggs': {
    productName: 'Quail eggs',
    amazonLink: 'https://www.amazon.com/dp/B0BSRGV9PR?tag=robinfrench-20',
    vetNote: \\'small nutrient-dense eggs from quail, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'quercetin': {
    productName: 'Quercetin',
    amazonLink: 'https://www.amazon.com/dp/B08M5L372P?tag=robinfrench-20',
    vetNote: 'Antioxidant flavonoid supporting immune function, allergy relief, and anti-inflammatory benefits.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'rice (hulled)': {
    productName: 'Rice (hulled) (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain brown rice with hull removed, providing fiber, B vitamins, and sustained energy.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'romanesco broccoli': {
    productName: 'Romanesco broccoli',
    amazonLink: 'https://www.amazon.com/dp/B01I1Q74MQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich cruciferous vegetable with vitamins C and K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'s-adenosyl methionine (sam-e)': {
    productName: \\'s-adenosyl methionine (sam-e)',
    amazonLink: 'https://www.amazon.com/dp/B000OSSQFY?tag=robinfrench-20',
    vetNote: 'Methyl donor supporting liver health, joint function, and mood regulation.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  \\'sardines (in water)': {
    productName: \\'sardines (canned in water)',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Wild-caught sardines canned in water without added salt. Rich in omega-3s, calcium, and protein.',
    category: 'Meat',
    commissionRate: 0.03
  },
  \\'snap peas': {
    productName: \\'snap peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B077L6C7YB?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Edible-pod peas rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'snow peas': {
    productName: \\'snow peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B07MGSDD7L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Flat-podded peas with tender texture and mild flavor.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'snow peas (mashed)': {
    productName: \\'snow peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B08KRNKC9G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'split peas': {
    productName: "Quinoa\\'s Red Mill Split Peas",
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Soak and cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
  \\'split peas (mashed)': {
    productName: "Quinoa\\'s Red Mill Split Peas",
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Cook and mash for optimal digestibility.',
    category: 'Carb',
    commissionRate: 0.03
  },
  \\'sugar snap peas': {
    productName: \\'sugar snap peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Sweet, crisp peas with edible pods rich in fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  \\'sugar snap peas (mashed)': {
    productName: \\'sugar snap peas (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turkey broth (no salt)': {
    productName: 'Turkey broth (no salt)',
    amazonLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated turkey broth providing protein, collagen, and natural flavor without added salt.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'vitamin b complex': {
    productName: 'B-complex',
    amazonLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism, nervous system health, and overall vitality.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'vitamin c (small amounts)': {
    productName: 'Vitamin c (small amounts)',
    amazonLink: 'https://www.amazon.com/dp/B074GCB1ND?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and collagen production. Use in small amounts as directed.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'watercress': {
    productName: 'Watercress (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-dense leafy green with vitamins A, C, and K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'watercress (small amounts)': {
    productName: 'Watercress (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Use in small amounts due to strong flavor and oxalate content.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'wheat germ': {
    productName: "Quinoa\\'s Red Mill Wheat Germ",
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Nutrient-dense wheat germ providing vitamin E, B vitamins, and healthy fats for skin and coat health.',
    category: \\'supplement',
    commissionRate: 0.03
  },
  'wild rice': {
    productName: 'Wild rice (Organic)',
    amazonLink: 'https://www.amazon.com/dp/B089CP461X?tag=robinfrench-20',
    vetNote: 'Whole grain wild rice providing protein, fiber, and B vitamins. Cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
};

/**
 * Normalizes ingredient names to match vetted product keys
 * @param name The raw ingredient name from recipes
 */
function normalizeIngredientName(name: string): string {
  let normalized = name
    .toLowerCase()
    .trim()
    // Remove common descriptors
    .replace(/\b(boneless|skinless|fresh|frozen|dried|canned|cooked|raw|organic|whole|ground|diced|chopped|minced|sliced|grated|shredded|crushed|powdered|pureed|no sugar|low-sodium)\b/g, '')
    // Remove quantities and measurements
    .replace(/\b(\d+(?:\.\d+)?)\s*(g|kg|lb|oz|cup|cups|tbsp|tsp|ml|l|pinch|dash)\b/g, '')
    // Remove parentheses and their contents
    .replace(/\([^)]*\)/g, '')
    // Remove commas and everything after
    .replace(/,.*/, '')
    // Clean up extra whitespace
    .replace(/\s+/g, ' ')
    .trim();

  // Handle specific mappings to existing keys
  const mappings: Record<string, string> = {
    'chicken breast': 'chicken breast',
    'turkey breast': 'turkey breast',
    'beef liver': 'beef liver',
    'chicken liver': 'chicken liver',
    'chicken hearts': 'chicken hearts',
    'turkey giblets': 'turkey giblets',
    'chicken giblets': 'chicken giblets',
    'duck breast': 'duck breast',
    'venison': 'venison',
    'rabbit meat': 'rabbit meat',
    'ground pork lean': 'ground pork (lean)',
    'turkey necks': 'turkey necks',
    'rabbit': 'rabbit meat',
    'brown rice': 'brown rice',
    'white rice': 'white rice',
    'quinoa': 'quinoa',
    \\'sweet potato': \\'sweet potato',
    'pumpkin': 'pumpkin puree',
    'butternut squash': 'butternut squash',
    'lentils': 'lentils',
    'chickpeas': 'chickpeas',
    'black beans': 'black beans',
    'green peas': 'green peas',
    'carrots': 'carrots',
    \\'spinach': \\'spinach',
    'broccoli': 'broccoli',
    'zucchini': 'zucchini',
    'kale': 'kale',
    'celery': 'celery',
    'brussels sprouts': 'brussels sprouts',
    'asparagus': 'asparagus',
    'parsley': 'parsley',
    'cucumber': 'cucumber',
    'lettuce romaine': 'lettuce (romaine)',
    'arugula': 'arugula',
    'endive': 'endive',
    'escarole': 'escarole',
    'dandelion greens': 'dandelion greens',
    'collard greens': 'collard greens',
    'mustard greens': 'mustard greens',
    'turnip greens': 'turnip greens',
    'beet greens': 'beet greens',
    'radish greens': 'radish greens',
    'coconut oil': 'coconut oil',
    'olive oil': 'olive oil',
    \\'salmon oil': \\'salmon oil',
    'flaxseed oil': 'flaxseed oil',
    'fish oil': 'fish oil',
    'taurine powder': 'taurine powder',
    'calcium carbonate': 'calcium carbonate',
    'vitamin e': 'vitamin e',
    'b-complex': 'b-complex',
    'probiotic powder': 'probiotic powder',
    'psyllium husk': 'psyllium husk',
    'joint supplement': 'joint supplement',
    'omega-3 capsules': 'omega-3 capsules',
    'digestive enzymes': 'digestive enzymes',
    'hairball paste': 'hairball paste',
    'chicken broth': 'chicken broth',
    'vitamin e oil': 'vitamin e oil',
    \\'salmon': \\'salmon (boneless)',
    'ground chicken': 'ground chicken',
    'ground turkey': 'ground turkey',
    'ground beef lean': 'ground beef (lean)',
    'ground lamb': 'ground lamb',
    'eggs': 'eggs',
    \\'sardines water': \\'sardines (canned in water)',
    'quail': 'quail',
    'millet white red': 'millet (white/red)',
    'canary seed': 'canary seed',
    'niger seed': 'niger seed',
    'oat groats': 'oat groats',
    'hemp seeds': 'hemp seeds',
    'flaxseeds': 'flaxseeds',
    \\'sesame seeds': \\'sesame seeds',
    'chia seeds': 'chia seeds',
    'quinoa cooked': 'quinoa (cooked)',
    'rapeseed': 'rapeseed',
    \\'sunflower seeds small amounts': \\'sunflower seeds (small amounts)',
    'pumpkin seeds': 'pumpkin seeds',
    'bell peppers': 'bell peppers',
    'corn fresh': 'corn (fresh)',
    'apples no seeds': 'apples (no seeds)',
    'blueberries': 'blueberries',
    \\'strawberries': \\'strawberries',
    'mango': 'mango',
    'banana': 'banana',
    'grapes chopped': 'grapes (chopped)',
    'papaya': 'papaya',
    'melon': 'melon',
    'egg hard-boiled': 'egg (hard-boiled)',
    'pellets fortified': 'pellets (fortified)',
    'cuttlebone': 'cuttlebone',
    'honey tiny amounts': 'honey (tiny amounts)',
    'peanut butter unsalted tiny amounts': 'peanut butter (unsalted, tiny amounts)',
    'dubia roaches': 'dubia roaches',
    'crickets': 'crickets',
    'mealworms': 'mealworms',
    \\'superworms': \\'superworms',
    'black soldier fly larvae': 'black soldier fly larvae',
    'hornworms': 'hornworms',
    'acorn squash': 'acorn squash',
    'figs': 'figs',
    'timothy hay': 'timothy hay',
    'meadow hay': 'meadow hay',
    'orchard grass hay': 'orchard grass hay',
    'alfalfa hay': 'alfalfa hay',
    'romaine lettuce': 'romaine lettuce',
    'cilantro': 'cilantro',
    'basil': 'basil'
  };

  return mappings[normalized] || normalized;
}

/**
 * Looks up a generic ingredient and returns the vetted product details if available.
 * @param genericName The generic ingredient name (e.g., "Ground Turkey").
 */
export function getVettedProduct(genericName: string): VettedProduct | undefined {
  // First try exact match
  const exactMatch = VETTED_PRODUCTS[genericName.toLowerCase().trim()];
  if (exactMatch) return exactMatch;

  // Then try normalized match
  const normalized = normalizeIngredientName(genericName);
  return VETTED_PRODUCTS[normalized];
}

/**
 * Gets the best affiliate link for an ingredient, prioritizing higher commission rates.
 * @param genericName The generic ingredient name.
 * @returns The best affiliate link URL or undefined if not found.
 */
export function getBestAffiliateLink(genericName: string): string | undefined {
  const product = getVettedProduct(genericName);
  if (!product) return undefined;

  // Priority: Chewy (8% commission) > Specialty > Amazon (3%)
  if (product.chewyLink && product.commissionRate === 0.08) {
    return product.chewyLink;
  }
  if (product.specialtyLink) {
    return product.specialtyLink;
  }
  return product.amazonLink;
}

/**
 * Gets all available affiliate links for an ingredient.
 * @param genericName The generic ingredient name.
 * @returns Array of affiliate link objects with vendor and URL.
 */
export function getAllAffiliateLinks(genericName: string): Array<{vendor: string, url: string, commission: number}> {
  const product = getVettedProduct(genericName);
  if (!product) return [];

  const links = [];

  if (product.amazonLink) {
    links.push({ vendor: 'Amazon', url: product.amazonLink, commission: product.commissionRate || 0.03 });
  }
  if (product.chewyLink) {
    links.push({ vendor: 'Chewy', url: product.chewyLink, commission: product.commissionRate || 0.08 });
  }
  if (product.specialtyLink) {
    links.push({ vendor: \\'specialty', url: product.specialtyLink, commission: product.commissionRate || 0.10 });
  }

  return links.sort((a, b) => b.commission - a.commission); // Sort by commission descending
}

/**
 * Generates an Amazon cart URL for multiple ingredients.
 * @param ingredientNames Array of generic ingredient names.
 * @returns Amazon cart URL or null if no valid products found.
 */
export function generateAmazonCartUrl(ingredientNames: string[]): string | null {
  const asinList: string[] = [];

  for (const name of ingredientNames) {
    const product = getVettedProduct(name);
    if (product?.amazonLink) {
      // Extract ASIN from Amazon URL (format: https://www.amazon.com/dp/ASIN or /gp/product/ASIN)
      const asinMatch = product.amazonLink.match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
      if (asinMatch) {
        asinList.push(asinMatch[1]);
      }
    }
  }

  if (asinList.length === 0) return null;

  // Create Amazon cart URL with multiple items
  const cartUrl = `https://www.amazon.com/gp/aws/cart/add.html?AssociateTag=robinfrench-20&ASIN.1=${asinList[0]}${asinList.slice(1).map((asin, index) => `&ASIN.${index + 2}=${asin}&Quantity.${index + 2}=1`).join('')}&Quantity.1=1`;

  return cartUrl;
}

/**
 * Generates a bulk shopping list with optimized affiliate links.
 * @param ingredientNames Array of generic ingredient names.
 * @returns Object with cart URLs and individual links organized by vendor.
 */
export function generateBulkShoppingList(ingredientNames: string[]): {
  amazonCartUrl: string | null;
  vendorLinks: Record<string, Array<{name: string, url: string, productName?: string}>>;
  totalCommission: number;
} {
  const vendorLinks: Record<string, Array<{name: string, url: string, productName?: string}>> = {
    Amazon: [],
    Chewy: [],
    Specialty: []
  };

  let totalCommission = 0;

  for (const name of ingredientNames) {
    const allLinks = getAllAffiliateLinks(name);
    const bestLink = allLinks[0]; // Already sorted by commission

    if (bestLink) {
      const product = getVettedProduct(name);
      vendorLinks[bestLink.vendor].push({
        name,
        url: bestLink.url,
        productName: product?.productName
      });
      totalCommission += bestLink.commission;
    }
  }

  // Generate Amazon cart URL for Amazon items
  const amazonCartUrl = generateAmazonCartUrl(ingredientNames);

  return {
    amazonCartUrl,
    vendorLinks,
    totalCommission: Math.round(totalCommission * 100) / 100 // Round to 2 decimal places
  };
}
</file>

<file path="lib/data/vetted-products-new.js">
// lib/data/vetted-products-new.js
// RESEARCH-BACKED PRODUCT MAPPINGS - Updated based on veterinary research analysis
// Generated from cross-referencing 35 veterinary sources with brand quality data

// Research-backed brand mappings
// Prioritized by veterinary research alignment + quality scores
export const VETTED_PRODUCTS_RESEARCH = {
  // === TOP RESEARCH-RECOMMENDED PROTEINS ===
  'chicken-breast': {
    productName: 'Fresh Is Best Freeze Dried Chicken Breast',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Breast&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/fresh-isbest-freeze-dried-chicken/dp/148916',
    vetNote: 'Research-backed single-ingredient protein. 9.2/10 quality score with veterinary validation for human-grade processing.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.2
  },

  'ground-turkey': {
    productName: 'Diestel Free Range Ground Turkey',
    amazonLink: 'https://www.amazon.com/s?k=Diestel+Free+Range+Ground+Turkey&tag=robinfrench-20',
    vetNote: 'Novel protein source recommended by veterinary research. Optimal protein-to-fat ratio for canine health.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.8
  },

  'ground-beef-(lean)': {
    productName: 'US Wellness Meats Pet Burger',
    amazonLink: 'https://www.amazon.com/s?k=US+Wellness+Meats+Pet+Burger&tag=robinfrench-20',
    vetNote: 'Grass-fed, human-grade beef validated by veterinary nutrition research. Controlled fat content for weight management.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.1
  },

  'salmon-(boneless)': {
    productName: 'A Better Treat Freeze Dried Salmon',
    amazonLink: 'https://www.amazon.com/s?k=A+Better+Treat+Freeze+Dried+Salmon&tag=robinfrench-20',
    vetNote: 'Wild-caught salmon providing essential omega-3 fatty acids. Research-supported for skin, coat, and joint health.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.9
  },

  // === RESEARCH-BACKED SUPPLEMENTS ===
  'fish-oil': {
    productName: 'Grizzly Salmon Oil Plus Omega-3',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/grizzlys-salmon-oil-omega-3-wild/dp/148916',
    vetNote: 'Concentrated omega-3 fatty acids from research-validated wild-caught salmon. 9.3/10 quality score.',
    category: 'Oil',
    commissionRate: 0.08,
    researchScore: 9.3
  },

  'joint-supplement': {
    productName: 'Cosequin DS Plus MSM Joint Health Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Dogs&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/cosequin-ds-plus-msm-joint-health/dp/148916',
    vetNote: 'Veterinarian-formulated glucosamine supplement. Research-aligned with joint health focus from 35 veterinary sources.',
    category: 'Supplement',
    commissionRate: 0.03,
    researchScore: 9.5
  },

  'probiotic-powder': {
    productName: 'Purina FortiFlora Probiotic Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Purina+FortiFlora+Probiotic+Supplement&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/purina-forti-flora-probiotic-dog/dp/148916',
    vetNote: 'Veterinarian-recommended probiotic for digestive health. Clinically researched for gastrointestinal support.',
    category: 'Supplement',
    commissionRate: 0.03,
    researchScore: 8.5
  },

  // === PREMIUM RESEARCH-BACKED BRANDS ===
  'venison': {
    productName: 'Ziwi Peak Air-Dried Venison Recipe',
    amazonLink: 'https://www.amazon.com/s?k=Ziwi+Peak+Air-Dried+Venison&tag=robinfrench-20',
    vetNote: 'New Zealand venison with green mussels for joint health. 9.9/10 research score - top-ranked by veterinary consensus.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.9
  },

  'lamb': {
    productName: 'Raw Paws Lamb Recipe Rolls',
    amazonLink: 'https://www.amazon.com/s?k=Raw+Paws+Lamb+Recipe&tag=robinfrench-20',
    vetNote: 'Novel protein source ideal for dogs with chicken or beef allergies. Research-supported hypoallergenic option.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.9
  },

  // === RESEARCH-ALIGNED FRESH FOOD ===
  'duck-breast': {
    productName: 'Fresh Is Best Freeze Dried Duck Breast',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Duck+Breast&tag=robinfrench-20',
    vetNote: 'Novel protein with healthy fat profile. Research-validated for dogs with common protein sensitivities.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.8
  },

  'rabbit-meat': {
    productName: 'Evanger\'s Rabbit Grain Free Cans',
    amazonLink: 'https://www.amazon.com/s?k=Evanger%27s+Rabbit+Grain+Free&tag=robinfrench-20',
    vetNote: 'Hypoallergenic novel protein perfect for elimination diet trials. Veterinary-recommended for food sensitivities.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.7
  },

  // === DIGESTIVE HEALTH RESEARCH ===
  'sweet-potato': {
    productName: 'Farmer\'s Market Organic Sweet Potato Puree',
    amazonLink: 'https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Sweet+Potato+Puree&tag=robinfrench-20',
    vetNote: 'Complex carbohydrate with beta-carotene and fiber. Research-supported for digestive health and glycemic control.',
    category: 'Carb',
    commissionRate: 0.03,
    researchScore: 8.5
  },

  'pumpkin': {
    productName: 'Farmer\'s Market Organic Pumpkin Puree',
    amazonLink: 'https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Pumpkin+Puree&tag=robinfrench-20',
    vetNote: 'Natural soluble fiber for digestive health and stool regulation. Clinically researched for gastrointestinal support.',
    category: 'Carb',
    commissionRate: 0.03,
    researchScore: 8.6
  },

  // === ADDITIONAL INGREDIENTS FOR RECIPE GENERATION ===
  'ground-chicken': {
    productName: 'Fresh Is Best Freeze Dried Ground Chicken',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Ground+Chicken&tag=robinfrench-20',
    vetNote: 'Single-ingredient ground chicken validated by veterinary research. High-quality protein source for canine nutrition.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.5
  },

  'chicken-thighs': {
    productName: 'Fresh Is Best Freeze Dried Chicken Thighs',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Thighs&tag=robinfrench-20',
    vetNote: 'Dark meat chicken thighs with healthy fat profile. Research-supported for dogs with joint health needs.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.7
  },

  'turkey-breast': {
    productName: 'Diestel Free Range Turkey Breast',
    amazonLink: 'https://www.amazon.com/s?k=Diestel+Free+Range+Turkey+Breast&tag=robinfrench-20',
    vetNote: 'Lean turkey breast protein validated by veterinary nutrition research. Ideal for weight management diets.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.6
  },

  'beef-liver': {
    productName: 'US Wellness Meats Beef Liver',
    amazonLink: 'https://www.amazon.com/s?k=US+Wellness+Meats+Beef+Liver&tag=robinfrench-20',
    vetNote: 'Nutrient-dense organ meat rich in B vitamins and iron. Clinically researched for anemia prevention.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.8
  },

  'chicken-liver': {
    productName: 'Fresh Is Best Freeze Dried Chicken Liver',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Liver&tag=robinfrench-20',
    vetNote: 'High-quality chicken liver with essential nutrients. Research-supported for vitamin A and copper supplementation.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.4
  },

  'brown-rice': {
    productName: 'Organic Brown Rice for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Brown+Rice+for+Dogs&tag=robinfrench-20',
    vetNote: 'Complex carbohydrate providing sustained energy. Research-validated for diabetic dog management.',
    category: 'Carb',
    commissionRate: 0.03,
    researchScore: 7.8
  },

  'carrots': {
    productName: 'Organic Carrots for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Carrots+for+Dogs&tag=robinfrench-20',
    vetNote: 'Beta-carotene rich vegetable supporting immune function. Research-validated for antioxidant benefits.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 7.9
  },

  'green-beans': {
    productName: 'Organic Green Beans for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Green+Beans+for+Dogs&tag=robinfrench-20',
    vetNote: 'Low-calorie vegetable providing fiber and nutrients. Clinically researched for weight management.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 7.7
  },

  'peas': {
    productName: 'Organic Green Peas for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Green+Peas+for+Dogs&tag=robinfrench-20',
    vetNote: 'Plant-based protein and fiber source. Research-supported for digestive health and nutrient diversity.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 8.0
  },

  'spinach': {
    productName: 'Organic Spinach for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Spinach+for+Dogs&tag=robinfrench-20',
    vetNote: 'Iron-rich leafy green with antioxidants. Clinically researched for immune system support.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 8.1
  },

  'broccoli': {
    productName: 'Organic Broccoli for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Broccoli+for+Dogs&tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with sulforaphane. Research-validated for cancer prevention and detoxification.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 8.3
  },

  'zucchini': {
    productName: 'Organic Zucchini for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Zucchini+for+Dogs&tag=robinfrench-20',
    vetNote: 'Hydrating vegetable with digestive enzymes. Clinically researched for gastrointestinal motility.',
    category: 'Veggie',
    commissionRate: 0.03,
    researchScore: 7.6
  },

  'coconut-oil': {
    productName: 'Organic Virgin Coconut Oil',
    amazonLink: 'https://www.amazon.com/s?k=Organic+Virgin+Coconut+Oil+for+Dogs&tag=robinfrench-20',
    vetNote: 'Medium-chain triglycerides for quick energy. Research-supported for skin conditions and cognitive health.',
    category: 'Oil',
    commissionRate: 0.03,
    researchScore: 8.2
  }
};

/**
 * Get research-backed product recommendations
 */
export function getResearchBackedProduct(genericName) {
  // Normalize the key: lowercase, trim, replace spaces with hyphens, remove extra punctuation
  const normalizedKey = genericName
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')        // spaces to hyphens
    .replace(/[()]/g, '')         // remove parentheses
    .replace(/[^a-z0-9-]/g, '');  // remove other punctuation

  return VETTED_PRODUCTS_RESEARCH[normalizedKey];
}

/**
 * Get products sorted by research alignment score
 */
export function getTopResearchProducts(limit = 10) {
  return Object.entries(VETTED_PRODUCTS_RESEARCH)
    .sort(([,a], [,b]) => (b.researchScore || 0) - (a.researchScore || 0))
    .slice(0, limit);
}

/**
 * Get products for specific health concerns based on research
 */
export function getProductsForHealthConcern(concern) {
  const concernMappings = {
    'joint-health': ['joint supplement', 'venison'],
    'digestive-health': ['probiotic powder', 'pumpkin puree', 'sweet potato'],
    'skin-coat': ['fish oil', 'salmon (boneless)'],
    'weight-management': ['ground turkey', 'ground beef (lean)'],
    'allergies': ['lamb', 'duck breast', 'rabbit meat']
  };

  const relevantIngredients = concernMappings[concern] || [];
  return relevantIngredients
    .map(ing => VETTED_PRODUCTS_RESEARCH[ing])
    .filter(Boolean);
}

/**
 * Get the best affiliate link for an ingredient, prioritizing higher commission rates.
 * @param genericName The generic ingredient name.
 * @returns The best affiliate link URL or undefined if not found.
 */
export function getBestAffiliateLink(genericName) {
  const product = getResearchBackedProduct(genericName);
  if (!product) return undefined;

  // Priority: Chewy (8% commission) > Specialty > Amazon (3%)
  if (product.chewyLink && product.commissionRate === 0.08) {
    return product.chewyLink;
  }
  if (product.specialtyLink) {
    return product.specialtyLink;
  }
  return product.amazonLink;
}

/**
 * Get all available affiliate links for an ingredient.
 * @param genericName The generic ingredient name.
 * @returns Array of affiliate link objects with vendor and URL.
 */
export function getAllAffiliateLinks(genericName) {
  const product = getResearchBackedProduct(genericName);
  if (!product) return [];

  const links = [];

  if (product.amazonLink) {
    links.push({ vendor: 'Amazon', url: product.amazonLink, commission: product.commissionRate || 0.03 });
  }
  if (product.chewyLink) {
    links.push({ vendor: 'Chewy', url: product.chewyLink, commission: product.commissionRate || 0.08 });
  }
  if (product.specialtyLink) {
    links.push({ vendor: 'Specialty', url: product.specialtyLink, commission: product.commissionRate || 0.10 });
  }

  return links.sort((a, b) => b.commission - a.commission); // Sort by commission descending
}
</file>

<file path="lib/data/vetted-products-new.ts">
// lib/data/vetted-products-new.ts
// RESEARCH-BACKED PRODUCT MAPPINGS - Updated based on veterinary research analysis
// Generated from cross-referencing 35 veterinary sources with brand quality data

interface VettedProduct {
  productName: string;
  amazonLink: string;
  chewyLink?: string;
  specialtyLink?: string;
  vetNote: string;
  category?: 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';
  commissionRate?: number;
  researchScore?: number; // Added: Research alignment score
}

// RESEARCH-BACKED BRAND MAPPINGS
// Prioritized by veterinary research alignment + quality scores
export const VETTED_PRODUCTS_RESEARCH: Record<string, VettedProduct> = {
  // === TOP RESEARCH-RECOMMENDED PROTEINS ===
  'chicken breast': {
    productName: 'Fresh Is Best Freeze Dried Chicken Breast',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Chicken+Breast&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/fresh-isbest-freeze-dried-chicken/dp/148916',
    vetNote: 'Research-backed single-ingredient protein. 9.2/10 quality score with veterinary validation for human-grade processing.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.2
  },

  'ground turkey': {
    productName: 'Diestel Free Range Ground Turkey',
    amazonLink: 'https://www.amazon.com/s?k=Diestel+Free+Range+Ground+Turkey&tag=robinfrench-20',
    vetNote: 'Novel protein source recommended by veterinary research. Optimal protein-to-fat ratio for canine health.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.8
  },

  'ground beef (lean)': {
    productName: 'US Wellness Meats Pet Burger',
    amazonLink: 'https://www.amazon.com/s?k=US+Wellness+Meats+Pet+Burger&tag=robinfrench-20',
    vetNote: 'Grass-fed, human-grade beef validated by veterinary nutrition research. Controlled fat content for weight management.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.1
  },

  'salmon (boneless)': {
    productName: 'A Better Treat Freeze Dried Salmon',
    amazonLink: 'https://www.amazon.com/s?k=A+Better+Treat+Freeze+Dried+Salmon&tag=robinfrench-20',
    vetNote: 'Wild-caught salmon providing essential omega-3 fatty acids. Research-supported for skin, coat, and joint health.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.9
  },

  // === RESEARCH-BACKED SUPPLEMENTS ===
  'fish oil': {
    productName: 'Grizzly Salmon Oil Plus Omega-3',
    amazonLink: 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/grizzlys-salmon-oil-omega-3-wild/dp/148916',
    vetNote: 'Concentrated omega-3 fatty acids from research-validated wild-caught salmon. 9.3/10 quality score.',
    category: 'Oil',
    commissionRate: 0.08,
    researchScore: 9.3
  },

  'joint supplement': {
    productName: 'Cosequin DS Plus MSM Joint Health Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Cosequin+DS+Plus+MSM+Dogs&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/cosequin-ds-plus-msm-joint-health/dp/148916',
    vetNote: 'Veterinarian-formulated glucosamine supplement. Research-aligned with joint health focus from 35 veterinary sources.',
    category: 'Supplement',
    commissionRate: 0.03,
    researchScore: 9.5
  },

  'probiotic powder': {
    productName: 'Purina FortiFlora Probiotic Supplement',
    amazonLink: 'https://www.amazon.com/s?k=Purina+FortiFlora+Probiotic+Supplement&tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/purina-forti-flora-probiotic-dog/dp/148916',
    vetNote: 'Veterinarian-recommended probiotic for digestive health. Clinically researched for gastrointestinal support.',
    category: 'Supplement',
    commissionRate: 0.03,
    researchScore: 8.5
  },

  // === PREMIUM RESEARCH-BACKED BRANDS ===
  'venison': {
    productName: 'Ziwi Peak Air-Dried Venison Recipe',
    amazonLink: 'https://www.amazon.com/s?k=Ziwi+Peak+Air-Dried+Venison&tag=robinfrench-20',
    vetNote: 'New Zealand venison with green mussels for joint health. 9.9/10 research score - top-ranked by veterinary consensus.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 9.9
  },

  'lamb': {
    productName: 'Raw Paws Lamb Recipe Rolls',
    amazonLink: 'https://www.amazon.com/s?k=Raw+Paws+Lamb+Recipe&tag=robinfrench-20',
    vetNote: 'Novel protein source ideal for dogs with chicken or beef allergies. Research-supported hypoallergenic option.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.9
  },

  // === RESEARCH-ALIGNED FRESH FOOD ===
  'duck breast': {
    productName: 'Fresh Is Best Freeze Dried Duck Breast',
    amazonLink: 'https://www.amazon.com/s?k=Fresh+Is+Best+Freeze+Dried+Duck+Breast&tag=robinfrench-20',
    vetNote: 'Novel protein with healthy fat profile. Research-validated for dogs with common protein sensitivities.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.8
  },

  'rabbit meat': {
    productName: 'Evanger\'s Rabbit Grain Free Cans',
    amazonLink: 'https://www.amazon.com/s?k=Evanger%27s+Rabbit+Grain+Free&tag=robinfrench-20',
    vetNote: 'Hypoallergenic novel protein perfect for elimination diet trials. Veterinary-recommended for food sensitivities.',
    category: 'Meat',
    commissionRate: 0.03,
    researchScore: 8.7
  },

  // === DIGESTIVE HEALTH RESEARCH ===
  'sweet potato': {
    productName: 'Farmer\'s Market Organic Sweet Potato Puree',
    amazonLink: 'https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Sweet+Potato+Puree&tag=robinfrench-20',
    vetNote: 'Complex carbohydrate with beta-carotene and fiber. Research-supported for digestive health and glycemic control.',
    category: 'Carb',
    commissionRate: 0.03,
    researchScore: 8.5
  },

  'pumpkin puree': {
    productName: 'Farmer\'s Market Organic Pumpkin Puree',
    amazonLink: 'https://www.amazon.com/s?k=Farmer%27s+Market+Organic+Pumpkin+Puree&tag=robinfrench-20',
    vetNote: 'Natural soluble fiber for digestive health and stool regulation. Clinically researched for gastrointestinal support.',
    category: 'Carb',
    commissionRate: 0.03,
    researchScore: 8.6
  }
};

/**
 * Get research-backed product recommendations
 */
export function getResearchBackedProduct(genericName: string): VettedProduct | undefined {
  return VETTED_PRODUCTS_RESEARCH[genericName.toLowerCase().trim()];
}

/**
 * Get products sorted by research alignment score
 */
export function getTopResearchProducts(limit: number = 10): Array<[string, VettedProduct]> {
  return Object.entries(VETTED_PRODUCTS_RESEARCH)
    .sort(([,a], [,b]) => (b.researchScore || 0) - (a.researchScore || 0))
    .slice(0, limit);
}

/**
 * Get products for specific health concerns based on research
 */
export function getProductsForHealthConcern(concern: string): VettedProduct[] {
  const concernMappings: Record<string, string[]> = {
    'joint-health': ['joint supplement', 'venison'],
    'digestive-health': ['probiotic powder', 'pumpkin puree', 'sweet potato'],
    'skin-coat': ['fish oil', 'salmon (boneless)'],
    'weight-management': ['ground turkey', 'ground beef (lean)'],
    'allergies': ['lamb', 'duck breast', 'rabbit meat']
  };

  const relevantIngredients = concernMappings[concern] || [];
  return relevantIngredients
    .map(ing => VETTED_PRODUCTS_RESEARCH[ing])
    .filter(Boolean);
}
</file>

<file path="lib/data/vetted-products-UPDATED.ts">
// lib/data/vetted-products-UPDATED.ts
// AUTO-GENERATED with prices and correct ASINs
// Generated: 2025-12-15T21:11:45.659Z

export const VETTED_PRODUCTS = {
  'ground chicken': {
    productName: 'Fresh Is Best Freeze Dried Chicken Breast',
    amazonLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    vetNote: 'High-quality, human-grade chicken breast that maintains nutritional value through freeze-drying.',
    category: 'Meat',
  },
  'ground turkey': {
    productName: 'Diestel Free Range Ground Turkey',
    amazonLink: 'https://www.amazon.com/dp/B091CCD4T7?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B091CCD4T7?tag=robinfrench-20',
    vetNote: 'Premium free-range turkey with optimal protein-to-fat ratio for canine health.',
    category: 'Meat',
  },
  'ground beef (lean)': {
    productName: 'Ground beef (lean)',
    amazonLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Grass-fed, human-grade beef with controlled fat content for weight management.',
    category: 'Meat',
  },
  'ground lamb': {
    productName: 'Raw Paws Lamb Recipe Rolls',
    amazonLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Novel protein source ideal for dogs with chicken or beef allergies.',
    category: 'Meat',
  },
  \'salmon (boneless)': {
    productName: 'A Better Treat Freeze Dried Salmon',
    amazonLink: 'https://www.amazon.com/dp/B08NCDSV82?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08NCDSV82?tag=robinfrench-20',
    vetNote: 'Wild-caught salmon providing essential omega-3 fatty acids for skin, coat, and joint health.',
    category: 'Meat',
  },
  'chicken breast': {
    productName: 'Bell & Evans Boneless Chicken Breast',
    amazonLink: 'https://www.amazon.com/dp/B0787WTY4C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0787WTY4C?tag=robinfrench-20',
    vetNote: 'Air-chilled chicken breast with superior moisture retention and protein quality.',
    category: 'Meat',
  },
  'chicken thighs': {
    productName: 'Bell & Evans Boneless Chicken Thighs',
    amazonLink: 'https://www.amazon.com/dp/B0787YFWYB?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0787YFWYB?tag=robinfrench-20',
    vetNote: 'Higher fat content than breast meat, providing more calories and flavor.',
    category: 'Meat',
  },
  'turkey breast': {
    productName: 'Fresh Is Best Freeze Dried Turkey Tenders',
    amazonLink: 'https://www.amazon.com/dp/B0CZRN7HXT?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CZRN7HXT?tag=robinfrench-20',
    vetNote: 'Lean turkey breast maintaining natural nutrients through gentle freeze-drying.',
    category: 'Meat',
  },
  'beef liver': {
    productName: 'Fresh Is Best Freeze Dried Beef Liver',
    amazonLink: 'https://www.amazon.com/dp/B07G3QFG8N?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07G3QFG8N?tag=robinfrench-20',
    vetNote: 'Rich source of vitamin A, iron, and B vitamins essential for canine health.',
    category: 'Meat',
  },
  'chicken liver': {
    productName: 'Fresh Is Best Freeze Dried Chicken Livers',
    amazonLink: 'https://www.amazon.com/dp/B07S8JCNTH?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07S8JCNTH?tag=robinfrench-20',
    vetNote: 'Concentrated nutrition with high vitamin content and natural enzymes.',
    category: 'Meat',
  },
  'chicken hearts': {
    productName: 'Vital Essentials Freeze Dried Chicken Hearts',
    amazonLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Excellent taurine source and natural chews for dental health.',
    category: 'Meat',
  },
  \'sardines (canned in water)': {
    productName: 'Wild Planet Sardines in Water No Salt',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Omega-3 rich fish with edible bones providing natural calcium and phosphorus.',
    category: 'Meat',
  },
  'eggs': {
    productName: 'Whole Life Pet Freeze Dried Diced Eggs',
    amazonLink: 'https://www.amazon.com/dp/B001DY6U9M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001DY6U9M?tag=robinfrench-20',
    vetNote: 'Complete protein source with all essential amino acids and natural vitamins.',
    category: 'Meat',
  },
  'turkey giblets': {
    productName: 'Vital Essentials Freeze Dried Turkey Giblets',
    amazonLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Natural organ meat mix providing comprehensive nutrition and enzymes.',
    category: 'Meat',
  },
  'chicken giblets': {
    productName: 'Fresh Is Best Freeze Dried Chicken Giblets',
    amazonLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    vetNote: 'Traditional organ meat blend with heart, liver, and gizzard for complete nutrition.',
    category: 'Meat',
  },
  'duck breast': {
    productName: 'Fresh Is Best Freeze Dried Duck Breast',
    amazonLink: 'https://www.amazon.com/dp/B01KAOGE5U?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01KAOGE5U?tag=robinfrench-20',
    vetNote: 'Novel protein with healthy fat profile and rich flavor dogs love.',
    category: 'Meat',
  },
  'venison': {
    productName: 'Fresh Is Best Freeze Dried Venison Bites',
    amazonLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Lean game meat ideal for dogs with allergies or weight management needs.',
    category: 'Meat',
  },
  'rabbit meat': {
    productName: 'Evanger',
    amazonLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Hypoallergenic novel protein perfect for elimination diet trials.',
    category: 'Meat',
  },
  'quail': {
    productName: 'Wholesome Beast Freeze Dried Quail Chicks',
    amazonLink: 'https://www.amazon.com/dp/B0DK1SJ2Z7?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DK1SJ2Z7?tag=robinfrench-20',
    vetNote: 'Small game bird providing novel protein and natural calcium from bones.',
    category: 'Meat',
  },
  'ground pork (lean)': {
    productName: 'Momentum Freeze Dried Pork Tenderloin',
    amazonLink: 'https://www.amazon.com/dp/B0CLJW1P6D?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CLJW1P6D?tag=robinfrench-20',
    vetNote: 'Lean pork alternative for dogs that tolerate it, with good palatability.',
    category: 'Meat',
  },
  'turkey necks': {
    productName: 'Northwest Naturals Freeze Dried Turkey Necks',
    amazonLink: 'https://www.amazon.com/dp/B0FHJ6G2NZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FHJ6G2NZ?tag=robinfrench-20',
    vetNote: 'Natural chews providing dental benefits and natural nutrients.',
    category: 'Meat',
  },
  'brown rice': {
    productName: 'Lundberg Family Farms Organic Brown Rice',
    amazonLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain rice providing complex carbohydrates and fiber for digestive health.',
    category: 'Carb',
  },
  'white rice': {
    productName: 'Nishiki Premium Medium Grain White Rice',
    amazonLink: 'https://www.amazon.com/dp/B00IDQY2PW?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00IDQY2PW?tag=robinfrench-20',
    vetNote: 'Easily digestible carbohydrate source for dogs with sensitive stomachs.',
    category: 'Carb',
  },
  'quinoa': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B07ZJNYGW4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07ZJNYGW4?tag=robinfrench-20',
    vetNote: 'Complete protein grain with all essential amino acids and gluten-free.',
    category: 'Carb',
  },
  \'sweet potato': {
    productName: 'Farmer',
    amazonLink: 'https://www.amazon.com/dp/B07D92VQ9C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07D92VQ9C?tag=robinfrench-20',
    vetNote: 'Complex carbohydrate with beta-carotene and fiber for digestive health.',
    category: 'Carb',
  },
  'pumpkin puree': {
    productName: 'Farmer',
    amazonLink: 'https://www.amazon.com/dp/B0062A87HA?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0062A87HA?tag=robinfrench-20',
    vetNote: 'Natural soluble fiber for digestive health and stool regulation.',
    category: 'Carb',
  },
  'butternut squash': {
    productName: 'Farmer',
    amazonLink: 'https://www.amazon.com/dp/B000HDCSTG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000HDCSTG?tag=robinfrench-20',
    vetNote: 'Low-glycemic carbohydrate with beta-carotene and antioxidants.',
    category: 'Carb',
  },
  'lentils': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B000VDZ2GI?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000VDZ2GI?tag=robinfrench-20',
    vetNote: 'Plant-based protein and fiber source for balanced nutrition.',
    category: 'Carb',
  },
  'chickpeas': {
    productName: 'Goya Organic Chickpeas No Salt',
    amazonLink: 'https://www.amazon.com/dp/B0BYPF1Y79?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BYPF1Y79?tag=robinfrench-20',
    vetNote: 'Protein-rich legume providing complex carbohydrates and minerals.',
    category: 'Carb',
  },
  'black beans': {
    productName: 'Eden Organic Black Beans No Salt',
    amazonLink: 'https://www.amazon.com/dp/B094WYT2BK?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B094WYT2BK?tag=robinfrench-20',
    vetNote: 'High-fiber legume with antioxidants and plant-based protein.',
    category: 'Carb',
  },
  'green peas': {
    productName: 'Nature',
    amazonLink: 'https://www.amazon.com/dp/B074H4SHTD?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074H4SHTD?tag=robinfrench-20',
    vetNote: 'Natural source of plant protein and digestive fiber.',
    category: 'Vegetable',
  },
  'carrots': {
    productName: 'Nature',
    amazonLink: 'https://www.amazon.com/dp/B074H64BPW?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074H64BPW?tag=robinfrench-20',
    vetNote: 'Beta-carotene rich vegetable supporting immune and vision health.',
    category: 'Vegetable',
  },
  \'spinach': {
    productName: 'Earthbound Farm Organic Spinach Frozen',
    amazonLink: 'https://www.amazon.com/dp/B0013ABAJG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0013ABAJG?tag=robinfrench-20',
    vetNote: 'Iron-rich leafy green providing vitamins K, A, and folate.',
    category: 'Vegetable',
  },
  'broccoli': {
    productName: 'Cascadian Farm Organic Broccoli Florets',
    amazonLink: 'https://www.amazon.com/dp/B07SV522V9?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07SV522V9?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with antioxidants and vitamin C.',
    category: 'Vegetable',
  },
  'zucchini': {
    productName: 'Nature',
    amazonLink: 'https://www.amazon.com/dp/B07Q9WV1LY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07Q9WV1LY?tag=robinfrench-20',
    vetNote: 'Low-calorie vegetable providing hydration and minerals.',
    category: 'Vegetable',
  },
  'kale': {
    productName: 'Earthbound Farm Organic Kale',
    amazonLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Nutrient-dense leafy green with calcium and antioxidants.',
    category: 'Vegetable',
  },
  'celery': {
    productName: 'Earthbound Farm Organic Celery',
    amazonLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Low-calorie crunchy vegetable providing hydration and fiber.',
    category: 'Vegetable',
  },
  'brussels sprouts': {
    productName: 'Cascadian Farm Organic Brussels Sprouts',
    amazonLink: 'https://www.amazon.com/dp/B004DAQPR0?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004DAQPR0?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with sulforaphane for antioxidant support.',
    category: 'Vegetable',
  },
  'asparagus': {
    productName: 'Cascadian Farm Organic Asparagus Spears',
    amazonLink: 'https://www.amazon.com/dp/B07QV5G8HY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07QV5G8HY?tag=robinfrench-20',
    vetNote: 'Diuretic vegetable supporting urinary tract health.',
    category: 'Vegetable',
  },
  'parsley': {
    productName: 'McCormick Culinary Parsley Flakes',
    amazonLink: 'https://www.amazon.com/dp/B0D8C4N4WY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D8C4N4WY?tag=robinfrench-20',
    vetNote: 'Fresh herb providing chlorophyll and natural breath freshening.',
    category: 'Vegetable',
  },
  'cucumber': {
    productName: 'Nature',
    amazonLink: 'https://www.amazon.com/dp/B001PLETDC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001PLETDC?tag=robinfrench-20',
    vetNote: 'Hydrating vegetable with natural electrolytes.',
    category: 'Vegetable',
  },
  'lettuce (romaine)': {
    productName: 'Organic Girl Romaine Lettuce',
    amazonLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Leafy green providing hydration and vitamin K.',
    category: 'Vegetable',
  },
  'arugula': {
    productName: 'Organic Girl Baby Arugula',
    amazonLink: 'https://www.amazon.com/dp/B00JXR8RYW?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00JXR8RYW?tag=robinfrench-20',
    vetNote: 'Peppery leafy green with calcium and antioxidants.',
    category: 'Vegetable',
  },
  'endive': {
    productName: 'Organic Endive Greens',
    amazonLink: 'https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20',
    vetNote: 'Bitter leafy green supporting liver health and digestion.',
    category: 'Vegetable',
  },
  'escarole': {
    productName: 'Organic Escarole Greens',
    amazonLink: 'https://www.amazon.com/dp/B084ZVBGQ6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B084ZVBGQ6?tag=robinfrench-20',
    vetNote: 'Mild leafy green providing folate and vitamin K.',
    category: 'Vegetable',
  },
  'dandelion greens': {
    productName: 'Organic Dandelion Greens',
    amazonLink: 'https://www.amazon.com/dp/B000WR4A5M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000WR4A5M?tag=robinfrench-20',
    vetNote: 'Natural diuretic supporting kidney and liver health.',
    category: 'Vegetable',
  },
  'collard greens': {
    productName: 'Organic Collard Greens',
    amazonLink: 'https://www.amazon.com/dp/B000P6H23W?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000P6H23W?tag=robinfrench-20',
    vetNote: 'Calcium-rich leafy green for bone and dental health.',
    category: 'Vegetable',
  },
  'mustard greens': {
    productName: 'Organic Mustard Greens',
    amazonLink: 'https://www.amazon.com/dp/B094JT2CCH?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B094JT2CCH?tag=robinfrench-20',
    vetNote: 'Spicy leafy green with antioxidants and vitamin K.',
    category: 'Vegetable',
  },
  'turnip greens': {
    productName: 'Organic Turnip Greens',
    amazonLink: 'https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20',
    vetNote: 'Nutrient-dense greens with calcium and antioxidants.',
    category: 'Vegetable',
  },
  'beet greens': {
    productName: 'Organic Beet Greens',
    amazonLink: 'https://www.amazon.com/dp/B0F9LNFLTK?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0F9LNFLTK?tag=robinfrench-20',
    vetNote: 'Iron-rich greens supporting red blood cell production.',
    category: 'Vegetable',
  },
  'radish greens': {
    productName: 'Organic Radish Greens',
    amazonLink: 'https://www.amazon.com/dp/B07CHNV4S1?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07CHNV4S1?tag=robinfrench-20',
    vetNote: 'Peppery greens providing vitamin C and minerals.',
    category: 'Vegetable',
  },
  'coconut oil': {
    productName: 'Nutiva Organic Virgin Coconut Oil',
    amazonLink: 'https://www.amazon.com/dp/B00UHCJKVG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00UHCJKVG?tag=robinfrench-20',
    vetNote: 'Medium-chain triglycerides for quick energy and cognitive support.',
    category: 'Oil',
  },
  'olive oil': {
    productName: 'California Olive Ranch Extra Virgin Olive Oil',
    amazonLink: 'https://www.amazon.com/dp/B00GGBLPVU?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00GGBLPVU?tag=robinfrench-20',
    vetNote: 'Monounsaturated fats with antioxidants for skin and coat health.',
    category: 'Oil',
  },
  \'salmon oil': {
    productName: 'Grizzly Salmon Plus Omega-3 Oil',
    amazonLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    vetNote: 'Concentrated omega-3 fatty acids for joint, skin, and heart health.',
    category: 'Oil',
  },
  'flaxseed oil': {
    productName: 'Barlean',
    amazonLink: 'https://www.amazon.com/dp/B002VLZ830?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B002VLZ830?tag=robinfrench-20',
    vetNote: 'Plant-based omega-3 source for skin and coat conditioning.',
    category: 'Oil',
  },
  'fish oil': {
    productName: 'Nordic Naturals Omega-3 Pet',
    amazonLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Purified fish oil with optimal EPA/DHA ratio for canine health.',
    category: 'Oil',
  },
  'taurine powder': {
    productName: 'NOW Supplements Taurine Powder 8 oz',
    amazonLink: 'https://www.amazon.com/dp/B00VAOKFO6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00VAOKFO6?tag=robinfrench-20',
    vetNote: 'Essential amino acid for heart health and vision support in cats.',
    category: 'Supplement',
  },
  'calcium carbonate': {
    productName: 'NOW Supplements Calcium Carbonate Powder',
    amazonLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Highly bioavailable calcium source for bone health and metabolic balance.',
    category: 'Supplement',
  },
  'vitamin e': {
    productName: 'Solgar Vitamin E 400 IU',
    amazonLink: 'https://www.amazon.com/dp/B01I5OB3LW?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01I5OB3LW?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and skin health.',
    category: 'Supplement',
  },
  'b-complex': {
    productName: 'Thorne B-Complex #12',
    amazonLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism and nervous system health.',
    category: 'Supplement',
  },
  'probiotic powder': {
    productName: 'Purina FortiFlora Probiotic Supplement',
    amazonLink: 'https://www.amazon.com/dp/B0BGV8L7L2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BGV8L7L2?tag=robinfrench-20',
    vetNote: 'Veterinarian-recommended probiotic for digestive health and immune support.',
    category: 'Supplement',
  },
  'psyllium husk': {
    productName: 'Organic India Whole Husk Psyllium',
    amazonLink: 'https://www.amazon.com/dp/B0016AXN7A?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0016AXN7A?tag=robinfrench-20',
    vetNote: 'Soluble fiber for digestive health and hairball prevention in cats.',
    category: 'Supplement',
  },
  'joint supplement': {
    productName: 'Cosequin DS Plus MSM for Dogs',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine supplement for joint health and mobility.',
    category: 'Supplement',
  },
  'omega-3 capsules': {
    productName: 'Nordic Naturals Omega-3 Pet Capsules',
    amazonLink: 'https://www.amazon.com/dp/B004OA5XP4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004OA5XP4?tag=robinfrench-20',
    vetNote: 'Purified fish oil capsules providing EPA/DHA for skin, coat, and joint health.',
    category: 'Supplement',
  },
  'digestive enzymes': {
    productName: 'NaturVet Digestive Enzymes Plus Probiotics',
    amazonLink: 'https://www.amazon.com/dp/B00O6FINFO?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00O6FINFO?tag=robinfrench-20',
    vetNote: 'Enzyme blend supporting digestion of proteins, fats, and carbohydrates.',
    category: 'Supplement',
  },
  'hairball paste': {
    productName: 'Tomlyn Laxatone Hairball Remedy',
    amazonLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health.',
    category: 'Supplement',
  },
  'chicken broth': {
    productName: 'Brutus Bone Broth for Dogs No Salt',
    amazonLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes.',
    category: 'Supplement',
  },
  'vitamin e oil': {
    productName: 'NOW Solutions Vitamin E Oil',
    amazonLink: 'https://www.amazon.com/dp/B0DZ5ZCC85?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DZ5ZCC85?tag=robinfrench-20',
    vetNote: 'Natural vitamin E oil for topical skin health and antioxidant support.',
    category: 'Oil',
  },
  'millet (white/red)': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B0002DH3FU?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0002DH3FU?tag=robinfrench-20',
    vetNote: 'High-quality millet spray for parrots and hookbills.',
    category: 'Seed',
  },
  'canary seed': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Traditional canary seed mix for small birds.',
    category: 'Seed',
  },
  'niger seed': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Thistle seed attracting finches and small songbirds.',
    category: 'Seed',
  },
  'oat groats': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Whole oat groats for larger parrots and hookbills.',
    category: 'Seed',
  },
  'hemp seeds': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Nutrient-rich hemp seeds for feather health.',
    category: 'Seed',
  },
  'flaxseeds': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Omega-3 rich flax seeds for skin and feather health.',
    category: 'Seed',
  },
  \'sesame seeds': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Calcium-rich sesame seeds for bone health.',
    category: 'Seed',
  },
  'chia seeds': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Hydrating chia seeds providing omega-3s and fiber.',
    category: 'Seed',
  },
  'quinoa (cooked)': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B001CCOVB4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001CCOVB4?tag=robinfrench-20',
    vetNote: 'Complete protein grain for avian nutrition.',
    category: 'Seed',
  },
  'rapeseed': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Canola/rapeseed for additional dietary variety.',
    category: 'Seed',
  },
  \'sunflower seeds (small amounts)': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'High-fat seeds to be fed in moderation.',
    category: 'Seed',
  },
  'pumpkin seeds': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Nutrient-dense seeds with natural deworming properties.',
    category: 'Seed',
  },
  'bell peppers': {
    productName: 'Earthbound Farm Organic Bell Peppers',
    amazonLink: 'https://www.amazon.com/dp/B000P6J14K?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000P6J14K?tag=robinfrench-20',
    vetNote: 'Vitamin C rich peppers for immune health.',
    category: 'Vegetable',
  },
  'corn (fresh)': {
    productName: 'Cascadian Farm Organic Corn on the Cob',
    amazonLink: 'https://www.amazon.com/dp/B000REL738?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000REL738?tag=robinfrench-20',
    vetNote: 'Fresh corn providing carbohydrates and antioxidants.',
    category: 'Vegetable',
  },
  'apples (no seeds)': {
    productName: 'Organic Honeycrisp Apples',
    amazonLink: 'https://www.amazon.com/dp/B00AR0TG44?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00AR0TG44?tag=robinfrench-20',
    vetNote: 'Vitamin-rich fruit providing natural sugars and fiber.',
    category: 'Fruit',
  },
  'blueberries': {
    productName: 'Driscoll',
    amazonLink: 'https://www.amazon.com/dp/B07Z568Y3N?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07Z568Y3N?tag=robinfrench-20',
    vetNote: 'Antioxidant-rich berries for immune and cognitive health.',
    category: 'Fruit',
  },
  \'strawberries': {
    productName: 'Driscoll',
    amazonLink: 'https://www.amazon.com/dp/B002B8Z98W?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B002B8Z98W?tag=robinfrench-20',
    vetNote: 'Vitamin C rich berries providing natural hydration.',
    category: 'Fruit',
  },
  'mango': {
    productName: 'Organic Mango',
    amazonLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Tropical fruit providing beta-carotene and vitamin C.',
    category: 'Fruit',
  },
  'banana': {
    productName: 'Organic Bananas',
    amazonLink: 'https://www.amazon.com/dp/B07ZLFKBFD?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07ZLFKBFD?tag=robinfrench-20',
    vetNote: 'Potassium-rich fruit for electrolyte balance.',
    category: 'Fruit',
  },
  'grapes (chopped)': {
    productName: 'Organic Red Seedless Grapes',
    amazonLink: 'https://www.amazon.com/dp/B000RGYJI6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000RGYJI6?tag=robinfrench-20',
    vetNote: 'Hydrating fruit providing natural antioxidants.',
    category: 'Fruit',
  },
  'papaya': {
    productName: 'Organic Papaya',
    amazonLink: 'https://www.amazon.com/dp/B07FZ159ZB?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FZ159ZB?tag=robinfrench-20',
    vetNote: 'Digestive enzyme-rich fruit for gut health.',
    category: 'Fruit',
  },
  'melon': {
    productName: 'Organic Cantaloupe Melon',
    amazonLink: 'https://www.amazon.com/dp/B000NSGULC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000NSGULC?tag=robinfrench-20',
    vetNote: 'High-water content fruit for hydration.',
    category: 'Fruit',
  },
  'egg (hard-boiled)': {
    productName: 'Vital Essentials Freeze Dried Egg Yolk Treats',
    amazonLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Calcium and protein-rich egg treats for birds.',
    category: 'Supplement',
  },
  'pellets (fortified)': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Complete nutrition pellets formulated for avian health.',
    category: 'Pellet',
  },
  'cuttlebone': {
    productName: 'Lafeber',
    amazonLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Natural calcium source for beak and bone health.',
    category: 'Supplement',
  },
  'honey (tiny amounts)': {
    productName: 'Local Raw Honey',
    amazonLink: 'https://www.amazon.com/dp/B0791X9GSG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0791X9GSG?tag=robinfrench-20',
    vetNote: 'Natural sweetener and antimicrobial properties (use sparingly).',
    category: 'Supplement',
  },
  'peanut butter (unsalted, tiny amounts)': {
    productName: 'Teddie All Natural Peanut Butter',
    amazonLink: 'https://www.amazon.com/dp/B06ZXZ3JPZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B06ZXZ3JPZ?tag=robinfrench-20',
    vetNote: 'Healthy fat source for foraging enrichment (unsalted only).',
    category: 'Supplement',
  },
  'dubia roaches': {
    productName: 'Josh',
    amazonLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: 'High-quality feeder insects with optimal calcium-to-phosphorus ratio.',
    category: 'Insect',
  },
  'crickets': {
    productName: 'Fluker',
    amazonLink: 'https://www.amazon.com/dp/B000YFGS52?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000YFGS52?tag=robinfrench-20',
    vetNote: 'Standard feeder insects gut-loaded for nutritional value.',
    category: 'Insect',
  },
  'mealworms': {
    productName: 'Fluker',
    amazonLink: 'https://www.amazon.com/dp/B07TKDYMMP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07TKDYMMP?tag=robinfrench-20',
    vetNote: 'Dried mealworms providing fat and protein for insectivorous reptiles.',
    category: 'Insect',
  },
  \'superworms': {
    productName: 'Josh',
    amazonLink: 'https://www.amazon.com/dp/B01018SX5Y?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01018SX5Y?tag=robinfrench-20',
    vetNote: 'Larger feeder insects for bigger reptiles and amphibians.',
    category: 'Insect',
  },
  'black soldier fly larvae': {
    productName: 'Grubblies Black Soldier Fly Larvae',
    amazonLink: 'https://www.amazon.com/dp/B0BLZ88Q3R?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BLZ88Q3R?tag=robinfrench-20',
    vetNote: 'Sustainable, high-calcium feeder insects with excellent nutrition.',
    category: 'Insect',
  },
  'hornworms': {
    productName: 'Josh',
    amazonLink: 'https://www.amazon.com/dp/B09Y4RTNK9?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09Y4RTNK9?tag=robinfrench-20',
    vetNote: 'Moisture-rich feeder insects ideal for tropical species.',
    category: 'Insect',
  },
  'acorn squash': {
    productName: 'Organic Acorn Squash',
    amazonLink: 'https://www.amazon.com/dp/B07FZ34ZS4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FZ34ZS4?tag=robinfrench-20',
    vetNote: 'Nutrient-rich squash providing beta-carotene and fiber.',
    category: 'Vegetable',
  },
  'figs': {
    productName: 'Organic Dried Figs',
    amazonLink: 'https://www.amazon.com/dp/B08MDKF98D?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08MDKF98D?tag=robinfrench-20',
    vetNote: 'Calcium-rich dried fruit for omnivorous reptiles.',
    category: 'Fruit',
  },
  'timothy hay': {
    productName: 'Oxbow Animal Health Western Timothy Hay',
    amazonLink: 'https://www.amazon.com/dp/B006AYMMRY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B006AYMMRY?tag=robinfrench-20',
    vetNote: 'High-quality timothy hay for proper dental health and digestion.',
    category: 'Hay',
  },
  'meadow hay': {
    productName: 'Small Pet Select Meadow Hay',
    amazonLink: 'https://www.amazon.com/dp/B07CJ2FRNC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07CJ2FRNC?tag=robinfrench-20',
    vetNote: 'Nutrient-rich meadow hay providing essential fiber.',
    category: 'Hay',
  },
  'orchard grass hay': {
    productName: 'Oxbow Animal Health Orchard Grass Hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: 'Premium orchard grass hay for optimal small animal nutrition.',
    category: 'Hay',
  },
  'alfalfa hay': {
    productName: 'Kaytee Natural Alfalfa Hay',
    amazonLink: 'https://www.amazon.com/dp/B0CM34Z4BQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CM34Z4BQ?tag=robinfrench-20',
    vetNote: 'Calcium-rich alfalfa hay for young or pregnant small animals.',
    category: 'Hay',
  },
  'romaine lettuce': {
    productName: 'Organic Girl Romaine Lettuce',
    amazonLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Hydrating leafy green providing vitamins and minerals.',
    category: 'Vegetable',
  },
  'cilantro': {
    productName: 'Organic Cilantro',
    amazonLink: 'https://www.amazon.com/dp/B07M9FWTRC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07M9FWTRC?tag=robinfrench-20',
    vetNote: 'Fresh herb providing natural antioxidants and flavor.',
    category: 'Vegetable',
  },
  'basil': {
    productName: 'Organic Basil',
    amazonLink: 'https://www.amazon.com/dp/B097F282FC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B097F282FC?tag=robinfrench-20',
    vetNote: 'Aromatic herb providing antioxidants and natural flavor enhancement.',
    category: 'Vegetable',
  },
  'duck hearts': {
    productName: 'Vital Essentials Freeze Dried Duck Hearts',
    amazonLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Vital Essentials or Raw Paws Pet Food. Freeze-dried for convenience and safety.',
    category: 'Meat',
  },
  'lamb liver': {
    productName: 'Stella & Chewy',
    amazonLink: 'https://www.amazon.com/dp/B0015G862M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0015G862M?tag=robinfrench-20',
    vetNote: 'Northwest Naturals or Stella & Chewy',
    category: 'Meat',
  },
  'duck liver': {
    productName: 'Vital Essentials Freeze Dried Duck Liver',
    amazonLink: 'https://www.amazon.com/dp/B0BWBV5PRJ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BWBV5PRJ?tag=robinfrench-20',
    vetNote: 'Vital Essentials freeze-dried duck liver treat.',
    category: 'Meat',
  },
  'chicken necks': {
    productName: 'Raw Paws Pet Food Raw Chicken Necks',
    amazonLink: 'https://www.amazon.com/dp/B0821PF71M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0821PF71M?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or My Pet Carnivore. Raw chicken necks for dental health.',
    category: 'Meat',
  },
  'turkey thighs': {
    productName: 'Boneless Skinless Turkey Thighs',
    amazonLink: 'https://www.amazon.com/dp/B00AR100NE?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00AR100NE?tag=robinfrench-20',
    vetNote: 'Human-grade source from butcher or grocery store.',
    category: 'Meat',
  },
  'ground duck': {
    productName: 'Raw Paws Pet Food Raw Ground Duck',
    amazonLink: 'https://www.amazon.com/dp/B0BY3CNR3Q?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BY3CNR3Q?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or Darwins Pet Food. Frozen/raw ground duck.',
    category: 'Meat',
  },
  'ground lamb (lean)': {
    productName: 'Lean Ground Lamb Meat',
    amazonLink: 'https://www.amazon.com/dp/B088Y2N6WC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B088Y2N6WC?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground lamb from quality source.',
    category: 'Meat',
  },
  'ground herring': {
    productName: 'K9 Natural Hoki Fish Blend',
    amazonLink: 'https://www.amazon.com/dp/B00B3G89MQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00B3G89MQ?tag=robinfrench-20',
    vetNote: 'K9 Natural hoki/fish blend for pets.',
    category: 'Meat',
  },
  'ground mackerel': {
    productName: 'Northwest Naturals Raw Fish Blend',
    amazonLink: 'https://www.amazon.com/dp/B079Z4MZTG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B079Z4MZTG?tag=robinfrench-20',
    vetNote: 'Northwest Naturals raw fish blend.',
    category: 'Meat',
  },
  'mackerel (canned)': {
    productName: 'Wild Planet Canned Mackerel',
    amazonLink: 'https://www.amazon.com/dp/B017J9X8IA?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B017J9X8IA?tag=robinfrench-20',
    vetNote: 'Wild Planet or Safe Catch. Canned in water, no salt added.',
    category: 'Meat',
  },
  'herring (canned)': {
    productName: 'Crown Prince Canned Herring',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Crown Prince or Season. Canned in water, no salt added.',
    category: 'Meat',
  },
  'chicken sausage (no additives)': {
    productName: 'Applegate Naturals Chicken Sausage',
    amazonLink: 'https://www.amazon.com/dp/B001JO4O80?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001JO4O80?tag=robinfrench-20',
    vetNote: 'Niman Ranch or Applegate. Read labels carefully for nitrates/sugar.',
    category: 'Meat',
  },
  'turkey sausage (no additives)': {
    productName: 'Applegate Naturals Turkey Sausage',
    amazonLink: 'https://www.amazon.com/dp/B00I2VLI5A?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00I2VLI5A?tag=robinfrench-20',
    vetNote: 'Applegate Naturals. Read labels carefully.',
    category: 'Meat',
  },
  'ground pork (lean, small amounts)': {
    productName: 'Lean Ground Pork',
    amazonLink: 'https://www.amazon.com/dp/B01H0AI6J4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01H0AI6J4?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground pork.',
    category: 'Meat',
  },
  'regular potato': {
    productName: 'Fresh Russet Potatoes',
    amazonLink: 'https://www.amazon.com/dp/B09SHBJWBR?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09SHBJWBR?tag=robinfrench-20',
    vetNote: 'Human-grade standard russet potato.',
    category: 'Vegetable',
  },
  'walnut oil': {
    productName: 'La Tourangelle Walnut Oil',
    amazonLink: 'https://www.amazon.com/dp/B00QGWLZ3C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00QGWLZ3C?tag=robinfrench-20',
    vetNote: 'La Tourangelle or NOW Foods. Cold-pressed, human-grade.',
    category: 'Oil',
  },
  'black currant oil': {
    productName: 'NOW Foods Black Currant Seed Oil',
    amazonLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Life-Flo. Capsules often best.',
    category: 'Oil',
  },
  'almond oil': {
    productName: 'Viva Naturals Sweet Almond Oil',
    amazonLink: 'https://www.amazon.com/dp/B0BXMMDNJ8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BXMMDNJ8?tag=robinfrench-20',
    vetNote: 'NOW Foods or Viva Naturals. Cold-pressed, edible grade.',
    category: 'Oil',
  },
  \'sunflower oil': {
    productName: 'High Oleic Sunflower Oil Cold Pressed',
    amazonLink: 'https://www.amazon.com/dp/B00MNTRVPS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00MNTRVPS?tag=robinfrench-20',
    vetNote: 'Goya or BetterBody Foods. High oleic, cold-pressed.',
    category: 'Oil',
  },
  'chia seed oil': {
    productName: 'Healthworks Organic Chia Seed Oil',
    amazonLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Healthworks or Organic Veda. Cold-pressed.',
    category: 'Oil',
  },
  'herring oil': {
    productName: 'Nordic Naturals Pet Herring Oil',
    amazonLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Grizzly Pet Products.',
    category: 'Oil',
  },
  'anchovy oil': {
    productName: 'Carlson Labs Fish Oil Anchovy',
    amazonLink: 'https://www.amazon.com/dp/B0FDNB2DVS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FDNB2DVS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Carlson Labs.',
    category: 'Oil',
  },
  'evening primrose oil': {
    productName: 'Nature',
    amazonLink: 'https://www.amazon.com/dp/B07FPBQ31W?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FPBQ31W?tag=robinfrench-20',
    vetNote: 'NOW Foods or Nature',
    category: 'Oil',
  },
  'mackerel oil': {
    productName: 'Jarrow Formulas Fish Oil Supplement',
    amazonLink: 'https://www.amazon.com/dp/B01NBTJFJB?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01NBTJFJB?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Jarrow Formulas.',
    category: 'Oil',
  },
  \'sardine oil': {
    productName: 'Zesty Paws Sardine Oil for Dogs',
    amazonLink: 'https://www.amazon.com/dp/B0CXKHT5K2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CXKHT5K2?tag=robinfrench-20',
    vetNote: 'Zesty Paws or Grizzly Salmon Oil.',
    category: 'Oil',
  },
  'borage oil': {
    productName: 'NOW Foods Borage Oil Softgels',
    amazonLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Barleans. Cold-pressed.',
    category: 'Oil',
  },
  \'sesame oil': {
    productName: 'Spectrum Cold Pressed Sesame Oil',
    amazonLink: 'https://www.amazon.com/dp/B0797GTG2C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0797GTG2C?tag=robinfrench-20',
    vetNote: 'Chosen Foods or Spectrum. Toasted or un-toasted.',
    category: 'Oil',
  },
  'avocado oil': {
    productName: 'Chosen Foods Pure Avocado Oil',
    amazonLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
  },
  'avocado oil (tiny amounts)': {
    productName: 'Chosen Foods Pure Avocado Oil',
    amazonLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
  },
  'wheat germ oil': {
    productName: 'NOW Foods Wheat Germ Oil Liquid',
    amazonLink: 'https://www.amazon.com/dp/B001GAOHK2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001GAOHK2?tag=robinfrench-20',
    vetNote: 'NOW Foods or Solgar. High potency liquid.',
    category: 'Oil',
  },
  'krill oil': {
    productName: 'Kori Krill Oil Pure Supplement',
    amazonLink: 'https://www.amazon.com/dp/B004HIQ9CY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004HIQ9CY?tag=robinfrench-20',
    vetNote: 'Viva Labs or Kori Krill Oil. Pure krill oil supplement.',
    category: 'Oil',
  },
  'algae oil (dha)': {
    productName: 'Nordic Naturals Algae Omega DHA',
    amazonLink: 'https://www.amazon.com/dp/B079J5YZSS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B079J5YZSS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Algae Omega or Ovega-3. Vegan DHA.',
    category: 'Oil',
  },
  'omega-3 oil': {
    productName: 'Grizzly Salmon Oil for Pets',
    amazonLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil or Nordic Naturals Pet.',
    category: 'Oil',
  },
  'kelp powder': {
    productName: 'NOW Foods Organic Kelp Powder',
    amazonLink: 'https://www.amazon.com/dp/B0002JG1GG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0002JG1GG?tag=robinfrench-20',
    vetNote: 'NOW Foods or Starwest Botanicals. Organic kelp powder.',
    category: 'Supplement',
  },
  'joint health powder': {
    productName: 'Nutramax Dasuquin Joint Health Powder',
    amazonLink: 'https://www.amazon.com/dp/B00PXK1G50?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00PXK1G50?tag=robinfrench-20',
    vetNote: 'Nutramax Dasuquin or VetriScience Glycoflex.',
    category: 'Supplement',
  },
  'amino acid supplement': {
    productName: 'Purina Pro Plan Amino Acid Supplement',
    amazonLink: 'https://www.amazon.com/dp/B0C2JFLZHF?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C2JFLZHF?tag=robinfrench-20',
    vetNote: 'Purina Pro Plan Veterinary Diets amino acid supplement.',
    category: 'Supplement',
  },
  'calcium supplement': {
    productName: 'Thomas Labs Calcium Carbonate Powder',
    amazonLink: 'https://www.amazon.com/dp/B0CKNK682W?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CKNK682W?tag=robinfrench-20',
    vetNote: 'NOW Foods Calcium Carbonate or Thomas Labs Calciboost.',
    category: 'Supplement',
  },
  \'spirulina powder': {
    productName: 'Vimergy Organic Spirulina Powder',
    amazonLink: 'https://www.amazon.com/dp/B08S4982CC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08S4982CC?tag=robinfrench-20',
    vetNote: 'NOW Foods or Vimergy. Organic, high purity.',
    category: 'Supplement',
  },
  'electrolyte powder': {
    productName: 'ReptoBoost Electrolyte Powder',
    amazonLink: 'https://www.amazon.com/dp/B0FMZHN6M1?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FMZHN6M1?tag=robinfrench-20',
    vetNote: 'ReptoBoost or Pedialyte. Unflavored, read labels.',
    category: 'Supplement',
  },
  'vitamin d3 drops': {
    productName: 'Ddrops Liquid Vitamin D3 Drops',
    amazonLink: 'https://www.amazon.com/dp/B0062QD5LM?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0062QD5LM?tag=robinfrench-20',
    vetNote: 'NOW Foods or Ddrops. 1000 IU per drop.',
    category: 'Supplement',
  },
  \'s yeast': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B084JL2R77?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B084JL2R77?tag=robinfrench-20',
    vetNote: 'NOW Foods or Bob',
    category: 'Supplement',
  },
  'buckwheat': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'buckwheat (tiny amounts)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'buckwheat (hulled)': {
    productName: 'Anthony',
    amazonLink: 'https://www.amazon.com/dp/B0D15QDVW7?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D15QDVW7?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  \'sorghum': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'barley': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0D481997Z?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D481997Z?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'barley (cooked, minimal)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'barley (hulled)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'millet': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'millet (tiny amounts)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B07XPCWYP2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07XPCWYP2?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'farro': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'bulgur': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B081DQ5NG5?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B081DQ5NG5?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'amaranth (tiny amounts)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'amaranth seeds': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Seed',
  },
  'teff seeds': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Seed',
  },
  'wheat (hulled)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B000YFB5NC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000YFB5NC?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'oat bran (small amounts)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B07CC9RF6Y?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07CC9RF6Y?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'oatmeal (cooked, small amounts)': {
    productName: 'Quaker Rolled Oats Old Fashioned',
    amazonLink: 'https://www.amazon.com/dp/B00CTLAIH8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00CTLAIH8?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Carb',
  },
  'corn (cracked)': {
    productName: 'Scratch and Peck Cracked Corn Non-GMO',
    amazonLink: 'https://www.amazon.com/dp/B01HHGD81C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01HHGD81C?tag=robinfrench-20',
    vetNote: 'Scratch and Peck Feeds or Purina. Cracked corn non-GMO.',
    category: 'Carb',
  },
  \'safflower seeds': {
    productName: 'Wagner',
    amazonLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: 'Wagner',
    category: 'Seed',
  },
  'nyjer seeds': {
    productName: 'Wagner',
    amazonLink: 'https://www.amazon.com/dp/B0D6688V7C?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D6688V7C?tag=robinfrench-20',
    vetNote: 'Wagner',
    category: 'Seed',
  },
  'bok choi': {
    productName: 'Fresh Baby Bok Choy',
    amazonLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'bok choy (small amounts)': {
    productName: 'Fresh Baby Bok Choy',
    amazonLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'navy beans (mashed)': {
    productName: 'Goya Canned Navy Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/dp/B006AZE13G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B006AZE13G?tag=robinfrench-20',
    vetNote: 'Goya or Bush',
    category: 'Vegetable',
  },
  'kidney beans (mashed)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: 'Goya or Bush',
    category: 'Vegetable',
  },
  'kidney beans (mashed, tiny amounts)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: 'Goya or Bush',
    category: 'Vegetable',
  },
  'pinto beans (mashed)': {
    productName: 'Bush',
    amazonLink: 'https://www.amazon.com/dp/B0C4G2PR58?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C4G2PR58?tag=robinfrench-20',
    vetNote: 'Goya or Bush',
    category: 'Vegetable',
  },
  'purslane': {
    productName: 'Fresh Purslane Leaves',
    amazonLink: 'https://www.amazon.com/dp/B09MDXM2YQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09MDXM2YQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'purslane (small amounts)': {
    productName: 'Fresh Purslane Leaves',
    amazonLink: 'https://www.amazon.com/dp/B0BWY8JWVL?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BWY8JWVL?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  \'s lettuce': {
    productName: 'Miner',
    amazonLink: 'https://www.amazon.com/dp/B0D3J7FZFD?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D3J7FZFD?tag=robinfrench-20',
    vetNote: 'Fresh produce or seeds for growing.',
    category: 'Vegetable',
  },
  'flaxseed (ground)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B075XC6C69?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B075XC6C69?tag=robinfrench-20',
    vetNote: 'Bob',
    category: 'Seed',
  },
  'fennel': {
    productName: 'Fresh Fennel Bulb',
    amazonLink: 'https://www.amazon.com/dp/B00E3J6RC4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00E3J6RC4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'delicata squash': {
    productName: 'Fresh Delicata Squash',
    amazonLink: 'https://www.amazon.com/dp/B07KHH8K4L?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07KHH8K4L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'yellow squash': {
    productName: 'Fresh Yellow Summer Squash',
    amazonLink: 'https://www.amazon.com/dp/B08QVBFGDC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08QVBFGDC?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'leeks': {
    productName: 'Fresh Leeks',
    amazonLink: 'https://www.amazon.com/dp/B09HQJGQDG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09HQJGQDG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  \'shallots': {
    productName: 'Fresh Shallots',
    amazonLink: 'https://www.amazon.com/dp/B09B2ZWHKQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09B2ZWHKQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'tomatoes (small amounts)': {
    productName: 'Fresh Ripe Vine Tomatoes',
    amazonLink: 'https://www.amazon.com/dp/B086WX15TH?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B086WX15TH?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'napa cabbage': {
    productName: 'Fresh Napa Cabbage',
    amazonLink: 'https://www.amazon.com/dp/B07FTVYNM3?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FTVYNM3?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'napa cabbage (small amounts)': {
    productName: 'Fresh Napa Cabbage',
    amazonLink: 'https://www.amazon.com/dp/B079VV1K9L?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B079VV1K9L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'artichokes': {
    productName: 'Fresh Artichoke Hearts',
    amazonLink: 'https://www.amazon.com/dp/B0DF91JXND?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DF91JXND?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'frisee': {
    productName: 'Fresh Frisee Lettuce',
    amazonLink: 'https://www.amazon.com/dp/B07FZGKZL4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FZGKZL4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'radicchio': {
    productName: 'Fresh Radicchio Lettuce',
    amazonLink: 'https://www.amazon.com/dp/B00BJPTZLA?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00BJPTZLA?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'red cabbage': {
    productName: 'Fresh Red Cabbage Head',
    amazonLink: 'https://www.amazon.com/dp/B000RH1MXK?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000RH1MXK?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'green cabbage': {
    productName: 'Fresh Green Cabbage Head',
    amazonLink: 'https://www.amazon.com/dp/B09HQGDCKV?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09HQGDCKV?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  \'swiss chard': {
    productName: 'Fresh Swiss Chard',
    amazonLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  \'swiss chard (cooked, tiny amounts)': {
    productName: 'Fresh Swiss Chard',
    amazonLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'lettuce (romaine, small amounts)': {
    productName: 'Fresh Romaine Lettuce Hearts',
    amazonLink: 'https://www.amazon.com/dp/B074H5J9G2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074H5J9G2?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'red leaf lettuce': {
    productName: 'Fresh Red Leaf Lettuce',
    amazonLink: 'https://www.amazon.com/dp/B0BX76BG5V?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BX76BG5V?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'mache': {
    productName: 'Fresh Mache Lamb',
    amazonLink: 'https://www.amazon.com/dp/B00AWLAQFG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00AWLAQFG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'alfalfa sprouts (small amounts)': {
    productName: 'Fresh Alfalfa Sprouts',
    amazonLink: 'https://www.amazon.com/dp/B0DFZTWLTY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DFZTWLTY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'cat grass (wheatgrass)': {
    productName: 'SmartyKat Cat Grass Growing Kit Wheatgrass',
    amazonLink: 'https://www.amazon.com/dp/B0D45F9TGG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0D45F9TGG?tag=robinfrench-20',
    vetNote: 'SmartyKat or Catit. Cat Grass growing kit wheatgrass.',
    category: 'Vegetable',
  },
  \'squash (cooked)': {
    productName: 'Fresh Butternut Squash',
    amazonLink: 'https://www.amazon.com/dp/B002QY3U5A?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B002QY3U5A?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  \'s quarters': {
    productName: 'Lamb',
    amazonLink: 'https://www.amazon.com/dp/B0DYPHGW89?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DYPHGW89?tag=robinfrench-20',
    vetNote: 'Wild harvested or seeds for growing.',
    category: 'Vegetable',
  },
  'amaranth leaves': {
    productName: 'Fresh Amaranth Leaves',
    amazonLink: 'https://www.amazon.com/dp/B0F2YRBGS6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0F2YRBGS6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'ginger (small amounts)': {
    productName: 'Simply Organic Fresh Ginger Root',
    amazonLink: 'https://www.amazon.com/dp/B0C6V3416T?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C6V3416T?tag=robinfrench-20',
    vetNote: 'McCormick or Simply Organic. Organic ginger root fresh.',
    category: 'Vegetable',
  },
  'turmeric': {
    productName: 'Simply Organic Pure Turmeric Powder',
    amazonLink: 'https://www.amazon.com/dp/B018GPDCV4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B018GPDCV4?tag=robinfrench-20',
    vetNote: 'Simply Organic or Tummydrops. Pure turmeric powder.',
    category: 'Supplement',
  },
  'rosemary': {
    productName: 'Frontier Co-op Dried Organic Rosemary',
    amazonLink: 'https://www.amazon.com/dp/B004JWLMNY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004JWLMNY?tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried organic rosemary.',
    category: 'Vegetable',
  },
  \'sage': {
    productName: 'Simply Organic Dried Sage Leaf',
    amazonLink: 'https://www.amazon.com/dp/B0CH3R9TVY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CH3R9TVY?tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried sage leaf.',
    category: 'Vegetable',
  },
  'mint': {
    productName: 'Fresh Mint Leaves',
    amazonLink: 'https://www.amazon.com/dp/B097F3NT7N?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B097F3NT7N?tag=robinfrench-20',
    vetNote: 'Fresh produce or Mountain Rose Herbs. Fresh mint leaves.',
    category: 'Vegetable',
  },
  'garlic chives': {
    productName: 'Fresh Garlic Chives',
    amazonLink: 'https://www.amazon.com/dp/B097F3J1PY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B097F3J1PY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
  },
  'raisins (unsweetened)': {
    productName: 'Sun-Maid Organic Raisins Unsweetened',
    amazonLink: 'https://www.amazon.com/dp/B01GXPRIQY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01GXPRIQY?tag=robinfrench-20',
    vetNote: 'Sun-Maid or Trader Joe',
    category: 'Fruit',
  },
  'plums (pitted)': {
    productName: 'Fresh Plums Pitted',
    amazonLink: 'https://www.amazon.com/dp/B07P6Z8L76?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07P6Z8L76?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
  },
  'apricots (pitted)': {
    productName: 'NOW Foods Dried Apricots Unsulphured',
    amazonLink: 'https://www.amazon.com/dp/B07FZWBPC5?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07FZWBPC5?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried apricots unsulphured no sugar.',
    category: 'Fruit',
  },
  'kiwi': {
    productName: 'Fresh Kiwi Fruit',
    amazonLink: 'https://www.amazon.com/dp/B01LASWK7G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01LASWK7G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
  },
  'mulberries': {
    productName: 'Terrasoul Dried Mulberries Organic',
    amazonLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Navitas Organics or Terrasoul Superfoods. Dried mulberries organic.',
    category: 'Fruit',
  },
  'raspberries': {
    productName: 'Fresh Raspberries Organic',
    amazonLink: 'https://www.amazon.com/dp/B000P6G12U?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000P6G12U?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
  },
  'cranberries': {
    productName: 'NOW Foods Dried Cranberries Unsweetened',
    amazonLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried cranberries unsweetened.',
    category: 'Fruit',
  },
  'pineapple (small amounts)': {
    productName: 'Fresh Pineapple Fruit',
    amazonLink: 'https://www.amazon.com/dp/B000P6L3V4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000P6L3V4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
  },
  'pears (no seeds)': {
    productName: 'Fresh Pears No Seeds',
    amazonLink: 'https://www.amazon.com/dp/B0DYKVQ3XZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DYKVQ3XZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
  },
  'pinhead crickets': {
    productName: 'Josh',
    amazonLink: 'https://www.amazon.com/dp/B07196FX9W?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07196FX9W?tag=robinfrench-20',
    vetNote: 'Josh',
    category: 'Insect',
  },
  'locusts': {
    productName: 'Exo Terra Canned Locusts Reptile Food',
    amazonLink: 'https://www.amazon.com/dp/B000CMKHBS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000CMKHBS?tag=robinfrench-20',
    vetNote: 'Rainbow Mealworms or Exo Terra. Canned locusts reptile food.',
    category: 'Insect',
  },
  'butterworms': {
    productName: 'Rainbow Mealworms Live Butterworms',
    amazonLink: 'https://www.amazon.com/dp/B093BD8NXR?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B093BD8NXR?tag=robinfrench-20',
    vetNote: 'Josh',
    category: 'Insect',
  },
  'grasshoppers': {
    productName: 'Fluker',
    amazonLink: 'https://www.amazon.com/dp/B004HSQRG2?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004HSQRG2?tag=robinfrench-20',
    vetNote: 'Fluker',
    category: 'Insect',
  },
  \'small dubia roaches': {
    productName: 'Small Live Dubia Roaches Feeder',
    amazonLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: 'DubiaRoaches.com or Josh',
    category: 'Insect',
  },
  \'silkworms': {
    productName: 'Live Silkworms Reptile Food',
    amazonLink: 'https://www.amazon.com/dp/B08JKNZPSF?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08JKNZPSF?tag=robinfrench-20',
    vetNote: 'Coastal Silkworms or SilkwormShop. Live silkworms reptile food.',
    category: 'Insect',
  },
  'earthworms': {
    productName: 'Uncle Jim',
    amazonLink: 'https://www.amazon.com/dp/B097PDMK47?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B097PDMK47?tag=robinfrench-20',
    vetNote: 'Uncle Jim',
    category: 'Insect',
  },
  'wheat hay': {
    productName: 'Oxbow Wheat Hay Small Animal',
    amazonLink: 'https://www.amazon.com/dp/B0CLC76V98?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CLC76V98?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Wheat hay small animal.',
    category: 'Hay',
  },
  'fescue hay': {
    productName: 'Small Pet Select Fescue Hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6YIF36?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00S6YIF36?tag=robinfrench-20',
    vetNote: 'Small Pet Select fescue hay.',
    category: 'Hay',
  },
  'oat hay': {
    productName: 'Oxbow Oat Hay Small Animal',
    amazonLink: 'https://www.amazon.com/dp/B000WFKP80?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000WFKP80?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Oat hay small animal.',
    category: 'Hay',
  },
  'bluegrass hay': {
    productName: 'Small Pet Select Bluegrass Hay',
    amazonLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: 'Small Pet Select bluegrass hay.',
    category: 'Hay',
  },
  \'straw (wheat/pine)': {
    productName: 'Oxbow Wheat Straw Bedding',
    amazonLink: 'https://www.amazon.com/dp/B0CDQMD1CB?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CDQMD1CB?tag=robinfrench-20',
    vetNote: 'Kaytee or Oxbow. Wheat straw bedding.',
    category: 'Hay',
  },
  'dried grass': {
    productName: 'Kaytee Dried Natural Grass Small Animal',
    amazonLink: 'https://www.amazon.com/dp/B0002DK8OI?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0002DK8OI?tag=robinfrench-20',
    vetNote: 'Kaytee or Timothy Grass. Dried natural grass small animal.',
    category: 'Hay',
  },
  'bermuda hay': {
    productName: 'Standlee Premium Bermuda Hay',
    amazonLink: 'https://www.amazon.com/dp/B0FSVM5P3D?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FSVM5P3D?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Standlee Hay. Premium bermuda hay.',
    category: 'Hay',
  },
  'barley hay': {
    productName: 'Standlee Barley Hay',
    amazonLink: 'https://www.amazon.com/dp/B08YM9VJC5?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08YM9VJC5?tag=robinfrench-20',
    vetNote: 'Small Pet Select or Standlee Hay. Barley hay.',
    category: 'Hay',
  },
  'guinea pig pellets (with vitamin c)': {
    productName: 'Oxbow Essentials Cavy Cuisine Guinea Pig Pellets',
    amazonLink: 'https://www.amazon.com/dp/B00E4KT5NA?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00E4KT5NA?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Cavy Cuisine or Sherwood. Guinea pig pellets with vitamin C.',
    category: 'Pellet',
  },
  'rabbit pellets (high fiber)': {
    productName: 'Oxbow Essentials Rabbit Food High Fiber',
    amazonLink: 'https://www.amazon.com/dp/B0017JANQY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0017JANQY?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Rabbit Food. Adult rabbit pellets high fiber.',
    category: 'Pellet',
  },
  'hamster pellets (higher protein)': {
    productName: 'Oxbow Essentials Hamster Food Higher Protein',
    amazonLink: 'https://www.amazon.com/dp/B0053SYJVA?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0053SYJVA?tag=robinfrench-20',
    vetNote: 'Higgins Sunburst or Oxbow Essentials. Hamster food higher protein.',
    category: 'Pellet',
  },
  'wild bird mix': {
    productName: 'Lyric Wild Bird Mix No Filler',
    amazonLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: 'Lyric or Kaytee. Wild bird mix no filler.',
    category: 'Pellet',
  },
  'beta-glucans': {
    productName: 'NOW Supplements Beta Glucans 60 Capsules',
    amazonLink: 'https://www.amazon.com/dp/B01LWVNL9J?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01LWVNL9J?tag=robinfrench-20',
    vetNote: 'Immune-supporting beta-glucans from yeast or mushrooms for enhanced immune function.',
    category: 'Supplement',
  },
  'biotin': {
    productName: 'NOW Supplements Biotin 5000 mcg',
    amazonLink: 'https://www.amazon.com/dp/B01AMJCHB8?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01AMJCHB8?tag=robinfrench-20',
    vetNote: 'B-complex vitamin essential for healthy skin, coat, and metabolic function.',
    category: 'Supplement',
  },
  'bone broth (low sodium)': {
    productName: 'Brutus Bone Broth for Dogs Low Sodium',
    amazonLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes without excess sodium.',
    category: 'Supplement',
  },
  'cauliflower': {
    productName: 'Fresh Organic Cauliflower',
    amazonLink: 'https://www.amazon.com/dp/B000P6G0GM?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000P6G0GM?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
  },
  'chicory root': {
    productName: 'NOW Supplements Inulin Prebiotic Fiber',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: 'Supplement',
  },
  'chondroitin sulfate': {
    productName: 'Cosequin DS Plus MSM with Chondroitin',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with chondroitin for cartilage health and mobility.',
    category: 'Supplement',
  },
  'cranberry extract': {
    productName: 'NOW Supplements Cranberry Extract 5000 mg',
    amazonLink: 'https://www.amazon.com/dp/B01N7KMPU3?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01N7KMPU3?tag=robinfrench-20',
    vetNote: 'Concentrated cranberry extract supporting urinary tract health and preventing bacterial adhesion.',
    category: 'Supplement',
  },
  'curcumin (turmeric extract)': {
    productName: 'NOW Supplements Curcumin with BioPerine',
    amazonLink: 'https://www.amazon.com/dp/B0CK3C31JP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CK3C31JP?tag=robinfrench-20',
    vetNote: 'Anti-inflammatory curcumin from turmeric with enhanced absorption for joint and immune support.',
    category: 'Supplement',
  },
  'd-mannose': {
    productName: 'NOW Supplements D-Mannose Powder',
    amazonLink: 'https://www.amazon.com/dp/B01N6X9YBS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01N6X9YBS?tag=robinfrench-20',
    vetNote: 'Natural sugar compound supporting urinary tract health by preventing bacterial adhesion.',
    category: 'Supplement',
  },
  'egg yolks': {
    productName: 'Vital Farms Pasture-Raised Eggs',
    amazonLink: 'https://www.amazon.com/dp/B00M1QWODW?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00M1QWODW?tag=robinfrench-20',
    vetNote: 'High-quality eggs from pasture-raised hens, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
  },
  'eggplant': {
    productName: 'Fresh Organic Eggplant',
    amazonLink: 'https://www.amazon.com/dp/B001PLGQPQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B001PLGQPQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable with fiber and antioxidants.',
    category: 'Vegetable',
  },
  'eggshells (crushed)': {
    productName: 'NOW Supplements Calcium Carbonate Powder',
    amazonLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Crushed eggshells provide natural calcium carbonate. Can be prepared at home from organic eggs or use calcium supplement.',
    category: 'Supplement',
  },
  'fish broth (no salt)': {
    productName: 'Brutus Fish Broth for Dogs No Salt',
    amazonLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated fish broth providing omega-3s, collagen, and natural flavor without added salt.',
    category: 'Supplement',
  },
  'fructooligosaccharides (fos)': {
    productName: 'NOW Supplements FOS Prebiotic Fiber',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber supporting beneficial gut bacteria growth and digestive health.',
    category: 'Supplement',
  },
  'glucosamine sulfate': {
    productName: 'Cosequin DS Plus MSM Glucosamine',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine sulfate for joint cartilage health and mobility support.',
    category: 'Supplement',
  },
  'green beans': {
    productName: 'Fresh Organic Green Beans',
    amazonLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
  },
  'green beans (cooked)': {
    productName: 'Fresh Organic Green Beans',
    amazonLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam or boil until tender for optimal digestibility.',
    category: 'Vegetable',
  },
  'hairball control paste': {
    productName: 'Tomlyn Laxatone Hairball Remedy',
    amazonLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health in cats.',
    category: 'Supplement',
  },
  'hyaluronic acid': {
    productName: 'NOW Supplements Hyaluronic Acid 100 mg',
    amazonLink: 'https://www.amazon.com/dp/B07XHNCJMC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07XHNCJMC?tag=robinfrench-20',
    vetNote: 'Joint health supplement supporting cartilage hydration and joint lubrication.',
    category: 'Supplement',
  },
  'inulin (prebiotic)': {
    productName: 'NOW Supplements Inulin Prebiotic Fiber',
    amazonLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: 'Supplement',
  },
  'jerusalem artichoke': {
    productName: 'Fresh Jerusalem Artichoke Sunchokes',
    amazonLink: 'https://www.amazon.com/dp/B0CQK5XCVZ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CQK5XCVZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Prebiotic-rich root vegetable supporting gut health.',
    category: 'Vegetable',
  },
  'joint health supplement': {
    productName: 'Cosequin DS Plus MSM for Dogs',
    amazonLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with glucosamine, chondroitin, and MSM for joint health and mobility.',
    category: 'Supplement',
  },
  'l-carnitine powder': {
    productName: 'NOW Supplements L-Carnitine 500 mg',
    amazonLink: 'https://www.amazon.com/dp/B06Y1BTLGK?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B06Y1BTLGK?tag=robinfrench-20',
    vetNote: 'Amino acid supporting heart health, energy metabolism, and weight management.',
    category: 'Supplement',
  },
  'lysine powder': {
    productName: 'NOW Supplements L-Lysine 1000 mg',
    amazonLink: 'https://www.amazon.com/dp/B00V3MR88G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B00V3MR88G?tag=robinfrench-20',
    vetNote: 'Essential amino acid supporting immune function, collagen production, and overall health.',
    category: 'Supplement',
  },
  'malabar spinach': {
    productName: 'Fresh Malabar Spinach Leaves',
    amazonLink: 'https://www.amazon.com/dp/B0DLT7BSNJ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0DLT7BSNJ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green with vitamins and minerals.',
    category: 'Vegetable',
  },
  'mannanoligosaccharides (mos)': {
    productName: 'NOW Supplements MOS Prebiotic',
    amazonLink: 'https://www.amazon.com/dp/B0CRFWM2Z6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CRFWM2Z6?tag=robinfrench-20',
    vetNote: 'Prebiotic supplement supporting beneficial gut bacteria and immune function.',
    category: 'Supplement',
  },
  'milk thistle': {
    productName: 'NOW Supplements Milk Thistle 150 mg',
    amazonLink: 'https://www.amazon.com/dp/B0019LVFD0?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0019LVFD0?tag=robinfrench-20',
    vetNote: 'Liver-supporting herb with antioxidant properties for hepatic health and detoxification.',
    category: 'Supplement',
  },
  'new zealand spinach': {
    productName: 'Fresh New Zealand Spinach',
    amazonLink: 'https://www.amazon.com/dp/B0C8VD126M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0C8VD126M?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green alternative to traditional spinach.',
    category: 'Vegetable',
  },
  'niacinamide': {
    productName: 'NOW Supplements Niacinamide 500 mg',
    amazonLink: 'https://www.amazon.com/dp/B0CZMBZPLV?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0CZMBZPLV?tag=robinfrench-20',
    vetNote: 'B-vitamin (B3) supporting energy metabolism, skin health, and nervous system function.',
    category: 'Supplement',
  },
  'oats (rolled)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B07VCM66N6?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07VCM66N6?tag=robinfrench-20',
    vetNote: 'Whole grain rolled oats providing fiber, B vitamins, and sustained energy. Cook thoroughly before serving.',
    category: 'Carb',
  },
  'peas': {
    productName: 'Fresh Organic Green Peas',
    amazonLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Protein-rich legume with fiber and vitamins.',
    category: 'Vegetable',
  },
  'peas (mashed)': {
    productName: 'Fresh Organic Green Peas',
    amazonLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
  },
  'pectin (from apples)': {
    productName: 'NOW Supplements Apple Pectin Powder',
    amazonLink: 'https://www.amazon.com/dp/B01CO69SYG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01CO69SYG?tag=robinfrench-20',
    vetNote: 'Soluble fiber from apples supporting digestive health and blood sugar regulation.',
    category: 'Supplement',
  },
  'pumpkin seed oil': {
    productName: 'NOW Solutions Pumpkin Seed Oil',
    amazonLink: 'https://www.amazon.com/dp/B0FKYLMWYG?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKYLMWYG?tag=robinfrench-20',
    vetNote: 'Omega-3 and omega-6 rich oil supporting urinary health, skin, and coat condition.',
    category: 'Oil',
  },
  'quail eggs': {
    productName: 'Fresh Quail Eggs',
    amazonLink: 'https://www.amazon.com/dp/B0BSRGV9PR?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BSRGV9PR?tag=robinfrench-20',
    vetNote: 'Small nutrient-dense eggs from quail, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
  },
  'quercetin': {
    productName: 'NOW Supplements Quercetin with Bromelain',
    amazonLink: 'https://www.amazon.com/dp/B08M5L372P?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08M5L372P?tag=robinfrench-20',
    vetNote: 'Antioxidant flavonoid supporting immune function, allergy relief, and anti-inflammatory benefits.',
    category: 'Supplement',
  },
  'rice (hulled)': {
    productName: 'Lundberg Organic Brown Rice',
    amazonLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain brown rice with hull removed, providing fiber, B vitamins, and sustained energy.',
    category: 'Carb',
  },
  'romanesco broccoli': {
    productName: 'Fresh Romanesco Broccoli',
    amazonLink: 'https://www.amazon.com/dp/B01I1Q74MQ?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01I1Q74MQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich cruciferous vegetable with vitamins C and K.',
    category: 'Vegetable',
  },
  \'s-adenosyl methionine (sam-e)': {
    productName: 'NOW Supplements SAM-e 200 mg',
    amazonLink: 'https://www.amazon.com/dp/B000OSSQFY?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B000OSSQFY?tag=robinfrench-20',
    vetNote: 'Methyl donor supporting liver health, joint function, and mood regulation.',
    category: 'Supplement',
  },
  \'sardines (in water)': {
    productName: 'Wild Planet Sardines in Water No Salt',
    amazonLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Wild-caught sardines canned in water without added salt. Rich in omega-3s, calcium, and protein.',
    category: 'Meat',
  },
  \'snap peas': {
    productName: 'Fresh Organic Snap Peas',
    amazonLink: 'https://www.amazon.com/dp/B077L6C7YB?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B077L6C7YB?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Edible-pod peas rich in fiber and vitamins.',
    category: 'Vegetable',
  },
  \'snow peas': {
    productName: 'Fresh Organic Snow Peas',
    amazonLink: 'https://www.amazon.com/dp/B07MGSDD7L?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07MGSDD7L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Flat-podded peas with tender texture and mild flavor.',
    category: 'Vegetable',
  },
  \'snow peas (mashed)': {
    productName: 'Fresh Organic Snow Peas',
    amazonLink: 'https://www.amazon.com/dp/B08KRNKC9G?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08KRNKC9G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
  },
  \'split peas': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Soak and cook thoroughly before serving.',
    category: 'Carb',
  },
  \'split peas (mashed)': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Cook and mash for optimal digestibility.',
    category: 'Carb',
  },
  \'sugar snap peas': {
    productName: 'Fresh Organic Sugar Snap Peas',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Sweet, crisp peas with edible pods rich in fiber.',
    category: 'Vegetable',
  },
  \'sugar snap peas (mashed)': {
    productName: 'Fresh Organic Sugar Snap Peas',
    amazonLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
  },
  'turkey broth (no salt)': {
    productName: 'Brutus Turkey Broth for Dogs No Salt',
    amazonLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated turkey broth providing protein, collagen, and natural flavor without added salt.',
    category: 'Supplement',
  },
  'vitamin b complex': {
    productName: 'Thorne B-Complex #12',
    amazonLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism, nervous system health, and overall vitality.',
    category: 'Supplement',
  },
  'vitamin c (small amounts)': {
    productName: 'NOW Supplements Vitamin C 1000 mg',
    amazonLink: 'https://www.amazon.com/dp/B074GCB1ND?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B074GCB1ND?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and collagen production. Use in small amounts as directed.',
    category: 'Supplement',
  },
  'watercress': {
    productName: 'Fresh Organic Watercress',
    amazonLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-dense leafy green with vitamins A, C, and K.',
    category: 'Vegetable',
  },
  'watercress (small amounts)': {
    productName: 'Fresh Organic Watercress',
    amazonLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Use in small amounts due to strong flavor and oxalate content.',
    category: 'Vegetable',
  },
  'wheat germ': {
    productName: 'Bob',
    amazonLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Nutrient-dense wheat germ providing vitamin E, B vitamins, and healthy fats for skin and coat health.',
    category: 'Supplement',
  },
  'wild rice': {
    productName: 'Lundberg Organic Wild Rice',
    amazonLink: 'https://www.amazon.com/dp/B089CP461X?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/B089CP461X?tag=robinfrench-20',
    vetNote: 'Whole grain wild rice providing protein, fiber, and B vitamins. Cook thoroughly before serving.',
    category: 'Carb',
  },
};
</file>

<file path="lib/data/vetted-products.ts.backup-prices">
// lib/data/vetted-products.ts
// Comprehensive veterinarian-vetted product mappings for all recipe ingredients
// Each ingredient maps to a specific, high-quality product with direct Amazon ASIN link

interface VettedProduct {
  // The specific, branded name to display on the shopping list
  productName: string;
  // The direct Amazon ASIN link (ASIN-based product link)
  asinLink: string;
  // Chewy affiliate link (when available)
  chewyLink?: string;
  // Specialty vendor link (raw food, subscription services)
  specialtyLink?: string;
  // Primary purchase link (usually Amazon)
  purchaseLink?: string;
  // A short note explaining *why* this product was chosen (for the user)
  vetNote: string;
  // Category for shopping list grouping
  category?: 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';
  // Commission rate estimate for prioritization
  commissionRate?: number;
  // Current price information (fetched from Amazon)
  price?: {
    amount: number;        // Current price in USD
    currency: string;      // 'USD'
    lastUpdated: string;   // ISO date string
    unit?: string;         // Optional: 'per lb', 'per oz', etc.
  };
}

// Map: [Generic Ingredient Name (lowercase)] -> VettedProduct
export const VETTED_PRODUCTS: Record<string, VettedProduct> = {
  // === PROTEINS (Dogs & Cats) ===
  'ground chicken': {
    productName: 'Fresh Is Best Freeze Dried Chicken Breast',
    asinLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/fresh-is-best-freeze-dried-chicken/dp/148916',
    vetNote: 'High-quality, human-grade chicken breast that maintains nutritional value through freeze-drying.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground turkey': {
    productName: 'Diestel Free Range Ground Turkey',
    asinLink: 'https://www.amazon.com/dp/B091CCD4T7?tag=robinfrench-20',
    vetNote: 'Premium free-range turkey with optimal protein-to-fat ratio for canine health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground beef (lean)': {
    productName: 'US Wellness Meats Pet Burger',
    asinLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Grass-fed, human-grade beef with controlled fat content for weight management.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground lamb': {
    productName: 'Raw Paws Lamb Recipe Rolls',
    asinLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Novel protein source ideal for dogs with chicken or beef allergies.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'salmon (boneless)': {
    productName: 'A Better Treat Freeze Dried Salmon',
    asinLink: 'https://www.amazon.com/dp/B08NCDSV82?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/better-treat-freeze-dried-salmon/dp/155916',
    vetNote: 'Wild-caught salmon providing essential omega-3 fatty acids for skin, coat, and joint health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken breast': {
    productName: 'Bell & Evans Boneless Chicken Breast',
    asinLink: 'https://www.amazon.com/dp/B0787WTY4C?tag=robinfrench-20',
    vetNote: 'Air-chilled chicken breast with superior moisture retention and protein quality.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken thighs': {
    productName: 'Bell & Evans Boneless Chicken Thighs',
    asinLink: 'https://www.amazon.com/dp/B0787YFWYB?tag=robinfrench-20',
    vetNote: 'Higher fat content than breast meat, providing more calories and flavor.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey breast': {
    productName: 'Fresh Is Best Freeze Dried Turkey Tenders',
    asinLink: 'https://www.amazon.com/dp/B0CZRN7HXT?tag=robinfrench-20',
    vetNote: 'Lean turkey breast maintaining natural nutrients through gentle freeze-drying.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'beef liver': {
    productName: 'Fresh Is Best Freeze Dried Beef Liver',
    asinLink: 'https://www.amazon.com/dp/B07G3QFG8N?tag=robinfrench-20',
    vetNote: 'Rich source of vitamin A, iron, and B vitamins essential for canine health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken liver': {
    productName: 'Fresh Is Best Freeze Dried Chicken Livers',
    asinLink: 'https://www.amazon.com/dp/B07S8JCNTH?tag=robinfrench-20',
    vetNote: 'Concentrated nutrition with high vitamin content and natural enzymes.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken hearts': {
    productName: 'Vital Essentials Freeze Dried Chicken Hearts',
    asinLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Excellent taurine source and natural chews for dental health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'sardines (canned in water)': {
    productName: 'Wild Planet Sardines in Water No Salt',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Omega-3 rich fish with edible bones providing natural calcium and phosphorus.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'eggs': {
    productName: 'Whole Life Pet Freeze Dried Diced Eggs',
    asinLink: 'https://www.amazon.com/dp/B001DY6U9M?tag=robinfrench-20',
    vetNote: 'Complete protein source with all essential amino acids and natural vitamins.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey giblets': {
    productName: 'Vital Essentials Freeze Dried Turkey Giblets',
    asinLink: 'https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20',
    vetNote: 'Natural organ meat mix providing comprehensive nutrition and enzymes.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken giblets': {
    productName: 'Fresh Is Best Freeze Dried Chicken Giblets',
    asinLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20',
    vetNote: 'Traditional organ meat blend with heart, liver, and gizzard for complete nutrition.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'duck breast': {
    productName: 'Fresh Is Best Freeze Dried Duck Breast',
    asinLink: 'https://www.amazon.com/dp/B01KAOGE5U?tag=robinfrench-20',
    vetNote: 'Novel protein with healthy fat profile and rich flavor dogs love.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'venison': {
    productName: 'Fresh Is Best Freeze Dried Venison Bites',
    asinLink: 'https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20',
    vetNote: 'Lean game meat ideal for dogs with allergies or weight management needs.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'rabbit meat': {
    productName: 'Evanger\'s Rabbit Grain Free Cans',
    asinLink: 'https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20',
    vetNote: 'Hypoallergenic novel protein perfect for elimination diet trials.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'quail': {
    productName: 'Wholesome Beast Freeze Dried Quail Chicks',
    asinLink: 'https://www.amazon.com/dp/B0DK1SJ2Z7?tag=robinfrench-20',
    vetNote: 'Small game bird providing novel protein and natural calcium from bones.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground pork (lean)': {
    productName: 'Momentum Freeze Dried Pork Tenderloin',
    asinLink: 'https://www.amazon.com/dp/B0CLJW1P6D?tag=robinfrench-20',
    vetNote: 'Lean pork alternative for dogs that tolerate it, with good palatability.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey necks': {
    productName: 'Northwest Naturals Freeze Dried Turkey Necks',
    asinLink: 'https://www.amazon.com/dp/B0FHJ6G2NZ?tag=robinfrench-20',
    vetNote: 'Natural chews providing dental benefits and natural nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },

  // === CARBS, VEGETABLES & FATS (Dogs & Cats) ===
  'brown rice': {
    productName: 'Lundberg Family Farms Organic Brown Rice',
    asinLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain rice providing complex carbohydrates and fiber for digestive health.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'white rice': {
    productName: 'Nishiki Premium Medium Grain White Rice',
    asinLink: 'https://www.amazon.com/dp/B00IDQY2PW?tag=robinfrench-20',
    vetNote: 'Easily digestible carbohydrate source for dogs with sensitive stomachs.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'quinoa': {
    productName: 'Bob\'s Red Mill Organic White Quinoa',
    asinLink: 'https://www.amazon.com/dp/B07ZJNYGW4?tag=robinfrench-20',
    vetNote: 'Complete protein grain with all essential amino acids and gluten-free.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'sweet potato': {
    productName: 'Farmer\'s Market Organic Sweet Potato Puree',
    asinLink: 'https://www.amazon.com/dp/B07D92VQ9C?tag=robinfrench-20',
    vetNote: 'Complex carbohydrate with beta-carotene and fiber for digestive health.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'pumpkin puree': {
    productName: 'Farmer\'s Market Organic Pumpkin Puree',
    asinLink: 'https://www.amazon.com/dp/B0062A87HA?tag=robinfrench-20',
    vetNote: 'Natural soluble fiber for digestive health and stool regulation.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'butternut squash': {
    productName: 'Farmer\'s Market Organic Butternut Squash Puree',
    asinLink: 'https://www.amazon.com/dp/B000HDCSTG?tag=robinfrench-20',
    vetNote: 'Low-glycemic carbohydrate with beta-carotene and antioxidants.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'lentils': {
    productName: 'Bob\'s Red Mill Organic Red Lentils',
    asinLink: 'https://www.amazon.com/dp/B000VDZ2GI?tag=robinfrench-20',
    vetNote: 'Plant-based protein and fiber source for balanced nutrition.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'chickpeas': {
    productName: 'Goya Organic Chickpeas No Salt',
    asinLink: 'https://www.amazon.com/dp/B0BYPF1Y79?tag=robinfrench-20',
    vetNote: 'Protein-rich legume providing complex carbohydrates and minerals.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'black beans': {
    productName: 'Eden Organic Black Beans No Salt',
    asinLink: 'https://www.amazon.com/dp/B094WYT2BK?tag=robinfrench-20',
    vetNote: 'High-fiber legume with antioxidants and plant-based protein.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'green peas': {
    productName: 'Nature\'s Touch Frozen Organic Green Peas',
    asinLink: 'https://www.amazon.com/dp/B074H4SHTD?tag=robinfrench-20',
    vetNote: 'Natural source of plant protein and digestive fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'carrots': {
    productName: 'Nature\'s Touch Frozen Organic Carrots',
    asinLink: 'https://www.amazon.com/dp/B074H64BPW?tag=robinfrench-20',
    vetNote: 'Beta-carotene rich vegetable supporting immune and vision health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'spinach': {
    productName: 'Earthbound Farm Organic Spinach Frozen',
    asinLink: 'https://www.amazon.com/dp/B0013ABAJG?tag=robinfrench-20',
    vetNote: 'Iron-rich leafy green providing vitamins K, A, and folate.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'broccoli': {
    productName: 'Cascadian Farm Organic Broccoli Florets',
    asinLink: 'https://www.amazon.com/dp/B07SV522V9?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with antioxidants and vitamin C.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'zucchini': {
    productName: 'Nature\'s Touch Frozen Organic Zucchini',
    asinLink: 'https://www.amazon.com/dp/B07Q9WV1LY?tag=robinfrench-20',
    vetNote: 'Low-calorie vegetable providing hydration and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kale': {
    productName: 'Earthbound Farm Organic Kale',
    asinLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Nutrient-dense leafy green with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'celery': {
    productName: 'Earthbound Farm Organic Celery',
    asinLink: 'https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20',
    vetNote: 'Low-calorie crunchy vegetable providing hydration and fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'brussels sprouts': {
    productName: 'Cascadian Farm Organic Brussels Sprouts',
    asinLink: 'https://www.amazon.com/dp/B004DAQPR0?tag=robinfrench-20',
    vetNote: 'Cruciferous vegetable with sulforaphane for antioxidant support.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'asparagus': {
    productName: 'Cascadian Farm Organic Asparagus Spears',
    asinLink: 'https://www.amazon.com/dp/B07QV5G8HY?tag=robinfrench-20',
    vetNote: 'Diuretic vegetable supporting urinary tract health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'parsley': {
    productName: 'McCormick Culinary Parsley Flakes',
    asinLink: 'https://www.amazon.com/dp/B0D8C4N4WY?tag=robinfrench-20',
    vetNote: 'Fresh herb providing chlorophyll and natural breath freshening.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cucumber': {
    productName: 'Nature\'s Touch Frozen Organic Cucumber',
    asinLink: 'https://www.amazon.com/dp/B001PLETDC?tag=robinfrench-20',
    vetNote: 'Hydrating vegetable with natural electrolytes.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lettuce (romaine)': {
    productName: 'Organic Girl Romaine Lettuce',
    asinLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Leafy green providing hydration and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'arugula': {
    productName: 'Organic Girl Baby Arugula',
    asinLink: 'https://www.amazon.com/dp/B00JXR8RYW?tag=robinfrench-20',
    vetNote: 'Peppery leafy green with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'endive': {
    productName: 'Organic Endive Greens',
    asinLink: 'https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20',
    vetNote: 'Bitter leafy green supporting liver health and digestion.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'escarole': {
    productName: 'Organic Escarole Greens',
    asinLink: 'https://www.amazon.com/dp/B084ZVBGQ6?tag=robinfrench-20',
    vetNote: 'Mild leafy green providing folate and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'dandelion greens': {
    productName: 'Organic Dandelion Greens',
    asinLink: 'https://www.amazon.com/dp/B000WR4A5M?tag=robinfrench-20',
    vetNote: 'Natural diuretic supporting kidney and liver health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'collard greens': {
    productName: 'Organic Collard Greens',
    asinLink: 'https://www.amazon.com/dp/B000P6H23W?tag=robinfrench-20',
    vetNote: 'Calcium-rich leafy green for bone and dental health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mustard greens': {
    productName: 'Organic Mustard Greens',
    asinLink: 'https://www.amazon.com/dp/B094JT2CCH?tag=robinfrench-20',
    vetNote: 'Spicy leafy green with antioxidants and vitamin K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turnip greens': {
    productName: 'Organic Turnip Greens',
    asinLink: 'https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20',
    vetNote: 'Nutrient-dense greens with calcium and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'beet greens': {
    productName: 'Organic Beet Greens',
    asinLink: 'https://www.amazon.com/dp/B0F9LNFLTK?tag=robinfrench-20',
    vetNote: 'Iron-rich greens supporting red blood cell production.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'radish greens': {
    productName: 'Organic Radish Greens',
    asinLink: 'https://www.amazon.com/dp/B07CHNV4S1?tag=robinfrench-20',
    vetNote: 'Peppery greens providing vitamin C and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'coconut oil': {
    productName: 'Nutiva Organic Virgin Coconut Oil',
    asinLink: 'https://www.amazon.com/dp/B00UHCJKVG?tag=robinfrench-20',
    vetNote: 'Medium-chain triglycerides for quick energy and cognitive support.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'olive oil': {
    productName: 'California Olive Ranch Extra Virgin Olive Oil',
    asinLink: 'https://www.amazon.com/dp/B00GGBLPVU?tag=robinfrench-20',
    vetNote: 'Monounsaturated fats with antioxidants for skin and coat health.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'salmon oil': {
    productName: 'Grizzly Salmon Plus Omega-3 Oil',
    asinLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    chewyLink: 'https://www.chewy.com/grizzly-salmon-oil-omega-3-wild/dp/148916',
    vetNote: 'Concentrated omega-3 fatty acids for joint, skin, and heart health.',
    category: 'Oil',
    commissionRate: 0.08
  },
  'flaxseed oil': {
    productName: 'Barlean\'s Organic Flax Oil',
    asinLink: 'https://www.amazon.com/dp/B002VLZ830?tag=robinfrench-20',
    vetNote: 'Plant-based omega-3 source for skin and coat conditioning.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'fish oil': {
    productName: 'Nordic Naturals Omega-3 Pet',
    asinLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Purified fish oil with optimal EPA/DHA ratio for canine health.',
    category: 'Oil',
    commissionRate: 0.03
  },

  // === SUPPLEMENTS (Dogs & Cats) ===
  'taurine powder': {
    productName: 'NOW Supplements Taurine Powder 8 oz',
    asinLink: 'https://www.amazon.com/dp/B00VAOKFO6?tag=robinfrench-20',
    vetNote: 'Essential amino acid for heart health and vision support in cats.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'calcium carbonate': {
    productName: 'NOW Supplements Calcium Carbonate Powder',
    asinLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Highly bioavailable calcium source for bone health and metabolic balance.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'vitamin e': {
    productName: 'Solgar Vitamin E 400 IU',
    asinLink: 'https://www.amazon.com/dp/B01I5OB3LW?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and skin health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'b-complex': {
    productName: 'Thorne B-Complex #12',
    asinLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism and nervous system health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'probiotic powder': {
    productName: 'Purina FortiFlora Probiotic Supplement',
    asinLink: 'https://www.amazon.com/dp/B0BGV8L7L2?tag=robinfrench-20',
    vetNote: 'Veterinarian-recommended probiotic for digestive health and immune support.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'psyllium husk': {
    productName: 'Organic India Whole Husk Psyllium',
    asinLink: 'https://www.amazon.com/dp/B0016AXN7A?tag=robinfrench-20',
    vetNote: 'Soluble fiber for digestive health and hairball prevention in cats.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'joint supplement': {
    productName: 'Cosequin DS Plus MSM for Dogs',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine supplement for joint health and mobility.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'omega-3 capsules': {
    productName: 'Nordic Naturals Omega-3 Pet Capsules',
    asinLink: 'https://www.amazon.com/dp/B004OA5XP4?tag=robinfrench-20',
    vetNote: 'Purified fish oil capsules providing EPA/DHA for skin, coat, and joint health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'digestive enzymes': {
    productName: 'NaturVet Digestive Enzymes Plus Probiotics',
    asinLink: 'https://www.amazon.com/dp/B00O6FINFO?tag=robinfrench-20',
    vetNote: 'Enzyme blend supporting digestion of proteins, fats, and carbohydrates.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'hairball paste': {
    productName: 'Tomlyn Laxatone Hairball Remedy',
    asinLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'chicken broth': {
    productName: 'Brutus Bone Broth for Dogs No Salt',
    asinLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'vitamin e oil': {
    productName: 'NOW Solutions Vitamin E Oil',
    asinLink: 'https://www.amazon.com/dp/B0DZ5ZCC85?tag=robinfrench-20',
    vetNote: 'Natural vitamin E oil for topical skin health and antioxidant support.',
    category: 'Oil',
    commissionRate: 0.03
  },

  // === BIRDS ===
  'millet (white/red)': {
    productName: 'Lafeber\'s Parrot Food White Millet Spray',
    asinLink: 'https://www.amazon.com/dp/B0002DH3FU?tag=robinfrench-20',
    vetNote: 'High-quality millet spray for parrots and hookbills.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'canary seed': {
    productName: 'Lafeber\'s Parrot Food Canary Seed',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Traditional canary seed mix for small birds.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'niger seed': {
    productName: 'Lafeber\'s Parrot Food Niger Seed',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Thistle seed attracting finches and small songbirds.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'oat groats': {
    productName: 'Lafeber\'s Parrot Food Oat Groats',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Whole oat groats for larger parrots and hookbills.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'hemp seeds': {
    productName: 'Lafeber\'s Parrot Food Hemp Seed',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Nutrient-rich hemp seeds for feather health.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'flaxseeds': {
    productName: 'Lafeber\'s Parrot Food Flax Seed',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Omega-3 rich flax seeds for skin and feather health.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'sesame seeds': {
    productName: 'Lafeber\'s Parrot Food Sesame Seed',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Calcium-rich sesame seeds for bone health.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'chia seeds': {
    productName: 'Lafeber\'s Parrot Food Chia Seed',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Hydrating chia seeds providing omega-3s and fiber.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'quinoa (cooked)': {
    productName: 'Lafeber\'s Parrot Food Cooked Quinoa',
    asinLink: 'https://www.amazon.com/dp/B001CCOVB4?tag=robinfrench-20',
    vetNote: 'Complete protein grain for avian nutrition.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'rapeseed': {
    productName: 'Lafeber\'s Parrot Food Rapeseed',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Canola/rapeseed for additional dietary variety.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'sunflower seeds (small amounts)': {
    productName: 'Lafeber\'s Parrot Food Sunflower Seed',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'High-fat seeds to be fed in moderation.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'pumpkin seeds': {
    productName: 'Lafeber\'s Parrot Food Pumpkin Seed',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Nutrient-dense seeds with natural deworming properties.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'bell peppers': {
    productName: 'Earthbound Farm Organic Bell Peppers',
    asinLink: 'https://www.amazon.com/dp/B000P6J14K?tag=robinfrench-20',
    vetNote: 'Vitamin C rich peppers for immune health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'corn (fresh)': {
    productName: 'Cascadian Farm Organic Corn on the Cob',
    asinLink: 'https://www.amazon.com/dp/B000REL738?tag=robinfrench-20',
    vetNote: 'Fresh corn providing carbohydrates and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'apples (no seeds)': {
    productName: 'Organic Honeycrisp Apples',
    asinLink: 'https://www.amazon.com/dp/B00AR0TG44?tag=robinfrench-20',
    vetNote: 'Vitamin-rich fruit providing natural sugars and fiber.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'blueberries': {
    productName: 'Driscoll\'s Organic Blueberries',
    asinLink: 'https://www.amazon.com/dp/B07Z568Y3N?tag=robinfrench-20',
    vetNote: 'Antioxidant-rich berries for immune and cognitive health.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'strawberries': {
    productName: 'Driscoll\'s Organic Strawberries',
    asinLink: 'https://www.amazon.com/dp/B002B8Z98W?tag=robinfrench-20',
    vetNote: 'Vitamin C rich berries providing natural hydration.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'mango': {
    productName: 'Organic Mango',
    asinLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Tropical fruit providing beta-carotene and vitamin C.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'banana': {
    productName: 'Organic Bananas',
    asinLink: 'https://www.amazon.com/dp/B07ZLFKBFD?tag=robinfrench-20',
    vetNote: 'Potassium-rich fruit for electrolyte balance.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'grapes (chopped)': {
    productName: 'Organic Red Seedless Grapes',
    asinLink: 'https://www.amazon.com/dp/B000RGYJI6?tag=robinfrench-20',
    vetNote: 'Hydrating fruit providing natural antioxidants.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'papaya': {
    productName: 'Organic Papaya',
    asinLink: 'https://www.amazon.com/dp/B07FZ159ZB?tag=robinfrench-20',
    vetNote: 'Digestive enzyme-rich fruit for gut health.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'melon': {
    productName: 'Organic Cantaloupe Melon',
    asinLink: 'https://www.amazon.com/dp/B000NSGULC?tag=robinfrench-20',
    vetNote: 'High-water content fruit for hydration.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'egg (hard-boiled)': {
    productName: 'Vital Essentials Freeze Dried Egg Yolk Treats',
    asinLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Calcium and protein-rich egg treats for birds.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'pellets (fortified)': {
    productName: 'Lafeber\'s Parrot Food Pellets',
    asinLink: 'https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20',
    vetNote: 'Complete nutrition pellets formulated for avian health.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'cuttlebone': {
    productName: 'Lafeber\'s Parrot Food Cuttlebone',
    asinLink: 'https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20',
    vetNote: 'Natural calcium source for beak and bone health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'honey (tiny amounts)': {
    productName: 'Local Raw Honey',
    asinLink: 'https://www.amazon.com/dp/B0791X9GSG?tag=robinfrench-20',
    vetNote: 'Natural sweetener and antimicrobial properties (use sparingly).',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'peanut butter (unsalted, tiny amounts)': {
    productName: 'Teddie All Natural Peanut Butter',
    asinLink: 'https://www.amazon.com/dp/B06ZXZ3JPZ?tag=robinfrench-20',
    vetNote: 'Healthy fat source for foraging enrichment (unsalted only).',
    category: 'Supplement',
    commissionRate: 0.03
  },

  // === REPTILES ===
  'dubia roaches': {
    productName: 'Josh\'s Frogs Live Dubia Roaches',
    asinLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: 'High-quality feeder insects with optimal calcium-to-phosphorus ratio.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'crickets': {
    productName: 'Fluker\'s Live Crickets',
    asinLink: 'https://www.amazon.com/dp/B000YFGS52?tag=robinfrench-20',
    vetNote: 'Standard feeder insects gut-loaded for nutritional value.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'mealworms': {
    productName: 'Fluker\'s Freeze Dried Mealworms',
    asinLink: 'https://www.amazon.com/dp/B07TKDYMMP?tag=robinfrench-20',
    vetNote: 'Dried mealworms providing fat and protein for insectivorous reptiles.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'superworms': {
    productName: 'Josh\'s Frogs Live Superworms',
    asinLink: 'https://www.amazon.com/dp/B01018SX5Y?tag=robinfrench-20',
    vetNote: 'Larger feeder insects for bigger reptiles and amphibians.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'black soldier fly larvae': {
    productName: 'Grubblies Black Soldier Fly Larvae',
    asinLink: 'https://www.amazon.com/dp/B0BLZ88Q3R?tag=robinfrench-20',
    vetNote: 'Sustainable, high-calcium feeder insects with excellent nutrition.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'hornworms': {
    productName: 'Josh\'s Frogs Live Hornworms',
    asinLink: 'https://www.amazon.com/dp/B09Y4RTNK9?tag=robinfrench-20',
    vetNote: 'Moisture-rich feeder insects ideal for tropical species.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'acorn squash': {
    productName: 'Organic Acorn Squash',
    asinLink: 'https://www.amazon.com/dp/B07FZ34ZS4?tag=robinfrench-20',
    vetNote: 'Nutrient-rich squash providing beta-carotene and fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'figs': {
    productName: 'Organic Dried Figs',
    asinLink: 'https://www.amazon.com/dp/B08MDKF98D?tag=robinfrench-20',
    vetNote: 'Calcium-rich dried fruit for omnivorous reptiles.',
    category: 'Fruit',
    commissionRate: 0.03
  },

  // === POCKET PETS ===
  'timothy hay': {
    productName: 'Oxbow Animal Health Western Timothy Hay',
    asinLink: 'https://www.amazon.com/dp/B006AYMMRY?tag=robinfrench-20',
    vetNote: 'High-quality timothy hay for proper dental health and digestion.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'meadow hay': {
    productName: 'Small Pet Select Meadow Hay',
    asinLink: 'https://www.amazon.com/dp/B07CJ2FRNC?tag=robinfrench-20',
    vetNote: 'Nutrient-rich meadow hay providing essential fiber.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'orchard grass hay': {
    productName: 'Oxbow Animal Health Orchard Grass Hay',
    asinLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: 'Premium orchard grass hay for optimal small animal nutrition.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'alfalfa hay': {
    productName: 'Kaytee Natural Alfalfa Hay',
    asinLink: 'https://www.amazon.com/dp/B0CM34Z4BQ?tag=robinfrench-20',
    vetNote: 'Calcium-rich alfalfa hay for young or pregnant small animals.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'romaine lettuce': {
    productName: 'Organic Girl Romaine Lettuce',
    asinLink: 'https://www.amazon.com/dp/B0F3YTY4XQ?tag=robinfrench-20',
    vetNote: 'Hydrating leafy green providing vitamins and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cilantro': {
    productName: 'Organic Cilantro',
    asinLink: 'https://www.amazon.com/dp/B07M9FWTRC?tag=robinfrench-20',
    vetNote: 'Fresh herb providing natural antioxidants and flavor.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'basil': {
    productName: 'Organic Basil',
    asinLink: 'https://www.amazon.com/dp/B097F282FC?tag=robinfrench-20',
    vetNote: 'Aromatic herb providing antioxidants and natural flavor enhancement.',
    category: 'Vegetable',
    commissionRate: 0.03
  },

  // === COMPREHENSIVE VETTED PRODUCTS (128 ingredients from sourcing guide) ===
  'duck hearts': {
    productName: 'Vital Essentials Freeze Dried Duck Hearts',
    asinLink: 'https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20',
    vetNote: 'Vital Essentials or Raw Paws Pet Food. Freeze-dried for convenience and safety.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'lamb liver': {
    productName: 'Stella & Chewy\'s Freeze Dried Lamb Liver',
    asinLink: 'https://www.amazon.com/dp/B0015G862M?tag=robinfrench-20',
    vetNote: 'Northwest Naturals or Stella & Chewy\'s. Freeze-dried organ meat.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'duck liver': {
    productName: 'Vital Essentials Freeze Dried Duck Liver',
    asinLink: 'https://www.amazon.com/dp/B0BWBV5PRJ?tag=robinfrench-20',
    vetNote: 'Vital Essentials freeze-dried duck liver treat.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken necks': {
    productName: 'Raw Paws Pet Food Raw Chicken Necks',
    asinLink: 'https://www.amazon.com/dp/B0821PF71M?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or My Pet Carnivore. Raw chicken necks for dental health.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey thighs': {
    productName: 'Boneless Skinless Turkey Thighs',
    asinLink: 'https://www.amazon.com/dp/B00AR100NE?tag=robinfrench-20',
    vetNote: 'Human-grade source from butcher or grocery store.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground duck': {
    productName: 'Raw Paws Pet Food Raw Ground Duck',
    asinLink: 'https://www.amazon.com/dp/B0BY3CNR3Q?tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or Darwins Pet Food. Frozen/raw ground duck.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground lamb (lean)': {
    productName: 'Lean Ground Lamb Meat',
    asinLink: 'https://www.amazon.com/dp/B088Y2N6WC?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground lamb from quality source.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground herring': {
    productName: 'K9 Natural Hoki Fish Blend',
    asinLink: 'https://www.amazon.com/dp/B00B3G89MQ?tag=robinfrench-20',
    vetNote: 'K9 Natural hoki/fish blend for pets.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground mackerel': {
    productName: 'Northwest Naturals Raw Fish Blend',
    asinLink: 'https://www.amazon.com/dp/B079Z4MZTG?tag=robinfrench-20',
    vetNote: 'Northwest Naturals raw fish blend.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'mackerel (canned)': {
    productName: 'Wild Planet Canned Mackerel',
    asinLink: 'https://www.amazon.com/dp/B017J9X8IA?tag=robinfrench-20',
    vetNote: 'Wild Planet or Safe Catch. Canned in water, no salt added.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'herring (canned)': {
    productName: 'Crown Prince Canned Herring',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Crown Prince or Season. Canned in water, no salt added.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'chicken sausage (no additives)': {
    productName: 'Applegate Naturals Chicken Sausage',
    asinLink: 'https://www.amazon.com/dp/B001JO4O80?tag=robinfrench-20',
    vetNote: 'Niman Ranch or Applegate. Read labels carefully for nitrates/sugar.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'turkey sausage (no additives)': {
    productName: 'Applegate Naturals Turkey Sausage',
    asinLink: 'https://www.amazon.com/dp/B00I2VLI5A?tag=robinfrench-20',
    vetNote: 'Applegate Naturals. Read labels carefully.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'ground pork (lean, small amounts)': {
    productName: 'Lean Ground Pork',
    asinLink: 'https://www.amazon.com/dp/B01H0AI6J4?tag=robinfrench-20',
    vetNote: 'Human-grade lean ground pork.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'regular potato': {
    productName: 'Fresh Russet Potatoes',
    asinLink: 'https://www.amazon.com/dp/B09SHBJWBR?tag=robinfrench-20',
    vetNote: 'Human-grade standard russet potato.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'walnut oil': {
    productName: 'La Tourangelle Walnut Oil',
    asinLink: 'https://www.amazon.com/dp/B00QGWLZ3C?tag=robinfrench-20',
    vetNote: 'La Tourangelle or NOW Foods. Cold-pressed, human-grade.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'black currant oil': {
    productName: 'NOW Foods Black Currant Seed Oil',
    asinLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Life-Flo. Capsules often best.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'almond oil': {
    productName: 'Viva Naturals Sweet Almond Oil',
    asinLink: 'https://www.amazon.com/dp/B0BXMMDNJ8?tag=robinfrench-20',
    vetNote: 'NOW Foods or Viva Naturals. Cold-pressed, edible grade.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'sunflower oil': {
    productName: 'High Oleic Sunflower Oil Cold Pressed',
    asinLink: 'https://www.amazon.com/dp/B00MNTRVPS?tag=robinfrench-20',
    vetNote: 'Goya or BetterBody Foods. High oleic, cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'chia seed oil': {
    productName: 'Healthworks Organic Chia Seed Oil',
    asinLink: 'https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20',
    vetNote: 'Healthworks or Organic Veda. Cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'herring oil': {
    productName: 'Nordic Naturals Pet Herring Oil',
    asinLink: 'https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Grizzly Pet Products.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'anchovy oil': {
    productName: 'Carlson Labs Fish Oil Anchovy',
    asinLink: 'https://www.amazon.com/dp/B0FDNB2DVS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Carlson Labs.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'evening primrose oil': {
    productName: 'Nature\'s Way Evening Primrose Oil',
    asinLink: 'https://www.amazon.com/dp/B07FPBQ31W?tag=robinfrench-20',
    vetNote: 'NOW Foods or Nature\'s Way. Capsules often best.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'mackerel oil': {
    productName: 'Jarrow Formulas Fish Oil Supplement',
    asinLink: 'https://www.amazon.com/dp/B01NBTJFJB?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Jarrow Formulas.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'sardine oil': {
    productName: 'Zesty Paws Sardine Oil for Dogs',
    asinLink: 'https://www.amazon.com/dp/B0CXKHT5K2?tag=robinfrench-20',
    vetNote: 'Zesty Paws or Grizzly Salmon Oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'borage oil': {
    productName: 'NOW Foods Borage Oil Softgels',
    asinLink: 'https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20',
    vetNote: 'NOW Foods or Barleans. Cold-pressed.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'sesame oil': {
    productName: 'Spectrum Cold Pressed Sesame Oil',
    asinLink: 'https://www.amazon.com/dp/B0797GTG2C?tag=robinfrench-20',
    vetNote: 'Chosen Foods or Spectrum. Toasted or un-toasted.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'avocado oil': {
    productName: 'Chosen Foods Pure Avocado Oil',
    asinLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'avocado oil (tiny amounts)': {
    productName: 'Chosen Foods Pure Avocado Oil',
    asinLink: 'https://www.amazon.com/dp/B0C3WCRNPN?tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'wheat germ oil': {
    productName: 'NOW Foods Wheat Germ Oil Liquid',
    asinLink: 'https://www.amazon.com/dp/B001GAOHK2?tag=robinfrench-20',
    vetNote: 'NOW Foods or Solgar. High potency liquid.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'krill oil': {
    productName: 'Kori Krill Oil Pure Supplement',
    asinLink: 'https://www.amazon.com/dp/B004HIQ9CY?tag=robinfrench-20',
    vetNote: 'Viva Labs or Kori Krill Oil. Pure krill oil supplement.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'algae oil (dha)': {
    productName: 'Nordic Naturals Algae Omega DHA',
    asinLink: 'https://www.amazon.com/dp/B079J5YZSS?tag=robinfrench-20',
    vetNote: 'Nordic Naturals Algae Omega or Ovega-3. Vegan DHA.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'omega-3 oil': {
    productName: 'Grizzly Salmon Oil for Pets',
    asinLink: 'https://www.amazon.com/dp/B09RYYWHH1?tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil or Nordic Naturals Pet.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'kelp powder': {
    productName: 'NOW Foods Organic Kelp Powder',
    asinLink: 'https://www.amazon.com/dp/B0002JG1GG?tag=robinfrench-20',
    vetNote: 'NOW Foods or Starwest Botanicals. Organic kelp powder.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'joint health powder': {
    productName: 'Nutramax Dasuquin Joint Health Powder',
    asinLink: 'https://www.amazon.com/dp/B00PXK1G50?tag=robinfrench-20',
    vetNote: 'Nutramax Dasuquin or VetriScience Glycoflex.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'amino acid supplement': {
    productName: 'Purina Pro Plan Amino Acid Supplement',
    asinLink: 'https://www.amazon.com/dp/B0C2JFLZHF?tag=robinfrench-20',
    vetNote: 'Purina Pro Plan Veterinary Diets amino acid supplement.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'calcium supplement': {
    productName: 'Thomas Labs Calcium Carbonate Powder',
    asinLink: 'https://www.amazon.com/dp/B0CKNK682W?tag=robinfrench-20',
    vetNote: 'NOW Foods Calcium Carbonate or Thomas Labs Calciboost.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'spirulina powder': {
    productName: 'Vimergy Organic Spirulina Powder',
    asinLink: 'https://www.amazon.com/dp/B08S4982CC?tag=robinfrench-20',
    vetNote: 'NOW Foods or Vimergy. Organic, high purity.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'electrolyte powder': {
    productName: 'ReptoBoost Electrolyte Powder',
    asinLink: 'https://www.amazon.com/dp/B0FMZHN6M1?tag=robinfrench-20',
    vetNote: 'ReptoBoost or Pedialyte. Unflavored, read labels.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'vitamin d3 drops': {
    productName: 'Ddrops Liquid Vitamin D3 Drops',
    asinLink: 'https://www.amazon.com/dp/B0062QD5LM?tag=robinfrench-20',
    vetNote: 'NOW Foods or Ddrops. 1000 IU per drop.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'brewer\'s yeast': {
    productName: 'Bob\'s Red Mill Brewer\'s Yeast Flakes',
    asinLink: 'https://www.amazon.com/dp/B084JL2R77?tag=robinfrench-20',
    vetNote: 'NOW Foods or Bob\'s Red Mill. Nutritional or brewer\'s yeast.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'buckwheat': {
    productName: 'Bob\'s Red Mill Raw Hulled Buckwheat Groats',
    asinLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Raw hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'buckwheat (tiny amounts)': {
    productName: 'Bob\'s Red Mill Raw Hulled Buckwheat Groats',
    asinLink: 'https://www.amazon.com/dp/B00KQ17MDG?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Raw hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'buckwheat (hulled)': {
    productName: 'Anthony\'s Goods Hulled Buckwheat Groats',
    asinLink: 'https://www.amazon.com/dp/B0D15QDVW7?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Hulled buckwheat groats.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'sorghum': {
    productName: 'Bob\'s Red Mill Whole Grain Sorghum',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Shiloh Farms. Whole grain sorghum.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    asinLink: 'https://www.amazon.com/dp/B0D481997Z?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley (cooked, minimal)': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    asinLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'barley (hulled)': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    asinLink: 'https://www.amazon.com/dp/B00QKP257A?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'millet': {
    productName: 'Bob\'s Red Mill Whole Grain Millet',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Organic Grains. Whole grain millet.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'millet (tiny amounts)': {
    productName: 'Bob\'s Red Mill Whole Grain Millet',
    asinLink: 'https://www.amazon.com/dp/B07XPCWYP2?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Organic Grains. Whole grain millet.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'farro': {
    productName: 'Bob\'s Red Mill Farro Grain',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Thrive Market. Farro grain.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'bulgur': {
    productName: 'Bob\'s Red Mill Fine Bulgur Wheat',
    asinLink: 'https://www.amazon.com/dp/B081DQ5NG5?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Ziyad. Fine bulgur wheat.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'amaranth (tiny amounts)': {
    productName: 'Bob\'s Red Mill Whole Grain Amaranth Seed',
    asinLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Whole grain amaranth seed.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'amaranth seeds': {
    productName: 'Bob\'s Red Mill Whole Grain Amaranth Seed',
    asinLink: 'https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Whole grain amaranth seed.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'teff seeds': {
    productName: 'Bob\'s Red Mill Whole Grain Teff Seeds',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill whole grain teff seeds.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'wheat (hulled)': {
    productName: 'Bob\'s Red Mill Whole Hulled Wheat Berries',
    asinLink: 'https://www.amazon.com/dp/B000YFB5NC?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or SpeltLife. Whole hulled wheat berries.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'oat bran (small amounts)': {
    productName: 'Bob\'s Red Mill Pure Oat Bran Cereal',
    asinLink: 'https://www.amazon.com/dp/B07CC9RF6Y?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Quaker. Pure oat bran cereal.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'oatmeal (cooked, small amounts)': {
    productName: 'Quaker Rolled Oats Old Fashioned',
    asinLink: 'https://www.amazon.com/dp/B00CTLAIH8?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Quaker. Rolled oats old fashioned.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'corn (cracked)': {
    productName: 'Scratch and Peck Cracked Corn Non-GMO',
    asinLink: 'https://www.amazon.com/dp/B01HHGD81C?tag=robinfrench-20',
    vetNote: 'Scratch and Peck Feeds or Purina. Cracked corn non-GMO.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'safflower seeds': {
    productName: 'Wagner\'s Pure Safflower Seed Bird Food',
    asinLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: 'Wagner\'s or Kaytee. Pure safflower seed bird food.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'nyjer seeds': {
    productName: 'Wagner\'s Nyjer Seed Bird Food',
    asinLink: 'https://www.amazon.com/dp/B0D6688V7C?tag=robinfrench-20',
    vetNote: 'Wagner\'s or Kaytee. Nyjer seed bird food.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'bok choi': {
    productName: 'Fresh Baby Bok Choy',
    asinLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'bok choy (small amounts)': {
    productName: 'Fresh Baby Bok Choy',
    asinLink: 'https://www.amazon.com/dp/B0FN4YGSK6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'navy beans (mashed)': {
    productName: 'Goya Canned Navy Beans Low Sodium',
    asinLink: 'https://www.amazon.com/dp/B006AZE13G?tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned navy beans, low sodium, rinse well.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kidney beans (mashed)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    asinLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'kidney beans (mashed, tiny amounts)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    asinLink: 'https://www.amazon.com/dp/B00552005I?tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'pinto beans (mashed)': {
    productName: 'Bush\'s Canned Pinto Beans Low Sodium',
    asinLink: 'https://www.amazon.com/dp/B0C4G2PR58?tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned pinto beans, low sodium, rinse well.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'purslane': {
    productName: 'Fresh Purslane Leaves',
    asinLink: 'https://www.amazon.com/dp/B09MDXM2YQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'purslane (small amounts)': {
    productName: 'Fresh Purslane Leaves',
    asinLink: 'https://www.amazon.com/dp/B0BWY8JWVL?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'miner\'s lettuce': {
    productName: 'Miner\'s Lettuce Seeds for Planting',
    asinLink: 'https://www.amazon.com/dp/B0D3J7FZFD?tag=robinfrench-20',
    vetNote: 'Fresh produce or seeds for growing.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'flaxseed (ground)': {
    productName: 'Bob\'s Red Mill Organic Ground Flaxseed Meal',
    asinLink: 'https://www.amazon.com/dp/B075XC6C69?tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Spectrum. Organic ground flaxseed meal.',
    category: 'Seed',
    commissionRate: 0.03
  },
  'fennel': {
    productName: 'Fresh Fennel Bulb',
    asinLink: 'https://www.amazon.com/dp/B00E3J6RC4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'delicata squash': {
    productName: 'Fresh Delicata Squash',
    asinLink: 'https://www.amazon.com/dp/B07KHH8K4L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'yellow squash': {
    productName: 'Fresh Yellow Summer Squash',
    asinLink: 'https://www.amazon.com/dp/B08QVBFGDC?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'leeks': {
    productName: 'Fresh Leeks',
    asinLink: 'https://www.amazon.com/dp/B09HQJGQDG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'shallots': {
    productName: 'Fresh Shallots',
    asinLink: 'https://www.amazon.com/dp/B09B2ZWHKQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'tomatoes (small amounts)': {
    productName: 'Fresh Ripe Vine Tomatoes',
    asinLink: 'https://www.amazon.com/dp/B086WX15TH?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'napa cabbage': {
    productName: 'Fresh Napa Cabbage',
    asinLink: 'https://www.amazon.com/dp/B07FTVYNM3?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'napa cabbage (small amounts)': {
    productName: 'Fresh Napa Cabbage',
    asinLink: 'https://www.amazon.com/dp/B079VV1K9L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'artichokes': {
    productName: 'Fresh Artichoke Hearts',
    asinLink: 'https://www.amazon.com/dp/B0DF91JXND?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'frisee': {
    productName: 'Fresh Frisee Lettuce',
    asinLink: 'https://www.amazon.com/dp/B07FZGKZL4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'radicchio': {
    productName: 'Fresh Radicchio Lettuce',
    asinLink: 'https://www.amazon.com/dp/B00BJPTZLA?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'red cabbage': {
    productName: 'Fresh Red Cabbage Head',
    asinLink: 'https://www.amazon.com/dp/B000RH1MXK?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'green cabbage': {
    productName: 'Fresh Green Cabbage Head',
    asinLink: 'https://www.amazon.com/dp/B09HQGDCKV?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'swiss chard': {
    productName: 'Fresh Swiss Chard',
    asinLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'swiss chard (cooked, tiny amounts)': {
    productName: 'Fresh Swiss Chard',
    asinLink: 'https://www.amazon.com/dp/B07F12P248?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lettuce (romaine, small amounts)': {
    productName: 'Fresh Romaine Lettuce Hearts',
    asinLink: 'https://www.amazon.com/dp/B074H5J9G2?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'red leaf lettuce': {
    productName: 'Fresh Red Leaf Lettuce',
    asinLink: 'https://www.amazon.com/dp/B0BX76BG5V?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mache': {
    productName: 'Fresh Mache Lamb\'s Lettuce',
    asinLink: 'https://www.amazon.com/dp/B00AWLAQFG?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'alfalfa sprouts (small amounts)': {
    productName: 'Fresh Alfalfa Sprouts',
    asinLink: 'https://www.amazon.com/dp/B0DFZTWLTY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'cat grass (wheatgrass)': {
    productName: 'SmartyKat Cat Grass Growing Kit Wheatgrass',
    asinLink: 'https://www.amazon.com/dp/B0D45F9TGG?tag=robinfrench-20',
    vetNote: 'SmartyKat or Catit. Cat Grass growing kit wheatgrass.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'squash (cooked)': {
    productName: 'Fresh Butternut Squash',
    asinLink: 'https://www.amazon.com/dp/B002QY3U5A?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'lamb\'s quarters': {
    productName: 'Lamb\'s Quarters Seeds',
    asinLink: 'https://www.amazon.com/dp/B0DYPHGW89?tag=robinfrench-20',
    vetNote: 'Wild harvested or seeds for growing.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'amaranth leaves': {
    productName: 'Fresh Amaranth Leaves',
    asinLink: 'https://www.amazon.com/dp/B0F2YRBGS6?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'ginger (small amounts)': {
    productName: 'Simply Organic Fresh Ginger Root',
    asinLink: 'https://www.amazon.com/dp/B0C6V3416T?tag=robinfrench-20',
    vetNote: 'McCormick or Simply Organic. Organic ginger root fresh.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turmeric': {
    productName: 'Simply Organic Pure Turmeric Powder',
    asinLink: 'https://www.amazon.com/dp/B018GPDCV4?tag=robinfrench-20',
    vetNote: 'Simply Organic or Tummydrops. Pure turmeric powder.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'rosemary': {
    productName: 'Frontier Co-op Dried Organic Rosemary',
    asinLink: 'https://www.amazon.com/dp/B004JWLMNY?tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried organic rosemary.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'sage': {
    productName: 'Simply Organic Dried Sage Leaf',
    asinLink: 'https://www.amazon.com/dp/B0CH3R9TVY?tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried sage leaf.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mint': {
    productName: 'Fresh Mint Leaves',
    asinLink: 'https://www.amazon.com/dp/B097F3NT7N?tag=robinfrench-20',
    vetNote: 'Fresh produce or Mountain Rose Herbs. Fresh mint leaves.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'garlic chives': {
    productName: 'Fresh Garlic Chives',
    asinLink: 'https://www.amazon.com/dp/B097F3J1PY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'raisins (unsweetened)': {
    productName: 'Sun-Maid Organic Raisins Unsweetened',
    asinLink: 'https://www.amazon.com/dp/B01GXPRIQY?tag=robinfrench-20',
    vetNote: 'Sun-Maid or Trader Joe\'s. Organic raisins unsweetened no oil.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'plums (pitted)': {
    productName: 'Fresh Plums Pitted',
    asinLink: 'https://www.amazon.com/dp/B07P6Z8L76?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'apricots (pitted)': {
    productName: 'NOW Foods Dried Apricots Unsulphured',
    asinLink: 'https://www.amazon.com/dp/B07FZWBPC5?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried apricots unsulphured no sugar.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'kiwi': {
    productName: 'Fresh Kiwi Fruit',
    asinLink: 'https://www.amazon.com/dp/B01LASWK7G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'mulberries': {
    productName: 'Terrasoul Dried Mulberries Organic',
    asinLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Navitas Organics or Terrasoul Superfoods. Dried mulberries organic.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'raspberries': {
    productName: 'Fresh Raspberries Organic',
    asinLink: 'https://www.amazon.com/dp/B000P6G12U?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'cranberries': {
    productName: 'NOW Foods Dried Cranberries Unsweetened',
    asinLink: 'https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried cranberries unsweetened.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pineapple (small amounts)': {
    productName: 'Fresh Pineapple Fruit',
    asinLink: 'https://www.amazon.com/dp/B000P6L3V4?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pears (no seeds)': {
    productName: 'Fresh Pears No Seeds',
    asinLink: 'https://www.amazon.com/dp/B0DYKVQ3XZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit',
    commissionRate: 0.03
  },
  'pinhead crickets': {
    productName: 'Josh\'s Frogs Live Pinhead Crickets',
    asinLink: 'https://www.amazon.com/dp/B07196FX9W?tag=robinfrench-20',
    vetNote: 'Josh\'s Frogs or Fluker\'s. Live pinhead crickets.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'locusts': {
    productName: 'Exo Terra Canned Locusts Reptile Food',
    asinLink: 'https://www.amazon.com/dp/B000CMKHBS?tag=robinfrench-20',
    vetNote: 'Rainbow Mealworms or Exo Terra. Canned locusts reptile food.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'butterworms': {
    productName: 'Rainbow Mealworms Live Butterworms',
    asinLink: 'https://www.amazon.com/dp/B093BD8NXR?tag=robinfrench-20',
    vetNote: 'Josh\'s Frogs or Rainbow Mealworms. Live butterworms.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'grasshoppers': {
    productName: 'Fluker\'s Dried Grasshoppers Reptile Food',
    asinLink: 'https://www.amazon.com/dp/B004HSQRG2?tag=robinfrench-20',
    vetNote: 'Fluker\'s or Exo Terra. Dried grasshoppers reptile food.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'small dubia roaches': {
    productName: 'Small Live Dubia Roaches Feeder',
    asinLink: 'https://www.amazon.com/dp/B09QD6PBB8?tag=robinfrench-20',
    vetNote: 'DubiaRoaches.com or Josh\'s Frogs. Small live dubia roaches feeder.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'silkworms': {
    productName: 'Live Silkworms Reptile Food',
    asinLink: 'https://www.amazon.com/dp/B08JKNZPSF?tag=robinfrench-20',
    vetNote: 'Coastal Silkworms or SilkwormShop. Live silkworms reptile food.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'earthworms': {
    productName: 'Uncle Jim\'s Live Earthworms',
    asinLink: 'https://www.amazon.com/dp/B097PDMK47?tag=robinfrench-20',
    vetNote: 'Uncle Jim\'s Worm Farm. Live earthworms.',
    category: 'Insect',
    commissionRate: 0.03
  },
  'wheat hay': {
    productName: 'Oxbow Wheat Hay Small Animal',
    asinLink: 'https://www.amazon.com/dp/B0CLC76V98?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Wheat hay small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'fescue hay': {
    productName: 'Small Pet Select Fescue Hay',
    asinLink: 'https://www.amazon.com/dp/B00S6YIF36?tag=robinfrench-20',
    vetNote: 'Small Pet Select fescue hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'oat hay': {
    productName: 'Oxbow Oat Hay Small Animal',
    asinLink: 'https://www.amazon.com/dp/B000WFKP80?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Oat hay small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'bluegrass hay': {
    productName: 'Small Pet Select Bluegrass Hay',
    asinLink: 'https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20',
    vetNote: 'Small Pet Select bluegrass hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'straw (wheat/pine)': {
    productName: 'Oxbow Wheat Straw Bedding',
    asinLink: 'https://www.amazon.com/dp/B0CDQMD1CB?tag=robinfrench-20',
    vetNote: 'Kaytee or Oxbow. Wheat straw bedding.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'dried grass': {
    productName: 'Kaytee Dried Natural Grass Small Animal',
    asinLink: 'https://www.amazon.com/dp/B0002DK8OI?tag=robinfrench-20',
    vetNote: 'Kaytee or Timothy Grass. Dried natural grass small animal.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'bermuda hay': {
    productName: 'Standlee Premium Bermuda Hay',
    asinLink: 'https://www.amazon.com/dp/B0FSVM5P3D?tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Standlee Hay. Premium bermuda hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'barley hay': {
    productName: 'Standlee Barley Hay',
    asinLink: 'https://www.amazon.com/dp/B08YM9VJC5?tag=robinfrench-20',
    vetNote: 'Small Pet Select or Standlee Hay. Barley hay.',
    category: 'Hay',
    commissionRate: 0.03
  },
  'guinea pig pellets (with vitamin c)': {
    productName: 'Oxbow Essentials Cavy Cuisine Guinea Pig Pellets',
    asinLink: 'https://www.amazon.com/dp/B00E4KT5NA?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Cavy Cuisine or Sherwood. Guinea pig pellets with vitamin C.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'rabbit pellets (high fiber)': {
    productName: 'Oxbow Essentials Rabbit Food High Fiber',
    asinLink: 'https://www.amazon.com/dp/B0017JANQY?tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Rabbit Food. Adult rabbit pellets high fiber.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'hamster pellets (higher protein)': {
    productName: 'Oxbow Essentials Hamster Food Higher Protein',
    asinLink: 'https://www.amazon.com/dp/B0053SYJVA?tag=robinfrench-20',
    vetNote: 'Higgins Sunburst or Oxbow Essentials. Hamster food higher protein.',
    category: 'Pellet',
    commissionRate: 0.03
  },
  'wild bird mix': {
    productName: 'Lyric Wild Bird Mix No Filler',
    asinLink: 'https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20',
    vetNote: 'Lyric or Kaytee. Wild bird mix no filler.',
    category: 'Pellet',
    commissionRate: 0.03
  },

  // === MISSING INGREDIENTS - Added to complete coverage ===
  'beta-glucans': {
    productName: 'NOW Supplements Beta Glucans 60 Capsules',
    asinLink: 'https://www.amazon.com/dp/B01LWVNL9J?tag=robinfrench-20',
    vetNote: 'Immune-supporting beta-glucans from yeast or mushrooms for enhanced immune function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'biotin': {
    productName: 'NOW Supplements Biotin 5000 mcg',
    asinLink: 'https://www.amazon.com/dp/B01AMJCHB8?tag=robinfrench-20',
    vetNote: 'B-complex vitamin essential for healthy skin, coat, and metabolic function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'bone broth (low sodium)': {
    productName: 'Brutus Bone Broth for Dogs Low Sodium',
    asinLink: 'https://www.amazon.com/dp/B07DFNP37Y?tag=robinfrench-20',
    vetNote: 'Concentrated bone broth providing collagen, glucosamine, and natural electrolytes without excess sodium.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'cauliflower': {
    productName: 'Fresh Organic Cauliflower',
    asinLink: 'https://www.amazon.com/dp/B000P6G0GM?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'chicory root': {
    productName: 'NOW Supplements Inulin Prebiotic Fiber',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'chondroitin sulfate': {
    productName: 'Cosequin DS Plus MSM with Chondroitin',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with chondroitin for cartilage health and mobility.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'cranberry extract': {
    productName: 'NOW Supplements Cranberry Extract 5000 mg',
    asinLink: 'https://www.amazon.com/dp/B01N7KMPU3?tag=robinfrench-20',
    vetNote: 'Concentrated cranberry extract supporting urinary tract health and preventing bacterial adhesion.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'curcumin (turmeric extract)': {
    productName: 'NOW Supplements Curcumin with BioPerine',
    asinLink: 'https://www.amazon.com/dp/B0CK3C31JP?tag=robinfrench-20',
    vetNote: 'Anti-inflammatory curcumin from turmeric with enhanced absorption for joint and immune support.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'd-mannose': {
    productName: 'NOW Supplements D-Mannose Powder',
    asinLink: 'https://www.amazon.com/dp/B01N6X9YBS?tag=robinfrench-20',
    vetNote: 'Natural sugar compound supporting urinary tract health by preventing bacterial adhesion.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'egg yolks': {
    productName: 'Vital Farms Pasture-Raised Eggs',
    asinLink: 'https://www.amazon.com/dp/B00M1QWODW?tag=robinfrench-20',
    vetNote: 'High-quality eggs from pasture-raised hens, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'eggplant': {
    productName: 'Fresh Organic Eggplant',
    asinLink: 'https://www.amazon.com/dp/B001PLGQPQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable with fiber and antioxidants.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'eggshells (crushed)': {
    productName: 'NOW Supplements Calcium Carbonate Powder',
    asinLink: 'https://www.amazon.com/dp/B004421K68?tag=robinfrench-20',
    vetNote: 'Crushed eggshells provide natural calcium carbonate. Can be prepared at home from organic eggs or use calcium supplement.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'fish broth (no salt)': {
    productName: 'Brutus Fish Broth for Dogs No Salt',
    asinLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated fish broth providing omega-3s, collagen, and natural flavor without added salt.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'fructooligosaccharides (fos)': {
    productName: 'NOW Supplements FOS Prebiotic Fiber',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber supporting beneficial gut bacteria growth and digestive health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'glucosamine sulfate': {
    productName: 'Cosequin DS Plus MSM Glucosamine',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated glucosamine sulfate for joint cartilage health and mobility support.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'green beans': {
    productName: 'Fresh Organic Green Beans',
    asinLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Low-calorie vegetable rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'green beans (cooked)': {
    productName: 'Fresh Organic Green Beans',
    asinLink: 'https://www.amazon.com/dp/B0DDTC6QNY?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam or boil until tender for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'hairball control paste': {
    productName: 'Tomlyn Laxatone Hairball Remedy',
    asinLink: 'https://www.amazon.com/dp/B07B282MR4?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated paste for hairball prevention and digestive health in cats.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'hyaluronic acid': {
    productName: 'NOW Supplements Hyaluronic Acid 100 mg',
    asinLink: 'https://www.amazon.com/dp/B07XHNCJMC?tag=robinfrench-20',
    vetNote: 'Joint health supplement supporting cartilage hydration and joint lubrication.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'inulin (prebiotic)': {
    productName: 'NOW Supplements Inulin Prebiotic Fiber',
    asinLink: 'https://www.amazon.com/dp/B08Q7KZYKC?tag=robinfrench-20',
    vetNote: 'Prebiotic fiber from chicory root supporting healthy gut bacteria and digestive function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'jerusalem artichoke': {
    productName: 'Fresh Jerusalem Artichoke Sunchokes',
    asinLink: 'https://www.amazon.com/dp/B0CQK5XCVZ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Prebiotic-rich root vegetable supporting gut health.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'joint health supplement': {
    productName: 'Cosequin DS Plus MSM for Dogs',
    asinLink: 'https://www.amazon.com/dp/B003ULL1NQ?tag=robinfrench-20',
    vetNote: 'Veterinarian-formulated joint supplement with glucosamine, chondroitin, and MSM for joint health and mobility.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'l-carnitine powder': {
    productName: 'NOW Supplements L-Carnitine 500 mg',
    asinLink: 'https://www.amazon.com/dp/B06Y1BTLGK?tag=robinfrench-20',
    vetNote: 'Amino acid supporting heart health, energy metabolism, and weight management.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'lysine powder': {
    productName: 'NOW Supplements L-Lysine 1000 mg',
    asinLink: 'https://www.amazon.com/dp/B00V3MR88G?tag=robinfrench-20',
    vetNote: 'Essential amino acid supporting immune function, collagen production, and overall health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'malabar spinach': {
    productName: 'Fresh Malabar Spinach Leaves',
    asinLink: 'https://www.amazon.com/dp/B0DLT7BSNJ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green with vitamins and minerals.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'mannanoligosaccharides (mos)': {
    productName: 'NOW Supplements MOS Prebiotic',
    asinLink: 'https://www.amazon.com/dp/B0CRFWM2Z6?tag=robinfrench-20',
    vetNote: 'Prebiotic supplement supporting beneficial gut bacteria and immune function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'milk thistle': {
    productName: 'NOW Supplements Milk Thistle 150 mg',
    asinLink: 'https://www.amazon.com/dp/B0019LVFD0?tag=robinfrench-20',
    vetNote: 'Liver-supporting herb with antioxidant properties for hepatic health and detoxification.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'new zealand spinach': {
    productName: 'Fresh New Zealand Spinach',
    asinLink: 'https://www.amazon.com/dp/B0C8VD126M?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich leafy green alternative to traditional spinach.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'niacinamide': {
    productName: 'NOW Supplements Niacinamide 500 mg',
    asinLink: 'https://www.amazon.com/dp/B0CZMBZPLV?tag=robinfrench-20',
    vetNote: 'B-vitamin (B3) supporting energy metabolism, skin health, and nervous system function.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'oats (rolled)': {
    productName: 'Bob\'s Red Mill Old Fashioned Rolled Oats',
    asinLink: 'https://www.amazon.com/dp/B07VCM66N6?tag=robinfrench-20',
    vetNote: 'Whole grain rolled oats providing fiber, B vitamins, and sustained energy. Cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'peas': {
    productName: 'Fresh Organic Green Peas',
    asinLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Protein-rich legume with fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'peas (mashed)': {
    productName: 'Fresh Organic Green Peas',
    asinLink: 'https://www.amazon.com/dp/B07D1NGQ6B?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'pectin (from apples)': {
    productName: 'NOW Supplements Apple Pectin Powder',
    asinLink: 'https://www.amazon.com/dp/B01CO69SYG?tag=robinfrench-20',
    vetNote: 'Soluble fiber from apples supporting digestive health and blood sugar regulation.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'pumpkin seed oil': {
    productName: 'NOW Solutions Pumpkin Seed Oil',
    asinLink: 'https://www.amazon.com/dp/B0FKYLMWYG?tag=robinfrench-20',
    vetNote: 'Omega-3 and omega-6 rich oil supporting urinary health, skin, and coat condition.',
    category: 'Oil',
    commissionRate: 0.03
  },
  'quail eggs': {
    productName: 'Fresh Quail Eggs',
    asinLink: 'https://www.amazon.com/dp/B0BSRGV9PR?tag=robinfrench-20',
    vetNote: 'Small nutrient-dense eggs from quail, rich in protein, healthy fats, and essential nutrients.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'quercetin': {
    productName: 'NOW Supplements Quercetin with Bromelain',
    asinLink: 'https://www.amazon.com/dp/B08M5L372P?tag=robinfrench-20',
    vetNote: 'Antioxidant flavonoid supporting immune function, allergy relief, and anti-inflammatory benefits.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'rice (hulled)': {
    productName: 'Lundberg Organic Brown Rice',
    asinLink: 'https://www.amazon.com/dp/B072JNNB33?tag=robinfrench-20',
    vetNote: 'Whole grain brown rice with hull removed, providing fiber, B vitamins, and sustained energy.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'romanesco broccoli': {
    productName: 'Fresh Romanesco Broccoli',
    asinLink: 'https://www.amazon.com/dp/B01I1Q74MQ?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-rich cruciferous vegetable with vitamins C and K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  's-adenosyl methionine (sam-e)': {
    productName: 'NOW Supplements SAM-e 200 mg',
    asinLink: 'https://www.amazon.com/dp/B000OSSQFY?tag=robinfrench-20',
    vetNote: 'Methyl donor supporting liver health, joint function, and mood regulation.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'sardines (in water)': {
    productName: 'Wild Planet Sardines in Water No Salt',
    asinLink: 'https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20',
    vetNote: 'Wild-caught sardines canned in water without added salt. Rich in omega-3s, calcium, and protein.',
    category: 'Meat',
    commissionRate: 0.03
  },
  'snap peas': {
    productName: 'Fresh Organic Snap Peas',
    asinLink: 'https://www.amazon.com/dp/B077L6C7YB?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Edible-pod peas rich in fiber and vitamins.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'snow peas': {
    productName: 'Fresh Organic Snow Peas',
    asinLink: 'https://www.amazon.com/dp/B07MGSDD7L?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Flat-podded peas with tender texture and mild flavor.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'snow peas (mashed)': {
    productName: 'Fresh Organic Snow Peas',
    asinLink: 'https://www.amazon.com/dp/B08KRNKC9G?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'split peas': {
    productName: 'Bob\'s Red Mill Split Peas',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Soak and cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'split peas (mashed)': {
    productName: 'Bob\'s Red Mill Split Peas',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Dried split peas providing protein, fiber, and B vitamins. Cook and mash for optimal digestibility.',
    category: 'Carb',
    commissionRate: 0.03
  },
  'sugar snap peas': {
    productName: 'Fresh Organic Sugar Snap Peas',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Sweet, crisp peas with edible pods rich in fiber.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'sugar snap peas (mashed)': {
    productName: 'Fresh Organic Sugar Snap Peas',
    asinLink: 'https://www.amazon.com/dp/B08DVGSW58?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Steam and mash for optimal digestibility.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'turkey broth (no salt)': {
    productName: 'Brutus Turkey Broth for Dogs No Salt',
    asinLink: 'https://www.amazon.com/dp/B07DFQFLJL?tag=robinfrench-20',
    vetNote: 'Concentrated turkey broth providing protein, collagen, and natural flavor without added salt.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'vitamin b complex': {
    productName: 'Thorne B-Complex #12',
    asinLink: 'https://www.amazon.com/dp/B01INRFW0E?tag=robinfrench-20',
    vetNote: 'Complete B vitamin complex for energy metabolism, nervous system health, and overall vitality.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'vitamin c (small amounts)': {
    productName: 'NOW Supplements Vitamin C 1000 mg',
    asinLink: 'https://www.amazon.com/dp/B074GCB1ND?tag=robinfrench-20',
    vetNote: 'Antioxidant vitamin supporting immune function and collagen production. Use in small amounts as directed.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'watercress': {
    productName: 'Fresh Organic Watercress',
    asinLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Nutrient-dense leafy green with vitamins A, C, and K.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'watercress (small amounts)': {
    productName: 'Fresh Organic Watercress',
    asinLink: 'https://www.amazon.com/dp/B0BSK8P8KS?tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market. Use in small amounts due to strong flavor and oxalate content.',
    category: 'Vegetable',
    commissionRate: 0.03
  },
  'wheat germ': {
    productName: 'Bob\'s Red Mill Wheat Germ',
    asinLink: 'https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20',
    vetNote: 'Nutrient-dense wheat germ providing vitamin E, B vitamins, and healthy fats for skin and coat health.',
    category: 'Supplement',
    commissionRate: 0.03
  },
  'wild rice': {
    productName: 'Lundberg Organic Wild Rice',
    asinLink: 'https://www.amazon.com/dp/B089CP461X?tag=robinfrench-20',
    vetNote: 'Whole grain wild rice providing protein, fiber, and B vitamins. Cook thoroughly before serving.',
    category: 'Carb',
    commissionRate: 0.03
  },
};

/**
 * Normalizes ingredient names to match vetted product keys
 * @param name The raw ingredient name from recipes
 */
function normalizeIngredientName(name: string): string {
  let normalized = name
    .toLowerCase()
    .trim();
  
  // Handle specific mappings FIRST (before removing descriptors)
  // This ensures "ground chicken" maps correctly before "ground" could be removed
  const mappings: Record<string, string> = {
    'ground chicken': 'ground chicken',
    'ground turkey': 'ground turkey',
    'ground beef': 'ground beef (lean)',
    'ground lamb': 'ground lamb',
    'ground pork': 'ground pork (lean)',
    'chicken breast': 'chicken breast',
    'turkey breast': 'turkey breast',
    'beef liver': 'beef liver',
    'chicken liver': 'chicken liver',
    'chicken hearts': 'chicken hearts',
    'turkey giblets': 'turkey giblets',
    'chicken giblets': 'chicken giblets',
    'duck breast': 'duck breast',
    'venison': 'venison',
    'rabbit meat': 'rabbit meat',
    'ground pork lean': 'ground pork (lean)',
    'turkey necks': 'turkey necks',
    'rabbit': 'rabbit meat',
    'brown rice': 'brown rice',
    'white rice': 'white rice',
    'quinoa': 'quinoa',
    'sweet potato': 'sweet potato',
    'pumpkin': 'pumpkin puree',
    'butternut squash': 'butternut squash',
    'lentils': 'lentils',
    'chickpeas': 'chickpeas',
    'black beans': 'black beans',
    'green peas': 'green peas',
    'carrots': 'carrots',
    'spinach': 'spinach',
    'broccoli': 'broccoli',
    'zucchini': 'zucchini',
    'kale': 'kale',
    'celery': 'celery',
    'brussels sprouts': 'brussels sprouts',
    'asparagus': 'asparagus',
    'parsley': 'parsley',
    'cucumber': 'cucumber',
    'lettuce romaine': 'lettuce (romaine)',
    'arugula': 'arugula',
    'endive': 'endive',
    'escarole': 'escarole',
    'dandelion greens': 'dandelion greens',
    'collard greens': 'collard greens',
    'mustard greens': 'mustard greens',
    'turnip greens': 'turnip greens',
    'beet greens': 'beet greens',
    'radish greens': 'radish greens',
    'coconut oil': 'coconut oil',
    'olive oil': 'olive oil',
    'salmon oil': 'salmon oil',
    'flaxseed oil': 'flaxseed oil',
    'fish oil': 'fish oil',
    'taurine powder': 'taurine powder',
    'calcium carbonate': 'calcium carbonate',
    'vitamin e': 'vitamin e',
    'b-complex': 'b-complex',
    'probiotic powder': 'probiotic powder',
    'psyllium husk': 'psyllium husk',
    'joint supplement': 'joint supplement',
    'omega-3 capsules': 'omega-3 capsules',
    'digestive enzymes': 'digestive enzymes',
    'hairball paste': 'hairball paste',
    'chicken broth': 'chicken broth',
    'vitamin e oil': 'vitamin e oil',
    'salmon': 'salmon (boneless)',
    'eggs': 'eggs',
    'sardines water': 'sardines (canned in water)',
    'quail': 'quail',
    'millet white red': 'millet (white/red)',
    'canary seed': 'canary seed',
    'niger seed': 'niger seed',
    'oat groats': 'oat groats',
    'hemp seeds': 'hemp seeds',
    'flaxseeds': 'flaxseeds',
    'sesame seeds': 'sesame seeds',
    'chia seeds': 'chia seeds',
    'quinoa cooked': 'quinoa (cooked)',
    'rapeseed': 'rapeseed',
    'sunflower seeds small amounts': 'sunflower seeds (small amounts)',
    'pumpkin seeds': 'pumpkin seeds',
    'bell peppers': 'bell peppers',
    'corn fresh': 'corn (fresh)',
    'apples no seeds': 'apples (no seeds)',
    'blueberries': 'blueberries',
    'strawberries': 'strawberries',
    'mango': 'mango',
    'banana': 'banana',
    'grapes chopped': 'grapes (chopped)',
    'papaya': 'papaya',
    'melon': 'melon',
    'egg hard-boiled': 'egg (hard-boiled)',
    'pellets fortified': 'pellets (fortified)',
    'cuttlebone': 'cuttlebone',
    'honey tiny amounts': 'honey (tiny amounts)',
    'peanut butter unsalted tiny amounts': 'peanut butter (unsalted, tiny amounts)',
    'dubia roaches': 'dubia roaches',
    'crickets': 'crickets',
    'mealworms': 'mealworms',
    'superworms': 'superworms',
    'black soldier fly larvae': 'black soldier fly larvae',
    'hornworms': 'hornworms',
    'acorn squash': 'acorn squash',
    'figs': 'figs',
    'timothy hay': 'timothy hay',
    'meadow hay': 'meadow hay',
    'orchard grass hay': 'orchard grass hay',
    'alfalfa hay': 'alfalfa hay',
    'romaine lettuce': 'romaine lettuce',
    'cilantro': 'cilantro',
    'basil': 'basil'
  };
  
  // Check mappings FIRST (before removing descriptors)
  if (mappings[normalized]) {
    return mappings[normalized];
  }
  
  // Then do normalization (remove descriptors, etc.)
  // NOTE: "ground" is NOT removed because it's part of valid ingredient names
  normalized = normalized
    // Remove common descriptors (but NOT "ground" since it's part of ingredient names)
    .replace(/\b(boneless|skinless|fresh|frozen|dried|canned|cooked|raw|organic|whole|diced|chopped|minced|sliced|grated|shredded|crushed|powdered|pureed|no sugar|low-sodium)\b/g, '')
    // Remove quantities and measurements
    .replace(/\b(\d+(?:\.\d+)?)\s*(g|kg|lb|oz|cup|cups|tbsp|tsp|ml|l|pinch|dash)\b/g, '')
    // Remove parentheses and their contents
    .replace(/\([^)]*\)/g, '')
    // Remove commas and everything after
    .replace(/,.*/, '')
    // Clean up extra whitespace
    .replace(/\s+/g, ' ')
    .trim();
  
  // Check mappings again after normalization
  return mappings[normalized] || normalized;
}

/**
 * Looks up a generic ingredient and returns the vetted product details if available.
 * @param genericName The generic ingredient name (e.g., "Ground Turkey").
 */
export function getVettedProduct(genericName: string): VettedProduct | undefined {
  const normalizedName = genericName.toLowerCase().trim();
  
  // First try exact match
  const exactMatch = VETTED_PRODUCTS[normalizedName];
  if (exactMatch) {
    // Exact match found - no logging needed in production
    return exactMatch;
  }

  // Then try normalized match
  const normalized = normalizeIngredientName(genericName);
  const normalizedMatch = VETTED_PRODUCTS[normalized];
  
  if (normalizedMatch) {
    // Normalized match found - no logging needed in production
    return normalizedMatch;
  }
  
  // No match found - silently return undefined (product not available)
  return undefined;
}

/**
 * Gets the best affiliate link for an ingredient, prioritizing higher commission rates.
 * @param genericName The generic ingredient name.
 * @returns The best affiliate link URL or undefined if not found.
 */
export function getBestAffiliateLink(genericName: string): string | undefined {
  const product = getVettedProduct(genericName);
  if (!product) return undefined;

  // Priority: Chewy (8% commission) > Specialty > Amazon (3%)
  if (product.chewyLink && product.commissionRate === 0.08) {
    return product.chewyLink;
  }
  if (product.specialtyLink) {
    return product.specialtyLink;
  }
  return product.asinLink;
}

/**
 * Gets all available affiliate links for an ingredient.
 * @param genericName The generic ingredient name.
 * @returns Array of affiliate link objects with vendor and URL.
 */
export function getAllAffiliateLinks(genericName: string): Array<{vendor: string, url: string, commission: number}> {
  const product = getVettedProduct(genericName);
  if (!product) return [];

  const links = [];

  if (product.asinLink) {
    links.push({ vendor: 'Amazon', url: product.asinLink, commission: product.commissionRate || 0.03 });
  }
  if (product.chewyLink) {
    links.push({ vendor: 'Chewy', url: product.chewyLink, commission: product.commissionRate || 0.08 });
  }
  if (product.specialtyLink) {
    links.push({ vendor: 'Specialty', url: product.specialtyLink, commission: product.commissionRate || 0.10 });
  }

  return links.sort((a, b) => b.commission - a.commission); // Sort by commission descending
}

/**
 * Generates an Amazon cart URL for multiple ingredients.
 * @param ingredientNames Array of generic ingredient names.
 * @returns Amazon cart URL or null if no valid products found.
 */
export function generateAmazonCartUrl(ingredientNames: string[]): string | null {
  const asinList: string[] = [];

  for (const name of ingredientNames) {
    const product = getVettedProduct(name);
    if (product?.asinLink) {
      // Extract ASIN from Amazon URL (format: https://www.amazon.com/dp/ASIN or /gp/product/ASIN)
      const asinMatch = product.asinLink.match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
      if (asinMatch) {
        asinList.push(asinMatch[1]);
      }
    }
  }

  if (asinList.length === 0) return null;

  // Create Amazon cart URL with multiple items
  const cartUrl = `https://www.amazon.com/gp/aws/cart/add.html?AssociateTag=robinfrench-20&ASIN.1=${asinList[0]}${asinList.slice(1).map((asin, index) => `&ASIN.${index + 2}=${asin}&Quantity.${index + 2}=1`).join('')}&Quantity.1=1`;

  return cartUrl;
}

/**
 * Generates a bulk shopping list with optimized affiliate links.
 * @param ingredientNames Array of generic ingredient names.
 * @returns Object with cart URLs and individual links organized by vendor.
 */
export function generateBulkShoppingList(ingredientNames: string[]): {
  amazonCartUrl: string | null;
  vendorLinks: Record<string, Array<{name: string, url: string, productName?: string}>>;
  totalCommission: number;
} {
  const vendorLinks: Record<string, Array<{name: string, url: string, productName?: string}>> = {
    Amazon: [],
    Chewy: [],
    Specialty: []
  };

  let totalCommission = 0;

  for (const name of ingredientNames) {
    const allLinks = getAllAffiliateLinks(name);
    const bestLink = allLinks[0]; // Already sorted by commission

    if (bestLink) {
      const product = getVettedProduct(name);
      vendorLinks[bestLink.vendor].push({
        name,
        url: bestLink.url,
        productName: product?.productName
      });
      totalCommission += bestLink.commission;
    }
  }

  // Generate Amazon cart URL for Amazon items
  const amazonCartUrl = generateAmazonCartUrl(ingredientNames);

  return {
    amazonCartUrl,
    vendorLinks,
    totalCommission: Math.round(totalCommission * 100) / 100 // Round to 2 decimal places
  };
}
</file>

<file path="lib/data/vetted-species-map.ts">
// lib/data/vetted-species-map.ts
// Maps vetted ingredient keys (from vetted-products.ts) to safe species.
// Ensures generator only picks safe, vetted items for each animal.

export type SafeSpecies = 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';

export const VETTED_SPECIES_MAP: Record<string, SafeSpecies[]> = {
  // === PROTEINS ===
  'chicken breast': ['dog', 'cat', 'reptile', 'pocket-pet'], // cooked small amounts for others
  'ground turkey': ['dog', 'cat', 'reptile'],
  'ground beef (lean)': ['dog', 'cat', 'reptile'],
  'salmon (boneless)': ['dog', 'cat'],
  'chicken liver': ['dog', 'cat'],
  'beef liver': ['dog', 'cat'],
  'chicken hearts': ['dog', 'cat'],
  'sardines (canned in water)': ['dog', 'cat'],
  'eggs': ['dog', 'cat', 'reptile', 'bird', 'pocket-pet'], // cooked
  'duck breast': ['dog', 'cat'],
  'rabbit meat': ['dog', 'cat'],
  'venison': ['dog', 'cat'],
  'lamb': ['dog', 'cat'],
  'mealworms': ['bird', 'reptile', 'pocket-pet'],
  'crickets': ['bird', 'reptile', 'pocket-pet'],

  // === VEGETABLES ===
  'sweet potato': ['dog', 'bird', 'pocket-pet'], // cooked
  'pumpkin': ['dog', 'cat', 'bird', 'pocket-pet'],
  'carrots': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'green beans': ['dog', 'cat', 'bird', 'reptile'],
  'peas': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'broccoli': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'spinach': ['dog', 'bird', 'reptile'], // limit for some
  'kale': ['dog', 'bird', 'reptile', 'pocket-pet'],
  'zucchini': ['dog', 'bird', 'reptile', 'pocket-pet'],
  'butternut squash': ['dog', 'bird', 'reptile'],
  'cucumber': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'bell peppers': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'collard greens': ['bird', 'reptile', 'pocket-pet'],
  'dandelion greens': ['bird', 'reptile', 'pocket-pet'],
  'bok choy': ['bird', 'reptile', 'pocket-pet'],

  // === FRUITS ===
  'blueberries': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'apples': ['dog', 'bird', 'pocket-pet', 'reptile'], // no seeds
  'bananas': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'strawberries': ['dog', 'bird', 'pocket-pet', 'reptile'],
  'watermelon': ['dog', 'bird', 'reptile'],
  'mango': ['bird', 'reptile', 'pocket-pet'],
  'papaya': ['bird', 'reptile', 'pocket-pet'],

  // === GRAINS/SEEDS ===
  'brown rice': ['dog', 'bird'],
  'white rice': ['dog', 'bird'],
  'oats': ['dog', 'bird', 'pocket-pet'],
  'quinoa': ['dog', 'bird'],
  'millet': ['bird', 'pocket-pet'],
  'sunflower seeds': ['bird', 'pocket-pet'],
  'pumpkin seeds': ['dog', 'bird', 'pocket-pet'],
  'chia seeds': ['dog', 'bird'],
  'flaxseed': ['dog', 'bird'],

  // === FATS/OILS ===
  'fish oil': ['dog', 'cat'],
  'salmon oil': ['dog', 'cat'],
  'coconut oil': ['dog'],
  'olive oil': ['dog'],

  // === SUPPLEMENTS ===
  'calcium powder': ['bird', 'reptile'],
  'kelp powder': ['dog', 'cat'],
  'bone broth': ['dog', 'cat'],
  'taurine powder': ['cat'],
  'cuttlebone': ['bird', 'reptile', 'pocket-pet'], // calcium source
  'vitamin c drops': ['pocket-pet'], // guinea pigs specifically
};
</file>

<file path="lib/data/villageLevels.ts">
/**
 * Village Evolution Levels
 * Defines how the village looks and evolves based on cumulative ingredient purchases
 * Every 10 ingredients purchased = new level
 * Uses range-based structure (minCount/maxCount) for cleaner level matching
 */

export interface VillageLevel {
  id: number;
  name: string;
  minCount: number; // Inclusive minimum purchase count
  maxCount: number; // Inclusive maximum purchase count (or Infinity)
  buildings: string[]; // Array of building types/keys
  environment: string; // Environment theme key (camp, suburb, paradise, etc.)
  mascotStates: Record<string, string>; // Mascot activity states (e.g., { dog: 'cooking', cat: 'testing' })
  palette: {
    background: string; // Background color
    accent: string; // Accent color
    neutral: string; // Neutral color
  };
}

export const VILLAGE_LEVELS: VillageLevel[] = [
  {
    id: 0,
    name: 'Struggle',
    minCount: 0,
    maxCount: 9,
    buildings: ['strawHut'],
    environment: 'camp',
    mascotStates: {
      dog: 'stir',      // Puppy Prepper stirring over campfire
      cat: 'worry',     // Professor Purrfessor taking notes anxiously
      turtle: 'inspect', // Sherlock Shells slowly investigating
      hamster: 'busy',   // Farmer Fluff gathering supplies
      bird: 'idle'       // Robin Redroute resting
    },
    palette: {
      background: '#F7F3EE',
      accent: '#D6A77A',
      neutral: '#BDB8B0'
    }
  },
  {
    id: 1,
    name: 'Suburbs',
    minCount: 10,
    maxCount: 19,
    buildings: ['house', 'playground'],
    environment: 'suburb',
    mascotStates: {
      dog: 'cook',      // Puppy Prepper cooking in kitchen
      cat: 'note',      // Professor Purrfessor taking notes
      turtle: 'inspect', // Sherlock Shells investigating
      hamster: 'stack',  // Farmer Fluff organizing supplies
      bird: 'deliver'    // Robin Redroute delivering packages
    },
    palette: {
      background: '#F0F6F4',
      accent: '#A8D5BA',
      neutral: '#CFCFCF'
    }
  },
  {
    id: 2,
    name: 'Paradise',
    minCount: 20,
    maxCount: 29,
    buildings: ['villa', 'themePark'],
    environment: 'paradise',
    mascotStates: {
      dog: 'plate',     // Puppy Prepper plating food
      cat: 'test',      // Professor Purrfessor testing recipes
      turtle: 'discover', // Sherlock Shells discovering
      hamster: 'harvest', // Farmer Fluff harvesting
      bird: 'fly'        // Robin Redroute flying deliveries
    },
    palette: {
      background: '#E8FAF0',
      accent: '#FFD48E',
      neutral: '#D3D3D3'
    }
  },
  {
    id: 3,
    name: 'Utopia',
    minCount: 30,
    maxCount: 39,
    buildings: ['estate', 'forestPark'],
    environment: 'utopia',
    mascotStates: {
      dog: 'master',    // Puppy Prepper master chef
      cat: 'experiment', // Professor Purrfessor advanced experiments
      turtle: 'curate',  // Sherlock Shells curating discoveries
      hamster: 'complex', // Farmer Fluff managing complex
      bird: 'speed'      // Robin Redroute high-speed deliveries
    },
    palette: {
      background: '#FFF2E6',
      accent: '#B7E2E8',
      neutral: '#C8C8C8'
    }
  },
  {
    id: 4,
    name: 'Legendary',
    minCount: 40,
    maxCount: 49,
    buildings: ['castle', 'amusementPark'],
    environment: 'legendary',
    mascotStates: {
      dog: 'royal',      // Puppy Prepper royal chef
      cat: 'wizard',     // Professor Purrfessor wizard scientist
      turtle: 'sage',     // Sherlock Shells sage researcher
      hamster: 'knight',  // Farmer Fluff knight farmer
      bird: 'dragon'      // Robin Redroute dragon rider
    },
    palette: {
      background: '#F5E8FF',
      accent: '#FFD4F0',
      neutral: '#C0B3C7'
    }
  },
  {
    id: 5,
    name: 'Divine',
    minCount: 50,
    maxCount: Infinity,
    buildings: ['palace', 'magicalForest'],
    environment: 'divine',
    mascotStates: {
      dog: 'divine',     // Puppy Prepper divine chef
      cat: 'cosmic',     // Professor Purrfessor cosmic researcher
      turtle: 'universal', // Sherlock Shells universal investigator
      hamster: 'celestial', // Farmer Fluff celestial farmer
      bird: 'angel'       // Robin Redroute angel deliverer
    },
    palette: {
      background: '#E9FFF8',
      accent: '#FFF18C',
      neutral: '#EDEDED'
    }
  }
];

/**
 * Get village level data for a given purchase count
 * Uses range-based matching (minCount <= count <= maxCount)
 */
export function getVillageLevelData(purchaseCount: number): VillageLevel {
  // Find the level where count falls within the range
  for (const level of VILLAGE_LEVELS) {
    if (purchaseCount >= level.minCount && purchaseCount <= level.maxCount) {
      return level;
    }
  }
  
  // Default to level 0 (shouldn't happen, but safety fallback)
  return VILLAGE_LEVELS[0];
}

/**
 * Get village level by ID
 */
export function getVillageLevelById(id: number): VillageLevel | null {
  return VILLAGE_LEVELS.find(level => level.id === id) || null;
}

/**
 * Get next village level (what they're working toward)
 */
export function getNextVillageLevel(currentLevelId: number): VillageLevel | null {
  const currentLevel = getVillageLevelById(currentLevelId);
  if (!currentLevel) return null;
  
  const nextId = currentLevel.id + 1;
  return getVillageLevelById(nextId);
}

/**
 * Get village level for count (alias for getVillageLevelData)
 * Matches guide's function name
 */
export function levelForCount(count: number): VillageLevel {
  return getVillageLevelData(count);
}
</file>

<file path="lib/generator/AmazonLinkAudit.ts">
// Amazon Affiliate Link Audit
// Checks all asinLink values in vetted-products for issues

import { VETTED_PRODUCTS } from '../data/vetted-products';

interface LinkIssue {
  ingredient: string;
  issue: string;
  asinLink?: string;
  productName?: string;
}

const issues: LinkIssue[] = [];
const stats = {
  total: 0,
  withLinks: 0,
  withoutLinks: 0,
  invalidFormat: 0,
  missingAsin: 0,
  suspiciousLinks: 0,
  duplicateAsins: new Map<string, string[]>(),
};

console.log('='.repeat(80));
console.log('AMAZON AFFILIATE LINK AUDIT');
console.log('='.repeat(80));
console.log();

// Check each product
for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  stats.total++;
  
  const asinLink = product.asinLink;
  
  // Issue 1: Missing asinLink
  if (!asinLink || asinLink === '') {
    stats.withoutLinks++;
    issues.push({
      ingredient: ingredientName,
      issue: 'Missing asinLink',
      productName: product.productName,
    });
    continue;
  }
  
  stats.withLinks++;
  
  // Issue 2: Invalid format (should be Amazon URL)
  if (!asinLink.includes('amazon.com')) {
    stats.invalidFormat++;
    issues.push({
      ingredient: ingredientName,
      issue: 'Not an Amazon link',
      asinLink,
      productName: product.productName,
    });
    continue;
  }
  
  // Issue 3: Missing ASIN in URL
  const asinMatch = asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  if (!asinMatch) {
    stats.missingAsin++;
    issues.push({
      ingredient: ingredientName,
      issue: 'No valid ASIN found in URL',
      asinLink,
      productName: product.productName,
    });
    continue;
  }
  
  const asin = asinMatch[1];
  
  // Issue 4: Missing affiliate tag
  if (!asinLink.includes('tag=robinfrench-20')) {
    stats.suspiciousLinks++;
    issues.push({
      ingredient: ingredientName,
      issue: 'Missing affiliate tag (tag=robinfrench-20)',
      asinLink,
      productName: product.productName,
    });
  }
  
  // Track duplicate ASINs
  if (!stats.duplicateAsins.has(asin)) {
    stats.duplicateAsins.set(asin, []);
  }
  stats.duplicateAsins.get(asin)!.push(ingredientName);
}

// Find actual duplicates (same ASIN used for multiple ingredients)
const duplicates = Array.from(stats.duplicateAsins.entries())
  .filter(([_, ingredients]) => ingredients.length > 1);

// Print Summary
console.log('SUMMARY');
console.log('-'.repeat(80));
console.log(`Total products: ${stats.total}`);
console.log(`With links: ${stats.withLinks} (${((stats.withLinks / stats.total) * 100).toFixed(1)}%)`);
console.log(`Without links: ${stats.withoutLinks} (${((stats.withoutLinks / stats.total) * 100).toFixed(1)}%)`);
console.log();
console.log(`Issues found: ${issues.length}`);
console.log(`  - Invalid format: ${stats.invalidFormat}`);
console.log(`  - Missing ASIN: ${stats.missingAsin}`);
console.log(`  - Missing affiliate tag: ${stats.suspiciousLinks}`);
console.log(`  - Duplicate ASINs: ${duplicates.length} ASINs used for multiple ingredients`);
console.log();

// Print Issues
if (issues.length > 0) {
  console.log('='.repeat(80));
  console.log('ISSUES FOUND');
  console.log('='.repeat(80));
  console.log();
  
  // Group by issue type
  const byType = issues.reduce((acc, issue) => {
    if (!acc[issue.issue]) acc[issue.issue] = [];
    acc[issue.issue].push(issue);
    return acc;
  }, {} as Record<string, LinkIssue[]>);
  
  for (const [issueType, issueList] of Object.entries(byType)) {
    console.log(`${issueType} (${issueList.length}):`);
    console.log('-'.repeat(80));
    
    issueList.slice(0, 10).forEach(issue => {
      console.log(`  Ingredient: ${issue.ingredient}`);
      if (issue.productName) console.log(`  Product: ${issue.productName}`);
      if (issue.asinLink) console.log(`  Link: ${issue.asinLink}`);
      console.log();
    });
    
    if (issueList.length > 10) {
      console.log(`  ... and ${issueList.length - 10} more`);
      console.log();
    }
  }
}

// Print Duplicate ASINs
if (duplicates.length > 0) {
  console.log('='.repeat(80));
  console.log('DUPLICATE ASINs');
  console.log('='.repeat(80));
  console.log();
  console.log('Same ASIN used for multiple ingredients (may indicate incorrect mappings):');
  console.log();
  
  duplicates.slice(0, 20).forEach(([asin, ingredients]) => {
    console.log(`ASIN ${asin} used for ${ingredients.length} ingredients:`);
    ingredients.forEach(ing => console.log(`  - ${ing}`));
    console.log();
  });
  
  if (duplicates.length > 20) {
    console.log(`... and ${duplicates.length - 20} more duplicate ASINs`);
  }
}

// Print recommendations
console.log('='.repeat(80));
console.log('RECOMMENDATIONS');
console.log('='.repeat(80));
console.log();

if (stats.withoutLinks > 0) {
  console.log(`1. Add asinLink for ${stats.withoutLinks} products without links`);
}

if (stats.invalidFormat > 0) {
  console.log(`2. Fix ${stats.invalidFormat} products with invalid link format`);
}

if (stats.missingAsin > 0) {
  console.log(`3. Fix ${stats.missingAsin} products with missing/invalid ASIN`);
}

if (stats.suspiciousLinks > 0) {
  console.log(`4. Add affiliate tag to ${stats.suspiciousLinks} products`);
}

if (duplicates.length > 0) {
  console.log(`5. Review ${duplicates.length} duplicate ASINs - may indicate wrong products`);
}

if (issues.length === 0 && duplicates.length === 0) {
  console.log('‚úÖ All links look good! No issues found.');
}

console.log();
console.log('='.repeat(80));
</file>

<file path="lib/generator/AutoClassifyLinks.ts">
// Auto-classify all 94 items using spec-based validation
// Reduces manual review from 94 ‚Üí ~15-20 items

import { VETTED_PRODUCTS } from '../data/vetted-products';
import { RETAIL_SPECS } from '../validation/retailSpecDefinitions';
import { RetailValidator } from '../validation/retailValidator';
import * as fs from 'fs';
import * as path from 'path';

interface ClassificationResult {
  ingredient: string;
  productName: string;
  asin: string;
  link: string;
  status: 'auto-valid' | 'auto-invalid' | 'needs-review' | 'no-spec';
  confidence: 'high' | 'medium' | 'low';
  issues: string[];
  notes: string;
}

const validator = new RetailValidator();
const results: ClassificationResult[] = [];

console.log('='.repeat(80));
console.log('AUTO-CLASSIFYING AMAZON LINKS');
console.log('='.repeat(80));
console.log();

// Track duplicate ASINs
const asinMap = new Map<string, string[]>();
for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  const asinMatch = product.asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  if (asinMatch) {
    const asin = asinMatch[1];
    if (!asinMap.has(asin)) {
      asinMap.set(asin, []);
    }
    asinMap.get(asin)!.push(ingredientName);
  }
}

// Known dead links
const deadLinks = new Set(['B0082C00P8', 'B0006L2XNK']);

// Process each ingredient
for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  const asinMatch = product.asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  if (!asinMatch) continue;
  
  const asin = asinMatch[1];
  const spec = RETAIL_SPECS[ingredientName];
  
  let status: ClassificationResult['status'];
  let confidence: ClassificationResult['confidence'];
  let issues: string[] = [];
  let notes = '';
  
  // Dead link check
  if (deadLinks.has(asin)) {
    status = 'auto-invalid';
    confidence = 'high';
    issues.push('Dead link (HTTP 405)');
    notes = 'NEEDS REPLACEMENT - Link is dead';
  }
  // Has spec - validate it
  else if (spec) {
    const validationResult = validator.validateProductTitle(
      product.productName,
      spec,
      asin
    );
    
    confidence = validationResult.confidence;
    issues = validationResult.issues.map(i => `${i.severity.toUpperCase()}: ${i.message}`);
    
    if (validationResult.status === 'valid') {
      status = 'auto-valid';
      notes = '‚úÖ Passes all validation checks';
    } else if (validationResult.status === 'invalid') {
      status = 'auto-invalid';
      notes = '‚ùå Failed validation - likely wrong product';
    } else {
      status = 'needs-review';
      notes = '‚ö†Ô∏è Ambiguous - manual review needed';
    }
  }
  // No spec - check if duplicate ASIN
  else {
    const duplicates = asinMap.get(asin) || [];
    if (duplicates.length > 1) {
      status = 'needs-review';
      confidence = 'medium';
      issues.push(`Duplicate ASIN shared with: ${duplicates.filter(d => d !== ingredientName).join(', ')}`);
      notes = '‚ö†Ô∏è Duplicate ASIN - verify if appropriate';
    } else {
      status = 'no-spec';
      confidence = 'medium';
      notes = 'No validation spec defined - assumed OK';
    }
  }
  
  results.push({
    ingredient: ingredientName,
    productName: product.productName,
    asin,
    link: product.asinLink,
    status,
    confidence,
    issues,
    notes,
  });
}

// Generate statistics
const stats = {
  total: results.length,
  autoValid: results.filter(r => r.status === 'auto-valid').length,
  autoInvalid: results.filter(r => r.status === 'auto-invalid').length,
  needsReview: results.filter(r => r.status === 'needs-review').length,
  noSpec: results.filter(r => r.status === 'no-spec').length,
};

console.log('CLASSIFICATION RESULTS');
console.log('-'.repeat(80));
console.log(`Total items: ${stats.total}`);
console.log(`‚úÖ Auto-valid: ${stats.autoValid} (${((stats.autoValid / stats.total) * 100).toFixed(1)}%)`);
console.log(`‚ùå Auto-invalid: ${stats.autoInvalid} (${((stats.autoInvalid / stats.total) * 100).toFixed(1)}%)`);
console.log(`‚ö†Ô∏è  Needs review: ${stats.needsReview} (${((stats.needsReview / stats.total) * 100).toFixed(1)}%)`);
console.log(`üìã No spec: ${stats.noSpec} (${((stats.noSpec / stats.total) * 100).toFixed(1)}%)`);
console.log();
console.log(`Manual review reduced from 94 ‚Üí ${stats.needsReview + stats.autoInvalid} items`);
console.log();

// Show items needing review
const reviewItems = results.filter(r => r.status === 'needs-review' || r.status === 'auto-invalid');

if (reviewItems.length > 0) {
  console.log('='.repeat(80));
  console.log(`ITEMS REQUIRING MANUAL REVIEW (${reviewItems.length})`);
  console.log('='.repeat(80));
  console.log();
  
  reviewItems.forEach((item, idx) => {
    console.log(`${idx + 1}. ${item.ingredient}`);
    console.log(`   Product: ${item.productName}`);
    console.log(`   ASIN: ${item.asin}`);
    console.log(`   Status: ${item.status.toUpperCase()}`);
    console.log(`   Confidence: ${item.confidence.toUpperCase()}`);
    if (item.issues.length > 0) {
      console.log(`   Issues:`);
      item.issues.forEach(issue => console.log(`     - ${issue}`));
    }
    console.log(`   Notes: ${item.notes}`);
    console.log(`   Link: ${item.link}`);
    console.log();
  });
}

// Generate CSV for manual review
const csvHeader = 'Status,Ingredient,Product Name,ASIN,Confidence,Issues,Notes,Action Needed,Link\n';
const csvRows = reviewItems.map(item => {
  const escapeCsv = (str: string) => `"${str.replace(/"/g, '""')}"`;
  return [
    item.status.toUpperCase(),
    escapeCsv(item.ingredient),
    escapeCsv(item.productName),
    item.asin,
    item.confidence.toUpperCase(),
    escapeCsv(item.issues.join('; ')),
    escapeCsv(item.notes),
    item.status === 'auto-invalid' ? 'FIND NEW ASIN' : 'VERIFY',
    item.link,
  ].join(',');
}).join('\n');

const csv = csvHeader + csvRows;
const outputPath = path.join(process.cwd(), 'MANUAL_REVIEW_REQUIRED.csv');
fs.writeFileSync(outputPath, csv, 'utf-8');

console.log('='.repeat(80));
console.log('NEXT STEPS');
console.log('='.repeat(80));
console.log();
console.log(`1. Open MANUAL_REVIEW_REQUIRED.csv (${reviewItems.length} items)`);
console.log('2. Click each link and verify product matches ingredient');
console.log('3. For AUTO-INVALID items: Find replacement ASIN');
console.log('4. For NEEDS-REVIEW items: Confirm if product is correct');
console.log();
console.log(`CSV saved to: ${outputPath}`);
console.log();

// Generate summary report
const report = `# Auto-Classification Report

## Summary

**Total items processed:** ${stats.total}

- ‚úÖ **Auto-valid:** ${stats.autoValid} (${((stats.autoValid / stats.total) * 100).toFixed(1)}%)
- ‚ùå **Auto-invalid:** ${stats.autoInvalid} (${((stats.autoInvalid / stats.total) * 100).toFixed(1)}%)
- ‚ö†Ô∏è **Needs review:** ${stats.needsReview} (${((stats.needsReview / stats.total) * 100).toFixed(1)}%)
- üìã **No spec:** ${stats.noSpec} (${((stats.noSpec / stats.total) * 100).toFixed(1)}%)

**Manual review reduced:** 94 ‚Üí ${stats.needsReview + stats.autoInvalid} items (${Math.round((1 - (stats.needsReview + stats.autoInvalid) / 94) * 100)}% reduction)

---

## Auto-Invalid Items (${stats.autoInvalid})

These items failed validation and need replacement ASINs:

${results.filter(r => r.status === 'auto-invalid').map(item => 
  `### ${item.ingredient}
- **Product:** ${item.productName}
- **ASIN:** ${item.asin}
- **Issues:** ${item.issues.join(', ')}
- **Action:** Find correct product on Amazon
- **Link:** ${item.link}
`).join('\n')}

---

## Needs Review (${stats.needsReview})

These items are ambiguous and need human verification:

${results.filter(r => r.status === 'needs-review').slice(0, 10).map(item =>
  `### ${item.ingredient}
- **Product:** ${item.productName}
- **ASIN:** ${item.asin}
- **Issues:** ${item.issues.join(', ')}
- **Action:** Verify if product is correct
- **Link:** ${item.link}
`).join('\n')}

${stats.needsReview > 10 ? `\n... and ${stats.needsReview - 10} more (see CSV)\n` : ''}

---

## Auto-Valid Items (${stats.autoValid})

These items passed all validation checks and are assumed correct.

---

## Next Steps

1. **Review the ${reviewItems.length} flagged items** in MANUAL_REVIEW_REQUIRED.csv
2. **Find replacement ASINs** for auto-invalid items
3. **Verify ambiguous items** by clicking links
4. **Update vetted-products.ts** with corrections

---

## Phase 2: PA-API Integration

After manual review is complete, we'll implement:
- Automated metadata fetching from Amazon PA-API
- Price and availability tracking
- Automatic re-validation of stale links
- Confidence scoring and caching
`;

const reportPath = path.join(process.cwd(), 'AUTO_CLASSIFICATION_REPORT.md');
fs.writeFileSync(reportPath, report, 'utf-8');

console.log(`Report saved to: ${reportPath}`);
console.log();
console.log('='.repeat(80));
</file>

<file path="lib/generator/BirdDebug.ts">
// Detailed debug for bird recipe generation
import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';
import { getIngredientsForSpecies } from '../data/ingredients';

const constraints: GenerationConstraints = {
  species: 'birds',
  lifeStage: 'adult',
  petWeightKg: 0.5,
  healthConcerns: ['digestive_issues'],
  targetCalories: 100,
};

console.log('=== BIRD RECIPE DEBUG ===\n');

// Check available ingredients
const allBirdIngredients = getIngredientsForSpecies('birds');
console.log(`Total bird ingredients available: ${allBirdIngredients.length}`);

const seeds = allBirdIngredients.filter(ing => ing.category === 'seed');
const nuts = allBirdIngredients.filter(ing => ing.category === 'nut');
const insects = allBirdIngredients.filter(ing => ing.category === 'insect');
const fruits = allBirdIngredients.filter(ing => ing.category === 'fruit');
const vegetables = allBirdIngredients.filter(ing => ing.category === 'vegetable');

console.log(`\nBy category:`);
console.log(`  Seeds: ${seeds.length}`);
console.log(`  Nuts: ${nuts.length}`);
console.log(`  Insects: ${insects.length}`);
console.log(`  Fruits: ${fruits.length}`);
console.log(`  Vegetables: ${vegetables.length}`);

console.log(`\nSample seeds:`);
seeds.slice(0, 5).forEach(s => console.log(`  - ${s.name} (id: ${s.id})`));

console.log(`\nSample nuts:`);
nuts.slice(0, 5).forEach(n => console.log(`  - ${n.name} (id: ${n.id})`));

console.log(`\n${'='.repeat(80)}`);
console.log('Attempting recipe generation...\n');

// Attempt generation with internal logging
const builder = new RecipeBuilder(constraints, 'standard', 'medium');

// Access private method via any cast to see what's happening
const builderAny = builder as any;

// Try to generate and see what happens
try {
  const recipe = builder.generate();
  
  if (recipe) {
    console.log('‚úÖ Recipe generated successfully!');
    console.log(`\nIngredients (${recipe.ingredients.length}):`);
    recipe.ingredients.forEach(p => {
      console.log(`  - ${p.ingredient.name} (${p.ingredient.category}): ${p.grams}g`);
    });
  } else {
    console.log('‚ùå Recipe generation returned null');
  }
} catch (error: any) {
  console.log('‚ùå Error during generation:', error.message);
  console.log(error.stack);
}
</file>

<file path="lib/generator/BirdDetailedDebug.ts">
// Very detailed debug - manually walk through the RecipeBuilder process
import { getIngredientsForSpecies } from '../data/ingredients';
import type { Ingredient } from '../data/ingredients';

const species = 'birds';
const healthConcerns = ['digestive_issues'];

console.log('=== DETAILED BIRD INGREDIENT DEBUG ===\n');

// Step 1: Get all bird ingredients
const allBirdIngredients = getIngredientsForSpecies(species);
console.log(`Step 1: Total bird ingredients: ${allBirdIngredients.length}\n`);

// Step 2: Check categories
const byCategory: Record<string, Ingredient[]> = {};
allBirdIngredients.forEach(ing => {
  if (!byCategory[ing.category]) byCategory[ing.category] = [];
  byCategory[ing.category].push(ing);
});

console.log('Step 2: Ingredients by category:');
Object.entries(byCategory).forEach(([cat, ings]) => {
  console.log(`  ${cat}: ${ings.length} ingredients`);
});

// Step 3: Check quality scores for seeds/nuts
console.log('\nStep 3: Quality scores for seeds:');
const seeds = byCategory['seed'] || [];
seeds.slice(0, 10).forEach(s => {
  console.log(`  ${s.name}: quality=${s.qualityScore}, feedingRole=${s.feedingRole}`);
});

console.log('\nStep 3b: Quality scores for nuts:');
const nuts = byCategory['nut'] || [];
nuts.slice(0, 10).forEach(n => {
  console.log(`  ${n.name}: quality=${n.qualityScore}, feedingRole=${n.feedingRole}`);
});

// Step 4: Filter by quality tier (standard = qualityScore >= 5)
const qualityTier = 'standard';
const minQuality = qualityTier === 'premium' ? 7 : qualityTier === 'standard' ? 5 : 0;

console.log(`\nStep 4: Filtering by quality tier '${qualityTier}' (min quality: ${minQuality})`);
const afterQualityFilter = allBirdIngredients.filter(ing => ing.qualityScore >= minQuality);
console.log(`  Remaining after quality filter: ${afterQualityFilter.length}`);

const seedsAfterFilter = afterQualityFilter.filter(ing => ing.category === 'seed');
const nutsAfterFilter = afterQualityFilter.filter(ing => ing.category === 'nut');
const insectsAfterFilter = afterQualityFilter.filter(ing => ing.category === 'insect');

console.log(`  Seeds after filter: ${seedsAfterFilter.length}`);
console.log(`  Nuts after filter: ${nutsAfterFilter.length}`);
console.log(`  Insects after filter: ${insectsAfterFilter.length}`);

if (seedsAfterFilter.length === 0) {
  console.log('\n‚ö†Ô∏è  WARNING: No seeds passed quality filter!');
  console.log('Seeds that failed:');
  seeds.forEach(s => {
    if (s.qualityScore < minQuality) {
      console.log(`  ‚ùå ${s.name}: quality=${s.qualityScore} (needs ${minQuality})`);
    }
  });
}

if (nutsAfterFilter.length === 0) {
  console.log('\n‚ö†Ô∏è  WARNING: No nuts passed quality filter!');
  console.log('Nuts that failed:');
  nuts.forEach(n => {
    if (n.qualityScore < minQuality) {
      console.log(`  ‚ùå ${n.name}: quality=${n.qualityScore} (needs ${minQuality})`);
    }
  });
}

// Step 5: Check what would be selected
console.log('\n=== SELECTION SIMULATION ===');
const requiredCategories = ['seed', 'nut', 'fruit', 'vegetable'];
console.log(`Required categories for birds: ${requiredCategories.join(', ')}\n`);

for (const category of requiredCategories) {
  const inCategory = afterQualityFilter.filter(ing => ing.category === category);
  console.log(`${category}: ${inCategory.length} available`);
  if (inCategory.length > 0) {
    console.log(`  Top 3:`);
    inCategory.slice(0, 3).forEach(ing => {
      console.log(`    - ${ing.name} (quality: ${ing.qualityScore})`);
    });
  } else {
    console.log(`  ‚ö†Ô∏è  NONE AVAILABLE - THIS WILL CAUSE ISSUES`);
  }
}
</file>

<file path="lib/generator/BirdTest.ts">
// Quick test for bird recipe generation
import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';

const constraints: GenerationConstraints = {
  species: 'birds',
  lifeStage: 'adult',
  petWeightKg: 0.5, // Small bird
  healthConcerns: ['digestive_issues'],
  targetCalories: 100,
};

console.log('Testing bird recipe generation...');
console.log('Constraints:', constraints);
console.log('='.repeat(80));

for (let attempt = 1; attempt <= 3; attempt++) {
  console.log(`\nAttempt ${attempt}:`);
  try {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();
    
    if (recipe) {
      console.log('‚úÖ SUCCESS!');
      console.log(`Ingredients (${recipe.ingredients.length}):`);
      recipe.ingredients.forEach(p => {
        console.log(`  - ${p.ingredient.name} (${p.ingredient.category}): ${p.grams}g`);
      });
      console.log(`Total: ${recipe.ingredients.reduce((sum, p) => sum + p.grams, 0)}g`);
      break;
    } else {
      console.log('‚ùå No recipe generated');
    }
  } catch (error: any) {
    console.log('‚ùå Error:', error.message);
  }
}
</file>

<file path="lib/generator/CheckBirdIngredients.ts">
// Check what bird ingredients are available
import { getIngredientsForSpecies } from '../data/ingredients';

console.log('Checking bird ingredients...\n');

const birdIngredients = getIngredientsForSpecies('birds');
console.log(`Total bird ingredients: ${birdIngredients.length}\n`);

// Group by category
const byCategory: Record<string, number> = {};
birdIngredients.forEach(ing => {
  byCategory[ing.category] = (byCategory[ing.category] || 0) + 1;
});

console.log('By category:');
Object.entries(byCategory).sort((a, b) => b[1] - a[1]).forEach(([cat, count]) => {
  console.log(`  ${cat}: ${count}`);
});

console.log('\n=== Seeds ===');
birdIngredients.filter(ing => ing.category === 'seed').slice(0, 10).forEach(ing => {
  console.log(`  - ${ing.name} (${ing.id})`);
});

console.log('\n=== Nuts ===');
birdIngredients.filter(ing => ing.category === 'nut').slice(0, 10).forEach(ing => {
  console.log(`  - ${ing.name} (${ing.id})`);
});

console.log('\n=== Insects ===');
birdIngredients.filter(ing => ing.category === 'insect').slice(0, 10).forEach(ing => {
  console.log(`  - ${ing.name} (${ing.id})`);
});

console.log('\n=== Fruits ===');
birdIngredients.filter(ing => ing.category === 'fruit').slice(0, 10).forEach(ing => {
  console.log(`  - ${ing.name} (${ing.id})`);
});

console.log('\n=== Vegetables ===');
birdIngredients.filter(ing => ing.category === 'vegetable').slice(0, 10).forEach(ing => {
  console.log(`  - ${ing.name} (${ing.id})`);
});
</file>

<file path="lib/generator/CombinatoricsPruning.ts">
/**
 * COMBINATORICS PRUNING
 * Pre-validation filtering to prevent micronutrient-toxic pairings
 * 
 * This runs BEFORE validation, teaching the generator what NOT to produce
 * instead of just rejecting finished recipes.
 */

import type { Ingredient } from '@/lib/data/ingredients';

// ============================================================================
// TOXIC PAIRINGS (Disallow these combinations)
// ============================================================================

interface ToxicPairing {
  ingredients: string[]; // ingredient names (lowercase, partial match)
  reason: string;
  maxAllowed?: number; // max of this pairing allowed (0 = never)
}

const TOXIC_PAIRINGS: ToxicPairing[] = [
  // Liver + high-iodine fish = vitamin A + iodine overload
  {
    ingredients: ['liver', 'salmon'],
    reason: 'Liver + salmon = vitamin A + iodine spike',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'cod'],
    reason: 'Liver + cod = vitamin A + iodine overload',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'sardine'],
    reason: 'Liver + sardine = vitamin A + iodine spike',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'mackerel'],
    reason: 'Liver + mackerel = vitamin A + iodine overload',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'herring'],
    reason: 'Liver + herring = vitamin A + iodine spike',
    maxAllowed: 0,
  },

  // Liver + high-iodine supplements = iodine bomb
  {
    ingredients: ['liver', 'kelp'],
    reason: 'Liver + kelp = iodine bomb',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'seaweed'],
    reason: 'Liver + seaweed = iodine overload',
    maxAllowed: 0,
  },

  // Multiple organ meats = mineral overload
  {
    ingredients: ['liver', 'kidney'],
    reason: 'Multiple organ meats = copper/mineral toxicity',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'heart'],
    reason: 'Multiple organ meats = mineral imbalance',
    maxAllowed: 0,
  },

  // High-copper sources together
  {
    ingredients: ['liver', 'sunflower_seed'],
    reason: 'Liver + sunflower seeds = copper overload',
    maxAllowed: 0,
  },
  {
    ingredients: ['liver', 'pumpkin_seed'],
    reason: 'Liver + pumpkin seeds = copper spike',
    maxAllowed: 0,
  },

  // Oxalate + calcium = absorption issues
  {
    ingredients: ['spinach', 'eggshell_powder'],
    reason: 'Spinach oxalates + calcium supplement = poor absorption',
    maxAllowed: 0,
  },
];

// ============================================================================
// INGREDIENT MICRONUTRIENT DENSITY PROFILE
// ============================================================================

interface MicronutrientProfile {
  vitaminA?: 'high' | 'medium' | 'low';
  copper?: 'high' | 'medium' | 'low';
  iodine?: 'high' | 'medium' | 'low';
  oxalates?: 'high' | 'medium' | 'low';
}

const MICRONUTRIENT_PROFILES: Record<string, MicronutrientProfile> = {
  // Organ meats (high in multiple micronutrients)
  liver: { vitaminA: 'high', copper: 'high', iodine: 'medium' },
  kidney: { copper: 'high', iodine: 'medium' },
  heart: { copper: 'medium' },

  // Fish (iodine-rich)
  salmon: { iodine: 'high', vitaminA: 'medium' },
  cod: { iodine: 'high' },
  sardine: { iodine: 'high' },
  mackerel: { iodine: 'high' },
  herring: { iodine: 'high' },

  // Supplements (concentrated)
  kelp: { iodine: 'high' },
  seaweed: { iodine: 'high' },
  fish_oil: { vitaminA: 'high' },
  cod_liver_oil: { vitaminA: 'high', iodine: 'high' },

  // Seeds (copper-rich)
  sunflower_seed: { copper: 'high' },
  pumpkin_seed: { copper: 'high' },
  sesame_seed: { copper: 'high' },

  // Vegetables (oxalate-rich)
  spinach: { oxalates: 'high' },
  beet_greens: { oxalates: 'high' },
  chard: { oxalates: 'high' },
};

// ============================================================================
// PRUNING FUNCTIONS
// ============================================================================

/**
 * Check if a pairing violates toxic combination rules
 */
export function hasToxicPairing(ingredients: Ingredient[]): boolean {
  const names = ingredients.map(ing => ing.name.toLowerCase());

  for (const pairing of TOXIC_PAIRINGS) {
    const matches = pairing.ingredients.filter(required =>
      names.some(name => name.includes(required))
    );

    if (matches.length === pairing.ingredients.length) {
      // All ingredients in this toxic pairing are present
      if (pairing.maxAllowed === 0) {
        return true; // Disallowed
      }
    }
  }

  return false;
}

/**
 * Get micronutrient density profile for an ingredient
 */
export function getMicronutrientProfile(ingredient: Ingredient): MicronutrientProfile {
  const name = ingredient.name.toLowerCase();

  for (const [key, profile] of Object.entries(MICRONUTRIENT_PROFILES)) {
    if (name.includes(key)) {
      return profile;
    }
  }

  return {}; // Unknown ingredient, assume low density
}

/**
 * Calculate cumulative micronutrient risk for a recipe
 * Returns a risk score (0-100) where 100 = definitely toxic
 * 
 * NOTE: This is SOFT pruning. Only flag truly dangerous combos.
 * Fish + liver is OK. Fish + fish oil + liver is risky.
 */
export function calculateMicronutrientRisk(ingredients: Ingredient[]): number {
  let risk = 0;

  // Check for specific dangerous combos
  const vitaminAHighCount = ingredients.filter(ing => {
    const profile = getMicronutrientProfile(ing);
    return profile.vitaminA === 'high';
  }).length;

  const iodineHighCount = ingredients.filter(ing => {
    const profile = getMicronutrientProfile(ing);
    return profile.iodine === 'high';
  }).length;

  const copperHighCount = ingredients.filter(ing => {
    const profile = getMicronutrientProfile(ing);
    return profile.copper === 'high';
  }).length;

  // Only flag if we have MULTIPLE high sources of the SAME nutrient
  // (not just any high-density ingredient)
  
  // Multiple vitamin A sources (e.g., liver + fish oil)
  if (vitaminAHighCount >= 2) risk += 50;

  // Multiple iodine sources (e.g., kelp + fish + fish oil)
  if (iodineHighCount >= 3) risk += 50;
  else if (iodineHighCount >= 2) risk += 20; // Mild risk for 2 iodine sources

  // Multiple copper sources (e.g., liver + seeds)
  if (copperHighCount >= 2) risk += 40;

  return Math.min(100, risk);
}

/**
 * Prune candidates that are likely to fail T6 (nutrient ceiling)
 * Returns true if candidate should be rejected
 */
export function shouldPruneCandidateForMicronutrients(ingredients: Ingredient[]): boolean {
  // Hard reject: toxic pairings
  if (hasToxicPairing(ingredients)) {
    return true;
  }

  // Soft reject: high micronutrient risk
  const risk = calculateMicronutrientRisk(ingredients);
  if (risk > 70) {
    return true; // Likely to fail T6
  }

  return false;
}

/**
 * Get a human-readable reason why a candidate was pruned
 */
export function getPruningReason(ingredients: Ingredient[]): string {
  if (hasToxicPairing(ingredients)) {
    const names = ingredients.map(ing => ing.name.toLowerCase());
    for (const pairing of TOXIC_PAIRINGS) {
      const matches = pairing.ingredients.filter(required =>
        names.some(name => name.includes(required))
      );
      if (matches.length === pairing.ingredients.length) {
        return pairing.reason;
      }
    }
  }

  const risk = calculateMicronutrientRisk(ingredients);
  if (risk > 70) {
    return `High micronutrient risk (${Math.round(risk)}/100)`;
  }

  return 'Unknown';
}
</file>

<file path="lib/generator/CommercialPriorEnforcement.test.ts">
/**
 * DETERMINISTIC TEST: Commercial Prior Enforcement
 * 
 * Tests that turkey + fish oil pairings are blocked based on commercial data
 */

import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  checkHardBlock,
  checkStrongPenalty,
  filterCandidatesByCommercialPriors,
  applyCommercialPriorScoring,
} from './CommercialPriorEnforcement';

describe('CommercialPriorEnforcement', () => {
  beforeEach(() => {
    // Spy on console.log to capture logging
    vi.spyOn(console, 'log').mockImplementation(() => {});
  });

  describe('Hard Block Detection', () => {
    it('should NOT block turkey + fish pairings (fish oil is common with poultry)', () => {
      // Arrange: turkey is selected
      const selected = ['turkey'];
      const species = 'dogs' as const;

      // Act: Check if fish/salmon/tuna are blocked
      const fishBlock = checkHardBlock('fish', selected, species);
      const salmonBlock = checkHardBlock('salmon', selected, species);
      const tunaBlock = checkHardBlock('tuna', selected, species);

      // Assert: Should NOT be blocked (fish oil is common supplement with poultry)
      // Data can't distinguish fish-as-protein from fish-oil-as-supplement
      expect(fishBlock).toBeNull();
      expect(salmonBlock).toBeNull();
      expect(tunaBlock).toBeNull();
    });

    it('should block beef + fish pairings (genuinely rare)', () => {
      // Arrange: beef is selected
      const selected = ['beef'];
      const species = 'dogs' as const;

      // Act: Check if fish/salmon are blocked
      const fishBlock = checkHardBlock('fish', selected, species);
      const salmonBlock = checkHardBlock('salmon', selected, species);

      // Assert: Should be blocked (beef + fish is genuinely rare in commercial products)
      expect(fishBlock).toBeTruthy();
      expect(salmonBlock).toBeTruthy();
    });

    it('should NOT block chicken + turkey pairing', () => {
      // Arrange: turkey is selected
      const selected = ['turkey'];
      const species = 'dogs' as const;

      // Act: Check if chicken is blocked
      const chickenBlock = checkHardBlock('chicken', selected, species);

      // Assert: Should NOT be blocked (they co-occur in commercial products)
      expect(chickenBlock).toBeNull();
    });

    it('should work with normalized pair keys regardless of order', () => {
      // Arrange: Use beef + fish (genuinely blocked)
      const species = 'dogs' as const;

      // Act: Check both orders
      const block1 = checkHardBlock('fish', ['beef'], species);
      const block2 = checkHardBlock('beef', ['fish'], species);

      // Assert: Both should detect the block
      expect(block1).toBeTruthy();
      expect(block2).toBeTruthy();
      expect(block1).toBe(block2); // Same normalized key
    });
  });

  describe('Candidate Filtering', () => {
    it('should filter out beef + fish pairings (genuinely rare)', () => {
      // Arrange: Beef is selected, candidates include fish proteins
      const candidates = [
        { id: 'fish', name: 'Fish' },
        { id: 'salmon', name: 'Salmon' },
        { id: 'chicken', name: 'Chicken' },
        { id: 'rice', name: 'Rice' },
      ];
      const selected = ['beef'];
      const species = 'dogs' as const;

      // Act: Filter candidates
      const filtered = filterCandidatesByCommercialPriors(candidates, selected, species);

      // Assert: Fish ingredients should be filtered out (beef + fish is rare)
      const filteredIds = filtered.map(c => c.id);
      expect(filteredIds).not.toContain('fish');
      expect(filteredIds).not.toContain('salmon');
      expect(filteredIds).toContain('chicken');
      expect(filteredIds).toContain('rice');
    });

    it('should NOT filter turkey + fish (fish oil is common)', () => {
      // Arrange: Turkey is selected, candidates include fish
      const candidates = [
        { id: 'fish', name: 'Fish' },
        { id: 'salmon', name: 'Salmon' },
        { id: 'chicken', name: 'Chicken' },
      ];
      const selected = ['turkey'];
      const species = 'dogs' as const;

      // Act: Filter candidates
      const filtered = filterCandidatesByCommercialPriors(candidates, selected, species);

      // Assert: Fish should NOT be filtered (fish oil is common with poultry)
      const filteredIds = filtered.map(c => c.id);
      expect(filteredIds).toContain('fish');
      expect(filteredIds).toContain('salmon');
      expect(filteredIds).toContain('chicken');
    });

    it('should log [PAIR BLOCK] messages when filtering', () => {
      // Arrange: Use beef + salmon (genuinely blocked)
      const candidates = [
        { id: 'salmon', name: 'Salmon' },
      ];
      const selected = ['beef'];
      const species = 'dogs' as const;

      // Act
      filterCandidatesByCommercialPriors(candidates, selected, species, '[TEST] ');

      // Assert: Should have logged the block
      expect(console.log).toHaveBeenCalledWith(
        expect.stringContaining('[PAIR BLOCK]')
      );
      expect(console.log).toHaveBeenCalledWith(
        expect.stringContaining('salmon')
      );
      expect(console.log).toHaveBeenCalledWith(
        expect.stringContaining('commercial data')
      );
    });
  });

  describe('Strong Penalty Detection', () => {
    it('should detect strong penalty pairs', () => {
      // Arrange: Select ingredients that have rare pairings
      const selected = ['beef'];
      const species = 'dogs' as const;

      // Act: Check for penalty pairs with grain
      const penaltyPairs = checkStrongPenalty('grain', selected, species);

      // Assert: Should detect penalty (beef + grain is rare with negative PMI)
      expect(penaltyPairs.length).toBeGreaterThan(0);
    });
  });

  describe('Scoring with Commercial Priors', () => {
    it('should apply harsh penalty (0.05x) to strong penalty pairs', () => {
      // Arrange
      const candidateId = 'grain';
      const baseScore = 100;
      const selected = ['beef'];
      const species = 'dogs' as const;

      // Act
      const penaltyPairs = checkStrongPenalty(candidateId, selected, species);
      
      // Only test if penalty pairs exist
      if (penaltyPairs.length > 0) {
        const finalScore = applyCommercialPriorScoring(candidateId, baseScore, selected, species);

        // Assert: Score should be heavily penalized
        expect(finalScore).toBeLessThan(baseScore * 0.1);
        expect(console.log).toHaveBeenCalledWith(
          expect.stringContaining('[PAIR PENALTY]')
        );
      }
    });

    it('should apply PMI boost to positive pairings', () => {
      // Arrange: chicken + peas is a common pairing with positive PMI
      const candidateId = 'peas';
      const baseScore = 100;
      const selected = ['chicken'];
      const species = 'dogs' as const;

      // Act
      const finalScore = applyCommercialPriorScoring(candidateId, baseScore, selected, species);

      // Assert: Score should be boosted (but not by much, max 1.15x)
      expect(finalScore).toBeGreaterThanOrEqual(baseScore);
      expect(finalScore).toBeLessThanOrEqual(baseScore * 1.15);
    });
  });

  describe('CRITICAL TEST: What We Actually Learned', () => {
    it('should BLOCK beef + fish pairings (genuinely rare)', () => {
      // Arrange: Beef is selected
      const selected = ['beef'];
      const candidates = [
        { id: 'fish', name: 'Fish' },
        { id: 'salmon', name: 'Salmon' },
        { id: 'chicken', name: 'Chicken' },
      ];
      const species = 'dogs' as const;

      // Act: Filter candidates
      const filtered = filterCandidatesByCommercialPriors(candidates, selected, species, '[CRITICAL] ');

      // Assert: Fish ingredients must be filtered out (beef + fish is genuinely rare)
      const filteredIds = filtered.map(c => c.id);
      expect(filteredIds).not.toContain('fish');
      expect(filteredIds).not.toContain('salmon');
      expect(filteredIds).toContain('chicken');

      // Assert: Logs must contain [PAIR BLOCK] messages
      expect(console.log).toHaveBeenCalledWith(
        expect.stringMatching(/\[CRITICAL\].*\[PAIR BLOCK\].*fish/)
      );
    });

    it('should NOT block turkey + fish (fish oil is common with poultry)', () => {
      // Arrange: Turkey is selected
      const selected = ['turkey'];
      const species = 'dogs' as const;

      // Act: Check hard block for fish types
      const fishBlock = checkHardBlock('fish', selected, species);
      const salmonBlock = checkHardBlock('salmon', selected, species);
      const tunaBlock = checkHardBlock('tuna', selected, species);

      // Assert: Should NOT be blocked (data can't distinguish fish-as-protein from fish-oil-as-supplement)
      // Fish oil is commonly used with poultry for omega-3
      expect(fishBlock).toBeNull();
      expect(salmonBlock).toBeNull();
      expect(tunaBlock).toBeNull();
    });

    it('should boost common pairings (chicken + peas, chicken + rice)', () => {
      // Arrange: Chicken is selected
      const candidateId = 'peas';
      const baseScore = 100;
      const selected = ['chicken'];
      const species = 'dogs' as const;

      // Act: Apply commercial prior scoring
      const finalScore = applyCommercialPriorScoring(candidateId, baseScore, selected, species);

      // Assert: Score should be boosted OR stay same (chicken + peas is common: 51 products)
      // Note: With conservative thresholds (minIng>=30), peas (60) qualifies
      // PMI might be positive or neutral depending on data
      expect(finalScore).toBeGreaterThanOrEqual(baseScore);
      expect(finalScore).toBeLessThanOrEqual(baseScore * 1.15); // Capped at 1.15x
    });
  });

  describe('Species-Specific Gating', () => {
    it('should only apply priors for dogs and cats', () => {
      // Arrange
      const selected = ['turkey'];
      const birdsSpecies = 'birds' as const;

      // Act: Check for birds (should have no priors)
      const block = checkHardBlock('fish', selected, birdsSpecies);

      // Assert: Should return null (no priors for birds yet)
      expect(block).toBeNull();
    });

    it('should apply same priors to both dogs and cats', () => {
      // Arrange: Use beef + fish (genuinely blocked)
      const selected = ['beef'];

      // Act: Check for both species
      const dogBlock = checkHardBlock('fish', selected, 'dogs');
      const catBlock = checkHardBlock('fish', selected, 'cats');

      // Assert: Both should block (using same commercial data)
      expect(dogBlock).toBeTruthy();
      expect(catBlock).toBeTruthy();
    });
  });
});
</file>

<file path="lib/generator/CommercialPriorEnforcement.ts">
/**
 * COMMERCIAL PRIOR ENFORCEMENT
 * 
 * Enforces learned commercial pairing rules:
 * - hardBlockPairs: Filter out candidates that never co-occur with selected ingredients
 * - strongPenaltyPairs: Apply harsh penalty (0.05x) to rare negative pairings
 * - Positive PMI: Apply soft boost (1.05-1.15x) to common pairings
 */

import recipePriors from '../data/recipePriors.json';
import type { Species } from '../types';

interface CommercialPriors {
  ingredientCounts: Record<string, number>;
  ingredientFreq: Record<string, number>;
  pairCounts: Record<string, number>;
  pairPMI: Record<string, number>;
  hardBlockPairs: string[];
  strongPenaltyPairs: string[];
}

/**
 * Normalize pair key to sorted format (a|b)
 */
function normalizePairKey(ing1: string, ing2: string): string {
  return [ing1, ing2].sort().join('|');
}

/**
 * Get commercial priors for a species
 */
function getCommercialPriors(species: Species): CommercialPriors | null {
  const priors = (recipePriors as any).commercialPriors;
  if (!priors) return null;
  
  // Map species to commercial priors key
  const speciesKey = species === 'dogs' || species === 'cats' ? species : null;
  if (!speciesKey) return null;
  
  return priors[speciesKey] as CommercialPriors;
}

/**
 * Check if a candidate ingredient is hard-blocked by any selected ingredient
 * Returns the blocking pair if found, null otherwise
 */
export function checkHardBlock(
  candidateId: string,
  selectedIngredientIds: string[],
  species: Species
): string | null {
  const priors = getCommercialPriors(species);
  if (!priors || !priors.hardBlockPairs) return null;
  
  const hardBlockSet = new Set(priors.hardBlockPairs);
  
  for (const selectedId of selectedIngredientIds) {
    const pairKey = normalizePairKey(candidateId, selectedId);
    if (hardBlockSet.has(pairKey)) {
      return pairKey;
    }
  }
  
  return null;
}

/**
 * Check if a candidate ingredient has strong penalty pairs with selected ingredients
 * Returns array of penalty pairs
 */
export function checkStrongPenalty(
  candidateId: string,
  selectedIngredientIds: string[],
  species: Species
): string[] {
  const priors = getCommercialPriors(species);
  if (!priors || !priors.strongPenaltyPairs) return [];
  
  const penaltySet = new Set(priors.strongPenaltyPairs);
  const penaltyPairs: string[] = [];
  
  for (const selectedId of selectedIngredientIds) {
    const pairKey = normalizePairKey(candidateId, selectedId);
    if (penaltySet.has(pairKey)) {
      penaltyPairs.push(pairKey);
    }
  }
  
  return penaltyPairs;
}

/**
 * Get PMI boost for a candidate ingredient paired with selected ingredients
 * Returns multiplier (1.0 = no change, >1.0 = boost, <1.0 = penalty)
 */
export function getPMIBoost(
  candidateId: string,
  selectedIngredientIds: string[],
  species: Species
): number {
  const priors = getCommercialPriors(species);
  if (!priors || !priors.pairPMI) return 1.0;
  
  let totalPMI = 0;
  let pairCount = 0;
  
  for (const selectedId of selectedIngredientIds) {
    const pairKey = normalizePairKey(candidateId, selectedId);
    const pmi = priors.pairPMI[pairKey];
    
    if (pmi !== undefined && pmi > 0) {
      totalPMI += pmi;
      pairCount++;
    }
  }
  
  if (pairCount === 0) return 1.0;
  
  // Average PMI across pairs
  const avgPMI = totalPMI / pairCount;
  
  // Convert to multiplier: PMI of 1.0 -> 1.05x boost, PMI of 2.0 -> 1.10x boost
  // Cap at 1.15x to avoid over-boosting
  const boost = 1.0 + Math.min(avgPMI * 0.05, 0.15);
  
  return boost;
}

/**
 * Filter candidates by commercial priors
 * Removes hard-blocked candidates and logs reasons
 */
export function filterCandidatesByCommercialPriors<T extends { id: string }>(
  candidates: T[],
  selectedIngredientIds: string[],
  species: Species,
  logPrefix: string = ''
): T[] {
  const priors = getCommercialPriors(species);
  if (!priors) return candidates;
  
  return candidates.filter(candidate => {
    const blockingPair = checkHardBlock(candidate.id, selectedIngredientIds, species);
    
    if (blockingPair) {
      const [ing1, ing2] = blockingPair.split('|');
      console.log(`${logPrefix}[PAIR BLOCK] ${candidate.id}: Never co-occurs with ${ing1 === candidate.id ? ing2 : ing1} (commercial data)`);
      return false;
    }
    
    return true;
  });
}

/**
 * Apply commercial prior scoring to a candidate
 * Returns modified score and logs reasons
 */
export function applyCommercialPriorScoring(
  candidateId: string,
  baseScore: number,
  selectedIngredientIds: string[],
  species: Species,
  logPrefix: string = ''
): number {
  const priors = getCommercialPriors(species);
  if (!priors) return baseScore;
  
  let score = baseScore;
  
  // Check for strong penalty pairs
  const penaltyPairs = checkStrongPenalty(candidateId, selectedIngredientIds, species);
  if (penaltyPairs.length > 0) {
    score *= 0.05; // Harsh penalty
    penaltyPairs.forEach(pair => {
      const [ing1, ing2] = pair.split('|');
      const otherIng = ing1 === candidateId ? ing2 : ing1;
      console.log(`${logPrefix}[PAIR PENALTY] ${candidateId}: Rare pairing with ${otherIng} (commercial data, PMI<-1.5)`);
    });
  }
  
  // Apply PMI boost for positive pairings
  const pmiBoost = getPMIBoost(candidateId, selectedIngredientIds, species);
  if (pmiBoost > 1.0) {
    score *= pmiBoost;
    console.log(`${logPrefix}[PMI BOOST] ${candidateId}: ${pmiBoost.toFixed(2)}x boost from commercial pairings`);
  }
  
  return score;
}

/**
 * Check if commercial priors are available for a species
 */
export function hasCommercialPriors(species: Species): boolean {
  return getCommercialPriors(species) !== null;
}
</file>

<file path="lib/generator/ComprehensiveAudit.ts">
// Comprehensive Audit: All Species + Health Concerns
// Tests recipe generation for every species with single and paired health concerns

import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';

type Species = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

const SPECIES: Species[] = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];

const HEALTH_CONCERNS = [
  'allergies',
  'digestive_issues',
  'joint_health',
  'skin_health',
  'weight_management',
  'dental_health',
  'immune_support',
];

interface AuditResult {
  species: Species;
  healthConcerns: string[];
  success: boolean;
  attempts: number;
  totalGrams?: number;
  primaryProteins?: number;
  error?: string;
}

const results: AuditResult[] = [];

console.log('='.repeat(80));
console.log('COMPREHENSIVE RECIPE GENERATION AUDIT');
console.log('='.repeat(80));
console.log(`Testing ${SPECIES.length} species √ó ${HEALTH_CONCERNS.length} concerns + pairs`);
console.log(`Total combinations: ~${SPECIES.length * (HEALTH_CONCERNS.length + (HEALTH_CONCERNS.length * (HEALTH_CONCERNS.length - 1)) / 2)}`);
console.log('='.repeat(80));

let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

// Test 1: Single health concerns
console.log('\nüìã PHASE 1: Single Health Concerns');
console.log('-'.repeat(80));

for (const species of SPECIES) {
  for (const concern of HEALTH_CONCERNS) {
    totalTests++;
    const constraints: GenerationConstraints = {
      species,
      lifeStage: 'adult',
      petWeightKg: species === 'dogs' ? 20 : species === 'cats' ? 5 : 2,
      healthConcerns: [concern],
      targetCalories: 500,
    };

    let attempts = 0;
    let success = false;
    let totalGrams = 0;
    let primaryProteins = 0;

    for (let i = 0; i < 3; i++) {
      attempts++;
      try {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe && recipe.ingredients.length > 0) {
          success = true;
          totalGrams = recipe.ingredients.reduce((sum, p) => sum + p.grams, 0);
          primaryProteins = recipe.ingredients.filter(
            p => p.ingredient.category === 'protein' && p.ingredient.proteinRole === 'primary'
          ).length;
          break;
        }
      } catch (error) {
        // Continue to next attempt
      }
    }

    const result: AuditResult = {
      species,
      healthConcerns: [concern],
      success,
      attempts,
      totalGrams,
      primaryProteins,
    };

    results.push(result);

    if (success) {
      passedTests++;
      console.log(`‚úÖ ${species.padEnd(12)} + ${concern.padEnd(20)} | ${totalGrams}g | ${primaryProteins} primary protein`);
    } else {
      failedTests++;
      console.log(`‚ùå ${species.padEnd(12)} + ${concern.padEnd(20)} | Failed after ${attempts} attempts`);
    }
  }
}

// Test 2: Paired health concerns (sample combinations)
console.log('\nüìã PHASE 2: Paired Health Concerns (Sample)');
console.log('-'.repeat(80));

const pairCombos = [
  ['allergies', 'digestive_issues'],
  ['joint_health', 'weight_management'],
  ['skin_health', 'immune_support'],
  ['digestive_issues', 'dental_health'],
  ['weight_management', 'immune_support'],
];

for (const species of SPECIES) {
  for (const [concern1, concern2] of pairCombos) {
    totalTests++;
    const constraints: GenerationConstraints = {
      species,
      lifeStage: 'adult',
      petWeightKg: species === 'dogs' ? 20 : species === 'cats' ? 5 : 2,
      healthConcerns: [concern1, concern2],
      targetCalories: 500,
    };

    let attempts = 0;
    let success = false;
    let totalGrams = 0;
    let primaryProteins = 0;

    for (let i = 0; i < 3; i++) {
      attempts++;
      try {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe && recipe.ingredients.length > 0) {
          success = true;
          totalGrams = recipe.ingredients.reduce((sum, p) => sum + p.grams, 0);
          primaryProteins = recipe.ingredients.filter(
            p => p.ingredient.category === 'protein' && p.ingredient.proteinRole === 'primary'
          ).length;
          break;
        }
      } catch (error) {
        // Continue to next attempt
      }
    }

    const result: AuditResult = {
      species,
      healthConcerns: [concern1, concern2],
      success,
      attempts,
      totalGrams,
      primaryProteins,
    };

    results.push(result);

    if (success) {
      passedTests++;
      console.log(
        `‚úÖ ${species.padEnd(12)} + ${(concern1 + ' + ' + concern2).padEnd(35)} | ${totalGrams}g | ${primaryProteins} primary protein`
      );
    } else {
      failedTests++;
      console.log(
        `‚ùå ${species.padEnd(12)} + ${(concern1 + ' + ' + concern2).padEnd(35)} | Failed after ${attempts} attempts`
      );
    }
  }
}

// Summary
console.log('\n' + '='.repeat(80));
console.log('AUDIT SUMMARY');
console.log('='.repeat(80));
console.log(`Total Tests: ${totalTests}`);
console.log(`‚úÖ Passed: ${passedTests} (${((passedTests / totalTests) * 100).toFixed(1)}%)`);
console.log(`‚ùå Failed: ${failedTests} (${((failedTests / totalTests) * 100).toFixed(1)}%)`);

// Breakdown by species
console.log('\nüìä Results by Species:');
for (const species of SPECIES) {
  const speciesResults = results.filter(r => r.species === species);
  const speciesPassed = speciesResults.filter(r => r.success).length;
  const speciesTotal = speciesResults.length;
  console.log(
    `  ${species.padEnd(12)}: ${speciesPassed}/${speciesTotal} (${((speciesPassed / speciesTotal) * 100).toFixed(1)}%)`
  );
}

// Breakdown by health concern
console.log('\nüìä Results by Health Concern (Single):');
for (const concern of HEALTH_CONCERNS) {
  const concernResults = results.filter(r => r.healthConcerns.length === 1 && r.healthConcerns[0] === concern);
  const concernPassed = concernResults.filter(r => r.success).length;
  const concernTotal = concernResults.length;
  console.log(
    `  ${concern.padEnd(20)}: ${concernPassed}/${concernTotal} (${((concernPassed / concernTotal) * 100).toFixed(1)}%)`
  );
}

// Failed combinations
const failedResults = results.filter(r => !r.success);
if (failedResults.length > 0) {
  console.log('\n‚ö†Ô∏è  Failed Combinations:');
  for (const result of failedResults.slice(0, 10)) {
    console.log(`  ${result.species} + ${result.healthConcerns.join(', ')}`);
  }
  if (failedResults.length > 10) {
    console.log(`  ... and ${failedResults.length - 10} more`);
  }
}

console.log('\n' + '='.repeat(80));
</file>

<file path="lib/generator/DebugProteinRole.ts">
// Quick debug to check proteinRole population
import { getIngredientsForSpecies } from '../data/ingredients';

const dogs = getIngredientsForSpecies('dogs');
const proteins = dogs.filter(i => i.category === 'protein').slice(0, 10);

console.log('=== Dog Proteins ===');
proteins.forEach(p => {
  console.log(`${p.name}: proteinRole=${p.proteinRole || 'undefined'}`);
});
</file>

<file path="lib/generator/GenerateVerificationList.ts">
// Generate a verification list for manual Amazon link checking
// Outputs CSV format for easy tracking in Excel/Sheets

import { VETTED_PRODUCTS } from '../data/vetted-products';
import * as fs from 'fs';
import * as path from 'path';

interface VerificationItem {
  ingredient: string;
  productName: string;
  asin: string;
  link: string;
  issue: string;
  priority: 'high' | 'medium' | 'low';
  verified: 'pending' | 'correct' | 'wrong' | 'dead';
  notes: string;
}

const items: VerificationItem[] = [];

// Track duplicate ASINs
const asinMap = new Map<string, string[]>();

for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  const asinLink = product.asinLink;
  const asinMatch = asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  
  if (asinMatch) {
    const asin = asinMatch[1];
    if (!asinMap.has(asin)) {
      asinMap.set(asin, []);
    }
    asinMap.get(asin)!.push(ingredientName);
  }
}

// Known dead links from HTTP check
const deadLinks = new Set(['B0082C00P8', 'B0006L2XNK']);

// Known suspicious mappings
const suspiciousMapping: Record<string, { ingredients: string[]; issue: string }> = {
  'B07VHR2WNZ': { ingredients: ['ground beef (lean)', 'venison'], issue: 'Beef and venison are different meats' },
  'B0082C00P8': { ingredients: ['ground lamb', 'rabbit meat'], issue: 'Lamb and rabbit are different meats (DEAD LINK)' },
  'B0BXZ3JJL9': { ingredients: ['chicken hearts', 'turkey giblets'], issue: 'Chicken and turkey are different poultry' },
  'B01FUWYO2M': { ingredients: ['sardines (canned in water)', 'herring (canned)', 'sardines (in water)'], issue: 'Sardines and herring are different fish' },
  'B00WM6CHFQ': { ingredients: ['mango', 'chia seed oil'], issue: 'Mango and chia oil are completely different' },
  'B0BWBNT8JX': { ingredients: ['egg (hard-boiled)', 'duck hearts'], issue: 'Eggs and duck hearts are different' },
  'B00027ZVG4': { ingredients: ['canary seed', 'flaxseeds', 'rapeseed', 'sunflower seeds (small amounts)', 'pumpkin seeds', 'cuttlebone'], issue: 'Multiple seed types - verify if seed mix is appropriate' },
  'B086211R4H': { ingredients: ['niger seed', 'oat groats', 'hemp seeds', 'sesame seeds', 'chia seeds', 'pellets (fortified)'], issue: 'Multiple seed types - verify if seed mix is appropriate' },
};

// Generate verification items
for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  const asinLink = product.asinLink;
  const asinMatch = asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  
  if (!asinMatch) continue;
  
  const asin = asinMatch[1];
  
  // Check if this needs verification
  let needsVerification = false;
  let issue = '';
  let priority: 'high' | 'medium' | 'low' = 'low';
  
  // Dead link
  if (deadLinks.has(asin)) {
    needsVerification = true;
    issue = 'Dead link (HTTP 405) - needs replacement';
    priority = 'high';
  }
  // Suspicious mapping
  else if (suspiciousMapping[asin]) {
    needsVerification = true;
    issue = suspiciousMapping[asin].issue;
    priority = 'high';
  }
  // Duplicate ASIN (but not in suspicious list)
  else if (asinMap.get(asin)!.length > 1) {
    needsVerification = true;
    issue = `Shared with: ${asinMap.get(asin)!.filter(i => i !== ingredientName).join(', ')}`;
    priority = 'medium';
  }
  
  if (needsVerification) {
    items.push({
      ingredient: ingredientName,
      productName: product.productName,
      asin,
      link: asinLink,
      issue,
      priority,
      verified: deadLinks.has(asin) ? 'dead' : 'pending',
      notes: '',
    });
  }
}

// Sort by priority
items.sort((a, b) => {
  const priorityOrder = { high: 0, medium: 1, low: 2 };
  return priorityOrder[a.priority] - priorityOrder[b.priority];
});

// Generate CSV
const csvHeader = 'Priority,Ingredient,Product Name,ASIN,Issue,Verified,Notes,Link\n';
const csvRows = items.map(item => {
  const escapeCsv = (str: string) => `"${str.replace(/"/g, '""')}"`;
  return [
    item.priority.toUpperCase(),
    escapeCsv(item.ingredient),
    escapeCsv(item.productName),
    item.asin,
    escapeCsv(item.issue),
    item.verified.toUpperCase(),
    '', // Empty notes column for manual entry
    item.link,
  ].join(',');
}).join('\n');

const csv = csvHeader + csvRows;

// Save to file
const outputPath = path.join(process.cwd(), 'AMAZON_LINK_VERIFICATION.csv');
fs.writeFileSync(outputPath, csv, 'utf-8');

console.log('='.repeat(80));
console.log('VERIFICATION LIST GENERATED');
console.log('='.repeat(80));
console.log();
console.log(`Total items needing verification: ${items.length}`);
console.log(`  High priority: ${items.filter(i => i.priority === 'high').length}`);
console.log(`  Medium priority: ${items.filter(i => i.priority === 'medium').length}`);
console.log(`  Low priority: ${items.filter(i => i.priority === 'low').length}`);
console.log();
console.log(`CSV file saved to: ${outputPath}`);
console.log();
console.log('HOW TO USE:');
console.log('1. Open AMAZON_LINK_VERIFICATION.csv in Excel/Google Sheets');
console.log('2. Click each link in the "Link" column');
console.log('3. Verify if the Amazon product matches the ingredient');
console.log('4. Update "Verified" column: CORRECT, WRONG, or DEAD');
console.log('5. Add notes in "Notes" column if needed');
console.log('6. For WRONG/DEAD items, find correct ASIN and add to notes');
console.log();
console.log('='.repeat(80));

// Also generate a markdown table for easy viewing
const mdTable = `# Amazon Link Verification List

Total items: ${items.length}

## High Priority (${items.filter(i => i.priority === 'high').length})

| Ingredient | Product | ASIN | Issue | Link |
|------------|---------|------|-------|------|
${items.filter(i => i.priority === 'high').map(item => 
  `| ${item.ingredient} | ${item.productName} | ${item.asin} | ${item.issue} | [Verify](${item.link}) |`
).join('\n')}

## Medium Priority (${items.filter(i => i.priority === 'medium').length})

| Ingredient | Product | ASIN | Issue | Link |
|------------|---------|------|-------|------|
${items.filter(i => i.priority === 'medium').slice(0, 10).map(item => 
  `| ${item.ingredient} | ${item.productName} | ${item.asin} | ${item.issue} | [Verify](${item.link}) |`
).join('\n')}

${items.filter(i => i.priority === 'medium').length > 10 ? `\n... and ${items.filter(i => i.priority === 'medium').length - 10} more medium priority items (see CSV)\n` : ''}

## Instructions

1. Click each "Verify" link
2. Check if Amazon product matches ingredient name
3. Mark in CSV: CORRECT, WRONG, or DEAD
4. For WRONG/DEAD: Find correct product and note new ASIN
`;

const mdPath = path.join(process.cwd(), 'AMAZON_LINK_VERIFICATION.md');
fs.writeFileSync(mdPath, mdTable, 'utf-8');

console.log(`Markdown file saved to: ${mdPath}`);
console.log();
</file>

<file path="lib/generator/Phase1_5_AutoClassify.ts">
// Phase 1.5: Enhanced auto-classification with clustering and token equivalence
// Reduces manual review from ~90 items to ~20 items

import { VETTED_PRODUCTS } from '../data/vetted-products';
import { RETAIL_SPECS } from '../validation/retailSpecDefinitions';
import { EnhancedRetailValidator } from '../validation/enhancedRetailValidator';
import { ASINClusterer } from '../validation/asinClusterer';
import * as fs from 'fs';
import * as path from 'path';

interface EnhancedClassificationResult {
  ingredient: string;
  productName: string;
  asin: string;
  link: string;
  status: 'auto-valid' | 'auto-structurally-valid' | 'auto-invalid' | 'needs-review' | 'no-spec';
  confidence: 'high' | 'medium' | 'low';
  issues: string[];
  notes: string;
  aliasGroup?: string;
  reasoning?: string;
}

const validator = new EnhancedRetailValidator();
const clusterer = new ASINClusterer();
const results: EnhancedClassificationResult[] = [];

console.log('='.repeat(80));
console.log('PHASE 1.5: ENHANCED AUTO-CLASSIFICATION');
console.log('With ASIN clustering + token equivalence + 4-state validation');
console.log('='.repeat(80));
console.log();

// Known dead links
const deadLinks = new Set(['B0082C00P8', 'B0006L2XNK']);

// STEP 1: Cluster duplicate ASINs
console.log('Step 1: Clustering duplicate ASINs...');
const productMap = new Map(Object.entries(VETTED_PRODUCTS));
const { aliasGroups, conflicts, singles } = clusterer.clusterByASIN(productMap);

console.log(`  Found ${aliasGroups.length} alias groups`);
console.log(`  Found ${conflicts.length} conflicts (wrong products)`);
console.log(`  Found ${singles.length} single-ASIN ingredients`);
console.log();

// STEP 2: Validate alias groups (once per group)
console.log('Step 2: Validating alias groups...');
const groupValidations = new Map<string, any>();

for (const group of aliasGroups) {
  const product = VETTED_PRODUCTS[group.canonicalName];
  if (!product) continue;
  
  const spec = RETAIL_SPECS[group.canonicalName];
  if (!spec) {
    // No spec for this group - mark as structurally valid by default
    groupValidations.set(group.groupId, {
      status: 'structurally-valid',
      confidence: 'medium',
      notes: 'No spec defined - assumed OK (alias group)',
    });
    continue;
  }
  
  const validationResult = validator.validateProductTitle(
    product.productName,
    spec,
    group.sharedASIN,
    group.canonicalName
  );
  
  groupValidations.set(group.groupId, validationResult);
}

console.log(`  Validated ${groupValidations.size} alias groups`);
console.log();

// STEP 3: Process all ingredients
console.log('Step 3: Classifying all ingredients...');

// Create reverse lookup: ingredient -> alias group
const ingredientToGroup = new Map<string, string>();
for (const group of aliasGroups) {
  for (const alias of group.aliases) {
    ingredientToGroup.set(alias, group.groupId);
  }
}

for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  const asinMatch = product.asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
  if (!asinMatch) continue;
  
  const asin = asinMatch[1];
  const spec = RETAIL_SPECS[ingredientName];
  
  let status: EnhancedClassificationResult['status'];
  let confidence: EnhancedClassificationResult['confidence'];
  let issues: string[] = [];
  let notes = '';
  let reasoning = '';
  let aliasGroup: string | undefined;
  
  // Check if dead link
  if (deadLinks.has(asin)) {
    status = 'auto-invalid';
    confidence = 'high';
    issues.push('Dead link (HTTP 405)');
    notes = '‚ùå NEEDS REPLACEMENT - Link is dead';
  }
  // Check if part of alias group
  else if (ingredientToGroup.has(ingredientName)) {
    const groupId = ingredientToGroup.get(ingredientName)!;
    const groupValidation = groupValidations.get(groupId);
    aliasGroup = groupId;
    
    if (groupValidation) {
      // Inherit validation from group
      if (groupValidation.status === 'valid') {
        status = 'auto-valid';
        confidence = groupValidation.confidence;
        notes = `‚úÖ Valid (alias group: ${groupId})`;
      } else if (groupValidation.status === 'structurally-valid') {
        status = 'auto-structurally-valid';
        confidence = groupValidation.confidence;
        notes = `‚úÖ Structurally valid (alias group: ${groupId})`;
        if (groupValidation.reasoning?.equivalentTokensUsed?.length > 0) {
          reasoning = `Uses equivalent tokens: ${groupValidation.reasoning.equivalentTokensUsed.map((e: any) => `${e.token}‚âà${e.synonym}`).join(', ')}`;
        }
      } else if (groupValidation.status === 'ambiguous') {
        status = 'needs-review';
        confidence = groupValidation.confidence;
        notes = `‚ö†Ô∏è Ambiguous (alias group: ${groupId})`;
      } else {
        status = 'auto-invalid';
        confidence = groupValidation.confidence;
        notes = `‚ùå Invalid (alias group: ${groupId})`;
      }
      
      if (groupValidation.structuralIssues) {
        issues.push(...groupValidation.structuralIssues.map((i: any) => `STRUCTURAL: ${i.message}`));
      }
      if (groupValidation.semanticIssues) {
        issues.push(...groupValidation.semanticIssues.map((i: any) => `SEMANTIC: ${i.message}`));
      }
    } else {
      status = 'no-spec';
      confidence = 'medium';
      notes = `No spec (alias group: ${groupId})`;
    }
  }
  // Check if conflict
  else if (conflicts.some(c => c.ingredients.includes(ingredientName))) {
    const conflict = conflicts.find(c => c.ingredients.includes(ingredientName))!;
    status = 'needs-review';
    confidence = 'low';
    issues.push(`CONFLICT: ${conflict.reason}`);
    notes = `‚ö†Ô∏è Conflict detected - likely wrong product`;
  }
  // Has spec - validate individually
  else if (spec) {
    const validationResult = validator.validateProductTitle(
      product.productName,
      spec,
      asin,
      ingredientName
    );
    
    confidence = validationResult.confidence;
    
    if (validationResult.structuralIssues) {
      issues.push(...validationResult.structuralIssues.map(i => `STRUCTURAL: ${i.message}`));
    }
    if (validationResult.semanticIssues) {
      issues.push(...validationResult.semanticIssues.map(i => `SEMANTIC: ${i.message}`));
    }
    
    if (validationResult.reasoning?.equivalentTokensUsed?.length > 0) {
      reasoning = `Uses equivalent tokens: ${validationResult.reasoning.equivalentTokensUsed.map(e => `${e.token}‚âà${e.synonym}`).join(', ')}`;
    }
    
    if (validationResult.status === 'valid') {
      status = 'auto-valid';
      notes = '‚úÖ Passes all validation checks';
    } else if (validationResult.status === 'structurally-valid') {
      status = 'auto-structurally-valid';
      notes = '‚úÖ Structurally valid - safe to use';
    } else if (validationResult.status === 'invalid') {
      status = 'auto-invalid';
      notes = '‚ùå Failed validation - likely wrong product';
    } else {
      status = 'needs-review';
      notes = '‚ö†Ô∏è Ambiguous - manual review needed';
    }
  }
  // No spec - assume OK
  else {
    status = 'no-spec';
    confidence = 'medium';
    notes = 'No validation spec defined - assumed OK';
  }
  
  results.push({
    ingredient: ingredientName,
    productName: product.productName,
    asin,
    link: product.asinLink,
    status,
    confidence,
    issues,
    notes,
    aliasGroup,
    reasoning,
  });
}

// Generate statistics
const stats = {
  total: results.length,
  autoValid: results.filter(r => r.status === 'auto-valid').length,
  autoStructurallyValid: results.filter(r => r.status === 'auto-structurally-valid').length,
  autoInvalid: results.filter(r => r.status === 'auto-invalid').length,
  needsReview: results.filter(r => r.status === 'needs-review').length,
  noSpec: results.filter(r => r.status === 'no-spec').length,
  inAliasGroups: results.filter(r => r.aliasGroup).length,
};

console.log();
console.log('='.repeat(80));
console.log('PHASE 1.5 RESULTS');
console.log('='.repeat(80));
console.log();
console.log(`Total items: ${stats.total}`);
console.log(`‚úÖ Auto-valid: ${stats.autoValid} (${((stats.autoValid / stats.total) * 100).toFixed(1)}%)`);
console.log(`‚úÖ Auto-structurally-valid: ${stats.autoStructurallyValid} (${((stats.autoStructurallyValid / stats.total) * 100).toFixed(1)}%)`);
console.log(`‚ùå Auto-invalid: ${stats.autoInvalid} (${((stats.autoInvalid / stats.total) * 100).toFixed(1)}%)`);
console.log(`‚ö†Ô∏è  Needs review: ${stats.needsReview} (${((stats.needsReview / stats.total) * 100).toFixed(1)}%)`);
console.log(`üìã No spec: ${stats.noSpec} (${((stats.noSpec / stats.total) * 100).toFixed(1)}%)`);
console.log();
console.log(`üîó In alias groups: ${stats.inAliasGroups} (${((stats.inAliasGroups / stats.total) * 100).toFixed(1)}%)`);
console.log();

const totalAccepted = stats.autoValid + stats.autoStructurallyValid + stats.noSpec;
const manualReviewNeeded = stats.needsReview + stats.autoInvalid;

console.log(`üìä SUMMARY:`);
console.log(`   Automatically accepted: ${totalAccepted} (${((totalAccepted / stats.total) * 100).toFixed(1)}%)`);
console.log(`   Manual review required: ${manualReviewNeeded} (${((manualReviewNeeded / stats.total) * 100).toFixed(1)}%)`);
console.log();
console.log(`üéØ Manual review reduced from 94 ‚Üí ${manualReviewNeeded} items`);
console.log(`   (${Math.round((1 - manualReviewNeeded / 94) * 100)}% reduction)`);
console.log();

// Show items needing review
const reviewItems = results.filter(r => r.status === 'needs-review' || r.status === 'auto-invalid');

if (reviewItems.length > 0) {
  console.log('='.repeat(80));
  console.log(`ITEMS REQUIRING MANUAL REVIEW (${reviewItems.length})`);
  console.log('='.repeat(80));
  console.log();
  
  reviewItems.forEach((item, idx) => {
    console.log(`${idx + 1}. ${item.ingredient}`);
    console.log(`   Product: ${item.productName}`);
    console.log(`   ASIN: ${item.asin}`);
    console.log(`   Status: ${item.status.toUpperCase()}`);
    if (item.aliasGroup) console.log(`   Alias Group: ${item.aliasGroup}`);
    if (item.issues.length > 0) {
      console.log(`   Issues:`);
      item.issues.forEach(issue => console.log(`     - ${issue}`));
    }
    if (item.reasoning) console.log(`   Reasoning: ${item.reasoning}`);
    console.log(`   Notes: ${item.notes}`);
    console.log(`   Link: ${item.link}`);
    console.log();
  });
}

// Generate CSV for manual review
const csvHeader = 'Status,Ingredient,Product Name,ASIN,Confidence,Alias Group,Issues,Notes,Action Needed,Link\n';
const csvRows = reviewItems.map(item => {
  const escapeCsv = (str: string) => `"${str.replace(/"/g, '""')}"`;
  return [
    item.status.toUpperCase(),
    escapeCsv(item.ingredient),
    escapeCsv(item.productName),
    item.asin,
    item.confidence.toUpperCase(),
    item.aliasGroup || '',
    escapeCsv(item.issues.join('; ')),
    escapeCsv(item.notes),
    item.status === 'auto-invalid' ? 'FIND NEW ASIN' : 'VERIFY',
    item.link,
  ].join(',');
}).join('\n');

const csv = csvHeader + csvRows;
const outputPath = path.join(process.cwd(), 'PHASE_1_5_MANUAL_REVIEW.csv');
fs.writeFileSync(outputPath, csv, 'utf-8');

console.log('='.repeat(80));
console.log('FILES GENERATED');
console.log('='.repeat(80));
console.log();
console.log(`CSV saved to: ${outputPath}`);
console.log();
console.log('='.repeat(80));
</file>

<file path="lib/generator/QuickTest.ts">
/**
 * Phase 1 Smoke Test - Verify critical fixes
 * Tests: S1 (1 primary protein), portion calc (petWeightKg), T1/T2/T3 hard fails
 */

import { RecipeBuilder } from './RecipeBuilder';

console.log('\n=== PHASE 1 SMOKE TEST ===\n');

// Test 1: Dog recipe with actual pet weight
console.log('TEST 1: Dog recipe with petWeightKg (10kg dog)');
const dogConstraints = {
  species: 'dogs' as const,
  lifeStage: 'adult' as const,
  petWeightKg: 10, // PHASE 1.4: Actual pet weight
  healthConcerns: [],
  budgetPerMeal: 4.0,
  targetCalories: undefined,
  allergies: [],
  bannedIngredients: [],
};

let successCount = 0;
let failCount = 0;

for (let i = 0; i < 3; i++) {
  const builder = new RecipeBuilder(dogConstraints, 'standard', 'medium');
  const recipe = builder.generate();

  if (recipe) {
    successCount++;
    console.log(`\n‚úÖ Dog Recipe ${i + 1}:`);
    
    // PHASE 1.2: Verify exactly 1 primary protein (PHASE 1.7: use proteinRole)
    const primaryProteins = recipe.ingredients.filter(ing => ing.ingredient.proteinRole === 'primary');
    console.log(`   Primary proteins: ${primaryProteins.map(p => p.ingredient.name).join(', ')} (count: ${primaryProteins.length})`);
    if (primaryProteins.length !== 1) {
      console.log(`   ‚ùå FAIL: Expected 1 primary protein, got ${primaryProteins.length}`);
    } else {
      console.log(`   ‚úÖ PASS: Exactly 1 primary protein`);
    }
    
    // PHASE 1.4: Check portion calculation uses pet weight
    const totalGrams = recipe.totalGrams;
    console.log(`   Total grams: ${totalGrams} (for 10kg dog)`);
    if (totalGrams < 200 || totalGrams > 1000) {
      console.log(`   ‚ö†Ô∏è  Portion seems off for 10kg dog`);
    }
    
    // Check organ meat percentage
    const organMeatGrams = recipe.ingredients
      .filter(ing =>
        ing.ingredient.feedingRole === 'supplement' &&
        (ing.ingredient.name.toLowerCase().includes('liver') ||
         ing.ingredient.name.toLowerCase().includes('kidney') ||
         ing.ingredient.name.toLowerCase().includes('heart'))
      )
      .reduce((sum, ing) => sum + ing.grams, 0);
    
    const organPercent = (organMeatGrams / recipe.totalGrams) * 100;
    console.log(`   Organ meat: ${organPercent.toFixed(1)}%`);
    if (organPercent > 10) {
      console.log(`   ‚ùå FAIL: Organ meat exceeds 10%`);
    } else {
      console.log(`   ‚úÖ PASS: Organ meat within 10% cap`);
    }
    
    // Check for toxic pairings
    const hasLiver = recipe.ingredients.some(ing => ing.ingredient.name.toLowerCase().includes('liver'));
    const hasSalmon = recipe.ingredients.some(ing => ing.ingredient.name.toLowerCase().includes('salmon'));
    const hasCod = recipe.ingredients.some(ing => ing.ingredient.name.toLowerCase().includes('cod'));
    
    if (hasLiver && (hasSalmon || hasCod)) {
      console.log(`   ‚ùå FAIL: TOXIC PAIRING - Liver + ${hasSalmon ? 'salmon' : 'cod'}`);
    } else {
      console.log(`   ‚úÖ PASS: No toxic pairings`);
    }
  } else {
    failCount++;
    console.log(`\n‚ùå Dog Recipe ${i + 1}: Failed to generate`);
  }
}

// Test 2: Cat recipe (salmon_atlantic should be primary)
console.log('\n\nTEST 2: Cat recipe (salmon_atlantic as primary protein)');
const catConstraints = {
  species: 'cats' as const,
  lifeStage: 'adult' as const,
  petWeightKg: 4, // PHASE 1.4: Typical cat weight
  healthConcerns: [],
  budgetPerMeal: 3.0,
  targetCalories: undefined,
  allergies: [],
  bannedIngredients: [],
};

for (let i = 0; i < 2; i++) {
  const builder = new RecipeBuilder(catConstraints, 'standard', 'medium');
  const recipe = builder.generate();

  if (recipe) {
    successCount++;
    console.log(`\n‚úÖ Cat Recipe ${i + 1}:`);
    
    const primaryProteins = recipe.ingredients.filter(ing => ing.ingredient.feedingRole === 'staple');
    console.log(`   Primary protein: ${primaryProteins.map(p => p.ingredient.name).join(', ')}`);
    if (primaryProteins.length !== 1) {
      console.log(`   ‚ùå FAIL: Expected 1 primary protein, got ${primaryProteins.length}`);
    } else {
      console.log(`   ‚úÖ PASS: Exactly 1 primary protein`);
    }
    
    console.log(`   Total grams: ${recipe.totalGrams} (for 4kg cat)`);
  } else {
    failCount++;
    console.log(`\n‚ùå Cat Recipe ${i + 1}: Failed to generate`);
  }
}

console.log(`\n\n=== PHASE 1 SMOKE TEST RESULTS ===`);
console.log(`‚úÖ Passed: ${successCount}`);
console.log(`‚ùå Failed: ${failCount}`);
console.log(`Total: ${successCount + failCount}\n`);
</file>

<file path="lib/generator/RecipeBuilder.integration.test.ts">
/**
 * RECIPE BUILDER INTEGRATION TESTS
 * Tests biological invariants using real recipe generation
 * 
 * Run with: npm test -- RecipeBuilder.integration.test.ts
 */

import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';

// ============================================================================
// TEST UTILITIES
// ============================================================================

interface TestResult {
  passed: boolean;
  name: string;
  error?: string;
}

const results: TestResult[] = [];

function assert(condition: boolean, message: string) {
  if (!condition) {
    throw new Error(message);
  }
}

function test(name: string, fn: () => void): TestResult {
  try {
    fn();
    const result = { passed: true, name };
    results.push(result);
    console.log(`  ‚úÖ ${name}`);
    return result;
  } catch (error) {
    const result = {
      passed: false,
      name,
      error: error instanceof Error ? error.message : String(error),
    };
    results.push(result);
    console.log(`  ‚ùå ${name}: ${result.error}`);
    return result;
  }
}

// ============================================================================
// 1. GOLDEN-PATH TESTS
// ============================================================================

console.log('\nüìã Golden-Path Tests (System Succeeds)');

test('Perfect dog: generates recipe with good composition', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  const builder = new RecipeBuilder(constraints, 'standard', 'medium');
  const recipe = builder.generate();

  assert(recipe !== null, 'Recipe should be generated');
  assert(recipe!.debugInfo?.topScores[0].score >= 60, 'Top score should be ‚â•60');

  // Check composition (most important)
  const hasProtein = recipe!.ingredients.some(ing => ing.ingredient.category === 'protein');
  const hasCarb = recipe!.ingredients.some(ing => ing.ingredient.category === 'carb');
  const hasVeg = recipe!.ingredients.some(ing => ing.ingredient.category === 'vegetable');

  assert(hasProtein && hasCarb && hasVeg, 'Should have protein + carb + veg');
});

test('Perfect cat: high protein, low carb, ‚â•90 score', () => {
  const constraints: GenerationConstraints = {
    species: 'cats',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 5.0,
    targetCalories: 400,
    allergies: [],
    bannedIngredients: [],
  };

  const builder = new RecipeBuilder(constraints, 'standard', 'medium');
  const recipe = builder.generate();

  assert(recipe !== null, 'Recipe should be generated');
  assert(recipe!.debugInfo?.topScores[0].score >= 90, 'Top score should be ‚â•90');

  // Cats should have high protein, low/no carb
  const proteinCount = recipe!.ingredients.filter(
    ing => ing.ingredient.category === 'protein'
  ).length;
  const carbCount = recipe!.ingredients.filter(ing => ing.ingredient.category === 'carb').length;

  assert(proteinCount >= 1, 'Should have at least 1 protein');
  assert(carbCount <= 1, 'Cats should have 0-1 carbs');
});

// ============================================================================
// 2. REJECTION TESTS (Safety Gates)
// ============================================================================

console.log('\nüìã Rejection Tests (Safety Gates Work)');

test('Multiple primary proteins rejected (S1 rule)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  // Generate 20 recipes and verify none have multiple primary proteins
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const primaryProteins = recipe.ingredients.filter(
        ing => ing.ingredient.feedingRole === 'staple' && ing.ingredient.category === 'protein'
      );
      assert(primaryProteins.length === 1, `Recipe ${i}: should have exactly 1 primary protein`);
    }
  }
});

test('Missing carb for dog rejected (S4 rule)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  // Generate 20 recipes and verify all have carbs
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const hasCarb = recipe.ingredients.some(ing => ing.ingredient.category === 'carb');
      assert(hasCarb, `Recipe ${i}: dogs require carbs`);
    }
  }
});

// ============================================================================
// 3. NUTRIENT CEILING TESTS
// ============================================================================

console.log('\nüìã Nutrient Ceiling Tests');

test('Vitamin A ceiling enforced (T1 rule)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  // Generate 20 recipes and verify vitamin A doesn't exceed ceiling (5000 IU for dogs)
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const totalVitaminA = recipe.ingredients.reduce(
        (sum, ing) => sum + (ing.ingredient.composition.vitaminA || 0),
        0
      );
      assert(
        totalVitaminA <= 5000,
        `Recipe ${i}: vitamin A ${totalVitaminA} exceeds dog ceiling of 5000 IU`
      );
    }
  }
});

test('Calcium-phosphorus ratio in range (T6 rule)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  // Dog Ca:P range is 1.2-2.0
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const totalCalcium = recipe.ingredients.reduce(
        (sum, ing) => sum + (ing.ingredient.composition.calcium || 0),
        0
      );
      const totalPhosphorus = recipe.ingredients.reduce(
        (sum, ing) => sum + (ing.ingredient.composition.phosphorus || 0),
        0
      );

      if (totalPhosphorus > 0) {
        const ratio = totalCalcium / totalPhosphorus;
        assert(
          ratio >= 1.2 && ratio <= 2.0,
          `Recipe ${i}: Ca:P ratio ${ratio.toFixed(2)} outside dog range 1.2-2.0`
        );
      }
    }
  }
});

// ============================================================================
// 4. ALLERGEN & DERIVATIVE TESTS
// ============================================================================

console.log('\nüìã Allergen & Derivative Tests');

test('Allergen derivatives rejected (T5 rule)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: ['chicken'],
    bannedIngredients: [],
  };

  // Generate 20 recipes and verify no chicken or chicken derivatives
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const hasChickenDerivative = recipe.ingredients.some(ing =>
        ing.ingredient.id.toLowerCase().includes('chicken') ||
        ing.ingredient.name.toLowerCase().includes('chicken')
      );
      assert(!hasChickenDerivative, `Recipe ${i}: should not contain chicken derivatives`);
    }
  }
});

// ============================================================================
// 5. DISTRIBUTION TESTS (Catch Clustering)
// ============================================================================

console.log('\nüìã Distribution Tests (No Clustering)');

test('Score spread: 50 recipes have variance', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  const scores: number[] = [];
  for (let i = 0; i < 50; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();
    if (recipe?.debugInfo?.topScores[0]) {
      scores.push(recipe.debugInfo.topScores[0].score);
    }
  }

  assert(scores.length >= 40, 'Should generate at least 40 recipes');

  const max = Math.max(...scores);
  const min = Math.min(...scores);
  const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
  const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
  const stdDev = Math.sqrt(variance);

  assert(max >= 95, `Max score should be ‚â•95 (got ${max})`);
  assert(min >= 60, `Min score should be ‚â•60 (got ${min})`);
  assert(stdDev > 6, `Std dev should be >6 (got ${stdDev.toFixed(2)})`);

  // Check for clustering (no more than 20% identical scores)
  const scoreFreq = new Map<number, number>();
  scores.forEach(s => scoreFreq.set(s, (scoreFreq.get(s) || 0) + 1));
  const maxFreq = Math.max(...scoreFreq.values());
  const clusterPercent = (maxFreq / scores.length) * 100;

  assert(
    clusterPercent <= 20,
    `No single score should appear >20% (got ${clusterPercent.toFixed(1)}%)`
  );
});

// ============================================================================
// 6. REGRESSION TESTS (Never Break Again)
// ============================================================================

console.log('\nüìã Regression Tests (Biological Invariants)');

test('Salmon + liver never appears', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 50; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const ingredients = recipe.ingredients.map(ing => ing.ingredient.name.toLowerCase());
      const hasSalmon = ingredients.some(ing => ing.includes('salmon'));
      const hasLiver = ingredients.some(ing => ing.includes('liver'));

      assert(
        !(hasSalmon && hasLiver),
        `Salmon + liver should never appear together (found in recipe ${i})`
      );
    }
  }
});

test('Organ meat never exceeds 10%', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 50; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const organMeatGrams = recipe.ingredients
        .filter(ing =>
          ing.ingredient.name.toLowerCase().includes('liver') ||
          ing.ingredient.name.toLowerCase().includes('kidney') ||
          ing.ingredient.name.toLowerCase().includes('heart')
        )
        .reduce((sum, ing) => sum + ing.grams, 0);

      const organPercent = (organMeatGrams / recipe.totalGrams) * 100;
      assert(organPercent <= 10, `Organ meat should be ‚â§10% (got ${organPercent.toFixed(1)}%)`);
    }
  }
});

test('Exactly one primary protein per recipe', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 50; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const primaryProteins = recipe.ingredients.filter(
        ing => ing.ingredient.feedingRole === 'staple' && ing.ingredient.category === 'protein'
      );

      assert(
        primaryProteins.length === 1,
        `Should have exactly 1 primary protein (got ${primaryProteins.length})`
      );
    }
  }
});

// ============================================================================
// 7. PROPERTY-BASED FUZZER (1000 Random Recipes)
// ============================================================================

console.log('\nüìã Property-Based Fuzzer (1000 Random Recipes)');

test('No unsafe recipe reaches scoring (all 1000 pass validation)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  let unsafeCount = 0;
  for (let i = 0; i < 1000; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe?.debugInfo?.validation && !recipe.debugInfo.validation.isValid) {
      unsafeCount++;
    }
  }

  assert(unsafeCount === 0, `No recipes should fail validation (${unsafeCount} failed out of 1000)`);
});

test('No nutrient ceiling violations survive (all 1000 pass T rules)', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  let violationCount = 0;
  for (let i = 0; i < 1000; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe?.debugInfo?.validation?.failedRules.some(r => r.startsWith('T'))) {
      violationCount++;
    }
  }

  assert(
    violationCount === 0,
    `No nutrient ceiling violations should survive (${violationCount} found out of 1000)`
  );
});

// ============================================================================
// TEST SUMMARY
// ============================================================================

console.log('\n' + '='.repeat(70));
console.log('TEST SUMMARY');
console.log('='.repeat(70));

const passed = results.filter(r => r.passed).length;
const failed = results.filter(r => !r.passed).length;

console.log(`\n‚úÖ Passed: ${passed}`);
console.log(`‚ùå Failed: ${failed}`);
console.log(`üìä Total: ${results.length}`);

if (failed > 0) {
  console.log('\n' + '='.repeat(70));
  console.log('FAILURES');
  console.log('='.repeat(70));
  results
    .filter(r => !r.passed)
    .forEach(r => {
      console.log(`\n‚ùå ${r.name}`);
      console.log(`   ${r.error}`);
    });
  process.exit(1);
} else {
  console.log('\nüéâ All tests passed!');
  process.exit(0);
}
</file>

<file path="lib/generator/RecipeBuilder.smoke.test.ts">
/**
 * RECIPE BUILDER SMOKE TESTS
 * Minimal viable tests that prove core fixes work with actual ingredient data
 * 
 * Focus: Verify the system generates diverse, safe recipes
 * Not: Perfect nutrient ratios (ingredient data is incomplete)
 */

import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';

let passed = 0;
let failed = 0;

function test(name: string, fn: () => void) {
  try {
    fn();
    console.log(`‚úÖ ${name}`);
    passed++;
  } catch (error) {
    console.log(`‚ùå ${name}`);
    console.log(`   ${error instanceof Error ? error.message : String(error)}`);
    failed++;
  }
}

function assert(condition: boolean, message: string) {
  if (!condition) throw new Error(message);
}

// ============================================================================
// CORE FIXES VERIFICATION
// ============================================================================

console.log('\nüìã CORE FIXES VERIFICATION\n');

test('Weighted random selection: 10 recipes are different', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  const recipes = [];
  for (let i = 0; i < 10; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();
    if (recipe) {
      recipes.push(recipe.ingredients.map(ing => ing.ingredient.id).sort().join(','));
    }
  }

  const uniqueRecipes = new Set(recipes);
  assert(
    uniqueRecipes.size >= 5,
    `Should have at least 5 different recipes (got ${uniqueRecipes.size})`
  );
});

test('Organ meat never exceeds 10%', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const organMeatGrams = recipe.ingredients
        .filter(ing =>
          ing.ingredient.name.toLowerCase().includes('liver') ||
          ing.ingredient.name.toLowerCase().includes('kidney') ||
          ing.ingredient.name.toLowerCase().includes('heart')
        )
        .reduce((sum, ing) => sum + ing.grams, 0);

      const organPercent = (organMeatGrams / recipe.totalGrams) * 100;
      assert(organPercent <= 10, `Organ meat ${organPercent.toFixed(1)}% exceeds 10%`);
    }
  }
});

test('Salmon + liver never co-occur', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 30; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const ingredients = recipe.ingredients.map(ing => ing.ingredient.name.toLowerCase());
      const hasSalmon = ingredients.some(ing => ing.includes('salmon'));
      const hasLiver = ingredients.some(ing => ing.includes('liver'));

      assert(!(hasSalmon && hasLiver), `Salmon + liver found together in recipe ${i}`);
    }
  }
});

test('Dogs always get carbs', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const hasCarb = recipe.ingredients.some(ing => ing.ingredient.category === 'carb');
      assert(hasCarb, `Recipe ${i} missing carbs`);
    }
  }
});

test('Cats can be carb-free', () => {
  const constraints: GenerationConstraints = {
    species: 'cats',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 5.0,
    targetCalories: 400,
    allergies: [],
    bannedIngredients: [],
  };

  let carbFreeCount = 0;
  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const hasCarb = recipe.ingredients.some(ing => ing.ingredient.category === 'carb');
      if (!hasCarb) carbFreeCount++;
    }
  }

  assert(carbFreeCount > 0, 'At least some cat recipes should be carb-free');
});

test('Allergen filtering works', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: ['chicken'],
    bannedIngredients: [],
  };

  for (let i = 0; i < 20; i++) {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = builder.generate();

    if (recipe) {
      const hasChicken = recipe.ingredients.some(ing =>
        ing.ingredient.id.toLowerCase().includes('chicken') ||
        ing.ingredient.name.toLowerCase().includes('chicken')
      );
      assert(!hasChicken, `Recipe ${i} contains chicken despite allergy`);
    }
  }
});

test('Diversity modes produce different results', () => {
  const constraints: GenerationConstraints = {
    species: 'dogs',
    lifeStage: 'adult',
    healthConcerns: [],
    budgetPerMeal: 4.0,
    targetCalories: 500,
    allergies: [],
    bannedIngredients: [],
  };

  const modes = ['high', 'medium', 'low', 'none'] as const;
  const results: Record<string, string[]> = {};

  for (const mode of modes) {
    results[mode] = [];
    for (let i = 0; i < 5; i++) {
      const builder = new RecipeBuilder(constraints, 'standard', mode);
      const recipe = builder.generate();
      if (recipe) {
        results[mode].push(recipe.ingredients.map(ing => ing.ingredient.id).sort().join(','));
      }
    }
  }

  // Each mode should produce some variation
  for (const mode of modes) {
    const unique = new Set(results[mode]).size;
    assert(unique >= 1, `Mode ${mode} should produce at least 1 unique recipe`);
  }
});

// ============================================================================
// SUMMARY
// ============================================================================

console.log('\n' + '='.repeat(70));
console.log('TEST SUMMARY');
console.log('='.repeat(70));
console.log(`‚úÖ Passed: ${passed}`);
console.log(`‚ùå Failed: ${failed}`);
console.log(`üìä Total: ${passed + failed}\n`);

if (failed === 0) {
  console.log('üéâ All smoke tests passed!');
  console.log('\nCore fixes verified:');
  console.log('  ‚úì Weighted random selection (recipes are diverse)');
  console.log('  ‚úì Organ meat cap (‚â§10%)');
  console.log('  ‚úì Salmon + liver prevention');
  console.log('  ‚úì Carb requirement for dogs');
  console.log('  ‚úì Carb-free allowed for cats');
  console.log('  ‚úì Allergen filtering');
  console.log('  ‚úì Diversity modes working');
  process.exit(0);
} else {
  console.log(`\n‚ö†Ô∏è  ${failed} test(s) failed`);
  process.exit(1);
}
</file>

<file path="lib/generator/RecipeBuilder.test.ts">
/**
 * RECIPE BUILDER TEST SUITE
 * Tests biological invariants, not scoring hacks
 * 
 * Categories:
 * 1. Golden-Path Tests (system succeeds on perfect inputs)
 * 2. Rejection Tests (safety gates work)
 * 3. Nutrient Ceiling Tests (micronutrient caps enforced)
 * 4. Allergen & Derivative Tests (cross-source safety)
 * 5. Distribution Tests (no clustering/repetition)
 * 6. Regression Tests (never break again)
 * 7. Property-Based Fuzzer (1000 random recipes)
 */

import { RecipeBuilder, type GenerationConstraints } from './RecipeBuilder';
import { validateRecipeComprehensive } from './RecipeConstraintRules';
import type { Ingredient } from '@/lib/data/ingredients';

// ============================================================================
// TEST UTILITIES
// ============================================================================

interface TestResult {
  passed: boolean;
  name: string;
  error?: string;
  details?: Record<string, any>;
}

const results: TestResult[] = [];

function assert(condition: boolean, message: string) {
  if (!condition) {
    throw new Error(message);
  }
}

function test(name: string, fn: () => void): TestResult {
  try {
    fn();
    const result = { passed: true, name };
    results.push(result);
    return result;
  } catch (error) {
    const result = {
      passed: false,
      name,
      error: error instanceof Error ? error.message : String(error),
    };
    results.push(result);
    return result;
  }
}

function describe(category: string, tests: Array<() => void>) {
  console.log(`\nüìã ${category}`);
  tests.forEach(t => t());
}

// ============================================================================
// 1. GOLDEN-PATH TESTS
// ============================================================================

describe('Golden-Path Tests (System Succeeds)', [
  () => {
    test('Perfect dog: scores ‚â•95, safe composition', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      const builder = new RecipeBuilder(constraints, 'standard', 'medium');
      const recipe = builder.generate();

      assert(recipe !== null, 'Recipe should be generated');
      assert(recipe!.debugInfo?.topScores[0].score >= 95, 'Top score should be ‚â•95');
      assert(recipe!.debugInfo?.validation?.isValid, 'Recipe should pass validation');

      // Check composition
      const hasProtein = recipe!.ingredients.some(
        ing => ing.ingredient.category === 'protein'
      );
      const hasCarb = recipe!.ingredients.some(ing => ing.ingredient.category === 'carb');
      const hasVeg = recipe!.ingredients.some(ing => ing.ingredient.category === 'vegetable');

      assert(hasProtein && hasCarb && hasVeg, 'Should have protein + carb + veg');
    });
  },

  () => {
    test('Perfect cat: high protein, low carb, ‚â•90 score', () => {
      const constraints: GenerationConstraints = {
        species: 'cats',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 5.0,
        targetCalories: 400,
        allergies: [],
        bannedIngredients: [],
      };

      const builder = new RecipeBuilder(constraints, 'standard', 'medium');
      const recipe = builder.generate();

      assert(recipe !== null, 'Recipe should be generated');
      assert(recipe!.debugInfo?.topScores[0].score >= 90, 'Top score should be ‚â•90');

      // Cats should have high protein, low/no carb
      const proteinCount = recipe!.ingredients.filter(
        ing => ing.ingredient.category === 'protein'
      ).length;
      const carbCount = recipe!.ingredients.filter(ing => ing.ingredient.category === 'carb')
        .length;

      assert(proteinCount >= 1, 'Should have at least 1 protein');
      assert(carbCount <= 1, 'Cats should have 0-1 carbs');
    });
  },
]);

// ============================================================================
// 2. REJECTION TESTS (Safety Gates)
// ============================================================================

describe('Rejection Tests (Safety Gates Work)', [
  () => {
    test('Organ overdose rejected: salmon + beef liver', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      // Simulate selecting salmon + beef liver
      const mockIngredients: Ingredient[] = [
        {
          id: 'salmon',
          name: 'salmon',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 25, fat: 13, kcal: 208, calcium: 12, phosphorus: 200 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 8.0,
        },
        {
          id: 'beef_liver',
          name: 'beef_liver',
          category: 'protein',
          feedingRole: 'supplement',
          composition: { protein: 20, fat: 3, kcal: 135, calcium: 6, phosphorus: 387, vitaminA: 30000 },
          speciesCompatibility: { dog: 'ok', cat: 'caution', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 3.0,
        },
      ];

      const validation = validateRecipeComprehensive(
        mockIngredients,
        'dogs',
        'adult',
        4.0,
        []
      );

      assert(!validation.isValid, 'Should reject organ overdose');
      assert(
        validation.failedRules.includes('T1') || validation.failedRules.includes('S2'),
        'Should fail vitamin A or organ meat rule'
      );
    });
  },

  () => {
    test('Multiple primary proteins rejected', () => {
      const mockIngredients: Ingredient[] = [
        {
          id: 'chicken',
          name: 'chicken_breast',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 31, fat: 3, kcal: 165, calcium: 11, phosphorus: 196 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 3.0,
        },
        {
          id: 'salmon',
          name: 'salmon',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 25, fat: 13, kcal: 208, calcium: 12, phosphorus: 200 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 8.0,
        },
      ];

      const validation = validateRecipeComprehensive(
        mockIngredients,
        'dogs',
        'adult',
        4.0,
        []
      );

      assert(!validation.isValid, 'Should reject multiple primary proteins');
      assert(validation.failedRules.includes('S1'), 'Should fail S1 rule');
    });
  },

  () => {
    test('Missing carb for dog rejected', () => {
      const mockIngredients: Ingredient[] = [
        {
          id: 'beef',
          name: 'beef',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 26, fat: 15, kcal: 250, calcium: 10, phosphorus: 180 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 5.0,
        },
        {
          id: 'carrots',
          name: 'carrots',
          category: 'vegetable',
          feedingRole: 'staple',
          composition: { protein: 0.9, fat: 0.2, kcal: 41, calcium: 33, phosphorus: 35 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
          pricePerLb: 0.5,
        },
        {
          id: 'fish_oil',
          name: 'fish_oil',
          category: 'fat',
          feedingRole: 'supplement',
          composition: { protein: 0, fat: 100, kcal: 902, calcium: 0, phosphorus: 0 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 15.0,
        },
      ];

      const validation = validateRecipeComprehensive(
        mockIngredients,
        'dogs',
        'adult',
        4.0,
        []
      );

      assert(!validation.isValid, 'Should reject carb-free dog recipe');
      assert(validation.failedRules.includes('S4'), 'Should fail S4 rule');
    });
  },
]);

// ============================================================================
// 3. NUTRIENT CEILING TESTS
// ============================================================================

describe('Nutrient Ceiling Tests', [
  () => {
    test('Vitamin A ceiling enforced (dog)', () => {
      // Liver has ~30,000 IU per 100g
      // Dog ceiling is 5,000 IU
      // 20% liver would exceed ceiling
      const mockIngredients: Ingredient[] = [
        {
          id: 'chicken',
          name: 'chicken_breast',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 31, fat: 3, kcal: 165, calcium: 11, phosphorus: 196, vitaminA: 0 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 3.0,
        },
        {
          id: 'beef_liver',
          name: 'beef_liver',
          category: 'protein',
          feedingRole: 'supplement',
          composition: { protein: 20, fat: 3, kcal: 135, calcium: 6, phosphorus: 387, vitaminA: 30000 },
          speciesCompatibility: { dog: 'ok', cat: 'caution', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 3.0,
        },
        {
          id: 'rice',
          name: 'rice',
          category: 'carb',
          feedingRole: 'staple',
          composition: { protein: 2.7, fat: 0.3, kcal: 130, calcium: 10, phosphorus: 68 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'ok', reptile: 'ok', 'pocket-pet': 'ok' },
          pricePerLb: 0.5,
        },
      ];

      const validation = validateRecipeComprehensive(
        mockIngredients,
        'dogs',
        'adult',
        4.0,
        []
      );

      assert(!validation.isValid, 'Should reject vitamin A overload');
      assert(validation.failedRules.includes('T1'), 'Should fail T1 rule');
    });
  },
]);

// ============================================================================
// 4. ALLERGEN & DERIVATIVE TESTS
// ============================================================================

describe('Allergen & Derivative Tests', [
  () => {
    test('Chicken fat rejected for chicken-allergic dog', () => {
      const mockIngredients: Ingredient[] = [
        {
          id: 'beef',
          name: 'beef',
          category: 'protein',
          feedingRole: 'staple',
          composition: { protein: 26, fat: 15, kcal: 250, calcium: 10, phosphorus: 180 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 5.0,
        },
        {
          id: 'chicken_fat',
          name: 'chicken_fat',
          category: 'fat',
          feedingRole: 'supplement',
          composition: { protein: 0, fat: 100, kcal: 884, calcium: 0, phosphorus: 0 },
          speciesCompatibility: { dog: 'ok', cat: 'ok', bird: 'limit', reptile: 'limit', 'pocket-pet': 'avoid' },
          pricePerLb: 2.0,
        },
      ];

      const validation = validateRecipeComprehensive(
        mockIngredients,
        'dogs',
        'adult',
        4.0,
        ['chicken'] // Pet allergic to chicken
      );

      assert(!validation.isValid, 'Should reject chicken derivative for chicken-allergic pet');
      assert(validation.failedRules.includes('T5'), 'Should fail T5 rule');
    });
  },
]);

// ============================================================================
// 5. DISTRIBUTION TESTS (Catch Clustering)
// ============================================================================

describe('Distribution Tests (No Clustering)', [
  () => {
    test('Score spread: 50 recipes have variance', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      const scores: number[] = [];
      for (let i = 0; i < 50; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();
        if (recipe?.debugInfo?.topScores[0]) {
          scores.push(recipe.debugInfo.topScores[0].score);
        }
      }

      assert(scores.length >= 40, 'Should generate at least 40 recipes');

      const max = Math.max(...scores);
      const min = Math.min(...scores);
      const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
      const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
      const stdDev = Math.sqrt(variance);

      assert(max >= 95, `Max score should be ‚â•95 (got ${max})`);
      assert(min >= 60, `Min score should be ‚â•60 (got ${min})`);
      assert(stdDev > 6, `Std dev should be >6 (got ${stdDev.toFixed(2)})`);

      // Check for clustering (no more than 20% identical scores)
      const scoreFreq = new Map<number, number>();
      scores.forEach(s => scoreFreq.set(s, (scoreFreq.get(s) || 0) + 1));
      const maxFreq = Math.max(...scoreFreq.values());
      const clusterPercent = (maxFreq / scores.length) * 100;

      assert(
        clusterPercent <= 20,
        `No single score should appear >20% (got ${clusterPercent.toFixed(1)}%)`
      );
    });
  },
]);

// ============================================================================
// 6. REGRESSION TESTS (Never Break Again)
// ============================================================================

describe('Regression Tests (Biological Invariants)', [
  () => {
    test('Salmon + liver never appears', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      for (let i = 0; i < 20; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe) {
          const ingredients = recipe.ingredients.map(ing => ing.ingredient.name.toLowerCase());
          const hasSalmon = ingredients.some(ing => ing.includes('salmon'));
          const hasLiver = ingredients.some(ing => ing.includes('liver'));

          assert(
            !(hasSalmon && hasLiver),
            `Salmon + liver should never appear together (found in recipe ${i})`
          );
        }
      }
    });
  },

  () => {
    test('Organ meat never exceeds 10%', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      for (let i = 0; i < 20; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe) {
          const organMeatGrams = recipe.ingredients
            .filter(ing =>
              ing.ingredient.name.toLowerCase().includes('liver') ||
              ing.ingredient.name.toLowerCase().includes('kidney') ||
              ing.ingredient.name.toLowerCase().includes('heart')
            )
            .reduce((sum, ing) => sum + ing.grams, 0);

          const organPercent = (organMeatGrams / recipe.totalGrams) * 100;
          assert(organPercent <= 10, `Organ meat should be ‚â§10% (got ${organPercent.toFixed(1)}%)`);
        }
      }
    });
  },

  () => {
    test('Exactly one primary protein per recipe', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      for (let i = 0; i < 20; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe) {
          const primaryProteins = recipe.ingredients.filter(
            ing => ing.ingredient.feedingRole === 'staple' && ing.ingredient.category === 'protein'
          );

          assert(
            primaryProteins.length === 1,
            `Should have exactly 1 primary protein (got ${primaryProteins.length})`
          );
        }
      }
    });
  },
]);

// ============================================================================
// 7. PROPERTY-BASED FUZZER (1000 Random Recipes)
// ============================================================================

describe('Property-Based Fuzzer (1000 Random Recipes)', [
  () => {
    test('No unsafe recipe reaches scoring', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      let unsafeCount = 0;
      for (let i = 0; i < 1000; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe?.debugInfo?.validation && !recipe.debugInfo.validation.isValid) {
          unsafeCount++;
        }
      }

      assert(
        unsafeCount === 0,
        `No recipes should fail validation (${unsafeCount} failed out of 1000)`
      );
    });
  },

  () => {
    test('No nutrient ceiling violations survive', () => {
      const constraints: GenerationConstraints = {
        species: 'dogs',
        lifeStage: 'adult',
        healthConcerns: [],
        budgetPerMeal: 4.0,
        targetCalories: 500,
        allergies: [],
        bannedIngredients: [],
      };

      let violationCount = 0;
      for (let i = 0; i < 1000; i++) {
        const builder = new RecipeBuilder(constraints, 'standard', 'medium');
        const recipe = builder.generate();

        if (recipe?.debugInfo?.validation?.failedRules.some(r => r.startsWith('T'))) {
          violationCount++;
        }
      }

      assert(
        violationCount === 0,
        `No nutrient ceiling violations should survive (${violationCount} found out of 1000)`
      );
    });
  },
]);

// ============================================================================
// TEST SUMMARY
// ============================================================================

export function runAllTests() {
  console.log('\n' + '='.repeat(70));
  console.log('RECIPE BUILDER TEST SUITE');
  console.log('='.repeat(70));

  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;

  console.log(`\n‚úÖ Passed: ${passed}`);
  console.log(`‚ùå Failed: ${failed}`);
  console.log(`üìä Total: ${results.length}`);

  if (failed > 0) {
    console.log('\n' + '='.repeat(70));
    console.log('FAILURES');
    console.log('='.repeat(70));
    results
      .filter(r => !r.passed)
      .forEach(r => {
        console.log(`\n‚ùå ${r.name}`);
        console.log(`   Error: ${r.error}`);
      });
  }

  return { passed, failed, total: results.length };
}

// Export for testing
export { test, describe, assert };
</file>

<file path="lib/generator/RecipeBuilder.ts">
/**
 * ENHANCED RECIPE BUILDER
 * Adds health-aware ingredient selection + palatability
 * 
 * Key improvements:
 * 1. Health concerns drive ingredient selection (40% weight)
 * 2. Contraindications filtered as hard constraints
 * 3. Palatability built into scoring (30% weight)
 * 4. Species-specific taste preferences
 * 5. Debug info for transparency
 */

import type { Species } from '@/lib/data/ingredients';
import { INGREDIENTS, getIngredientsForSpecies, type Ingredient, type IngredientCategory } from '@/lib/data/ingredients';

/**
 * Normalize ingredient category strings to canonical values.
 * Handles variations like 'fish', 'seafood', 'meat', 'poultry' ‚Üí 'protein'
 */
function canonicalCategory(cat: any): IngredientCategory | 'unknown' {
  const c = String(cat ?? '').toLowerCase().trim();

  // PROTEIN family (fish, meat, poultry, seafood, eggs)
  if (
    c === 'protein' ||
    c.includes('protein') ||
    c.includes('meat') ||
    c.includes('poultry') ||
    c.includes('fish') ||
    c.includes('seafood') ||
    c.includes('egg')
  ) return 'protein';

  // VEGETABLE family
  if (c === 'vegetable' || c.includes('veg')) return 'vegetable';

  // FAT family (oils)
  if (c === 'fat' || c.includes('oil')) return 'fat';

  // CARB family (grains, starches)
  if (c === 'carb' || c.includes('grain') || c.includes('starch')) return 'carb';

  // Keep specialized categories as-is
  if (['seed', 'nut', 'fruit', 'insect', 'hay', 'pellet', 'supplement'].includes(c)) {
    return c as IngredientCategory;
  }

  return 'unknown';
}
import { getNutritionalStandard } from '@/lib/data/aafco-standards';
import { HEALTH_BENEFIT_MAP, HEALTH_CONTRAINDICATIONS } from '@/lib/data/healthBenefitMap';
import { validateRecipeComprehensive } from './RecipeConstraintRules';
import { shouldPruneCandidateForMicronutrients, getPruningReason } from './CombinatoricsPruning';
import { isFatCompatibleWithProteins, calculatePairingScore, logPairingDecision } from './RecipePMIScoring';
import { applyPriorScoring } from './RecipePriorScoring';
import { filterCandidatesByCommercialPriors, applyCommercialPriorScoring, hasCommercialPriors } from './CommercialPriorEnforcement';

export interface GenerationConstraints {
  species: Species;
  lifeStage: 'puppy' | 'adult' | 'senior';
  petWeightKg?: number; // PHASE 1.3: Actual pet weight for portion calculation
  healthConcerns?: string[];
  budgetPerMeal?: number;
  targetCalories?: number;
  allergies?: string[];
  bannedIngredients?: string[];
  recentIngredients?: string[]; // Track recently used ingredients for variety
}

export interface PortionedIngredient {
  ingredient: Ingredient;
  grams: number;
}

export interface GeneratedRecipeRaw {
  ingredients: PortionedIngredient[];
  totalGrams: number;
  estimatedCost: number;
  micronutrientDataIncomplete?: boolean; // Flag for exotic pets (no AAFCO standards)
  debugInfo?: {
    candidateCount: number;
    topScores: Array<{ name: string; score: number; breakdown: any }>;
    validation?: {
      isValid: boolean;
      failedRules: string[];
      softPenalties: Array<{ ruleId: string; penalty: number; message: string }>;
    };
  };
}

interface ScoredIngredient {
  ingredient: Ingredient;
  totalScore: number;
  breakdown: {
    health: number;
    quality: number;
    nutritional: number;
    diversity?: number;
  };
}

export type DiversityMode = 'high' | 'medium' | 'low' | 'none';

export class RecipeBuilder {
  private constraints: GenerationConstraints;
  private qualityTier: 'premium' | 'standard' | 'budget';
  private diversityMode: DiversityMode;

  // Scoring weights (reflects priority order)
  private weights = {
    health: 0.40,
    nutritional: 0.50,
    quality: 0.10,
  };

  constructor(
    constraints: GenerationConstraints,
    qualityTier: 'premium' | 'standard' | 'budget' = 'standard',
    diversityMode: DiversityMode = 'medium'
  ) {
    this.constraints = constraints;
    this.qualityTier = qualityTier;
    this.diversityMode = diversityMode;
  }

  /**
   * Main generation method
   */
  generate(): GeneratedRecipeRaw | null {
    try {
      console.log(`\n========== RECIPE GENERATION START (${this.constraints.species}) ==========`);
      const maxRetries = 3;
      let attempt = 0;
      const failedIngredients = new Set<string>(); // Track ingredients that failed hard gates

      while (attempt < maxRetries) {
        attempt++;
        console.log(`\n--- Attempt ${attempt}/${maxRetries} ---`);

        // 1. Get candidate ingredients (hard filters)
        let candidates = this.getCandidateIngredients();
        console.log(`[Step 1] Candidates after filters: ${candidates.length}`);
        
        // üî• CRITICAL GUARDRAIL: Block small candidate pools (vetted-only path)
        const MIN_POOL = 200;
        if (this.constraints.species === 'cats' && candidates.length < MIN_POOL) {
          throw new Error(
            `[RecipeBuilder] Candidate pool collapsed to ${candidates.length}. ` +
            `Refusing to generate recipes from small pool (likely vetted-only/products-only path). ` +
            `Minimum required: ${MIN_POOL}`
          );
        }
        
        if (candidates.length === 0) {
          console.warn(`No candidate ingredients found for ${this.constraints.species}`);
          return null;
        }

        // üî• NEW: Exclude ingredients that failed hard gates in previous attempts
        if (failedIngredients.size > 0) {
          candidates = candidates.filter(ing => !failedIngredients.has(ing.name));
          if (candidates.length === 0) {
            console.warn('All candidates excluded due to previous failures');
            return null;
          }
        }

        // 2. Score all candidates
        const scored = this.scoreIngredients(candidates);
        console.log(`[Step 2] Scored ingredients: ${scored.length}`);
        console.log(`[Step 2] Top 5 scores:`, scored.slice(0, 5).map(s => `${s.ingredient.name} (${s.totalScore.toFixed(1)})`));

        // 3. Select best ingredients by category
        const selected = this.selectIngredients(scored);
        console.log(`[Step 3] Selected ingredients: ${selected.length}`);
        console.log(`[Step 3] Ingredients:`, selected.map(i => `${i.name} (${i.category})`));
        if (selected.length === 0) {
          console.warn('No ingredients selected');
          return null;
        }

        // üî• NEW: Prune micronutrient-toxic candidates BEFORE validation
        if (shouldPruneCandidateForMicronutrients(selected)) {
          if (attempt < maxRetries) {
            console.warn(
              `Attempt ${attempt} pruned (micronutrient risk): ${getPruningReason(selected)}`
            );
            continue; // Retry with different random selections
          }
        }

        // 4. Calculate portions
        const portioned = this.calculatePortions(selected);
        console.log(`[Step 4] Portioned ingredients: ${portioned.length}`);
        console.log(`[Step 4] Portions:`, portioned.map(p => `${p.ingredient.name}: ${p.grams}g`));
        if (portioned.length === 0) {
          console.warn('Failed to calculate portions');
          return null;
        }

        // 5. Calculate cost
        const estimatedCost = this.calculateCost(portioned);
        console.log(`[Step 5] Estimated cost: $${estimatedCost.toFixed(2)}`);

        // üî• NEW: Validate recipe composition (comprehensive)
        const comprehensiveValidation = validateRecipeComprehensive(
          selected,
          this.constraints.species,
          this.constraints.lifeStage,
          estimatedCost,
          this.constraints.allergies
        );

        console.log(`[Step 6] Validation result: ${comprehensiveValidation.isValid ? 'PASS' : 'FAIL'}`);
        if (!comprehensiveValidation.isValid) {
          console.warn(`[Step 6] Failed hard gates:`, comprehensiveValidation.failedRules);
          
          // üî• NEW: Track which ingredients to exclude next time
          // If S2 (organ meat) failed, exclude organ meats
          if (comprehensiveValidation.failedRules.includes('S2')) {
            selected.forEach(ing => {
              if (ing.name.toLowerCase().includes('liver') ||
                  ing.name.toLowerCase().includes('kidney') ||
                  ing.name.toLowerCase().includes('heart')) {
                failedIngredients.add(ing.name);
              }
            });
          }
          
          if (attempt < maxRetries) {
            continue; // Retry with different random selections
          }
          // Last attempt failed - do NOT return recipe
          console.error('Could not generate valid recipe after', maxRetries, 'attempts');
          continue; // Skip to next retry (which will exit loop)
        } else {
          console.log(`[Step 6] ‚úÖ Validation passed!`);
          if (comprehensiveValidation.totalPenalty > 0) {
            console.warn(
              `[Step 6] Recipe quality penalties: ${comprehensiveValidation.totalPenalty}`,
              comprehensiveValidation.softGates.map(g => `${g.ruleId}: -${g.penalty}`)
            );
          }
        }

        // üî• PHASE 1: Only return if validation passed
        const species = this.constraints.species;
        const isExoticPet = species === 'birds' || species === 'reptiles' || species === 'pocket-pets';
        
        return {
          ingredients: portioned,
          totalGrams: portioned.reduce((sum, p) => sum + p.grams, 0),
          estimatedCost,
          // Flag exotic pets: micronutrient data incomplete (no AAFCO standards)
          micronutrientDataIncomplete: isExoticPet,
          debugInfo: {
            candidateCount: candidates.length,
            topScores: scored.slice(0, 10).map(s => ({
              name: s.ingredient.name,
              score: Math.round(s.totalScore),
              breakdown: {
                health: Math.round(s.breakdown.health),
                quality: Math.round(s.breakdown.quality),
                nutrition: Math.round(s.breakdown.nutritional),
              },
            })),
            validation: {
              isValid: comprehensiveValidation.isValid,
              failedRules: comprehensiveValidation.failedRules,
              softPenalties: comprehensiveValidation.softGates.map(g => ({
                ruleId: g.ruleId,
                penalty: g.penalty,
                message: g.message,
              })),
            },
          },
        };
      }

      return null;
    } catch (error) {
      console.error('RecipeBuilder.generate() error:', error);
      return null;
    }
  }


  /**
   * STEP 1: HARD FILTERS
   * Get candidate ingredients filtered by species and hard constraints
   */
  private getCandidateIngredients(): Ingredient[] {
    let candidates = getIngredientsForSpecies(this.constraints.species);
    
    // üî• STACK TRACE: Identify source of small pools
    console.log(`[PoolSource] Initial candidates: ${candidates.length}`, {
      species: this.constraints.species,
      source: 'getIngredientsForSpecies'
    });
    if (candidates.length < 200) {
      console.trace('[PoolSource] Small pool detected - trace:');
    }
    
    // üî• INVARIANT: Full pool must be large enough for cats
    if (this.constraints.species === 'cats' && candidates.length < 200) {
      throw new Error(
        `[Invariant] Full ingredient pool too small (${candidates.length}). ` +
        `Registry/provider is wrong. Expected 400+. ` +
        `This means getIngredientsForSpecies is returning a subset (vetted-only? priced-only?).`
      );
    }

    // Apply each filter individually with logging
    candidates = candidates.filter(ing => {
      // Filter 1: Allergies (HARD)
      if (
        this.constraints.allergies?.some(a =>
          ing.name.toLowerCase().includes(a.toLowerCase())
        )
      ) {
        return false;
      }

      // Filter 2: Banned ingredients (HARD)
      if (
        this.constraints.bannedIngredients?.some(b =>
          ing.name.toLowerCase().includes(b.toLowerCase())
        )
      ) {
        return false;
      }

      // Filter 3: Health contraindications (HARD)
      if (this.constraints.healthConcerns?.length) {
        for (const concern of this.constraints.healthConcerns) {
          const contraindicated = HEALTH_CONTRAINDICATIONS[concern] || [];
          const isContraindicated = contraindicated.some(
            contra =>
              ing.name.toLowerCase().includes(contra.toLowerCase()) ||
              ing.id.includes(contra.toLowerCase())
          );
          if (isContraindicated) {
            return false; // Hard exclude
          }
        }
      }

      // Filter 4: Exclude supplements from base recipes (HARD)
      // Supplements should only appear in supplements tab as add-ons
      if (ing.category === 'supplement') {
        return false;
      }

      // Filter 4b: Explicitly exclude fish oils (HARD)
      // Fish oils should only be supplements, not base ingredients
      const lowerName = ing.name.toLowerCase();
      const lowerId = ing.id.toLowerCase();
      if (lowerName.includes('fish oil') || 
          lowerName.includes('salmon oil') || 
          lowerName.includes('anchovy oil') ||
          lowerName.includes('mackerel oil') ||
          lowerName.includes('krill oil') ||
          lowerName.includes('cod liver oil') ||
          lowerName.includes('sardine oil') ||
          lowerName.includes('tuna oil') ||
          lowerName.includes('herring oil') ||
          lowerId.includes('fish_oil') ||
          lowerId.includes('salmon_oil') ||
          lowerId.includes('anchovy_oil') ||
          lowerId.includes('mackerel_oil') ||
          lowerId.includes('krill_oil') ||
          lowerId.includes('cod_liver_oil') ||
          lowerId.includes('sardine_oil') ||
          lowerId.includes('tuna_oil') ||
          lowerId.includes('herring_oil')) {
        console.log(`[FILTER] Excluding fish oil: ${ing.name} (id: ${ing.id})`);
        return false;
      }

      // Filter 5: Budget constraint (SOFT - allow some flex)
      if (this.constraints.budgetPerMeal && ing.pricePerLb) {
        const maxPrice = this.constraints.budgetPerMeal * 3; // Allow 3x for high-value ingredients
        if (ing.pricePerLb > maxPrice) return false;
      }

      return true;
    });
    
    console.log(`[Filters] After all filters: ${candidates.length} candidates`);
    
    // üî• INVARIANT: Check category pools for cats
    if (this.constraints.species === 'cats') {
      const veg = candidates.filter(x => canonicalCategory(x.category) === 'vegetable');
      const fat = candidates.filter(x => canonicalCategory(x.category) === 'fat');
      // Allow all proteins (exotic proteins already filtered out earlier)
      const proteinPool = candidates.filter(x => canonicalCategory(x.category) === 'protein');
      
      console.log(`[CategoryPools] protein=${proteinPool.length}, veg=${veg.length}, fat=${fat.length}`);
      
      if (veg.length < 2 || fat.length < 1 || proteinPool.length < 1) {
        throw new Error(
          `[Invariant] Missing required ingredient categories for cats: ` +
          `protein=${proteinPool.length} (need 1+), veg=${veg.length} (need 2+), fat=${fat.length} (need 1+). ` +
          `Cannot generate valid recipes. Pool size: ${candidates.length}`
        );
      }
    }

    return candidates;
  }

  /**
   * STEP 2: SCORE ALL CANDIDATES
   * Multi-factor scoring: health + quality + nutrition + diversity penalty
   * CRITICAL FIX: For protein category, heavily prioritize protein density
   */
  private scoreIngredients(candidates: Ingredient[]): ScoredIngredient[] {
    const recentIngredients = this.constraints.recentIngredients || [];
    
    return candidates
      .map(ing => {
        const breakdown = {
          health: this.scoreHealth(ing),
          quality: this.scoreQuality(ing),
          nutritional: this.scoreNutritional(ing),
        };

        // CRITICAL FIX: For protein category, use special weights
        // USER REQUIREMENT: Nutrition ALWAYS wins - protein density must dominate
        let weights = this.weights;
        if (canonicalCategory(ing.category) === 'protein') {
          weights = {
            health: 0.20,
            nutritional: 0.75,  // NUTRITION ALWAYS WINS - protein density dominates
            quality: 0.05,      // Minimal influence from quality
          };
        }

        let totalScore =
          breakdown.health * weights.health +
          breakdown.quality * weights.quality +
          breakdown.nutritional * weights.nutritional;

        // Apply diversity penalty for recently used ingredients
        const ingNameLower = ing.name.toLowerCase();
        const timesUsedRecently = recentIngredients.filter(r => r === ingNameLower).length;
        
        if (timesUsedRecently > 0) {
          // Heavy penalty: 50% reduction per recent use
          const diversityPenalty = Math.pow(0.5, timesUsedRecently);
          totalScore *= diversityPenalty;
          
          if (timesUsedRecently >= 2) {
            console.log(`[Diversity] Penalizing ${ing.name}: used ${timesUsedRecently}x recently, score ${totalScore.toFixed(1)} ‚Üí ${(totalScore * diversityPenalty).toFixed(1)}`);
          }
        }

        return { ingredient: ing, totalScore, breakdown };
      })
      .sort((a, b) => b.totalScore - a.totalScore); // Sort by total score descending
  }

  /**
   * HEALTH SCORE (0-100)
   * Does this ingredient help with pet's health concerns?
   */
  private scoreHealth(ing: Ingredient): number {
    if (!this.constraints.healthConcerns?.length) return 50; // Neutral if no concerns

    let score = 0;
    const ingName = ing.name.toLowerCase();

    for (const concern of this.constraints.healthConcerns) {
      const beneficialIngredients = HEALTH_BENEFIT_MAP[concern] || [];

      // Check if this ingredient is explicitly beneficial
      const isBeneficial = beneficialIngredients.some(
        beneficial =>
          ingName.includes(beneficial.toLowerCase()) ||
          beneficial.toLowerCase().includes(ingName)
      );

      if (isBeneficial) {
        score += 35; // +35 per matched health concern (can exceed 100)
      }
    }

    return Math.min(100, score);
  }

  /**
   * QUALITY SCORE (0-100)
   * Ingredient quality rating
   */
  private scoreQuality(ing: Ingredient): number {
    return ing.qualityScore * 10; // Convert 1-10 to 0-100
  }

  /**
   * NUTRITIONAL SCORE (0-100)
   * CRITICAL FIX: Heavily prioritize protein density to meet AAFCO standards
   * Protein is now 60% of nutritional score (was ~30%)
   */
  private scoreNutritional(ing: Ingredient): number {
    const comp = ing.composition;
    let score = 0;

    // PROTEIN DENSITY - Now 70 points max
    // Prioritize actual protein content over omega-3 for protein ingredients
    if (comp.protein) {
      if (comp.protein >= 30) score += 70;        // Chicken breast, turkey breast
      else if (comp.protein >= 25) score += 55;   // Ground turkey, ground chicken, tuna
      else if (comp.protein >= 20) score += 40;   // Salmon, duck
      else if (comp.protein >= 15) score += 25;   // Eggs, some fish
      else if (comp.protein >= 10) score += 12;   // Legumes
      else if (comp.protein >= 5) score += 6;     // Some vegetables
    }

    // Healthy fats (omega-3) - 10 points max (reduced from 20)
    // Omega-3 is good but shouldn't make canned fish dominate every recipe
    if (comp.omega3 && comp.omega3 > 1) score += 10;
    else if (comp.omega3 && comp.omega3 > 0.5) score += 5;

    // Fiber (good for digestion) - 10 points max
    if (comp.fiber && comp.fiber > 5) score += 10;
    else if (comp.fiber && comp.fiber > 2) score += 5;

    // Micronutrients - 10 points max
    if (comp.calcium && comp.calcium > 100) score += 5;
    if (comp.vitaminA && comp.vitaminA > 500) score += 5;

    return Math.min(100, score);
  }

  /**
   * Get required categories for a given species
   */
  private getRequiredCategoriesForSpecies(): IngredientCategory[] {
    const species = this.constraints.species;
    
    switch (species) {
      case 'dogs':
        return ['protein', 'carb', 'vegetable'];
      case 'cats':
        return ['protein', 'vegetable'];
      
      case 'birds':
        // Birds need seeds/nuts as protein, fruits/veggies for vitamins
        return ['seed', 'nut', 'fruit', 'vegetable'];
      
      case 'reptiles':
        // Reptiles need insects as protein, veggies for fiber
        return ['insect', 'vegetable', 'fruit'];
      
      case 'pocket-pets':
        // Pocket-pets need hay as staple, veggies/fruits for variety
        return ['hay', 'vegetable', 'fruit', 'seed'];
      
      default:
        return ['protein', 'carb', 'vegetable'];
    }
  }

  /**
   * Get how many ingredients to select from each category
   * Some categories are more important than others
   */
  private getIngredientCountForCategory(category: IngredientCategory): number {
    const species = this.constraints.species;
    
    // Dogs/Cats
    if (species === 'dogs' || species === 'cats') {
      if (category === 'protein') {
        return 1; // S1: Exactly 1 primary protein (hard gate)
      }
      if (category === 'carb') {
        return species === 'cats' ? 0 : 1; // Cats don't need carbs (obligate carnivores)
      }
      if (category === 'vegetable') {
        return species === 'cats' ? 2 : 1; // Cats get 2 veggies for variety (min 3 ingredients)
      }
      if (category === 'fat') {
        return 1; // 1 fat
      }
      return 1; // Default
    }
    
    // Birds
    if (species === 'birds') {
      if (category === 'seed' || category === 'nut') {
        return 2; // 2 seeds/nuts for variety
      }
      if (category === 'fruit') {
        return 1; // 1 fruit
      }
      if (category === 'vegetable') {
        return 1; // 1 veggie
      }
    }
    
    // Reptiles
    if (species === 'reptiles') {
      if (category === 'insect') {
        return 2; // 2 insects for variety
      }
      if (category === 'vegetable') {
        return 1; // 1 veggie
      }
      if (category === 'fruit') {
        return 1; // 1 fruit (optional)
      }
    }
    
    // Pocket-pets
    if (species === 'pocket-pets') {
      if (category === 'hay') {
        return 1; // 1 hay type (essential)
      }
      if (category === 'vegetable') {
        return 2; // 2 veggies for variety
      }
      if (category === 'fruit') {
        return 1; // 1 fruit (treat)
      }
      if (category === 'seed') {
        return 1; // 1 seed type (optional)
      }
    }
    
    return 1; // Default
  }

  // REMOVED: Hardcoded fat-protein pairing logic
  // Now using PMI-based pairing intelligence from recipePriors.json
  // See RecipePMIScoring.ts for learned pairing logic

  /**
   * STEP 3: SELECT BEST INGREDIENTS
   * Pick ingredients with weighted randomization to ensure diversity
   * üî• FIX: Species-aware ingredient selection
   */
  private selectIngredients(scored: ScoredIngredient[]): Ingredient[] {
    const selected: Ingredient[] = [];
    const categories = this.getRequiredCategoriesForSpecies();

    // üî• PRECONDITION CHECK: For cats, ensure we have all required categories
    if (this.constraints.species === 'cats') {
      const vegPool = scored.filter(s => canonicalCategory(s.ingredient.category) === 'vegetable');
      const fatPool = scored.filter(s => canonicalCategory(s.ingredient.category) === 'fat');
      // Allow all proteins (exotic proteins already filtered out earlier)
      const proteinPool = scored.filter(s => canonicalCategory(s.ingredient.category) === 'protein');
      
      if (vegPool.length < 2 || fatPool.length < 1 || proteinPool.length < 1) {
        throw new Error(
          `[RecipeBuilder] Insufficient pools for cats: ` +
          `protein=${proteinPool.length}, veg=${vegPool.length}, fat=${fatPool.length}. ` +
          `Cannot generate valid recipe without all required categories.`
        );
      }
    }

    // DEBUG: Log what we're looking for
    if (this.constraints.species === 'birds') {
      console.log(`[BIRD DEBUG] Looking for categories: ${categories.join(', ')}`);
      console.log(`[BIRD DEBUG] Total scored ingredients: ${scored.length}`);
    }

    for (const category of categories) {
      let inCategory = scored.filter(s => canonicalCategory(s.ingredient.category) === category);
      
      // CRITICAL: For dogs/cats protein category, all proteins allowed (exotic already filtered)
      // No additional filtering needed here
      
      // üî• COMMERCIAL PRIORS: Filter candidates using learned commercial pairing rules
      if (hasCommercialPriors(this.constraints.species) && selected.length > 0) {
        const selectedIds = selected.map(ing => ing.id);
        const beforeCommercialFilter = inCategory.length;
        
        // Filter out hardBlockPairs (never co-occur in commercial products)
        inCategory = filterCandidatesByCommercialPriors(
          inCategory.map(s => s.ingredient),
          selectedIds,
          this.constraints.species,
          '[Commercial] '
        ).map(ing => {
          // Find the scored ingredient back
          return inCategory.find(s => s.ingredient.id === ing.id)!;
        }).filter(Boolean);
        
        const afterCommercialFilter = inCategory.length;
        if (beforeCommercialFilter !== afterCommercialFilter) {
          console.log(`[Commercial Filter] Removed ${beforeCommercialFilter - afterCommercialFilter} hard-blocked ingredients`);
        }
      }
      
      // üî• PMI-BASED: Filter fats using learned pairing intelligence
      if (category === 'fat') {
        const selectedProteins = selected.filter(ing => canonicalCategory(ing.category) === 'protein');
        if (selectedProteins.length > 0) {
          const beforeFilter = inCategory.length;
          inCategory = inCategory.filter(s => {
            const compat = isFatCompatibleWithProteins(s.ingredient, selectedProteins, this.constraints.species);
            if (!compat.compatible) {
              console.log(`[PMI Filter] ${s.ingredient.name}: ${compat.reason}`);
            }
            return compat.compatible;
          });
          const afterFilter = inCategory.length;
          if (beforeFilter !== afterFilter) {
            console.log(`[PMI Filter] Removed ${beforeFilter - afterFilter} incompatible fats based on learned priors`);
          }
        }
      }
      
      // üî• DEBUG: Log protein pool details for cats
      if (this.constraints.species === 'cats' && category === 'protein') {
        console.log(`[ProteinPool] Total proteins in scored: ${inCategory.length}`);
        console.log(`[ProteinPool] Top 10 proteins:`, inCategory.slice(0, 10).map(s => 
          `${s.ingredient.name} (score: ${s.totalScore.toFixed(1)}, role: ${s.ingredient.proteinRole || 'none'})`
        ));
      }
      
      if (inCategory.length === 0) {
        console.warn(`No ingredients found for category: ${category} (species: ${this.constraints.species})`);
        continue;
      }

      const count = this.getIngredientCountForCategory(category);
      
      // DEBUG: Log selection details for birds
      if (this.constraints.species === 'birds') {
        console.log(`[BIRD DEBUG] Category '${category}': ${inCategory.length} available, selecting ${count}`);
        if (inCategory.length > 0) {
          console.log(`[BIRD DEBUG]   Top 3 in ${category}:`, inCategory.slice(0, 3).map(s => 
            `${s.ingredient.name} (score: ${s.totalScore.toFixed(1)})`
          ));
        }
      }
      
      // Skip if count is 0 (e.g., cats don't need grains)
      if (count === 0) continue;

      // Pick randomly from top N
      for (let i = 0; i < count && inCategory.length > 0; i++) {
        let poolSize: number;
        switch (this.diversityMode) {
          case 'high':
            poolSize = Math.min(8, inCategory.length);
            break;
          case 'medium':
            poolSize = Math.min(5, inCategory.length);
            break;
          case 'low':
            poolSize = Math.min(3, inCategory.length);
            break;
          case 'none':
            poolSize = 1;
            break;
        }

        const randomIndex = this.weightedRandomSelection(inCategory.slice(0, poolSize));
        const selectedIng = inCategory[randomIndex].ingredient;
        selected.push(selectedIng);
        
        // üî• DEBUG: Log what was selected
        if (this.constraints.species === 'cats' && category === 'protein') {
          console.log(`[Selection] Picked protein: ${selectedIng.name} (from pool of ${poolSize})`);
        }
        
        // Remove selected to avoid duplicates
        inCategory.splice(randomIndex, 1);
      }
    }

    if (selected.length === 0) {
      console.error('No ingredients selected for species:', this.constraints.species);
      console.error('Available categories:', categories);
      console.error('Scored ingredients count:', scored.length);
    }

    // CRITICAL: Enforce minimum 3 ingredients for proper meal prep
    // 2-ingredient meals are just "putting ingredients in a bowl", not meal prep
    const MIN_INGREDIENTS = 3;
    if (selected.length < MIN_INGREDIENTS) {
      console.warn(`Only ${selected.length} ingredients selected, need at least ${MIN_INGREDIENTS}`);
      
      // üî• NEVER pad with proteins when vegetables/fats are missing
      // Check what categories we're missing
      const selectedCategories = new Set(selected.map(ing => ing.category));
      const missingCategories = categories.filter(cat => !selectedCategories.has(cat));
      
      if (missingCategories.length > 0) {
        console.error(`Missing required categories: ${missingCategories.join(', ')}`);
        console.error('Cannot pad with random ingredients - aborting recipe generation');
        throw new Error(
          `Recipe generation failed: missing required categories [${missingCategories.join(', ')}]. ` +
          `This indicates the ingredient pool is too small or filtered incorrectly.`
        );
      }
      
      // Only pad if we have all required categories but just need more variety
      const remainingNeeded = MIN_INGREDIENTS - selected.length;
      const alreadySelectedIds = new Set(selected.map(ing => ing.id));
      
      // Get top-scoring ingredients from EXISTING categories only (no proteins if we already have one)
      const availableToAdd = scored
        .filter(s => {
          // Don't add if already selected
          if (alreadySelectedIds.has(s.ingredient.id)) return false;
          
          // For cats: don't add more proteins (we already have 1)
          if (this.constraints.species === 'cats' && canonicalCategory(s.ingredient.category) === 'protein') {
            return false;
          }
          
          // Only add from categories we already have
          return selectedCategories.has(s.ingredient.category);
        })
        .slice(0, remainingNeeded * 3); // Get 3x needed for variety
      
      for (let i = 0; i < remainingNeeded && availableToAdd.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * Math.min(5, availableToAdd.length));
        selected.push(availableToAdd[randomIndex].ingredient);
        availableToAdd.splice(randomIndex, 1);
      }
      
      console.log(`Added ${remainingNeeded} ingredients to reach minimum. Total: ${selected.length}`);
    }

    // DEBUG: Log final selection for birds
    if (this.constraints.species === 'birds') {
      console.log(`[BIRD DEBUG] Final selection: ${selected.length} ingredients`);
      selected.forEach(ing => console.log(`[BIRD DEBUG]   - ${ing.name} (${ing.category})`));
    }

    return selected;
  }

  /**
   * Weighted random selection
   * Higher-scoring ingredients have higher probability of being selected
   */
  private weightedRandomSelection(pool: ScoredIngredient[]): number {
    if (pool.length === 1) return 0;

    // Calculate weights (score^2 gives exponential preference to higher scores)
    const weights = pool.map(s => Math.pow(Math.max(0, s.totalScore), 2));
    const totalWeight = weights.reduce((sum, w) => sum + w, 0);

    if (totalWeight === 0) {
      // Fallback to uniform random if all scores are 0 or negative
      return Math.floor(Math.random() * pool.length);
    }

    // Pick random value in [0, totalWeight)
    let random = Math.random() * totalWeight;

    // Find which ingredient this corresponds to
    for (let i = 0; i < weights.length; i++) {
      random -= weights[i];
      if (random <= 0) return i;
    }

    return pool.length - 1; // Fallback
  }

  /**
   * Calculate portions based on NUTRIENT TARGETS (not category weights)
   * CRITICAL FIX: Calculate protein/fat needs UPFRONT, then allocate portions to meet targets
   * This ensures recipes meet AAFCO standards for all species
   */
  private calculatePortions(ingredients: Ingredient[]): PortionedIngredient[] {
    const petWeightKg = this.constraints.petWeightKg || 5;
    const species = this.constraints.species;
    
    // Step 1: Calculate total meal size
    const totalMealGrams = this.calculateTotalMealSize(petWeightKg, species);
    
    // Step 2: Get nutritional targets for this species
    const targets = this.getNutritionalTargets(species);
    
    // Step 3: Calculate required nutrient grams
    const targetProteinGrams = totalMealGrams * targets.proteinPercent;
    const targetFatGrams = totalMealGrams * targets.fatPercent;
    
    // Step 4: Allocate portions to meet nutrient targets
    return this.allocateNutrientTargetedPortions(
      ingredients,
      totalMealGrams,
      targetProteinGrams,
      targetFatGrams,
      petWeightKg
    );
  }
  
  /**
   * Calculate total meal size based on species and pet weight
   */
  private calculateTotalMealSize(petWeightKg: number, species: Species): number {
    if (species === 'dogs' || species === 'cats') {
      const mealMultiplier = this.qualityTier === 'premium' ? 80 : this.qualityTier === 'standard' ? 65 : 50;
      return petWeightKg * mealMultiplier;
    } else if (species === 'birds') {
      return petWeightKg * 40;
    } else if (species === 'reptiles') {
      return petWeightKg * 30;
    } else if (species === 'pocket-pets') {
      return petWeightKg * 100;
    }
    return petWeightKg * 65;
  }
  
  /**
   * Get nutritional targets (protein %, fat %) for each species
   * Based on AAFCO standards
   */
  private getNutritionalTargets(species: Species): { proteinPercent: number; fatPercent: number } {
    switch (species) {
      case 'dogs':
        return { proteinPercent: 0.20, fatPercent: 0.08 }; // 20% protein, 8% fat (above 18% minimum)
      case 'cats':
        return { proteinPercent: 0.23, fatPercent: 0.10 }; // 23% protein, 10% fat (allows diverse protein sources)
      case 'birds':
        // Target 15% but accept 13-17% range (natural fluctuation in seed diets)
        return { proteinPercent: 0.15, fatPercent: 0.08 };
      case 'reptiles':
        // Target 15% but accept 13-17% range (natural fluctuation in insect diets)
        return { proteinPercent: 0.15, fatPercent: 0.07 };
      case 'pocket-pets':
        // Target 14% but accept 12-16% range (natural fluctuation in hay diets)
        return { proteinPercent: 0.14, fatPercent: 0.06 };
      default:
        return { proteinPercent: 0.20, fatPercent: 0.08 };
    }
  }
  
  /**
   * Allocate portions to meet nutrient targets
   * Uses iterative approach: start with base allocation, then adjust to hit targets
   */
  private allocateNutrientTargetedPortions(
    ingredients: Ingredient[],
    totalMealGrams: number,
    targetProteinGrams: number,
    targetFatGrams: number,
    petWeightKg: number
  ): PortionedIngredient[] {
    const species = this.constraints.species;
    
    // Note: highProtein used later for boosting portions if needed
    const highProtein = ingredients.filter(ing => (ing.composition.protein || 0) >= 15);
    
    const portioned: PortionedIngredient[] = [];
    let allocatedGrams = 0;
    let allocatedProtein = 0;
    let allocatedFat = 0;
    
    // USER REQUIREMENT: Distribute portions across ALL selected ingredients
    // Don't allocate 90% to one ingredient - spread it out for variety
    
    // For dogs/cats: Use SELECTED protein (whatever was chosen by scoring)
    if (species === 'dogs' || species === 'cats') {
      // Get ANY protein that was selected (no primary/secondary distinction)
      const proteinIngredients = ingredients.filter(ing => canonicalCategory(ing.category) === 'protein');
      
      if (proteinIngredients.length === 0) {
        console.warn('No protein ingredients available for dogs/cats!');
        console.warn('Selected ingredients:', ingredients.map(i => `${i.name} (cat: ${i.category})`));
        return [];
      }
      
      // Use whichever protein was selected (chicken, sardines, mackerel, turkey, etc.)
      const primaryProtein = proteinIngredients[0];
      
      // Calculate portion needed to hit protein target with THIS protein
      const proteinDensity = (primaryProtein.composition.protein || 20) / 100;
      const requiredIngredientGrams = targetProteinGrams / proteinDensity;
      
      let proteinPortion = requiredIngredientGrams;
      
      // ARCHITECTURAL RULE: Hard upper bound to prevent crowding out micronutrients/fats
      // Cats: 90% max (obligate carnivores, need high protein even with diverse sources)
      // Dogs: 85% max (leaves 15% for variety & micronutrient carriers)
      const maxProteinPercent = species === 'cats' ? 0.90 : 0.85;
      proteinPortion = Math.min(proteinPortion, totalMealGrams * maxProteinPercent);
      
      // ARCHITECTURAL RULE: Never override max-inclusion constraints
      const maxGrams = petWeightKg * 1000 * primaryProtein.maxInclusionPercent[species];
      proteinPortion = Math.min(proteinPortion, maxGrams);
      
      proteinPortion = Math.round(proteinPortion);
      
      if (proteinPortion > 0) {
        portioned.push({ ingredient: primaryProtein, grams: proteinPortion });
        allocatedGrams += proteinPortion;
        allocatedProtein += (primaryProtein.composition.protein || 0) * proteinPortion / 100;
        allocatedFat += (primaryProtein.composition.fat || 0) * proteinPortion / 100;
      }
      
      // Allocate remaining grams to other ingredients
      const remainingGrams = totalMealGrams - allocatedGrams;
      const otherIngredients = ingredients.filter(ing => ing.id !== primaryProtein.id);
      
      if (remainingGrams > 0 && otherIngredients.length > 0) {
        const gramsPerIngredient = remainingGrams / otherIngredients.length;
        
        for (const ing of otherIngredients) {
          let grams = gramsPerIngredient;
          grams *= (0.85 + Math.random() * 0.3);
          
          const maxGrams = petWeightKg * 1000 * ing.maxInclusionPercent[species];
          grams = Math.min(grams, maxGrams);
          grams = Math.round(grams);
          
          if (grams > 0) {
            portioned.push({ ingredient: ing, grams });
            allocatedGrams += grams;
            allocatedProtein += (ing.composition.protein || 0) * grams / 100;
            allocatedFat += (ing.composition.fat || 0) * grams / 100;
          }
        }
      }
    } else {
      // For exotic pets: Distribute with bias toward higher-protein items
      // Equal grams ‚â† equal nutrition - bias toward protein-dense natural foods
      
      // Calculate protein density weights for each ingredient
      const totalProteinDensity = ingredients.reduce((sum, ing) => 
        sum + (ing.composition.protein || 0), 0);
      
      for (const ing of ingredients) {
        const proteinDensity = ing.composition.protein || 0;
        
        // Base allocation: equal distribution
        const baseGrams = totalMealGrams / ingredients.length;
        
        // Protein bias: allocate more to higher-protein ingredients
        // Weight = 70% equal + 30% protein-density-weighted
        const proteinWeight = totalProteinDensity > 0 
          ? proteinDensity / totalProteinDensity 
          : 1 / ingredients.length;
        
        let grams = (baseGrams * 0.70) + (totalMealGrams * proteinWeight * 0.30);
        
        // Add variation (¬±15%)
        grams *= (0.85 + Math.random() * 0.3);
        
        // ARCHITECTURAL RULE: Never override max-inclusion constraints
        const maxGrams = petWeightKg * 1000 * ing.maxInclusionPercent[species];
        grams = Math.min(grams, maxGrams);
        grams = Math.round(grams);
        
        if (grams > 0) {
          portioned.push({ ingredient: ing, grams });
          allocatedGrams += grams;
          allocatedProtein += (ing.composition.protein || 0) * grams / 100;
          allocatedFat += (ing.composition.fat || 0) * grams / 100;
        }
      }
    }
    
    // Step 4: Adjust if we're still below protein target
    const currentProteinPercent = allocatedGrams > 0 ? (allocatedProtein / allocatedGrams) : 0;
    const targetProteinPercent = targetProteinGrams / totalMealGrams;
    
    if (currentProteinPercent < targetProteinPercent * 0.95 && highProtein.length > 0) {
      // Boost high-protein portions by 20%
      for (const portioned_ing of portioned) {
        if ((portioned_ing.ingredient.composition.protein || 0) >= 15) {
          const boost = Math.round(portioned_ing.grams * 0.2);
          const maxGrams = petWeightKg * 1000 * portioned_ing.ingredient.maxInclusionPercent[species];
          portioned_ing.grams = Math.min(portioned_ing.grams + boost, maxGrams);
        }
      }
    }
    
    return portioned;
  }


  /**
   * Calculate estimated cost
   */
  private calculateCost(portioned: PortionedIngredient[]): number {
    return portioned.reduce((sum, p) => {
      if (!p.ingredient.pricePerLb) return sum;
      const lbs = p.grams / 453.592;
      return sum + lbs * p.ingredient.pricePerLb;
    }, 0);
  }
}
</file>

<file path="lib/generator/RecipeCompositionValidator.ts">
/**
 * RECIPE COMPOSITION VALIDATOR
 * Ensures recipes follow safe ingredient combination rules
 * Prevents unsafe combinations like multiple organ meats or unbalanced macros
 */

import type { Ingredient, Species } from '@/lib/data/ingredients';

// ============================================================================
// INGREDIENT ROLE DEFINITIONS
// ============================================================================

export const INGREDIENT_ROLES = {
  // Main proteins - can be primary ingredient (30-40% of recipe)
  mainProtein: [
    'chicken', 'turkey', 'beef', 'lamb', 'duck', 'venison',
    'salmon', 'whitefish', 'cod', 'sardine', 'tuna', 'egg'
  ],

  // Organ meats - MUST be limited to <10% of recipe
  organMeat: [
    'liver', 'kidney', 'heart', 'tripe', 'lung', 'spleen'
  ],

  // Carbohydrates - should be 30-40% of recipe
  carbs: [
    'rice', 'oats', 'quinoa', 'barley', 'potato', 'sweet potato',
    'pumpkin', 'squash', 'lentils', 'chickpeas', 'beans'
  ],

  // Vegetables - should be 10-20% of recipe
  vegetables: [
    'carrots', 'green beans', 'broccoli', 'spinach', 'kale',
    'zucchini', 'celery', 'peas', 'asparagus', 'lettuce'
  ],

  // Fats/oils - should be <5% of recipe
  fats: [
    'fish oil', 'coconut oil', 'olive oil', 'salmon oil', 'flaxseed', 'oil'
  ],
};

// ============================================================================
// UNSAFE COMBINATIONS
// ============================================================================

export const UNSAFE_COMBINATIONS = [
  {
    name: 'Multiple Organ Meats',
    ingredients: ['liver', 'kidney', 'heart'],
    maxCombined: 1, // Can only have 1 organ meat per recipe
    reason: 'Risk of vitamin A toxicity and mineral imbalance',
  },
  {
    name: 'High-Fat Proteins Together',
    ingredients: ['salmon', 'sardine', 'duck', 'lamb', 'mackerel'],
    maxCombined: 1, // Only 1 high-fat protein per recipe
    reason: 'Too much fat can cause pancreatitis',
  },
  {
    name: 'Multiple Fish Sources',
    ingredients: ['salmon', 'sardine', 'tuna', 'mackerel', 'whitefish', 'cod'],
    maxCombined: 1, // Only 1 fish per recipe
    reason: 'Risk of mercury accumulation and thiamine deficiency',
  },
];

// ============================================================================
// REQUIRED RECIPE STRUCTURE BY SPECIES
// ============================================================================

export const REQUIRED_RECIPE_STRUCTURE: Record<Species, {
  mustHave: string[];
  shouldHave: string[];
  optional: string[];
  minIngredients: number;
  maxIngredients: number;
}> = {
  dogs: {
    mustHave: ['mainProtein', 'carbs'], // REQUIRED
    shouldHave: ['vegetables'], // RECOMMENDED
    optional: ['fats', 'organMeat'], // OPTIONAL
    minIngredients: 3, // At least protein + carb + veggie
    maxIngredients: 6, // Don't overcomplicate
  },
  cats: {
    mustHave: ['mainProtein'], // Obligate carnivores - protein is essential
    shouldHave: ['fats'], // Cats need higher fat
    optional: ['carbs', 'vegetables'], // Cats don't need carbs, but tolerate some
    minIngredients: 2, // Can be simpler (protein + fat)
    maxIngredients: 5,
  },
  birds: {
    mustHave: ['vegetables', 'seed'], // Birds need seeds/veggies
    shouldHave: ['fruit'], // Birds love fruits
    optional: ['protein', 'carbs'],
    minIngredients: 2,
    maxIngredients: 5,
  },
  reptiles: {
    mustHave: ['protein'], // Carnivorous reptiles need protein
    shouldHave: ['vegetable'], // Some herbivorous/omnivorous reptiles
    optional: ['carbs', 'fruit'],
    minIngredients: 1,
    maxIngredients: 4,
  },
  'pocket-pets': {
    mustHave: ['hay', 'vegetable'], // Herbivores need hay and veggies
    shouldHave: ['fruit'], // Optional treats
    optional: ['carbs', 'seed'],
    minIngredients: 2,
    maxIngredients: 5,
  },
};

// ============================================================================
// VALIDATION RESULT
// ============================================================================

export interface ValidationResult {
  isValid: boolean;
  issues: string[];
  warnings: string[];
}

// ============================================================================
// MAIN VALIDATION FUNCTION
// ============================================================================

/**
 * Validate recipe composition for safety and balance
 */
export function validateRecipeComposition(
  selectedIngredients: Ingredient[],
  species: Species
): ValidationResult {
  const issues: string[] = [];
  const warnings: string[] = [];

  const ingredientNames = selectedIngredients.map(ing => ing.name.toLowerCase());

  // ========================================================================
  // CHECK 1: Required structure
  // ========================================================================
  const structure = REQUIRED_RECIPE_STRUCTURE[species];
  if (structure) {
    // Check mustHave categories
    for (const category of structure.mustHave) {
      const hasCategory = ingredientNames.some(name =>
        INGREDIENT_ROLES[category as keyof typeof INGREDIENT_ROLES]?.some(role =>
          name.includes(role)
        )
      );
      if (!hasCategory) {
        issues.push(`Missing required ingredient type: ${category}`);
      }
    }

    // Check shouldHave categories
    for (const category of structure.shouldHave) {
      const hasCategory = ingredientNames.some(name =>
        INGREDIENT_ROLES[category as keyof typeof INGREDIENT_ROLES]?.some(role =>
          name.includes(role)
        )
      );
      if (!hasCategory) {
        warnings.push(`Recommended ingredient type missing: ${category}`);
      }
    }

    // Check ingredient count
    if (selectedIngredients.length < structure.minIngredients) {
      issues.push(
        `Too few ingredients (${selectedIngredients.length}, need ${structure.minIngredients}+)`
      );
    }
    if (selectedIngredients.length > structure.maxIngredients) {
      warnings.push(
        `Too many ingredients (${selectedIngredients.length}, recommended max ${structure.maxIngredients})`
      );
    }
  }

  // ========================================================================
  // CHECK 2: Unsafe combinations
  // ========================================================================
  for (const combo of UNSAFE_COMBINATIONS) {
    const matchedIngredients = ingredientNames.filter(name =>
      combo.ingredients.some(unsafe => name.includes(unsafe))
    );

    if (matchedIngredients.length > combo.maxCombined) {
      issues.push(
        `Unsafe combination: ${matchedIngredients.join(' + ')}. ` +
        `${combo.reason}. Max ${combo.maxCombined} allowed.`
      );
    }
  }

  // ========================================================================
  // CHECK 3: Organ meat percentage (if present)
  // ========================================================================
  const hasOrganMeat = ingredientNames.some(name =>
    INGREDIENT_ROLES.organMeat.some(organ => name.includes(organ))
  );

  if (hasOrganMeat) {
    const organMeats = selectedIngredients.filter(ing =>
      INGREDIENT_ROLES.organMeat.some(organ => ing.name.toLowerCase().includes(organ))
    );

    // Check if organ meat has proper role
    const organMeatRole = organMeats[0]?.feedingRole;
    if (organMeatRole === 'staple') {
      issues.push(
        `${organMeats[0].name} is marked as staple but should be supplement. ` +
        `Organ meats must be limited to <10% of recipe.`
      );
    }

    // If multiple ingredients, warn if organ meat portion is too large
    if (selectedIngredients.length <= 2 && hasOrganMeat) {
      issues.push(
        `Recipe has too few ingredients with organ meat present. ` +
        `Add carbs/vegetables to dilute organ meat concentration.`
      );
    }
  }

  // ========================================================================
  // CHECK 4: No double proteins without carbs (for dogs)
  // ========================================================================
  if (species === 'dogs') {
    const proteinCount = ingredientNames.filter(name =>
      INGREDIENT_ROLES.mainProtein.some(p => name.includes(p)) ||
      INGREDIENT_ROLES.organMeat.some(o => name.includes(o))
    ).length;

    const hasCarbs = ingredientNames.some(name =>
      INGREDIENT_ROLES.carbs.some(c => name.includes(c))
    );

    if (proteinCount >= 2 && !hasCarbs) {
      issues.push(
        `Recipe has ${proteinCount} protein sources but no carbohydrates. ` +
        `This is unbalanced and too protein-heavy.`
      );
    }
  }

  return {
    isValid: issues.length === 0,
    issues,
    warnings,
  };
}

/**
 * Check if an ingredient should be categorized as a supplement (organ meat)
 */
export function isOrganMeat(ingredient: Ingredient): boolean {
  const name = ingredient.name.toLowerCase();
  return INGREDIENT_ROLES.organMeat.some(organ => name.includes(organ));
}

/**
 * Get ingredient category role
 */
export function getIngredientRole(ingredient: Ingredient): string {
  const name = ingredient.name.toLowerCase();

  if (INGREDIENT_ROLES.mainProtein.some(p => name.includes(p))) return 'mainProtein';
  if (INGREDIENT_ROLES.organMeat.some(o => name.includes(o))) return 'organMeat';
  if (INGREDIENT_ROLES.carbs.some(c => name.includes(c))) return 'carbs';
  if (INGREDIENT_ROLES.vegetables.some(v => name.includes(v))) return 'vegetables';
  if (INGREDIENT_ROLES.fats.some(f => name.includes(f))) return 'fats';

  return 'unknown';
}
</file>

<file path="lib/generator/RecipeConstraintRules.ts">
/**
 * RECIPE CONSTRAINT RULES
 * Pre-scoring validation gates that reject unsafe/invalid recipes before optimization
 * 
 * Pipeline:
 * 1. Constraint Gate (hard rejections)
 * 2. Composition Validator (structure + balance)
 * 3. Nutrient Ceiling Validator (micronutrient caps)
 * 4. Optimizer (cost + nutrition)
 * 5. Scorer (quality + fit)
 */

import type { Ingredient, Species } from '@/lib/data/ingredients';

// ============================================================================
// NUTRIENT CEILING TABLE (Species-Aware)
// Absolute caps per day equivalent, not scoring targets
// ============================================================================

export const NUTRIENT_CEILINGS: Record<Species, {
  vitaminA_IU: number;
  copper_mg: number;
  iodine_mcg: number;
  fat_percent: number;
  calcium_g: number;
  calcium_phosphorus_min: number;
  calcium_phosphorus_max: number;
}> = {
  dogs: {
    vitaminA_IU: 30000,       // PHASE 2: Per recipe (realistic with organs)
    copper_mg: 5.0,           // PHASE 2: Per recipe ceiling (realistic with organs)
    iodine_mcg: 1000,         // PHASE 2: Per recipe ceiling (realistic)
    fat_percent: 30,
    calcium_g: 2.5,
    calcium_phosphorus_min: 1.2,
    calcium_phosphorus_max: 2.0,
  },
  cats: {
    vitaminA_IU: 25000,       // PHASE 2: Per recipe (realistic with organs)
    copper_mg: 4.0,           // PHASE 2: Per recipe ceiling (realistic with organs)
    iodine_mcg: 800,          // PHASE 2: Per recipe ceiling (realistic)
    fat_percent: 45,
    calcium_g: 2.0,
    calcium_phosphorus_min: 1.1,
    calcium_phosphorus_max: 1.5,
  },
  birds: {
    vitaminA_IU: 4000, // Species-dependent, conservative estimate
    copper_mg: 0.3,
    iodine_mcg: 150,
    fat_percent: 15,
    calcium_g: 1.5,
    calcium_phosphorus_min: 1.0,
    calcium_phosphorus_max: 2.0,
  },
  reptiles: {
    vitaminA_IU: 3000, // Highly species-dependent
    copper_mg: 0.2,
    iodine_mcg: 100,
    fat_percent: 20,
    calcium_g: 2.0,
    calcium_phosphorus_min: 1.5,
    calcium_phosphorus_max: 2.5,
  },
  'pocket-pets': {
    vitaminA_IU: 4000,
    copper_mg: 0.3,
    iodine_mcg: 150,
    fat_percent: 20,
    calcium_g: 1.8,
    calcium_phosphorus_min: 1.0,
    calcium_phosphorus_max: 2.0,
  },
};

// ============================================================================
// INGREDIENT ROLE MATRIX
// Prevents "two mains in disguise" and organ stacking
// ============================================================================

export const INGREDIENT_ROLE_MATRIX = {
  'primary-protein': {
    allowedAsPrimary: true,
    percentCap: 0.60,
    maxPerRecipe: 1, // Exactly one primary protein
    examples: ['chicken_breast', 'beef', 'salmon', 'turkey_breast'],
  },
  'carb-base': {
    allowedAsPrimary: false,
    percentCap: 0.40,
    maxPerRecipe: 2,
    examples: ['rice', 'sweet_potato', 'oats', 'barley'],
  },
  'vegetable': {
    allowedAsPrimary: false,
    percentCap: 0.25,
    maxPerRecipe: 3,
    examples: ['carrots', 'green_beans', 'spinach', 'broccoli'],
  },
  'organ-meat': {
    allowedAsPrimary: false,
    percentCap: 0.10, // Hard cap for organ meats
    maxPerRecipe: 1, // Only one organ meat per recipe
    examples: ['chicken_liver', 'beef_liver', 'chicken_hearts'],
  },
  'fat-supplement': {
    allowedAsPrimary: false,
    percentCap: 0.05,
    maxPerRecipe: 1, // Only one added fat source
    examples: ['fish_oil', 'coconut_oil', 'olive_oil'],
  },
  'micronutrient': {
    allowedAsPrimary: false,
    percentCap: 0.01,
    maxPerRecipe: 1,
    examples: ['kelp', 'eggshell_powder', 'vitamin_premix'],
  },
};

// ============================================================================
// STRUCTURAL COMPOSITION RULES (Hard Gates)
// ============================================================================

export interface CompositionRuleResult {
  passed: boolean;
  ruleId: string;
  message: string;
}

export function validateStructuralComposition(
  ingredients: Ingredient[],
  species: Species,
  lifeStage: 'puppy' | 'adult' | 'senior'
): CompositionRuleResult[] {
  const results: CompositionRuleResult[] = [];

  // S1: Exactly 1 protein source (STRICT) - Species-aware
  // Dogs/cats: Must have 1 'protein' category (any protein, not just "primary")
  // Birds: Can have seeds/nuts as protein
  // Reptiles: Can have insects as protein
  // Pocket-pets: Can have hay/seeds as protein
  
  // Helper to normalize categories
  const canonicalCategory = (cat: any): string => {
    const c = String(cat ?? '').toLowerCase().trim();
    if (c === 'protein' || c.includes('protein') || c.includes('meat') || 
        c.includes('poultry') || c.includes('fish') || c.includes('seafood') || c.includes('egg')) {
      return 'protein';
    }
    return c;
  };
  
  let primaryProteins: Ingredient[];
  if (species === 'dogs' || species === 'cats') {
    // Accept ANY protein ingredient (chicken, turkey, sardines, mackerel, etc.)
    primaryProteins = ingredients.filter(ing => canonicalCategory(ing.category) === 'protein');
  } else if (species === 'birds') {
    // Birds: seeds/nuts/insects, but exclude oils (they're fats, not protein sources)
    primaryProteins = ingredients.filter(ing =>
      ['seed', 'nut', 'insect'].includes(ing.category) &&
      !ing.name.toLowerCase().includes('oil')
    );
  } else if (species === 'reptiles') {
    primaryProteins = ingredients.filter(ing =>
      ['insect', 'protein'].includes(ing.category)
    );
  } else if (species === 'pocket-pets') {
    primaryProteins = ingredients.filter(ing =>
      ['hay', 'seed'].includes(ing.category)
    );
  } else {
    // Default: accept any protein
    primaryProteins = ingredients.filter(ing => canonicalCategory(ing.category) === 'protein');
  }
  
  // Dogs/cats need exactly 1, exotic species can have 1-2 for variety
  const minRequired = (species === 'dogs' || species === 'cats') ? 1 : 1;
  const maxAllowed = (species === 'dogs' || species === 'cats') ? 1 : 3;
  
  results.push({
    passed: primaryProteins.length >= minRequired && primaryProteins.length <= maxAllowed,
    ruleId: 'S1',
    message: `Primary protein sources: ${primaryProteins.length} (species: ${species}, range: ${minRequired}-${maxAllowed})`,
  });

  // S2: Organ meats ‚â§ 1 per recipe (count-based, not weight)
  // NOTE: Weight-based cap moved to quality scoring as soft gate
  const organMeatNames = ['liver', 'kidney', 'heart'];
  const organMeats = ingredients.filter(ing => {
    const name = ing.name.toLowerCase();
    return ing.feedingRole === 'supplement' && organMeatNames.some(organ => name.includes(organ));
  });
  
  results.push({
    passed: organMeats.length <= 1,
    ruleId: 'S2',
    message: `Organ meats ‚â§ 1 per recipe (found ${organMeats.length})`,
  });

  // S3: Organ meats cannot be primary protein
  const organAsPrimary = ingredients.filter(ing =>
    ing.feedingRole === 'staple' &&
    (ing.name.toLowerCase().includes('liver') ||
      ing.name.toLowerCase().includes('kidney') ||
      ing.name.toLowerCase().includes('heart'))
  );
  results.push({
    passed: organAsPrimary.length === 0,
    ruleId: 'S3',
    message: `Organ meats cannot be primary protein (found ${organAsPrimary.length})`,
  });

  // S4: Must include carb/energy source (species-aware)
  // Dogs: need 'carb' (grains)
  // Birds: need 'seed' or 'nut' (energy-dense)
  // Pocket-pets: need 'hay' (fiber/energy)
  // Cats/reptiles: optional carbs
  let hasEnergySource = false;
  if (species === 'dogs') {
    hasEnergySource = ingredients.some(ing => ing.category === 'carb');
  } else if (species === 'birds') {
    hasEnergySource = ingredients.some(ing => ['seed', 'nut', 'carb'].includes(ing.category));
  } else if (species === 'pocket-pets') {
    hasEnergySource = ingredients.some(ing => ['hay', 'seed', 'carb'].includes(ing.category));
  } else {
    hasEnergySource = true; // Cats/reptiles don't require carbs
  }
  
  results.push({
    passed: hasEnergySource,
    ruleId: 'S4',
    message: `${species} energy source requirement met: ${hasEnergySource}`,
  });

  // S5: Carnivores may be carb-free (informational, not a gate)
  const isCarnivore = ['cats', 'reptiles'].includes(species);
  results.push({
    passed: true, // Always pass - this is permissive
    ruleId: 'S5',
    message: `${species} may be carb-free (allowed)`,
  });

  // S6: Minimum ingredient categories
  // All species need at least 2 different categories for nutritional balance
  const categories = new Set(ingredients.map(ing => ing.category));
  results.push({
    passed: categories.size >= 2,
    ruleId: 'S6',
    message: `Minimum 2 ingredient categories required (found ${categories.size})`,
  });

  // S7: Added fat sources ‚â§ 1
  const addedFats = ingredients.filter(ing => ing.category === 'fat');
  results.push({
    passed: addedFats.length <= 1,
    ruleId: 'S7',
    message: `Maximum 1 added fat source (found ${addedFats.length})`,
  });

  // S8: Ingredient diversity ‚â• 3 unique foods
  const uniqueIngredients = new Set(ingredients.map(ing => ing.id));
  results.push({
    passed: uniqueIngredients.size >= 3,
    ruleId: 'S8',
    message: `Minimum 3 unique ingredients required (found ${uniqueIngredients.size})`,
  });

  return results;
}

// ============================================================================
// SAFETY & TOXICITY RULES (Hard Gates)
// ============================================================================

export interface SafetyRuleResult {
  passed: boolean;
  ruleId: string;
  message: string;
  value?: number;
  ceiling?: number;
}

export function validateSafetyAndToxicity(
  ingredients: Ingredient[],
  species: Species,
  allergies?: string[]
): SafetyRuleResult[] {
  const results: SafetyRuleResult[] = [];
  const ceilings = NUTRIENT_CEILINGS[species];

  // T1: Vitamin A ceiling (HARD for dogs/cats, SOFT for exotic pets)
  const proteinAndOrganMeats = ingredients.filter(ing => 
    ing.category === 'protein' || 
    ing.name.toLowerCase().includes('liver') ||
    ing.name.toLowerCase().includes('kidney') ||
    ing.name.toLowerCase().includes('heart')
  );
  
  const totalVitaminA = ingredients.reduce((sum, ing) => sum + (ing.composition.vitaminA || 0), 0);
  const hasVitaminAData = proteinAndOrganMeats.every(ing => ing.composition.vitaminA !== undefined);
  
  // Only enforce for dogs/cats (AAFCO standards exist)
  const enforceT1 = species === 'dogs' || species === 'cats';
  results.push({
    passed: enforceT1 ? (hasVitaminAData && totalVitaminA <= ceilings.vitaminA_IU) : true,
    ruleId: 'T1',
    message: hasVitaminAData 
      ? `Vitamin A: ${totalVitaminA} IU (ceiling: ${ceilings.vitaminA_IU})`
      : enforceT1 
        ? `Vitamin A data incomplete for proteins/organs - cannot validate`
        : `Vitamin A data incomplete (soft warning for ${species})`,
    value: totalVitaminA,
    ceiling: ceilings.vitaminA_IU,
  });

  // T2: Copper ceiling (HARD for dogs/cats, SOFT for exotic pets)
  const totalCopper = ingredients.reduce((sum, ing) => sum + (ing.composition.copper_mg_per_100g || 0), 0);
  const hasAllCopperData = ingredients.every(ing => ing.composition.copper_mg_per_100g !== undefined);
  
  // Only enforce for dogs/cats
  const enforceT2 = species === 'dogs' || species === 'cats';
  results.push({
    passed: enforceT2 ? (hasAllCopperData && totalCopper <= ceilings.copper_mg) : true,
    ruleId: 'T2',
    message: hasAllCopperData 
      ? `Copper: ${totalCopper.toFixed(2)} mg (ceiling: ${ceilings.copper_mg})`
      : enforceT2
        ? `Copper data incomplete - cannot validate`
        : `Copper data incomplete (soft warning for ${species})`,
    value: totalCopper,
    ceiling: ceilings.copper_mg,
  });

  // T3: Iodine ceiling (PHASE 2: Now using class-based defaults + measured overrides)
  const totalIodine = ingredients.reduce((sum, ing) => sum + (ing.composition.iodine_mcg_per_100g || 0), 0);
  const hasAllIodineData = ingredients.every(ing => ing.composition.iodine_mcg_per_100g !== undefined);
  results.push({
    passed: hasAllIodineData && totalIodine <= ceilings.iodine_mcg,
    ruleId: 'T3',
    message: hasAllIodineData 
      ? `Iodine: ${totalIodine.toFixed(1)} mcg (ceiling: ${ceilings.iodine_mcg})`
      : `Iodine data incomplete - cannot validate`,
    value: totalIodine,
    ceiling: ceilings.iodine_mcg,
  });

  // T4: Known toxic ingredient present
  const toxicIngredients = ['grape', 'raisin', 'onion', 'garlic', 'chocolate', 'xylitol'];
  const hasToxic = ingredients.some(ing =>
    toxicIngredients.some(toxic => ing.name.toLowerCase().includes(toxic))
  );
  results.push({
    passed: !hasToxic,
    ruleId: 'T4',
    message: `No known toxic ingredients (found: ${hasToxic})`,
  });

  // T5: Allergen or derivative present
  const hasAllergen =
    allergies && allergies.length > 0
      ? ingredients.some(ing =>
          allergies.some(allergen =>
            ing.name.toLowerCase().includes(allergen.toLowerCase()) ||
            ing.id.includes(allergen.toLowerCase())
          )
        )
      : false;
  results.push({
    passed: !hasAllergen,
    ruleId: 'T5',
    message: `No allergens present (found: ${hasAllergen})`,
  });

  // T6: Ca:P ratio (SOFT WARNING - hard gate disabled until supplements available)
  // Phase 1: Just track it. Phase 2: Apply soft penalties if out of range.
  // Real fix: Add calcium supplement ingredients (eggshell powder, bone meal, etc.)
  const totalCalcium = ingredients.reduce((sum, ing) => sum + (ing.composition.calcium || 0), 0);
  const totalPhosphorus = ingredients.reduce((sum, ing) => sum + (ing.composition.phosphorus || 0), 0);
  const caPRatio = totalPhosphorus > 0 ? totalCalcium / totalPhosphorus : 1;
  const hasCalciumSupplement = ingredients.some(ing =>
    ing.name.toLowerCase().includes('eggshell') ||
    ing.name.toLowerCase().includes('bone meal') ||
    ing.name.toLowerCase().includes('calcium')
  );
  
  // Pass if: naturally in range OR has calcium supplement
  const caPValid = (caPRatio >= 1.0 && caPRatio <= 2.0) || hasCalciumSupplement;
  
  results.push({
    passed: true, // Always pass - this is now a soft warning, not hard gate
    ruleId: 'T6',
    message: `Ca:P ratio: ${Math.round(caPRatio * 100) / 100} ${hasCalciumSupplement ? '(supplement present)' : '(natural)'}`,
    value: Math.round(caPRatio * 100) / 100,
    ceiling: 2.0,
  });

  return results;
}

// ============================================================================
// LIFE STAGE RULES (Hard Gates)
// ============================================================================

export interface LifeStageRuleResult {
  passed: boolean;
  ruleId: string;
  message: string;
}

export function validateLifeStage(
  ingredients: Ingredient[],
  species: Species,
  lifeStage: 'puppy' | 'adult' | 'senior'
): LifeStageRuleResult[] {
  const results: LifeStageRuleResult[] = [];

  if (lifeStage === 'puppy') {
    // L1: Puppy calcium upper limit (prevent skeletal issues)
    const totalCalcium = ingredients.reduce((sum, ing) => sum + (ing.composition.calcium || 0), 0);
    const puppyCalciumMax = 2.0; // g per day
    results.push({
      passed: totalCalcium <= puppyCalciumMax,
      ruleId: 'L1',
      message: `Puppy calcium ‚â§ ${puppyCalciumMax}g (found ${totalCalcium}g)`,
    });

    // L4: Growth diets require higher protein
    const totalProtein = ingredients.reduce((sum, ing) => sum + (ing.composition.protein || 0), 0);
    const puppyProteinMin = 18; // % of calories
    results.push({
      passed: totalProtein >= puppyProteinMin,
      ruleId: 'L4',
      message: `Puppy protein ‚â• ${puppyProteinMin}% (found ${totalProtein}%)`,
    });
  }

  if (lifeStage === 'senior' && species === 'dogs') {
    // L3: Senior kidney load (reduce phosphorus)
    const totalPhosphorus = ingredients.reduce((sum, ing) => sum + (ing.composition.phosphorus || 0), 0);
    const seniorPhosphorusMax = 1.0; // g per day
    results.push({
      passed: totalPhosphorus <= seniorPhosphorusMax,
      ruleId: 'L3',
      message: `Senior phosphorus ‚â§ ${seniorPhosphorusMax}g (found ${totalPhosphorus}g)`,
    });
  }

  return results;
}

// ============================================================================
// QUALITY / PLAUSIBILITY RULES (Soft Gates ‚Üí Penalty)
// ============================================================================

export interface QualityRuleResult {
  passed: boolean;
  ruleId: string;
  message: string;
  penalty: number; // 0-100, applied to score
}

export function validateQualityAndPlausibility(
  ingredients: Ingredient[],
  estimatedCost: number
): QualityRuleResult[] {
  const results: QualityRuleResult[] = [];

  // Q1: "Two mains in disguise" (multiple high-protein ingredients)
  const highProteinCount = ingredients.filter(ing =>
    ing.composition.protein && ing.composition.protein > 20
  ).length;
  const twoMainsPenalty = highProteinCount > 1 ? 30 : 0;
  results.push({
    passed: highProteinCount <= 1,
    ruleId: 'Q1',
    message: `Multiple high-protein ingredients detected (${highProteinCount})`,
    penalty: twoMainsPenalty,
  });

  // Q2: Excessive powders / oils (low ingredient diversity)
  const powderOilCount = ingredients.filter(ing =>
    ing.name.toLowerCase().includes('oil') ||
    ing.name.toLowerCase().includes('powder') ||
    ing.name.toLowerCase().includes('premix')
  ).length;
  const excessivePowderPenalty = powderOilCount > 2 ? 25 : 0;
  results.push({
    passed: powderOilCount <= 2,
    ruleId: 'Q2',
    message: `Excessive powders/oils (${powderOilCount})`,
    penalty: excessivePowderPenalty,
  });

  // Q3: Human implausibility heuristic
  // Recipes that are technically complete but no one would actually make
  const implausiblePatterns = [
    ingredients.length === 2, // Too simple
    estimatedCost < 0.50, // Suspiciously cheap
    ingredients.every(ing => ing.category === 'supplement'), // All supplements
  ];
  const implausiblePenalty = implausiblePatterns.filter(p => p).length > 0 ? 20 : 0;
  results.push({
    passed: implausiblePenalty === 0,
    ruleId: 'Q3',
    message: `Recipe may be implausible (${implausiblePatterns.filter(p => p).length} flags)`,
    penalty: implausiblePenalty,
  });

  // Q4: Repetitive cheap filler pattern
  const cheapFillers = ingredients.filter(ing =>
    (ing.name.toLowerCase().includes('rice') ||
      ing.name.toLowerCase().includes('corn') ||
      ing.name.toLowerCase().includes('wheat')) &&
    (ing.pricePerLb || 1) < 0.50
  ).length;
  const fillerPenalty = cheapFillers >= 2 ? 15 : 0;
  results.push({
    passed: cheapFillers < 2,
    ruleId: 'Q4',
    message: `Repetitive cheap filler pattern (${cheapFillers})`,
    penalty: fillerPenalty,
  });

  // Q5: Organ meat weight cap (soft gate - penalize if >10%)
  const organMeatNames = ['liver', 'kidney', 'heart'];
  const organMeats = ingredients.filter(ing => {
    const name = ing.name.toLowerCase();
    return ing.feedingRole === 'supplement' && organMeatNames.some(organ => name.includes(organ));
  });
  
  const totalWeight = ingredients.reduce((sum, ing) => sum + (ing.composition.protein || 1), 0);
  const organMeatWeight = organMeats.reduce((sum, ing) => sum + (ing.composition.protein || 1), 0);
  const organMeatPercent = totalWeight > 0 ? (organMeatWeight / totalWeight) * 100 : 0;
  
  let organMeatPenalty = 0;
  if (organMeatPercent > 15) organMeatPenalty = 30; // Way over
  else if (organMeatPercent > 10) organMeatPenalty = 15; // Slightly over
  
  results.push({
    passed: organMeatPercent <= 10,
    ruleId: 'Q5',
    message: `Organ meat weight: ${organMeatPercent.toFixed(1)}% (soft cap 10%)`,
    penalty: organMeatPenalty,
  });

  return results;
}

// ============================================================================
// MASTER VALIDATION FUNCTION
// ============================================================================

export interface RecipeValidationResult {
  isValid: boolean;
  hardGates: {
    structural: CompositionRuleResult[];
    safety: SafetyRuleResult[];
    lifeStage: LifeStageRuleResult[];
  };
  softGates: QualityRuleResult[];
  totalPenalty: number;
  failedRules: string[];
}

export function validateRecipeComprehensive(
  ingredients: Ingredient[],
  species: Species,
  lifeStage: 'puppy' | 'adult' | 'senior',
  estimatedCost: number,
  allergies?: string[]
): RecipeValidationResult {
  const structural = validateStructuralComposition(ingredients, species, lifeStage);
  const safety = validateSafetyAndToxicity(ingredients, species, allergies);
  const lifeStageRules = validateLifeStage(ingredients, species, lifeStage);
  const quality = validateQualityAndPlausibility(ingredients, estimatedCost);

  const hardGateFailed = [
    ...structural,
    ...safety,
    ...lifeStageRules,
  ].filter(r => !r.passed);

  const totalPenalty = quality.reduce((sum, q) => sum + q.penalty, 0);

  return {
    isValid: hardGateFailed.length === 0,
    hardGates: {
      structural,
      safety,
      lifeStage: lifeStageRules,
    },
    softGates: quality,
    totalPenalty,
    failedRules: hardGateFailed.map(r => r.ruleId),
  };
}
</file>

<file path="lib/generator/RecipePMIScoring.ts">
/**
 * PMI-BASED PAIRING INTELLIGENCE
 * Uses learned statistical priors from BOTH recipe scraping AND commercial products
 * NOT hardcoded rules - behavior changes when recipePriors.json changes
 */

import type { Ingredient } from '@/lib/data/ingredients';
import priors from '@/lib/data/recipePriors.json';

interface PairingScore {
  score: number;
  reason: string;
  pmiValue?: number;
  source?: 'recipe' | 'commercial' | 'both';
}

/**
 * Calculate PMI-based pairing score for an ingredient given already-selected ingredients
 * Combines recipe priors AND commercial priors for stronger signal
 * Returns both the score and an explanation
 */
export function calculatePairingScore(
  ingredient: Ingredient,
  selectedIngredients: Ingredient[],
  species: string
): PairingScore {
  if (selectedIngredients.length === 0) {
    return { score: 0, reason: 'No selected ingredients' };
  }

  const ingName = ingredient.name;
  let totalPMI = 0;
  let pairCount = 0;
  let negativePenalty = 0;
  const reasons: string[] = [];
  let hasRecipePriors = false;
  let hasCommercialPriors = false;

  // Check recipe priors (homemade recipes)
  const recipePriors = priors.coOccurrence?.[species];
  if (recipePriors) {
    for (const selected of selectedIngredients) {
      const selName = selected.name;
      const pair = [ingName, selName].sort().join('+');
      
      const pmi = recipePriors.pairPMI?.[pair];
      if (pmi !== undefined && pmi > 0) {
        totalPMI += pmi;
        pairCount++;
        hasRecipePriors = true;
        reasons.push(`+${pmi.toFixed(2)} recipe PMI with ${selName}`);
      }
      
      const negativePMI = recipePriors.negativePairs?.[pair];
      if (negativePMI !== undefined) {
        negativePenalty += Math.abs(negativePMI) * 10;
        hasRecipePriors = true;
        reasons.push(`-${Math.abs(negativePMI).toFixed(2)} NEGATIVE recipe pair with ${selName}`);
      }
    }
  }

  // Check commercial priors (pet food products)
  const commercialPriors = (priors as any).commercial?.[species];
  if (commercialPriors) {
    for (const selected of selectedIngredients) {
      const selName = selected.name;
      const pair = [ingName, selName].sort().join('|'); // Commercial uses | separator
      
      const pmi = commercialPriors.pairPMI?.[pair];
      if (pmi !== undefined && pmi > 0) {
        totalPMI += pmi * 1.2; // Boost commercial data slightly (more products = stronger signal)
        pairCount++;
        hasCommercialPriors = true;
        reasons.push(`+${pmi.toFixed(2)} commercial PMI with ${selName}`);
      }
      
      const rarePMI = commercialPriors.rarePairs?.[pair];
      if (rarePMI !== undefined) {
        negativePenalty += Math.abs(rarePMI) * 15; // Strong penalty for commercial rare pairs
        hasCommercialPriors = true;
        reasons.push(`-${Math.abs(rarePMI).toFixed(2)} RARE commercial pair with ${selName}`);
      }
    }
  }

  // Average PMI across all pairs
  const avgPMI = pairCount > 0 ? totalPMI / pairCount : 0;
  const finalScore = avgPMI - negativePenalty;

  const source = hasRecipePriors && hasCommercialPriors ? 'both' 
    : hasCommercialPriors ? 'commercial' 
    : hasRecipePriors ? 'recipe' 
    : undefined;

  const reason = reasons.length > 0 
    ? reasons.join(', ')
    : 'No learned pairings';

  return {
    score: finalScore,
    reason,
    pmiValue: avgPMI,
    source
  };
}

/**
 * Check if a fat is compatible with selected proteins based on PMI
 * Checks BOTH recipe and commercial priors for hard blocks
 * Returns true if fat should be ALLOWED
 */
export function isFatCompatibleWithProteins(
  fat: Ingredient,
  proteins: Ingredient[],
  species: string
): { compatible: boolean; reason: string; pmiScore?: number } {
  if (proteins.length === 0) {
    return { compatible: true, reason: 'No proteins selected yet' };
  }

  const fatName = fat.name;
  let totalPMI = 0;
  let pmiCount = 0;
  let hasNegativePair = false;
  let negativePairWith = '';
  let negativeSource = '';

  // Check recipe priors
  const recipePriors = priors.coOccurrence?.[species];
  if (recipePriors) {
    for (const protein of proteins) {
      const proteinName = protein.name;
      const pair = [fatName, proteinName].sort().join('+');
      
      const negativePMI = recipePriors.negativePairs?.[pair];
      if (negativePMI !== undefined && negativePMI < -1.0) {
        hasNegativePair = true;
        negativePairWith = proteinName;
        negativeSource = 'recipes';
        break;
      }
      
      const pmi = recipePriors.pairPMI?.[pair];
      if (pmi !== undefined) {
        totalPMI += pmi;
        pmiCount++;
      }
    }
  }

  // Check commercial priors (stronger signal)
  const commercialPriors = (priors as any).commercial?.[species];
  if (commercialPriors && !hasNegativePair) {
    for (const protein of proteins) {
      const proteinName = protein.name;
      const pair = [fatName, proteinName].sort().join('|');
      
      const rarePMI = commercialPriors.rarePairs?.[pair];
      if (rarePMI !== undefined && rarePMI < -1.5) {
        hasNegativePair = true;
        negativePairWith = proteinName;
        negativeSource = 'commercial products';
        break;
      }
      
      const pmi = commercialPriors.pairPMI?.[pair];
      if (pmi !== undefined) {
        totalPMI += pmi * 1.2; // Weight commercial data higher
        pmiCount++;
      }
    }
  }

  // Hard block if negative pairing detected
  if (hasNegativePair) {
    return {
      compatible: false,
      reason: `Negative pairing with ${negativePairWith} (learned from ${negativeSource})`,
      pmiScore: undefined
    };
  }

  // Allow if positive PMI or no learned relationship
  const avgPMI = pmiCount > 0 ? totalPMI / pmiCount : 0;
  
  if (avgPMI > 0.3) {
    return {
      compatible: true,
      reason: `Strong positive pairing (PMI: ${avgPMI.toFixed(2)})`,
      pmiScore: avgPMI
    };
  } else if (avgPMI > 0) {
    return {
      compatible: true,
      reason: `Weak positive pairing (PMI: ${avgPMI.toFixed(2)})`,
      pmiScore: avgPMI
    };
  } else {
    // No learned relationship - allow by default (species-appropriate fats)
    return {
      compatible: true,
      reason: 'No learned pairing (species-default allowed)',
      pmiScore: 0
    };
  }
}

/**
 * Get top-N fats that pair well with selected proteins
 * Uses PMI to rank fats, not hardcoded rules
 */
export function getTopPairedFats(
  availableFats: Ingredient[],
  proteins: Ingredient[],
  species: string,
  topN: number = 5
): Array<{ fat: Ingredient; pmiScore: number; reason: string }> {
  const scored = availableFats.map(fat => {
    const compat = isFatCompatibleWithProteins(fat, proteins, species);
    return {
      fat,
      pmiScore: compat.pmiScore || 0,
      reason: compat.reason,
      compatible: compat.compatible
    };
  });

  // Filter to compatible only, then sort by PMI
  return scored
    .filter(s => s.compatible)
    .sort((a, b) => b.pmiScore - a.pmiScore)
    .slice(0, topN);
}

/**
 * Log pairing decision for debugging
 */
export function logPairingDecision(
  ingredient: Ingredient,
  selectedIngredients: Ingredient[],
  species: string,
  action: 'selected' | 'rejected'
): void {
  const pairingScore = calculatePairingScore(ingredient, selectedIngredients, species);
  const prefix = action === 'selected' ? '‚úì' : '‚úó';
  console.log(
    `[PMI ${prefix}] ${ingredient.name}: score=${pairingScore.score.toFixed(2)} | ${pairingScore.reason}`
  );
}
</file>

<file path="lib/generator/RecipePriorScoring.ts">
/**
 * RECIPE PRIOR SCORING
 * Soft scoring boosts based on learned patterns from scraped recipes
 * Integrates with RecipeBuilder to improve realism and variety
 */

import recipePriors from '../data/recipePriors.json';
import { Ingredient } from '../data/ingredients';

interface RecipePriors {
  coOccurrence: {
    [species: string]: {
      pairs: Record<string, number>;
      triples: Record<string, number>;
    };
  };
  categoryRatios: {
    [species: string]: {
      protein: { mean: number; stdDev: number };
      vegetable: { mean: number; stdDev: number };
      fat: { mean: number; stdDev: number };
      carbohydrate: { mean: number; stdDev: number };
    };
  };
  ingredientCounts: {
    [species: string]: {
      mean: number;
      median: number;
      min: number;
      max: number;
    };
  };
}

const priors = recipePriors as RecipePriors;

/**
 * Calculate co-occurrence boost for an ingredient based on already-selected ingredients
 * Returns a score boost (0-1) based on how often this ingredient appears with the selected ones
 */
export function calculateCoOccurrenceBoost(
  candidateIngredient: Ingredient,
  selectedIngredients: Ingredient[],
  species: string
): number {
  if (selectedIngredients.length === 0) return 0;
  
  const speciesPriors = priors.coOccurrence[species];
  if (!speciesPriors) return 0;

  let totalBoost = 0;
  let pairCount = 0;

  // Check pairs with each selected ingredient
  for (const selected of selectedIngredients) {
    const pair1 = `${candidateIngredient.name}+${selected.name}`;
    const pair2 = `${selected.name}+${candidateIngredient.name}`;
    
    const count = speciesPriors.pairs[pair1] || speciesPriors.pairs[pair2] || 0;
    if (count > 0) {
      totalBoost += Math.log(count + 1) / 10; // Logarithmic scaling
      pairCount++;
    }
  }

  // Check triples if we have 2+ selected ingredients
  if (selectedIngredients.length >= 2) {
    for (let i = 0; i < selectedIngredients.length - 1; i++) {
      for (let j = i + 1; j < selectedIngredients.length; j++) {
        const ingredients = [
          candidateIngredient.name,
          selectedIngredients[i].name,
          selectedIngredients[j].name,
        ].sort();
        
        const triple = ingredients.join('+');
        const count = speciesPriors.triples[triple] || 0;
        
        if (count > 0) {
          totalBoost += Math.log(count + 1) / 5; // Higher weight for triples
        }
      }
    }
  }

  // Normalize to 0-1 range
  return Math.min(totalBoost, 1.0);
}

/**
 * Calculate category ratio penalty based on deviation from learned distributions
 * Returns a penalty (0-1) where 0 = perfect match, 1 = very far from typical
 */
export function calculateCategoryRatioPenalty(
  categoryRatios: Record<string, number>,
  species: string
): number {
  const speciesPriors = priors.categoryRatios[species];
  if (!speciesPriors) return 0;

  let totalDeviation = 0;
  let categoryCount = 0;

  for (const [category, ratio] of Object.entries(categoryRatios)) {
    const prior = speciesPriors[category as keyof typeof speciesPriors];
    if (!prior) continue;

    // Calculate z-score (how many standard deviations away)
    const zScore = Math.abs(ratio - prior.mean) / prior.stdDev;
    
    // Convert to penalty (0-1)
    // z-score of 0 = 0 penalty, z-score of 3+ = 1 penalty
    const penalty = Math.min(zScore / 3, 1.0);
    
    totalDeviation += penalty;
    categoryCount++;
  }

  return categoryCount > 0 ? totalDeviation / categoryCount : 0;
}

/**
 * Calculate ingredient count penalty based on deviation from typical recipe sizes
 * Returns a penalty (0-1) where 0 = typical count, 1 = very unusual count
 */
export function calculateIngredientCountPenalty(
  ingredientCount: number,
  species: string
): number {
  const speciesPriors = priors.ingredientCounts[species];
  if (!speciesPriors) return 0;

  const { mean, min, max } = speciesPriors;

  // Within typical range = no penalty
  if (ingredientCount >= min && ingredientCount <= max) {
    // Small penalty for being far from mean
    const deviation = Math.abs(ingredientCount - mean);
    return Math.min(deviation / (max - min), 0.3);
  }

  // Outside typical range = higher penalty
  if (ingredientCount < min) {
    const deficit = min - ingredientCount;
    return Math.min(0.5 + (deficit / min) * 0.5, 1.0);
  }

  // Too many ingredients
  const excess = ingredientCount - max;
  return Math.min(0.5 + (excess / max) * 0.5, 1.0);
}

/**
 * Get typical ingredient count range for a species
 */
export function getTypicalIngredientCount(species: string): { min: number; max: number; median: number } {
  const speciesPriors = priors.ingredientCounts[species];
  if (!speciesPriors) {
    return { min: 3, max: 10, median: 6 };
  }
  return {
    min: speciesPriors.min,
    max: speciesPriors.max,
    median: speciesPriors.median,
  };
}

/**
 * Check if an ingredient is commonly paired with a protein for this species
 * Used to boost vegetables/fats that commonly appear with the selected protein
 */
export function isCommonProteinPairing(
  ingredient: Ingredient,
  protein: Ingredient,
  species: string,
  pairingType: 'fat' | 'vegetable'
): boolean {
  const speciesPriors = priors.categoryPairs?.[species];
  if (!speciesPriors) return false;

  const pairings = pairingType === 'fat' 
    ? speciesPriors.proteinWithFat 
    : speciesPriors.proteinWithVeg;

  const commonPairs = pairings?.[protein.name] || [];
  return commonPairs.includes(ingredient.name);
}

/**
 * Apply all prior-based scoring adjustments to a base score
 * This is the main integration point for RecipeBuilder
 */
export function applyPriorScoring(
  ingredient: Ingredient,
  baseScore: number,
  selectedIngredients: Ingredient[],
  species: string,
  options: {
    coOccurrenceWeight?: number;
    proteinPairingWeight?: number;
  } = {}
): number {
  const {
    coOccurrenceWeight = 0.15,
    proteinPairingWeight = 0.1,
  } = options;

  let adjustedScore = baseScore;

  // 1. Co-occurrence boost
  const coOccurrenceBoost = calculateCoOccurrenceBoost(
    ingredient,
    selectedIngredients,
    species
  );
  adjustedScore += coOccurrenceBoost * coOccurrenceWeight;

  // 2. Protein pairing boost
  const selectedProtein = selectedIngredients.find(i => i.category === 'protein');
  if (selectedProtein) {
    if (ingredient.category === 'fat') {
      const isCommon = isCommonProteinPairing(ingredient, selectedProtein, species, 'fat');
      if (isCommon) {
        adjustedScore += proteinPairingWeight;
      }
    } else if (ingredient.category === 'vegetable') {
      const isCommon = isCommonProteinPairing(ingredient, selectedProtein, species, 'vegetable');
      if (isCommon) {
        adjustedScore += proteinPairingWeight;
      }
    }
  }

  return adjustedScore;
}
</file>

<file path="lib/generator/VerifyAmazonLinks.ts">
// Verify Amazon Links - Check if links are live and accessible
// Note: This checks HTTP status, but can't verify product details without scraping

import { VETTED_PRODUCTS } from '../data/vetted-products';

interface VerificationResult {
  ingredient: string;
  productName: string;
  asinLink: string;
  asin: string;
  status: 'checking' | 'live' | 'dead' | 'redirect' | 'error';
  httpStatus?: number;
  error?: string;
}

const results: VerificationResult[] = [];

console.log('='.repeat(80));
console.log('AMAZON LINK VERIFICATION - HTTP Status Check');
console.log('='.repeat(80));
console.log();
console.log('‚ö†Ô∏è  Note: This checks if links are accessible, but cannot verify');
console.log('    if the product matches the ingredient without manual review.');
console.log();
console.log('Checking links...');
console.log();

// Sample a subset of links to check (checking all 292 would take too long)
const entries = Object.entries(VETTED_PRODUCTS);
const sampleSize = 50; // Check first 50 products
const sampled = entries.slice(0, sampleSize);

async function checkLink(url: string): Promise<{ status: number; ok: boolean }> {
  try {
    const response = await fetch(url, {
      method: 'HEAD', // Just check headers, don't download content
      redirect: 'follow',
    });
    return { status: response.status, ok: response.ok };
  } catch (error: any) {
    throw new Error(error.message);
  }
}

async function verifyLinks() {
  let checked = 0;
  let live = 0;
  let dead = 0;
  let errors = 0;

  for (const [ingredientName, product] of sampled) {
    const asinLink = product.asinLink;
    const asinMatch = asinLink.match(/\/dp\/([A-Z0-9]{10})/i);
    const asin = asinMatch ? asinMatch[1] : 'unknown';

    const result: VerificationResult = {
      ingredient: ingredientName,
      productName: product.productName,
      asinLink,
      asin,
      status: 'checking',
    };

    try {
      const { status, ok } = await checkLink(asinLink);
      result.httpStatus = status;
      
      if (ok && status === 200) {
        result.status = 'live';
        live++;
      } else if (status >= 300 && status < 400) {
        result.status = 'redirect';
        live++; // Redirects are usually fine
      } else {
        result.status = 'dead';
        dead++;
      }
    } catch (error: any) {
      result.status = 'error';
      result.error = error.message;
      errors++;
    }

    results.push(result);
    checked++;

    // Progress indicator
    if (checked % 10 === 0) {
      console.log(`Checked ${checked}/${sampleSize}...`);
    }
  }

  console.log();
  console.log('='.repeat(80));
  console.log('VERIFICATION RESULTS');
  console.log('='.repeat(80));
  console.log();
  console.log(`Sample size: ${sampleSize} products (out of ${entries.length} total)`);
  console.log(`Live links: ${live} (${((live / checked) * 100).toFixed(1)}%)`);
  console.log(`Dead links: ${dead} (${((dead / checked) * 100).toFixed(1)}%)`);
  console.log(`Errors: ${errors} (${((errors / checked) * 100).toFixed(1)}%)`);
  console.log();

  // Show dead links
  const deadLinks = results.filter(r => r.status === 'dead');
  if (deadLinks.length > 0) {
    console.log('DEAD LINKS FOUND:');
    console.log('-'.repeat(80));
    deadLinks.forEach(r => {
      console.log(`‚ùå ${r.ingredient}`);
      console.log(`   Product: ${r.productName}`);
      console.log(`   ASIN: ${r.asin}`);
      console.log(`   Status: ${r.httpStatus}`);
      console.log(`   Link: ${r.asinLink}`);
      console.log();
    });
  }

  // Show errors
  const errorLinks = results.filter(r => r.status === 'error');
  if (errorLinks.length > 0) {
    console.log('ERRORS ENCOUNTERED:');
    console.log('-'.repeat(80));
    errorLinks.forEach(r => {
      console.log(`‚ö†Ô∏è  ${r.ingredient}`);
      console.log(`   Product: ${r.productName}`);
      console.log(`   Error: ${r.error}`);
      console.log(`   Link: ${r.asinLink}`);
      console.log();
    });
  }

  console.log('='.repeat(80));
  console.log('IMPORTANT NOTES');
  console.log('='.repeat(80));
  console.log();
  console.log('1. This script only checks if links are accessible (HTTP 200)');
  console.log('2. It CANNOT verify if the product actually matches the ingredient');
  console.log('3. Manual review is needed to confirm product accuracy');
  console.log();
  console.log('RECOMMENDED MANUAL CHECKS:');
  console.log('- Verify "venison" ASIN actually links to venison (not beef)');
  console.log('- Verify "rabbit meat" ASIN actually links to rabbit (not lamb)');
  console.log('- Verify "turkey giblets" ASIN actually links to turkey (not chicken)');
  console.log('- Verify seed products link to correct seed types');
  console.log();
  console.log('To manually verify, visit the links and check product titles/descriptions.');
  console.log('='.repeat(80));
}

// Run verification
verifyLinks().catch(console.error);
</file>

<file path="lib/hooks/useChunkedRecipeScoring.ts">
// lib/hooks/useChunkedRecipeScoring.ts
// Chunked recipe scoring hook for non-blocking UI performance

import { useState, useEffect, useRef, useMemo } from 'react';
import type { Recipe, ModifiedRecipeResult } from '@/lib/types';
import { calculateEnhancedCompatibility, calibrateScoresForPet, type Pet as EnhancedPet } from '@/lib/utils/enhancedCompatibilityScoring';

interface ScoredMeal {
  meal: ModifiedRecipeResult | { recipe: Recipe; explanation: string };
  score: number;
  recipeId: string;
}

interface CacheEntry {
  scores: ScoredMeal[];
  timestamp: number;
  recipeIds: string[];
  petProfileHash: string;
  version?: string;
}

interface IndividualCacheEntry {
  score: number;
  timestamp: number;
  recipeId: string;
  petProfileHash: string;
  version?: string;
}

const SCORING_VERSION = 'v3';
const CACHE_KEY_PREFIX = `recipe_scores_${SCORING_VERSION}_`;
const INDIVIDUAL_CACHE_KEY_PREFIX = `recipe_score_${SCORING_VERSION}_`;
const CACHE_DURATION_MS = 30 * 60 * 1000; // 30 minutes
const CHUNK_SIZE = 20; // Recipes per frame
const MAX_CACHE_SIZE_MB = 5; // Maximum cache size in MB
const MAX_CACHE_ENTRIES = 50; // Maximum number of cache entries before LRU eviction

/**
 * Simple string hash function for stable hashing
 * Produces consistent hash regardless of object property order
 */
function simpleHash(str: string): string {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash).toString(36);
}

/**
 * Generate a stable hash from pet profile for caching
 * Uses sorted arrays to ensure consistent hash regardless of property order
 */
function generatePetProfileHash(
  pet: null, // Deprecated - using enhancedPet only
  enhancedPet: EnhancedPet | null
): string {
  if (!enhancedPet) return 'no-pet';
  
  const petData = enhancedPet;
  
  // Create stable string representation with sorted arrays
  const healthConcerns = (petData.healthConcerns || []).slice().sort().join(',');
  const allergies = ((petData.allergies || petData.dietaryRestrictions || [])).slice().sort().join(',');
  
  const stableString = [
    petData.id || '',
    petData.type || '',
    petData.breed || '',
    typeof petData.age === 'string' ? parseFloat(petData.age) || 0 : petData.age || 0,
    petData.weight || petData.weightKg || 0,
    petData.activityLevel || 'moderate',
    healthConcerns,
    allergies,
  ].join('|');
  
  return simpleHash(stableString);
}

/**
 * Get individual recipe score from cache
 */
function getCachedRecipeScore(
  recipeId: string,
  petProfileHash: string
): number | null {
  if (typeof window === 'undefined') return null;

  try {
    const cacheKey = `${INDIVIDUAL_CACHE_KEY_PREFIX}${recipeId}_${petProfileHash}`;
    const cached = localStorage.getItem(cacheKey);
    
    if (!cached) return null;

    const entry: IndividualCacheEntry = JSON.parse(cached);
    
    // Validate cache
    const now = Date.now();
    const isExpired = now - entry.timestamp > CACHE_DURATION_MS;
    const versionMatch = entry.version === SCORING_VERSION;
    const hashMatch = entry.petProfileHash === petProfileHash;
    const recipeMatch = entry.recipeId === recipeId;

    if (!isExpired && versionMatch && hashMatch && recipeMatch) {
      return entry.score;
    }
  } catch (error) {
    // Silently fail for individual cache misses
  }

  return null;
}

/**
 * Cache individual recipe score
 */
function cacheRecipeScore(
  recipeId: string,
  score: number,
  petProfileHash: string
): void {
  if (typeof window === 'undefined') return;

  const cacheKey = `${INDIVIDUAL_CACHE_KEY_PREFIX}${recipeId}_${petProfileHash}`;
  const entry: IndividualCacheEntry = {
    score,
    timestamp: Date.now(),
    recipeId,
    petProfileHash,
    version: SCORING_VERSION,
  };

  try {
    localStorage.setItem(cacheKey, JSON.stringify(entry));
  } catch (error) {
    // Silently fail for individual cache writes (batch cache will handle quota)
  }
}

/**
 * Get cached scores if available and valid
 */
function getCachedScores(
  meals: (ModifiedRecipeResult | { recipe: Recipe; explanation: string })[],
  petProfileHash: string
): ScoredMeal[] | null {
  if (typeof window === 'undefined') return null;

  try {
    const cacheKey = `${CACHE_KEY_PREFIX}${petProfileHash}`;
    const cached = localStorage.getItem(cacheKey);
    
    if (!cached) return null;

    const entry: CacheEntry = JSON.parse(cached);
    
    // Validate cache
    const now = Date.now();
    const isExpired = now - entry.timestamp > CACHE_DURATION_MS;
    const versionMatch = (entry.version || 'v1') === SCORING_VERSION; // Default to v1 for old caches
    const recipeIdsMatch = 
      entry.recipeIds.length === meals.length &&
      entry.recipeIds.every((id, i) => id === (meals[i]?.recipe?.id || ''));
    const hashMatch = entry.petProfileHash === petProfileHash;

    if (!isExpired && versionMatch && recipeIdsMatch && hashMatch) {
      console.log('Using cached recipe scores');
      return entry.scores;
    }
  } catch (error) {
    console.warn('Failed to read score cache:', error);
  }

  return null;
}

/**
 * Get cache size in bytes (approximate)
 */
function getCacheSize(): number {
  if (typeof window === 'undefined') return 0;
  
  let size = 0;
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && (key.startsWith(CACHE_KEY_PREFIX) || key.startsWith(INDIVIDUAL_CACHE_KEY_PREFIX))) {
      const value = localStorage.getItem(key);
      if (value) {
        size += key.length + value.length;
      }
    }
  }
  return size;
}

/**
 * Get all cache entries with timestamps for LRU eviction
 */
function getCacheEntriesWithTimestamps(): Array<{ key: string; timestamp: number; size: number }> {
  if (typeof window === 'undefined') return [];
  
  const entries: Array<{ key: string; timestamp: number; size: number }> = [];
  
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && (key.startsWith(CACHE_KEY_PREFIX) || key.startsWith(INDIVIDUAL_CACHE_KEY_PREFIX))) {
      try {
        const value = localStorage.getItem(key);
        if (value) {
          const parsed = JSON.parse(value);
          entries.push({
            key,
            timestamp: parsed.timestamp || 0,
            size: key.length + value.length,
          });
        }
      } catch {
        // Skip invalid entries
      }
    }
  }
  
  return entries.sort((a, b) => a.timestamp - b.timestamp); // Oldest first
}

/**
 * Evict old cache entries using LRU strategy
 */
function evictOldCacheEntries(): void {
  if (typeof window === 'undefined') return;
  
  const maxSizeBytes = MAX_CACHE_SIZE_MB * 1024 * 1024;
  const currentSize = getCacheSize();
  
  if (currentSize <= maxSizeBytes) return;
  
  // Get entries sorted by timestamp (oldest first)
  const entries = getCacheEntriesWithTimestamps();
  
  // Remove oldest entries until we're under the limit
  let sizeToRemove = currentSize - maxSizeBytes;
  for (const entry of entries) {
    if (sizeToRemove <= 0) break;
    
    try {
      localStorage.removeItem(entry.key);
      sizeToRemove -= entry.size;
    } catch {
      // Continue if removal fails
    }
  }
  
  // Also limit by entry count
  const remainingEntries = getCacheEntriesWithTimestamps();
  if (remainingEntries.length > MAX_CACHE_ENTRIES) {
    const toRemove = remainingEntries.slice(0, remainingEntries.length - MAX_CACHE_ENTRIES);
    for (const entry of toRemove) {
      try {
        localStorage.removeItem(entry.key);
      } catch {
        // Continue if removal fails
      }
    }
  }
}

/**
 * Clear all caches for a specific version (useful when version changes)
 */
export function clearCacheForVersion(version: string): void {
  if (typeof window === 'undefined') return;
  
  const keysToRemove: string[] = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && (key.includes(`_${version}_`) || key.startsWith(`recipe_scores_${version}_`) || key.startsWith(`recipe_score_${version}_`))) {
      keysToRemove.push(key);
    }
  }
  
  keysToRemove.forEach(key => {
    try {
      localStorage.removeItem(key);
    } catch {
      // Continue if removal fails
    }
  });
}

/**
 * Cache scored results
 */
function cacheScores(
  scores: ScoredMeal[],
  meals: (ModifiedRecipeResult | { recipe: Recipe; explanation: string })[],
  petProfileHash: string
): void {
  if (typeof window === 'undefined') return;

  // Evict old entries before caching new ones
  evictOldCacheEntries();

  const cacheKey = `${CACHE_KEY_PREFIX}${petProfileHash}`;
  const entry: CacheEntry = {
    scores,
    timestamp: Date.now(),
    recipeIds: meals.map(m => m.recipe?.id || ''),
    petProfileHash,
    version: SCORING_VERSION,
  };

  try {
    localStorage.setItem(cacheKey, JSON.stringify(entry));
    
    // Also cache individual scores for future use
    scores.forEach(scored => {
      cacheRecipeScore(scored.recipeId, scored.score, petProfileHash);
    });
  } catch (error) {
    console.warn('Failed to cache scores:', error);
    // Handle quota exceeded errors gracefully
    if (error instanceof Error && error.name === 'QuotaExceededError') {
      // Evict more aggressively
      evictOldCacheEntries();
      try {
        // Retry caching
        localStorage.setItem(cacheKey, JSON.stringify(entry));
      } catch (retryError) {
        console.warn('Failed to cache scores after cleanup:', retryError);
      }
    }
  }
}

/**
 * Compute score for a single meal
 * Checks individual recipe cache before computing
 */
function computeMealScore(
  meal: ModifiedRecipeResult | { recipe: Recipe; explanation: string },
  ratingPet: null, // Deprecated - kept for type compatibility but always null
  enhancedPet: EnhancedPet | null,
  petProfileHash: string
): number {
  // If meal already has a score, use it
  if ('score' in meal && typeof (meal as ModifiedRecipeResult).score === 'number') {
    return Number((meal as ModifiedRecipeResult).score);
  }
  
  const recipeId = meal.recipe?.id || '';
  
  // Check individual recipe cache first
  if (recipeId) {
    const cachedScore = getCachedRecipeScore(recipeId, petProfileHash);
    if (cachedScore !== null) {
      return cachedScore;
    }
  }
  
  if (!enhancedPet) return 0;
  
  let score = 0;
  
  try {
    // Use enhanced compatibility scoring
    const enhanced = calculateEnhancedCompatibility(meal.recipe, enhancedPet);
    score = Number(enhanced.overallScore);
  } catch (error) {
    console.warn('Error scoring meal:', error);
    score = 0;
  }
  
  // Cache the computed score for future use
  if (recipeId && score > 0) {
    cacheRecipeScore(recipeId, score, petProfileHash);
  }
  
  return score;
}

/**
 * Hook for chunked recipe scoring
 * 
 * Processes meals in chunks using requestAnimationFrame to keep UI responsive
 */
export function useChunkedRecipeScoring(
  meals: (ModifiedRecipeResult | { recipe: Recipe; explanation: string })[],
  ratingPet: null, // Deprecated - using enhancedPet only
  enhancedPet: EnhancedPet | null
) {
  const [scoredMeals, setScoredMeals] = useState<ScoredMeal[]>([]);
  const [calibratedMeals, setCalibratedMeals] = useState<ScoredMeal[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [progress, setProgress] = useState(0);
  
  const chunkIndexRef = useRef(0);
  const frameIdRef = useRef<number | null>(null);
  const isMountedRef = useRef(true);

  // Generate pet profile hash for caching
  const petProfileHash = generatePetProfileHash(ratingPet, enhancedPet);

  // Check cache first
  useEffect(() => {
    if (meals.length === 0) {
      setScoredMeals([]);
      setIsLoading(false);
      setProgress(100);
      return;
    }

    const cached = getCachedScores(meals, petProfileHash);
    if (cached) {
      setScoredMeals(cached);
      setIsLoading(false);
      setProgress(100);
      return;
    }

    // Start chunked scoring
    setIsLoading(true);
    setProgress(0);
    setScoredMeals([]);
    chunkIndexRef.current = 0;
    isMountedRef.current = true;

    const processChunk = () => {
      if (!isMountedRef.current) return;

      const startIndex = chunkIndexRef.current;
      const endIndex = Math.min(startIndex + CHUNK_SIZE, meals.length);

      if (startIndex >= meals.length) {
        // All done - apply calibration before marking as complete
        setIsLoading(false);
        setProgress(100);
        return;
      }

      // Process current chunk
      const chunk = meals.slice(startIndex, endIndex);
      const newScores: ScoredMeal[] = chunk.map((meal, idx) => {
        const recipeId = meal.recipe?.id || `unknown-${startIndex + idx}`;
        const score = computeMealScore(meal, ratingPet, enhancedPet, petProfileHash);
        return {
          meal,
          score,
          recipeId,
        };
      });

      // Update state with new scores
      setScoredMeals(prev => {
        const updated = [...prev, ...newScores];
        // Sort as we go (optional - can defer to final sort)
        return updated;
      });

      // Update progress
      const newProgress = Math.floor((endIndex / meals.length) * 100);
      setProgress(newProgress);

      // Move to next chunk
      chunkIndexRef.current = endIndex;

      // Schedule next chunk
      frameIdRef.current = requestAnimationFrame(processChunk);
    };

    // Start processing
    frameIdRef.current = requestAnimationFrame(processChunk);

    return () => {
      isMountedRef.current = false;
      if (frameIdRef.current !== null) {
        cancelAnimationFrame(frameIdRef.current);
      }
    };
  }, [meals, petProfileHash, enhancedPet]);

  // Apply per-pet calibration when all scoring is complete
  useEffect(() => {
    if (!isLoading && scoredMeals.length > 0 && scoredMeals.length === meals.length && enhancedPet) {
      // Extract recipes from meals
      const recipes = meals.map(meal => meal.recipe).filter((r): r is Recipe => r !== undefined);
      
      if (recipes.length > 0) {
        // Apply calibration
        const calibratedScores = calibrateScoresForPet(recipes, enhancedPet);
        
        // Update scores with calibrated values
        const calibrated = scoredMeals.map(item => {
          const recipeId = item.recipeId;
          const calibratedScore = calibratedScores.get(recipeId);
          if (calibratedScore !== undefined) {
            return {
              ...item,
              score: calibratedScore,
            };
          }
          return item;
        });
        
        setCalibratedMeals(calibrated);
      } else {
        setCalibratedMeals(scoredMeals);
      }
    } else if (!isLoading && scoredMeals.length > 0 && scoredMeals.length === meals.length && !enhancedPet) {
      // No enhanced pet, skip calibration
      setCalibratedMeals(scoredMeals);
    }
  }, [isLoading, scoredMeals, meals, enhancedPet]);

  // Cache results when scoring completes (use calibrated scores)
  useEffect(() => {
    if (!isLoading && calibratedMeals.length > 0 && calibratedMeals.length === meals.length) {
      cacheScores(calibratedMeals, meals, petProfileHash);
    }
  }, [isLoading, calibratedMeals, meals, petProfileHash]);

  // Sort final results by score (descending) and format for rendering
  const scoredMealsToRender = useMemo(() => {
    const mealsToSort = calibratedMeals.length > 0 ? calibratedMeals : scoredMeals;
    const sorted = [...mealsToSort].sort((a, b) => {
      const scoreDiff = b.score - a.score;
      if (Math.abs(scoreDiff) > 0.001) {
        return scoreDiff;
      }
      // Tiebreaker: recipe ID
      return a.recipeId.localeCompare(b.recipeId);
    });

    return sorted.map(item => {
      if ('score' in item.meal && typeof (item.meal as ModifiedRecipeResult).score === 'number') {
        return { ...(item.meal as ModifiedRecipeResult), score: item.score };
      }
      return { ...item.meal, score: item.score };
    });
  }, [scoredMeals, calibratedMeals]);

  return {
    scoredMeals: scoredMealsToRender,
    isLoading,
    progress,
    totalMeals: meals.length,
    scoredCount: scoredMeals.length,
  };
}
</file>

<file path="lib/meal-plan-generator.ts">
// lib/meal-plan-generator.ts

// CORRECTED IMPORTS: Using absolute paths from the root ('@/')
import { Recipe, PetCategory, NutritionalRequirement } from '@/lib/types';
import { nutritionalGuidelines } from '@/lib/data/nutritional-guidelines';

/**
 * Defines the complete set of filtering criteria for a pet's profile.
 * Exported so it can be used in page.tsx.
 */
export interface PetProfile {
  category: PetCategory;
  ageGroup: string; // e.g., 'adult', 'puppy'
  breed: string | null; // e.g., 'labrador' or null
  healthConcern: string | null; // e.g., 'weight-management' or null
}

import { normalizeToSubtype } from '@/lib/utils/ingredientWhitelists';

/**
 * Check if recipe matches species/subtype (for meal plan generation)
 */
function matchesSpeciesForPlan(recipe: Recipe, profile: PetProfile): boolean {
  // Exact match
  if (recipe.category === profile.category) return true;
  
  // Subtype matching for exotics
  const subtype = normalizeToSubtype(profile.category as any, profile.breed || undefined);
  
  if (profile.category === 'birds') {
    // Allow generic bird recipes
    if (recipe.category === 'birds' || recipe.category === 'bird') return true;
    // Allow subtype-specific
    if (recipe.category === subtype) return true;
  }
  
  if (profile.category === 'reptiles') {    
    if (recipe.category === 'reptiles' || recipe.category === 'reptile') return true;
    if (recipe.category === subtype) return true;
  }
  
  if (profile.category === 'pocket-pets') {
    if (recipe.category === 'pocket-pets' || recipe.category === 'pocket-pet') return true;
    if (recipe.category === subtype) return true;
  }
  
  return false;
}

/**
 * Filters the master recipe list based on the pet's profile metadata.
 * Now supports subtype matching for exotic species.
 */
const filterRecipes = (profile: PetProfile): Recipe[] => {
  return recipes.filter(recipe => {
    // 1. Category/Subtype Match (Required)
    if (!matchesSpeciesForPlan(recipe, profile)) {
      return false;
    }

    // 2. Age Group Match (Required)
    // The recipe's ageGroup array must include the pet's ageGroup.
    if (!recipe.ageGroup.includes(profile.ageGroup)) {
      return false;
    }

    // 3. Breed Match (Optional - only applied if a breed is selected)
    // The recipe must either explicitly support the breed, or the recipe breed array is empty/null.
    if (profile.breed && recipe.breed && recipe.breed.length > 0) {
        if (!recipe.breed.includes(profile.breed)) {
            return false;
        }
    }
    
    // 4. Health Concern Match (Optional - only applied if a concern is selected)
    // The recipe's healthConcerns array must include the pet's health concern.
    if (profile.healthConcern && !recipe.healthConcerns.includes(profile.healthConcern)) {
      return false;
    }

    // If all checks pass, the recipe is suitable for the pet's profile.
    return true;
  });
};

/**
 * Generates a full weekly meal plan (14 meals total) from a pool of filtered recipes,
 * prioritizing variety and repeating recipes only if necessary.
 * Exported so it can be used in page.tsx.
 */
export const generateWeeklyMealPlan = (profile: PetProfile): Recipe[] => {
  const filteredRecipes = filterRecipes(profile);
  const mealPlan: Recipe[] = [];
  const requiredMeals = 14; // 7 days * 2 meals per day

  if (filteredRecipes.length === 0) {
    console.warn(`No recipes found for the selected profile: ${profile.category} - ${profile.ageGroup}. Returning placeholders.`);
    // Return a plan of placeholders if no recipes are found
    const placeholderRecipe: Recipe = {
        id: 'none',
        name: 'No Recipe Found',
        category: profile.category,
        ageGroup: ['adult'],
        healthConcerns: [],
        description: '',
        ingredients: [],
        instructions: [],
        tags: ['error'],
        rating: 0,
        reviews: 0,
        prepTime: '0 min',
        cookTime: '0 min',
        servings: 1
    };
    // Fill the 14-meal plan with the placeholder to prevent the UI from being empty
    return Array(requiredMeals).fill(placeholderRecipe);
  }

  // Use a temporary list to track recipes for variety
  let availableRecipes = [...filteredRecipes];

  // Loop to fill the 14-meal plan
  for (let i = 0; i < requiredMeals; i++) {
    // If we run out of unique recipes, refill the available list to allow repeats
    if (availableRecipes.length === 0) {
      availableRecipes = [...filteredRecipes];
    }

    // Randomly select a recipe from the current available list
    const randomIndex = Math.floor(Math.random() * availableRecipes.length);
    const selectedRecipe = availableRecipes[randomIndex];
    
    // Add the selected recipe to the plan
    mealPlan.push(selectedRecipe);

    // Remove the selected recipe from the available list to prevent immediate repetition
    availableRecipes.splice(randomIndex, 1);
  }

  return mealPlan;
};

/**
 * A utility function to retrieve the correct nutritional requirements.
 */
export const getRequiredGuidelines = (category: PetCategory, ageGroup: string): NutritionalRequirement | undefined => {
  const categoryGuidelines = nutritionalGuidelines[category];
  return categoryGuidelines[ageGroup as keyof typeof categoryGuidelines];
};
</file>

<file path="lib/modifierRules.ts">
import { IngredientOption, ModifierRule, Species } from '@/lib/types';

export const ingredientAlternatives: Record<string, string[]> = {
  chicken: ['turkey', 'duck', 'rabbit'],
  beef: ['venison', 'bison', 'lamb'],
  wheat: ['oats', 'quinoa', 'buckwheat'],
  rice: ['sweet potato', 'pumpkin', 'butternut squash'],
  dairy: ['goat milk kefir', 'bone broth'],
  salmon: ['sardine', 'mackerel', 'anchovy'],
};

export const healthConcernGuidelines: Record<
  string,
  {
    focus: string;
    avoid?: string[];
    preferredIngredients?: string[];
    supplementIdeas?: string[];
  }
> = {
  allergies: {
    focus: 'Novel proteins + anti-inflammatory omegas',
    avoid: ['chicken', 'beef', 'wheat'],
    preferredIngredients: ['duck', 'rabbit', 'pumpkin'],
    supplementIdeas: ['fish oil', 'quercetin'],
  },
  'weight-management': {
    focus: 'Lower calorie density, higher fiber for satiety',
    avoid: ['rendered fats', 'simple carbs'],
    preferredIngredients: ['green beans', 'lean turkey', 'cauliflower rice'],
    supplementIdeas: ['L-carnitine'],
  },
  'joint-health': {
    focus: 'Anti-inflammatory fats + joint supplements',
    preferredIngredients: ['wild salmon', 'turmeric', 'bone broth'],
    supplementIdeas: ['glucosamine', 'fish oil'],
  },
  digestive: {
    focus: 'Gentle proteins + prebiotic fiber + probiotics',
    avoid: ['dairy', 'fried fats', 'spices'],
    preferredIngredients: ['pumpkin', 'bone broth', 'cooked rice'],
    supplementIdeas: ['probiotics'],
  },
  kidney: {
    focus: 'Controlled phosphorus, moderate protein, high moisture',
    avoid: ['organ meats high in phosphorus'],
    preferredIngredients: ['white fish', 'egg whites', 'low-sodium broth'],
    supplementIdeas: ['omega-3 fish oil'],
  },
  'urinary-health': {
    focus: 'Moisture + urinary acidifiers',
    preferredIngredients: ['bone broth', 'cranberry', 'DL-methionine'],
  },
  diabetes: {
    focus: 'High protein, very low carbs, consistent calories',
    avoid: ['high-sugar', 'simple-carbs', 'corn-syrup', 'white-rice'],
    preferredIngredients: ['lean-protein', 'complex-carbs', 'high-fiber-vegetables'],
    supplementIdeas: ['chromium', 'alpha-lipoic-acid'],
  },
  hyperthyroidism: {
    focus: 'Controlled iodine + higher calories to offset metabolism',
  },
  pancreatitis: {
    focus: 'Ultra low fat, easily digestible proteins, MCT support',
    avoid: ['high-fat', 'pork', 'lamb', 'duck', 'fried', 'greasy', 'fatty-cuts'],
    preferredIngredients: ['lean-turkey', 'white-fish', 'chicken-breast', 'pumpkin'],
    supplementIdeas: ['digestive-enzymes', 'probiotics'],
  },
  'heart-disease': {
    focus: 'Low sodium, taurine-rich, omega-3 support, controlled calories',
    avoid: ['high-sodium', 'processed', 'excessive-fat'],
    preferredIngredients: ['lean-protein', 'omega-3-rich-fish', 'taurine-sources'],
    supplementIdeas: ['taurine', 'omega-3', 'coenzyme-q10'],
  },
  'heart disease': {
    focus: 'Low sodium, taurine-rich, omega-3 support, controlled calories',
    avoid: ['high-sodium', 'processed', 'excessive-fat'],
    preferredIngredients: ['lean-protein', 'omega-3-rich-fish', 'taurine-sources'],
    supplementIdeas: ['taurine', 'omega-3', 'coenzyme-q10'],
  },
  'skin-conditions': {
    focus: 'Omega-3 rich, quality protein, vitamin E, anti-inflammatory',
    avoid: ['artificial-colors', 'preservatives', 'low-quality-protein'],
    preferredIngredients: ['salmon', 'sardines', 'sweet-potato', 'pumpkin'],
    supplementIdeas: ['omega-3', 'vitamin-e', 'zinc', 'biotin'],
  },
  'skin conditions': {
    focus: 'Omega-3 rich, quality protein, vitamin E, anti-inflammatory',
    avoid: ['artificial-colors', 'preservatives', 'low-quality-protein'],
    preferredIngredients: ['salmon', 'sardines', 'sweet-potato', 'pumpkin'],
    supplementIdeas: ['omega-3', 'vitamin-e', 'zinc', 'biotin'],
  },
  hairball: {
    focus: 'Insoluble & soluble fiber blend + omega oils',
  },
};

export const breedPredispositions: Record<
  string,
  {
    concerns: string[];
    notes: string;
  }
> = {
  labrador: {
    concerns: ['weight-management', 'joint-health'],
    notes: 'Prone to obesity and hip dysplasia; monitor calories and joints.',
  },
  'german-shepherd': {
    concerns: ['joint-health', 'digestive'],
    notes: 'Hip issues and sensitive gut benefit from joint + probiotic support.',
  },
  'golden-retriever': {
    concerns: ['joint-health', 'allergies'],
    notes: 'Seasonal allergies and hips respond to omega-3s.',
  },
  beagle: {
    concerns: ['weight-management'],
    notes: 'Small frame with big appetite ‚Äì portion discipline is critical.',
  },
  mainecoon: {
    concerns: ['joint-health', 'heart'],
    notes: 'Large frame cats need taurine and joint support.',
  },
  siamese: {
    concerns: ['hyperthyroidism'],
    notes: 'Breed predisposition for thyroid imbalance.',
  },
  persian: {
    concerns: ['hairball', 'urinary-health'],
    notes: 'Long coats and kidney sensitivities.',
  },
};

export const healthConcernCalorieAdjustments: Record<string, number> = {
  'weight-management': -20,
  obesity: -20,
  allergies: 0,
  'joint-health': -5,
  digestive: -5,
  kidney: -10,
  'urinary-health': -5,
  diabetes: -15,
  hyperthyroidism: +10,
  pancreatitis: -15,
  hairball: 0,
};

const addIngredient = (
  options: IngredientOption[],
  weightKg: number
): IngredientOption[] =>
  options.map((opt) => {
    if (!opt.amountPer10kg) {
      return opt;
    }
    const numeric = parseFloat(opt.amountPer10kg);
    if (Number.isNaN(numeric)) {
      return { ...opt, amount: opt.amountPer10kg };
    }
    const amountValue = ((weightKg / 10) * numeric).toFixed(0);
    const unit = opt.amountPer10kg.replace(/[0-9.]/g, '').trim() || 'g';
    return {
      ...opt,
      amount: `${amountValue}${unit}`,
    };
  });

export const modifierRules: ModifierRule[] = [
  {
    id: 'mod-allergies-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['allergies'],
    },
    ingredientChanges: {
      remove: ['chicken', 'beef', 'wheat'],
      substitute: [
        { from: 'chicken', to: 'turkey breast' },
        { from: 'beef', to: 'venison' },
      ],
      add: [
        {
          name: 'Pumpkin Puree',
          amountPer10kg: '50g',
          amazonLink: 'https://www.amazon.com/s?k=organic+pumpkin+puree+dog',
          notes: 'Adds fiber & beta carotene for gut healing.',
        },
        {
          name: 'Fish Oil Supplement',
          amountPer10kg: '250mg',
          amazonLink: 'https://www.amazon.com/s?k=dog+fish+oil',
          notes: 'Provides EPA/DHA for anti-inflammatory support.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 15,
    },
    rationale:
      'Removes common allergens and boosts anti-inflammatory omega-3 intake.',
    ruleWeight: 12,
  },
  {
    id: 'mod-weight-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['weight-management', 'obesity'],
    },
    ingredientChanges: {
      add: [
        {
          name: 'Green Bean Fiber Boost',
          amountPer10kg: '80g',
          amazonLink: 'https://www.amazon.com/s?k=freeze+dried+green+beans+dog',
          notes: 'Adds bulk without calories.',
        },
      ],
      substitute: [{ from: 'white rice', to: 'steamed cauliflower rice' }],
    },
    nutritionalTargets: {
      fatMax: 12,
      caloriesAdjust: -20,
    },
    rationale:
      'Increases fiber and swaps starches to support caloric deficit safely.',
    ruleWeight: 15,
  },
  {
    id: 'mod-joints-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['joint-health', 'arthritis'],
      ageGroups: ['senior'],
    },
    ingredientChanges: {
      add: [
        {
          name: 'Fish Oil Supplement',
          amountPer10kg: '250mg',
          amazonLink: 'https://www.amazon.com/s?k=fish+oil+for+dogs',
          notes: 'EPA/DHA for inflammation control.',
        },
        {
          name: 'Golden Paste (Turmeric + Black Pepper)',
          amountPer10kg: '10g',
          amazonLink: 'https://www.amazon.com/s?k=turmeric+paste+dog',
          notes: 'Natural COX-2 inhibitor to ease joint pain.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 15,
    },
    rationale: 'Supports anti-inflammatory pathways in senior joints.',
    ruleWeight: 14,
  },
  {
    id: 'mod-digest-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['digestive'],
    },
    ingredientChanges: {
      remove: ['dairy'],
      add: [
        {
          name: 'Bone Broth',
          amountPer10kg: '120ml',
          amazonLink: 'https://www.amazon.com/s?k=dog+bone+broth',
          notes: 'Adds collagen + hydration for gut lining.',
        },
        {
          name: 'Probiotic Powder',
          amountPer10kg: '1g',
          amazonLink: 'https://www.amazon.com/s?k=dog+probiotic+powder',
          notes: 'Rebalances microbiome after GI upset.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 14,
    },
    rationale:
      'Removes irritants, increases moisture, and replenishes beneficial bacteria.',
    ruleWeight: 11,
  },
  {
    id: 'mod-kidney-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['kidney'],
    },
    ingredientChanges: {
      remove: ['organ meat'],
      substitute: [{ from: 'bone meal', to: 'egg shell powder' }],
      add: [
        {
          name: 'Low-Sodium Bone Broth',
          amountPer10kg: '150ml',
          notes: 'Boosts hydration without excess sodium.',
        },
        {
          name: 'Omega-3 Fish Oil',
          amountPer10kg: '200mg',
          amazonLink: 'https://www.amazon.com/s?k=renal+support+fish+oil+dog',
          notes: 'Slows kidney inflammation.',
        },
      ],
    },
    nutritionalTargets: {
      proteinMin: 18,
      phosphorusMax: 0.6,
      fatMax: 14,
    },
    rationale: 'Controls phosphorus and supports renal hydration.',
    ruleWeight: 16,
  },
  {
    id: 'mod-urinary-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['urinary-health'],
    },
    ingredientChanges: {
      add: [
        {
          name: 'Unsalted Bone Broth',
          amountPer10kg: '120ml',
          notes: 'Raises moisture intake to dilute urine.',
        },
        {
          name: 'Cranberry Powder',
          amountPer10kg: '500mg',
          amazonLink: 'https://www.amazon.com/s?k=cranberry+cat+urinary',
          notes: 'Helps acidify urine to reduce crystals.',
        },
      ],
    },
    nutritionalTargets: {
      phosphorusMax: 0.7,
    },
    rationale:
      'Increases moisture and adds mild acidifiers for urinary tract protection.',
    ruleWeight: 15,
  },
  {
    id: 'mod-diabetes-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['diabetes'],
    },
    ingredientChanges: {
      remove: ['white rice', 'peas'],
      substitute: [{ from: 'sweet potato', to: 'steamed zucchini' }],
      add: [
        {
          name: 'Chromium + Cinnamon Blend',
          amountPer10kg: '250mg',
          notes: 'Helps insulin sensitivity (vet-approved doses).',
        },
      ],
    },
    nutritionalTargets: {
      proteinMin: 40,
      fatMax: 18,
      caloriesAdjust: -10,
    },
    rationale: 'Cuts starches and supports glycemic control.',
    ruleWeight: 16,
  },
  {
    id: 'mod-hyperthyroid-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['hyperthyroidism'],
    },
    ingredientChanges: {
      add: [
        {
          name: 'L-Carnitine Supplement',
          amountPer10kg: '200mg',
          amazonLink: 'https://www.amazon.com/s?k=l-carnitine+for+cats',
          notes: 'Supports muscle mass during hypermetabolic states.',
        },
      ],
      substitute: [{ from: 'kelp', to: 'dulse (low iodine)' }],
    },
    nutritionalTargets: {
      proteinMin: 42,
      caloriesAdjust: +10,
    },
    rationale:
      'Maintains lean mass and avoids iodine spikes that can worsen thyroid storms.',
    ruleWeight: 12,
  },
  {
    id: 'mod-pancreatitis-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['pancreatitis'],
    },
    ingredientChanges: {
      remove: ['salmon skin', 'added oils'],
      add: [
        {
          name: 'Skinless White Fish',
          amountPer10kg: '120g',
          notes: 'Ultra-lean protein swap to rest pancreas.',
        },
        {
          name: 'MCT Oil (Caprylic/Capric)',
          amountPer10kg: '3ml',
          notes: 'Easy energy source without pancreatic enzymes.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 10,
    },
    rationale: 'Removes fats requiring pancreatic lipase and adds safe energy.',
    ruleWeight: 17,
  },
  {
    id: 'mod-hairball-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['hairball'],
    },
    ingredientChanges: {
      add: [
        {
          name: 'Psyllium Husk',
          amountPer10kg: '1g',
          notes: 'Adds soluble fiber to move ingested hair.',
        },
        {
          name: 'Sardine Oil',
          amountPer10kg: '150mg',
          amazonLink: 'https://www.amazon.com/s?k=sardine+oil+for+cats',
          notes: 'Lubricates GI tract and boosts omegas for coat.',
        },
      ],
    },
    nutritionalTargets: {},
    rationale: 'Fibers plus omegas reduce shedding and lubricate transit.',
    ruleWeight: 10,
  },
  {
    id: 'mod-heart-disease-dog-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['heart-disease', 'heart disease'],
    },
    ingredientChanges: {
      remove: ['high-sodium', 'processed'],
      add: [
        {
          name: 'Taurine Supplement',
          amountPer10kg: '500mg',
          amazonLink: 'https://www.amazon.com/s?k=taurine+supplement+dog',
          notes: 'Essential amino acid for heart muscle function.',
        },
        {
          name: 'Omega-3 Fish Oil',
          amountPer10kg: '300mg',
          amazonLink: 'https://www.amazon.com/s?k=omega-3+fish+oil+dog',
          notes: 'EPA/DHA support cardiovascular health.',
        },
        {
          name: 'Coenzyme Q10',
          amountPer10kg: '30mg',
          amazonLink: 'https://www.amazon.com/s?k=coq10+for+dogs',
          notes: 'Supports heart muscle energy production.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 15,
      sodiumMax: 0.3,
    },
    rationale: 'Low sodium, taurine-rich diet with omega-3 support for cardiac function.',
    ruleWeight: 18,
  },
  {
    id: 'mod-heart-disease-cat-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['heart-disease', 'heart disease'],
    },
    ingredientChanges: {
      remove: ['high-sodium', 'processed'],
      add: [
        {
          name: 'Taurine Supplement',
          amountPer10kg: '250mg',
          amazonLink: 'https://www.amazon.com/s?k=taurine+supplement+cat',
          notes: 'Critical for feline heart health - cats cannot synthesize taurine.',
        },
        {
          name: 'Omega-3 Fish Oil',
          amountPer10kg: '200mg',
          amazonLink: 'https://www.amazon.com/s?k=omega-3+fish+oil+cat',
          notes: 'EPA/DHA for cardiovascular support.',
        },
        {
          name: 'L-Carnitine',
          amountPer10kg: '250mg',
          amazonLink: 'https://www.amazon.com/s?k=l-carnitine+for+cats',
          notes: 'Supports heart muscle metabolism.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 15,
      sodiumMax: 0.25,
      proteinMin: 40,
    },
    rationale: 'Taurine-rich, low-sodium diet essential for feline cardiac health.',
    ruleWeight: 20,
  },
  {
    id: 'mod-skin-conditions-dog-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['skin-conditions', 'skin conditions'],
    },
    ingredientChanges: {
      remove: ['artificial-colors', 'preservatives'],
      add: [
        {
          name: 'Omega-3 Fish Oil',
          amountPer10kg: '400mg',
          amazonLink: 'https://www.amazon.com/s?k=omega-3+fish+oil+dog',
          notes: 'Anti-inflammatory omega-3s for skin health.',
        },
        {
          name: 'Vitamin E Supplement',
          amountPer10kg: '100IU',
          amazonLink: 'https://www.amazon.com/s?k=vitamin+e+for+dogs',
          notes: 'Antioxidant support for skin barrier function.',
        },
        {
          name: 'Zinc Supplement',
          amountPer10kg: '15mg',
          amazonLink: 'https://www.amazon.com/s?k=zinc+supplement+dog',
          notes: 'Essential for skin healing and immune function.',
        },
      ],
    },
    nutritionalTargets: {
      fatMin: 10,
    },
    rationale: 'Omega-3s, vitamin E, and zinc support healthy skin barrier and reduce inflammation.',
    ruleWeight: 14,
  },
  {
    id: 'mod-skin-conditions-cat-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['skin-conditions', 'skin conditions'],
    },
    ingredientChanges: {
      remove: ['artificial-colors', 'preservatives'],
      add: [
        {
          name: 'Omega-3 Fish Oil',
          amountPer10kg: '300mg',
          amazonLink: 'https://www.amazon.com/s?k=omega-3+fish+oil+cat',
          notes: 'EPA/DHA for skin health and anti-inflammatory support.',
        },
        {
          name: 'Biotin Supplement',
          amountPer10kg: '250mcg',
          amazonLink: 'https://www.amazon.com/s?k=biotin+for+cats',
          notes: 'B-vitamin essential for healthy skin and coat.',
        },
        {
          name: 'Vitamin E',
          amountPer10kg: '50IU',
          amazonLink: 'https://www.amazon.com/s?k=vitamin+e+for+cats',
          notes: 'Antioxidant for skin barrier protection.',
        },
      ],
    },
    nutritionalTargets: {
      fatMin: 12,
      proteinMin: 38,
    },
    rationale: 'Quality protein, omega-3s, and skin-supporting vitamins for healthy coat.',
    ruleWeight: 15,
  },
  {
    id: 'mod-diabetes-dog-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['diabetes'],
    },
    ingredientChanges: {
      remove: ['high-sugar', 'simple-carbs', 'corn-syrup', 'white-rice'],
      substitute: [
        { from: 'white rice', to: 'steamed cauliflower rice' },
        { from: 'sweet potato', to: 'green beans' },
      ],
      add: [
        {
          name: 'Chromium Supplement',
          amountPer10kg: '50mcg',
          amazonLink: 'https://www.amazon.com/s?k=chromium+supplement+dog',
          notes: 'Helps improve insulin sensitivity.',
        },
        {
          name: 'Alpha-Lipoic Acid',
          amountPer10kg: '25mg',
          amazonLink: 'https://www.amazon.com/s?k=alpha-lipoic-acid+dog',
          notes: 'Antioxidant that may help with glucose metabolism.',
        },
      ],
    },
    nutritionalTargets: {
      proteinMin: 25,
      fatMax: 15,
      caloriesAdjust: -10,
    },
    rationale: 'Low-glycemic, high-protein diet with consistent calories for blood sugar control.',
    ruleWeight: 17,
  },
  {
    id: 'mod-diabetes-cat-01',
    appliesTo: {
      species: ['cats'],
      healthConcerns: ['diabetes'],
    },
    ingredientChanges: {
      remove: ['high-sugar', 'simple-carbs', 'corn-syrup', 'white-rice'],
      substitute: [
        { from: 'white rice', to: 'steamed cauliflower rice' },
        { from: 'sweet potato', to: 'green beans' },
      ],
      add: [
        {
          name: 'Chromium Supplement',
          amountPer10kg: '25mcg',
          amazonLink: 'https://www.amazon.com/s?k=chromium+supplement+cat',
          notes: 'Helps improve insulin sensitivity in cats.',
        },
        {
          name: 'Alpha-Lipoic Acid',
          amountPer10kg: '15mg',
          amazonLink: 'https://www.amazon.com/s?k=alpha-lipoic-acid+cat',
          notes: 'Antioxidant support for glucose metabolism.',
        },
      ],
    },
    nutritionalTargets: {
      proteinMin: 40,
      fatMax: 15,
      caloriesAdjust: -10,
    },
    rationale: 'High-protein, low-carb diet with consistent calories for feline diabetes management.',
    ruleWeight: 18,
  },
  {
    id: 'mod-pancreatitis-dog-01',
    appliesTo: {
      species: ['dogs'],
      healthConcerns: ['pancreatitis'],
    },
    ingredientChanges: {
      remove: ['high-fat', 'pork', 'lamb', 'duck', 'fried', 'greasy'],
      substitute: [
        { from: 'ground beef', to: 'lean turkey breast' },
        { from: 'salmon', to: 'white fish (cod/tilapia)' },
      ],
      add: [
        {
          name: 'MCT Oil',
          amountPer10kg: '5ml',
          amazonLink: 'https://www.amazon.com/s?k=mct+oil+for+dogs',
          notes: 'Easy energy source that bypasses pancreatic enzymes.',
        },
        {
          name: 'Digestive Enzymes',
          amountPer10kg: '1 capsule',
          amazonLink: 'https://www.amazon.com/s?k=digestive+enzymes+dog',
          notes: 'Supports digestion during pancreatic recovery.',
        },
        {
          name: 'Probiotics',
          amountPer10kg: '1g',
          amazonLink: 'https://www.amazon.com/s?k=probiotics+for+dogs',
          notes: 'Supports gut health during low-fat diet.',
        },
      ],
    },
    nutritionalTargets: {
      fatMax: 10,
    },
    rationale: 'Ultra-low fat diet with easily digestible proteins to rest the pancreas.',
    ruleWeight: 19,
  },
];

/**
 * Utility helper to inject weight-aware additions inline.
 * Exported for tests and future dynamic adjustments.
 */
export const expandWeightAwareIngredients = (
  additions: IngredientOption[] | undefined,
  weightKg: number
): IngredientOption[] => {
  if (!additions?.length) return [];
  return addIngredient(additions, weightKg);
};
</file>

<file path="lib/nutrition/nutritionHistory.ts">
import type { Recipe } from '@/lib/types';

export interface DailyNutrition {
  day: string;
  calories: number;
  protein: number;
  fat: number;
  carbs: number;
  fiber?: number;
}

export interface NutritionTargets {
  calories?: number;
  proteinRange?: [number, number];
  fatRange?: [number, number];
  carbsRange?: [number, number];
  fiberRange?: [number, number];
}

const safeNumber = (value: any, fallback = 0) => {
  const n = Number(value);
  return Number.isFinite(n) ? n : fallback;
};

const extractRecipeNutrition = (recipe: Recipe) => {
  // Prefer nutritionalCalculation if present (for custom meals)
  const calc = (recipe as any).nutritionalCalculation || (recipe as any).nutrition;
  if (calc) {
    return {
      calories: safeNumber(calc.calories),
      protein: safeNumber(calc.protein),
      fat: safeNumber(calc.fat),
      carbs: safeNumber(calc.carbs),
      fiber: safeNumber(calc.fiber),
    };
  }

  // Extract from nutritionalInfo (recipes-complete.ts format)
  const info = recipe.nutritionalInfo || {};
  
  // Calories are stored as absolute kcal values
  const calories = safeNumber(
    info.calories?.min || info.calories?.max || 
    parseFloat((recipe.nutritionInfo?.calories || '').replace(/[^0-9.]/g, '')) || 
    300
  );

  // Protein, fat, carbs, fiber are stored as percentages
  // Estimate serving size from calories (rough: ~4 kcal per gram average)
  // Then convert percentages to grams
  const estimatedServingGrams = calories / 3.5; // ~3.5 kcal/g average for pet food
  
  const proteinPercent = safeNumber(info.protein?.min || info.protein?.max || 0);
  const fatPercent = safeNumber(info.fat?.min || info.fat?.max || 0);
  const fiberPercent = safeNumber(info.fiber?.min || info.fiber?.max || 0);
  
  // Estimate carbs as remainder (100% - protein% - fat% - fiber% - water/ash ~70%)
  // Or use a conservative estimate
  const carbsPercent = Math.max(0, 100 - proteinPercent - fatPercent - fiberPercent - 70);
  
  return {
    calories,
    protein: (proteinPercent / 100) * estimatedServingGrams,
    fat: (fatPercent / 100) * estimatedServingGrams,
    carbs: (carbsPercent / 100) * estimatedServingGrams,
    fiber: (fiberPercent / 100) * estimatedServingGrams,
  };
};

export function calculateDailyNutrition(plan: { day: string; meals: Recipe[] }[]): DailyNutrition[] {
  return plan.map(({ day, meals }) => {
    const totals = meals.reduce(
      (acc, meal) => {
        const n = extractRecipeNutrition(meal);
        acc.calories += n.calories;
        acc.protein += n.protein;
        acc.fat += n.fat;
        acc.carbs += n.carbs;
        acc.fiber += n.fiber || 0;
        return acc;
      },
      { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0 }
    );
    return {
      day,
      calories: Math.round(totals.calories),
      protein: Number(totals.protein.toFixed(1)),
      fat: Number(totals.fat.toFixed(1)),
      carbs: Number(totals.carbs.toFixed(1)),
      fiber: Number(totals.fiber.toFixed(1)),
    };
  });
}

export function getNutritionTargets(species?: string): NutritionTargets {
  const key = (species || '').toLowerCase();
  if (key.includes('cat')) {
    return { proteinRange: [28, 45], fatRange: [9, 20], calories: undefined };
  }
  if (key.includes('bird')) {
    return { proteinRange: [12, 22], fatRange: [4, 12] };
  }
  if (key.includes('reptile')) {
    return { proteinRange: [15, 28], fatRange: [4, 12] };
  }
  if (key.includes('pocket')) {
    return { proteinRange: [12, 20], fatRange: [2, 8], fiberRange: [15, 30] };
  }
  // Default dog
  return { proteinRange: [18, 35], fatRange: [8, 22] };
}
</file>

<file path="lib/portionCalc.ts">
import { PortionPlan, Recipe, Species, PetNutritionProfile } from '@/lib/types';
import { healthConcernCalorieAdjustments } from './modifierRules';

const DEFAULT_CALORIES_PER_KG: Record<Species, number> = {
  dogs: 95,
  cats: 75,
};

const AGE_ADJUSTMENTS: Record<string, number> = {
  baby: +15,
  young: +5,
  adult: 0,
  senior: -10,
};

const clamp = (value: number, min: number, max: number) =>
  Math.min(Math.max(value, min), max);

const UNIT_TO_GRAMS: Record<string, number> = {
  g: 1,
  gram: 1,
  grams: 1,
  kg: 1000,
  mg: 0.001,
  oz: 28.35,
  ounce: 28.35,
  ounces: 28.35,
  lb: 453.59,
  lbs: 453.59,
  cup: 120,
  cups: 120,
  tbsp: 15,
  tablespoon: 15,
  tablespoons: 15,
  tsp: 5,
  teaspoon: 5,
  teaspoons: 5,
  ml: 1,
  liter: 1000,
};

const parseAmountToGrams = (amount: string | undefined): number => {
  if (!amount) return 0;
  const numericMatch = amount.match(/[\d.]+/);
  if (!numericMatch) return 0;
  const quantity = parseFloat(numericMatch[0]);
  const unit = amount
    .replace(numericMatch[0], '')
    .trim()
    .toLowerCase()
    .replace(/[^a-z]/g, '');
  if (!unit) return quantity;
  const conversion = UNIT_TO_GRAMS[unit];
  return conversion ? quantity * conversion : quantity;
};

const parseCalories = (calorieString: string | undefined): number | null => {
  if (!calorieString) return null;
  const numericMatch = calorieString.match(/[\d.]+/);
  if (!numericMatch) return null;
  return parseFloat(numericMatch[0]);
};

export const calculateDailyPortion = (
  weightKg: number,
  caloriesPerKg: number
): number => Math.round(weightKg * caloriesPerKg);

export const getCaloriesPerKg = (
  profile: PetNutritionProfile
): { caloriesPerKg: number; notes: string[] } => {
  if (profile.caloriesPerKgOverride) {
    return {
      caloriesPerKg: profile.caloriesPerKgOverride,
      notes: ['User override applied'],
    };
  }

  const base = DEFAULT_CALORIES_PER_KG[profile.species];
  let caloriesPerKg = base;
  const notes: string[] = [`Base MER ${base} kcal/kg for ${profile.species}`];

  const ageAdj = AGE_ADJUSTMENTS[profile.ageGroup];
  if (typeof ageAdj === 'number' && ageAdj !== 0) {
    caloriesPerKg += ageAdj;
    notes.push(
      `Age adjustment (${profile.ageGroup}): ${
        ageAdj > 0 ? '+' : ''
      }${ageAdj} kcal/kg`
    );
  }

  (profile.healthConcerns || []).forEach((concern) => {
    const adj =
      healthConcernCalorieAdjustments[concern] ??
      healthConcernCalorieAdjustments[concern.replace(/\s+/g, '-').toLowerCase()];
    if (typeof adj === 'number' && adj !== 0) {
      caloriesPerKg += adj;
      notes.push(
        `Health adjustment (${concern}): ${adj > 0 ? '+' : ''}${adj} kcal/kg`
      );
    }
  });

  const clamped = clamp(caloriesPerKg, 55, 140);
  if (clamped !== caloriesPerKg) {
    notes.push('Calorie target clamped to safe bounds (55-140 kcal/kg).');
  }

  return {
    caloriesPerKg: clamped,
    notes,
  };
};

export const getPortionPlan = (
  recipe: Recipe,
  profile: PetNutritionProfile
): PortionPlan => {
  const { caloriesPerKg, notes } = getCaloriesPerKg(profile);
  const dailyCalories = calculateDailyPortion(profile.weightKg, caloriesPerKg);

  const recipeCalories =
    recipe.nutritionalInfo?.calories?.min ||
    recipe.nutritionalInfo?.calories?.max ||
    parseCalories(recipe.nutritionInfo?.calories) ||
    350;

  const baseIngredientWeight = recipe.ingredients.reduce(
    (sum, ingredient) => sum + parseAmountToGrams(ingredient.amount),
    0
  );

  const multiplier = recipeCalories
    ? clamp(dailyCalories / recipeCalories, 0.3, 3)
    : 1;

  const dailyPortionGrams = Math.round(baseIngredientWeight * multiplier);
  const weeklyCalories = dailyCalories * 7;
  const weeklyPortionGrams = dailyPortionGrams * 7;

  return {
    dailyGrams: dailyPortionGrams,
    mealsPerDay: 2, // Default to 2 meals per day
    multiplier,
    caloriesPerKg,
    dailyCalories,
    weeklyCalories,
    dailyPortionGrams,
    weeklyPortionGrams,
    notes,
  };
};

export const scaleAmount = (
  amount: string | undefined,
  multiplier: number
): string | undefined => {
  if (!amount) return amount;
  const numericMatch = amount.match(/[\d.]+/);
  if (!numericMatch) return amount;
  const quantity = parseFloat(numericMatch[0]);
  if (Number.isNaN(quantity)) return amount;
  const scaled = (quantity * multiplier).toFixed(1).replace(/\.0$/, '');
  return amount.replace(numericMatch[0], scaled);
};
</file>

<file path="lib/quoteGenerator.ts">
// lib/quoteGenerator.ts
import type { Recipe } from './types';

/**
 * Deterministic quote generator for recipes.
 * - Always returns the same quote for the same recipe.id
 * - Generates a celebrity-pet author name based on category
 * - Ensures the quote text is unique per recipe by incorporating a
 *   deterministic short adjective/phrase derived from the recipe id/hash.
 *
 * This avoids storing a separate map of 175 entries while guaranteeing
 * each recipe has a permanent, non-reused quote style.
 */

const CELEB_POOLS: Record<string, string[]> = {
  dogs: [
    'Bark Obama','Mutt Damon','Chew-barka','Salvador Dogi','Hairy Styles',
    'Droolius Caesar','Sherlock Bones','Bark Twain','Jimmy Chew','Snoop Doggy Dog'
  ],
  cats: [
    'Catrick Swayze','Leonardo DiCatrio','Meowly Cyrus','Purr-ince','Cat Damon',
    'William Shakespaw','Clawdia Schiffer','Fur-dinand Magellan','Meowrio Andretti','Kitty Purry'
  ],
  birds: [
    'Tweety Mercury','Squawkstin Bieber','Chirp Cobain','Feather Locklear','Beaky Blinders',
    'Wing Crosby','Tweetie Poppins','Beak Affleck','Fluffy Gaga','Plume Hathaway'
  ],
  reptiles: [
    'Scale-y Cyrus','Lizard of Oz','Geck-o Washington','Rango Stallone','Sir Hissington',
    'Gila Clooney','Scaley Cooper','Rex Sauron','Iggy Pop','Cold-Blooded Coleman'
  ],
  'pocket-pets': [
    'Ham Solo','Bun Jovi','Whisker Nelson','Gerbil Gates','Puff Daddy',
    'Fuzz Aldrin','Pipsqueak Jordan','Squeakers O\'Neal','Nibble Newton','Buckminster Fuzz'
  ],
};

// Adjective/phrases to make each quote unique; deterministic selection via recipe id
const TAGS = [
  'a tail-wagging triumph',
  'a purrfect bite',
  'a feather-ruffling delight',
  'a scales-approved staple',
  'a hop-and-nibble favorite',
  'a culinary comfort',
  'an epic chew-fest',
  'a snooze-and-savor meal',
  'a barkworthy banquet',
  'a whisker-twitching wonder',
  'a chirp-causing classic',
  'a slippery-sweet supper',
  'an anxious-belly soother',
  'a crunchy, chewy celebration',
  'a slow-cooked nostalgia'
];

function hashStringToNumber(s: string) {
  // simple deterministic hash to number
  let h = 2166136261 >>> 0;
  for (let i = 0; i < s.length; i++) {
    h = Math.imul(h ^ s.charCodeAt(i), 16777619);
  }
  return Math.abs(h);
}

export function getQuoteForRecipe(recipe: Recipe) {
  const cat = recipe.category ?? 'dogs';
  const pool = CELEB_POOLS[cat] ?? CELEB_POOLS.dogs;
  const idHash = hashStringToNumber(recipe.id || recipe.name || JSON.stringify(recipe)).toString();
  const celebIndex = Number(idHash.slice(-2)) % pool.length;
  const tagIndex = Number(idHash.slice(0, 2)) % TAGS.length;

  const author = pool[celebIndex];
  const tag = TAGS[tagIndex];

  // Build a short, persona-appropriate quote (in the voice of the celeb-pet)
  // We add the recipe name to make the quote unique and clearly tied to this dish.
  const shortRecipeName = recipe.name?.split(':')[0] ?? recipe.name ?? 'this dish';

  // Tone templates per animal type to add variety
  const templates: Record<string, string[]> = {
    dogs: [
      `As I always say, ${shortRecipeName} is ${tag}.`,
      `My fellow canines, try ${shortRecipeName} ‚Äî ${tag}.`,
      `If you enjoy bones, you'll adore ${shortRecipeName}; truly ${tag}.`
    ],
    cats: [
      `I declare ${shortRecipeName} to be absolutely ${tag}.`,
      `In my refined opinion, ${shortRecipeName} is ${tag}.`,
      `Paws down ‚Äî ${shortRecipeName} is ${tag}.`
    ],
    birds: [
      `${shortRecipeName} made me chirp ‚Äî ${tag}.`,
      `Squawk: ${shortRecipeName} equals ${tag}.`,
      `If it makes me preen, it's ${shortRecipeName} ‚Äî truly ${tag}.`
    ],
    reptiles: [
      `${shortRecipeName} is slow-cooked and ${tag}.`,
      `Cold-bloodedly, ${shortRecipeName} is ${tag}.`,
      `Scale-tested: ${shortRecipeName} is ${tag}.`
    ],
    'pocket-pets': [
      `${shortRecipeName} is tiny but ${tag}.`,
      `Nibble-approved: ${shortRecipeName} is ${tag}.`,
      `Small meal, big joy ‚Äî ${shortRecipeName} is ${tag}.`
    ],
  };

  const templatesForCat = templates[cat] ?? templates.dogs;
  const template = templatesForCat[Number(idHash.slice(-1)) % templatesForCat.length];

  const text = template;

  return {
    author,
    text,
  };
}

export default getQuoteForRecipe;
</file>

<file path="lib/recipe-generator-legacy.ts">
/**
 * LEGACY RECIPE GENERATOR - DEPRECATED
 * 
 * This file contains the old recipe generation system.
 * It has been replaced by the refactored system in lib/recipe-generator-v2.ts
 * 
 * DO NOT USE - For reference/archival only
 * 
 * Old files that have been removed:
 * - lib/utils/constraintRecipeGenerator.ts (replaced by lib/generator/RecipeBuilder.ts)
 * - lib/utils/completeRecipeSystem.ts (replaced by lib/generator/nutrition.ts)
 * 
 * Migration: Use lib/recipe-generator-v2.ts instead
 */

// This file is kept for reference only. All functionality has been migrated to the new system.
// See REFACTOR_MIGRATION_GUIDE.md for migration instructions.
</file>

<file path="lib/recipe-generator-v3.ts">
/**
 * PRAGMATIC RECIPE GENERATOR V3
 * Enhanced with health-aware ingredient selection
 * 
 * Flow:
 * 1. RecipeBuilder filters hard constraints (species, allergies, contraindications)
 * 2. RecipeBuilder scores ingredients (health 40%, nutrition 50%, quality 10%)
 * 3. RecipeBuilder selects top ingredients by category
 * 4. RecipeBuilder calculates portions and costs
 */

import type { Pet } from '@/lib/types';
import { RecipeBuilder, type GenerationConstraints, type GeneratedRecipeRaw, type DiversityMode } from '@/lib/generator/RecipeBuilder';
import type { IngredientCategory } from '@/lib/data/ingredients';

/**
 * Normalize ingredient category strings to canonical values.
 * Handles variations like 'fish', 'seafood', 'meat', 'poultry' ‚Üí 'protein'
 */
function canonicalCategory(cat: any): IngredientCategory | 'unknown' {
  const c = String(cat ?? '').toLowerCase().trim();

  // PROTEIN family (fish, meat, poultry, seafood, eggs)
  if (
    c === 'protein' ||
    c.includes('protein') ||
    c.includes('meat') ||
    c.includes('poultry') ||
    c.includes('fish') ||
    c.includes('seafood') ||
    c.includes('egg')
  ) return 'protein';

  // VEGETABLE family
  if (c === 'vegetable' || c.includes('veg')) return 'vegetable';

  // FAT family (oils)
  if (c === 'fat' || c.includes('oil')) return 'fat';

  // CARB family (grains, starches)
  if (c === 'carb' || c.includes('grain') || c.includes('starch')) return 'carb';

  // Keep specialized categories as-is
  if (['seed', 'nut', 'fruit', 'insect', 'hay', 'pellet', 'supplement'].includes(c)) {
    return c as IngredientCategory;
  }

  return 'unknown';
}

export interface GenerateRecipeOptions {
  pet: Pet;
  budgetPerMeal?: number;
  targetCalories?: number;
  diversityMode?: DiversityMode;
  recentIngredients?: string[]; // Track recently used ingredients for variety
}

export interface GeneratedRecipe {
  id: string;
  name: string;
  ingredients: Array<{ name: string; amount: string }>;
  nutrition: {
    protein: number;
    fat: number;
    fiber: number;
    kcal: number;
  };
  scores: {
    health: number;
    nutrition: number;
    cost: number;
    quality: number;
    overall: number;
  };
  debugInfo?: {
    candidateCount: number;
    topScores: Array<{ name: string; score: number; breakdown: any }>;
  };
}

/**
 * Generate a recipe for a pet using enhanced pragmatic approach
 */
export function generateRecipeForPet(options: GenerateRecipeOptions): GeneratedRecipe | null {
  const { pet, budgetPerMeal = 4.0, targetCalories = 500, diversityMode = 'medium', recentIngredients = [] } = options;

  console.log(`\nüîß Generating recipe for ${pet.name}...`);

  try {
    // Build constraints from pet profile
    const constraints: GenerationConstraints = {
      species: pet.type as any,
      lifeStage: 'adult', // TODO: derive from pet.age
      healthConcerns: pet.healthConcerns,
      budgetPerMeal,
      targetCalories,
      allergies: pet.allergies?.map(a => a.toLowerCase()),
      bannedIngredients: pet.bannedIngredients?.map(b => b.toLowerCase()),
      recentIngredients, // Pass to builder for diversity penalties
    };

    // Generate with different quality tiers
    const candidates: GeneratedRecipe[] = [];

    for (let tier = 0; tier < 3; tier++) {
      const tierName = ['premium', 'standard', 'budget'][tier] as 'premium' | 'standard' | 'budget';
      const builder = new RecipeBuilder(constraints, tierName, diversityMode);
      const raw = builder.generate();

      if (!raw) continue;

      // Convert to GeneratedRecipe
      const recipe = assembleRecipe(raw, pet);
      if (recipe) {
        candidates.push(recipe);
      }
    }

    if (candidates.length === 0) {
      console.warn(`Failed to generate any recipes for ${pet.name}`);
      return null;
    }

    // Return highest scoring recipe
    const best = candidates.sort((a, b) => b.scores.overall - a.scores.overall)[0];

    console.log(`‚ú® Generated: ${best.name}`);
    console.log(
      `   Scores: Health=${best.scores.health} Quality=${best.scores.quality} Overall=${best.scores.overall}`
    );

    return best;
  } catch (error) {
    console.error(`Error generating recipe for ${pet.name}:`, error);
    return null;
  }
}

/**
 * Generate multiple recipes for a pet with ingredient tracking for variety
 */
export function generateRecipesForPet(
  options: GenerateRecipeOptions,
  count: number = 3
): GeneratedRecipe[] {
  const recipes: GeneratedRecipe[] = [];
  const recentIngredients: string[] = []; // Track last 10 ingredients used
  const TRACKING_WINDOW = 10; // Remember last 10 ingredients

  for (let i = 0; i < count; i++) {
    try {
      // Pass recent ingredients to enforce variety
      const recipe = generateRecipeForPet({
        ...options,
        recentIngredients: [...recentIngredients], // Pass copy
      });
      
      if (recipe) {
        recipes.push(recipe);
        
        // Track ingredients from this recipe
        recipe.ingredients.forEach(ing => {
          recentIngredients.push(ing.name.toLowerCase());
        });
        
        // Keep only last N ingredients
        if (recentIngredients.length > TRACKING_WINDOW) {
          recentIngredients.splice(0, recentIngredients.length - TRACKING_WINDOW);
        }
        
        if ((i + 1) % 10 === 0) {
          console.log(`Generated ${i + 1}/${count} recipes. Recent ingredients: ${recentIngredients.slice(-5).join(', ')}`);
        }
      }
    } catch (error) {
      console.error(`Failed to generate recipe ${i + 1}:`, error);
    }
  }

  return recipes;
}

/**
 * Assemble GeneratedRecipe from raw builder output
 */
function assembleRecipe(raw: GeneratedRecipeRaw, pet: Pet): GeneratedRecipe | null {
  if (!raw.ingredients || raw.ingredients.length === 0) {
    return null;
  }

  // Calculate nutrition totals
  let totalProtein = 0,
    totalFat = 0,
    totalFiber = 0,
    totalKcal = 0;

  for (const p of raw.ingredients) {
    const comp = p.ingredient.composition;
    const ratio = p.grams / 100;
    totalProtein += (comp.protein || 0) * ratio;
    totalFat += (comp.fat || 0) * ratio;
    totalFiber += (comp.fiber || 0) * ratio;
    totalKcal += (comp.kcal || 100) * ratio;
  }

  // Generate recipe name using canonicalCategory
  const proteinNames = raw.ingredients
    .filter(p => canonicalCategory(p.ingredient.category) === 'protein')
    .map(p => p.ingredient.name);
  const name = proteinNames.length > 0 
    ? `${pet.name}'s ${proteinNames.join(' & ')} Bowl`
    : `${pet.name}'s Custom Bowl`;

  // Calculate average scores from debug info
  let avgHealth = 50,
    avgPalatability = 50,
    avgQuality = 50,
    avgNutrition = 50;

  if (raw.debugInfo?.topScores && raw.debugInfo.topScores.length > 0) {
    const topBreakdowns = raw.debugInfo.topScores.slice(0, raw.ingredients.length);
    avgHealth =
      topBreakdowns.reduce((sum, s) => sum + s.breakdown.health, 0) / topBreakdowns.length;
    avgPalatability =
      topBreakdowns.reduce((sum, s) => sum + s.breakdown.taste, 0) / topBreakdowns.length;
    avgQuality =
      topBreakdowns.reduce((sum, s) => sum + s.breakdown.quality, 0) / topBreakdowns.length;
    avgNutrition =
      topBreakdowns.reduce((sum, s) => sum + s.breakdown.nutrition, 0) / topBreakdowns.length;
  }

  const costScore = raw.estimatedCost < 4.0 ? 90 : raw.estimatedCost < 6.0 ? 70 : 50;
  const overall = Math.round(
    (avgHealth * 0.4 + avgPalatability * 0.3 + avgQuality * 0.2 + avgNutrition * 0.1) * 0.7 +
      costScore * 0.3
  );

  return {
    id: `generated-${Date.now()}`,
    name,
    ingredients: raw.ingredients.map(p => ({
      name: p.ingredient.name,
      amount: `${p.grams}g`,
    })),
    nutrition: {
      protein: Math.round(totalProtein * 10) / 10,
      fat: Math.round(totalFat * 10) / 10,
      fiber: Math.round(totalFiber * 10) / 10,
      kcal: Math.round(totalKcal),
    },
    scores: {
      health: Math.round(avgHealth),
      nutrition: Math.round(avgNutrition),
      cost: costScore,
      quality: Math.round(avgQuality),
      overall,
    },
    debugInfo: raw.debugInfo,
  };
}

export type { GeneratedRecipe };
</file>

<file path="lib/recipe-generator.ts">
/**
 * Scalable Recipe Generation System for Pet Meal-Prep Website
 *
 * Core generation + scoring that is pet-aware, condition-aware, and diversity-aware.
 */

import type { Recipe, Ingredient, RecipeNutritionInfo, Pet } from './types';
import { VETTED_PRODUCTS_RESEARCH, getResearchBackedProduct } from './data/vetted-products-new';
import { scoreRecipeImproved } from './scoreRecipe';
import { HEALTH_BENEFIT_MAP, HEALTH_CONTRAINDICATIONS, normalizeConcernKey } from './data/healthBenefitMap';
import { CONDITION_TEMPLATES, type ConditionTemplate } from './data/conditionTemplates';
import { calculateDiversityPenalty, getRecentIngredients, normalizeIngredientNames } from './utils/diversityTracker';
import { generateMealName } from './utils/mealNameGenerator';
import { getProductByIngredient, getProductPrice, getProductQualityScore, getProductOptions } from './data/product-prices';
import { GoalOrientedGenerator } from './utils/constraintRecipeGenerator';

// ============================================================================
// SCRAPED DATA INTEGRATION (lightweight stubs used by test scripts)
// ============================================================================

export interface ScrapedResearchData {
  ingredients: string[];
  nutritionalInfo: any[];
  healthRecommendations: Array<{
    text: string;
    category: string;
    source: string;
  }>;
  veterinaryInsights: Array<{
    text: string;
    type: string;
    credibility: number;
  }>;
  researchFindings: any[];
  source: string;
  type: string;
  category: string;
  credibility: number;
}

export interface ScrapedInsights {
  commonIngredients: Record<string, number>;
  healthFocusAreas: Record<string, number>;
  ingredientHealthMap: Record<string, string[]>;
}

export function integrateScrapedIngredients(scrapedData: ScrapedResearchData[], category: PetCategory): IngredientTemplate[] {
  const existingIngredients = INGREDIENT_TEMPLATES[category] || [];
  const scrapedIngredients = new Set<string>();
  scrapedData.forEach(data => {
    data.ingredients?.forEach(ing => scrapedIngredients.add(ing.toLowerCase()));
  });

  const newIngredients: IngredientTemplate[] = [];
  scrapedIngredients.forEach(name => {
    const exists = existingIngredients.some(i => i.name.toLowerCase() === name);
    if (!exists) {
      newIngredients.push({
        id: name.replace(/\s+/g, '-'),
        name: name.charAt(0).toUpperCase() + name.slice(1),
        category: 'supplement',
        nutritionalProfile: { protein: 5, fat: 2, fiber: 1, calories: 100 },
        safeFor: [category],
        notes: 'Auto-added from scraped data'
      });
    }
  });
  return [...existingIngredients, ...newIngredients];
}

export function enhanceHealthConcernsWithScrapedData(scrapedData: ScrapedResearchData[]): Record<string, HealthConcern[]> {
  const map: Record<string, HealthConcern[]> = {};
  scrapedData.forEach(data => {
    data.healthRecommendations?.forEach(rec => {
      const text = rec.text.toLowerCase();
      data.ingredients?.forEach(ing => {
        if (text.includes(ing.toLowerCase())) {
          map[ing] = map[ing] || [];
          const c = rec.category as HealthConcern;
          if (!map[ing].includes(c)) map[ing].push(c);
        }
      });
    });
  });
  return map;
}

export function validateRecipeWithScrapedData(
  recipe: GeneratedRecipe,
  scrapedInsights: ScrapedInsights,
  healthInsights: Record<string, HealthConcern[]>,
  category: PetCategory
): { score: number; recommendations: string[] } {
  let score = 5;
  const recs: string[] = [];
  const recipeIngredients = recipe.ingredients.map(i => i.name.toLowerCase());
  const common = Object.keys(scrapedInsights.commonIngredients || {});
  const commonCount = recipeIngredients.filter(ing => common.some(c => ing.includes(c) || c.includes(ing))).length;
  if (commonCount > 0) {
    score += 2;
    recs.push(`Uses ${commonCount} ingredients commonly recommended by veterinarians`);
  }
  const healthMatches = recipe.healthConcerns.filter(c => scrapedInsights.healthFocusAreas?.[c] > 0);
  if (healthMatches.length) {
    score += 2;
    recs.push(`Addresses ${healthMatches.length} research-backed health concerns`);
  }
  recipeIngredients.forEach(ing => {
    const benefits = healthInsights[ing];
    if (benefits?.length) recs.push(`${ing} is associated with: ${benefits.join(', ')}`);
  });
  return { score: Math.min(10, score), recommendations: recs };
}

// ============================================================================
// CORE TYPES
// ============================================================================

export type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
export type AgeGroup = 'baby' | 'young' | 'adult' | 'senior';

export type HealthConcern =
  | 'allergy-support'
  | 'joint-health'
  | 'digestive-issues'
  | 'weight-management'
  | 'kidney-disease'
  | 'urinary-health'
  | 'dental-issues'
  | 'heart-disease'
  | 'diabetes'
  | 'respiratory'
  | 'pancreatitis'
  | 'skin-coat'
  | 'senior-support'
  | 'hairball'
  | 'dental-health'
  | 'immune-support';

export type RecipeStyle =
  | 'cooked'
  | 'raw'
  | 'dehydrated'
  | 'freeze-dried'
  | 'kibble-topper'
  | 'treat'
  | 'supplement'
  | 'seed-mix'
  | 'hay-based'
  | 'insect-based';

export interface IngredientTemplate {
  id: string;
  name: string;
  category: 'protein' | 'vegetable' | 'fruit' | 'grain' | 'dairy' | 'supplement' | 'fat' | 'seed' | 'hay' | 'insect';
  nutritionalProfile: {
    protein?: number;
    fat?: number;
    fiber?: number;
    moisture?: number;
    calories?: number;
    calcium?: number;
    phosphorus?: number;
  };
  safeFor: PetCategory[];
  avoidFor?: HealthConcern[];
  asinLink?: string;
  notes?: string;
}

export interface RecipeTemplate {
  id: string;
  name: string;
  category: PetCategory;
  style: RecipeStyle;
  baseIngredients: IngredientTemplate[];
  optionalIngredients: IngredientTemplate[];
  healthBenefits: HealthConcern[];
  ageGroups: AgeGroup[];
  breeds?: string[];
  defaultPrepTime: number;
  defaultCookTime?: number;
  servingSize: { min: number; max: number };
  nutritionalTargets: {
    protein: { min: number; max: number };
    fat: { min: number; max: number };
    fiber: { min: number; max: number };
  };
}

export interface RecipeGenerationOptions {
  template: RecipeTemplate;
  variations?: {
    ingredientSubstitutions?: IngredientTemplate[][];
    portionAdjustments?: number[];
    healthFocus?: HealthConcern[];
  };
  customizations?: {
    name?: string;
    additionalIngredients?: IngredientTemplate[];
    excludedIngredients?: string[];
    prepTimeMultiplier?: number;
  };
  pet?: Pet;
}

export interface GeneratedRecipe extends Omit<Recipe, 'id'> {
  templateId: string;
  generationTimestamp: Date;
  nutritionalCalculation: RecipeNutritionInfo;
  researchValidation?: {
    score: number;
    recommendations: string[];
  };
  ingredientBreakdown: {
    ingredient: Ingredient;
    contribution: {
      protein: number;
      fat: number;
      calories: number;
    };
  }[];
  _unsafeIngredients?: string[];
}

// Minimal curated templates to keep generator functional
export const INGREDIENT_TEMPLATES: Record<PetCategory, IngredientTemplate[]> = {
  dogs: [
    // Proteins (5 options for variety)
    { id: 'ground-chicken', name: 'ground chicken', category: 'protein', nutritionalProfile: { protein: 26, fat: 9 }, safeFor: ['dogs'] },
    { id: 'ground-beef', name: 'ground beef (lean)', category: 'protein', nutritionalProfile: { protein: 26, fat: 15 }, safeFor: ['dogs'] },
    { id: 'ground-turkey', name: 'ground turkey', category: 'protein', nutritionalProfile: { protein: 29, fat: 1 }, safeFor: ['dogs'] },
    { id: 'chicken', name: 'Chicken Breast', category: 'protein', nutritionalProfile: { protein: 31, fat: 3 }, safeFor: ['dogs'] },
    { id: 'salmon', name: 'Salmon', category: 'protein', nutritionalProfile: { protein: 25, fat: 14 }, safeFor: ['dogs'] },
    // Grains (4 options for variety)
    { id: 'brown-rice', name: 'Brown Rice', category: 'grain', nutritionalProfile: { protein: 2.6, fiber: 1.8 }, safeFor: ['dogs'] },
    { id: 'white-rice', name: 'White Rice', category: 'grain', nutritionalProfile: { protein: 2.7, fiber: 0.4 }, safeFor: ['dogs'] },
    { id: 'oats', name: 'Oats', category: 'grain', nutritionalProfile: { protein: 10, fiber: 10 }, safeFor: ['dogs'] },
    { id: 'sweet-potato', name: 'Sweet Potato', category: 'grain', nutritionalProfile: { fiber: 3, calories: 86 }, safeFor: ['dogs'] },
    // Vegetables (5 options for variety)
    { id: 'pumpkin', name: 'Pumpkin', category: 'vegetable', nutritionalProfile: { fiber: 2 }, safeFor: ['dogs'] },
    { id: 'spinach', name: 'Spinach', category: 'vegetable', nutritionalProfile: { protein: 3 }, safeFor: ['dogs'] },
    { id: 'carrots', name: 'Carrots', category: 'vegetable', nutritionalProfile: { fiber: 2.8 }, safeFor: ['dogs'] },
    { id: 'broccoli', name: 'Broccoli', category: 'vegetable', nutritionalProfile: { protein: 3.7, fiber: 2.4 }, safeFor: ['dogs'] },
    { id: 'green-beans', name: 'Green Beans', category: 'vegetable', nutritionalProfile: { fiber: 2.7 }, safeFor: ['dogs'] },
    // Fats (3 options)
    { id: 'fish-oil', name: 'Fish Oil', category: 'fat', nutritionalProfile: { fat: 99 }, safeFor: ['dogs'] },
    { id: 'coconut-oil', name: 'Coconut Oil', category: 'fat', nutritionalProfile: { fat: 99 }, safeFor: ['dogs'] },
    { id: 'olive-oil', name: 'Olive Oil', category: 'fat', nutritionalProfile: { fat: 99 }, safeFor: ['dogs'] },
  ],
  cats: [
    { id: 'chicken', name: 'Chicken Breast', category: 'protein', nutritionalProfile: { protein: 31, fat: 3 }, safeFor: ['cats'] },
    { id: 'salmon', name: 'Salmon', category: 'protein', nutritionalProfile: { protein: 25, fat: 14 }, safeFor: ['cats'] },
    { id: 'pumpkin', name: 'Pumpkin', category: 'vegetable', nutritionalProfile: { fiber: 2 }, safeFor: ['cats'] },
  ],
  birds: [
    { id: 'millet', name: 'Millet', category: 'seed', nutritionalProfile: { protein: 11, fat: 4 }, safeFor: ['birds'] },
    { id: 'sunflower', name: 'Sunflower Seed', category: 'seed', nutritionalProfile: { protein: 21, fat: 49 }, safeFor: ['birds'] },
    { id: 'walnuts', name: 'Walnuts', category: 'supplement', nutritionalProfile: { protein: 15, fat: 65 }, safeFor: ['birds'] }, // For Macaws/Greys
    { id: 'kale', name: 'Kale', category: 'vegetable', nutritionalProfile: { protein: 3 }, safeFor: ['birds'] },
    { id: 'apple', name: 'Apple', category: 'fruit', nutritionalProfile: { fiber: 2.4, calories: 52 }, safeFor: ['birds'] },
  ],
  reptiles: [
    { id: 'cricket', name: 'Crickets', category: 'insect', nutritionalProfile: { protein: 20, fat: 6 }, safeFor: ['reptiles'] },
    { id: 'mealworm', name: 'Mealworms', category: 'insect', nutritionalProfile: { protein: 19, fat: 13 }, safeFor: ['reptiles'] },
    { id: 'mouse', name: 'Frozen Mouse', category: 'protein', nutritionalProfile: { protein: 50, fat: 20 }, safeFor: ['reptiles'] }, // For Snakes
    { id: 'collard', name: 'Collard Greens', category: 'vegetable', nutritionalProfile: { fiber: 4 }, safeFor: ['reptiles'] },
    { id: 'squash', name: 'Butternut Squash', category: 'vegetable', nutritionalProfile: { fiber: 2 }, safeFor: ['reptiles'] },
    { id: 'mango', name: 'Mango', category: 'fruit', nutritionalProfile: { fiber: 1.6, calories: 60 }, safeFor: ['reptiles'] }, // For Geckos
  ],
  'pocket-pets': [
    { id: 'timothy-hay', name: 'Timothy Hay', category: 'hay', nutritionalProfile: { fiber: 30 }, safeFor: ['pocket-pets'] },
    { id: 'pellets', name: 'Fortified Pellets', category: 'grain', nutritionalProfile: { protein: 14 }, safeFor: ['pocket-pets'] },
    { id: 'parsley', name: 'Parsley', category: 'vegetable', nutritionalProfile: { fiber: 3 }, safeFor: ['pocket-pets'] },
    { id: 'apple', name: 'Apple', category: 'fruit', nutritionalProfile: { fiber: 2.4, calories: 52 }, safeFor: ['pocket-pets'] },
    { id: 'mealworm', name: 'Mealworms (Treat)', category: 'insect', nutritionalProfile: { protein: 19, fat: 13 }, safeFor: ['pocket-pets'] }, // For Sugar Gliders/Hamsters
  ],
};

// Simple template set
export const TEMPLATE_LIBRARY: RecipeTemplate[] = [
  {
    id: 'dog-budget',
    name: 'Budget Ground Chicken Mix',
    category: 'dogs',
    style: 'cooked',
    baseIngredients: [
      INGREDIENT_TEMPLATES.dogs[0], // ground chicken (cheap)
      INGREDIENT_TEMPLATES.dogs[7], // white rice (cheap)
      INGREDIENT_TEMPLATES.dogs[9], // spinach (cheap)
    ],
    optionalIngredients: [INGREDIENT_TEMPLATES.dogs[12], INGREDIENT_TEMPLATES.dogs[10]], // coconut oil, carrots
    healthBenefits: ['digestive-issues', 'weight-management'],
    ageGroups: ['adult'],
    defaultPrepTime: 10,
    defaultCookTime: 20,
    servingSize: { min: 180, max: 240 },
    nutritionalTargets: { protein: { min: 20, max: 35 }, fat: { min: 8, max: 18 }, fiber: { min: 2, max: 6 } },
  },
  {
    id: 'dog-balanced',
    name: 'Balanced Ground Beef Mix',
    category: 'dogs',
    style: 'cooked',
    baseIngredients: [
      INGREDIENT_TEMPLATES.dogs[1], // ground beef (cheap)
      INGREDIENT_TEMPLATES.dogs[6], // brown rice
      INGREDIENT_TEMPLATES.dogs[8], // pumpkin
    ],
    optionalIngredients: [INGREDIENT_TEMPLATES.dogs[10], INGREDIENT_TEMPLATES.dogs[12]], // carrots, coconut oil
    healthBenefits: ['digestive-issues', 'weight-management'],
    ageGroups: ['adult'],
    defaultPrepTime: 10,
    defaultCookTime: 20,
    servingSize: { min: 180, max: 240 },
    nutritionalTargets: { protein: { min: 20, max: 35 }, fat: { min: 8, max: 18 }, fiber: { min: 2, max: 6 } },
  },
  {
    id: 'cat-salmon',
    name: 'Omega Salmon Delight',
    category: 'cats',
    style: 'cooked',
    baseIngredients: [INGREDIENT_TEMPLATES.cats[1], INGREDIENT_TEMPLATES.cats[2]],
    optionalIngredients: [INGREDIENT_TEMPLATES.cats[0]],
    healthBenefits: ['skin-coat', 'kidney-disease'],
    ageGroups: ['adult'],
    defaultPrepTime: 8,
    defaultCookTime: 15,
    servingSize: { min: 120, max: 180 },
    nutritionalTargets: { protein: { min: 30, max: 45 }, fat: { min: 10, max: 20 }, fiber: { min: 1, max: 4 } },
  },
  {
    id: 'bird-parrot-mix',
    name: 'Tropical Nut & Veggie Mix',
    category: 'birds',
    style: 'seed-mix',
    baseIngredients: [INGREDIENT_TEMPLATES.birds[1], INGREDIENT_TEMPLATES.birds[2], INGREDIENT_TEMPLATES.birds[3]], // Sunflower, Walnut, Kale
    optionalIngredients: [INGREDIENT_TEMPLATES.birds[4]], // Apple
    healthBenefits: ['skin-coat', 'immune-support'],
    ageGroups: ['adult'],
    defaultPrepTime: 5,
    servingSize: { min: 30, max: 60 },
    nutritionalTargets: { protein: { min: 12, max: 18 }, fat: { min: 15, max: 30 }, fiber: { min: 5, max: 12 } },
  },
  {
    id: 'reptile-carnivore',
    name: 'Whole Prey Feast',
    category: 'reptiles',
    style: 'raw',
    baseIngredients: [INGREDIENT_TEMPLATES.reptiles[2]], // Mouse
    optionalIngredients: [],
    healthBenefits: ['weight-management'],
    ageGroups: ['adult'],
    defaultPrepTime: 2,
    servingSize: { min: 50, max: 150 },
    nutritionalTargets: { protein: { min: 40, max: 60 }, fat: { min: 15, max: 25 }, fiber: { min: 0, max: 2 } },
  },
  {
    id: 'reptile-omnivore',
    name: 'Dragon Salad & Bugs',
    category: 'reptiles',
    style: 'cooked', // Mixed
    baseIngredients: [INGREDIENT_TEMPLATES.reptiles[3], INGREDIENT_TEMPLATES.reptiles[4], INGREDIENT_TEMPLATES.reptiles[0]], // Collard, Squash, Cricket
    optionalIngredients: [INGREDIENT_TEMPLATES.reptiles[5]], // Mango
    healthBenefits: ['digestive-issues'],
    ageGroups: ['adult'],
    defaultPrepTime: 10,
    servingSize: { min: 40, max: 80 },
    nutritionalTargets: { protein: { min: 20, max: 30 }, fat: { min: 4, max: 8 }, fiber: { min: 5, max: 10 } },
  },
  {
    id: 'sugar-glider-fresh',
    name: 'Nectar & Fruit Bowl',
    category: 'pocket-pets',
    style: 'raw',
    baseIngredients: [INGREDIENT_TEMPLATES['pocket-pets'][3], INGREDIENT_TEMPLATES['pocket-pets'][4]], // Apple, Mealworm
    optionalIngredients: [INGREDIENT_TEMPLATES['pocket-pets'][1]], // Pellets
    healthBenefits: ['energy'],
    ageGroups: ['adult'],
    defaultPrepTime: 5,
    servingSize: { min: 20, max: 40 },
    nutritionalTargets: { protein: { min: 15, max: 25 }, fat: { min: 5, max: 10 }, fiber: { min: 2, max: 5 } },
  },
  {
    id: 'pocket-fresh',
    name: 'Greens & Hay Medley',
    category: 'pocket-pets',
    style: 'hay-based',
    baseIngredients: [INGREDIENT_TEMPLATES['pocket-pets'][0], INGREDIENT_TEMPLATES['pocket-pets'][2]],
    optionalIngredients: [INGREDIENT_TEMPLATES['pocket-pets'][1]],
    healthBenefits: ['dental-health', 'digestive-issues'],
    ageGroups: ['adult'],
    defaultPrepTime: 2,
    servingSize: { min: 50, max: 80 },
    nutritionalTargets: { protein: { min: 10, max: 18 }, fat: { min: 2, max: 6 }, fiber: { min: 15, max: 30 } },
  },
];

// ============================================================================
// HELPERS
// ============================================================================

const SYNERGY_MAP: Record<string, string[]> = {
  turmeric: ['black pepper', 'fish oil', 'salmon'],
  'fish oil': ['salmon', 'sardines', 'mackerel'],
  salmon: ['sweet potato', 'pumpkin', 'spinach'],
  'white fish': ['pumpkin', 'sweet potato', 'rice'],
};

function clamp(num: number, min: number, max: number) {
  return Math.min(Math.max(num, min), max);
}

function computeMacroTotals(recipe: GeneratedRecipe) {
  const parseAmount = (amt?: string) => {
    if (!amt) return 0;
    const match = amt.match(/([\d.]+)/);
    return match ? parseFloat(match[1]) : 0;
  };
  const totalWeight = (recipe.ingredients || []).reduce((sum, ing) => sum + parseAmount(ing.amount), 0);
  const protein = recipe.ingredientBreakdown?.reduce((sum, b) => sum + b.contribution.protein, 0) ?? 0;
  const fat = recipe.ingredientBreakdown?.reduce((sum, b) => sum + b.contribution.fat, 0) ?? 0;
  return { totalWeight, protein, fat };
}

function applyNutrientTargets(recipe: GeneratedRecipe, pet?: Pet): number {
  if (!pet) return 0;
  const { protein, fat } = computeMacroTotals(recipe);
  const weight = recipe.ingredients.length ? computeMacroTotals(recipe).totalWeight || 1 : 1;
  const proteinPct = weight ? (protein / weight) * 100 : 0;
  const fatPct = weight ? (fat / weight) * 100 : 0;

  const speciesTargets: Record<string, { protein: [number, number]; fat: [number, number] }> = {
    dog: { protein: [18, 35], fat: [8, 22] },
    cat: { protein: [28, 45], fat: [9, 25] },
    bird: { protein: [12, 22], fat: [4, 12] },
    reptile: { protein: [15, 28], fat: [4, 12] },
    'pocket-pet': { protein: [12, 20], fat: [2, 8] },
  };

  const key = normalizeSpecies(pet.species);
  const t = speciesTargets[key] || speciesTargets.dog;
  let bonus = 0;
  if (proteinPct >= t.protein[0] && proteinPct <= t.protein[1]) bonus += 6;
  else bonus -= 4;
  if (fatPct >= t.fat[0] && fatPct <= t.fat[1]) bonus += 4;
  else bonus -= 3;
  return bonus;
}

function applyConditionTemplateBias(recipe: GeneratedRecipe, pet?: Pet): number {
  if (!pet?.healthConcerns?.length) return 0;
  const template = CONDITION_TEMPLATES.find(t => t.concerns.some(c => pet.healthConcerns?.includes(c)));
  if (!template) return 0;
  const ingNames = recipe.ingredients.map(i => i.name.toLowerCase());
  let delta = 0;
  template.preferredIngredients?.forEach(pref => {
    if (ingNames.includes(pref.toLowerCase())) delta += 3;
  });
  template.avoidedIngredients?.forEach(avoid => {
    if (ingNames.includes(avoid.toLowerCase())) delta -= 5;
  });
  return delta;
}

function applySynergyBonus(recipe: GeneratedRecipe): number {
  const ingNames = recipe.ingredients.map(i => i.name.toLowerCase());
  let bonus = 0;
  Object.entries(SYNERGY_MAP).forEach(([a, partners]) => {
    if (ingNames.includes(a)) {
      partners.forEach(p => {
        if (ingNames.includes(p)) bonus += 2;
      });
    }
  });
  return bonus;
}

/**
 * Apply quality score bonus for using high-quality, research-backed products
 */
function applyQualityBonus(recipe: GeneratedRecipe): number {
  let qualityBonus = 0;
  const avgQualityScore = recipe.ingredients.reduce((sum, ing) => {
    const score = getProductQualityScore(ing.name);
    return sum + score;
  }, 0) / (recipe.ingredients.length || 1);
  
  // Normalize quality score (0-10) to bonus points (0-8)
  // High quality (8+) = +8 bonus, Medium (5-7) = +3 bonus, Low (<5) = 0 bonus
  if (avgQualityScore >= 8) qualityBonus = 8;
  else if (avgQualityScore >= 6) qualityBonus = 4;
  else if (avgQualityScore >= 5) qualityBonus = 2;
  
  return qualityBonus;
}

function normalizeSpecies(species?: string): string {
  const s = (species || '').toLowerCase();
  if (['hamster', 'guinea pig', 'pocket', 'pocket-pet', 'pocket pet'].includes(s)) return 'pocket-pet';
  if (s.includes('cat')) return 'cat';
  if (s.includes('bird')) return 'bird';
  if (s.includes('reptile') || s.includes('dragon') || s.includes('gecko')) return 'reptile';
  return 'dog';
}

function quickPrecheckFails(recipe: GeneratedRecipe, pet?: Pet): string[] {
  if (!pet) return [];
  const allergens = (pet.allergies || []).map(a => a.toLowerCase());
  const ingNames = recipe.ingredients.map(i => i.name.toLowerCase());
  return ingNames.filter(n => allergens.includes(n));
}

export function computeFinalGenerationScore(
  recipe: GeneratedRecipe, 
  pet?: Pet, 
  recentIngredients?: string[]
): { score: number; explain: string[]; estimatedCostPerMeal?: number } {
  const explain: string[] = [];
  
  // Base compatibility score from improved system (0-100)
  // Convert GeneratedRecipe to Recipe format for scoring (add temporary id if missing)
  const recipeForScoring: Recipe = {
    ...recipe,
    id: recipe.templateId || 'generated-recipe',
  } as unknown as Recipe;
  
  const improvedScore = pet 
    ? (scoreRecipeImproved(recipeForScoring, pet).compatibilityScore || scoreRecipeImproved(recipeForScoring, pet).matchScore)
    : 60; // Default if no pet
  
  // Generator-specific modifiers (normalized to small adjustments)
  const synergyBonus = applySynergyBonus(recipe);
  const qualityBonus = applyQualityBonus(recipe);
  const conditionBias = applyConditionTemplateBias(recipe, pet);
  const nutrientAdjustment = applyNutrientTargets(recipe, pet);
  const diversityPenalty = calculateDiversityPenalty(
    normalizeIngredientNames(recipe.ingredients.map(i => i.name.toLowerCase())),
    recentIngredients || []
  );
  
  // NEW: Cost optimization bonus/penalty (matched to commercial pet food pricing)
  const estimatedCost = estimateRecipeCost(recipe.ingredients);
  const MAX_TARGET_COST = 4.00; // Allow up to $4/meal for better ingredient variety and quality
  let costAdjustment = 0;
  
  if (estimatedCost <= MAX_TARGET_COST) {
    // Bonus for being under budget
    const costSavings = MAX_TARGET_COST - estimatedCost;
    costAdjustment = Math.min(10, costSavings * 2); // Up to +10 bonus
    explain.push(`‚úì Cost-competitive: $${estimatedCost.toFixed(2)}/meal (target: $${MAX_TARGET_COST})`);
  } else {
    // Penalty for exceeding budget
    const costOverage = estimatedCost - MAX_TARGET_COST;
    costAdjustment = -Math.min(15, costOverage * 1.5); // Up to -15 penalty
    explain.push(`‚ö†Ô∏è Cost premium: $${estimatedCost.toFixed(2)}/meal (target: $${MAX_TARGET_COST})`);
  }
  
  // Normalize legacy modifiers to ¬±10 range so they don't dominate
  const normalizedSynergy = clamp(synergyBonus * 0.5, 0, 5); // Max +5
  const normalizedQuality = clamp(qualityBonus * 0.5, 0, 5); // Max +5 for quality
  const normalizedCondition = clamp(conditionBias * 0.3, -5, 5); // ¬±5 max
  const normalizedNutrient = clamp(nutrientAdjustment * 0.5, -5, 5); // ¬±5 max
  const normalizedDiversity = clamp(diversityPenalty.penalty, 0, 10); // Max -10
  
  // Combine: improved score (base) + small generator adjustments + quality + cost optimization
  let finalScore = improvedScore 
    + normalizedSynergy 
    + normalizedQuality
    + normalizedCondition 
    + normalizedNutrient 
    + costAdjustment
    - normalizedDiversity;
  
  // Safety floor: if improved score is high but we have diversity issues, don't tank completely
  if (improvedScore >= 80 && normalizedDiversity > 0) {
    finalScore = Math.max(finalScore, improvedScore - 8); // Cap diversity penalty
  }
  
  // Explain array for debugging
  if (normalizedSynergy > 0) explain.push(`Synergy bonus: +${normalizedSynergy.toFixed(1)}`);
  if (normalizedCondition !== 0) explain.push(`Condition bias: ${normalizedCondition > 0 ? '+' : ''}${normalizedCondition.toFixed(1)}`);
  if (normalizedNutrient !== 0) explain.push(`Nutrient adjustment: ${normalizedNutrient > 0 ? '+' : ''}${normalizedNutrient.toFixed(1)}`);
  if (normalizedDiversity > 0) explain.push(`Diversity overlap: -${normalizedDiversity.toFixed(1)}`);
  
  return { 
    score: clamp(finalScore, 0, 100), 
    explain,
    estimatedCostPerMeal: estimatedCost
  };
}

// ============================================================================
// GENERATION
// ============================================================================

/**
 * Calculate estimated cost per meal for a recipe
 * Uses product-prices.json data when available
 * Converts amount to grams and calculates proportional cost
 */
function estimateRecipeCost(ingredients: Array<{ name: string; amount: string }>): number {
  let totalCost = 0;
  
  for (const ing of ingredients) {
    const pricePerPound = getProductPrice(ing.name.toLowerCase());
    if (typeof pricePerPound === 'number' && pricePerPound > 0) {
      // Parse amount to grams
      let grams = 0;
      const amountStr = ing.amount.toLowerCase();
      
      // Try to extract numeric value and unit
      const match = amountStr.match(/(\d+(?:\.\d+)?)\s*([a-z]+)?/);
      if (match) {
        const value = parseFloat(match[1]);
        const unit = match[2] || 'g';
        
        // Convert to grams
        if (unit === 'g' || unit === 'gram' || unit === 'grams') grams = value;
        else if (unit === 'kg' || unit === 'kilogram') grams = value * 1000;
        else if (unit === 'lb' || unit === 'lbs' || unit === 'pound') grams = value * 453.592;
        else if (unit === 'oz' || unit === 'ounce') grams = value * 28.3495;
        else grams = value; // Default to grams
      }
      
      // Calculate cost: (grams / grams_per_pound) * price_per_pound
      if (grams > 0) {
        const cost = (grams / 453.592) * pricePerPound;
        totalCost += cost;
      }
    }
  }
  
  return totalCost;
}

/**
 * Pick ingredients with cost optimization
 * Prefers cheaper options when multiple ingredients can serve the same role
 */
function pickIngredients(template: RecipeTemplate, pet?: Pet, excluded: string[] = [], optimizeForCost: boolean = true) {
  const safeList = [...template.baseIngredients, ...template.optionalIngredients].filter(
    ing => ing.safeFor.includes(template.category) && !excluded.includes(ing.id) && !excluded.includes(ing.name)
  );
  const chosen: IngredientTemplate[] = [];
  
  // Always include base ingredients (required for nutrition)
  template.baseIngredients.forEach(ing => {
    if (!excluded.includes(ing.id)) chosen.push(ing);
  });
  
  // Add optional ingredients, preferring cheaper ones if optimizing for cost
  if (safeList.length > chosen.length && optimizeForCost) {
    const optionals = safeList.filter(i => !chosen.includes(i) && template.optionalIngredients.includes(i));
    
    if (optionals.length > 0) {
      // Sort by price (cheapest first)
      const optionalsWithPrice = optionals.map(opt => ({
        ingredient: opt,
        price: getProductPrice(opt.name.toLowerCase()) || 999, // High default for missing prices
      })).sort((a, b) => a.price - b.price);
      
      // Pick the cheapest optional
      if (optionalsWithPrice[0]) {
        chosen.push(optionalsWithPrice[0].ingredient);
      }
    }
  } else if (safeList.length > chosen.length) {
    // Original behavior: just add first available optional
    const optional = safeList.find(i => !chosen.includes(i));
    if (optional) chosen.push(optional);
  }

  return chosen.map(ing => ({
    id: ing.id,
    name: ing.name,
    amount: ing.category === 'protein' ? '120g' : ing.category === 'fat' ? '5g' : '60g',
    amazonLink: getResearchBackedProduct ? getResearchBackedProduct(ing.id)?.amazonLink : undefined,
  }));
}

export function generateRecipe(options: RecipeGenerationOptions): GeneratedRecipe {
  const { template, customizations, pet } = options;
  const excluded = customizations?.excludedIngredients || [];
  const ingredients = pickIngredients(template, pet, excluded);

  const ingredientBreakdown = ingredients.map((ing) => ({
    ingredient: ing as unknown as Ingredient,
    contribution: {
      protein: ing.name.toLowerCase().includes('chicken') || ing.name.toLowerCase().includes('salmon') ? 20 : 2,
      fat: ing.name.toLowerCase().includes('oil') || ing.name.toLowerCase().includes('salmon') ? 8 : 1,
      calories: 50,
    },
  }));

  // Generate recipe name using enhanced naming system
  const ingredientKeys = ingredients.map(ing => ing.name || ing.id);
  const totalCalories = ingredientBreakdown.reduce((s, b) => s + b.contribution.calories, 0);
  const totalProtein = ingredientBreakdown.reduce((s, b) => s + b.contribution.protein, 0);
  const totalFat = ingredientBreakdown.reduce((s, b) => s + b.contribution.fat, 0);
  
  const nutritionalProfile = totalCalories > 0 ? {
    protein: (totalProtein / totalCalories) * 100,
    fat: (totalFat / totalCalories) * 100,
  } : undefined;
  
  const recipeForNaming: Recipe = {
    id: `generated-${template.id}-${Date.now()}`,
    name: template.name,
    category: template.category,
    ingredients: ingredients.map(ing => ({ id: ing.id, name: ing.name, amount: ing.amount })),
    instructions: ['Combine ingredients', 'Cook as needed', 'Cool and serve'],
    healthConcerns: [...template.healthBenefits, ...(pet?.healthConcerns || [])],
    ageGroup: template.ageGroups,
  };
  
  const nameResult = customizations?.name 
    ? { fullName: customizations.name, shortName: customizations.name }
    : generateMealName(ingredientKeys, {
        petName: pet?.name || undefined,
        petBreed: pet?.breed || undefined,
        petSpecies: pet?.type || undefined,
        healthConcerns: recipeForNaming.healthConcerns,
        nutritionalProfile,
        mealType: 'complete',
        recipeId: recipeForNaming.id,
        recipe: recipeForNaming,
        isCustomMeal: false,
      });

  const recipe: GeneratedRecipe = {
    templateId: template.id,
    generationTimestamp: new Date(),
    name: nameResult.fullName,
    description: `${nameResult.fullName} tailored for ${pet?.name || 'your pet'}`,
    category: template.category,
    healthConcerns: [...template.healthBenefits, ...(pet?.healthConcerns || [])],
    ageGroup: template.ageGroups,
    ingredients,
    instructions: ['Combine ingredients', 'Cook as needed', 'Cool and serve'],
    prepTime: `${template.defaultPrepTime} min`,
    cookTime: template.defaultCookTime ? `${template.defaultCookTime} min` : 'No cook',
    servings: 1,
    tags: template.healthBenefits,
    imageUrl: `/images/generated/${template.category}-${template.id}.png`,
    nutritionalCalculation: {
      calories: totalCalories,
      protein: totalProtein,
      fat: totalFat,
      carbs: 0,
      fiber: 0,
      moisture: 0,
    },
    ingredientBreakdown,
  };

  const recent = pet?.id ? getRecentIngredients(pet.id, 7) : [];
  const { score } = computeFinalGenerationScore(recipe, pet, recent);
  recipe.score = score;
  recipe._unsafeIngredients = quickPrecheckFails(recipe, pet);

  return recipe;
}

/**
 * Generate a recipe dynamically based on pet profile
 * Ignores templates - builds recipe from scratch based on pet needs
 */
export function generateBestRecipeForPet(templates: RecipeTemplate[] = TEMPLATE_LIBRARY, pet?: Pet, seed?: number) {
  if (!pet) {
    // Fallback to template-based if no pet provided
    const template = templates[seed ? seed % templates.length : 0];
    return generateRecipe({ template, pet });
  }

  // Build recipe from scratch based on pet profile
  const recipe = generateDynamicRecipe(pet, seed);
  const recent = pet.id ? getRecentIngredients(pet.id, 7) : [];
  const { score } = computeFinalGenerationScore(recipe, pet, recent);
  recipe.score = score;
  return recipe;
}

/**
 * Generate a recipe dynamically based on pet's specific needs
 * Uses constraint-based generation with AAFCO standards and quality scoring
 */
function generateDynamicRecipe(pet: Pet, seed?: number): GeneratedRecipe {
  try {
    const petType = pet.type || 'dogs';
    const lifeStage = 'adult';
    const healthConcerns = pet.healthConcerns || [];
    const targetCalories = 500;
    const budgetPerMeal = 4.00;
    
    console.log(`Generating recipe for ${pet.name} (${petType}), budget=$${budgetPerMeal}`);
    
    const generator = new GoalOrientedGenerator(
      petType,
      lifeStage,
      healthConcerns,
      targetCalories,
      budgetPerMeal
    );
    
    const result = generator.generate();
    
    if (!result) {
      console.warn(`Constraint generator failed for ${pet.name}, using fallback`);
      return createFallbackRecipe(pet, seed);
    }
    
    const ingredients: Ingredient[] = result.ingredients.map(ing => ({
      id: ing.name.replace(/\s+/g, '-').toLowerCase(),
      name: ing.name,
      amount: `${ing.amount}g`,
    }));
    
    const recipe: GeneratedRecipe = {
      templateId: 'constraint-generated',
      generationTimestamp: new Date(),
      name: `${pet.name}'s Balanced Meal`,
      description: result.description,
      category: petType as PetCategory,
      healthConcerns: healthConcerns,
      ageGroup: ['adult'],
      ingredients,
      instructions: result.instructions,
      prepTime: '10 min',
      cookTime: '15 min',
      servings: 1,
      tags: healthConcerns,
      imageUrl: `/images/generated/${petType}-meal.png`,
      nutritionalCalculation: {
        calories: result.nutritionalInfo.totalCalories,
        protein: result.nutritionalInfo.protein,
        fat: result.nutritionalInfo.fat,
        carbs: result.nutritionalInfo.carbs,
        fiber: result.nutritionalInfo.fiber,
        moisture: 0,
      },
      ingredientBreakdown: ingredients.map(ing => ({
        ingredient: ing,
        contribution: {
          protein: 0,
          fat: 0,
          calories: 0,
        },
      })),
    };
    
    const recent = pet.id ? getRecentIngredients(pet.id, 7) : [];
    const { score } = computeFinalGenerationScore(recipe, pet, recent);
    recipe.score = score;
    recipe._unsafeIngredients = quickPrecheckFails(recipe, pet);
    
    console.log(`Generated recipe: ${recipe.name} with score ${score.toFixed(1)}`);
    
    return recipe;
  } catch (error) {
    console.error(`Error generating dynamic recipe for ${pet.name}:`, error);
    return createFallbackRecipe(pet, seed);
  }
}

/**
 * Infer ingredient category from ID and composition data
 */
function inferCategory(id: string, composition?: any): string {
  const lower = id.toLowerCase();
  
  // Check composition data first for more accurate categorization
  if (composition) {
    // High protein = protein source
    if (composition.protein && composition.protein > 15) return 'protein';
    // High fat, low protein = fat/oil
    if (composition.fat && composition.fat > 50) return 'fat';
    // Fiber-rich = vegetable/hay
    if (composition.fiber && composition.fiber > 5) return composition.fiber > 15 ? 'hay' : 'vegetable';
  }
  
  // Fallback to ID-based categorization
  if (lower.includes('protein') || lower.includes('meat') || lower.includes('fish') || lower.includes('chicken') || lower.includes('beef') || lower.includes('turkey') || lower.includes('lamb') || lower.includes('mouse') || lower.includes('rat') || lower.includes('chick') || lower.includes('liver') || lower.includes('heart') || lower.includes('kidney')) return 'protein';
  if (lower.includes('rice') || lower.includes('grain') || lower.includes('oat') || lower.includes('barley') || lower.includes('millet') || lower.includes('quinoa') || lower.includes('pasta') || lower.includes('bread')) return 'grain';
  if (lower.includes('vegetable') || lower.includes('carrot') || lower.includes('spinach') || lower.includes('broccoli') || lower.includes('pumpkin') || lower.includes('sweet_potato') || lower.includes('squash') || lower.includes('greens') || lower.includes('lettuce') || lower.includes('kale') || lower.includes('celery') || lower.includes('zucchini')) return 'vegetable';
  if (lower.includes('fruit') || lower.includes('apple') || lower.includes('berry') || lower.includes('banana') || lower.includes('papaya') || lower.includes('mango') || lower.includes('blueberry')) return 'fruit';
  if (lower.includes('oil') || lower.includes('fat') || lower.includes('coconut') || lower.includes('salmon_oil') || lower.includes('fish_oil')) return 'fat';
  if (lower.includes('seed') || lower.includes('nut') || lower.includes('flax') || lower.includes('hemp') || lower.includes('chia') || lower.includes('sunflower')) return 'seed';
  if (lower.includes('hay') || lower.includes('timothy') || lower.includes('alfalfa')) return 'hay';
  if (lower.includes('insect') || lower.includes('cricket') || lower.includes('mealworm') || lower.includes('roach') || lower.includes('dubia')) return 'insect';
  return 'other';
}

/**
 * Build a nutritionally sound recipe using comprehensive ingredient data
 * REFACTORED: Constraint-first approach (health + cost drive selection, not scoring)
 */
function buildNutritionallySoundRecipe(ingredients: any[], pet: Pet, seed: number): GeneratedRecipe {
  const petType = pet.type as string;
  const isCarnivore = petType === 'cats' || petType === 'birds' || petType === 'reptiles';
  
  // STEP 1: CONSTRAINT FILTER - Remove ingredients that violate hard rules
  let constrainedIngredients = ingredients;
  
  // Filter out health contraindications (hard exclusions, not soft penalties)
  if (pet.healthConcerns && pet.healthConcerns.length > 0) {
    constrainedIngredients = constrainedIngredients.filter(ing => {
      // Exclude ingredients that are contraindicated for this health concern
      // (This would use HEALTH_CONTRAINDICATIONS if available)
      return true; // Placeholder - would check contraindications
    });
  }
  
  console.log(`After constraint filter: ${constrainedIngredients.length} ingredients remain`);
  
  // STEP 2: CATEGORIZE INTO FUNCTIONAL POOLS (not just ingredient type)
  const pools = {
    primaryProtein: constrainedIngredients.filter(i => 
      i.category === 'protein' && (i.composition.protein || 0) > 20
    ),
    secondaryProtein: constrainedIngredients.filter(i => 
      i.category === 'protein' && (i.composition.protein || 0) > 10 && (i.composition.protein || 0) <= 20
    ),
    carb: constrainedIngredients.filter(i => i.category === 'grain'),
    fiberVeg: constrainedIngredients.filter(i => i.category === 'vegetable'),
    fat: constrainedIngredients.filter(i => i.category === 'fat'),
    fruit: constrainedIngredients.filter(i => i.category === 'fruit'),
    seed: constrainedIngredients.filter(i => i.category === 'seed'),
    insect: constrainedIngredients.filter(i => i.category === 'insect'),
    hay: constrainedIngredients.filter(i => i.category === 'hay'),
  };
  
  // STEP 3: INGREDIENT OPTIMIZER - Score each ingredient by fitness (not final score)
  const ingredientFitness = (ing: any): number => {
    let fitness = 0;
    
    // Species safety (0-1)
    const speciesSafety = ing.composition.speciesCompatibility?.[petType === 'pocket-pets' ? 'pocket-pet' : petType];
    if (speciesSafety === 'ok') fitness += 1.0;
    else if (speciesSafety === 'limit') fitness += 0.5;
    else if (speciesSafety === 'caution') fitness += 0.2;
    
    // Health alignment (0-2)
    if (pet.healthConcerns && pet.healthConcerns.length > 0) {
      // Bonus for ingredients that support health concerns
      if (ing.composition.protein && pet.healthConcerns.includes('muscle-loss')) fitness += 0.5;
      if (ing.composition.omega3 && pet.healthConcerns.includes('joint-health')) fitness += 0.5;
      if (ing.composition.fiber && pet.healthConcerns.includes('digestion')) fitness += 0.5;
    }
    
    // Cost penalty (0-2, lower is better)
    const price = getProductPrice(ing.name);
    if (price !== null) {
      if (price < 2) fitness += 1.5;
      else if (price < 5) fitness += 1.0;
      else if (price < 10) fitness += 0.5;
      else fitness -= 1.0;
    }
    
    // Overuse penalty (0-1)
    const recentIngredients = getRecentIngredients(ing.id) || [];
    if (Array.isArray(recentIngredients) && recentIngredients.length > 3) fitness -= 0.5;
    
    return fitness;
  };
  
  // STEP 4: SELECT TOP INGREDIENTS FROM EACH POOL
  const selectTopFromPool = (pool: any[], count: number = 1): any[] => {
    return pool
      .map(ing => ({ ing, fitness: ingredientFitness(ing) }))
      .sort((a, b) => b.fitness - a.fitness)
      .slice(0, count)
      .map(x => x.ing);
  };
  
  const selected: any[] = [];
  
  // MANDATORY: Primary protein for carnivores/omnivores only
  // Herbivores (rabbits, guinea pigs, some reptiles) should NOT get meat
  const isHerbivore = petType === 'pocket-pets' && (pet.breed?.toLowerCase().includes('rabbit') || pet.breed?.toLowerCase().includes('guinea'));
  const isOmnivore = !isCarnivore && !isHerbivore;
  
  if (isCarnivore || isOmnivore) {
    const selectedProtein = selectTopFromPool(pools.primaryProtein, 1);
    if (selectedProtein.length > 0) {
      selected.push(selectedProtein[0]);
    } else if (pools.secondaryProtein.length > 0) {
      const secondary = selectTopFromPool(pools.secondaryProtein, 1);
      if (secondary.length > 0) selected.push(secondary[0]);
    } else if (isCarnivore) {
      console.warn(`No suitable protein found for carnivorous pet ${pet.name}`);
    }
    
    // OPTIONAL: Secondary protein (variety)
    if (seed % 2 === 0 && pools.secondaryProtein.length > 0) {
      const secondary = selectTopFromPool(pools.secondaryProtein, 1);
      if (secondary.length > 0 && secondary[0].id !== selected[0]?.id) {
        selected.push(secondary[0]);
      }
    }
  }
  
  // CARB: Choose based on health concerns
  if (pools.carb.length > 0) {
    const carbs = selectTopFromPool(pools.carb, 1);
    if (carbs.length > 0) selected.push(carbs[0]);
  }
  
  // FIBER/VEG: Always include for herbivores, optional for carnivores
  if (pools.fiberVeg.length > 0) {
    const isHerbivore = petType === 'pocket-pets' || petType === 'reptiles';
    if (isHerbivore || seed % 2 === 0) {
      const veg = selectTopFromPool(pools.fiberVeg, 1);
      if (veg.length > 0) selected.push(veg[0]);
    }
  }
  
  // FAT: Include for omega-3 and energy
  if (pools.fat.length > 0 && seed % 3 !== 0) {
    const fat = selectTopFromPool(pools.fat, 1);
    if (fat.length > 0) selected.push(fat[0]);
  }
  
  // FRUIT: Optional, low priority
  if (pools.fruit.length > 0 && seed % 4 === 0) {
    const fruit = selectTopFromPool(pools.fruit, 1);
    if (fruit.length > 0) selected.push(fruit[0]);
  }
  
  // Calculate portions to meet nutritional targets
  const weightKg = pet.weightKg || parseFloat(pet.weight || '10');
  const portionedIngredients = selected.map((ing) => {
    let amount = 100; // grams
    
    if (ing.category === 'protein') {
      amount = Math.round(weightKg * 8);
    } else if (ing.category === 'grain') {
      amount = Math.round(weightKg * 6);
    } else if (ing.category === 'vegetable') {
      amount = Math.round(weightKg * 3);
    } else if (ing.category === 'fruit') {
      amount = Math.round(weightKg * 2);
    } else if (ing.category === 'fat') {
      amount = Math.round(weightKg * 0.5);
    } else if (ing.category === 'seed') {
      amount = Math.round(weightKg * 1);
    } else if (ing.category === 'insect') {
      amount = Math.round(weightKg * 4);
    } else if (ing.category === 'hay') {
      amount = Math.round(weightKg * 5);
    }
    
    return { ingredient: ing, amount };
  });
  
  // Build recipe
  const recipeIngredients = portionedIngredients.map(p => ({
    id: p.ingredient.id,
    name: p.ingredient.name,
    amount: `${p.amount}g`,
  }));
  
  const ingredientNames = recipeIngredients.map(i => i.name).join(' & ');
  const recipeName = `${pet.name || 'Pet'}'s ${ingredientNames}`;
  
  // Calculate nutrition from composition data
  let totalProtein = 0;
  let totalFat = 0;
  let totalCalories = 0;
  let totalFiber = 0;
  
  for (const p of portionedIngredients) {
    const comp = p.ingredient.composition;
    const grams = p.amount;
    
    totalProtein += ((comp.protein || 0) * grams) / 100;
    totalFat += ((comp.fat || 0) * grams) / 100;
    totalCalories += ((comp.kcal || 50) * grams) / 100;
    totalFiber += ((comp.fiber || 0) * grams) / 100;
  }
  
  const ingredientBreakdown = portionedIngredients.map(p => ({
    ingredient: p.ingredient as unknown as Ingredient,
    contribution: {
      protein: ((p.ingredient.composition.protein || 0) * p.amount) / 100,
      fat: ((p.ingredient.composition.fat || 0) * p.amount) / 100,
      calories: ((p.ingredient.composition.kcal || 50) * p.amount) / 100,
    },
  }));
  
  return {
    templateId: 'dynamic',
    generationTimestamp: new Date(),
    name: recipeName,
    description: `Nutritionally balanced recipe for ${pet.name} using ${recipeIngredients.length} ingredients`,
    category: pet.type as PetCategory,
    healthConcerns: pet.healthConcerns || [],
    ageGroup: [pet.age || 'adult'],
    ingredients: recipeIngredients,
    instructions: [
      'Combine all ingredients',
      'Cook protein thoroughly if needed',
      'Mix with other ingredients',
      'Cool to room temperature before serving',
    ],
    prepTime: '10 min',
    cookTime: '20 min',
    servings: 1,
    tags: pet.healthConcerns || [],
    imageUrl: `/images/generated/${pet.type}-custom.png`,
    nutritionalCalculation: {
      calories: totalCalories,
      protein: totalProtein,
      fat: totalFat,
      fiber: totalFiber,
    },
    ingredientBreakdown,
  } as any;
}

/**
 * Infer ingredient category from ID or composition
 */
function getIngredientCategory(id: string, comp: any): string {
  if (comp.category) return comp.category;
  if (id.includes('protein') || id.includes('meat') || id.includes('fish') || id.includes('chicken') || id.includes('beef')) return 'protein';
  if (id.includes('rice') || id.includes('grain') || id.includes('oat') || id.includes('barley')) return 'grain';
  if (id.includes('vegetable') || id.includes('carrot') || id.includes('spinach') || id.includes('broccoli')) return 'vegetable';
  if (id.includes('fruit') || id.includes('apple') || id.includes('berry')) return 'fruit';
  if (id.includes('oil') || id.includes('fat')) return 'fat';
  return 'other';
}

/**
 * Prioritize ingredients based on health concerns
 */
function prioritizeIngredientsForHealth(ingredients: any[], pet: Pet): any[] {
  const concerns = pet.healthConcerns || [];
  if (concerns.length === 0) return ingredients;
  
  // Score each ingredient based on health benefits
  return ingredients.sort((a, b) => {
    const aScore = scoreIngredientForHealth(a, concerns);
    const bScore = scoreIngredientForHealth(b, concerns);
    return bScore - aScore;
  });
}

/**
 * Score ingredient for health benefits
 */
function scoreIngredientForHealth(ingredient: any, concerns: string[]): number {
  let score = 0;
  const comp = ingredient.composition;
  
  for (const concern of concerns) {
    if (concern.includes('digestive') && (comp.fiber || 0) > 2) score += 2;
    if (concern.includes('joint') && (comp.omega3 || 0) > 0.5) score += 2;
    if (concern.includes('weight') && (comp.protein || 0) > 20) score += 2;
    if (concern.includes('skin') && (comp.omega3 || 0) > 0.5) score += 2;
    if (concern.includes('allergy') && ingredient.category === 'protein') score += 1;
  }
  
  return score;
}

/**
 * Select diverse ingredients from the full pool
 */
function selectDiverseIngredientsFromPool(ingredients: any[], seed?: number): any[] {
  const categories = {
    protein: ingredients.filter(i => i.category === 'protein'),
    grain: ingredients.filter(i => i.category === 'grain'),
    vegetable: ingredients.filter(i => i.category === 'vegetable'),
    fruit: ingredients.filter(i => i.category === 'fruit'),
    fat: ingredients.filter(i => i.category === 'fat'),
  };
  
  const selected: any[] = [];
  const s = seed || 0;
  
  // Pick one from each category, cycling through all available
  if (categories.protein.length > 0) {
    selected.push(categories.protein[s % categories.protein.length]);
  }
  if (categories.grain.length > 0) {
    selected.push(categories.grain[(s + 1) % categories.grain.length]);
  }
  if (categories.vegetable.length > 0) {
    selected.push(categories.vegetable[(s + 2) % categories.vegetable.length]);
  }
  if (categories.fruit.length > 0 && s % 3 !== 0) {
    selected.push(categories.fruit[(s + 3) % categories.fruit.length]);
  }
  if (categories.fat.length > 0 && s % 2 === 0) {
    selected.push(categories.fat[(s + 4) % categories.fat.length]);
  }
  
  return selected;
}

/**
 * Calculate portions based on composition data
 */
function calculatePortionsFromComposition(ingredients: any[], pet: Pet): any[] {
  const weightKg = pet.weightKg || parseFloat(pet.weight || '10');
  
  return ingredients.map(ing => {
    let amount = '100g';
    const comp = ing.composition;
    
    if (ing.category === 'protein') {
      amount = `${Math.round(weightKg * 8)}g`;
    } else if (ing.category === 'grain') {
      amount = `${Math.round(weightKg * 6)}g`;
    } else if (ing.category === 'vegetable') {
      amount = `${Math.round(weightKg * 3)}g`;
    } else if (ing.category === 'fruit') {
      amount = `${Math.round(weightKg * 2)}g`;
    } else if (ing.category === 'fat') {
      amount = `${Math.round(weightKg * 0.5)}g`;
    }
    
    return { ingredient: ing, amount };
  });
}

/**
 * Build recipe from composition data
 */
function buildRecipeFromCompositions(portionedIngredients: any[], pet: Pet, seed?: number): GeneratedRecipe {
  const ingredients = portionedIngredients.map(p => ({
    id: p.ingredient.id,
    name: p.ingredient.name,
    amount: p.amount,
  }));
  
  const ingredientBreakdown = portionedIngredients.map(p => {
    const comp = p.ingredient.composition;
    const grams = parseFloat(p.amount);
    return {
      ingredient: p.ingredient as unknown as Ingredient,
      contribution: {
        protein: ((comp.protein || 0) * grams) / 100,
        fat: ((comp.fat || 0) * grams) / 100,
        calories: ((comp.kcal || 50) * grams) / 100,
      },
    };
  });
  
  const totalProtein = ingredientBreakdown.reduce((s, b) => s + b.contribution.protein, 0);
  const totalFat = ingredientBreakdown.reduce((s, b) => s + b.contribution.fat, 0);
  const totalCalories = ingredientBreakdown.reduce((s, b) => s + b.contribution.calories, 0);
  
  const ingredientNames = ingredients.map(i => i.name).join(' & ');
  const recipeName = `${pet.name || 'Pet'}'s ${ingredientNames}`;
  
  return {
    templateId: 'dynamic',
    generationTimestamp: new Date(),
    id: `generated-${Date.now()}-${seed || Math.random()}`,
    name: recipeName,
    description: `Customized recipe for ${pet.name} using real ingredient data`,
    category: pet.type as PetCategory,
    healthConcerns: pet.healthConcerns || [],
    ageGroup: [pet.age || 'adult'],
    ingredients,
    instructions: [
      'Combine all ingredients',
      'Cook protein thoroughly if needed',
      'Mix with other ingredients',
      'Cool to room temperature before serving',
    ],
    prepTime: '10 min',
    cookTime: '20 min',
    servings: 1,
    tags: pet.healthConcerns || [],
    imageUrl: `/images/generated/${pet.type}-custom.png`,
    nutritionalCalculation: {
      calories: totalCalories,
      protein: totalProtein,
      fat: totalFat,
      fiber: ingredientBreakdown.reduce((s, b) => s + ((b.ingredient.composition?.fiber || 0) * parseFloat(ingredients[ingredientBreakdown.indexOf(b)].amount)) / 100, 0),
    },
    ingredientBreakdown,
  };
}

/**
 * Create a fallback recipe when dynamic generation fails
 */
function createFallbackRecipe(pet: Pet, seed?: number): GeneratedRecipe {
  const petType = pet.type as PetCategory;
  const allIngredients = INGREDIENT_TEMPLATES[petType] || [];
  
  // Pick first 3 ingredients as fallback
  const ingredients = allIngredients.slice(0, 3);
  
  if (ingredients.length === 0) {
    // Ultimate fallback - create a minimal recipe
    return {
      templateId: 'fallback',
      generationTimestamp: new Date(),
      id: `fallback-${Date.now()}-${seed || 0}`,
      name: `${pet.name || 'Pet'}'s Basic Meal`,
      description: 'Basic meal recipe',
      category: petType,
      healthConcerns: [],
      ageGroup: ['adult'],
      ingredients: [
        { id: 'protein', name: 'Protein', amount: '100g' },
        { id: 'carbs', name: 'Carbohydrates', amount: '100g' },
        { id: 'veggies', name: 'Vegetables', amount: '50g' },
      ],
      instructions: ['Mix ingredients', 'Cook if needed', 'Serve'],
      prepTime: '10 min',
      cookTime: '20 min',
      servings: 1,
      tags: [],
      imageUrl: `/images/generated/${petType}-basic.png`,
      nutritionalCalculation: {
        calories: 300,
        protein: 30,
        fat: 10,
        fiber: 3,
      },
      ingredientBreakdown: [],
    };
  }
  
  const portionedIngredients = calculatePortions(ingredients, pet);
  return buildRecipeFromIngredients(portionedIngredients, pet, seed);
}

/**
 * Get all safe ingredients for a pet (exclude allergies)
 */
function getSafeIngredientsForPet(pet: Pet): IngredientTemplate[] {
  const allergies = (pet.allergies || []).map(a => a.toLowerCase());
  const petType = pet.type as PetCategory;
  const templates = INGREDIENT_TEMPLATES[petType] || [];
  
  return templates.filter((ing: any) => {
    const ingName = ing.name.toLowerCase();
    const ingId = ing.id.toLowerCase();
    return !allergies.some(allergy => 
      ingName.includes(allergy) || ingId.includes(allergy)
    );
  });
}

/**
 * Prioritize ingredients based on health concerns
 */
function prioritizeForHealthConcerns(ingredients: IngredientTemplate[], pet: Pet): IngredientTemplate[] {
  const concerns = pet.healthConcerns || [];
  if (concerns.length === 0) return ingredients;
  
  // Map health concerns to beneficial ingredients
  const healthBenefits: Record<string, string[]> = {
    'digestive-issues': ['pumpkin', 'sweet potato', 'brown rice', 'chicken'],
    'joint-health': ['salmon', 'fish oil', 'sweet potato'],
    'weight-management': ['chicken', 'turkey', 'lean beef', 'spinach', 'carrots'],
    'skin-coat': ['salmon', 'fish oil', 'sweet potato'],
    'allergy-support': ['chicken', 'turkey', 'sweet potato', 'pumpkin'],
    'kidney-disease': ['chicken', 'white fish', 'white rice'],
  };
  
  // Sort ingredients: beneficial ones first
  return ingredients.sort((a, b) => {
    const aIsBeneficial = concerns.some(c => 
      healthBenefits[c]?.some(benefit => a.name.toLowerCase().includes(benefit))
    );
    const bIsBeneficial = concerns.some(c => 
      healthBenefits[c]?.some(benefit => b.name.toLowerCase().includes(benefit))
    );
    return aIsBeneficial === bIsBeneficial ? 0 : aIsBeneficial ? -1 : 1;
  });
}

/**
 * Select diverse ingredients (protein, carbs, veggies, fats)
 * Uses seed to create deterministic but varied selections
 * Ensures all ingredients are used across 50 recipes
 */
function selectDiverseIngredients(ingredients: IngredientTemplate[], pet: Pet, seed: number): IngredientTemplate[] {
  const categories = {
    protein: ingredients.filter(i => i.category === 'protein'),
    carbs: ingredients.filter(i => i.category === 'grain'),
    veggies: ingredients.filter(i => i.category === 'vegetable'),
    fats: ingredients.filter(i => i.category === 'fat'),
  };
  
  const selected: IngredientTemplate[] = [];
  
  // Use seed to cycle through ALL ingredients deterministically
  // With 50 seeds, we'll use each ingredient multiple times in different combinations
  
  // Pick a protein - cycle through all proteins
  if (categories.protein.length > 0) {
    const idx = seed % categories.protein.length;
    selected.push(categories.protein[idx]);
  }
  
  // Pick a carb - offset seed so it doesn't match protein selection
  if (categories.carbs.length > 0) {
    const idx = (seed + Math.floor(seed / categories.protein.length)) % categories.carbs.length;
    selected.push(categories.carbs[idx]);
  }
  
  // Pick a veggie - different offset
  if (categories.veggies.length > 0) {
    const idx = (seed + Math.floor(seed / (categories.protein.length * categories.carbs.length))) % categories.veggies.length;
    selected.push(categories.veggies[idx]);
  }
  
  // Pick a fat - different offset, optional
  if (categories.fats.length > 0) {
    const idx = (seed * 2) % categories.fats.length;
    // Include fat ~60% of the time
    if (seed % 5 !== 0) {
      selected.push(categories.fats[idx]);
    }
  }
  
  return selected;
}

/**
 * Calculate portions based on pet weight and ingredient type
 */
function calculatePortions(ingredients: IngredientTemplate[], pet: Pet): Array<{ ingredient: IngredientTemplate; amount: string }> {
  const weightKg = pet.weightKg || parseFloat(pet.weight || '10');
  const dailyCalories = weightKg < 5 ? 200 : weightKg < 15 ? 400 : weightKg < 30 ? 800 : 1200;
  
  return ingredients.map(ing => {
    let amount = '100g'; // default
    
    if (ing.category === 'protein') {
      // ~40% of calories from protein
      amount = `${Math.round(weightKg * 8)}g`;
    } else if (ing.category === 'grain') {
      // ~40% of calories from carbs
      amount = `${Math.round(weightKg * 6)}g`;
    } else if (ing.category === 'vegetable') {
      // ~15% of calories from veggies
      amount = `${Math.round(weightKg * 3)}g`;
    } else if (ing.category === 'fat') {
      // ~5% of calories from fats
      amount = `${Math.round(weightKg * 0.5)}g`;
    }
    
    return { ingredient: ing, amount };
  });
}

/**
 * Build a complete recipe from selected ingredients
 */
function buildRecipeFromIngredients(
  portionedIngredients: Array<{ ingredient: IngredientTemplate; amount: string }>,
  pet: Pet,
  seed?: number
): GeneratedRecipe {
  const ingredients = portionedIngredients.map(p => ({
    id: p.ingredient.id,
    name: p.ingredient.name,
    amount: p.amount,
  }));
  
  const ingredientBreakdown = portionedIngredients.map(p => ({
    ingredient: p.ingredient as unknown as Ingredient,
    contribution: {
      protein: (p.ingredient.nutritionalProfile.protein || 0) * (parseFloat(p.amount) / 100),
      fat: (p.ingredient.nutritionalProfile.fat || 0) * (parseFloat(p.amount) / 100),
      calories: (p.ingredient.nutritionalProfile.calories || 50) * (parseFloat(p.amount) / 100),
    },
  }));
  
  const totalProtein = ingredientBreakdown.reduce((s, b) => s + b.contribution.protein, 0);
  const totalFat = ingredientBreakdown.reduce((s, b) => s + b.contribution.fat, 0);
  const totalCalories = ingredientBreakdown.reduce((s, b) => s + b.contribution.calories, 0);
  
  const ingredientNames = ingredients.map(i => i.name).join(' & ');
  const recipeName = `${pet.name || 'Pet'}'s Custom ${ingredientNames}`;
  
  return {
    templateId: 'dynamic',
    generationTimestamp: new Date(),
    id: `generated-${Date.now()}-${seed || Math.random()}`,
    name: recipeName,
    description: `Customized recipe for ${pet.name} based on their allergies, health concerns, and weight`,
    category: pet.type,
    healthConcerns: pet.healthConcerns || [],
    ageGroup: [pet.age || 'adult'],
    ingredients,
    instructions: [
      'Combine all ingredients',
      'Cook protein thoroughly',
      'Mix with vegetables and grains',
      'Cool to room temperature before serving',
      `Serve ${Math.round(totalCalories / 100)}g portions daily`,
    ],
    prepTime: '10 min',
    cookTime: '20 min',
    servings: 1,
    tags: pet.healthConcerns || [],
    imageUrl: `/images/generated/${pet.type}-custom.png`,
    nutritionalCalculation: {
      calories: totalCalories,
      protein: totalProtein,
      fat: totalFat,
      fiber: ingredientBreakdown.reduce((s, b) => s + ((b.ingredient as any).nutritionalProfile.fiber || 0), 0),
    },
    ingredientBreakdown,
  };
}

export function getRecipeTemplates(category?: PetCategory, style?: RecipeStyle): RecipeTemplate[] {
  return TEMPLATE_LIBRARY.filter(t => (!category || t.category === category) && (!style || t.style === style));
}

export async function loadAndIntegrateScrapedData() {
  // Stubbed: in real use we would fetch and merge scraped veterinary data.
  const insights: ScrapedInsights = { commonIngredients: {}, healthFocusAreas: {}, ingredientHealthMap: {} };
  const enhancedIngredients = TEMPLATE_LIBRARY.flatMap(t => t.baseIngredients);
  const healthInsights = enhanceHealthConcernsWithScrapedData([]);
  return { enhancedIngredients, healthInsights, insights };
}
</file>

<file path="lib/scoreRecipe.ts">
import type { Recipe } from './types';
import { dogModifiers } from './data/nutrition-dog-modifiers';
import { catModifiers } from './data/nutrition-cat-modifiers';
import { matchesSpecies } from './utils/recipeRecommendations';
import {
  calculateEnhancedCompatibility,
  type Pet as EnhancedPet,
} from './utils/enhancedCompatibilityScoring';

export interface ScoreReasoning {
  goodMatches: string[];
  conflicts: string[];
}

export interface ScoreResult {
  compatibilityScore: number; // 0-100 (formerly matchScore)
  matchScore: number; // 0-100 (deprecated - use compatibilityScore)
  stars: number; // 1-5
  reasoning: ScoreReasoning;
  conflictCount: number; // number of avoid rule conflicts
  hasHydrationSupport: boolean; // for kidney/urinary
  summaryReasoning?: string;
  recommendations?: string[];
}

const commonAllergens = [
  'chicken',
  'beef',
  'pork',
  'fish',
  'soy',
  'dairy',
  'egg',
  'wheat',
  'peanut',
  'lamb',
];

function toLower(s?: string) {
  return (s || '').toLowerCase();
}

function containsAllergen(recipe: Recipe, allergies: string[] = []) {
  const ingredientText = (recipe.ingredients || []).map((i) => toLower(i.name)).join(' ');
  // if user specified allergies explicitly, check those first
  for (const a of allergies) {
    const aLow = toLower(a);
    if (!aLow) continue;
    if (ingredientText.includes(aLow)) return aLow;
    // check substring matches for common names
  }
  // fallback: check against commonAllergens
  for (const allergen of commonAllergens) {
    if (ingredientText.includes(allergen)) return allergen;
  }
  return null;
}

function mapScoreToStars(score: number) {
  if (score >= 90) return 5;
  if (score >= 75) return 4;
  if (score >= 55) return 3;
  if (score >= 30) return 2;
  return 1;
}

// Helper function to get related keywords for health concerns
function getRelatedKeywords(concern: string): string[] {
  const keywordMap: Record<string, string[]> = {
    'allergies': ['skin', 'itch', 'immune', 'inflammatory'],
    'joint-health': ['arthritis', 'mobility', 'inflammatory', 'bone', 'cartilage'],
    'digestive-issues': ['gi', 'stomach', 'gut', 'inflammatory', 'sensitive'],
    'weight-management': ['low-calorie', 'lean', 'obesity', 'weight', 'calorie'],
    'kidney-disease': ['kidney', 'renal', 'phosphorus', 'hydration'],
    'urinary-health': ['urinary', 'uti', 'hydration', 'bladder'],
    'dental-issues': ['dental', 'teeth', 'tartar', 'oral'],
    'heart-disease': ['heart', 'cardiac', 'taurine', 'omega-3'],
    'diabetes': ['diabetes', 'sugar', 'glucose', 'insulin'],
    'respiratory': ['respiratory', 'breathing', 'lungs', 'airway'],
  };
  
  return keywordMap[concern] || [];
}

// Normalize human-readable health concerns to recipe format (kebab-case)
function normalizeHealthConcernForMatching(concern: string): string {
  const normalized = concern.toLowerCase().trim();
  
  // Map human-readable concerns to recipe format
  const mapping: Record<string, string> = {
    // Dogs
    'allergies/skin issues': 'allergies',
    'allergies': 'allergies',
    'allergy': 'allergies',
    'skin issues': 'allergies',
    'arthritis/joint pain': 'joint-health',
    'joint pain': 'joint-health',
    'arthritis': 'joint-health',
    'dental problems': 'dental-issues',
    'dental disease': 'dental-issues',
    'dental issues': 'dental-issues',
    'digestive issues': 'digestive-issues',
    'digestive': 'digestive-issues',
    'ear infections': 'ear-infections',
    'obesity/weight management': 'weight-management',
    'obesity': 'weight-management',
    'weight management': 'weight-management',
    'kidney disease': 'kidney-disease',
    'kidney': 'kidney-disease',
    'heart disease': 'heart-disease',
    'heart': 'heart-disease',
    'pancreatitis': 'pancreatitis',
    'pancreatic': 'pancreatitis',
    'diabetes': 'diabetes',
    'diabetic': 'diabetes',
    'skin conditions': 'skin-conditions',
    'skin condition': 'skin-conditions',
    'urinary problems': 'urinary-health',
    'urinary': 'urinary-health',
    'thyroid issues': 'thyroid',
    'thyroid': 'thyroid',
    
    // Cats
    'urinary tract issues': 'urinary-health',
    'hyperthyroidism': 'hyperthyroidism',
    'inflammatory bowel disease': 'digestive-issues',
    'ibd': 'digestive-issues',
    'hairballs': 'hairball',
    'hairball': 'hairball',
    'respiratory issues': 'respiratory',
    'skin allergies': 'allergies',
    
    // Birds
    'feather plucking': 'feather-plucking',
    'respiratory infection': 'respiratory',
    'beak overgrowth': 'beak-overgrowth',
    'vitamin deficiencies': 'vitamin-deficiency',
    'heavy metal exposure': 'heavy-metal',
    'egg binding': 'egg-binding',
    'fatty liver disease': 'fatty-liver',
    'nutritional imbalances': 'nutritional-deficiency',
    
    // Reptiles
    'metabolic bone disease': 'metabolic-bone-disease',
    'mbd': 'metabolic-bone-disease',
    'parasites': 'parasites',
    'stuck shed': 'stuck-shed',
    'impaction': 'impaction',
    'mouth rot': 'mouth-rot',
    'thermal burns': 'thermal-burns',
    'nutritional deficiencies': 'nutritional-deficiency',
    
    // Pocket pets (removed duplicates - already defined above)
    'skin/fur issues': 'skin-conditions',
  };
  
  // Try exact match first
  if (mapping[normalized]) {
    return mapping[normalized];
  }
  
  // Try partial matches (e.g., "obesity/weight management" contains "weight management")
  for (const [key, value] of Object.entries(mapping)) {
    if (normalized.includes(key) || key.includes(normalized)) {
      return value;
    }
  }
  
  // Fallback: convert to kebab-case
  return normalized.replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

const concernToModifierKey: Record<string, string> = {
  allergies: 'allergies',
  'joint-health': 'joint_issues',
  'weight-management': 'weight_management',
  digestive: 'gi_issues',
  'digestive-issues': 'gi_issues',
  'gi-issues': 'gi_issues',
  'kidney': 'kidney_support',
  'kidney-disease': 'kidney_support',
  'kidney/urinary-support': 'kidney_support',
  'urinary-health': 'urinary_health',
  diabetes: 'diabetes',
  'pancreatitis': 'pancreatitis',
  'heart-disease': 'heart_disease',
  'heart disease': 'heart_disease',
  'skin-conditions': 'skin_conditions',
  'skin conditions': 'skin_conditions',
  'skin-coat': 'skin_conditions',
  'dental-issues': 'dental_issues',
  'dental': 'dental_issues',
};

export function scoreRecipe(recipe: Recipe, pet: any): ScoreResult {
  const reasoning: ScoreReasoning = { goodMatches: [], conflicts: [] };
  let conflictCount = 0;
  let hasHydrationSupport = false;

  // Species gate: use matchesSpecies to support subtype matching for exotics
  if (!matchesSpecies(recipe, pet)) {
    reasoning.conflicts.push('Different species - not suitable');
    return { compatibilityScore: 0, matchScore: 0, stars: 1, reasoning, conflictCount: 1, hasHydrationSupport };
  }

  // Debug logging (only in development)
  if (process.env.NODE_ENV === 'development' && Math.random() < 0.1) { // Log 10% of calls
    // Debug logging removed - use logger if needed
  }

  // Base score components - start with higher base
  let score = 50; // Base score for species/age match
  let possible = 100; // total possible when nutrition present

  // Age match +15
  if (recipe.ageGroup && pet.age && recipe.ageGroup.includes(pet.age)) {
    score += 15;
    reasoning.goodMatches.push('Age group match');
  }
  // NO ELSE STATEMENT - no penalty for missing

  // Breed relevance +10
  if (recipe.breed && pet.breed && recipe.breed.includes(pet.breed)) {
    score += 10;
    reasoning.goodMatches.push('Breed-specific match');
  }

  // Health concerns: Use as modifiers, not blockers
  // Bonus if aligned, small penalty if not (but don't block)
  // Normalize pet concerns to recipe format for matching
  const petConcernsNormalized: string[] = (pet.healthConcerns || []).map((c: string) => 
    normalizeHealthConcernForMatching(String(c).toLowerCase())
  );
  const recipeConcernsNormalized: string[] = (recipe.healthConcerns || []).map((c: string) => 
    String(c).toLowerCase().trim()
  );
  
  let healthMatches = 0;
  let healthMismatches = 0;
  
  if (petConcernsNormalized.length > 0) {
    if (recipeConcernsNormalized.length > 0) {
      // Check for matches (exact or partial)
      for (const petConcern of petConcernsNormalized) {
        const matched = recipeConcernsNormalized.some(rc => 
          rc === petConcern || 
          rc.includes(petConcern) || 
          petConcern.includes(rc)
        );
        if (matched) {
          healthMatches += 1;
          const originalConcern = (pet.healthConcerns || [])[petConcernsNormalized.indexOf(petConcern)];
          reasoning.goodMatches.push(`Supports ${originalConcern}`);
          if (healthMatches >= 4) break;
        } else {
          healthMismatches += 1;
        }
      }
    } else {
      // Recipe has no health concern tags - small penalty but don't block
      healthMismatches = petConcernsNormalized.length;
      reasoning.conflicts.push('Not optimized for health concerns (but still safe)');
    }
  }
  
  // Bonus for matches: +15 each up to +60
  score += Math.min(4, healthMatches) * 15;
  
  // Small penalty for mismatches: -5 each, but don't go below base score
  score -= Math.min(healthMismatches * 5, 20); // Max -20 penalty
  score = Math.max(score, 30); // Never go below 30 if species matches

  // Weight control fit: +10 if pet overweight and recipe flags low-calorie
  const weightFlag = ((recipe.tags || []).map((t) => t.toLowerCase()).includes('low-calorie')) || false;
  if (pet.weightKg && (pet as any).weightStatus === 'overweight') {
    if (weightFlag) {
      score += 10;
      reasoning.goodMatches.push('Low-calorie fit for weight control');
    }
  }

  // Allergy detection: if pet has 'allergy' in concerns or explicit allergies, penalize heavily
  const normalizedPetConcernsForAllergy = petConcernsNormalized.filter((c: string) => c.includes('allerg') || c.includes('allergy'));
  const explicitAllergies: string[] = (pet && pet.allergies) || [];
  const allergyTrigger = containsAllergen(recipe, explicitAllergies.length ? explicitAllergies : normalizedPetConcernsForAllergy);
  if (allergyTrigger) {
    reasoning.conflicts.push(`Contains potential allergen: ${allergyTrigger}`);
    conflictCount += 1;
    // allergy override: near-zero
    return { compatibilityScore: 0, matchScore: 0, stars: 1, reasoning, conflictCount, hasHydrationSupport };
  }

  // Nutrient fit: +15 if nutritional info present and assumed within AAFCO range
  const hasNutrition = !!recipe.nutritionalInfo || !!recipe.nutritionInfo;
  if (hasNutrition) {
    // Simple heuristic: if nutritionalInfo exists, grant full nutrient fit
    score += 15;
    reasoning.goodMatches.push('Nutritional profile fits AAFCO ranges');
  } else {
    // If nutrition missing, lower max possible to 80
    possible = 80;
  }

  // Apply modifiers if applicable
  const modifiers = pet.type === 'dogs' ? dogModifiers : pet.type === 'cats' ? catModifiers : null;
  if (modifiers) {
    // Use normalized concerns for modifier matching
    for (let i = 0; i < petConcernsNormalized.length; i++) {
      const petConcernNormalized = petConcernsNormalized[i];
      const modKey = concernToModifierKey[petConcernNormalized];
      if (modKey && (modifiers as any)[modKey]) {
        const modifier = (modifiers as any)[modKey];
        // If recipe supports the concern, add boost
        if (recipeConcernsNormalized.some((rc: string) => rc.includes(petConcernNormalized) || petConcernNormalized.includes(rc))) {
          score += modifier.scoreBoost;
          const originalConcern = (pet.healthConcerns || [])[i];
          reasoning.goodMatches.push(`+${modifier.scoreBoost} for ${originalConcern} support`);
        }
        // Check for avoid ingredients
        const ingredientText = (recipe.ingredients || []).map((i) => toLower(i.name)).join(' ');
        for (const avoid of modifier.avoid) {
          if (ingredientText.includes(avoid.toLowerCase())) {
            score -= 5;
            conflictCount += 1;
            reasoning.conflicts.push(`-5 for containing ${avoid} (${petConcernNormalized})`);
          }
        }
        // Check if this modifier provides hydration support
        if (petConcernNormalized === 'kidney-disease' || petConcernNormalized === 'kidney' || petConcernNormalized === 'urinary-health') {
          hasHydrationSupport = true;
        }
      }
    }
  }

  // Normalize final score to 0..100 given 'possible'
  // But first, ensure negative conflicts do not drop below 0 (we handled allergies above)

  // Cap score to possible (shouldn't exceed)
  if (score > possible) score = possible;
  if (score < 0) score = 0;

  // Map into 0..100 proportionally
  const compatibilityScore = Math.round((score / possible) * 100);
  const stars = mapScoreToStars(compatibilityScore);

  return { compatibilityScore, matchScore: compatibilityScore, stars, reasoning, conflictCount, hasHydrationSupport };
}

/**
 * Improved scoring wrapper using the enhanced algorithm from improvedCompatibilityScoring.
 * Keeps the original ScoreResult shape for drop-in use.
 */
export function scoreRecipeImproved(recipe: Recipe, pet: any): ScoreResult {
  const enhancedPet: EnhancedPet = {
    id: pet.id,
    name: pet.name,
    type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
    breed: pet.breed,
    age: typeof pet.age === 'string' ? parseFloat(pet.age) || 1 : pet.age || 1,
    weight: pet.weight || pet.weightKg || 10,
    activityLevel: pet.activityLevel,
    healthConcerns: pet.healthConcerns || [],
    dietaryRestrictions: pet.dietaryRestrictions || [],
    allergies: pet.allergies || [],
  };

  const result = calculateEnhancedCompatibility(recipe, enhancedPet);
  const stars = Math.round(result.overallScore / 20);
  return {
    compatibilityScore: result.overallScore,
    matchScore: result.overallScore, // Keep for backward compatibility
    stars: stars,
    reasoning: {
      goodMatches: result.detailedBreakdown.healthBenefits,
      conflicts: result.detailedBreakdown.warnings,
    },
    conflictCount: result.detailedBreakdown.warnings.length,
    hasHydrationSupport: false,
    summaryReasoning: `Compatibility score: ${result.overallScore}% (${result.grade})`,
    recommendations: result.detailedBreakdown.recommendations,
  };
}
</file>

<file path="lib/seo/metadata.ts">
// SEO Metadata Configurations for Key Pages
import { Metadata } from 'next';

const baseUrl = 'https://petplatesmealplatform-ldvstwjsy-plateandpaw.vercel.app';

// Helper to generate structured data for recipes
export function generateRecipeStructuredData(recipe: any) {
  return {
    "@context": "https://schema.org",
    "@type": "Recipe",
    "name": recipe.name,
    "description": recipe.description,
    "image": recipe.imageUrl ? `${baseUrl}${recipe.imageUrl}` : undefined,
    "prepTime": recipe.prepTime,
    "cookTime": recipe.cookTime,
    "recipeYield": `${recipe.servings} servings`,
    "recipeCategory": "Pet Food",
    "recipeCuisine": "Pet Nutrition",
    "keywords": `${recipe.category} food, homemade pet food, ${recipe.name}`,
    "recipeIngredient": recipe.ingredients?.map((i: any) => i.name) || [],
    "recipeInstructions": recipe.instructions?.map((step: string, idx: number) => ({
      "@type": "HowToStep",
      "position": idx + 1,
      "text": step
    })) || [],
    "author": {
      "@type": "Organization",
      "name": "Paw & Plate"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "reviewCount": "127"
    }
  };
}

// Page-specific metadata configurations
export const pageMetadata: Record<string, Metadata> = {
  home: {
    title: 'Paw & Plate - Fresh Meal Prep for Dogs, Cats, Birds, Reptiles & Small Pets',
    description: 'Free vet-approved meal plans for ALL your pets. Custom recipes for dogs, cats, birds, reptiles, and pocket pets with one-click Amazon ingredient ordering. AAFCO & WSAVA compliant.',
    keywords: ['homemade dog food', 'homemade cat food', 'DIY pet meals', 'pet meal prep', 'fresh pet food recipes'],
    openGraph: {
      title: 'Paw & Plate - Fresh Meal Prep for All Pets',
      description: 'Free vet-approved meal plans with one-click Amazon ordering',
    },
  },
  
  dogs: {
    title: 'Homemade Dog Food Recipes - Vet-Approved & AAFCO Compliant',
    description: 'Free custom dog food recipes for all breeds, ages, and health needs. AAFCO compliant nutrition with Amazon ingredient links. Puppy, adult, and senior meal plans.',
    keywords: ['homemade dog food', 'dog food recipes', 'puppy food recipes', 'senior dog food', 'healthy dog meals'],
    openGraph: {
      title: 'Homemade Dog Food Recipes - Vet-Approved',
      description: 'AAFCO compliant dog food recipes for all breeds and ages',
    },
  },
  
  cats: {
    title: 'Homemade Cat Food Recipes - Vet-Approved & Balanced',
    description: 'Free custom cat food recipes for all breeds and ages. AAFCO compliant nutrition with Amazon ingredient links. Kitten, adult, and senior meal plans.',
    keywords: ['homemade cat food', 'cat food recipes', 'kitten food recipes', 'senior cat food', 'healthy cat meals'],
    openGraph: {
      title: 'Homemade Cat Food Recipes - Vet-Approved',
      description: 'AAFCO compliant cat food recipes for all breeds and ages',
    },
  },
  
  birds: {
    title: 'Bird Food Recipes & Diet Plans - Parrot, Parakeet, Cockatiel Nutrition',
    description: 'Custom bird diet plans for parrots, parakeets, cockatiels, and more. Evidence-based avian nutrition with ingredient shopping links.',
    keywords: ['bird food recipes', 'parrot diet', 'parakeet food', 'cockatiel nutrition', 'homemade bird food'],
    openGraph: {
      title: 'Bird Food Recipes - Avian Nutrition Plans',
      description: 'Evidence-based diet plans for parrots, parakeets, and more',
    },
  },
  
  reptiles: {
    title: 'Reptile Diet Plans - Bearded Dragon, Gecko, Snake Nutrition',
    description: 'Custom reptile diet plans for bearded dragons, geckos, snakes, and more. Species-specific nutrition with ingredient links.',
    keywords: ['reptile diet', 'bearded dragon food', 'gecko diet', 'snake feeding', 'reptile nutrition'],
    openGraph: {
      title: 'Reptile Diet Plans - Species-Specific Nutrition',
      description: 'Custom diet plans for bearded dragons, geckos, snakes, and more',
    },
  },
  
  'pocket-pets': {
    title: 'Small Pet Food Recipes - Hamster, Rabbit, Guinea Pig Nutrition',
    description: 'Custom diet plans for rabbits, hamsters, guinea pigs, ferrets, and more. Small pet nutrition with ingredient shopping links.',
    keywords: ['rabbit food', 'hamster diet', 'guinea pig nutrition', 'ferret food', 'small pet recipes'],
    openGraph: {
      title: 'Small Pet Food Recipes - Hamster, Rabbit, Guinea Pig',
      description: 'Custom diet plans for rabbits, hamsters, guinea pigs, and more',
    },
  },
  
  blog: {
    title: 'Pet Nutrition Blog - Meal Prep Tips & Recipes',
    description: 'Expert pet nutrition advice, homemade food recipes, and meal prep tips for dogs, cats, birds, reptiles, and small pets.',
    keywords: ['pet nutrition blog', 'pet food tips', 'homemade pet food advice', 'pet meal prep'],
    openGraph: {
      title: 'Pet Nutrition Blog - Expert Advice & Recipes',
      description: 'Expert pet nutrition advice and homemade food recipes',
    },
  },
  
  faq: {
    title: 'FAQ - Common Questions About Pet Meal Prep',
    description: 'Frequently asked questions about homemade pet food, nutrition guidelines, AAFCO compliance, and meal prep for dogs, cats, birds, reptiles, and small pets.',
    keywords: ['pet food FAQ', 'homemade pet food questions', 'AAFCO guidelines', 'pet nutrition FAQ'],
    openGraph: {
      title: 'FAQ - Pet Meal Prep Questions Answered',
      description: 'Common questions about homemade pet food and nutrition',
    },
  },
  
  contact: {
    title: 'Contact Us - Paw & Plate Support',
    description: 'Get in touch with the Paw & Plate team. Questions about pet nutrition, meal plans, or account support.',
    keywords: ['contact pet nutrition', 'Paw & Plate support', 'pet food questions'],
    openGraph: {
      title: 'Contact Paw & Plate',
      description: 'Get in touch with our pet nutrition team',
    },
  },
};

// Generate organization structured data
export const organizationStructuredData = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Paw & Plate",
  "description": "Free vet-approved meal plans for dogs, cats, birds, reptiles, and pocket pets",
  "url": baseUrl,
  "logo": `${baseUrl}/images/emojis/Mascots/HeroPics/HeroBanner-v3.png`,
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "Customer Support",
    "email": "support@pawandplate.com"
  },
  "sameAs": [
    // Add your social media profiles here when you have them
    // "https://facebook.com/pawandplate",
    // "https://twitter.com/pawandplate",
    // "https://instagram.com/pawandplate",
  ]
};

// Generate FAQ structured data for FAQ page
export function generateFAQStructuredData(faqs: { question: string; answer: string }[]) {
  return {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map(faq => ({
      "@type": "Question",
      "name": faq.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.answer
      }
    }))
  };
}

// Generate breadcrumb structured data
export function generateBreadcrumbStructuredData(items: { name: string; url: string }[]) {
  return {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": items.map((item, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": item.name,
      "item": `${baseUrl}${item.url}`
    }))
  };
}
</file>

<file path="lib/services/amazonPurchaseTracker.ts">
/**
 * Amazon Associates API integration for purchase confirmation
 * 
 * This service handles:
 * - Receiving purchase confirmations from Amazon
 * - Validating purchase data
 * - Updating purchase tracking
 * - Triggering village level updates
 * 
 * Note: This is a placeholder implementation.
 * In production, this would integrate with Amazon Associates API
 * to automatically confirm purchases when orders are completed.
 */

export interface AmazonPurchaseConfirmation {
  orderId: string;
  userId: string;
  items: Array<{
    asin: string;
    ingredientId: string;
    ingredientName: string;
    quantity: number;
    price: number;
  }>;
  orderDate: string;
  signature?: string; // For webhook verification
}

/**
 * Process Amazon purchase confirmation
 * This would be called by the webhook endpoint
 */
export async function processAmazonPurchaseConfirmation(
  confirmation: AmazonPurchaseConfirmation
): Promise<{
  success: boolean;
  confirmedCount: number;
  villageLevelUpdated: boolean;
}> {
  // TODO: Implement actual purchase confirmation logic
  // 1. Validate confirmation data
  // 2. Update purchase records in database
  // 3. Check if village level should be updated
  // 4. Return results

  return {
    success: true,
    confirmedCount: confirmation.items.length,
    villageLevelUpdated: false
  };
}

/**
 * Verify Amazon webhook signature
 */
export function verifyAmazonWebhookSignature(
  signature: string,
  payload: string,
  secret: string
): boolean {
  // TODO: Implement Amazon webhook signature verification
  // This would use HMAC-SHA256 to verify the signature
  return true; // Placeholder
}

/**
 * Get purchase confirmation URL for webhook
 */
export function getPurchaseConfirmationWebhookUrl(): string {
  // In production, this would return the actual webhook URL
  // registered with Amazon Associates API
  return '/api/amazon/purchase-confirmation';
}
</file>

<file path="lib/services/brandBasedVetter.ts">
// lib/services/brandBasedVetter.ts
// Brand-based product suggestions using analyze-brands.js data

import fs from 'fs';
import path from 'path';

interface BrandMatch {
  ingredient: string;
  brand: string;
  qualityScore: number;
  productName: string;
  confidence: number;
  category: string;
  specialties: string[];
  priceRange: string;
}

interface BrandData {
  category: string;
  qualityScore: number;
  vetRecommended: boolean;
  specialties: string[];
  priceRange: string;
  affiliateLink?: string;
}

// Brand database from analyze-brands.js
const BRAND_DATABASE: Record<string, BrandData> = {
  'Fresh Is Best': {
    category: 'freeze-dried',
    qualityScore: 9.2,
    vetRecommended: true,
    specialties: ['single-ingredient', 'human-grade', 'raw alternative'],
    priceRange: '$$',
    affiliateLink: 'https://www.freshisbest.com/'
  },
  'Vital Essentials': {
    category: 'freeze-dried',
    qualityScore: 9.0,
    vetRecommended: true,
    specialties: ['organ meats', 'grain-free', 'natural supplements'],
    priceRange: '$$',
    affiliateLink: 'https://www.vitalessentialsraw.com/'
  },
  'US Wellness Meats': {
    category: 'raw',
    qualityScore: 9.1,
    vetRecommended: true,
    specialties: ['grass-fed', 'organic', 'human-grade'],
    priceRange: '$$',
    affiliateLink: 'https://grasslandbeef.com/'
  },
  'Raw Paws': {
    category: 'raw',
    qualityScore: 8.9,
    vetRecommended: true,
    specialties: ['novel proteins', 'limited ingredients', 'digestive health'],
    priceRange: '$$',
    affiliateLink: 'https://www.rawpaws.pet/'
  },
  'Grizzly Salmon Oil': {
    category: 'supplement',
    qualityScore: 9.3,
    vetRecommended: true,
    specialties: ['wild-caught salmon', 'omega-3 concentrate', 'skin/coat health'],
    priceRange: '$',
    affiliateLink: 'https://www.grizzlys.com/'
  },
  'Primal': {
    category: 'raw',
    qualityScore: 8.7,
    vetRecommended: true,
    specialties: ['freeze-dried', 'complete nutrition', 'grain-free'],
    priceRange: '$$',
    affiliateLink: 'https://www.primalpetfoods.com/'
  },
  'Stella & Chewy\'s': {
    category: 'freeze-dried',
    qualityScore: 8.8,
    vetRecommended: true,
    specialties: ['raw-coated', 'grain-free', 'probiotics'],
    priceRange: '$$',
    affiliateLink: 'https://www.stellaandchewys.com/'
  },
  'Northwest Naturals': {
    category: 'freeze-dried',
    qualityScore: 8.8,
    vetRecommended: true,
    specialties: ['regional ingredients', 'sustainable', 'limited ingredients'],
    priceRange: '$$',
    affiliateLink: 'https://www.nwnaturals.com/'
  }
};

// Ingredient to brand mapping based on specialties
const INGREDIENT_BRAND_MAP: Record<string, string[]> = {
  // Proteins
  'chicken': ['Fresh Is Best', 'US Wellness Meats', 'Vital Essentials'],
  'chicken breast': ['Fresh Is Best', 'US Wellness Meats'],
  'ground chicken': ['US Wellness Meats', 'Raw Paws'],
  'turkey': ['US Wellness Meats', 'Raw Paws'],
  'ground turkey': ['US Wellness Meats', 'Raw Paws'],
  'beef': ['US Wellness Meats', 'Primal'],
  'ground beef': ['US Wellness Meats', 'Primal'],
  'lamb': ['Raw Paws', 'US Wellness Meats'],
  'ground lamb': ['Raw Paws', 'US Wellness Meats'],
  'duck': ['Raw Paws', 'Vital Essentials'],
  'venison': ['US Wellness Meats', 'Primal'],
  'rabbit': ['Raw Paws', 'US Wellness Meats'],
  'salmon': ['Vital Essentials', 'Fresh Is Best'],
  'fish': ['Vital Essentials', 'Fresh Is Best'],
  
  // Organs
  'heart': ['Vital Essentials', 'US Wellness Meats', 'Raw Paws'],
  'duck hearts': ['Vital Essentials', 'Raw Paws'],
  'chicken hearts': ['Vital Essentials', 'US Wellness Meats'],
  'liver': ['Vital Essentials', 'US Wellness Meats', 'Raw Paws'],
  'chicken liver': ['Vital Essentials', 'US Wellness Meats'],
  'lamb liver': ['Raw Paws', 'US Wellness Meats'],
  'kidney': ['Vital Essentials', 'US Wellness Meats'],
  'organ': ['Vital Essentials', 'US Wellness Meats'],
  
  // Oils & Supplements
  'salmon oil': ['Grizzly Salmon Oil'],
  'fish oil': ['Grizzly Salmon Oil'],
  'omega-3': ['Grizzly Salmon Oil'],
  'coconut oil': ['US Wellness Meats'],
  'flaxseed oil': ['US Wellness Meats'],
  'kelp powder': ['Vital Essentials', 'Northwest Naturals'],
  'supplement': ['Vital Essentials', 'Northwest Naturals']
};

export class BrandBasedVetter {
  findBrandMatches(ingredient: string): BrandMatch[] {
    const matches: BrandMatch[] = [];
    const normalizedIngredient = this.normalizeIngredientName(ingredient);
    
    // Check direct ingredient mapping
    const mappedBrands = INGREDIENT_BRAND_MAP[normalizedIngredient] || 
                        this.findBrandsByKeyword(normalizedIngredient);
    
    if (mappedBrands.length > 0) {
      mappedBrands.forEach(brandName => {
        const brandData = BRAND_DATABASE[brandName];
        if (brandData) {
          matches.push({
            ingredient,
            brand: brandName,
            qualityScore: brandData.qualityScore,
            productName: this.generateProductName(brandName, ingredient),
            confidence: this.calculateConfidence(ingredient, brandData, normalizedIngredient),
            category: brandData.category,
            specialties: brandData.specialties,
            priceRange: brandData.priceRange
          });
        }
      });
    }
    
    return matches.sort((a, b) => b.confidence - a.confidence);
  }
  
  private findBrandsByKeyword(ingredient: string): string[] {
    const brands: string[] = [];
    const keywords = ingredient.split(' ');
    
    Object.entries(BRAND_DATABASE).forEach(([brandName, brandData]) => {
      // Check if brand specialties match ingredient
      const matchesSpecialty = brandData.specialties.some(specialty =>
        keywords.some(keyword => specialty.toLowerCase().includes(keyword.toLowerCase()))
      );
      
      if (matchesSpecialty) {
        brands.push(brandName);
      }
    });
    
    return brands;
  }
  
  private generateProductName(brand: string, ingredient: string): string {
    // Clean ingredient name
    const cleanIngredient = ingredient
      .replace(/\(.*?\)/g, '')
      .trim();
    
    return `${brand} ${cleanIngredient}`;
  }
  
  private calculateConfidence(ingredient: string, brandData: BrandData, normalizedIngredient: string): number {
    let confidence = 0.5;
    
    // Higher confidence for higher quality scores
    if (brandData.qualityScore >= 9.0) confidence += 0.2;
    if (brandData.qualityScore >= 8.5) confidence += 0.1;
    
    // Higher confidence for vet recommended
    if (brandData.vetRecommended) confidence += 0.1;
    
    // Higher confidence for direct ingredient matches
    if (INGREDIENT_BRAND_MAP[normalizedIngredient]) {
      confidence += 0.1;
    }
    
    // Higher confidence for organ meats (brand-specific)
    if (normalizedIngredient.includes('heart') || 
        normalizedIngredient.includes('liver') || 
        normalizedIngredient.includes('kidney')) {
      confidence += 0.1;
    }
    
    // Higher confidence if brand specialty matches ingredient
    const ingredientKeywords = normalizedIngredient.split(' ');
    const specialtyMatch = brandData.specialties.some(specialty =>
      ingredientKeywords.some(keyword => 
        specialty.toLowerCase().includes(keyword.toLowerCase())
      )
    );
    if (specialtyMatch) confidence += 0.1;
    
    return Math.min(0.95, confidence);
  }
  
  private normalizeIngredientName(name: string): string {
    return name
      .toLowerCase()
      .replace(/\(.*?\)/g, '') // Remove parentheses
      .replace(/\s+/g, ' ')
      .trim();
  }
  
  generateVettedProduct(ingredient: string, brandMatch: BrandMatch): any {
    const amazonLink = brandMatch.brand === 'Grizzly Salmon Oil'
      ? 'https://www.amazon.com/s?k=Grizzly+Salmon+Plus+Omega-3+Oil&tag=robinfrench-20'
      : `https://www.amazon.com/s?k=${encodeURIComponent(brandMatch.productName)}&tag=robinfrench-20`;
    
    return {
      productName: brandMatch.productName,
      amazonLink,
      vetNote: `${brandMatch.brand} (${brandMatch.qualityScore}/10 quality score). ${brandMatch.specialties.slice(0, 2).join(', ')}. Veterinary recommended brand.`,
      category: this.getCategory(ingredient),
      commissionRate: 0.03,
      confidence: brandMatch.confidence,
      source: 'brand_analysis'
    };
  }
  
  private getCategory(ingredient: string): 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet' {
    const normalized = ingredient.toLowerCase();
    
    if (normalized.includes('heart') || normalized.includes('liver') || normalized.includes('kidney') || normalized.includes('organ')) {
      return 'Meat';
    }
    if (normalized.includes('oil') || normalized.includes('fat')) {
      return 'Oil';
    }
    if (normalized.includes('supplement') || normalized.includes('powder') || normalized.includes('capsule') || normalized.includes('kelp')) {
      return 'Supplement';
    }
    if (normalized.includes('seed') || normalized.includes('grain') || normalized.includes('flour') || normalized.includes('buckwheat') || normalized.includes('quinoa')) {
      return 'Carb';
    }
    
    return 'Meat'; // Default for proteins
  }
}
</file>

<file path="lib/services/firestoreService.ts">
import { 
  collection, 
  doc, 
  getDocs, 
  getDoc, 
  setDoc, 
  deleteDoc, 
  updateDoc, 
  query, 
  where,
  Timestamp 
} from 'firebase/firestore';
import { getFirebaseServices, getAppId } from '@/lib/utils/firebaseConfig';
import { Pet, CustomMeal } from '@/lib/types';
import { DatabaseError, ValidationError } from '@/lib/utils/errorHandler';
import { validatePet, validateCustomMeal } from '@/lib/validation/petSchema';

// Helper to get collection ref
const getCollection = (userId: string, collectionName: string) => {
  const services = getFirebaseServices();
  if (!services || !services.db) {
    throw new DatabaseError('Firebase not initialized');
  }
  const appId = getAppId();
  return collection(services.db, `artifacts/${appId}/users/${userId}/${collectionName}`);
};

// --- Pet Operations ---

export async function getPets(userId: string): Promise<Pet[]> {
  if (!userId) {
    throw new ValidationError('User ID is required');
  }

  try {
    const petsRef = getCollection(userId, 'pets');
    const snapshot = await getDocs(petsRef);
    
    const pets = snapshot.docs.map(doc => ({
      ...doc.data(),
      id: doc.id,
    })) as Pet[];
    
    // Validate each pet
    return pets.map(pet => {
      try {
        return validatePet(pet);
      } catch (e) {
        console.warn('Invalid pet data, skipping:', e);
        return null;
      }
    }).filter(Boolean) as Pet[];
  } catch (error) {
    if (error instanceof ValidationError || error instanceof DatabaseError) {
      throw error;
    }
    throw new DatabaseError('Failed to fetch pets', error as Error);
  }
}

export async function savePet(userId: string, pet: Pet): Promise<void> {
  if (!userId) {
    throw new ValidationError('User ID is required');
  }

  try {
    // Validate pet data
    const validatedPet = validatePet(pet);
    
    const petsRef = getCollection(userId, 'pets');
    const petDoc = doc(petsRef, validatedPet.id);
    
    // Convert undefined to null (Firestore doesn't accept undefined)
    const safePet = JSON.parse(JSON.stringify(validatedPet));
    
    await setDoc(petDoc, {
      ...safePet,
      updatedAt: Timestamp.now(),
    }, { merge: true });
  } catch (error) {
    if (error instanceof ValidationError || error instanceof DatabaseError) {
      throw error;
    }
    throw new DatabaseError('Failed to save pet', error as Error);
  }
}

export async function deletePet(userId: string, petId: string): Promise<void> {
  const { db } = getFirebaseServices() || {};
  if (!db) return;

  try {
    const petsRef = getCollection(userId, 'pets');
    await deleteDoc(doc(petsRef, petId));
  } catch (error) {
    console.error('Error deleting pet:', error);
    throw error;
  }
}

// --- Custom Meal Operations ---

export async function getCustomMeals(userId: string, petId: string): Promise<CustomMeal[]> {
  if (!userId || !petId) {
    throw new ValidationError('User ID and Pet ID are required');
  }

  try {
    const mealsRef = getCollection(userId, 'custom_meals');
    const q = query(mealsRef, where('petId', '==', petId));
    const snapshot = await getDocs(q);
    
    const meals = snapshot.docs.map(doc => ({
      ...doc.data(),
      id: doc.id,
    })) as CustomMeal[];
    
    // Validate each meal
    return meals.map(meal => {
      try {
        return validateCustomMeal(meal);
      } catch (e) {
        console.warn('Invalid meal data, skipping:', e);
        return null;
      }
    }).filter(Boolean) as CustomMeal[];
  } catch (error) {
    if (error instanceof ValidationError || error instanceof DatabaseError) {
      throw error;
    }
    throw new DatabaseError('Failed to fetch custom meals', error as Error);
  }
}

export async function saveCustomMeal(userId: string, meal: CustomMeal): Promise<void> {
  if (!userId) {
    throw new ValidationError('User ID is required');
  }

  try {
    // Validate meal data
    const validatedMeal = validateCustomMeal(meal);
    
    const mealsRef = getCollection(userId, 'custom_meals');
    const mealDoc = doc(mealsRef, validatedMeal.id);
    
    // Convert undefined to null
    const safeMeal = JSON.parse(JSON.stringify(validatedMeal));

    await setDoc(mealDoc, {
      ...safeMeal,
      updatedAt: Timestamp.now(),
    }, { merge: true });
  } catch (error) {
    if (error instanceof ValidationError || error instanceof DatabaseError) {
      throw error;
    }
    throw new DatabaseError('Failed to save custom meal', error as Error);
  }
}

export async function deleteCustomMeal(userId: string, mealId: string): Promise<void> {
  const { db } = getFirebaseServices() || {};
  if (!db) return;

  try {
    const mealsRef = getCollection(userId, 'custom_meals');
    await deleteDoc(doc(mealsRef, mealId));
  } catch (error) {
    console.error('Error deleting custom meal:', error);
    throw error;
  }
}
</file>

<file path="lib/services/unifiedVettingService.ts">
// lib/services/unifiedVettingService.ts
// Unified vetting service combining brand analysis + Amazon scraping

import { BrandBasedVetter } from './brandBasedVetter';
import { getVettedProduct } from '../data/vetted-products';
import fs from 'fs';
import path from 'path';

interface VettingResult {
  ingredient: string;
  status: 'vetted' | 'needs_vetting' | 'generic';
  vettedProduct?: any;
  brandMatches?: any[];
  amazonMatches?: any[];
  confidence?: number;
  recommendation?: string;
}

export class UnifiedVettingService {
  private brandVetter: BrandBasedVetter;
  
  constructor() {
    this.brandVetter = new BrandBasedVetter();
  }
  
  async getIngredientStatus(ingredientName: string): Promise<VettingResult> {
    // Check if already vetted
    const vetted = getVettedProduct(ingredientName);
    if (vetted) {
      return {
        ingredient: ingredientName,
        status: 'vetted',
        vettedProduct: vetted,
        confidence: 1.0
      };
    }
    
    // Check if generic
    if (this.isGenericIngredient(ingredientName)) {
      return {
        ingredient: ingredientName,
        status: 'generic',
        confidence: 1.0
      };
    }
    
    // Get brand matches
    const brandMatches = this.brandVetter.findBrandMatches(ingredientName);
    
    // Get Amazon matches (if available)
    const amazonMatches = await this.getAmazonMatches(ingredientName);
    
    // Calculate overall confidence
    const confidence = this.calculateOverallConfidence(brandMatches, amazonMatches);
    
    // Generate recommendation
    let recommendation = '';
    if (amazonMatches.length > 0 && amazonMatches[0].score >= 0.8) {
      recommendation = `Use Amazon product: ${amazonMatches[0].name} (${(amazonMatches[0].score * 100).toFixed(0)}% match)`;
    } else if (brandMatches.length > 0 && brandMatches[0].confidence >= 0.7) {
      recommendation = `Use brand: ${brandMatches[0].productName} (${(brandMatches[0].confidence * 100).toFixed(0)}% confidence)`;
    } else {
      recommendation = 'Manual review needed';
    }
    
    return {
      ingredient: ingredientName,
      status: 'needs_vetting',
      brandMatches: brandMatches.slice(0, 3),
      amazonMatches: amazonMatches.slice(0, 3),
      confidence,
      recommendation
    };
  }
  
  async getAllIngredientsStatus(ingredients: string[]): Promise<VettingResult[]> {
    const statuses: VettingResult[] = [];
    
    for (const ingredient of ingredients) {
      const status = await this.getIngredientStatus(ingredient);
      statuses.push(status);
    }
    
    return statuses;
  }
  
  generateVettedProductFromBrand(ingredient: string, brandMatch: any): any {
    return this.brandVetter.generateVettedProduct(ingredient, brandMatch);
  }
  
  generateVettedProductFromAmazon(ingredient: string, amazonProduct: any): any {
    return {
      productName: amazonProduct.name,
      amazonLink: amazonProduct.url,
      vetNote: `Amazon-discovered product. Rating: ${amazonProduct.rating}‚≠ê (${amazonProduct.reviewCount} reviews). Score: ${((amazonProduct.score || 0) * 100).toFixed(0)}%.`,
      category: this.determineCategory(ingredient),
      commissionRate: 0.03,
      confidence: amazonProduct.score || 0.7,
      source: 'amazon_scraper',
      asin: amazonProduct.asin
    };
  }
  
  private async getAmazonMatches(ingredientName: string): Promise<any[]> {
    try {
      // Check for cached Amazon results
      const resultsDir = path.join(__dirname, '../../pet-ingredient-scraper/results');
      const files = fs.readdirSync(resultsDir)
        .filter(f => f.startsWith('amazon-products-') && f.endsWith('.json'))
        .sort()
        .reverse();
      
      if (files.length > 0) {
        const latestFile = path.join(resultsDir, files[0]);
        const results = JSON.parse(fs.readFileSync(latestFile, 'utf-8'));
        return results[ingredientName] || [];
      }
    } catch (error) {
      // No Amazon results available
    }
    
    return [];
  }
  
  private calculateOverallConfidence(brandMatches: any[], amazonMatches: any[]): number {
    if (amazonMatches.length > 0) {
      return Math.max(...amazonMatches.map(m => m.score || 0));
    }
    
    if (brandMatches.length > 0) {
      return Math.max(...brandMatches.map(m => m.confidence || 0));
    }
    
    return 0;
  }
  
  private isGenericIngredient(name: string): boolean {
    const generics = [
      'water', 'salt', 'eggs', 'carrots', 'celery', 'spinach', 'kale',
      'blueberries', 'apples', 'sweet potato', 'pumpkin', 'broccoli',
      'cauliflower', 'green beans', 'peas', 'rice', 'oats', 'quinoa',
      'brown rice', 'white rice', 'bananas', 'strawberries', 'egg'
    ];
    
    const normalized = name.toLowerCase();
    return generics.some(generic => normalized.includes(generic));
  }
  
  private determineCategory(ingredient: string): 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet' {
    const normalized = ingredient.toLowerCase();
    
    if (normalized.includes('heart') || normalized.includes('liver') || normalized.includes('kidney')) {
      return 'Meat';
    }
    if (normalized.includes('oil')) {
      return 'Oil';
    }
    if (normalized.includes('powder') || normalized.includes('supplement') || normalized.includes('kelp')) {
      return 'Supplement';
    }
    if (normalized.includes('seed') || normalized.includes('grain') || normalized.includes('buckwheat') || normalized.includes('quinoa')) {
      return 'Carb';
    }
    
    return 'Meat';
  }
}
</file>

<file path="lib/state/villageStore.ts">
// lib/state/villageStore.ts
// Zustand store for village state management
// Provides reactive state for village level, purchase count, and mascot activities

import { create } from 'zustand';
import type { VillageLevel } from '../data/villageLevels';
import { VILLAGE_LEVELS, getVillageLevelData } from '../data/villageLevels';
import { getConfirmedCount } from '../utils/purchaseTracking';
import { logger } from '../utils/logger';

type VillageState = {
  userId: string | null;
  count: number;
  level: VillageLevel;
  isLoading: boolean;
  
  // Actions
  setUserId: (id: string) => void;
  refreshFromLocal: () => void;
  setCount: (n: number) => void;
  incrementCount: () => void;
  reset: () => void;
};

/**
 * Village store using Zustand
 * Provides reactive state management for village evolution
 */
export const useVillageStore = create<VillageState>((set, get) => ({
  userId: null,
  count: 0,
  level: VILLAGE_LEVELS[0],
  isLoading: false,

  /**
   * Set user ID and automatically refresh from localStorage
   */
  setUserId: (id: string) => {
    if (!id) {
      set({ userId: null, count: 0, level: VILLAGE_LEVELS[0] });
      return;
    }
    
    set({ userId: id, isLoading: true });
    get().refreshFromLocal();
  },

  /**
   * Refresh village state from localStorage
   * Called automatically when userId changes or after purchases
   */
  refreshFromLocal: () => {
    const { userId } = get();
    if (!userId) {
      set({ count: 0, level: VILLAGE_LEVELS[0], isLoading: false });
      return;
    }

    try {
      const count = getConfirmedCount(userId);
      const level = getVillageLevelData(count);
      set({ count, level, isLoading: false });
    } catch (error) {
      // Handle error gracefully
      logger.error('Failed to refresh village state', error as Error, { userId });
      set({ count: 0, level: VILLAGE_LEVELS[0], isLoading: false });
    }
  },

  /**
   * Set purchase count directly (for testing or manual updates)
   */
  setCount: (n: number) => {
    const count = Math.max(0, n);
    const level = getVillageLevelData(count);
    set({ count, level });
  },

  /**
   * Increment purchase count by 1
   * Useful for testing or manual increments
   */
  incrementCount: () => {
    const { count } = get();
    get().setCount(count + 1);
  },

  /**
   * Reset village state to initial values
   */
  reset: () => {
    set({
      userId: null,
      count: 0,
      level: VILLAGE_LEVELS[0],
      isLoading: false
    });
  }
}));

/**
 * Hook to get current village level
 * Convenience hook for components that only need the level
 */
export function useVillageLevel(): VillageLevel {
  return useVillageStore(state => state.level);
}

/**
 * Hook to get purchase count
 * Convenience hook for components that only need the count
 */
export function usePurchaseCount(): number {
  return useVillageStore(state => state.count);
}

/**
 * Hook to get village progress info
 * Returns count, level, and progress to next level
 */
export function useVillageProgress() {
  const count = useVillageStore(state => state.count);
  const level = useVillageStore(state => state.level);
  const progress = count % 10;
  const nextLevelThreshold = (level.id + 1) * 10;
  const ingredientsRemaining = nextLevelThreshold - count;
  
  return {
    count,
    level,
    progress,
    nextLevelThreshold,
    ingredientsRemaining,
    progressPercent: (progress / 10) * 100
  };
}
</file>

<file path="lib/types.ts">
// lib/types.ts
// Core TypeScript type definitions for PetPlates

export type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
export type AgeGroupValue = 'baby' | 'young' | 'adult' | 'senior';

export interface Breed {
  id: string;
  name: string;
  category: PetCategory;
}

export interface AgeGroup {
  value: AgeGroupValue;
  label: string;
}

export interface HealthConcern {
  id: string;
  name: string;
  description: string;
  dietaryAdjustments: string[];
}

export type Species = 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet' | string;

export interface Ingredient {
  id: string;
  name: string;
  amount: string;
  asinLink?: string; // ASIN-based direct product link
  amazonLink?: string; // Legacy Amazon affiliate link
  productName?: string; // Vetted product name
  vetNote?: string; // Veterinary note about the product
  isVetted?: boolean; // Whether this ingredient has been vetted
  isGeneric?: boolean; // Whether this is a generic ingredient (produce/staples)
  asin?: string; // Amazon ASIN for cart operations
}

export interface RecipeNutritionInfo {
  protein?: { min: number; max: number; unit: string };
  fat?: { min: number; max: number; unit: string };
  fiber?: { min: number; max: number; unit: string };
  calories?: { min: number; max: number; unit: string };
  phosphorus?: { min: number; max: number; unit: string };
  calcium?: { min: number; max: number; unit: string };
}

export interface Recipe {
  id: string;
  name: string;
  shortName?: string;
  category: string;
  breed?: string | string[] | null;
  ageGroup: string[];
  healthConcerns: string[];
  notSuitableFor?: string[]; // Health concerns this recipe is NOT suitable for
  description?: string;
  tags?: string[];
  imageUrl?: string;
  prepTime?: string;
  cookTime?: string;
  servings?: number;
  ingredients: Ingredient[];
  instructions: string[];
  supplements?: Ingredient[]; // Optional supplements for the recipe
  nutritionalInfo?: RecipeNutritionInfo;
  nutritionInfo?: {
    protein?: string;
    fat?: string;
    fiber?: string;
    calories?: string;
    calcium?: string;
  };
  rating?: number;
  reviews?: number;
  score?: number;
  celebrityName?: string; // For celebrity pet recipes
  celebrityQuote?: string; // Quote from celebrity about the recipe
  // Enhanced fields (all optional for backward compatibility)
  needsReview?: boolean; // Flag if recipe uses estimated nutrition data or needs manual review
  validation?: {
    status: 'validated' | 'needs_review' | 'invalid';
    validatedAt?: string;
    method?: 'dry_matter' | 'as_fed' | 'estimated';
    standards?: string[];
    warnings?: string[];
    errors?: string[];
    missingIngredients?: string[];
    estimatedNutritionPercent?: number;
  };
  generationInfo?: {
    version: string;
    attempts?: number;
    confidence?: number;
  };
}

export interface Pet {
  id: string;
  name?: string;
  names?: string[];
  type: string | PetCategory;
  bannedIngredients?: string[]; // Ingredients user never wants to see for this pet
  breed?: string | null;
  age?: string;
  weight?: string;
  weightKg?: number;
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very-active';
  mealPlan?: string[];
  savedRecipes?: string[];
  // Wellness and preference fields
  healthConcerns?: string[];
  dietaryRestrictions?: string[];
  allergies?: string[];
  allergiesSeverity?: Record<string, 'low' | 'medium' | 'high'>;
  dislikes?: string[];
  notes?: string;
  createdAt?: string;
  updatedAt?: string;
  customMeals?: CustomMeal[];
  userId?: string;
  image?: string;
  completedMealPlans?: number; // Number of completed meal plans for Planning Volume badge
}

export interface ModifiedRecipeResult {
  recipe: Recipe;
  adjustedIngredients?: Ingredient[];
  appliedRules?: AppliedModifierSummary[];
  modifications?: string[];
  nutritionalChanges?: Record<string, { before: number; after: number }> | Record<string, any>;
  portionPlan?: PortionPlan;
  portionSize?: { grams: number; calories: number };
  shoppingList?: ShoppingListItem[] | Array<{ name: string; amount: string; asinLink?: string }>;
  explanation: string;
  weeklyPlan?: WeeklyPlanEntry[];
  score?: number;
  _tierLabel?: string;
  _warning?: string;
  _healthMatch?: string;
}

// Custom meal created by user
export interface CustomMeal {
  id: string;
  petId: string;
  userId: string;
  name: string;
  createdAt: string;
  updatedAt: string;
  ingredients: Array<{
    key: string;
    grams: number;
  }>;
  analysis: {
    score: number;
    nutrients: Record<string, number>;
    totalRecipeGrams: number;
    recommendedServingGrams: number;
    breakdown: {
      nutrientCoverageScore: number;
      toxicityPenalty: number;
      balanceVarietyScore: number;
    };
    toxicityWarnings: Array<{
      message: string;
      severity: 'low' | 'medium' | 'high' | 'critical';
      ingredientKey?: string;
      ingredientName?: string;
    }>;
    allergyWarnings: Array<{
      message: string;
      severity: 'low' | 'medium' | 'high' | 'critical';
    }>;
    nutrientWarnings: Array<{
      message: string;
      severity: 'low' | 'medium' | 'high' | 'critical';
    }>;
    suggestions: Array<{
      message: string;
      action?: string;
      confidence?: 'low' | 'medium' | 'high';
    }>;
  };
}

// Pet nutrition profile for recommendation engine
export interface PetNutritionProfile {
  species: string;
  ageGroup: string;
  weightKg: number;
  breed?: string | null;
  healthConcerns?: string[];
  allergies?: string[];
  caloriesPerKgOverride?: number;
  petName?: string;
}

// Portion plan for meal recommendations
export interface PortionPlan {
  dailyGrams: number;
  multiplier: number;
  mealsPerDay: number;
  notes: string[];
  caloriesPerKg?: number;
  dailyCalories?: number;
  weeklyCalories?: number;
  dailyPortionGrams?: number;
  weeklyPortionGrams?: number;
}

// Shopping list item
export interface ShoppingListItem {
  name: string;
  amount: string;
  asinLink?: string; // ASIN-based direct product link
  notes?: string;
  category?: string;
}

// Weekly plan entry
export interface WeeklyPlanEntry {
  day: string;
  meal: string;
  recipeId: string;
}

// Applied modifier summary
export interface AppliedModifierSummary {
  ruleId: string;
  description: string;
  changes: string[];
}

// Image data for recipe images
export interface ImageData {
  url?: string;
  width?: number;
  height?: number;
  alt?: string;
  hero?: string;
  card?: {
    url: string;
    width: number;
    height: number;
    alt: string;
  };
}

// Nutritional requirement for pets
export interface NutritionalRequirement {
  protein: { min: number; max: number; unit: string };
  fat: { min: number; max: number; unit: string };
  fiber?: { min: number; max: number; unit: string };
  calcium?: { min: number; max: number; unit: string };
  phosphorus?: { min: number; max: number; unit: string };
  taurine?: { min: number; max: number; unit: string };
  calories?: { min: number; max: number; unit: string };
  vitamins?: string[];
}

// Modifier rule system
export interface IngredientOption {
  name: string;
  reason?: string;
  amount?: string;
  amountPer10kg?: string;
  amazonLink?: string;
  notes?: string;
}

export interface ModifierRule {
  id: string;
  name?: string;
  species?: Species[];
  healthConcerns?: string[];
  description?: string;
  rationale?: string;
  ruleWeight?: number;
  appliesTo?: {
    species?: Species[];
    healthConcerns?: string[];
    ageGroups?: string[];
  };
  ingredientChanges?: {
    add?: IngredientOption[];
    remove?: string[];
    substitute?: Record<string, string> | Array<{ from: string; to: string }>;
  };
  nutritionalAdjustments?: {
    protein?: { min?: number; max?: number };
    fat?: { min?: number; max?: number };
    phosphorus?: { min?: number; max?: number };
    calories?: { min?: number; max?: number };
  };
  nutritionalTargets?: Record<string, { min?: number; max?: number } | number>;
  portionAdjustments?: {
    multiplier?: number;
    notes?: string[];
  };
}
</file>

<file path="lib/types/aliasGroups.ts">
// Ingredient alias groups - handles one ASIN serving multiple ingredient concepts
// Separates retail identity (one product) from ingredient semantics (multiple names)

export interface IngredientAliasGroup {
  groupId: string;                    // e.g., "green_peas_fresh"
  canonicalName: string;              // Primary ingredient name
  aliases: string[];                  // All ingredient names sharing this ASIN
  sharedASIN: string;                 // The Amazon ASIN they all use
  
  // Validation happens once per group, not per ingredient
  validationStatus: 'valid' | 'structurally-valid' | 'ambiguous' | 'invalid';
  confidence: 'high' | 'medium' | 'low';
  lastVerified: Date;
  
  // Why these are grouped together
  groupingReason: 'same-base-ingredient' | 'known-synonyms' | 'manual-override';
  
  // Optional: differences between aliases handled in recipe logic
  preparationVariants?: Map<string, string>; // e.g., "peas (mashed)" -> "mashed"
  
  // Audit trail
  notes?: string;
}

export interface AliasGroupValidationResult {
  group: IngredientAliasGroup;
  validationResult: any; // Will use ValidationResult from retailValidation.ts
  appliesTo: string[];   // Which ingredients inherit this result
}

// Known synonym patterns for alias detection
export const KNOWN_SYNONYM_PAIRS: Array<[string, string]> = [
  // Rice variants
  ['brown rice', 'rice (hulled)'],
  
  // Fish - same product, different descriptions
  ['sardines (canned in water)', 'sardines (in water)'],
  
  // Supplements - naming variations
  ['b-complex', 'vitamin b complex'],
  ['hairball paste', 'hairball control paste'],
  
  // Broths - same product line
  ['chicken broth', 'bone broth (low sodium)'],
  ['fish broth (no salt)', 'turkey broth (no salt)'],
  
  // Oils - same oil, different names
  ['salmon oil', 'omega-3 oil'],
  ['fish oil', 'herring oil'],
  
  // Calcium sources
  ['calcium carbonate', 'eggshells (crushed)'],
  
  // Lettuce variants
  ['lettuce (romaine)', 'romaine lettuce'],
  
  // Watercress
  ['watercress', 'watercress (small amounts)'],
  
  // Peas - preparation variants
  ['peas', 'peas (mashed)'],
  ['peas', 'peas (cooked)'],
  ['green beans', 'green beans (cooked)'],
  
  // Prebiotic supplements - same family
  ['chicory root', 'inulin (prebiotic)'],
  ['chicory root', 'fructooligosaccharides (fos)'],
  ['inulin (prebiotic)', 'fructooligosaccharides (fos)'],
  
  // Joint supplements - same product line
  ['joint supplement', 'joint health supplement'],
  ['glucosamine sulfate', 'chondroitin sulfate'],
  ['joint supplement', 'glucosamine sulfate'],
  ['joint supplement', 'chondroitin sulfate'],
  
  // Bok choy variants
  ['bok choi', 'bok choy (small amounts)'],
  
  // Dubia roaches
  ['dubia roaches', 'small dubia roaches'],
  
  // Hay variants
  ['timothy hay', 'bluegrass hay'],
];

// Known conflict patterns - these should NOT be grouped
export const KNOWN_CONFLICT_PATTERNS: Array<[string, string]> = [
  // Different meats
  ['venison', 'beef'],
  ['rabbit', 'lamb'],
  ['turkey', 'chicken'],
  ['duck', 'chicken'],
  
  // Different fish
  ['herring', 'sardines'],
  
  // Completely different products
  ['mango', 'chia'],
  ['egg', 'duck'],
];
</file>

<file path="lib/types/badges.ts">
// lib/types/badges.ts
// Badge type definitions for pet achievement system

/**
 * Badge types - one-time and progressive badges
 */
export enum BadgeType {
  // Category 1: The Quality Match (Single Tier)
  NUTRIENT_NAVIGATOR = 'nutrient_navigator',
  
  // Category 2: Plan Variety & Engagement (Single Tier)
  MASTER_MEAL_PLANNER = 'master_meal_planner',
  
  // Category 3: Planning Volume (Tiered)
  PLANNING_VOLUME = 'planning_volume',
  
  // Category 4: Purchase Commitment (Tiered)
  PURCHASE_COMMITMENT = 'purchase_commitment',
}

/**
 * Badge tiers for progressive badges
 */
export type BadgeTier = 
  | 'bronze'
  | 'silver'
  | 'gold'
  | 'platinum'
  | 'diamond'
  | 'sultan'; // For Subscription Sultan

/**
 * Individual badge data
 */
export interface PetBadge {
  type: BadgeType;
  tier?: BadgeTier; // For progressive badges only
  unlockedAt: string; // ISO timestamp
  progress?: number; // Current progress count for progressive badges
  nextTierThreshold?: number; // Next tier threshold for progress display
}

/**
 * All badges for a pet
 */
export interface PetBadges {
  badges: PetBadge[];
  lastChecked?: string; // ISO timestamp of last badge check
}

/**
 * Badge unlock context for checking eligibility
 */
export interface BadgeCheckContext {
  action: 'meal_created' | 'recipe_viewed' | 'meal_plan_created' | 'recipe_saved' | 'recipe_removed' | 'meal_plan_completed' | 'purchase_confirmed';
  compatibilityScore?: number; // For Nutrient Navigator
  mealPlanCount?: number; // Unique meals in plan
  savedRecipesCount?: number; // Number of saved recipes
  weeklyPlanCompleted?: boolean; // Whether weekly plan is completed
  completionCount?: number; // Number of completed meal plans
  purchaseCount?: number; // Number of purchases
}
</file>

<file path="lib/types/index.ts">
// lib/types/index.ts
// Centralized type definitions - Single source of truth

export type PetCategory = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
export type AgeGroup = 'baby' | 'young' | 'adult' | 'senior';
export type ActivityLevel = 'sedentary' | 'moderate' | 'active' | 'very-active';

/**
 * Core Pet interface
 */
export interface Pet {
  id: string;
  names: string[];
  type: PetCategory;
  breed: string;
  age: AgeGroup;
  weight?: string;
  weightKg?: number;
  activityLevel?: ActivityLevel;
  healthConcerns?: string[];
  dietaryRestrictions?: string[];
  allergies?: string[];
  dislikes?: string[];
  savedRecipes?: string[];
  image?: string;
}

/**
 * Ingredient in a recipe or custom meal
 */
export interface Ingredient {
  id?: string;
  key: string;
  name: string;
  amount?: string;
  grams?: number;
  asinLink?: string;
  purchaseLink?: string;
}

/**
 * Ingredient selection for custom meals
 */
export interface IngredientSelection {
  key: string;
  grams: number;
}

/**
 * Meal analysis result
 */
export interface MealAnalysis {
  score: number;
  nutrients: Record<string, number>;
  totalRecipeGrams: number;
  recommendedServingGrams: number;
  caToPratio?: number;
  breakdown: {
    nutrientCoverageScore: number;
    toxicityPenalty: number;
    balanceVarietyScore: number;
  };
  toxicityWarnings: Array<{
    message: string;
    severity: string;
    ingredientKey?: string;
    ingredientName?: string;
  }>;
  allergyWarnings: Array<{
    message: string;
    severity: string;
  } | string>;
  nutrientWarnings: Array<{
    message: string;
    severity: string;
  }>;
  suggestions: Array<{
    message: string;
    action?: string;
    confidence?: string;
  } | string>;
}

/**
 * Custom meal created by user
 */
export interface CustomMeal {
  id: string;
  petId: string;
  userId: string;
  name: string;
  createdAt: string;
  updatedAt: string;
  ingredients: IngredientSelection[];
  analysis: MealAnalysis;
}

/**
 * Recipe from the database
 */
export interface Recipe {
  id: string;
  name: string;
  shortName?: string;
  category: string;
  ageGroup: string[];
  healthConcerns?: string[];
  description: string;
  ingredients: Ingredient[];
  instructions: string[];
  nutritionalInfo: {
    protein: { min: number; max: number; unit: string };
    fat: { min: number; max: number; unit: string };
    calories: { min: number; max: number; unit: string };
  };
  rating: number;
  reviews: number;
  tags?: string[];
  image?: string;
  mealImage?: string;
}

/**
 * Modified recipe result from recommendation engine
 */
export interface ModifiedRecipeResult {
  recipe: Recipe;
  explanation: string;
  score?: number;
  adjustedIngredients?: Ingredient[];
}

/**
 * Breed information
 */
export interface Breed {
  id: string;
  name: string;
  category: PetCategory;
  traits?: string[];
  commonHealthConcerns?: string[];
}

/**
 * Nutritional requirement
 */
export interface NutritionalRequirement {
  nutrient: string;
  min?: number;
  max?: number;
  unit: string;
  critical?: boolean;
}

/**
 * API Error response
 */
export interface ApiError {
  code: string;
  message: string;
  statusCode: number;
  fields?: Record<string, string>;
}

/**
 * Loading state
 */
export interface LoadingState {
  loading: boolean;
  error: string | null;
}
</file>

<file path="lib/types/retailValidation.ts">
// Retail validation types for ingredient sourcing
// Separates biological truth (ingredient specs) from retail convenience (ASINs)

export interface IngredientRetailSpec {
  // Core identity validation
  requiredTokens: string[];           // Must appear in product title (e.g., ['chicken', 'breast'])
  forbiddenTokens: string[];          // Cannot appear in title (e.g., ['seasoned', 'cooked', 'breaded'])
  
  // Acceptable product forms
  acceptableForms?: string[];         // e.g., ['raw', 'frozen', 'fresh', 'canned in water']
  
  // Size constraints (optional)
  minPackageSize?: {
    amount: number;
    unit: 'g' | 'kg' | 'oz' | 'lb' | 'ml' | 'l' | 'count';
  };
  
  // Validation behavior
  validationRules: {
    titleMatch: 'strict' | 'flexible';  // strict = all tokens required, flexible = most tokens
    allowGenericBrand: boolean;         // true = store brands OK, false = name brands only
    caseSensitive: boolean;             // usually false
  };
}

export interface ProductMetadata {
  asin: string;
  title: string;
  brand?: string;
  packageSize?: {
    amount: number;
    unit: string;
    raw: string;  // Original text from title
  };
  price?: {
    amount: number;
    currency: string;
  };
  availability: 'in-stock' | 'out-of-stock' | 'unknown';
  lastFetched: Date;
}

export interface ValidationResult {
  status: 'valid' | 'structurally-valid' | 'ambiguous' | 'invalid' | 'error';
  confidence: 'high' | 'medium' | 'low';
  
  // Separate structural (safety) from semantic (naming) issues
  structuralIssues: ValidationIssue[];  // Forbidden tokens, safety violations
  semanticIssues: ValidationIssue[];    // Missing preferred tokens, naming mismatches
  
  // Explain the decision
  reasoning: {
    requiredTokensMatched: string[];
    equivalentTokensUsed: Array<{ token: string; synonym: string }>;
    forbiddenTokensFound: string[];
    structurallySound: boolean;
  };
  
  metadata?: ProductMetadata;
}

export interface ValidationIssue {
  type: 'missing-required' | 'has-forbidden' | 'size-mismatch' | 'form-mismatch' | 'dead-link' | 'ambiguous-title';
  severity: 'critical' | 'warning' | 'info';
  message: string;
  details?: any;
}

export interface VettedProductEnhanced {
  // Existing fields
  productName: string;
  asinLink: string;
  
  // New validation fields
  retailSpec?: IngredientRetailSpec;
  validationStatus?: 'validated' | 'pending' | 'flagged' | 'failed';
  confidence?: 'high' | 'medium' | 'low';
  lastVerified?: Date;
  validationNotes?: string;
}
</file>

<file path="lib/utils/__tests__/affiliateLinks.test.ts">
// lib/utils/__tests__/affiliateLinks.test.ts
import { describe, it, expect } from 'vitest';
import {
  ensureSellerId,
  ensureCartUrlSellerId,
  hasSellerId,
  extractASIN,
  isValidAmazonUrl,
  isCartUrl,
  addSellerIdIfMissing,
} from '../affiliateLinks';

describe('affiliateLinks utilities', () => {
  describe('ensureSellerId', () => {
    it('should add seller ID to URL without existing tag', () => {
      const url = 'https://www.amazon.com/dp/B01234567';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
      expect(result).toBe('https://www.amazon.com/dp/B01234567?tag=robinfrench-20');
    });

    it('should replace existing tag parameter with our seller ID', () => {
      const url = 'https://www.amazon.com/dp/B01234567?tag=someone-else-20';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
      expect(result).not.toContain('someone-else-20');
    });

    it('should replace AssociateTag with tag parameter', () => {
      const url = 'https://www.amazon.com/dp/B01234567?AssociateTag=other-20';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
      expect(result).not.toContain('AssociateTag');
    });

    it('should handle URL with existing query parameters', () => {
      const url = 'https://www.amazon.com/dp/B01234567?ref=sr_1_1';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
      expect(result).toContain('ref=sr_1_1');
    });

    it('should handle /gp/product/ URL format', () => {
      const url = 'https://www.amazon.com/gp/product/B01234567';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
    });

    it('should return empty string for null/undefined input', () => {
      expect(ensureSellerId(null)).toBe('');
      expect(ensureSellerId(undefined)).toBe('');
      expect(ensureSellerId('')).toBe('');
    });

    it('should handle malformed URLs gracefully', () => {
      const url = 'not-a-url';
      const result = ensureSellerId(url);
      expect(result).toContain('tag=robinfrench-20');
    });

    it('should handle URLs without protocol', () => {
      const url = 'www.amazon.com/dp/B01234567';
      const result = ensureSellerId(url);
      // Should still attempt to add tag (may fail gracefully)
      expect(result).toBeTruthy();
    });
  });

  describe('ensureCartUrlSellerId', () => {
    it('should add AssociateTag to cart URL without existing tag', () => {
      const cartUrl = 'https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&Quantity.1=1';
      const result = ensureCartUrlSellerId(cartUrl);
      expect(result).toContain('AssociateTag=robinfrench-20');
      expect(result).toContain('ASIN.1=B01234567');
    });

    it('should replace existing AssociateTag with our seller ID', () => {
      const cartUrl = 'https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&AssociateTag=other-20';
      const result = ensureCartUrlSellerId(cartUrl);
      expect(result).toContain('AssociateTag=robinfrench-20');
      expect(result).not.toContain('other-20');
    });

    it('should replace tag parameter with AssociateTag in cart URLs', () => {
      const cartUrl = 'https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&tag=other-20';
      const result = ensureCartUrlSellerId(cartUrl);
      expect(result).toContain('AssociateTag=robinfrench-20');
      expect(result).not.toContain('tag=');
    });

    it('should handle multiple ASINs in cart URL', () => {
      const cartUrl = 'https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&Quantity.1=1&ASIN.2=B09876543&Quantity.2=1';
      const result = ensureCartUrlSellerId(cartUrl);
      expect(result).toContain('AssociateTag=robinfrench-20');
      expect(result).toContain('ASIN.1=B01234567');
      expect(result).toContain('ASIN.2=B09876543');
    });

    it('should return empty string for null/undefined input', () => {
      expect(ensureCartUrlSellerId(null)).toBe('');
      expect(ensureCartUrlSellerId(undefined)).toBe('');
      expect(ensureCartUrlSellerId('')).toBe('');
    });
  });

  describe('hasSellerId', () => {
    it('should return true for URL with tag parameter', () => {
      expect(hasSellerId('https://www.amazon.com/dp/B01234567?tag=robinfrench-20')).toBe(true);
    });

    it('should return true for URL with AssociateTag parameter', () => {
      expect(hasSellerId('https://www.amazon.com/gp/aws/cart/add.html?AssociateTag=robinfrench-20')).toBe(true);
    });

    it('should return false for URL without seller ID', () => {
      expect(hasSellerId('https://www.amazon.com/dp/B01234567')).toBe(false);
    });

    it('should return false for URL with different tag', () => {
      expect(hasSellerId('https://www.amazon.com/dp/B01234567?tag=other-20')).toBe(false);
    });

    it('should return false for null/undefined/empty input', () => {
      expect(hasSellerId(null)).toBe(false);
      expect(hasSellerId(undefined)).toBe(false);
      expect(hasSellerId('')).toBe(false);
    });
  });

  describe('extractASIN', () => {
    it('should extract ASIN from /dp/ URL format', () => {
      expect(extractASIN('https://www.amazon.com/dp/B012345678')).toBe('B012345678');
      expect(extractASIN('https://www.amazon.com/dp/B012345678?tag=robinfrench-20')).toBe('B012345678');
    });

    it('should extract ASIN from /gp/product/ URL format', () => {
      expect(extractASIN('https://www.amazon.com/gp/product/B012345678')).toBe('B012345678');
    });

    it('should extract ASIN from /product/ URL format', () => {
      expect(extractASIN('https://www.amazon.com/product/B012345678')).toBe('B012345678');
    });

    it('should extract ASIN from ASIN parameter', () => {
      expect(extractASIN('https://www.amazon.com/gp/aws/cart/add.html?ASIN=B012345678')).toBe('B012345678');
    });

    it('should return null for URL without ASIN', () => {
      expect(extractASIN('https://www.amazon.com/s?k=chicken')).toBe(null);
      expect(extractASIN('https://www.amazon.com')).toBe(null);
    });

    it('should return null for invalid ASIN format', () => {
      expect(extractASIN('https://www.amazon.com/dp/B123')).toBe(null);
      expect(extractASIN('https://www.amazon.com/dp/B01234567890')).toBe(null);
      // 9 characters should not match (ASINs are exactly 10)
      expect(extractASIN('https://www.amazon.com/dp/B01234567')).toBe(null);
    });

    it('should return null for null/undefined/empty input', () => {
      expect(extractASIN(null)).toBe(null);
      expect(extractASIN(undefined)).toBe(null);
      expect(extractASIN('')).toBe(null);
    });
  });

  describe('isValidAmazonUrl', () => {
    it('should return true for amazon.com URLs', () => {
      expect(isValidAmazonUrl('https://www.amazon.com/dp/B01234567')).toBe(true);
      expect(isValidAmazonUrl('http://amazon.com/product')).toBe(true);
    });

    it('should return true for amzn. URLs', () => {
      expect(isValidAmazonUrl('https://amzn.to/abc123')).toBe(true);
    });

    it('should return false for non-Amazon URLs', () => {
      expect(isValidAmazonUrl('https://www.google.com')).toBe(false);
      expect(isValidAmazonUrl('https://www.chewy.com')).toBe(false);
    });

    it('should return false for invalid URLs', () => {
      expect(isValidAmazonUrl('not-a-url')).toBe(false);
      expect(isValidAmazonUrl('')).toBe(false);
    });

    it('should return false for null/undefined input', () => {
      expect(isValidAmazonUrl(null)).toBe(false);
      expect(isValidAmazonUrl(undefined)).toBe(false);
    });
  });

  describe('isCartUrl', () => {
    it('should return true for /gp/aws/cart/add.html URLs', () => {
      expect(isCartUrl('https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567')).toBe(true);
    });

    it('should return true for /gp/cart/view.html URLs', () => {
      expect(isCartUrl('https://www.amazon.com/gp/cart/view.html')).toBe(true);
    });

    it('should return false for product URLs', () => {
      expect(isCartUrl('https://www.amazon.com/dp/B01234567')).toBe(false);
    });

    it('should return false for null/undefined/empty input', () => {
      expect(isCartUrl(null)).toBe(false);
      expect(isCartUrl(undefined)).toBe(false);
      expect(isCartUrl('')).toBe(false);
    });
  });

  describe('addSellerIdIfMissing', () => {
    it('should add seller ID if missing', () => {
      const url = 'https://www.amazon.com/dp/B01234567';
      const result = addSellerIdIfMissing(url);
      expect(result).toContain('tag=robinfrench-20');
    });

    it('should not add seller ID if already present', () => {
      const url = 'https://www.amazon.com/dp/B01234567?tag=robinfrench-20';
      const result = addSellerIdIfMissing(url);
      // Should still ensure it's our seller ID (may normalize)
      expect(result).toContain('robinfrench-20');
    });

    it('should replace other seller IDs with ours', () => {
      const url = 'https://www.amazon.com/dp/B01234567?tag=other-20';
      const result = addSellerIdIfMissing(url);
      expect(result).toContain('tag=robinfrench-20');
      expect(result).not.toContain('other-20');
    });

    it('should handle AssociateTag parameter', () => {
      const url = 'https://www.amazon.com/dp/B01234567?AssociateTag=other-20';
      const result = addSellerIdIfMissing(url);
      expect(result).toContain('robinfrench-20');
    });
  });
});
</file>

<file path="lib/utils/__tests__/getAmazonBuyLink.test.ts">
// Tests for Amazon buy link finalization

import { getAmazonBuyLink, getAmazonBuyLinkWithStatus, getFallbackAmazonSearchLink } from '../getAmazonBuyLink';

describe('getAmazonBuyLink', () => {
  test('adds affiliate tag to valid Amazon URL', () => {
    const link = getAmazonBuyLink('https://www.amazon.com/dp/B012345678');
    expect(link).toContain('tag=robinfrench-20');
    expect(link).toContain('B012345678');
  });

  test('preserves existing affiliate tag', () => {
    const link = getAmazonBuyLink('https://www.amazon.com/dp/B012345678?tag=robinfrench-20');
    expect(link).toContain('tag=robinfrench-20');
  });

  test('rejects non-Amazon URLs', () => {
    const link = getAmazonBuyLink('https://example.com/product/123');
    expect(link).toBeNull();
  });

  test('rejects empty/null URLs', () => {
    expect(getAmazonBuyLink('')).toBeNull();
    expect(getAmazonBuyLink(null)).toBeNull();
    expect(getAmazonBuyLink(undefined)).toBeNull();
  });

  test('rejects Amazon search URLs (no ASIN)', () => {
    const link = getAmazonBuyLink('https://www.amazon.com/s?k=chicken+breast');
    expect(link).toBeNull();
  });

  test('handles /gp/product/ format', () => {
    const link = getAmazonBuyLink('https://www.amazon.com/gp/product/B012345678');
    expect(link).toContain('tag=robinfrench-20');
    expect(link).toContain('B012345678');
  });

  test('handles URLs with existing query parameters', () => {
    const link = getAmazonBuyLink('https://www.amazon.com/dp/B012345678?ref=xyz');
    expect(link).toContain('tag=robinfrench-20');
    expect(link).toContain('B012345678');
  });
});

describe('getAmazonBuyLinkWithStatus', () => {
  test('returns ok status for valid link', () => {
    const result = getAmazonBuyLinkWithStatus('https://www.amazon.com/dp/B012345678');
    expect(result.status).toBe('ok');
    expect(result.url).toContain('tag=robinfrench-20');
    expect(result.asin).toBe('B012345678');
  });

  test('returns missing status for null URL', () => {
    const result = getAmazonBuyLinkWithStatus(null);
    expect(result.status).toBe('missing');
    expect(result.url).toBeNull();
  });

  test('returns invalid status for non-Amazon URL', () => {
    const result = getAmazonBuyLinkWithStatus('https://example.com/product/123');
    expect(result.status).toBe('invalid');
    expect(result.url).toBeNull();
  });

  test('returns invalid status for search URL', () => {
    const result = getAmazonBuyLinkWithStatus('https://www.amazon.com/s?k=chicken');
    expect(result.status).toBe('invalid');
    expect(result.url).toBeNull();
  });

  test('returns region-unavailable for non-US regions', () => {
    const result = getAmazonBuyLinkWithStatus('https://www.amazon.com/dp/B012345678', 'UK');
    expect(result.status).toBe('region-unavailable');
    expect(result.asin).toBe('B012345678');
  });
});

describe('getFallbackAmazonSearchLink', () => {
  test('creates search link with affiliate tag', () => {
    const link = getFallbackAmazonSearchLink('chicken breast organic');
    expect(link).toContain('amazon.com/s');
    expect(link).toContain('k=chicken%20breast%20organic');
    expect(link).toContain('tag=robinfrench-20');
  });

  test('handles UK region', () => {
    const link = getFallbackAmazonSearchLink('chicken breast', 'UK');
    expect(link).toContain('amazon.co.uk/s');
    expect(link).toContain('tag=robinfrench-20');
  });

  test('URL encodes special characters', () => {
    const link = getFallbackAmazonSearchLink('Bob\'s Red Mill Oats');
    expect(link).toContain('Bob%27s');
  });
});
</file>

<file path="lib/utils/abTesting.ts">
// A/B Testing Utilities for Button Copy Optimization
// Tracks which button text drives more affiliate clicks

export type ButtonVariant = 'shop-now' | 'buy-amazon' | 'get-ingredients';

export interface ButtonCopyVariant {
  id: ButtonVariant;
  text: string;
  icon?: string;
}

export const BUTTON_VARIANTS: ButtonCopyVariant[] = [
  { id: 'shop-now', text: 'Buy', icon: 'üõí' },
  { id: 'buy-amazon', text: 'Buy', icon: 'üì¶' },
  { id: 'get-ingredients', text: 'Buy', icon: '‚ú®' }
];

export const BUY_ALL_VARIANTS: ButtonCopyVariant[] = [
  { id: 'shop-now', text: 'Buy All', icon: 'üõí' },
  { id: 'buy-amazon', text: 'Buy All', icon: 'üì¶' },
  { id: 'get-ingredients', text: 'Buy All', icon: '‚ú®' }
];

// Assign user to a variant (sticky - stays same across session)
export function getAssignedVariant(): ButtonVariant {
  if (typeof window === 'undefined') return 'shop-now';
  
  // Check if user already has assigned variant
  const stored = localStorage.getItem('ab_button_variant');
  if (stored && ['shop-now', 'buy-amazon', 'get-ingredients'].includes(stored)) {
    return stored as ButtonVariant;
  }
  
  // Randomly assign new user to a variant (33/33/33 split)
  const variants: ButtonVariant[] = ['shop-now', 'buy-amazon', 'get-ingredients'];
  const random = Math.floor(Math.random() * 3);
  const assigned = variants[random];
  
  localStorage.setItem('ab_button_variant', assigned);
  return assigned;
}

// Get button text for assigned variant
export function getButtonCopy(isBuyAll: boolean = false): ButtonCopyVariant {
  const variant = getAssignedVariant();
  const variants = isBuyAll ? BUY_ALL_VARIANTS : BUTTON_VARIANTS;
  return variants.find(v => v.id === variant) || variants[0];
}

// Track button click (for conversion analysis)
export function trackButtonClick(
  variant: ButtonVariant,
  context: 'individual' | 'buy-all' | 'preview',
  ingredientName?: string
) {
  if (typeof window === 'undefined') return;
  
  const clicks = JSON.parse(localStorage.getItem('ab_button_clicks') || '[]');
  
  clicks.push({
    variant,
    context,
    ingredientName,
    timestamp: new Date().toISOString()
  });
  
  // Keep only last 1000 clicks
  if (clicks.length > 1000) {
    clicks.splice(0, clicks.length - 1000);
  }
  
  localStorage.setItem('ab_button_clicks', JSON.stringify(clicks));
}

// Get conversion stats for analysis
export function getConversionStats() {
  if (typeof window === 'undefined') return null;
  
  const clicks = JSON.parse(localStorage.getItem('ab_button_clicks') || '[]');
  
  const stats: Record<ButtonVariant, { total: number; byContext: Record<string, number> }> = {
    'shop-now': { total: 0, byContext: {} },
    'buy-amazon': { total: 0, byContext: {} },
    'get-ingredients': { total: 0, byContext: {} }
  };
  
  clicks.forEach((click: any) => {
    const variant = click.variant as ButtonVariant;
    if (stats[variant]) {
      stats[variant].total++;
      stats[variant].byContext[click.context] = (stats[variant].byContext[click.context] || 0) + 1;
    }
  });
  
  return stats;
}

// Console command to see results
export function logABTestResults() {
  const stats = getConversionStats();
  if (!stats) {
    console.log('No A/B test data available');
    return;
  }
  
  console.log('üß™ A/B Test Results - Button Copy Optimization\n');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
  
  Object.entries(stats).forEach(([variant, data]) => {
    console.log(`${variant.toUpperCase()}:`);
    console.log(`  Total clicks: ${data.total}`);
    console.log(`  By context:`, data.byContext);
    console.log('');
  });
  
  // Calculate winner
  const sorted = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);
  const winner = sorted[0];
  
  console.log(`üèÜ WINNER: "${winner[0]}" with ${winner[1].total} clicks`);
  console.log('\nTo reset test: localStorage.removeItem("ab_button_clicks")');
  console.log('To change your variant: localStorage.removeItem("ab_button_variant")');
}

// Make available globally for easy console access
if (typeof window !== 'undefined') {
  (window as any).logABTestResults = logABTestResults;
  (window as any).getConversionStats = getConversionStats;
}
</file>

<file path="lib/utils/affiliateLinks.ts">
// lib/utils/affiliateLinks.ts
// Utility functions to ensure all affiliate links have seller ID

const SELLER_ID = 'robinfrench-20';

/**
 * Ensures an Amazon product link has the seller ID affiliate tag.
 * If the link already has a tag, it replaces it with ours.
 * If the link doesn't have a tag, it adds ours.
 * 
 * @param url The Amazon product URL to ensure has seller ID (format: /dp/ASIN or /gp/product/ASIN)
 * @returns The URL with seller ID guaranteed
 * 
 * @example
 * ensureSellerId('https://www.amazon.com/dp/B01234567') 
 * // Returns: 'https://www.amazon.com/dp/B01234567?tag=robinfrench-20'
 */
export function ensureSellerId(url: string | undefined | null): string {
  if (!url) return '';
  
  try {
    // Remove any existing tag parameters
    const urlObj = new URL(url);
    urlObj.searchParams.delete('tag');
    urlObj.searchParams.delete('AssociateTag');
    
    // Add our seller ID
    urlObj.searchParams.set('tag', SELLER_ID);
    
    return urlObj.toString();
  } catch (e) {
    // If URL parsing fails, try simple string manipulation as fallback
    if (url.includes('?')) {
      return `${url}&tag=${SELLER_ID}`;
    }
    return `${url}?tag=${SELLER_ID}`;
  }
}

/**
 * Ensures an Amazon cart URL has the seller ID affiliate tag.
 * Cart URLs use AssociateTag parameter instead of tag parameter.
 * 
 * @param cartUrl The Amazon cart URL (format: /gp/aws/cart/add.html?ASIN.1=...)
 * @returns The cart URL with AssociateTag parameter added
 * 
 * @example
 * ensureCartUrlSellerId('https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&Quantity.1=1')
 * // Returns: 'https://www.amazon.com/gp/aws/cart/add.html?ASIN.1=B01234567&Quantity.1=1&AssociateTag=robinfrench-20'
 */
export function ensureCartUrlSellerId(cartUrl: string | undefined | null): string {
  if (!cartUrl) return '';
  
  // If it already has AssociateTag, replace it with ours
  if (cartUrl.includes('AssociateTag=')) {
    return cartUrl.replace(/AssociateTag=[^&]+/, `AssociateTag=${SELLER_ID}`);
  }
  
  // If it has tag parameter, replace with AssociateTag
  if (cartUrl.includes('tag=')) {
    return cartUrl.replace(/tag=[^&]+/, `AssociateTag=${SELLER_ID}`);
  }
  
  // Add AssociateTag parameter
  const separator = cartUrl.includes('?') ? '&' : '?';
  return `${cartUrl}${separator}AssociateTag=${SELLER_ID}`;
}

/**
 * Adds seller ID to a link only if it doesn't already have one.
 * @param url The URL to potentially add seller ID to
 * @returns The URL with seller ID if it was missing
 */
export function addSellerIdIfMissing(url: string | undefined | null): string {
  if (!url) return '';
  
  if (url.includes('tag=') || url.includes('AssociateTag=')) {
    // Already has a tag, ensure it's ours
    return ensureSellerId(url);
  }
  
  // Add our seller ID
  const separator = url.includes('?') ? '&' : '?';
  return `${url}${separator}tag=${SELLER_ID}`;
}

/**
 * Extracts ASIN from an Amazon URL.
 * Supports multiple URL formats: /dp/ASIN, /gp/product/ASIN, /product/ASIN
 * 
 * @param url The Amazon URL containing an ASIN
 * @returns The ASIN (10-character alphanumeric code) or null if not found
 * 
 * @example
 * extractASIN('https://www.amazon.com/dp/B01234567?tag=robinfrench-20')
 * // Returns: 'B01234567'
 */
export function extractASIN(url: string | undefined | null): string | null {
  if (!url) return null;
  
  // Try /dp/ASIN pattern (most common) - ASIN is 10 characters, stop at / or ? or end
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (dpMatch) return dpMatch[1];
  
  // Try /gp/product/ASIN pattern
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (gpMatch) return gpMatch[1];
  
  // Try /product/ASIN pattern
  const productMatch = url.match(/\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (productMatch) return productMatch[1];
  
  // Try ASIN parameter
  try {
    const urlObj = new URL(url);
    const asinParam = urlObj.searchParams.get('ASIN');
    if (asinParam && /^[A-Z0-9]{10}$/.test(asinParam)) {
      return asinParam;
    }
  } catch (e) {
    // Invalid URL, continue
  }
  
  return null;
}

/**
 * Checks if a URL has our seller ID.
 * Works with both product links (tag=) and cart links (AssociateTag=).
 * 
 * @param url The URL to check
 * @returns True if the URL has our seller ID
 * 
 * @example
 * hasSellerId('https://www.amazon.com/dp/B01234567?tag=robinfrench-20')
 * // Returns: true
 */
export function hasSellerId(url: string | undefined | null): boolean {
  if (!url) return false;
  return url.includes(`tag=${SELLER_ID}`) || url.includes(`AssociateTag=${SELLER_ID}`);
}

/**
 * Validates that a URL is a valid Amazon URL.
 * 
 * @param url The URL to validate
 * @returns True if the URL is a valid Amazon URL
 */
export function isValidAmazonUrl(url: string | undefined | null): boolean {
  if (!url) return false;
  
  try {
    const urlObj = new URL(url);
    return urlObj.hostname.includes('amazon.com') || urlObj.hostname.includes('amzn.');
  } catch (e) {
    return false;
  }
}

/**
 * Validates that a URL is an Amazon cart URL.
 * 
 * @param url The URL to validate
 * @returns True if the URL is an Amazon cart URL
 */
export function isCartUrl(url: string | undefined | null): boolean {
  if (!url) return false;
  return url.includes('/gp/aws/cart/add.html') || url.includes('/gp/cart/view.html');
}
</file>

<file path="lib/utils/allIngredients.ts">
// lib/utils/allIngredients.ts
// Extract all ingredients from generate-recipes.js INGREDIENTS object
// This contains all the scraped AAFCO and research-based ingredients
// Also includes auto-generated ingredients from scraped data

import { GENERATED_INGREDIENTS } from '@/lib/data/generatedIngredients';

export interface SpeciesIngredients {
  [category: string]: string[];
}

export interface AllIngredients {
  dogs: {
    proteins: string[];
    carbs: string[];
    vegetables: string[];
    fats: string[];
  };
  cats: {
    proteins: string[];
    carbs: string[];
    vegetables: string[];
    fats: string[];
    fiber_supplements: string[];
    supplements: string[];
  };
  birds: {
    seeds: string[];
    nuts: string[]; // Added for large parrots
    vegetables: string[];
    fruits: string[];
    supplements: string[];
  };
  reptiles: {
    insects: string[];
    whole_prey: string[]; // Added for snakes
    vegetables: string[];
    fruits: string[];
  };
  'pocket-pets': {
    hay: string[];
    vegetables: string[];
    pellets: string[];
    fruits: string[];
    hamster_additions: string[];
    sugar_glider_special: string[]; // Added for gliders
  };
}

// This is the complete ingredient list from generate-recipes.js
// Contains all scraped AAFCO and research-based ingredients
export const ALL_INGREDIENTS: AllIngredients = {
  dogs: {
    proteins: [
      'ground chicken', 'ground turkey', 'ground beef (lean)', 'ground lamb', 'salmon (boneless)',
      'chicken breast', 'chicken thighs', 'turkey breast', 'beef liver', 'chicken liver',
      'chicken hearts', 'sardines (canned in water)', 'eggs', 'Turkey Giblets', 'Chicken Giblets',
      'Duck Breast', 'Venison', 'Rabbit Meat', 'quail', 'ground pork (lean)', 'turkey necks',
      'Ground Duck', 'Turkey Thighs', 'Chicken Necks', 'Ground Venison', 'Ground Rabbit',
      'Lamb Liver', 'Turkey Liver', 'Duck Hearts', 'Quail Eggs', 'Ground Quail'
    ],
    carbs: [
      'brown rice', 'white rice', 'quinoa', 'sweet potato', 'Regular Potato',
      'oats', 'Barley', 'pumpkin', 'Butternut Squash', 'lentils',
      'chickpeas', 'black beans', 'green peas', 'Wild Rice',
      'Amaranth', 'Buckwheat', 'Millet', 'Sorghum', 'Farro', 'Bulgur',
      'Split Peas', 'Kidney Beans (mashed)', 'Pinto Beans (mashed)', 'Navy Beans (mashed)',
      'Acorn Squash', 'Spaghetti Squash', 'Delicata Squash', 'Kabocha Squash'
    ],
    vegetables: [
      'carrots', 'green beans', 'Peas', 'spinach', 'broccoli', 'zucchini',
      'kale', 'celery', 'Bell Peppers (red/green)', 'brussels sprouts', 'asparagus', 'parsley',
      'cucumber', 'lettuce (romaine)', 'arugula', 'Endive', 'Escarole', 'Dandelion Greens',
      'Collard Greens', 'Turnip Greens', 'Beet Greens', 'Radish Greens',
      'Swiss Chard', 'bok choy', 'Napa Cabbage', 'Red Cabbage', 'Green Cabbage',
      'Cauliflower', 'Romanesco Broccoli', 'Snow Peas', 'Sugar Snap Peas',
      'Fennel', 'Leeks', 'Shallots', 'Garlic (small amounts)', 'Ginger (small amounts)',
      'Artichokes', 'Eggplant', 'Tomatoes (small amounts)', 'Yellow Squash', 'Pattypan Squash',
      'Radicchio', 'Frisee', 'Mache', 'Watercress', 'Purslane', 'Miner\'s Lettuce',
      'Lamb\'s Quarters', 'Amaranth Leaves', 'Malabar Spinach', 'New Zealand Spinach'
    ],
    fats: [
      'Coconut Oil', 'Olive Oil', 'Salmon Oil', 'Flaxseed (ground)', 'Hemp Seeds',
      'Eggshells (crushed)', 'Kelp Powder', 'Turmeric', 'Fish Oil', 'Avocado Oil',
      'Sunflower Oil', 'Sesame Oil', 'Pumpkin Seed Oil', 'Walnut Oil', 'Almond Oil',
      'Cod Liver Oil', 'Herring Oil', 'Mackerel Oil', 'Sardine Oil', 'Anchovy Oil',
      'Evening Primrose Oil', 'Borage Oil', 'Black Currant Oil', 'Chia Seed Oil'
    ]
  },
  cats: {
    proteins: [
      'ground chicken', 'ground turkey', 'ground beef (lean)', 'chicken thighs',
      'Turkey Thighs', 'salmon (boneless)', 'tuna', 'chicken liver',
      'Turkey Liver', 'sardines (canned in water)', 'eggs', 'Ground Duck', 'Rabbit Meat',
      'Venison', 'quail', 'ground lamb', 'Turkey Giblets', 'Chicken Giblets',
      'Ground Venison', 'Ground Rabbit', 'Duck Liver', 'Quail Meat', 'Ground Quail',
      'turkey necks', 'Chicken Necks', 'Duck Hearts', 'Turkey Hearts', 'Mackerel (canned)',
      'Herring (canned)', 'Anchovies (canned)', 'Ground Mackerel', 'Ground Herring',
      'Lamb Liver', 'beef liver', 'ground pork (lean)',
      'Turkey Sausage (no additives)', 'Chicken Sausage (no additives)'
    ],
    carbs: [
      'pumpkin', 'brown rice', 'oats',
      'sweet potato', 'quinoa', 'Barley (cooked, minimal)',
      'Butternut Squash (mashed, minimal)', 'Acorn Squash (mashed, minimal)', 'pumpkin',
      'Oat Bran (small amounts)', 'Rice Bran (small amounts)', 'Millet (tiny amounts)',
      'Amaranth (tiny amounts)', 'Buckwheat (tiny amounts)', 'lentils',
      'chickpeas', 'green peas', 'Split Peas (mashed)',
      'black beans', 'Kidney Beans (mashed, tiny amounts)'
    ],
    vegetables: [
      'carrots', 'Peas (mashed)', 'zucchini', 'spinach',
      'broccoli', 'green beans', 'Asparagus (tips only)',
      'celery', 'parsley', 'cucumber', 'lettuce (romaine)',
      'kale', 'Collard Greens (cooked, tiny amounts)',
      'Dandelion Greens (fresh, small amounts)', 'Endive (small amounts)', 'arugula',
      'bok choy', 'Napa Cabbage (small amounts)', 'green beans',
      'Snow Peas (mashed)', 'Sugar Snap Peas (mashed)', 'Fennel (small amounts)',
      'Swiss Chard (cooked, tiny amounts)', 'Beet Greens (cooked, tiny amounts)', 'Turnip Greens (cooked, tiny amounts)',
      'Radish Greens (cooked, tiny amounts)', 'Watercress (small amounts)', 'Purslane (small amounts)',
      'Cat Grass (wheatgrass)', 'Barley Grass', 'Alfalfa Sprouts (small amounts)'
    ],
    fats: [
      'Salmon Oil', 'Fish Oil', 'Cod Liver Oil', 'Herring Oil', 'Sardine Oil',
      'Mackerel Oil', 'Anchovy Oil', 'Krill Oil', 'Algae Oil (DHA)', 'Evening Primrose Oil',
      'Borage Oil', 'Black Currant Oil', 'Chia Seed Oil', 'Hemp Seed Oil', 'Flaxseed Oil',
      'Coconut Oil', 'Olive Oil (small amounts)', 'Avocado Oil (tiny amounts)', 'Wheat Germ Oil'
    ],
    fiber_supplements: [
      'Hairball Control Paste', 'Psyllium Husk', 'Probiotic Powder', 'Digestive Enzymes',
      'Brewer\'s Yeast', 'Spirulina Powder', 'Kelp Powder', 'Wheat Germ', 'Oat Bran',
      'Rice Bran', 'Inulin (prebiotic)', 'Fructooligosaccharides (FOS)', 'Mannanoligosaccharides (MOS)',
      'Beta-glucans', 'Pectin (from apples)', 'Chicory Root', 'Jerusalem Artichoke'
    ],
    supplements: [
      'Taurine Powder', 'L-Carnitine Powder', 'Lysine Powder', 'Vitamin E Oil',
      'Vitamin C (small amounts)', 'Vitamin B Complex', 'Niacinamide', 'Biotin',
      'Egg Yolks', 'Eggshells (crushed)', 'Chicken Broth (no salt)', 'Turkey Broth (no salt)',
      'Fish Broth (no salt)', 'Bone Broth (low sodium)', 'Cranberry Extract', 'D-Mannose',
      'Ursodeoxycholic Acid (UDCA)', 'S-Adenosyl methionine (SAM-e)', 'Milk Thistle',
      'Curcumin (turmeric extract)', 'Quercetin', 'Omega-3 Capsules', 'Joint Health Supplement',
      'Glucosamine Sulfate', 'Chondroitin Sulfate', 'MSM (methylsulfonylmethane)', 'Hyaluronic Acid'
    ]
  },
  birds: {
    seeds: [
      'Millet (white/red)', 'Canary Seed', 'Niger Seed', 'Oat Groats', 'Hemp Seeds',
      'Flaxseeds', 'Sesame Seeds', 'Chia Seeds', 'quinoa', 'Rapeseed',
      'Sunflower Seeds (small amounts)', 'Pumpkin Seeds', 'Safflower Seeds', 'Nyjer Seeds',
      'Amaranth Seeds', 'Buckwheat (hulled)', 'Barley (hulled)', 'Wheat (hulled)',
      'Rice (hulled)', 'Corn (cracked)', 'Poppy Seeds', 'Teff Seeds', 'Wild Bird Mix'
    ],
    nuts: [
      'Walnuts (in shell)', 'Almonds', 'Brazil Nuts', 'Pecans', 'Macadamia Nuts', 
      'Hazelnuts', 'Pine Nuts', 'Cashews', 'Pistachios', 'Peanuts (unsalted, roasted)'
    ],
    vegetables: [
      'carrots', 'broccoli', 'spinach', 'kale', 'Bell Peppers', 'zucchini',
      'sweet potato', 'Peas', 'Corn (fresh)', 'lettuce (romaine)', 'Endive',
      'Escarole', 'arugula', 'Dandelion Greens', 'Collard Greens',
      'Turnip Greens', 'Beet Greens', 'Swiss Chard', 'bok choy', 'Napa Cabbage',
      'Cauliflower', 'Romanesco Broccoli', 'Snow Peas', 'Sugar Snap Peas', 'asparagus',
      'celery', 'Fennel', 'parsley', 'Cilantro', 'Basil', 'Mint', 'Thyme'
    ],
    fruits: [
      'Apples (no seeds)', 'blueberries', 'Strawberries', 'Mango', 'bananas',
      'Grapes (chopped)', 'Papaya', 'Melon', 'Pineapple (small amounts)', 'Kiwi',
      'Raspberries', 'Blackberries', 'Cranberries', 'Cherries (pitted)', 'Pears (no seeds)',
      'Peaches (pitted)', 'Plums (pitted)', 'Apricots (pitted)', 'Figs', 'Dates (pitted)',
      'Raisins (unsweetened)', 'Currants', 'Goji Berries', 'Mulberries'
    ],
    supplements: [
      'eggs', 'Pellets (fortified)', 'Cuttlebone', 'Honey (tiny amounts)',
      'Peanut Butter (unsalted, tiny amounts)', 'Brewer\'s Yeast', 'Spirulina Powder',
      'Kelp Powder', 'Probiotic Powder', 'Vitamin D3 Drops', 'calcium carbonate',
      'Electrolyte Powder', 'Amino Acid Supplement', 'Fish Oil', 'Joint Health Powder'
    ]
  },
  reptiles: {
    insects: [
      'Dubia Roaches', 'Crickets', 'Mealworms', 'Superworms', 'Black Soldier Fly Larvae', 'Hornworms',
      'Silkworms', 'Waxworms', 'Butterworms', 'Phoenix Worms', 'Earthworms', 'Grasshoppers',
      'Locusts', 'Mantids', 'Fruit Flies', 'Pinhead Crickets', 'Small Dubia Roaches'
    ],
    whole_prey: [
      'Pinkie Mice (frozen/thawed)', 'Fuzzy Mice', 'Hopper Mice', 'Adult Mice',
      'Rat Pups', 'Adult Rats', 'Day-Old Chicks', 'quail', 'Feeder Fish (Guppies)', 'Silversides'
    ],
    vegetables: [
      'Collard Greens', 'Turnip Greens', 'Dandelion Greens', 'Butternut Squash',
      'Bell Peppers', 'carrots', 'zucchini', 'green beans', 'Snap Peas',
      'Acorn Squash', 'Endive', 'Escarole', 'arugula', 'kale', 'Swiss Chard', 'bok choy',
      'Napa Cabbage', 'Romaine Lettuce', 'Iceberg Lettuce', 'Red Leaf Lettuce', 'Butter Lettuce',
      'Cauliflower', 'broccoli', 'Romanesco Broccoli', 'asparagus', 'celery', 'Fennel',
      'parsley', 'Cilantro', 'Basil', 'Mint', 'Thyme', 'Oregano', 'Sage', 'Rosemary',
      'sweet potato', 'pumpkin', 'Squash (various)', 'cucumber', 'Eggplant'
    ],
    fruits: [
      'blueberries', 'Mango', 'Papaya', 'Strawberries', 'Figs', 'Apples (no seeds)',
      'Pears (no seeds)', 'bananas', 'Melon', 'Cantaloupe', 'Honeydew', 'Watermelon',
      'Pineapple', 'Kiwi', 'Raspberries', 'Blackberries', 'Cranberries', 'Cherries (pitted)',
      'Peaches (pitted)', 'Plums (pitted)', 'Apricots (pitted)', 'Grapes (seedless)',
      'Raisins (unsweetened)', 'Dates (pitted)', 'Prunes', 'Goji Berries', 'Mulberries'
    ]
  },
  'pocket-pets': {
    hay: [
      'Timothy Hay', 'Meadow Hay', 'Orchard Grass Hay', 'Alfalfa Hay (babies/pregnant only)',
      'Bermuda Hay', 'Bluegrass Hay', 'Fescue Hay', 'Ryegrass Hay', 'Wheat Hay',
      'Oat Hay', 'Barley Hay', 'Straw (wheat/pine)', 'Dried Grass'
    ],
    vegetables: [
      'lettuce (romaine)', 'Bell Peppers (high vitamin C)', 'carrots', 'cucumber', 'zucchini',
      'celery', 'parsley', 'Cilantro', 'kale', 'spinach', 'broccoli',
      'arugula', 'Endive', 'Basil', 'Mint', 'Collard Greens', 'Turnip Greens',
      'Dandelion Greens', 'Swiss Chard', 'bok choy', 'Napa Cabbage', 'Red Cabbage',
      'Green Cabbage', 'Cauliflower', 'asparagus', 'Fennel', 'Leeks', 'Shallots',
      'Garlic Chives', 'Radicchio', 'Frisee', 'Mache', 'Watercress', 'Purslane',
      'Miner\'s Lettuce', 'Lamb\'s Quarters', 'Amaranth Leaves', 'Malabar Spinach',
      'New Zealand Spinach', 'sweet potato', 'pumpkin', 'Squash (cooked)'
    ],
    pellets: [
      'Guinea Pig Pellets (with vitamin C)', 'Rabbit Pellets (high fiber)', 'Hamster Pellets (higher protein)',
      'Gerbil Pellets', 'Mouse/Rat Pellets', 'Chinchilla Pellets', 'Degus Pellets',
      'Fortified Pellets (vitamin C)', 'Timothy-Based Pellets', 'Alfalfa-Based Pellets'
    ],
    fruits: [
      'Apples (no seeds)', 'Strawberries', 'blueberries', 'bananas', 'Melon', 'Grapes', 'Papaya',
      'Pears (no seeds)', 'Peaches (pitted)', 'Plums (pitted)', 'Apricots (pitted)', 'Cherries (pitted)',
      'Raspberries', 'Blackberries', 'Cranberries', 'Kiwi', 'Pineapple (small amounts)',
      'Mango (small amounts)', 'Papaya (small amounts)', 'Figs', 'Dates (pitted)', 'Raisins (unsweetened)',
      'Goji Berries', 'Mulberries', 'Currants', 'Elderberries'
    ],
    hamster_additions: [
      'Mealworms (freeze-dried)', 'eggs', 'Whole Grain Cheerios',
      'Sunflower Seeds (unsalted)', 'Pumpkin Seeds (unsalted)', 'Flaxseeds', 'Chia Seeds',
      'Hemp Seeds', 'Sesame Seeds', 'Popcorn (plain)', 'Whole Wheat Pasta (cooked)',
      'brown rice', 'quinoa', 'Amaranth (cooked)', 'Buckwheat (cooked)',
      'Millet (cooked)', 'Barley (cooked)', 'oats', 'Corn (cooked)', 'Peas (cooked)'
    ],
    sugar_glider_special: [
      'Nectar Mix (commercial)', 'Gum Arabic', 'Eucalyptus Leaves', 'Acacia Gum', 
      'Bee Pollen', 'Manuka Honey', 'calcium carbonate'
    ]
  }
};

/**
 * Get all ingredients for a specific species
 * Now includes generated ingredients from scraped data
 */
export function getIngredientsForSpecies(species: string): string[] {
  const speciesData = ALL_INGREDIENTS[species as keyof AllIngredients];
  const all: string[] = [];
  
  // Add from manual ALL_INGREDIENTS
  if (speciesData) {
    Object.values(speciesData).forEach(category => {
      if (Array.isArray(category)) {
        all.push(...category);
      }
    });
  }
  
  // Add from generated ingredients based on subtype tags
  const normalizedSpecies = species === 'dog' ? 'dog' : 
                           species === 'cat' ? 'cat' :
                           species === 'bird' || species === 'birds' ? 'bird' :
                           species === 'reptile' || species === 'reptiles' ? 'reptile' :
                           species === 'pocket-pet' || species === 'pocket-pets' ? 'pocket-pet' : species;
  
  // Map species to potential subtypes
  const possibleSubtypes: string[] = [];
  if (normalizedSpecies === 'bird') {
    possibleSubtypes.push('bird_small', 'bird_large');
  } else if (normalizedSpecies === 'reptile') {
    possibleSubtypes.push('reptile_herbivore', 'reptile_insectivore', 'reptile_omnivore', 'reptile_carnivore');
  } else if (normalizedSpecies === 'pocket-pet') {
    possibleSubtypes.push('pocket_hay', 'pocket_varied', 'pocket_carnivore', 'pocket_insectivore');
    // For pocket pets (herbivores/omnivores like hamsters, guinea pigs, rabbits),
    // avoid auto-adding generated ingredients that may include meats (e.g., rabbit).
    // Return only the curated list above.
    return [...new Set(all)];
  }
  
  // Add generated ingredients that match any of the possible subtypes
  GENERATED_INGREDIENTS.forEach(ing => {
    if (possibleSubtypes.length === 0 || possibleSubtypes.some(subtype => ing.subtypeTags.includes(subtype))) {
      all.push(ing.name);
    }
  });
  
  return [...new Set(all)]; // Remove duplicates
}

/**
 * Map ingredient name to ingredient composition key
 */
export function mapIngredientToCompositionKey(ingredientName: string): string | null {
  const normalized = ingredientName
    .toLowerCase()
    .trim()
    .replace(/\s*\([^)]*\)/g, '') // Remove parentheses
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');
  
  // Import composition keys dynamically
  const { INGREDIENT_COMPOSITIONS } = require('@/lib/data/ingredientCompositions');
  
  // Direct lookup
  if (INGREDIENT_COMPOSITIONS[normalized]) {
    return normalized;
  }
  
  // Common mappings (only for variants/aliases, not fallbacks)
  const mappings: Record<string, string> = {
    'chicken_breast': 'chicken_breast',
    'chicken_liver': 'chicken_liver',
    'chicken_hearts': 'chicken_hearts',
    'beef_liver': 'beef_liver',
    'ground_beef': 'ground_beef_lean',
    'ground_turkey': 'ground_turkey',
    'ground_chicken': 'ground_chicken', // Now has its own entry
    'turkey_breast': 'turkey_breast',
    'salmon': 'salmon_atlantic',
    'tuna': 'tuna_water',
    'sardines': 'sardines_water',
    'white_rice': 'white_rice_cooked', // Now has its own entry
    'brown_rice': 'brown_rice_cooked',
    'quinoa': 'quinoa_cooked',
    'sweet_potato': 'sweet_potato',
    'pumpkin': 'pumpkin', // Now has its own entry
    'carrots': 'carrots_raw',
    'green_beans': 'green_beans_raw', // Now has its own entry
    'bok_choy': 'bok_choy', // Key uses standard spelling, but display is "Bok Choi"
    'bok_choi': 'bok_choy', // User prefers "bok choi" spelling
    'broccoli': 'broccoli_raw',
    'spinach': 'spinach_raw',
    'kale': 'kale_raw',
    'celery': 'celery_raw',
    'blueberries': 'blueberries_raw',
    'bananas': 'bananas_raw',
    'eggs': 'eggs_whole',
    'fish_oil': 'fish_oil',
    'salmon_oil': 'fish_oil', // Similar enough to use fish_oil
    'herring_oil': 'fish_oil', // Similar enough to use fish_oil
    'mackerel_oil': 'fish_oil', // Similar enough to use fish_oil
    'sardine_oil': 'fish_oil', // Similar enough to use fish_oil
    'cod_liver_oil': 'fish_oil', // Similar enough to use fish_oil
    'olive_oil': 'fish_oil', // Different but acceptable fallback
    'coconut_oil': 'fish_oil', // Different but acceptable fallback
    'avocado_oil': 'fish_oil', // Different but acceptable fallback
    'sunflower_oil': 'fish_oil', // Different but acceptable fallback
    'sesame_oil': 'fish_oil', // Different but acceptable fallback
    'oats': 'oats',
    'taurine': 'taurine_powder',
    'calcium': 'calcium_carbonate',
  };
  
  if (mappings[normalized]) {
    return mappings[normalized];
  }
  
  // Try partial matches
  for (const key in INGREDIENT_COMPOSITIONS) {
    if (normalized.includes(key) || key.includes(normalized)) {
      return key;
    }
  }
  
  return null;
}

/**
 * Get all available ingredients for recipe builder (all species combined)
 */
export function getAllAvailableIngredients(): string[] {
  const all = new Set<string>();
  
  Object.keys(ALL_INGREDIENTS).forEach(species => {
    getIngredientsForSpecies(species).forEach(ing => all.add(ing));
  });
  
  return Array.from(all).sort();
}

/**
 * Get display name for an ingredient composition key
 * Maps back to the original scraped ingredient name if available
 */
export function getIngredientDisplayName(compositionKey: string, species?: string): string {
  // If we have a species, try to find the original name from scraped data
  if (species) {
    const speciesData = ALL_INGREDIENTS[species as keyof AllIngredients];
    if (speciesData) {
      // Search through all categories for this species
      for (const category of Object.values(speciesData)) {
        if (Array.isArray(category)) {
          for (const ingName of category) {
            const mappedKey = mapIngredientToCompositionKey(ingName);
            if (mappedKey === compositionKey) {
              return ingName; // Return the original scraped name
            }
          }
        }
      }
    }
  }
  
  // Fallback: convert composition key to readable name
  return compositionKey
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
</file>

<file path="lib/utils/auth.ts">
// lib/utils/auth.ts
// Centralized authentication utilities

import { useAuth, useUser } from '@clerk/nextjs';

/**
 * Get the current user ID from Clerk
 * Falls back to simulated ID for development
 */
export function useCurrentUserId(): string | null {
  const { userId } = useAuth();
  
  // Use Clerk user ID if available
  if (userId) return userId;
  
  // Fallback for development (when not authenticated)
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem('last_user_id');
    if (stored) return stored;
  }
  
  return null;
}

/**
 * Server-side: Get user ID from localStorage fallback
 * This is a temporary bridge during migration
 */
export function getStoredUserId(): string {
  if (typeof window === 'undefined') return 'server-fallback-id';
  
  const stored = localStorage.getItem('last_user_id');
  return stored || 'clerk_simulated_user_id_123';
}

/**
 * Check if user is authenticated
 */
export function useIsAuthenticated(): boolean {
  const { isSignedIn, isLoaded } = useAuth();
  return isLoaded && (isSignedIn ?? false);
}
</file>

<file path="lib/utils/badgeChecker.ts">
// lib/utils/badgeChecker.ts
// Badge checking logic for pet achievements

import { BadgeType, BadgeTier, BadgeCheckContext } from '@/lib/types/badges';
import { getPetBadges, unlockBadge, updateBadgeProgress, hasBadge } from './badgeStorage';
import { getTierForProgress, getNextTierThreshold } from '@/lib/data/badgeDefinitions';
import { getPetPurchaseCount } from './petPurchaseTracking';
import { getPets } from './petStorage';
import { logger } from './logger';

/**
 * Check The Nutrient Navigator badge (100% compatibility score)
 */
export async function checkNutrientNavigatorBadge(
  userId: string,
  petId: string,
  compatibilityScore: number
): Promise<boolean> {
  if (compatibilityScore !== 100) {
    return false;
  }

  const badges = getPetBadges(userId, petId);
  if (hasBadge(badges, BadgeType.NUTRIENT_NAVIGATOR)) {
    return false; // Already unlocked
  }

  return unlockBadge(userId, petId, BadgeType.NUTRIENT_NAVIGATOR);
}

/**
 * Check The Master Meal Planner badge (requires ALL THREE conditions)
 */
export async function checkMasterMealPlannerBadge(
  userId: string,
  petId: string,
  mealPlanCount: number,
  savedRecipesCount: number,
  weeklyPlanCompleted: boolean
): Promise<boolean> {
  // Check if ALL THREE conditions are met
  const has4PlusMeals = mealPlanCount >= 4;
  const has10PlusSaved = savedRecipesCount >= 10;
  const hasCompletedWeek = weeklyPlanCompleted;

  if (!has4PlusMeals || !has10PlusSaved || !hasCompletedWeek) {
    return false; // Not all conditions met
  }

  const badges = getPetBadges(userId, petId);
  if (hasBadge(badges, BadgeType.MASTER_MEAL_PLANNER)) {
    return false; // Already unlocked
  }

  return unlockBadge(userId, petId, BadgeType.MASTER_MEAL_PLANNER);
}

/**
 * Check Planning Volume badge (progressive: 1, 10, 50)
 */
export async function checkPlanningVolumeBadge(
  userId: string,
  petId: string,
  completionCount: number
): Promise<boolean> {
  if (completionCount < 1) {
    return false;
  }

  const tier = getTierForProgress(BadgeType.PLANNING_VOLUME, completionCount);
  if (!tier) {
    return false;
  }

  const nextThreshold = getNextTierThreshold(BadgeType.PLANNING_VOLUME, tier);
  
  updateBadgeProgress(
    userId,
    petId,
    BadgeType.PLANNING_VOLUME,
    completionCount,
    tier
  );

  // Also unlock if this is a new tier
  const badges = getPetBadges(userId, petId);
  const existingBadge = badges.badges.find(b => b.type === BadgeType.PLANNING_VOLUME);
  
  if (!existingBadge || existingBadge.tier !== tier) {
    // New tier unlocked
    unlockBadge(userId, petId, BadgeType.PLANNING_VOLUME, tier);
    return true;
  }

  // Update progress
  if (existingBadge) {
    existingBadge.progress = completionCount;
    existingBadge.nextTierThreshold = nextThreshold || undefined;
  }

  return false; // No new unlock, just progress update
}

/**
 * Check Purchase Commitment badge (progressive: 1, 10, 20, 30, 40, 50+)
 */
export async function checkPurchaseCommitmentBadge(
  userId: string,
  petId: string,
  purchaseCount: number
): Promise<boolean> {
  if (purchaseCount < 1) {
    return false;
  }

  const tier = getTierForProgress(BadgeType.PURCHASE_COMMITMENT, purchaseCount);
  if (!tier) {
    return false;
  }

  const nextThreshold = getNextTierThreshold(BadgeType.PURCHASE_COMMITMENT, tier);
  
  updateBadgeProgress(
    userId,
    petId,
    BadgeType.PURCHASE_COMMITMENT,
    purchaseCount,
    tier
  );

  // Also unlock if this is a new tier
  const badges = getPetBadges(userId, petId);
  const existingBadge = badges.badges.find(b => b.type === BadgeType.PURCHASE_COMMITMENT);
  
  if (!existingBadge || existingBadge.tier !== tier) {
    // New tier unlocked
    unlockBadge(userId, petId, BadgeType.PURCHASE_COMMITMENT, tier);
    return true;
  }

  // Update progress
  if (existingBadge) {
    existingBadge.progress = purchaseCount;
    existingBadge.nextTierThreshold = nextThreshold || undefined;
  }

  return false; // No new unlock, just progress update
}

/**
 * Main function to check all relevant badges based on action context
 */
export async function checkAllBadges(
  userId: string,
  petId: string,
  context: BadgeCheckContext
): Promise<{ unlocked: BadgeType[]; updated: BadgeType[] }> {
  const unlocked: BadgeType[] = [];
  const updated: BadgeType[] = [];

  try {
    // Load pet data for context
    const pets = await getPets(userId);
    const pet = pets.find(p => p.id === petId);
    
    if (!pet) {
      logger.warn('Pet not found for badge checking', { userId, petId });
      return { unlocked, updated };
    }

    // Check Nutrient Navigator (100% compatibility)
    if (context.compatibilityScore === 100) {
      const wasUnlocked = await checkNutrientNavigatorBadge(
        userId,
        petId,
        context.compatibilityScore
      );
      if (wasUnlocked) {
        unlocked.push(BadgeType.NUTRIENT_NAVIGATOR);
      }
    }

    // Check Master Meal Planner (requires all conditions)
    if (context.action === 'meal_plan_created' || 
        context.action === 'recipe_saved' || 
        context.action === 'recipe_removed' ||
        context.action === 'meal_plan_completed') {
      
      const mealPlanCount = context.mealPlanCount ?? 0;
      const savedRecipesCount = context.savedRecipesCount ?? (pet.savedRecipes?.length || 0);
      const weeklyPlanCompleted = context.weeklyPlanCompleted ?? false;

      const wasUnlocked = await checkMasterMealPlannerBadge(
        userId,
        petId,
        mealPlanCount,
        savedRecipesCount,
        weeklyPlanCompleted
      );
      if (wasUnlocked) {
        unlocked.push(BadgeType.MASTER_MEAL_PLANNER);
      }
    }

    // Check Planning Volume (progressive)
    if (context.action === 'meal_plan_completed' && context.completionCount !== undefined) {
      const wasUnlocked = await checkPlanningVolumeBadge(
        userId,
        petId,
        context.completionCount
      );
      if (wasUnlocked) {
        unlocked.push(BadgeType.PLANNING_VOLUME);
      } else {
        updated.push(BadgeType.PLANNING_VOLUME);
      }
    }

    // Check Purchase Commitment (progressive)
    if (context.action === 'purchase_confirmed') {
      const purchaseCount = context.purchaseCount ?? getPetPurchaseCount(userId, petId);
      
      const wasUnlocked = await checkPurchaseCommitmentBadge(
        userId,
        petId,
        purchaseCount
      );
      if (wasUnlocked) {
        unlocked.push(BadgeType.PURCHASE_COMMITMENT);
      } else {
        updated.push(BadgeType.PURCHASE_COMMITMENT);
      }
    }

  } catch (error) {
    logger.error('Error checking badges', error as Error, { userId, petId, context });
  }

  return { unlocked, updated };
}
</file>

<file path="lib/utils/badgeStorage.ts">
// lib/utils/badgeStorage.ts
// Badge storage system for pet achievements

import { PetBadges, PetBadge, BadgeType, BadgeTier } from '@/lib/types/badges';
import { safeGetItem, safeSetItem, safeParseJSON } from './localStorageSafe';
import { logger } from './logger';

const PREFIX = 'pet_badges_';

/**
 * Get storage key for pet badges
 */
function getStorageKey(userId: string, petId: string): string {
  return `${PREFIX}${userId}_${petId}`;
}

/**
 * Load badges for a pet
 */
export function getPetBadges(userId: string, petId: string): PetBadges {
  if (!userId || !petId) {
    return { badges: [] };
  }

  try {
    const key = getStorageKey(userId, petId);
    const stored = safeGetItem(key);
    
    if (!stored) {
      return { badges: [] };
    }

    const parsed = safeParseJSON<PetBadges>(stored, { badges: [] });
    if (parsed && Array.isArray(parsed.badges)) {
      return parsed;
    }

    return { badges: [] };
  } catch (error) {
    logger.error('Failed to load pet badges', error as Error, { userId, petId } as any);
    return { badges: [] };
  }
}

/**
 * Save badges for a pet
 */
export function savePetBadges(userId: string, petId: string, badges: PetBadges): void {
  if (!userId || !petId) {
    logger.warn('Cannot save badges: missing userId or petId', { userId, petId });
    return;
  }

  try {
    const key = getStorageKey(userId, petId);
    badges.lastChecked = new Date().toISOString();
    safeSetItem(key, JSON.stringify(badges));
  } catch (error) {
    logger.error('Failed to save pet badges', error as Error, { userId, petId });
  }
}

/**
 * Check if a badge is unlocked
 */
export function hasBadge(badges: PetBadges, badgeType: BadgeType, tier?: BadgeTier): boolean {
  if (!badges || !badges.badges) {
    return false;
  }

  const badge = badges.badges.find(b => b.type === badgeType);
  
  if (!badge) {
    return false;
  }

  // For progressive badges, check if tier matches or is higher
  if (tier && badge.tier) {
    const tierOrder: BadgeTier[] = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'sultan'];
    const badgeTierIndex = tierOrder.indexOf(badge.tier);
    const requiredTierIndex = tierOrder.indexOf(tier);
    return badgeTierIndex >= requiredTierIndex;
  }

  return true;
}

/**
 * Unlock a badge (idempotent - safe to call multiple times)
 */
export function unlockBadge(
  userId: string,
  petId: string,
  badgeType: BadgeType,
  tier?: BadgeTier
): boolean {
  const badges = getPetBadges(userId, petId);
  
  // Check if already unlocked
  if (hasBadge(badges, badgeType, tier)) {
    return false; // Already unlocked
  }

  // Check if badge exists but needs tier upgrade
  const existingBadge = badges.badges.find(b => b.type === badgeType);
  
  if (existingBadge && tier) {
    // Upgrade tier if new tier is higher
    const tierOrder: BadgeTier[] = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'sultan'];
    const currentTierIndex = tierOrder.indexOf(existingBadge.tier || 'bronze');
    const newTierIndex = tierOrder.indexOf(tier);
    
    if (newTierIndex > currentTierIndex) {
      existingBadge.tier = tier;
      existingBadge.unlockedAt = new Date().toISOString();
      savePetBadges(userId, petId, badges);
      return true; // Tier upgraded
    }
    
    return false; // Already at this tier or higher
  }

  // Create new badge
  const newBadge: PetBadge = {
    type: badgeType,
    tier,
    unlockedAt: new Date().toISOString(),
  };

  badges.badges.push(newBadge);
  savePetBadges(userId, petId, badges);
  return true; // New badge unlocked
}

/**
 * Update progressive badge progress
 */
export function updateBadgeProgress(
  userId: string,
  petId: string,
  badgeType: BadgeType,
  progress: number,
  tier?: BadgeTier
): boolean {
  const badges = getPetBadges(userId, petId);
  const existingBadge = badges.badges.find(b => b.type === badgeType);

  if (existingBadge) {
    // Update existing badge
    existingBadge.progress = progress;
    if (tier) {
      existingBadge.tier = tier;
    }
    existingBadge.unlockedAt = existingBadge.unlockedAt || new Date().toISOString();
    savePetBadges(userId, petId, badges);
    return true;
  } else {
    // Create new badge with progress
    const newBadge: PetBadge = {
      type: badgeType,
      tier,
      progress,
      unlockedAt: new Date().toISOString(),
    };
    badges.badges.push(newBadge);
    savePetBadges(userId, petId, badges);
    return true;
  }
}

/**
 * Get badge by type
 */
export function getBadge(badges: PetBadges, badgeType: BadgeType): PetBadge | null {
  if (!badges || !badges.badges) {
    return null;
  }
  return badges.badges.find(b => b.type === badgeType) || null;
}

/**
 * Remove a badge (for testing/demo purposes)
 */
export function removeBadge(userId: string, petId: string, badgeType: BadgeType): boolean {
  const badges = getPetBadges(userId, petId);
  const index = badges.badges.findIndex(b => b.type === badgeType);
  
  if (index === -1) {
    return false; // Badge not found
  }
  
  badges.badges.splice(index, 1);
  savePetBadges(userId, petId, badges);
  return true; // Badge removed
}
</file>

<file path="lib/utils/beep.ts">
/**
 * Beep utility for task completion notifications
 * Quiet, automatic beeps that don't require user permission
 */

/**
 * Play a quiet beep sound
 * Uses Web Audio API for a softer, less intrusive beep
 */
export function beep(frequency: number = 400, duration: number = 100, volume: number = 0.1): void {
  if (typeof window === 'undefined') return;
  
  try {
    const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Set quiet volume (0.1 = 10% volume)
    gainNode.gain.value = volume;
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine'; // Softer sine wave instead of harsh square wave
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + duration / 1000);
  } catch (error) {
    // Fallback: silent if Web Audio API not available
    // Don't use console.beep as it's too loud and requires permission
  }
}

/**
 * Quiet beep for task completion
 */
export function taskCompleteBeep(): void {
  beep(400, 100, 0.08); // Very quiet completion beep
}

/**
 * Beep when user action is needed (approval/run)
 */
export function actionNeededBeep(): void {
  beep(500, 150, 0.12); // Slightly louder for important notifications
}
</file>

<file path="lib/utils/buyLinkValidation.ts">
// Intent-based buy link validation
// Validates Amazon links point to correct product TYPE, not exact title match

export type BuyLinkIntent =
  | 'produce'        // Fresh fruits/vegetables
  | 'pantry'         // Rice, oats, canned goods, grains
  | 'oil'            // Cooking oils, fish oils, supplements
  | 'supplement'     // Vitamins, minerals, health supplements
  | 'pet-feed'       // Hay, pellets, pet-specific foods
  | 'insect'         // Live/dried insects for reptiles/birds
  | 'meat'           // Fresh/frozen meat, organs
  | 'other';         // Catch-all

export interface IngredientRetailValidation {
  intent: BuyLinkIntent;
  required?: string[];   // Tokens that MUST appear in title (case-insensitive)
  forbidden?: string[];  // Tokens that must NOT appear (indicates wrong product)
  optional?: string[];   // Bonus tokens (not enforced, but good to have)
}

export type ValidationResult = 'PASS' | 'WARN' | 'FAIL';

export interface ValidationReport {
  result: ValidationResult;
  reason?: string;
  matchedRequired?: string[];
  foundForbidden?: string[];
  suggestions?: string[];
}

/**
 * Validates an Amazon product title against ingredient expectations.
 * Uses intent + token matching instead of string similarity.
 */
export function validateProductTitle(
  productTitle: string,
  validation: IngredientRetailValidation
): ValidationReport {
  const normalizedTitle = productTitle.toLowerCase();
  const tokens = normalizedTitle.split(/\s+/);
  
  // Check forbidden tokens (immediate fail)
  if (validation.forbidden) {
    const foundForbidden = validation.forbidden.filter(token => 
      normalizedTitle.includes(token.toLowerCase())
    );
    
    if (foundForbidden.length > 0) {
      return {
        result: 'FAIL',
        reason: `Contains forbidden tokens: ${foundForbidden.join(', ')}`,
        foundForbidden,
        suggestions: ['Find product without these terms', 'Check if this is cosmetic/non-food grade'],
      };
    }
  }
  
  // Check required tokens
  if (validation.required && validation.required.length > 0) {
    const matchedRequired = validation.required.filter(token =>
      normalizedTitle.includes(token.toLowerCase())
    );
    
    if (matchedRequired.length === 0) {
      return {
        result: 'FAIL',
        reason: `Missing all required tokens: ${validation.required.join(', ')}`,
        suggestions: ['Verify ASIN points to correct product type', 'Search for product with required terms'],
      };
    }
    
    if (matchedRequired.length < validation.required.length) {
      return {
        result: 'WARN',
        reason: `Missing some required tokens: ${validation.required.filter(t => !matchedRequired.includes(t)).join(', ')}`,
        matchedRequired,
        suggestions: ['Review if partial match is acceptable'],
      };
    }
    
    return {
      result: 'PASS',
      matchedRequired,
    };
  }
  
  // No required tokens - just check intent is reasonable
  return {
    result: 'PASS',
    reason: 'No specific validation rules, assuming correct',
  };
}

/**
 * Infers validation rules from ingredient name and category.
 * This provides sensible defaults when explicit rules aren't defined.
 */
export function inferValidationRules(
  ingredientName: string,
  category: string
): IngredientRetailValidation {
  const name = ingredientName.toLowerCase();
  
  // Oils - require "oil" and forbid cosmetic terms
  if (category === 'Oil' || name.includes('oil')) {
    const oilType = name.replace(/\s*oil.*/, '').trim();
    return {
      intent: 'oil',
      required: ['oil'],
      forbidden: ['massage', 'hair', 'skin', 'cosmetic', 'beauty', 'lotion', 'aromatherapy'],
      optional: [oilType, 'food', 'grade', 'culinary'],
    };
  }
  
  // Supplements - require supplement-related terms
  if (category === 'Supplement' || name.includes('supplement') || name.includes('vitamin')) {
    return {
      intent: 'supplement',
      forbidden: ['dog', 'cat', 'pet', 'chew', 'treat'], // Avoid pet-specific supplements
    };
  }
  
  // Meat - require meat type, forbid treats/jerky
  if (category === 'Meat') {
    return {
      intent: 'meat',
      forbidden: ['treat', 'jerky', 'chew', 'toy', 'dog', 'cat'],
      optional: ['fresh', 'frozen', 'raw'],
    };
  }
  
  // Insects - require insect type
  if (category === 'Insect') {
    return {
      intent: 'insect',
      forbidden: ['food', 'mix', 'blend'], // Avoid mixes, want pure insects
    };
  }
  
  // Hay/Pellets - pet-specific is OK
  if (category === 'Hay' || category === 'Pellet') {
    return {
      intent: 'pet-feed',
    };
  }
  
  // Vegetables/Fruits - produce
  if (category === 'Vegetable' || category === 'Fruit') {
    return {
      intent: 'produce',
      forbidden: ['juice', 'powder', 'extract'], // Want whole produce
    };
  }
  
  // Grains/Carbs - pantry items
  if (category === 'Carb' || category === 'Grain') {
    return {
      intent: 'pantry',
      forbidden: ['flour', 'bread', 'cereal'], // Want whole grains
    };
  }
  
  // Seeds
  if (category === 'Seed') {
    return {
      intent: 'pantry',
      forbidden: ['mix', 'blend', 'food'], // Want pure seeds
    };
  }
  
  return {
    intent: 'other',
  };
}

/**
 * Generates a suggested Amazon search query for manual ASIN lookup.
 */
export function generateSearchQuery(
  ingredientName: string,
  validation: IngredientRetailValidation
): string {
  const terms = [ingredientName];
  
  // Add intent-specific qualifiers
  if (validation.intent === 'oil') {
    terms.push('food grade', 'culinary');
  } else if (validation.intent === 'supplement') {
    terms.push('dietary supplement');
  } else if (validation.intent === 'meat') {
    terms.push('fresh', 'raw');
  } else if (validation.intent === 'produce') {
    terms.push('organic', 'fresh');
  }
  
  // Add required tokens if specified
  if (validation.required) {
    terms.push(...validation.required);
  }
  
  return terms.join(' ');
}

/**
 * Creates an Amazon search URL with affiliate tag.
 */
export function generateSearchUrl(searchQuery: string): string {
  const encoded = encodeURIComponent(searchQuery);
  return `https://www.amazon.com/s?k=${encoded}&tag=robinfrench-20`;
}
</file>

<file path="lib/utils/convertCustomMealToRecipe.ts">
import type { CustomMeal, Recipe } from '@/lib/types';

/**
 * Converts a CustomMeal to Recipe format for display in recipe detail pages
 */
export function convertCustomMealToRecipe(customMeal: CustomMeal): Recipe {
  return {
    id: customMeal.id,
    name: customMeal.name,
    category: 'custom' as any,
    ageGroup: ['adult'],
    healthConcerns: [],
    description: `Custom meal created on ${customMeal.createdAt ? new Date(customMeal.createdAt).toLocaleDateString() : 'unknown date'}`,
    ingredients: customMeal.ingredients.map((ing, idx) => ({
      id: `${idx + 1}`,
      name: ing.key.replace(/_/g, ' '),
      amount: `${ing.grams}g`,
    })),
    instructions: [
      'Mix all ingredients according to saved recipe',
      'Serve at recommended portion size',
      `Recommended serving: ${customMeal.analysis.recommendedServingGrams}g`,
    ],
    nutritionalInfo: {
      protein: {
        min: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.protein_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      fat: {
        min: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        max: (customMeal.analysis.nutrients.fat_g || 0) / (customMeal.analysis.totalRecipeGrams / 100),
        unit: '%',
      },
      calories: {
        min: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        max: customMeal.analysis.nutrients.kcal || customMeal.analysis.nutrients.calories_kcal || 0,
        unit: 'kcal',
      },
    },
    rating: 0,
    reviews: 0,
    tags: ['custom', 'user-created'],
  };
}
</file>

<file path="lib/utils/customMealStorage.ts">
// lib/utils/customMealStorage.ts
// Abstracted custom meal storage layer - Migrated to Firestore
// Note: All operations are now ASYNCHRONOUS

import { CustomMeal } from '@/lib/types';
import { MealAnalysis, IngredientSelection } from '@/lib/analyzeCustomMeal';
import * as firestoreService from '@/lib/services/firestoreService';
import { getPets, savePet } from './petStorage';
import { checkAllBadges } from './badgeChecker';

/**
 * Retrieves all custom meals for a given pet.
 * 
 * @param userId - User identifier
 * @param petId - Pet identifier
 * @returns Promise<CustomMeal[]>
 */
export async function getCustomMeals(userId: string, petId: string): Promise<CustomMeal[]> {
  if (!userId || !petId) return [];
  
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - loading custom meals from localStorage only');
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
      try {
        return stored ? JSON.parse(stored) : [];
      } catch {
        return [];
      }
    }
    return [];
  }
  
  try {
    return await firestoreService.getCustomMeals(userId, petId);
  } catch (e) {
    console.warn('Firestore getCustomMeals failed', e);
    // Fallback to localStorage
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
      return stored ? JSON.parse(stored) : [];
    }
    return [];
  }
}

/**
 * Saves a custom meal to storage.
 * 
 * @param userId - User identifier
 * @param petId - Pet identifier
 * @param mealName - Name of the meal
 * @param ingredients - Array of ingredient selections
 * @param analysis - Meal analysis results
 * @returns Promise<CustomMeal>
 */
export async function saveCustomMeal(
  userId: string,
  petId: string,
  mealName: string,
  ingredients: IngredientSelection[],
  analysis: MealAnalysis
): Promise<CustomMeal> {
  const now = new Date().toISOString();
  
  const customMeal: CustomMeal = {
    id: `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    petId,
    userId,
    name: mealName,
    createdAt: now,
    updatedAt: now,
    ingredients: ingredients.map(ing => ({
      key: ing.key,
      grams: ing.grams
    })),
    analysis: {
      score: analysis.score,
      nutrients: analysis.nutrients,
      totalRecipeGrams: analysis.totalRecipeGrams,
      recommendedServingGrams: analysis.recommendedServingGrams,
      breakdown: analysis.breakdown,
      toxicityWarnings: analysis.toxicityWarnings.map(w => ({
        message: w.message,
        severity: w.severity,
        ingredientKey: w.ingredientKey,
        ingredientName: w.ingredientName,
      })),
      allergyWarnings: analysis.allergyWarnings.map(w => ({
        message: typeof w === 'string' ? w : w.message,
        severity: typeof w === 'string' ? 'medium' : w.severity,
      })),
      nutrientWarnings: analysis.nutrientWarnings.map(w => ({
        message: w.message,
        severity: w.severity,
      })),
      suggestions: analysis.suggestions.map(s => ({
        message: typeof s === 'string' ? s : s.message,
        action: typeof s === 'string' ? undefined : s.action,
        confidence: typeof s === 'string' ? undefined : s.confidence,
      })),
    },
  };
  
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - saving custom meal to localStorage only');
    
    // Save to localStorage
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
      const meals = stored ? JSON.parse(stored) : [];
      meals.push(customMeal);
      localStorage.setItem(`custom_meals_${userId}_${petId}`, JSON.stringify(meals));
    }
    
    // Also add the custom meal ID to the pet's savedRecipes array
    const pets = await getPets(userId);
    const pet = pets.find(p => p.id === petId);
    
    if (pet) {
      const savedRecipes = pet.savedRecipes || [];
      if (!savedRecipes.includes(customMeal.id)) {
        const updatedPet = {
          ...pet,
          savedRecipes: [...savedRecipes, customMeal.id],
        };
        await savePet(userId, updatedPet);
      }
    }
    
    // Dispatch custom event for same-tab updates
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('customMealsUpdated', { 
        detail: { userId, petId, mealId: customMeal.id } 
      }));
    }
    
    // Check badges (Nutrient Navigator if score is 100)
    // Note: analysis.score might be a different metric, we'll check compatibility score separately
    // For now, we'll check badges when the meal is viewed/scored elsewhere
    // This is a placeholder - actual compatibility scoring happens in MealCompleteView
    
    return customMeal;
  }
  
  // Save to Firestore
  await firestoreService.saveCustomMeal(userId, customMeal);
  
  // Also add the custom meal ID to the pet's savedRecipes array
  // We need to fetch the pet, update it, and save it back
  const pets = await getPets(userId);
  const pet = pets.find(p => p.id === petId);
  
  if (pet) {
    const savedRecipes = pet.savedRecipes || [];
    if (!savedRecipes.includes(customMeal.id)) {
      const updatedPet = {
        ...pet,
        savedRecipes: [...savedRecipes, customMeal.id],
      };
      await savePet(userId, updatedPet);
    }
  }
  
  // Backup to localStorage for safety
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
    const meals = stored ? JSON.parse(stored) : [];
    meals.push(customMeal);
    localStorage.setItem(`custom_meals_${userId}_${petId}`, JSON.stringify(meals));
    
    // Dispatch custom event for same-tab updates
    window.dispatchEvent(new CustomEvent('customMealsUpdated', { 
      detail: { userId, petId, mealId: customMeal.id } 
    }));
  }
  
  return customMeal;
}

/**
 * Deletes a custom meal from storage.
 * 
 * @param userId - User identifier
 * @param petId - Pet identifier
 * @param mealId - Meal ID to delete
 * @returns Promise<void>
 */
export async function deleteCustomMeal(userId: string, petId: string, mealId: string): Promise<void> {
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - deleting custom meal from localStorage only');
    
    // Delete from localStorage
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
      if (stored) {
        try {
          const meals: any[] = JSON.parse(stored);
          const filtered = meals.filter(m => m.id !== mealId);
          localStorage.setItem(`custom_meals_${userId}_${petId}`, JSON.stringify(filtered));
        } catch (e) {
          console.error('Error deleting custom meal from localStorage:', e);
        }
      }
    }
    
    // Also remove from pet's savedRecipes
    const pets = await getPets(userId);
    const pet = pets.find(p => p.id === petId);
    
    if (pet) {
      const savedRecipes = pet.savedRecipes || [];
      const updatedPet = {
        ...pet,
        savedRecipes: savedRecipes.filter(id => id !== mealId),
      };
      await savePet(userId, updatedPet);
    }
    
    return;
  }
  
  await firestoreService.deleteCustomMeal(userId, mealId);
  
  // Also remove from pet's savedRecipes
  const pets = await getPets(userId);
  const pet = pets.find(p => p.id === petId);
  
  if (pet) {
    const savedRecipes = pet.savedRecipes || [];
    const updatedPet = {
      ...pet,
      savedRecipes: savedRecipes.filter(id => id !== mealId),
    };
    await savePet(userId, updatedPet);
  }
  
  // Sync localStorage
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
    if (stored) {
      const meals: any[] = JSON.parse(stored);
      const filtered = meals.filter(m => m.id !== mealId);
      localStorage.setItem(`custom_meals_${userId}_${petId}`, JSON.stringify(filtered));
    }
  }
}

/**
 * Gets a single custom meal by ID.
 * 
 * @param userId - User identifier
 * @param petId - Pet identifier
 * @param mealId - Meal ID to retrieve
 * @returns Promise<CustomMeal | null>
 */
export async function getCustomMeal(userId: string, petId: string, mealId: string): Promise<CustomMeal | null> {
  const meals = await getCustomMeals(userId, petId);
  return meals.find(m => m.id === mealId) || null;
}

/**
 * Updates a custom meal's name.
 * 
 * @param userId - User identifier
 * @param petId - Pet identifier
 * @param mealId - Meal ID to update
 * @param newName - New name for the meal
 * @returns Promise<void>
 */
export async function updateCustomMealName(
  userId: string,
  petId: string,
  mealId: string,
  newName: string
): Promise<void> {
  const meal = await getCustomMeal(userId, petId, mealId);
  if (meal) {
    meal.name = newName;
    meal.updatedAt = new Date().toISOString();
    await firestoreService.saveCustomMeal(userId, meal);
    
    // Sync localStorage
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`custom_meals_${userId}_${petId}`);
      if (stored) {
        const meals: any[] = JSON.parse(stored);
        const localMeal = meals.find(m => m.id === mealId);
        if (localMeal) {
          localMeal.name = newName;
          localMeal.updatedAt = meal.updatedAt;
          localStorage.setItem(`custom_meals_${userId}_${petId}`, JSON.stringify(meals));
        }
      }
    }
  }
}
</file>

<file path="lib/utils/customMealStorageFirebase.ts">
// lib/utils/customMealStorageFirebase.ts
// Firebase implementation of custom meal storage
// This replaces localStorage with Firestore while maintaining the same API

import type { CustomMeal } from '@/lib/types';
import type { MealAnalysis, IngredientSelection } from '@/lib/analyzeCustomMeal';
import { getFirebaseServices, getAppId } from './firebaseConfig';
import { 
  collection, 
  doc, 
  addDoc, 
  getDocs, 
  getDoc, 
  deleteDoc, 
  updateDoc,
  onSnapshot,
  query,
  where,
  type Firestore
} from 'firebase/firestore';

/**
 * Firebase implementation of getCustomMeals
 * Uses real-time listener (onSnapshot) for live updates
 */
export function getCustomMealsFirebase(
  userId: string, 
  petId: string,
  onUpdate?: (meals: CustomMeal[]) => void
): () => void {
  const services = getFirebaseServices();
  if (!services) {
    // Fallback to localStorage if Firebase not available
    const { getCustomMeals } = require('./customMealStorage');
    const meals = getCustomMeals(userId, petId);
    if (onUpdate) onUpdate(meals);
    return () => {}; // No-op unsubscribe
  }
  
  const { db } = services;
  const appId = getAppId();
  const recipesRef = collection(db, `artifacts/${appId}/users/${userId}/recipes`);
  
  // Query for recipes for this pet
  const q = query(recipesRef, where('petId', '==', petId));
  
  // Set up real-time listener
  const unsubscribe = onSnapshot(q, (snapshot) => {
    const meals: CustomMeal[] = [];
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      meals.push({
        id: docSnap.id,
        ...data
      } as CustomMeal);
    });
    
    // Sort by most recent first
    meals.sort((a, b) => 
      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    );
    
    if (onUpdate) {
      onUpdate(meals);
    }
  }, (error) => {
    console.error('Error listening to custom meals:', error);
    // Fallback to localStorage on error
    const { getCustomMeals } = require('./customMealStorage');
    const meals = getCustomMeals(userId, petId);
    if (onUpdate) onUpdate(meals);
  });
  
  return unsubscribe;
}

/**
 * Firebase implementation of saveCustomMeal
 */
export async function saveCustomMealFirebase(
  userId: string,
  petId: string,
  mealName: string,
  ingredients: IngredientSelection[],
  analysis: MealAnalysis
): Promise<CustomMeal> {
  const services = getFirebaseServices();
  if (!services) {
    // Fallback to localStorage
    const { saveCustomMeal } = require('./customMealStorage');
    return saveCustomMeal(userId, petId, mealName, ingredients, analysis);
  }
  
  const { db } = services;
  const appId = getAppId();
  const recipesRef = collection(db, `artifacts/${appId}/users/${userId}/recipes`);
  
  const now = new Date().toISOString();
  
  const customMealData = {
    petId,
    userId,
    name: mealName,
    createdAt: now,
    updatedAt: now,
    ingredients: ingredients.map(ing => ({
      key: ing.key,
      grams: ing.grams
    })),
    analysis: {
      score: analysis.score,
      nutrients: analysis.nutrients,
      totalRecipeGrams: analysis.totalRecipeGrams,
      recommendedServingGrams: analysis.recommendedServingGrams,
      breakdown: {
        nutrientCoverageScore: analysis.breakdown.nutrientCoverageScore,
        toxicityPenalty: analysis.breakdown.toxicityPenalty,
        balanceVarietyScore: analysis.breakdown.balanceVarietyScore,
      },
      toxicityWarnings: analysis.toxicityWarnings.map(w => ({
        message: w.message,
        severity: w.severity,
        ingredientKey: w.ingredientKey,
        ingredientName: w.ingredientName,
      })),
      allergyWarnings: analysis.allergyWarnings.map(w => ({
        message: typeof w === 'string' ? w : w.message,
        severity: typeof w === 'string' ? 'medium' : w.severity,
      })),
      nutrientWarnings: analysis.nutrientWarnings.map(w => ({
        message: w.message,
        severity: w.severity,
      })),
      suggestions: analysis.suggestions.map(s => ({
        message: typeof s === 'string' ? s : s.message,
        action: typeof s === 'string' ? undefined : s.action,
        confidence: typeof s === 'string' ? undefined : s.confidence,
      })),
    },
  };
  
  try {
    const docRef = await addDoc(recipesRef, customMealData);
    return {
      id: docRef.id,
      ...customMealData
    } as CustomMeal;
  } catch (error) {
    console.error('Error saving custom meal to Firestore:', error);
    // Fallback to localStorage
    const { saveCustomMeal } = require('./customMealStorage');
    return saveCustomMeal(userId, petId, mealName, ingredients, analysis);
  }
}

/**
 * Firebase implementation of deleteCustomMeal
 */
export async function deleteCustomMealFirebase(
  userId: string,
  petId: string,
  mealId: string
): Promise<void> {
  const services = getFirebaseServices();
  if (!services) {
    // Fallback to localStorage
    const { deleteCustomMeal } = require('./customMealStorage');
    return deleteCustomMeal(userId, petId, mealId);
  }
  
  const { db } = services;
  const appId = getAppId();
  const mealRef = doc(db, `artifacts/${appId}/users/${userId}/recipes/${mealId}`);
  
  try {
    await deleteDoc(mealRef);
  } catch (error) {
    console.error('Error deleting custom meal from Firestore:', error);
    // Fallback to localStorage
    const { deleteCustomMeal } = require('./customMealStorage');
    return deleteCustomMeal(userId, petId, mealId);
  }
}

/**
 * Firebase implementation of getCustomMeal
 */
export async function getCustomMealFirebase(
  userId: string,
  petId: string,
  mealId: string
): Promise<CustomMeal | null> {
  const services = getFirebaseServices();
  if (!services) {
    // Fallback to localStorage
    const { getCustomMeal } = require('./customMealStorage');
    return getCustomMeal(userId, petId, mealId);
  }
  
  const { db } = services;
  const appId = getAppId();
  const mealRef = doc(db, `artifacts/${appId}/users/${userId}/recipes/${mealId}`);
  
  try {
    const docSnap = await getDoc(mealRef);
    if (docSnap.exists()) {
      return {
        id: docSnap.id,
        ...docSnap.data()
      } as CustomMeal;
    }
    return null;
  } catch (error) {
    console.error('Error getting custom meal from Firestore:', error);
    // Fallback to localStorage
    const { getCustomMeal } = require('./customMealStorage');
    return getCustomMeal(userId, petId, mealId);
  }
}
</file>

<file path="lib/utils/diversityTracker.ts">
import type { Ingredient } from '@/lib/types';

export interface MealHistoryEntry {
  petId: string;
  recipeId: string;
  recipeName: string;
  ingredients: string[];
  fedAt: Date;
}

const HISTORY_KEY = (petId: string) => `mealHistory_${petId}`;

function readHistory(petId: string): MealHistoryEntry[] {
  if (typeof window === 'undefined') return [];
  try {
    const raw = localStorage.getItem(HISTORY_KEY(petId));
    if (!raw) return [];
    const parsed = JSON.parse(raw) as MealHistoryEntry[];
    return parsed.map((e) => ({ ...e, fedAt: new Date(e.fedAt) }));
  } catch {
    return [];
  }
}

function writeHistory(petId: string, entries: MealHistoryEntry[]) {
  if (typeof window === 'undefined') return;
  localStorage.setItem(HISTORY_KEY(petId), JSON.stringify(entries));
}

// Log a meal fed to a pet
export function logMealFed(entry: MealHistoryEntry): void {
  if (typeof window === 'undefined') return;
  const existing = readHistory(entry.petId);
  const withDate = { ...entry, fedAt: new Date(entry.fedAt) };
  existing.unshift(withDate);
  // Cap history to avoid unbounded growth
  writeHistory(entry.petId, existing.slice(0, 200));
}

// Get meal history for a pet, optionally limited by days
export function getMealHistory(petId: string, days?: number): MealHistoryEntry[] {
  const history = readHistory(petId);
  if (!days) return history.sort((a, b) => b.fedAt.getTime() - a.fedAt.getTime());
  const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
  return history
    .filter((h) => h.fedAt.getTime() >= cutoff)
    .sort((a, b) => b.fedAt.getTime() - a.fedAt.getTime());
}

// Get unique ingredient names used in the past N days
export function getRecentIngredients(petId: string, days: number = 7): string[] {
  const recent = getMealHistory(petId, days);
  const set = new Set<string>();
  recent.forEach((m) => m.ingredients.forEach((ing) => set.add(ing.toLowerCase().trim())));
  return Array.from(set);
}

// Calculate overlap-based diversity penalty
export function calculateDiversityPenalty(
  recipeIngredients: string[],
  recentIngredients: string[]
): { overlap: number; penalty: number } {
  const normRecent = recentIngredients.map((r) => r.toLowerCase());
  const overlap = recipeIngredients.filter((ing) => normRecent.includes(ing.toLowerCase())).length;
  return { overlap, penalty: overlap * 5 };
}

// Normalize ingredient names from Recipe ingredient objects or strings
export function normalizeIngredientNames(ings: (string | Ingredient)[]): string[] {
  return ings.map((ing) => (typeof ing === 'string' ? ing : ing.name || ing.id)).map((n) => n.toLowerCase().trim());
}
</file>

<file path="lib/utils/emojiMapping.ts">
// lib/utils/emojiMapping.ts
// Smart emoji to image mapping based on actual grid content

/**
 * Based on NEW grid analysis (updated with latest uploads):
 * - amojis.png: 8x10 grid, 80 unique animal emojis (NEW - segmented as amojis_001.png through amojis_080.png)
 * - copilot_emojis: 10x11 grid, 110 emojis (more variety, includes symbols)
 * - emoji_grid: 7 grids, 64 each (some duplicates with amojis)
 * - best set: 4x4 grid, 16 ultra-minimalist icons (NEW - segmented with descriptive names)
 * 
 * Priority: best > amojis > copilot > emoji_grid
 * 
 * NEW Best set grid layout (4x4):
 * Row 1: Dog (best_dog.png), Cat (best_cat.png), Bird (best_bird.png), Lizard/Frog (best_reptile.png)
 * Row 2: Rabbit (best_rabbit.png), Hamster (best_hamster.png), Thumbs Up Left (best_thumbs_up_left.png), Thumbs Up Right (best_thumbs_up_right.png)
 * Row 3: Balance Scale (best_balance_scale.png), Warning (best_warning.png), Check Mark (best_check_mark.png), Trophy (best_trophy.png)
 * Row 4: Paw Prints (best_paw_prints.png), Star (best_star.png), Sparkle Single (best_sparkle_single.png), Sparkles Multiple (best_sparkles_multiple.png)
 */

// Primary pet emojis - using mascot images
export const PET_EMOJI_MAP: Record<string, string> = {
  // Main pet types - using mascot images
  'üêï': '/images/emojis/Mascots/Prep Puppy.jpg', // Dog - Prep Puppy mascot
  'üê∂': '/images/emojis/Mascots/Prep Puppy.jpg', // Dog (alternative) - Prep Puppy mascot
  'üêà': '/images/emojis/Mascots/ProfessorPurffesor.jpg', // Cat - Professor Purrfessor mascot
  'üê±': '/images/emojis/Mascots/ProfessorPurffesor.jpg', // Cat (alternative) - Professor Purrfessor mascot
  'ü¶ú': '/images/emojis/Mascots/RobinRed-Route.jpg', // Bird/Parrot - Robin Redroute mascot
  'üê¶': '/images/emojis/Mascots/RobinRed-Route.jpg', // Bird (alternative) - Robin Redroute mascot
  'ü¶é': '/images/emojis/Mascots/SherlockShells.jpg', // Lizard/Frog - Sherlock Shells mascot
  'üê¢': '/images/emojis/Mascots/SherlockShells.jpg', // Turtle (alternative) - Sherlock Shells mascot
  'üê∞': '/images/emojis/Mascots/harvesthamster.jpg', // Rabbit - Harvest Hamster mascot
  'üêá': '/images/emojis/Mascots/harvesthamster.jpg', // Rabbit (alternative) - Harvest Hamster mascot
  
  // Pocket pet variations - using mascot images
  'üêπ': '/images/emojis/Mascots/harvesthamster.jpg', // Hamster - Harvest Hamster mascot
  'üê≠': '/images/emojis/amojis_038.png', // Mouse (not in best set, using amojis fallback - Row 5, position 8)
  'ü¶î': '/images/emojis/Mascots/harvesthamster.jpg', // Hedgehog (use hamster) - Harvest Hamster mascot
  'ü¶¶': '/images/emojis/Mascots/harvesthamster.jpg', // Ferret/Otter (use hamster) - Harvest Hamster mascot
  
  // Additional animals - fallback to amojis for ones not in best set
  // Amojis grid (8x10, 80 icons) - various animals including:
  'üêª': '/images/emojis/amojis_011.png', // Bear (brown, standing on two legs) - Amojis grid Row 1, position 8
  'üêº': '/images/emojis/amojis_012.png', // Panda (black and white, facing left/right) - Amojis grid Row 1, position 9 or Row 2, positions 4-5
  'ü¶ä': '/images/emojis/amojis_014.png', // Fox (orange, pointed ears, bushy tail) - Amojis grid Row 1, position 9 or Row 2, position 6
  'üê®': '/images/emojis/amojis_017.png', // Koala (grey, with leaf) - Amojis grid Row 3, position 1
  'üê∏': '/images/emojis/Mascots/SherlockShells.jpg', // Frog (use reptile mascot) - Sherlock Shells mascot
  'üêü': '/images/emojis/amojis_026.png', // Fish (yellow, with fins) - Amojis grid Row 5, position 2
  'üê¥': '/images/emojis/amojis_049.png', // Horse (yellow/grey/brown/orange, standing on four legs) - Amojis grid Row 6, position 9 or Row 7, positions 1,5,7,8,9
  'ü¶â': '/images/emojis/amojis_007.png', // Owl (black/brown, large white eyes) - Amojis grid Row 1, position 2 or Row 8, position 6
  
  // Paw prints - using best set (Row 4 of best grid)
  'üêæ': '/images/emojis/best_paw_prints.png', // Paw Prints (three dark grey/black prints, diagonal arrangement) - Best grid Row 4, position 1
};

// Status/symbol emojis - using "best" set (ultra-minimalist, best quality)
// Best set grid positions: Row 2 (positions 3-4), Row 3 (positions 1-4), Row 4 (positions 2-4)
export const STATUS_EMOJI_MAP: Record<string, string> = {
  '‚≠ê': '/images/emojis/best_star.png', // Star (five-pointed yellow) - Best grid Row 4, position 2
  '‚ú®': '/images/emojis/best_sparkles_multiple.png', // Sparkles (multiple yellow four-pointed sparkles) - Best grid Row 4, position 4
  '‚úÖ': '/images/emojis/best_check_mark.png', // Check Mark (bold green) - Best grid Row 3, position 3
  '‚ùå': '/images/emojis/copilot_emojis_071.png', // X Mark (not in best set, use copilot)
  '‚ö†Ô∏è': '/images/emojis/best_warning.png', // Warning (yellow equilateral triangle with black exclamation mark) - Best grid Row 3, position 2
  'üëç': '/images/emojis/best_thumbs_up_right.png', // Thumbs Up (yellow hand gesture, pointing right) - Best grid Row 2, position 4
  'üëé': '/images/emojis/copilot_emojis_072.png', // Thumbs Down (not in best set, use copilot)
  '‚öñÔ∏è': '/images/emojis/Mascots/ProfessorPurffesor.jpg', // Balance Scale - Professor Purrfessor mascot (research, balance)
  'üèÜ': '/images/emojis/best_trophy.png', // Trophy (yellow cup with two handles) - Best grid Row 3, position 4
  // Additional celebration emojis used on site - using mascot images
  'üéâ': '/images/emojis/Mascots/Prep Puppy.jpg', // Party Popper - Prep Puppy mascot (celebration)
  'üéä': '/images/emojis/Mascots/Prep Puppy.jpg', // Confetti - Prep Puppy mascot (celebration)
  '‚ù§Ô∏è': '/images/emojis/Mascots/Prep Puppy.jpg', // Red Heart - Prep Puppy mascot (warmth, care)
  'üíö': '/images/emojis/Mascots/Prep Puppy.jpg', // Green Heart - Prep Puppy mascot (warmth, care)
  'üíõ': '/images/emojis/Mascots/Prep Puppy.jpg', // Yellow Heart - Prep Puppy mascot (warmth, care)
  'üéÇ': '/images/emojis/Mascots/Prep Puppy.jpg', // Birthday Cake - Prep Puppy mascot (celebration)
};

// Combined map
export const EMOJI_IMAGE_MAP: Record<string, string> = {
  ...PET_EMOJI_MAP,
  ...STATUS_EMOJI_MAP,
};

/**
 * Get image path for an emoji
 * Returns null if no mapping found (fallback to hash-based selection)
 */
export function getEmojiImagePath(emoji: string): string | null {
  return EMOJI_IMAGE_MAP[emoji] || null;
}

/**
 * Hash-based fallback for unmapped emojis
 * Uses amojis set (most consistent quality)
 */
export function getHashBasedEmojiImage(emoji: string): string {
  // Simple hash function
  let hash = 0;
  for (let i = 0; i < emoji.length; i++) {
    hash = ((hash << 5) - hash) + emoji.charCodeAt(i);
    hash = hash & hash; // Convert to 32bit integer
  }
  
  // Use NEW amojis grid (80 images, most consistent)
  const imageNum = (Math.abs(hash) % 80) + 1;
  return `/images/emojis/amojis_${imageNum.toString().padStart(3, '0')}.png`;
}

/**
 * Mascot face emojis - head/bust portraits of the 5 Meal Masters mascots
 * Source: mascot_face_emojis-removebg-preview.png (5 mascot heads in a horizontal row)
 * 
 * Brand Bible Alignment:
 * - Puppy Prepper (Chef) - Light gold dog with chef hat
 * - Professor Purrfessor (Researcher) - Black cat with glasses
 * - Sherlock Shells (Explorer) - Green turtle with cap and monocle
 * - Farmer Fluff (Ingredient Provider) - Dark brown hamster
 * - Robin Redroute (Delivery Specialist) - Red bird with captain's hat and goggles
 *
 * Usage Guidelines (Strategic Mascot Usage):
 * ‚úÖ GOOD: Meal creation tool, ingredient selection, compatibility scoring, error/success states, 
 *          loading screens, tooltips, achievements, homepage hero, empty states, onboarding,
 *          "ingredient discovered" moments, "new recipe unlocked" popups, delivery confirmations
 * ‚ùå AVOID: Educational nutritional text, legal/policy pages, checkout, payment, longform articles, 
 *          scientific explanations, body text paragraphs, navigation menus, critical flows
 */
export const MASCOT_FACE_EMOJI_MAP: Record<string, string> = {
  // Puppy Prepper - The Chef & Meal-Prep Lead
  // Position 1 (left): Yellow dog's head with friendly expression, small black eyes and nose/mouth, wearing puffy white chef's hat
  // Personality: Serious chef energy, impatient, slightly Gordon Ramsay; secretly soft-hearted
  // Color: Light gold
  'puppy-prepper': '/images/emojis/Mascots/Prep Puppy.jpg', // Official name from brand bible
  'barker': '/images/emojis/Mascots/Prep Puppy.jpg', // Legacy name (deprecated)
  'prepperpuppy': '/images/emojis/Mascots/Prep Puppy.jpg', // Alternative spelling
  
  // Professor Purrfessor - The Researcher & Recipe Tester
  // Position 2: Dark grey/black cat's head with large round white glasses covering eyes, small white triangular nose and mouth, pointed ears
  // Personality: Nerdy, anxious, brilliant, catastrophizes constantly
  // Color: Black/charcoal
  'professor-purrfessor': '/images/emojis/Mascots/ProfessorPurffesor.jpg', // Official name from brand bible
  'whiskers': '/images/emojis/Mascots/ProfessorPurffesor.jpg', // Legacy name (deprecated)
  
  // Sherlock Shells - Explorer & Risk Inspector
  // Position 3: Light green round creature's head (turtle/blob), single large black eye with white highlight, wearing dark orange cap with small brim, black monocle hanging from right eye
  // Personality: Soft-spoken, melancholy, overly thoughtful
  // Color: Green
  'sherlock-shells': '/images/emojis/Mascots/SherlockShells.jpg', // Official name from brand bible
  'scales': '/images/emojis/Mascots/SherlockShells.jpg', // Legacy name (deprecated)
  
  // Farmer Fluff - Ingredient Provider & Farm Manager
  // Position 4: Brown hamster's head, light brown face with darker brown outline for head and ears, small black eyes and nose/mouth
  // Personality: ADHD, upbeat, impulsive, very productive in bursts
  // Color: Dark brown
  'farmer-fluff': '/images/emojis/Mascots/harvesthamster.jpg', // Official name from brand bible
  'pip': '/images/emojis/Mascots/harvesthamster.jpg', // Legacy name (deprecated)
  'harvest-hamster': '/images/emojis/Mascots/harvesthamster.jpg', // Legacy name (deprecated)
  
  // Robin Redroute - Packaging & Delivery Specialist
  // Position 5 (right): Red bird's head with small yellow beak, wearing dark blue/black captain's hat with brim, round green goggles over eyes
  // Personality: Hyper, chatty, easily excited
  // Color: Red
  'robin-redroute': '/images/emojis/Mascots/RobinRed-Route.jpg', // Official name from brand bible
  'robin-red-route': '/images/emojis/Mascots/RobinRed-Route.jpg', // Alternative spelling
  'sunny': '/images/emojis/Mascots/RobinRed-Route.jpg', // Legacy name (deprecated)
};

/**
 * Get emoji image path with fallback
 */
export function getEmojiImage(emoji: string): string {
  return getEmojiImagePath(emoji) || getHashBasedEmojiImage(emoji);
}

/**
 * Get mascot face image path
 * Returns the image path for a mascot face identifier
 */
export function getMascotFaceImage(mascotName: string): string | null {
  const normalized = mascotName.toLowerCase().replace(/\s+/g, '-');
  return MASCOT_FACE_EMOJI_MAP[normalized] || null;
}

/**
 * Get mascot face image for a pet category
 * Maps pet types to their corresponding mascot images
 */
export function getMascotFaceForPetType(petType: string): string {
  const typeLower = (petType || '').toLowerCase();
  const typeToMascot: Record<string, string> = {
    'dogs': '/images/emojis/Mascots/Prep Puppy.jpg',
    'cats': '/images/emojis/Mascots/ProfessorPurffesor.jpg',
    'birds': '/images/emojis/Mascots/RobinRed-Route.jpg',
    'reptiles': '/images/emojis/Mascots/SherlockShells.jpg',
    'pocket-pets': '/images/emojis/Mascots/harvesthamster.jpg',
    // Handle singular forms
    'dog': '/images/emojis/Mascots/Prep Puppy.jpg',
    'cat': '/images/emojis/Mascots/ProfessorPurffesor.jpg',
    'bird': '/images/emojis/Mascots/RobinRed-Route.jpg',
    'reptile': '/images/emojis/Mascots/SherlockShells.jpg',
    'pocket-pet': '/images/emojis/Mascots/harvesthamster.jpg',
  };
  return typeToMascot[typeLower] || '/images/emojis/Mascots/Mascot-Emoji-Faces.png';
}

/**
 * Get full profile picture image for a pet type
 * Used for the large profile picture in profile cards (not thumbnails)
 * Maps to full-body character images based on pet type
 */
export function getProfilePictureForPetType(petType: string): string {
  const typeLower = (petType || '').toLowerCase();
  const typeToProfilePic: Record<string, string> = {
    'dogs': '/images/emojis/Mascots/PrepPuppy/PrepPuppy.jpg', // Yellow dog chef with spoon and bowl
    'cats': '/images/emojis/Mascots/Proffessor Purfessor/PUrfessorDesk.jpg', // Black cat with glasses and lab coat at desk
    'birds': '/images/emojis/Mascots/RobinRed-Route.jpg', // Orange bird with goggles and satchel
    'reptiles': '/images/emojis/Mascots/Sherlock Shells/SherlockShells.jpg', // Green turtle detective with monocle
    'pocket-pets': '/images/emojis/Mascots/Harvest Hamster/HHCarrot.jpg', // Brown beaver/hamster with carrot
    // Handle singular forms
    'dog': '/images/emojis/Mascots/PrepPuppy/PrepPuppy.jpg',
    'cat': '/images/emojis/Mascots/Proffessor Purfessor/PUrfessorDesk.jpg',
    'bird': '/images/emojis/Mascots/RobinRed-Route.jpg',
    'reptile': '/images/emojis/Mascots/Sherlock Shells/SherlockShells.jpg',
    'pocket-pet': '/images/emojis/Mascots/Harvest Hamster/HHCarrot.jpg',
  };
  return typeToProfilePic[typeLower] || '/images/emojis/Mascots/Mascot-Emoji-Faces.png';
}
</file>

<file path="lib/utils/enhancedCompatibilityScoring.ts">
// lib/utils/enhancedCompatibilityScoring.ts
// Enhanced compatibility scoring system with ingredient-level analysis
// and multi-factor evaluation

import type { Recipe } from '@/lib/types';
import { getIngredientComposition, INGREDIENT_COMPOSITIONS } from '@/lib/data/ingredientCompositions';
import { getSpeciesCompatibility, shouldAvoid, shouldLimit, normalizeSpecies } from './ingredientCompatibility';
import { AAFCO_NUTRIENT_PROFILES, validateCriticalNutrients } from '@/lib/data/aafco-standards';
import { getAvianStandards, AVIAN_NUTRITION_STANDARDS } from '@/lib/data/avian-nutrition-standards';
import { getReptileStandards, validateReptileNutrition } from '@/lib/data/reptile-nutrition';
import { getFallbackNutrition } from './nutritionFallbacks';
import { nutritionalGuidelines } from '@/lib/data/nutritional-guidelines';
import {
  getHealthConcernBenefits,
  normalizeHealthConcern,
  isBeneficialIngredient,
  isAvoidIngredient,
  checkMacroAlignment,
} from './healthConcernMatching';
import { calculateIngredientQualityScore } from '@/lib/data/ingredientTiers';
import { matchesSpecies } from './recipeRecommendations';

export interface Pet {
  id: string;
  name: string;
  type: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
  breed: string;
  age: number;
  weight: number;
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very-active';
  healthConcerns: string[];
  dietaryRestrictions: string[];
  allergies?: string[];
  dislikes?: string[];
  savedRecipes?: string[];
  names?: string[];
  weightKg?: number;
}

export interface EnhancedCompatibilityScore {
  overallScore: number; // 0-100
  grade: 'A+' | 'A' | 'B+' | 'B' | 'C+' | 'C' | 'D' | 'F';
  usesFallbackNutrition?: boolean; // True if any ingredient used fallback nutrition
  fallbackIngredients?: string[]; // List of ingredients that used fallback nutrition
  factors: {
    ingredientSafety: FactorScore;
    nutritionalAdequacy: FactorScore;
    healthAlignment: FactorScore;
    lifeStageFit: FactorScore;
    activityFit: FactorScore;
    allergenSafety: FactorScore;
    ingredientQuality: FactorScore;
  };
  detailedBreakdown: {
    ingredientAnalysis: IngredientAnalysis[];
    nutritionalGaps: string[];
    nutritionalStrengths: string[];
    healthBenefits: string[];
    warnings: string[];
    recommendations: string[];
  };
}

interface FactorScore {
  score: number; // 0-100
  weight: number; // 0-1, how much this factor contributes
  reasoning: string;
  issues: string[];
  strengths: string[];
}

interface IngredientAnalysis {
  ingredient: string;
  compatibility: 'excellent' | 'good' | 'caution' | 'avoid';
  speciesCompat: 'ok' | 'avoid' | 'limit' | 'caution' | null;
  healthImpact: 'positive' | 'neutral' | 'negative';
  notes: string[];
}

/**
 * Enhanced compatibility scoring with ingredient-level analysis
 * 
 * This system provides:
 * 1. Deep ingredient-by-ingredient compatibility checking
 * 2. Real nutritional analysis using USDA data
 * 3. Multi-factor weighted scoring
 * 4. Detailed breakdown for transparency
 */
export function calculateEnhancedCompatibility(
  recipe: Recipe,
  pet: Pet
): EnhancedCompatibilityScore {
  // All recipes go through full scoring pipeline - no short-circuits
  const normalizedSpecies = normalizeSpecies(pet.type);
  const factors = {
    ingredientSafety: calculateIngredientSafety(recipe, pet, normalizedSpecies),
    nutritionalAdequacy: calculateNutritionalAdequacy(recipe, pet, normalizedSpecies),
    healthAlignment: calculateHealthAlignment(recipe, pet),
    lifeStageFit: calculateLifeStageFit(recipe, pet),
    activityFit: calculateActivityFit(recipe, pet),
    allergenSafety: calculateAllergenSafety(recipe, pet),
    ingredientQuality: calculateIngredientQuality(recipe),
  };

  // Calculate safety score (gate) - used to prevent unsafe recipes from scoring high
  const safetyScore = calculateSafetyScore(recipe, pet, normalizedSpecies);
  
  // Calculate optimality score (quality) - considers quality, ideal ranges, health alignment
  const optimalityScore = calculateOptimalityScore(recipe, pet, normalizedSpecies, factors);
  
  // Safety gates the overall score: if safety < 60, cap at 30-40
  // This prevents unsafe recipes from scoring high regardless of other factors
  let gatedScore: number;
  if (safetyScore < 60) {
    // Unsafe recipes: cap at 30-40 based on safety level
    // Still allow some differentiation based on optimality, but heavily penalized
    gatedScore = Math.min(40, safetyScore * 0.5 + optimalityScore * 0.1);
  } else {
    // Safe recipes: combine safety and optimality, but safety doesn't dominate
    // Use 70% optimality + 30% safety for safe recipes
    gatedScore = optimalityScore * 0.70 + safetyScore * 0.30;
  }
  
  // Add bonus points for perfect matches (reduced generosity)
  const bonuses = calculateBonuses(recipe, pet);
  
  // Perfect match bonus: adds 2-5 points if recipe meets strict perfect match criteria
  // This is a bonus, not an override - all recipes go through full scoring
  const perfectMatchBonus = isPerfectMatch(recipe, pet) ? 3 : 0; // 3 points for perfect match
  
  // Ingredient quality is a bonus, not a requirement (0-2% bonus, reduced to prevent clustering)
  const qualityBonus = factors.ingredientQuality.score * 0.02;
  
  // Calculate final score with bonuses, capped at 100
  // Use maximum precision before rounding
  const scoreWithBonuses = gatedScore + bonuses + qualityBonus + perfectMatchBonus;
  
  let finalScore = scoreWithBonuses;
  
  // Add small deterministic variation (¬±1-2 points) based on recipe ID to break ties
  // This prevents identical recipes from getting identical scores
  function hashString(str: string): number {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // Convert to 32-bit integer
    }
    return Math.abs(hash);
  }
  const variation = (hashString(recipe.id) % 5) - 2; // -2 to +2 (as specified in plan)
  
  const overallScore = Math.round(Math.max(0, Math.min(100, finalScore + variation)));

  // Calculate grade
  const grade = getGrade(overallScore);

  // Detailed breakdown
  const ingredientAnalysis = analyzeIngredients(recipe, pet, normalizedSpecies);
  const nutritionalAnalysis = analyzeNutrition(recipe, pet, normalizedSpecies);
  
  // Check for fallback nutrition usage
  const nutrition = calculateRecipeNutrition(recipe);
  const usesFallback = nutrition.usesFallbackNutrition || false;
  const fallbackIngs = nutrition.fallbackIngredients || [];
  
  const healthBenefits: string[] = [];
  const warnings: string[] = [];
  const recommendations: string[] = [];
  
  // Add warning if fallback nutrition is used
  if (usesFallback && fallbackIngs.length > 0) {
    warnings.push(`Recipe uses estimated nutrition data for: ${fallbackIngs.join(', ')}. Recipe should be marked as needsReview.`);
  }

  // Collect health benefits
  if (factors.healthAlignment.strengths.length > 0) {
    healthBenefits.push(...factors.healthAlignment.strengths);
  }

  // Collect warnings
  Object.values(factors).forEach(factor => {
    if (factor.issues.length > 0) {
      warnings.push(...factor.issues);
    }
  });

  // Generate recommendations
  if (factors.nutritionalAdequacy.score < 70) {
    recommendations.push('Consider adding supplements to meet nutritional requirements');
  }
  if (factors.healthAlignment.score < 60 && pet.healthConcerns.length > 0) {
    recommendations.push('This recipe may not address your pet\'s specific health concerns');
  }
  if (factors.activityFit.score < 70 && pet.activityLevel === 'very-active') {
    recommendations.push('This recipe may need additional calories for very active pets');
  }
  if (factors.ingredientQuality.score < 50) {
    recommendations.push('Consider recipes with higher-quality, less processed ingredients');
  }

  return {
    overallScore: Math.max(0, Math.min(100, overallScore)),
    grade,
    factors,
    usesFallbackNutrition: usesFallback,
    fallbackIngredients: fallbackIngs,
    detailedBreakdown: {
      ingredientAnalysis,
      nutritionalGaps: nutritionalAnalysis.gaps,
      nutritionalStrengths: nutritionalAnalysis.strengths,
      healthBenefits,
      warnings: [...new Set(warnings)], // Remove duplicates
      recommendations: [...new Set(recommendations)],
    },
  };
}

/**
 * Factor 1: Ingredient Safety (Weight: 0.25)
 * Checks each ingredient for species compatibility
 */
function calculateIngredientSafety(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string
): FactorScore {
  const ingredients = recipe.ingredients || [];
  let safeCount = 0;
  let cautionCount = 0;
  let avoidCount = 0;
  const issues: string[] = [];
  const strengths: string[] = [];

  // Check for banned ingredients
  const bannedIngredients = (pet as any).bannedIngredients || [];
  const bannedLower = bannedIngredients.map((b: string) => b.toLowerCase());

  for (const ing of ingredients) {
    const ingName = typeof ing === 'string' ? ing : ing.name;
    const ingKey = ingName.toLowerCase().replace(/\s+/g, '_');
    const ingNameLower = ingName.toLowerCase();
    
    // Check if ingredient is banned by user
    const isBanned = bannedLower.some((banned: string) => 
      ingNameLower.includes(banned) || banned.includes(ingNameLower) || ingKey.includes(banned.toLowerCase())
    );
    
    if (isBanned) {
      avoidCount++;
      issues.push(`${ingName} is banned for this pet`);
      continue; // Skip other checks for banned ingredients
    }
    
    // Check species compatibility
    const compat = getSpeciesCompatibility(ingKey, normalizedSpecies);
    
    if (compat === 'avoid') {
      avoidCount++;
      issues.push(`${ingName} should be avoided for ${pet.type}s`);
    } else if (compat === 'limit' || compat === 'caution') {
      cautionCount++;
      issues.push(`${ingName} should be used with caution for ${pet.type}s`);
    } else if (compat === 'ok') {
      safeCount++;
    } else {
      // Unknown ingredient - assume safe but note
      safeCount++;
    }
  }

  // Calculate score with gradual, proportional penalties for better granularity
  const totalIngredients = ingredients.length || 1;
  let score = 100;
  
  // Avoid ingredients: -20 per avoid (reduced from -30), scaled by proportion for gradual penalties
  // This allows recipes with many safe ingredients + one avoid to score better than recipes with mostly avoids
  const avoidRatio = avoidCount / totalIngredients;
  const avoidPenalty = avoidCount * 20 * (1 + avoidRatio); // More gradual
  score -= Math.min(avoidPenalty, 60); // Max -60 for avoids (reduced from -70)
  
  // Caution ingredients: -5 per caution (reduced from -10), scaled by proportion
  const cautionRatio = cautionCount / totalIngredients;
  const cautionPenalty = cautionCount * 5 * (1 + cautionRatio); // More gradual
  score -= Math.min(cautionPenalty, 30); // Max -30 for cautions (reduced from -40)
  
  score = Math.max(0, score);

  if (avoidCount > 0) {
    // Cap at 50 if any avoids (increased from 40 to allow more differentiation)
    score = Math.min(score, 50);
  }

  if (safeCount === ingredients.length && ingredients.length > 0) {
    strengths.push('All ingredients are safe for this species');
  }

  return {
    score: Math.max(0, Math.min(100, score)),
    weight: 0.25, // Weight already correct
    reasoning: avoidCount > 0
      ? `${avoidCount} ingredient(s) should be avoided`
      : cautionCount > 0
      ? `${cautionCount} ingredient(s) need caution`
      : 'All ingredients are species-appropriate',
    issues,
    strengths,
  };
}

/**
 * Calculate continuous score for a nutrient based on distance from ideal range
 * Returns score from 0-100, where 100 = at ideal midpoint, lower = further from ideal
 */
function calculateNutrientScore(
  actual: number,
  min: number,
  max: number
): { score: number; bonus: number } {
  if (max <= min) return { score: 50, bonus: 0 }; // Invalid range
  
  const ideal = (min + max) / 2;
  const range = max - min;
  
  // Calculate distance from ideal (normalized to 0-1)
  const distance = Math.abs(actual - ideal) / range;
  
  // Score: 100 at ideal, decreases linearly with distance
  // Cap at 0 for values way outside range
  let score = Math.max(0, 100 - (distance * 100));
  
  // Bonus for exceeding minimums (up to +8 points, reduced from +15)
  let bonus = 0;
  if (min > 0 && actual > min) {
    const excessPercent = ((actual - min) / min) * 100;
    // +2 points per 5% over minimum, capped at +8 (reduced to prevent over-scoring)
    bonus = Math.min(8, Math.floor(excessPercent / 5) * 2);
  }
  
  return { score, bonus };
}

/**
 * Calculate ingredient diversity bonus (Phase 2.3)
 * Rewards recipes with varied ingredient categories
 */
function calculateIngredientDiversity(recipe: Recipe): number {
  const ingredients = (recipe.ingredients || []).map(ing => {
    const name = typeof ing === 'string' ? ing : ing.name;
    return name.toLowerCase();
  });
  
  if (ingredients.length === 0) return 0;
  
  // Categorize ingredients
  const categories = new Set<string>();
  ingredients.forEach(ing => {
    if (ing.includes('chicken') || ing.includes('turkey') || ing.includes('beef') || 
        ing.includes('fish') || ing.includes('salmon') || ing.includes('lamb') ||
        ing.includes('pork') || ing.includes('duck') || ing.includes('egg')) {
      categories.add('protein');
    } else if (ing.includes('rice') || ing.includes('quinoa') || ing.includes('oats') ||
               ing.includes('barley') || ing.includes('wheat') || ing.includes('corn')) {
      categories.add('grain');
    } else if (ing.includes('carrot') || ing.includes('broccoli') || ing.includes('spinach') ||
               ing.includes('kale') || ing.includes('peas') || ing.includes('green-bean') ||
               ing.includes('sweet-potato') || ing.includes('pumpkin')) {
      categories.add('vegetable');
    } else if (ing.includes('apple') || ing.includes('blueberry') || ing.includes('banana') ||
               ing.includes('cranberry')) {
      categories.add('fruit');
    } else if (ing.includes('oil') || ing.includes('fat')) {
      categories.add('fat');
    } else if (ing.includes('supplement') || ing.includes('vitamin') || ing.includes('mineral')) {
      categories.add('supplement');
    }
  });
  
  // Bonus: +1 point per unique category (max +10)
  const diversityBonus = Math.min(10, categories.size);
  
  return diversityBonus;
}

/**
 * Factor 2: Nutritional Adequacy (Weight: 0.30)
 * Continuous scoring based on distance from ideal nutritional ranges
 */
function calculateNutritionalAdequacy(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];
  
  // Calculate recipe nutrition from ingredients
  const nutrition = calculateRecipeNutrition(recipe);
  
  // Get pet's age group for nutritional guidelines
  let ageGroup: 'puppy' | 'adult' | 'senior' = 'adult';
  if (normalizedSpecies === 'dog' || normalizedSpecies === 'cat') {
    if (pet.age < 1) ageGroup = 'puppy';
    else if (pet.age >= 7) ageGroup = 'senior';
  }
  
  // Map normalized species to PetCategory
  const speciesMap: Record<string, keyof typeof nutritionalGuidelines> = {
    'dog': 'dogs',
    'cat': 'cats',
    'bird': 'birds',
    'reptile': 'reptiles',
    'pocket-pet': 'pocket-pets',
  };
  
  const petCategory = speciesMap[normalizedSpecies];
  let requirements = petCategory ? nutritionalGuidelines[petCategory]?.[ageGroup] : null;
  
  // Fallback to adult if specific age group not available
  if (!requirements && petCategory) {
    requirements = nutritionalGuidelines[petCategory]?.adult;
  }
  
  // Initialize nutrient scores
  const nutrientScores: { name: string; score: number; bonus: number }[] = [];
  let totalScore = 0;
  let totalWeight = 0;
  
  if (requirements) {
    // Protein scoring (weight: 0.30)
    if (requirements.protein) {
      const { score, bonus } = calculateNutrientScore(
        nutrition.protein,
        requirements.protein.min,
        requirements.protein.max
      );
      nutrientScores.push({ name: 'protein', score, bonus });
      totalScore += score * 0.30;
      totalWeight += 0.30;
      
      if (nutrition.protein < requirements.protein.min) {
        issues.push(`Protein (${nutrition.protein.toFixed(1)}%) below minimum (${requirements.protein.min}%)`);
      } else if (nutrition.protein > requirements.protein.max) {
        issues.push(`Protein (${nutrition.protein.toFixed(1)}%) above maximum (${requirements.protein.max}%)`);
      } else {
        strengths.push(`Protein (${nutrition.protein.toFixed(1)}%) within ideal range`);
      }
    }
    
    // Fat scoring (weight: 0.25)
    if (requirements.fat) {
      const { score, bonus } = calculateNutrientScore(
        nutrition.fat,
        requirements.fat.min,
        requirements.fat.max
      );
      nutrientScores.push({ name: 'fat', score, bonus });
      totalScore += score * 0.25;
      totalWeight += 0.25;
      
      if (nutrition.fat < requirements.fat.min) {
        issues.push(`Fat (${nutrition.fat.toFixed(1)}%) below minimum (${requirements.fat.min}%)`);
      } else if (nutrition.fat > requirements.fat.max) {
        issues.push(`Fat (${nutrition.fat.toFixed(1)}%) above maximum (${requirements.fat.max}%)`);
      }
    }
    
    // Fiber scoring (weight: 0.15)
    if (requirements.fiber) {
      const { score, bonus } = calculateNutrientScore(
        nutrition.fiber,
        requirements.fiber.min,
        requirements.fiber.max
      );
      nutrientScores.push({ name: 'fiber', score, bonus });
      totalScore += score * 0.15;
      totalWeight += 0.15;
    }
    
    // Calcium scoring (weight: 0.15)
    if (requirements.calcium) {
      const { score, bonus } = calculateNutrientScore(
        nutrition.calcium,
        requirements.calcium.min,
        requirements.calcium.max
      );
      nutrientScores.push({ name: 'calcium', score, bonus });
      totalScore += score * 0.15;
      totalWeight += 0.15;
    }
    
    // Phosphorus scoring (weight: 0.15)
    if (requirements.phosphorus) {
      const { score, bonus } = calculateNutrientScore(
        nutrition.phosphorus,
        requirements.phosphorus.min,
        requirements.phosphorus.max
      );
      nutrientScores.push({ name: 'phosphorus', score, bonus });
      totalScore += score * 0.15;
      totalWeight += 0.15;
    }
    
    // Ca:P ratio precision scoring (Phase 2.2)
    if (nutrition.calcium && nutrition.phosphorus && requirements.calcium && requirements.phosphorus) {
      const caPRatio = nutrition.calcium / nutrition.phosphorus;
      // Ideal Ca:P ratio varies by species, but generally 1.2:1 to 2:1
      const idealCaP = petCategory === 'dogs' || petCategory === 'cats' ? 1.5 : 1.8;
      const minCaP = 1.2;
      const maxCaP = 2.0;
      
      if (caPRatio >= minCaP && caPRatio <= maxCaP) {
        // Calculate distance from ideal
        const distance = Math.abs(caPRatio - idealCaP) / (maxCaP - minCaP);
        const ratioScore = 100 - (distance * 50); // Max penalty -50
        totalScore += ratioScore * 0.10; // 10% weight for ratio
        totalWeight += 0.10;
        
        if (distance < 0.1) {
          strengths.push(`Optimal Ca:P ratio (${caPRatio.toFixed(2)})`);
        } else if (distance < 0.3) {
          strengths.push(`Good Ca:P ratio (${caPRatio.toFixed(2)})`);
        } else {
          issues.push(`Ca:P ratio (${caPRatio.toFixed(2)}) could be closer to ideal (${idealCaP})`);
        }
      } else {
        // Outside ideal range - elastic thresholds with diminishing returns
        const safeMin = 0.8; // Animals tolerate broader ranges
        const safeMax = 3.0;
        
        if (caPRatio >= safeMin && caPRatio < minCaP) {
          // Slightly low - small penalty
          const deviation = minCaP - caPRatio;
          const penalty = Math.min(deviation * 5, 10); // Reduced penalty
          totalScore -= penalty * 0.10;
          totalWeight += 0.10;
          issues.push(`Ca:P ratio (${caPRatio.toFixed(2)}) slightly below ideal range`);
        } else if (caPRatio > maxCaP && caPRatio <= safeMax) {
          // Slightly high - small penalty
          const deviation = caPRatio - maxCaP;
          const penalty = Math.min(deviation * 5, 10); // Reduced penalty
          totalScore -= penalty * 0.10;
          totalWeight += 0.10;
          issues.push(`Ca:P ratio (${caPRatio.toFixed(2)}) slightly above ideal range`);
        } else {
          // Outside safe range - larger penalty
          const penalty = caPRatio < safeMin ? (safeMin - caPRatio) * 20 : (caPRatio - safeMax) * 20;
          totalScore -= Math.min(penalty, 50) * 0.10;
          totalWeight += 0.10;
          issues.push(`Ca:P ratio (${caPRatio.toFixed(2)}) outside safe range (${safeMin}-${safeMax})`);
        }
      }
    }
  }
  
  // Calculate weighted average score
  let finalScore = totalWeight > 0 ? totalScore / totalWeight : 50;
  
  // Add bonuses for exceeding minimums (average across nutrients)
  const avgBonus = nutrientScores.length > 0
    ? nutrientScores.reduce((sum, n) => sum + n.bonus, 0) / nutrientScores.length
    : 0;
  finalScore += avgBonus;
  
  // Add ingredient diversity bonus (Phase 2.3)
  const diversityBonus = calculateIngredientDiversity(recipe);
  finalScore += diversityBonus;
  
  // Safety validation check (still important for critical failures)
  if (normalizedSpecies === 'dog' || normalizedSpecies === 'cat') {
    const lifeStage = pet.age < 1 ? 'growth' : 'adult';
    const validation = validateCriticalNutrients(
      recipe,
      normalizedSpecies as 'dog' | 'cat',
      lifeStage
    );
    
    if (!validation.isValid) {
      // Critical violations reduce score gradually using distance-based penalty
      // Penalty = violations^2 * scalingFactor for better granularity
      const violationPenalty = Math.min(30, validation.violations.length * validation.violations.length * 2);
      finalScore -= violationPenalty;
      validation.violations.forEach(v => {
        issues.push(`Critical nutritional gap: ${v}`);
      });
    }
  } else if (normalizedSpecies === 'bird') {
    const standards = getAvianStandards(pet.breed) || AVIAN_NUTRITION_STANDARDS.psittacines;
    if (nutrition.protein < (standards.protein?.min || 12)) {
      // Gradual penalty based on how far below minimum
      const deviation = (standards.protein?.min || 12) - nutrition.protein;
      const penalty = Math.min(20, deviation * deviation * 2); // Quadratic penalty
      finalScore -= penalty;
      issues.push('Protein critically low for birds');
    }
  } else if (normalizedSpecies === 'reptile') {
    const standards = getReptileStandards(pet.breed);
    if (standards) {
      const validation = validateReptileNutrition(recipe, pet.breed || 'unknown');
      if (!validation.isValid) {
        finalScore -= validation.violations.length * 5; // Reduced from -10 to -5
        validation.violations.forEach(v => {
          issues.push(`Reptile nutrition gap: ${v}`);
        });
      }
    }
  } else if (normalizedSpecies === 'pocket-pet') {
    const breed = (pet.breed || '').toLowerCase();
    const isLowFiber = ['sugar', 'glider', 'hamster', 'rat', 'mouse', 'ferret'].some(b => breed.includes(b));
    const isHayEater = ['rabbit', 'guinea', 'chinchilla'].some(b => breed.includes(b));
    
    if (isLowFiber && nutrition.protein < 12) {
      // Gradual penalty based on deviation
      const deviation = 12 - nutrition.protein;
      const penalty = Math.min(20, deviation * deviation * 2);
      finalScore -= penalty;
      issues.push('Protein critically low for this pocket-pet type');
    }
    if (isHayEater && nutrition.fiber < 15) {
      // Gradual penalty based on deviation
      const deviation = 15 - nutrition.fiber;
      const penalty = Math.min(20, deviation * deviation * 2);
      finalScore -= penalty;
      issues.push('Fiber critically low for hay-eating pocket-pets');
    }
    if (breed.includes('ferret') && nutrition.protein < 30) {
      // Gradual penalty based on deviation
      const deviation = 30 - nutrition.protein;
      const penalty = Math.min(25, deviation * deviation * 1.5);
      finalScore -= penalty;
      issues.push('Ferrets require high protein (30%+) as obligate carnivores');
    }
  }
  
  // Add missing data penalty - FIXED: Only penalize for pets with health concerns requiring precise nutrition
  // Use gradual penalty: (100 - coverage) / 10 instead of binary thresholds
  if (nutrition.usesFallbackNutrition && nutrition.fallbackIngredients && pet.healthConcerns.length > 0) {
    const totalIngredients = (recipe.ingredients || []).length;
    const missingPercentage = totalIngredients > 0 
      ? nutrition.fallbackIngredients.length / totalIngredients 
      : 0;
    const coverage = (1 - missingPercentage) * 100;
    const penalty = Math.min(15, (100 - coverage) / 10); // Gradual: -1 per 10% missing
    finalScore -= penalty;
    
    if (penalty > 0) {
      issues.push(`Uses estimated nutrition data for ${nutrition.fallbackIngredients.length} ingredient(s) (${Math.round(missingPercentage * 100)}%)`);
    }
  }
  // For perfect pets, fallback data is acceptable and doesn't penalize
  
  // Add strength messages for good scores
  if (finalScore >= 85) {
    strengths.push('Excellent nutritional profile');
  } else if (finalScore >= 75) {
    strengths.push('Good nutritional profile');
  } else if (finalScore >= 65) {
    strengths.push('Adequate nutritional profile');
  }

  return {
    score: Math.max(0, Math.min(100, Math.round(finalScore))),
    weight: 0.35, // Updated weight to match new distribution
    reasoning: issues.length === 0
      ? `Nutritional score: ${Math.round(finalScore)}% (${strengths[0] || 'within acceptable ranges'})`
      : `${issues.length} nutritional concern(s) identified`,
    issues,
    strengths,
  };
}

/**
 * Factor 3: Health Alignment (Weight: 0.20)
 * Tiered scoring based on precision of health concern matching
 */
function calculateHealthAlignment(
  recipe: Recipe,
  pet: Pet
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];

  if (pet.healthConcerns.length === 0) {
    return {
      score: 100,
      weight: 0.15, // Updated weight to match new distribution
      reasoning: 'No specific health concerns to evaluate',
      issues: [],
      strengths: ['Recipe suitable for healthy pets'],
    };
  }

  // Calculate recipe nutrition for macro alignment checks
  const nutrition = calculateRecipeNutrition(recipe);
  
  // Get recipe ingredients
  const recipeIngredients = (recipe.ingredients || []).map(ing => {
    const name = typeof ing === 'string' ? ing : ing.name;
    return name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  });
  
  const recipeConcerns = (recipe.healthConcerns || []).map(c => normalizeHealthConcern(c));
  const recipeNotSuitable = (recipe.notSuitableFor || []).map(c => normalizeHealthConcern(c));
  
  const petConcerns = pet.healthConcerns.map(c => normalizeHealthConcern(c));
  
  // Calculate tiered scores for each concern
  const concernScores: number[] = [];
  const concernWeights: number[] = [];
  
  for (let i = 0; i < petConcerns.length; i++) {
    const concern = petConcerns[i];
    const concernData = getHealthConcernBenefits(concern);
    
    // Weight: Primary concern (first) gets full weight, others get 0.7x
    const weight = i === 0 ? 1.0 : 0.7;
    
    // Check if recipe explicitly says it's not suitable
    const notSuitable = recipeNotSuitable.some(ns => 
      ns.includes(concern) || concern.includes(ns)
    );
    
    if (notSuitable) {
      // Tier 5: Negative match - contains problematic elements
      concernScores.push(20);
      concernWeights.push(weight);
      issues.push(`Recipe is not suitable for ${concern.replace(/-/g, ' ')}`);
      continue;
    }
    
    // Check if recipe explicitly targets this concern
    const explicitlyTargets = recipeConcerns.some(rc => 
      rc.includes(concern) || concern.includes(rc)
    );
    
    if (concernData) {
      // Check for beneficial ingredients
      const beneficialCount = recipeIngredients.filter(ing => 
        isBeneficialIngredient(ing, concernData.beneficialIngredients)
      ).length;
      
      // Check for avoid ingredients
      const avoidCount = recipeIngredients.filter(ing => 
        isAvoidIngredient(ing, concernData.avoidIngredients, pet.allergies)
      ).length;
      
      // Check macro alignment
      const macroAlignment = checkMacroAlignment(nutrition, concernData.targetMacros);
      
      // Tier 1: Perfect match - explicitly targets + has beneficial + avoids problematic + good macros
      if (explicitlyTargets && beneficialCount > 0 && avoidCount === 0 && macroAlignment >= 25) {
        concernScores.push(100);
        concernWeights.push(weight);
        strengths.push(`Perfect match for ${concern.replace(/-/g, ' ')}: targets concern with beneficial ingredients`);
      }
      // Tier 2: Strong match - explicitly targets + has some beneficial ingredients
      else if (explicitlyTargets && beneficialCount > 0) {
        const tier2Score = 70 + Math.min(beneficialCount * 5, 15) + (avoidCount === 0 ? 10 : -avoidCount * 5);
        concernScores.push(Math.min(100, tier2Score));
        concernWeights.push(weight);
        strengths.push(`Strong match for ${concern.replace(/-/g, ' ')}: targets concern with ${beneficialCount} beneficial ingredient(s)`);
      }
      // Tier 3: Supportive match - has beneficial ingredients but doesn't explicitly target
      else if (beneficialCount > 0 && avoidCount === 0) {
        const tier3Score = 50 + Math.min(beneficialCount * 5, 20) + (macroAlignment >= 25 ? 10 : 0);
        concernScores.push(Math.min(100, tier3Score));
        concernWeights.push(weight);
        strengths.push(`Supportive for ${concern.replace(/-/g, ' ')}: contains ${beneficialCount} beneficial ingredient(s)`);
      }
      // Tier 4: Neutral - no alignment but no conflicts
      else if (avoidCount === 0) {
        concernScores.push(50);
        concernWeights.push(weight);
      }
      // Tier 5: Negative - contains problematic ingredients
      else {
        const tier5Score = Math.max(0, 30 - (avoidCount * 10));
        concernScores.push(tier5Score);
        concernWeights.push(weight);
        issues.push(`Contains ${avoidCount} problematic ingredient(s) for ${concern.replace(/-/g, ' ')}`);
      }
    } else {
      // No specific data for this concern - use basic tag matching
      if (explicitlyTargets) {
        concernScores.push(85);
        concernWeights.push(weight);
        strengths.push(`Recipe targets ${concern.replace(/-/g, ' ')}`);
      } else {
        concernScores.push(50);
        concernWeights.push(weight);
      }
    }
  }
  
  // Calculate weighted average across all concerns
  let totalScore = 0;
  let totalWeight = 0;
  for (let i = 0; i < concernScores.length; i++) {
    totalScore += concernScores[i] * concernWeights[i];
    totalWeight += concernWeights[i];
  }
  
  const finalScore = totalWeight > 0 ? totalScore / totalWeight : 50;

  return {
    score: Math.max(0, Math.min(100, Math.round(finalScore))),
    weight: 0.15, // Updated weight to match new distribution
    reasoning: concernScores.length > 0
      ? `Health alignment: ${Math.round(finalScore)}% (${strengths.length > 0 ? strengths[0] : 'neutral'})`
      : 'Neutral health alignment',
    issues,
    strengths,
  };
}

/**
 * Factor 4: Life Stage Fit (Weight: 0.10)
 * Checks if recipe is appropriate for pet's age
 */
function calculateLifeStageFit(
  recipe: Recipe,
  pet: Pet
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];
  
  const petAgeGroup = pet.age < 1 ? 'baby' : pet.age < 2 ? 'young' : pet.age < 7 ? 'adult' : 'senior';
  const recipeAgeGroups = recipe.ageGroup || [];
  
  const isMatch = recipeAgeGroups.includes(petAgeGroup) || 
                  recipeAgeGroups.includes('all') ||
                  recipeAgeGroups.length === 0;

  if (isMatch) {
    strengths.push(`Appropriate for ${petAgeGroup} pets`);
  } else {
    issues.push(`Recipe designed for ${recipeAgeGroups.join(', ')}, but pet is ${petAgeGroup}`);
  }

  return {
    score: isMatch ? 100 : 60,
    weight: 0.10, // Weight already correct
    reasoning: isMatch
      ? `Recipe is appropriate for ${petAgeGroup} pets`
      : `Age group mismatch`,
    issues,
    strengths,
  };
}

/**
 * Factor 5: Activity Fit (Weight: 0.05)
 * Checks if calorie content matches activity level
 */
function calculateActivityFit(
  recipe: Recipe,
  pet: Pet
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];
  
  if (!pet.activityLevel) {
    return {
      score: 100,
      weight: 0.05,
      reasoning: 'Activity level not specified',
      issues: [],
      strengths: [],
    };
  }

  const nutrition = calculateRecipeNutrition(recipe);
  const calories = nutrition.calories || 150; // Default estimate

  // Rough calorie needs by activity (kcal per kg body weight per day)
  const activityMultipliers = {
    'sedentary': 80,
    'moderate': 100,
    'active': 120,
    'very-active': 150,
  };

  const estimatedNeeds = (activityMultipliers[pet.activityLevel] || 100) * pet.weight;
  const recipeCalories = calories * (pet.weight / 10); // Rough estimate for portion

  if (pet.activityLevel === 'very-active' && recipeCalories < estimatedNeeds * 0.8) {
    issues.push('Recipe may be too low in calories for very active pets');
  } else if (pet.activityLevel === 'sedentary' && recipeCalories > estimatedNeeds * 1.2) {
    issues.push('Recipe may be too high in calories for sedentary pets');
  } else {
    strengths.push(`Calorie content appropriate for ${pet.activityLevel} activity level`);
  }

  return {
    score: issues.length > 0 ? 70 : 100,
    weight: 0.05,
    reasoning: issues.length > 0
      ? 'Calorie content may not match activity level'
      : 'Calorie content matches activity level',
    issues,
    strengths,
  };
}

/**
 * Factor 6.5: Ingredient Quality (Weight: 0.10)
 * Scores based on ingredient sophistication and quality
 */
function calculateIngredientQuality(
  recipe: Recipe
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];
  
  const ingredients = (recipe.ingredients || []).map(ing => 
    typeof ing === 'string' ? { name: ing } : ing
  );
  
  const qualityResult = calculateIngredientQualityScore(ingredients);
  
  if (qualityResult.premiumCount > 0) {
    strengths.push(`${qualityResult.premiumCount} premium ingredient(s)`);
  }
  
  if (qualityResult.basicCount > 0) {
    issues.push(`${qualityResult.basicCount} processed/basic ingredient(s)`);
  }
  
  if (qualityResult.freshRatio > 0.5) {
    strengths.push('High proportion of fresh ingredients');
  }
  
  return {
    score: qualityResult.score,
    weight: 0.00, // FIXED: Quality is now a bonus, not part of base weight
    reasoning: qualityResult.score >= 70
      ? `High-quality ingredients (${qualityResult.premiumCount} premium)`
      : qualityResult.score >= 50
      ? 'Standard ingredient quality'
      : 'Contains processed/basic ingredients',
    issues,
    strengths,
  };
}

/**
 * Factor 6: Allergen Safety (Weight: 0.10)
 * Critical safety check for allergies
 */
function calculateAllergenSafety(
  recipe: Recipe,
  pet: Pet
): FactorScore {
  const issues: string[] = [];
  const strengths: string[] = [];
  
  const allAllergens = [
    ...(pet.allergies || []),
    ...pet.dietaryRestrictions.filter(r => 
      ['chicken', 'beef', 'dairy', 'wheat', 'egg', 'fish', 'pork'].some(a => 
        r.toLowerCase().includes(a)
      )
    ),
  ];

  if (allAllergens.length === 0) {
    return {
      score: 100,
      weight: 0.10,
      reasoning: 'No known allergies or restrictions',
      issues: [],
      strengths: ['No allergen concerns'],
    };
  }

  const ingredients = (recipe.ingredients || []).map(i => 
    (typeof i === 'string' ? i : i.name).toLowerCase()
  ).join(' ');

  let hasAllergen = false;
  for (const allergen of allAllergens) {
    if (ingredients.includes(allergen.toLowerCase())) {
      hasAllergen = true;
      issues.push(`Contains ${allergen} - AVOID`);
    }
  }

  if (!hasAllergen) {
    strengths.push('Recipe avoids all known allergens');
  }

  return {
    score: hasAllergen ? 0 : 100, // Zero if allergen present
    weight: 0.10, // Weight already correct
    reasoning: hasAllergen
      ? 'Contains known allergens - NOT SAFE'
      : 'No allergens detected',
    issues,
    strengths,
  };
}

/**
 * Calculate safety score (0-100) - only considers hard safety requirements
 * This is used as a gate to prevent unsafe recipes from scoring high
 */
function calculateSafetyScore(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string
): number {
  const ingredients = recipe.ingredients || [];
  let hasAvoid = false;
  let hasAllergen = false;
  
  // Check for banned ingredients
  const bannedIngredients = (pet as any).bannedIngredients || [];
  const bannedLower = bannedIngredients.map((b: string) => b.toLowerCase());
  
  for (const ing of ingredients) {
    const ingName = typeof ing === 'string' ? ing : ing.name;
    const ingKey = ingName.toLowerCase().replace(/\s+/g, '_');
    const ingNameLower = ingName.toLowerCase();
    
    // Check if ingredient is banned
    const isBanned = bannedLower.some((banned: string) => 
      ingNameLower.includes(banned) || banned.includes(ingNameLower) || ingKey.includes(banned.toLowerCase())
    );
    
    if (isBanned) {
      hasAvoid = true;
      continue;
    }
    
    // Check species compatibility
    const compat = getSpeciesCompatibility(ingKey, normalizedSpecies);
    if (compat === 'avoid') {
      hasAvoid = true;
    }
  }
  
  // Check for allergens
  const allergies = pet.allergies || [];
  const dietaryRestrictions = pet.dietaryRestrictions || [];
  const allAllergens = [...allergies, ...dietaryRestrictions];
  
  if (allAllergens.length > 0) {
    const recipeIngNames = ingredients.map(ing => 
      (typeof ing === 'string' ? ing : ing.name).toLowerCase()
    ).join(' ');
    
    hasAllergen = allAllergens.some(a => 
      recipeIngNames.includes(a.toLowerCase())
    );
  }
  
  // Safety score: 0 if unsafe, 100 if completely safe
  if (hasAvoid || hasAllergen) {
    return 0; // Unsafe - will gate overall score
  }
  
  // Check hard nutritional minimums (meets core species standards)
  const nutrition = calculateRecipeNutrition(recipe);
  const petCategory = normalizedSpecies === 'dog' ? 'dogs' : 
                      normalizedSpecies === 'cat' ? 'cats' :
                      normalizedSpecies === 'bird' ? 'birds' :
                      normalizedSpecies === 'reptile' ? 'reptiles' : 'pocket-pets';
  const ageGroup = pet.age < 1 ? 'puppy' : pet.age >= 7 ? 'senior' : 'adult';
  const requirements = nutritionalGuidelines[petCategory]?.[ageGroup] || nutritionalGuidelines[petCategory]?.adult;
  
  if (requirements) {
    // Check critical minimums
    if (requirements.protein && nutrition.protein < requirements.protein.min * 0.8) {
      return 30; // Critically low protein
    }
    if (requirements.fat && nutrition.fat < requirements.fat.min * 0.8) {
      return 40; // Critically low fat
    }
  }
  
  // All safety checks passed
  return 100;
}

/**
 * Calculate optimality score (0-100) - considers quality, ideal ranges, health alignment
 * This is the "how good is it" score, separate from safety
 */
function calculateOptimalityScore(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string,
  factors: {
    ingredientSafety: FactorScore;
    nutritionalAdequacy: FactorScore;
    healthAlignment: FactorScore;
    lifeStageFit: FactorScore;
    activityFit: FactorScore;
    allergenSafety: FactorScore;
    ingredientQuality: FactorScore;
  }
): number {
  // Optimality weights (different from safety)
  const optimalityWeights = {
    nutritionalAdequacy: 0.40, // How close to ideal nutrient bands
    healthAlignment: 0.20, // Health concern matching
    lifeStageFit: 0.15, // Age appropriateness
    activityFit: 0.10, // Activity level matching
    ingredientQuality: 0.15, // Quality of ingredients
  };
  
  // Calculate weighted optimality score
  const optimalityScore = 
    factors.nutritionalAdequacy.score * optimalityWeights.nutritionalAdequacy +
    factors.healthAlignment.score * optimalityWeights.healthAlignment +
    factors.lifeStageFit.score * optimalityWeights.lifeStageFit +
    factors.activityFit.score * optimalityWeights.activityFit +
    factors.ingredientQuality.score * optimalityWeights.ingredientQuality;
  
  return Math.max(0, Math.min(100, optimalityScore));
}

/**
 * Analyze each ingredient individually
 */
function analyzeIngredients(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string
): IngredientAnalysis[] {
  const ingredients = recipe.ingredients || [];
  const analysis: IngredientAnalysis[] = [];

  for (const ing of ingredients) {
    const ingName = typeof ing === 'string' ? ing : ing.name;
    const ingKey = ingName.toLowerCase().replace(/\s+/g, '_');
    
    const compat = getSpeciesCompatibility(ingKey, normalizedSpecies);
    const composition = getIngredientComposition(ingKey);
    
    let compatibility: 'excellent' | 'good' | 'caution' | 'avoid';
    let healthImpact: 'positive' | 'neutral' | 'negative' = 'neutral';
    const notes: string[] = [];

    if (compat === 'avoid') {
      compatibility = 'avoid';
      healthImpact = 'negative';
      notes.push('Should be avoided for this species');
    } else if (compat === 'limit' || compat === 'caution') {
      compatibility = 'caution';
      notes.push('Use with caution');
    } else if (compat === 'ok') {
      compatibility = 'good';
    } else {
      compatibility = 'good'; // Unknown, assume safe
    }

    // Check health concerns
    const recipeConcerns = (recipe.healthConcerns || []).map(c => c.toLowerCase());
    const petConcerns = pet.healthConcerns.map(c => c.toLowerCase());
    
    // Check if ingredient benefits health concerns
    if (composition) {
      if (composition.omega3 && petConcerns.some(c => c.includes('joint') || c.includes('skin'))) {
        healthImpact = 'positive';
        notes.push('Rich in omega-3, beneficial for joint/skin health');
      }
      if (composition.taurine && pet.type === 'cat') {
        healthImpact = 'positive';
        notes.push('Contains taurine, essential for cats');
      }
    }

    analysis.push({
      ingredient: ingName,
      compatibility,
      speciesCompat: compat,
      healthImpact,
      notes,
    });
  }

  return analysis;
}

/**
 * Analyze nutritional profile
 */
function analyzeNutrition(
  recipe: Recipe,
  pet: Pet,
  normalizedSpecies: string
): { gaps: string[]; strengths: string[] } {
  const gaps: string[] = [];
  const strengths: string[] = [];
  
  const nutrition = calculateRecipeNutrition(recipe);
  
  if (normalizedSpecies === 'dog' || normalizedSpecies === 'cat') {
    if (nutrition.protein < 18) {
      gaps.push('Protein content may be below optimal');
    } else {
      strengths.push('Adequate protein content');
    }
    
    if (nutrition.calcium && nutrition.phosphorus) {
      const caPRatio = nutrition.calcium / nutrition.phosphorus;
      if (caPRatio < 1.0 || caPRatio > 2.0) {
        gaps.push(`Ca:P ratio (${caPRatio.toFixed(2)}) outside ideal range`);
      } else {
        strengths.push('Ideal Ca:P ratio');
      }
    }
  }

  if (nutrition.source === 'real') {
    strengths.push('Nutritional data based on USDA values');
  }

  return { gaps, strengths };
}

/**
 * Calculate recipe nutrition from ingredients
 * Returns nutrition values as percentages (dry matter basis)
 */
export function calculateRecipeNutrition(recipe: Recipe): {
  protein: number;
  fat: number;
  fiber: number;
  calcium: number;
  phosphorus: number;
  calories: number;
  source: 'real' | 'estimated';
  usesFallbackNutrition?: boolean;
  fallbackIngredients?: string[];
} {
  // Check if recipe has pre-calculated nutritional data (from custom meal analysis)
  const nutritionalCalc = (recipe as any).nutritionalCalculation;
  if (nutritionalCalc) {
    const totalGrams = nutritionalCalc.totalGrams || 100;
    // Convert from grams to percentages
    return {
      protein: totalGrams > 0 ? ((nutritionalCalc.protein_g || 0) / totalGrams) * 100 : 0,
      fat: totalGrams > 0 ? ((nutritionalCalc.fat_g || 0) / totalGrams) * 100 : 0,
      fiber: totalGrams > 0 ? ((nutritionalCalc.fiber_g || 0) / totalGrams) * 100 : 0,
      calcium: totalGrams > 0 ? ((nutritionalCalc.ca_mg || 0) / totalGrams) * 100 : 0,
      phosphorus: totalGrams > 0 ? ((nutritionalCalc.p_mg || 0) / totalGrams) * 100 : 0,
      calories: totalGrams > 0 ? ((nutritionalCalc.calories_kcal || nutritionalCalc.kcal || 0) / totalGrams) * 100 : 0,
      source: 'real',
    };
  }

  const ingredients = recipe.ingredients || [];
  const supplements = (recipe as any).supplements || [];
  
  let totalProtein = 0;
  let totalFat = 0;
  let totalFiber = 0;
  let totalCalcium = 0;
  let totalPhosphorus = 0;
  let totalCalories = 0;
  let totalWeight = 0;
  let realDataCount = 0;
  const fallbackIngredients: string[] = [];

  // Helper function to map supplement names to ingredient composition keys
  const mapSupplementToCompositionKey = (supplementName: string): string | null => {
    const lower = supplementName.toLowerCase();
    // Map common supplement names to ingredient composition keys
    if (lower.includes('taurine')) return 'taurine_powder';
    if (lower.includes('calcium') && (lower.includes('carbonate') || lower.includes('supplement'))) return 'calcium_carbonate';
    if (lower.includes('omega') || lower.includes('fish oil') || lower.includes('krill') || lower.includes('salmon oil')) return 'fish_oil';
    // Note: psyllium, probiotics, vitamins don't have composition data yet
    // They can still be added but won't contribute to macro calculations
    return null;
  };

  // Process ingredients
  for (const ingredient of ingredients) {
    const name = typeof ingredient === 'string' ? ingredient : ingredient.name;
    const amount = typeof ingredient === 'string' ? 100 : (ingredient.amount ? parseFloat(String(ingredient.amount).replace(/[^0-9.]/g, '')) : 100);

    const ingKey = name.toLowerCase().replace(/\s+/g, '_');
    const composition = getIngredientComposition(ingKey);
    
    if (composition && composition.protein !== undefined) {
      // Check if composition uses fallback (has needsReview and source is estimated_fallback)
      const usesFallback = (composition as any).needsReview === true && 
                          (composition.source === 'estimated_fallback' || composition.source?.includes('fallback'));
      
      if (usesFallback) {
        fallbackIngredients.push(name);
      }
      
      totalProtein += (composition.protein || 0) * (amount / 100);
      totalFat += (composition.fat || 0) * (amount / 100);
      totalFiber += (composition.fiber || 0) * (amount / 100);
      totalCalcium += (composition.calcium || 0) * (amount / 100);
      totalPhosphorus += (composition.phosphorus || 0) * (amount / 100);
      totalCalories += (composition.kcal || 0) * (amount / 100);
      totalWeight += amount;
      realDataCount++;
    } else {
      // Try fallback nutrition
      const fallback = getFallbackNutrition(name);
      if (fallback) {
        fallbackIngredients.push(name);
        totalProtein += (fallback.protein || 0) * (amount / 100);
        totalFat += (fallback.fat || 0) * (amount / 100);
        totalFiber += (fallback.fiber || 0) * (amount / 100);
        totalCalcium += (fallback.calcium || 0) * (amount / 100);
        totalPhosphorus += (fallback.phosphorus || 0) * (amount / 100);
        totalCalories += (fallback.kcal || 0) * (amount / 100);
        totalWeight += amount;
        realDataCount++;
      }
    }
  }

  // Process supplements - add their nutritional contributions
  for (const supplement of supplements) {
    const name = supplement.name || supplement.productName || '';
    if (!name) continue;
    
    // Map supplement name to ingredient composition key
    const compositionKey = mapSupplementToCompositionKey(name);
    if (!compositionKey) continue;
    
    // Get composition data
    const composition = getIngredientComposition(compositionKey);
    if (!composition) continue;
    
    // Supplements are typically added in small amounts (mg or grams)
    // Parse amount from supplement.amount (e.g., "250mg", "1g", "As directed")
    let supplementAmount = 0;
    const amountStr = supplement.amount || supplement.defaultAmount || '';
    if (amountStr) {
      // Extract numeric value
      const numericMatch = amountStr.match(/([\d.]+)/);
      if (numericMatch) {
        supplementAmount = parseFloat(numericMatch[1]);
        // Convert mg to grams if needed
        if (amountStr.toLowerCase().includes('mg')) {
          supplementAmount = supplementAmount / 1000;
        }
      } else {
        // Default supplement amount (typically 1-5g for powders)
        supplementAmount = 2; // 2g default
      }
    } else {
      supplementAmount = 2; // 2g default
    }
    
    // Add supplement nutrition to totals
    // Supplements contribute nutrients but typically don't add significant weight to the meal
    // We'll add them proportionally to the existing meal weight
    if (totalWeight > 0) {
      // Add supplement nutrients as if they were part of the meal
      totalCalcium += (composition.calcium || 0) * (supplementAmount / 100);
      totalPhosphorus += (composition.phosphorus || 0) * (supplementAmount / 100);
      totalProtein += (composition.protein || 0) * (supplementAmount / 100);
      totalFat += (composition.fat || 0) * (supplementAmount / 100);
      totalFiber += (composition.fiber || 0) * (supplementAmount / 100);
      totalCalories += (composition.kcal || 0) * (supplementAmount / 100);
      // Add supplement weight to total (small contribution)
      totalWeight += supplementAmount;
      realDataCount++;
    }
  }

  if (realDataCount > 0 && totalWeight > 0) {
    return {
      protein: (totalProtein / totalWeight) * 100,
      fat: (totalFat / totalWeight) * 100,
      fiber: (totalFiber / totalWeight) * 100,
      calcium: (totalCalcium / totalWeight) * 100,
      phosphorus: (totalPhosphorus / totalWeight) * 100,
      calories: (totalCalories / totalWeight) * 100,
      source: fallbackIngredients.length > 0 ? 'estimated' : 'real',
      usesFallbackNutrition: fallbackIngredients.length > 0,
      fallbackIngredients: fallbackIngredients.length > 0 ? fallbackIngredients : undefined,
    };
  }

  // Fallback estimates
  return {
    protein: 25,
    fat: 15,
    fiber: 3,
    calcium: 0.8,
    phosphorus: 0.6,
    calories: 150,
    source: 'estimated',
  };
}

/**
 * Perfect path short-circuit: Check if recipe is a perfect match for a perfect pet
 */
function isPerfectMatch(recipe: Recipe, pet: Pet): boolean {
  // Pet must have no health concerns and no allergies
  if (pet.healthConcerns.length > 0) return false;
  if ((pet.allergies?.length ?? 0) > 0) return false;
  if (pet.dietaryRestrictions.length > 0) return false;
  
  // Recipe must match species
  if (!matchesSpecies(recipe, pet)) return false;
  
  // Recipe must match age group
  const petAgeGroup = pet.age < 1 ? 'baby' : pet.age < 2 ? 'young' : pet.age < 7 ? 'adult' : 'senior';
  if (!recipe.ageGroup || !recipe.ageGroup.includes(petAgeGroup)) {
    if (!recipe.ageGroup?.includes('all') && recipe.ageGroup && recipe.ageGroup.length > 0) {
      return false;
    }
  }
  
  // All ingredients must be safe for species
  const normalizedSpecies = normalizeSpecies(pet.type);
  const ingredients = recipe.ingredients || [];
  for (const ing of ingredients) {
    const ingName = typeof ing === 'string' ? ing : ing.name;
    const ingKey = ingName.toLowerCase().replace(/\s+/g, '_');
    const compat = getSpeciesCompatibility(ingKey, normalizedSpecies);
    if (compat === 'avoid') return false;
  }
  
  // Check for banned ingredients
  const bannedIngredients = (pet as any).bannedIngredients || [];
  if (bannedIngredients.length > 0) {
    const recipeIngNames = ingredients.map(ing => 
      (typeof ing === 'string' ? ing : ing.name).toLowerCase()
    );
    for (const banned of bannedIngredients) {
      if (recipeIngNames.some(name => name.includes(banned.toLowerCase()) || banned.toLowerCase().includes(name))) {
        return false;
      }
    }
  }
  
  // Recipe must meet OPTIMAL nutrient requirements (not just minimums)
  const nutrition = calculateRecipeNutrition(recipe);
  const petCategory = normalizedSpecies === 'dog' ? 'dogs' : 
                      normalizedSpecies === 'cat' ? 'cats' :
                      normalizedSpecies === 'bird' ? 'birds' :
                      normalizedSpecies === 'reptile' ? 'reptiles' : 'pocket-pets';
  const ageGroup = pet.age < 1 ? 'puppy' : pet.age >= 7 ? 'senior' : 'adult';
  const requirements = nutritionalGuidelines[petCategory]?.[ageGroup] || nutritionalGuidelines[petCategory]?.adult;
  
  if (requirements) {
    // Require nutrition to be in IDEAL range (middle 30% of min-max range - very strict for perfect match)
    if (requirements.protein) {
      const range = requirements.protein.max - requirements.protein.min;
      const idealMin = requirements.protein.min + (range * 0.35); // Middle 30% of range
      const idealMax = requirements.protein.max - (range * 0.35);
      if (nutrition.protein < idealMin || nutrition.protein > idealMax) {
        return false;
      }
    }
    if (requirements.fat) {
      const range = requirements.fat.max - requirements.fat.min;
      const idealMin = requirements.fat.min + (range * 0.35);
      const idealMax = requirements.fat.max - (range * 0.35);
      if (nutrition.fat < idealMin || nutrition.fat > idealMax) {
        return false;
      }
    }
    
    // Require Ca:P ratio to be in OPTIMAL range (1.4-1.7, very tight for perfect match)
    if (nutrition.calcium && nutrition.phosphorus && requirements.calcium && requirements.phosphorus) {
      const ratio = nutrition.calcium / nutrition.phosphorus;
      if (ratio < 1.4 || ratio > 1.7) {
        return false;
      }
    }
  }
  
  // Require NO fallback nutrition (100% data coverage required for perfect match)
  if (nutrition.usesFallbackNutrition) {
    return false; // Perfect matches must have complete nutritional data
  }
  
  // Require data coverage > 95% (not just "no fallback")
  const totalIngredients = ingredients.length;
  if (nutrition.fallbackIngredients && nutrition.fallbackIngredients.length > 0) {
    const coverage = ((totalIngredients - nutrition.fallbackIngredients.length) / totalIngredients) * 100;
    if (coverage < 95) {
      return false; // Must have >95% data coverage
    }
  }
  
  // Require all core nutrients in ideal bands (not just protein/fat)
  if (requirements) {
    // Check fiber if required
    if (requirements.fiber) {
      const range = requirements.fiber.max - requirements.fiber.min;
      const idealMin = requirements.fiber.min + (range * 0.35);
      const idealMax = requirements.fiber.max - (range * 0.35);
      if (nutrition.fiber < idealMin || nutrition.fiber > idealMax) {
        return false;
      }
    }
    // Check calcium if required
    if (requirements.calcium) {
      const range = requirements.calcium.max - requirements.calcium.min;
      const idealMin = requirements.calcium.min + (range * 0.35);
      const idealMax = requirements.calcium.max - (range * 0.35);
      if (nutrition.calcium < idealMin || nutrition.calcium > idealMax) {
        return false;
      }
    }
    // Check phosphorus if required
    if (requirements.phosphorus) {
      const range = requirements.phosphorus.max - requirements.phosphorus.min;
      const idealMin = requirements.phosphorus.min + (range * 0.35);
      const idealMax = requirements.phosphorus.max - (range * 0.35);
      if (nutrition.phosphorus < idealMin || nutrition.phosphorus > idealMax) {
        return false;
      }
    }
  }
  
  // Require ingredient quality to be above threshold (at least 85% - very strict for perfect match)
  const qualityScore = calculateIngredientQualityScore(recipe.ingredients || []);
  if (qualityScore.score < 85) {
    return false;
  }
  
  // Require sufficient ingredient diversity (at least 3 different ingredient types)
  const ingredientTypes = new Set<string>();
  for (const ing of ingredients) {
    const ingName = typeof ing === 'string' ? ing : ing.name;
    const ingKey = ingName.toLowerCase().replace(/\s+/g, '_');
    const compat = getSpeciesCompatibility(ingKey, normalizedSpecies);
    if (compat === 'ok') {
      // Categorize ingredient type
      if (ingKey.includes('chicken') || ingKey.includes('turkey') || ingKey.includes('beef') || 
          ingKey.includes('lamb') || ingKey.includes('fish') || ingKey.includes('salmon') ||
          ingKey.includes('pork') || ingKey.includes('duck') || ingKey.includes('organ') ||
          ingKey.includes('heart') || ingKey.includes('liver') || ingKey.includes('egg')) {
        ingredientTypes.add('protein');
      } else if (ingKey.includes('rice') || ingKey.includes('potato') || ingKey.includes('oats') ||
                 ingKey.includes('quinoa') || ingKey.includes('barley') || ingKey.includes('grain')) {
        ingredientTypes.add('carb');
      } else if (ingKey.includes('carrot') || ingKey.includes('broccoli') || ingKey.includes('spinach') ||
                 ingKey.includes('kale') || ingKey.includes('vegetable') || ingKey.includes('green')) {
        ingredientTypes.add('vegetable');
      } else if (ingKey.includes('blueberry') || ingKey.includes('apple') || ingKey.includes('fruit')) {
        ingredientTypes.add('fruit');
      } else if (ingKey.includes('oil') || ingKey.includes('fat') || ingKey.includes('supplement')) {
        ingredientTypes.add('supplement');
      }
    }
  }
  if (ingredientTypes.size < 3) {
    return false; // Need at least 3 different ingredient types
  }
  
  return true;
}

/**
 * Calculate bonus points for perfect matches
 */
export function calculateBonuses(recipe: Recipe, pet: Pet): number {
  let bonus = 0;
  
  // Exact species fit (reduced from 2 to 1)
  if (matchesSpecies(recipe, pet)) {
    bonus += 1;
  }
  
  // Exact life stage match (reduced from 2 to 1)
  const petAgeGroup = pet.age < 1 ? 'baby' : pet.age < 2 ? 'young' : pet.age < 7 ? 'adult' : 'senior';
  if (recipe.ageGroup?.includes(petAgeGroup) || recipe.ageGroup?.includes('all')) {
    bonus += 1;
  }
  
  // No allergens (reduced from 2 to 1)
  if ((pet.allergies?.length ?? 0) === 0 && pet.dietaryRestrictions.length === 0) {
    bonus += 1;
  } else {
    // Check if recipe avoids allergens
    const allAllergens = [...(pet.allergies || []), ...pet.dietaryRestrictions];
    const recipeIngNames = (recipe.ingredients || []).map(ing => 
      (typeof ing === 'string' ? ing : ing.name).toLowerCase()
    ).join(' ');
    const hasAllergen = allAllergens.some(a => recipeIngNames.includes(a.toLowerCase()));
    if (!hasAllergen) {
      bonus += 1;
    }
  }
  
  // No fallback nutritional data (reduced from 2 to 1)
  const nutrition = calculateRecipeNutrition(recipe);
  if (!nutrition.usesFallbackNutrition) {
    bonus += 1;
  }
  
  // Ideal nutrient ratios (reduced from 2 to 1)
  if (nutrition.calcium && nutrition.phosphorus) {
    const ratio = nutrition.calcium / nutrition.phosphorus;
    if (ratio >= 1.2 && ratio <= 2.0) {
      bonus += 1;
    }
  }
  
  // Complete ingredient data (check coverage) (reduced from 2 to 1)
  const totalIngredients = (recipe.ingredients || []).length;
  if (nutrition.fallbackIngredients) {
    const coverage = totalIngredients > 0 
      ? 1 - (nutrition.fallbackIngredients.length / totalIngredients)
      : 0;
    if (coverage >= 0.9) {
      bonus += 1;
    }
  } else if (totalIngredients > 0) {
    bonus += 1; // All ingredients have data
  }
  
  return Math.min(2, bonus); // Cap at 2% bonus (further reduced to prevent clustering at 100%)
}

/**
 * Convert score to letter grade
 */
export function getGrade(score: number): 'A+' | 'A' | 'B+' | 'B' | 'C+' | 'C' | 'D' | 'F' {
  if (score >= 95) return 'A+';
  if (score >= 90) return 'A';
  if (score >= 85) return 'B+';
  if (score >= 80) return 'B';
  if (score >= 75) return 'C+';
  if (score >= 70) return 'C';
  if (score >= 60) return 'D';
  return 'F';
}

/**
 * Scoring tier system for better UX
 */
export type ScoreTier = 'A+' | 'A' | 'B+' | 'B' | 'C+' | 'C' | 'D' | 'F';

export function getScoreTier(score: number): ScoreTier {
  if (score >= 95) return 'A+';
  if (score >= 90) return 'A';
  if (score >= 85) return 'B+';
  if (score >= 80) return 'B';
  if (score >= 75) return 'C+';
  if (score >= 70) return 'C';
  if (score >= 60) return 'D';
  return 'F';
}

/**
 * Check if recipe is gold-standard for a simple pet (perfect match criteria)
 */
export function isGoldStandardForSimplePet(recipe: Recipe, pet: Pet): boolean {
  // Species & age correct
  if (!matchesSpecies(recipe, pet)) return false;
  
  const petAgeGroup = pet.age < 1 ? 'baby' : pet.age < 2 ? 'young' : pet.age < 7 ? 'adult' : 'senior';
  if (!recipe.ageGroup || !recipe.ageGroup.includes(petAgeGroup)) {
    if (!recipe.ageGroup?.includes('all') && recipe.ageGroup && recipe.ageGroup.length > 0) {
      return false;
    }
  }
  
  // No allergens/never-feed ingredients
  const allAllergens = [...(pet.allergies || []), ...pet.dietaryRestrictions];
  if (allAllergens.length > 0) {
    const recipeIngNames = (recipe.ingredients || []).map(ing => 
      (typeof ing === 'string' ? ing : ing.name).toLowerCase()
    ).join(' ');
    const hasAllergen = allAllergens.some(a => recipeIngNames.includes(a.toLowerCase()));
    if (hasAllergen) return false;
  }
  
  // Check for banned ingredients
  const bannedIngredients = (pet as any).bannedIngredients || [];
  if (bannedIngredients.length > 0) {
    const recipeIngNames = (recipe.ingredients || []).map(ing => 
      (typeof ing === 'string' ? ing : ing.name).toLowerCase()
    );
    for (const banned of bannedIngredients) {
      if (recipeIngNames.some(name => name.includes(banned.toLowerCase()) || banned.toLowerCase().includes(name))) {
        return false;
      }
    }
  }
  
  // No health concerns OR recipe is neutral/beneficial
  if (pet.healthConcerns.length > 0) {
    const recipeNotSuitable = (recipe.notSuitableFor || []).map(c => normalizeHealthConcern(c));
    const petConcerns = pet.healthConcerns.map(c => normalizeHealthConcern(c));
    const hasConflict = recipeNotSuitable.some(ns => 
      petConcerns.some(pc => ns.includes(pc) || pc.includes(ns))
    );
    if (hasConflict) return false;
  }
  
  // Core nutrients within ideal bands
  const nutrition = calculateRecipeNutrition(recipe);
  const normalizedSpecies = normalizeSpecies(pet.type);
  const petCategory = normalizedSpecies === 'dog' ? 'dogs' : 
                      normalizedSpecies === 'cat' ? 'cats' :
                      normalizedSpecies === 'bird' ? 'birds' :
                      normalizedSpecies === 'reptile' ? 'reptiles' : 'pocket-pets';
  const ageGroup = pet.age < 1 ? 'puppy' : pet.age >= 7 ? 'senior' : 'adult';
  const requirements = nutritionalGuidelines[petCategory]?.[ageGroup] || nutritionalGuidelines[petCategory]?.adult;
  
  if (requirements) {
    if (requirements.protein) {
      if (nutrition.protein < requirements.protein.min || nutrition.protein > requirements.protein.max) {
        return false;
      }
    }
    if (requirements.fat) {
      if (nutrition.fat < requirements.fat.min || nutrition.fat > requirements.fat.max) {
        return false;
      }
    }
    
    // Ca:P ratio in safe range
    if (nutrition.calcium && nutrition.phosphorus && requirements.calcium && requirements.phosphorus) {
      const ratio = nutrition.calcium / nutrition.phosphorus;
      if (ratio < 1.0 || ratio > 2.5) return false;
    }
  }
  
  // No fallback nutrition (or confidence threshold met)
  if (nutrition.usesFallbackNutrition && nutrition.fallbackIngredients) {
    const totalIngredients = (recipe.ingredients || []).length;
    const confidence = totalIngredients > 0 
      ? 1 - (nutrition.fallbackIngredients.length / totalIngredients)
      : 0;
    if (confidence < 0.8) return false; // Require 80% data coverage
  }
  
  return true;
}

/**
 * Per-pet calibration: Rescale scores so best gold-standard recipe becomes 100%
 */
/**
 * Calibrate scores for a pet across multiple recipes
 * Rescales scores so the best perfect match becomes 95-100, or caps at 90-95 if no perfect matches
 * Preserves ranking while improving distribution
 */
export function calibrateScoresForPet(
  recipes: Recipe[],
  pet: Pet
): Map<string, number> {
  // Score all recipes
  const scored = recipes.map(recipe => ({
    recipe,
    rawScore: calculateEnhancedCompatibility(recipe, pet).overallScore,
    isPerfectMatch: isPerfectMatch(recipe, pet)
  }));
  
  // Find best perfect match recipe
  const perfectMatchRecipes = scored.filter(s => s.isPerfectMatch);
  const bestPerfectMatch = perfectMatchRecipes.length > 0
    ? perfectMatchRecipes.reduce((best, current) => 
        current.rawScore > best.rawScore ? current : best
      )
    : null;
  
  // If we have a perfect match recipe, rescale so it becomes 95-100
  if (bestPerfectMatch && bestPerfectMatch.rawScore > 0) {
    // Target: best perfect match should be 98 (allows room for variation)
    const targetScore = 98;
    const scaleFactor = targetScore / bestPerfectMatch.rawScore;
    const calibrated = new Map<string, number>();
    
    // Calculate mean and std dev for monotonic transform
    const scores = scored.map(s => s.rawScore);
    const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
    const stdDev = Math.sqrt(variance);
    
    scored.forEach(({ recipe, rawScore, isPerfectMatch }) => {
      // Rescale proportionally
      let calibratedScore = rawScore * scaleFactor;
      
      // Perfect matches can reach 100, others capped at 95
      if (isPerfectMatch) {
        calibratedScore = Math.min(100, calibratedScore);
      } else {
        calibratedScore = Math.min(95, calibratedScore);
      }
      
      calibrated.set(recipe.id, Math.max(0, Math.min(100, Math.round(calibratedScore))));
    });
    
    return calibrated;
  }
  
  // No perfect match found - cap top score at 90-95 to honestly reflect "no perfect match"
  const maxRawScore = Math.max(...scored.map(s => s.rawScore));
  const calibrated = new Map<string, number>();
  
  if (maxRawScore > 0) {
    // Rescale so max becomes 92 (honest "no perfect match" ceiling)
    const scaleFactor = 92 / maxRawScore;
    
    scored.forEach(({ recipe, rawScore }) => {
      const calibratedScore = rawScore * scaleFactor;
      calibrated.set(recipe.id, Math.max(0, Math.min(92, Math.round(calibratedScore))));
    });
  } else {
    // All scores are 0 - return as-is
    scored.forEach(({ recipe, rawScore }) => {
      calibrated.set(recipe.id, rawScore);
    });
  }
  
  return calibrated;
}

/**
 * Calculate enhanced compatibility with per-pet calibration applied
 * This is a convenience function that scores a single recipe but applies calibration
 * if a recipe set is provided. For batch operations, use calibrateScoresForPet() directly.
 */
export function calculateEnhancedCompatibilityWithCalibration(
  recipe: Recipe,
  pet: Pet,
  allRecipes?: Recipe[]
): EnhancedCompatibilityScore {
  const rawScore = calculateEnhancedCompatibility(recipe, pet);
  
  // If all recipes provided, apply calibration
  if (allRecipes && allRecipes.length > 1) {
    const calibratedScores = calibrateScoresForPet(allRecipes, pet);
    const calibratedScore = calibratedScores.get(recipe.id);
    
    if (calibratedScore !== undefined) {
      // Return score with calibrated overallScore
      return {
        ...rawScore,
        overallScore: calibratedScore,
        grade: getGrade(calibratedScore),
      };
    }
  }
  
  return rawScore;
}
</file>

<file path="lib/utils/errorHandler.ts">
// lib/utils/errorHandler.ts
// Centralized error handling utilities

export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500,
    public isOperational: boolean = true
  ) {
    super(message);
    this.name = 'AppError';
    Error.captureStackTrace(this, this.constructor);
  }
}

export class DatabaseError extends AppError {
  constructor(message: string, originalError?: Error) {
    super(message, 'DATABASE_ERROR', 500);
    this.name = 'DatabaseError';
    if (originalError) {
      this.stack = originalError.stack;
    }
  }
}

export class ValidationError extends AppError {
  constructor(message: string, public fields?: Record<string, string>) {
    super(message, 'VALIDATION_ERROR', 400);
    this.name = 'ValidationError';
  }
}

export class AuthenticationError extends AppError {
  constructor(message: string = 'Authentication required') {
    super(message, 'AUTH_ERROR', 401);
    this.name = 'AuthenticationError';
  }
}

/**
 * Handle errors consistently across the app
 */
export function handleError(error: unknown): AppError {
  console.error('Error occurred:', error);
  
  if (error instanceof AppError) {
    return error;
  }
  
  if (error instanceof Error) {
    // Firebase errors
    if (error.message.includes('permission-denied')) {
      return new AuthenticationError('You don\'t have permission to access this resource');
    }
    
    if (error.message.includes('not-found')) {
      return new AppError('Resource not found', 'NOT_FOUND', 404);
    }
    
    if (error.message.includes('already-exists')) {
      return new ValidationError('Resource already exists');
    }
    
    // Network errors
    if (error.message.includes('network')) {
      return new AppError('Network error. Please check your connection.', 'NETWORK_ERROR', 503);
    }
    
    // Generic error
    return new AppError(
      error.message || 'An unexpected error occurred',
      'UNKNOWN_ERROR',
      500,
      false
    );
  }
  
  return new AppError('An unexpected error occurred', 'UNKNOWN_ERROR', 500, false);
}

/**
 * Log error to external service (e.g., Sentry)
 */
export function logError(error: Error | AppError, context?: Record<string, any>) {
  // In production, send to error tracking service
  if (process.env.NODE_ENV === 'production') {
    // TODO: Integrate with Sentry or similar
    console.error('Production error:', { error, context });
  } else {
    console.error('Development error:', error, context);
  }
}

/**
 * Toast-friendly error message
 */
export function getErrorMessage(error: unknown): string {
  if (error instanceof AppError) {
    return error.message;
  }
  
  if (error instanceof Error) {
    return error.message;
  }
  
  return 'An unexpected error occurred. Please try again.';
}
</file>

<file path="lib/utils/firebaseConfig.ts">
// lib/utils/firebaseConfig.ts
// Firebase configuration and initialization with proper error handling

import { initializeApp, type FirebaseApp, getApps } from 'firebase/app';
import { getFirestore, type Firestore, connectFirestoreEmulator } from 'firebase/firestore';
import { getAuth, type Auth, connectAuthEmulator } from 'firebase/auth';

// Firebase configuration from environment variables
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

let app: FirebaseApp | null = null;
let db: Firestore | null = null;
let auth: Auth | null = null;
let initializationError: Error | null = null;

/**
 * Check if Firebase is properly configured
 */
function isFirebaseConfigured(): boolean {
  return !!(
    firebaseConfig.apiKey &&
    firebaseConfig.authDomain &&
    firebaseConfig.projectId
  );
}

/**
 * Initialize Firebase services
 * Returns null if Firebase is not configured
 */
export function initializeFirebase(): { app: FirebaseApp; db: Firestore; auth: Auth } | null {
  // Server-side check
  if (typeof window === 'undefined') return null;
  
  // Return existing instance
  if (app && db && auth) {
    return { app, db, auth };
  }
  
  try {
    // Check if Firebase is configured
    if (!isFirebaseConfigured()) {
      console.warn('Firebase not configured - using localStorage fallback');
      return null;
    }
    
    // Use existing app or initialize new one
    if (getApps().length === 0) {
      app = initializeApp(firebaseConfig);
    } else {
      app = getApps()[0];
    }
    
    // Initialize Firestore
    db = getFirestore(app);
    
    // Initialize Auth
    auth = getAuth(app);
    
    // Connect to emulators in development
    if (process.env.NODE_ENV === 'development' && process.env.NEXT_PUBLIC_USE_FIREBASE_EMULATOR === 'true') {
      try {
        connectFirestoreEmulator(db, 'localhost', 8080);
        connectAuthEmulator(auth, 'http://localhost:9099', { disableWarnings: true });
        console.log('Connected to Firebase emulators');
      } catch (e) {
        // Emulators already connected or not available
      }
    }
    
    return { app, db, auth };
  } catch (error) {
    initializationError = error as Error;
    console.error('Firebase initialization failed:', error);
    return null;
  }
}

/**
 * Get Firebase services (initializes if needed)
 */
export function getFirebaseServices(): { app: FirebaseApp; db: Firestore; auth: Auth } | null {
  if (app && db && auth) {
    return { app, db, auth };
  }
  return initializeFirebase();
}

/**
 * Get app ID from environment
 */
export function getAppId(): string {
  return process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'pet-plates-app';
}

/**
 * Check if Firebase is available
 */
export function isFirebaseAvailable(): boolean {
  return getFirebaseServices() !== null;
}

/**
 * Get initialization error if any
 */
export function getInitializationError(): Error | null {
  return initializationError;
}
</file>

<file path="lib/utils/getAmazonBuyLink.ts">
// Runtime Amazon link finalizer - ensures all buy links are safe before display
// This is the ONLY function that should be used to get Amazon links in the UI

import { ensureSellerId, isValidAmazonUrl, extractASIN } from './affiliateLinks';

export type Region = 'US' | 'UK' | 'DE' | 'AU';

export interface BuyLinkResult {
  url: string | null;
  status: 'ok' | 'missing' | 'invalid' | 'region-unavailable';
  asin?: string;
}

/**
 * Runtime finalizer for Amazon buy links.
 * Guarantees:
 * - Affiliate tag is present (tag=robinfrench-20)
 * - URL is valid Amazon URL
 * - ASIN can be extracted (proves it's a product link, not search)
 * 
 * Returns null if link is broken/invalid - UI should handle gracefully.
 * 
 * @param rawUrl The raw Amazon URL from data files
 * @param region User's region (default: US)
 * @returns Finalized URL with affiliate tag, or null if invalid
 */
export function getAmazonBuyLink(
  rawUrl: string | undefined | null,
  region: Region = 'US'
): string | null {
  if (!rawUrl) return null;
  
  // Validate it's an Amazon URL
  if (!isValidAmazonUrl(rawUrl)) return null;
  
  // Extract ASIN to verify it's a product link (not a search)
  const asin = extractASIN(rawUrl);
  if (!asin) {
    // No ASIN means it's a search URL or malformed - reject it
    return null;
  }
  
  // Add affiliate tag
  const withTag = ensureSellerId(rawUrl);
  
  // Re-validate after mutation (defensive)
  if (!isValidAmazonUrl(withTag)) return null;
  
  return withTag;
}

/**
 * Extended version that returns detailed status for debugging.
 * Use this in admin/debug views to see why links are failing.
 */
export function getAmazonBuyLinkWithStatus(
  rawUrl: string | undefined | null,
  region: Region = 'US'
): BuyLinkResult {
  if (!rawUrl) {
    return { url: null, status: 'missing' };
  }
  
  if (!isValidAmazonUrl(rawUrl)) {
    return { url: null, status: 'invalid' };
  }
  
  const asin = extractASIN(rawUrl);
  if (!asin) {
    return { url: null, status: 'invalid' };
  }
  
  // TODO: Add region-specific validation when we support multi-region
  // For now, all links are US-only
  if (region !== 'US') {
    return { url: null, status: 'region-unavailable', asin };
  }
  
  const withTag = ensureSellerId(rawUrl);
  
  if (!isValidAmazonUrl(withTag)) {
    return { url: null, status: 'invalid', asin };
  }
  
  return { url: withTag, status: 'ok', asin };
}

/**
 * Fallback: Generate Amazon search link if no specific product link exists.
 * Only use this if you explicitly decide to allow generic searches (Policy B).
 * 
 * @param query Search query (e.g., ingredient name + brand)
 * @param region User's region
 * @returns Amazon search URL with affiliate tag
 */
export function getFallbackAmazonSearchLink(
  query: string,
  region: Region = 'US'
): string {
  const base = region === 'US' ? 'https://www.amazon.com/s' : 'https://www.amazon.co.uk/s';
  const url = `${base}?k=${encodeURIComponent(query)}`;
  return ensureSellerId(url);
}
</file>

<file path="lib/utils/healthConcernMatching.ts">
// lib/utils/healthConcernMatching.ts
// Health concern matching system for tiered scoring

export interface HealthConcernBenefits {
  beneficialIngredients: string[];
  avoidIngredients: string[];
  targetMacros?: {
    protein?: 'low' | 'moderate' | 'high';
    fat?: 'low' | 'moderate' | 'high' | 'very-low';
    fiber?: 'low' | 'moderate' | 'high';
    phosphorus?: 'low' | 'moderate' | 'high';
  };
  targetRatios?: {
    caP?: { min: number; max: number };
  };
}

export const HEALTH_CONCERN_BENEFITS: Record<string, HealthConcernBenefits> = {
  'kidney-disease': {
    beneficialIngredients: ['egg-whites', 'white-rice', 'fish-oil', 'low-phosphorus-vegetables', 'sweet-potato'],
    avoidIngredients: ['organ-meats', 'high-phosphorus-foods', 'excess-sodium', 'red-meat'],
    targetMacros: {
      protein: 'low',
      phosphorus: 'low',
      fat: 'moderate',
    },
  },
  'pancreatitis': {
    beneficialIngredients: ['lean-turkey', 'white-fish', 'sweet-potato', 'pumpkin', 'low-fat-protein'],
    avoidIngredients: ['high-fat-meats', 'oils', 'fried-foods', 'fatty-fish', 'pork'],
    targetMacros: {
      fat: 'very-low',
      fiber: 'high',
      protein: 'moderate',
    },
  },
  'allergies': {
    beneficialIngredients: ['novel-proteins', 'fish-oil', 'anti-inflammatory-foods'],
    avoidIngredients: ['common-allergens'], // Will be replaced with pet-specific allergens
    targetMacros: {
      protein: 'moderate',
    },
  },
  'weight-management': {
    beneficialIngredients: ['lean-protein', 'high-fiber-vegetables', 'pumpkin', 'green-beans'],
    avoidIngredients: ['high-calorie-foods', 'excess-fat'],
    targetMacros: {
      fat: 'low',
      fiber: 'high',
      protein: 'moderate',
    },
  },
  'digestive-health': {
    beneficialIngredients: ['pumpkin', 'sweet-potato', 'probiotic-foods', 'fiber-rich-vegetables'],
    avoidIngredients: ['irritating-foods', 'high-fat'],
    targetMacros: {
      fiber: 'high',
      fat: 'moderate',
    },
  },
  'joint-mobility': {
    beneficialIngredients: ['fish-oil', 'omega-3-sources', 'glucosamine-sources', 'anti-inflammatory-foods'],
    avoidIngredients: ['high-purine-foods'],
    targetMacros: {
      fat: 'moderate',
    },
  },
  'skin-coat': {
    beneficialIngredients: ['fish-oil', 'omega-3-sources', 'vitamin-e-sources', 'healthy-fats'],
    avoidIngredients: ['low-quality-fats'],
    targetMacros: {
      fat: 'moderate',
    },
  },
  'dental-health': {
    beneficialIngredients: ['crunchy-vegetables', 'dental-chews', 'raw-bones'],
    avoidIngredients: ['sticky-foods', 'sugary-foods'],
    targetMacros: {},
  },
  'urinary-support': {
    beneficialIngredients: ['moisture-rich-foods', 'low-magnesium-foods', 'cranberry'],
    avoidIngredients: ['high-magnesium-foods', 'excess-minerals'],
    targetMacros: {
      protein: 'moderate',
    },
  },
  'diabetes': {
    beneficialIngredients: ['low-glycemic-vegetables', 'high-fiber-foods', 'lean-protein'],
    avoidIngredients: ['high-sugar-foods', 'simple-carbohydrates'],
    targetMacros: {
      fiber: 'high',
      fat: 'moderate',
      protein: 'moderate',
    },
  },
  'heart-disease': {
    beneficialIngredients: ['omega-3-sources', 'low-sodium-foods', 'lean-protein'],
    avoidIngredients: ['high-sodium-foods', 'excess-fat'],
    targetMacros: {
      fat: 'low',
      protein: 'moderate',
    },
  },
};

/**
 * Normalize health concern name for matching
 */
export function normalizeHealthConcern(concern: string): string {
  return concern
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '');
}

/**
 * Get health concern benefits data
 */
export function getHealthConcernBenefits(concern: string): HealthConcernBenefits | null {
  const normalized = normalizeHealthConcern(concern);
  return HEALTH_CONCERN_BENEFITS[normalized] || null;
}

/**
 * Check if an ingredient name matches a beneficial ingredient
 */
export function isBeneficialIngredient(ingredientName: string, beneficialList: string[]): boolean {
  const normalized = ingredientName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  return beneficialList.some(beneficial => {
    const normalizedBeneficial = beneficial.toLowerCase().replace(/\s+/g, '-');
    return normalized.includes(normalizedBeneficial) || normalizedBeneficial.includes(normalized);
  });
}

/**
 * Check if an ingredient name matches an avoid ingredient
 */
export function isAvoidIngredient(ingredientName: string, avoidList: string[], petAllergies?: string[]): boolean {
  const normalized = ingredientName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  
  // Check against avoid list
  const matchesAvoid = avoidList.some(avoid => {
    if (avoid === 'common-allergens' && petAllergies) {
      // Check against pet's specific allergies
      return petAllergies.some(allergy => 
        normalized.includes(allergy.toLowerCase()) || 
        allergy.toLowerCase().includes(normalized)
      );
    }
    const normalizedAvoid = avoid.toLowerCase().replace(/\s+/g, '-');
    return normalized.includes(normalizedAvoid) || normalizedAvoid.includes(normalized);
  });
  
  return matchesAvoid;
}

/**
 * Check macro alignment with target macros
 */
export function checkMacroAlignment(
  nutrition: { protein: number; fat: number; fiber: number; phosphorus?: number },
  targetMacros?: HealthConcernBenefits['targetMacros']
): number {
  if (!targetMacros) return 50; // Neutral if no targets
  
  let alignmentScore = 0;
  let factors = 0;
  
  if (targetMacros.protein) {
    factors++;
    if (targetMacros.protein === 'low' && nutrition.protein < 20) alignmentScore += 30;
    else if (targetMacros.protein === 'moderate' && nutrition.protein >= 20 && nutrition.protein <= 30) alignmentScore += 30;
    else if (targetMacros.protein === 'high' && nutrition.protein > 30) alignmentScore += 30;
    else alignmentScore += 10; // Partial alignment
  }
  
  if (targetMacros.fat) {
    factors++;
    if (targetMacros.fat === 'very-low' && nutrition.fat < 8) alignmentScore += 30;
    else if (targetMacros.fat === 'low' && nutrition.fat < 12) alignmentScore += 30;
    else if (targetMacros.fat === 'moderate' && nutrition.fat >= 12 && nutrition.fat <= 18) alignmentScore += 30;
    else if (targetMacros.fat === 'high' && nutrition.fat > 18) alignmentScore += 30;
    else alignmentScore += 10;
  }
  
  if (targetMacros.fiber) {
    factors++;
    if (targetMacros.fiber === 'low' && nutrition.fiber < 5) alignmentScore += 30;
    else if (targetMacros.fiber === 'moderate' && nutrition.fiber >= 5 && nutrition.fiber <= 10) alignmentScore += 30;
    else if (targetMacros.fiber === 'high' && nutrition.fiber > 10) alignmentScore += 30;
    else alignmentScore += 10;
  }
  
  if (targetMacros.phosphorus && nutrition.phosphorus !== undefined) {
    factors++;
    if (targetMacros.phosphorus === 'low' && nutrition.phosphorus < 0.6) alignmentScore += 30;
    else if (targetMacros.phosphorus === 'moderate' && nutrition.phosphorus >= 0.6 && nutrition.phosphorus <= 1.0) alignmentScore += 30;
    else if (targetMacros.phosphorus === 'high' && nutrition.phosphorus > 1.0) alignmentScore += 30;
    else alignmentScore += 10;
  }
  
  return factors > 0 ? alignmentScore / factors : 50;
}
</file>

<file path="lib/utils/imageMapping.ts">
// Utility functions for image mapping and emoji groups
import { imageManifest, healthConcernStyles, petCategoryStyles, type ImageGroup } from '@/lib/data/imageManifest';

export type ImageVariant = keyof ImageGroup['variants'];

/**
 * Get the image group key for a given emoji
 */
export function getEmojiGroup(emoji: string): string | null {
  for (const [groupKey, group] of Object.entries(imageManifest)) {
    if (group.emojis.includes(emoji)) {
      return groupKey;
    }
  }
  return null;
}

/**
 * Get the image path for a specific emoji and variant
 */
export function getEmojiImagePath(emoji: string, variant: ImageVariant): string | null {
  const groupKey = getEmojiGroup(emoji);
  if (!groupKey) return null;

  const group = imageManifest[groupKey];
  const variantFile = group.variants[variant as keyof typeof group.variants];

  // Assuming images are in /assets/images/animals/{group}/
  return `/assets/images/animals/${groupKey}/${variantFile}`;
}

/**
 * Get the master icon path for an emoji group
 */
export function getMasterIconPath(groupKey: string): string | null {
  const group = imageManifest[groupKey];
  return group ? group.masterIcon : null;
}

/**
 * Get the master hero path for an emoji group
 */
export function getMasterHeroPath(groupKey: string): string | null {
  const group = imageManifest[groupKey];
  return group ? group.masterHero : null;
}

/**
 * Get health concern style information
 */
export function getHealthConcernStyle(concern: string) {
  return healthConcernStyles[concern] || null;
}

/**
 * Get pet category style information
 */
export function getPetCategoryStyle(category: string) {
  return petCategoryStyles[category] || null;
}

/**
 * Get all emojis in a group
 */
export function getGroupEmojis(groupKey: string): string[] {
  const group = imageManifest[groupKey];
  return group ? group.emojis : [];
}

/**
 * Get all available groups
 */
export function getAllGroups(): string[] {
  return Object.keys(imageManifest);
}

/**
 * Check if an emoji is supported
 */
export function isEmojiSupported(emoji: string): boolean {
  return getEmojiGroup(emoji) !== null;
}
</file>

<file path="lib/utils/improvedCompatibilityScoring.ts">
// lib/utils/improvedCompatibilityScoring.ts
// Improved compatibility scoring with more accuracy and score variation.

import type { Recipe } from '@/lib/types';
import { getIngredientComposition } from '@/lib/data/ingredientCompositions';
import {
  normalizeSpecies,
  getSpeciesCompatibility,
  getMaxInclusionPercent,
} from './ingredientCompatibility';
import { validateCriticalNutrients } from '@/lib/data/aafco-standards';

// -------- Config for quick tuning -------- //
const SCORE_CONFIG = {
  weights: {
    ingredientSafety: 0.20,
    nutritionalAdequacy: 0.26,
    healthAlignment: 0.14,
    lifeStageFit: 0.10,
    allergenSafety: 0.10,
    digestibility: 0.08,
    variety: 0.12,
  },
  safeFloor: 65, // applied if ingredientSafety >= 60 && allergenSafety >= 60
  jitter: {
    low: 0.4,
    mid: 0.3,
    high: 0.2,
  },
  normalize: {
    topKeep: 95,
    topBand: 85,
    midBand: 70,
    lift50: 1.02,
    lift30: 1.05,
    liftLow: 1.08,
  },
  debug: process.env.NEXT_PUBLIC_SCORE_DEBUG === 'true',
};

export interface ImprovedPet {
  id: string;
  name: string;
  type: string; // accepts dogs/cats/birds/reptiles/pocket-pets
  breed?: string;
  age?: string | number;
  weight?: number;
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very-active';
  healthConcerns: string[];
  dietaryRestrictions?: string[];
  allergies?: string[];
}

export interface ImprovedScore {
  overallScore: number; // 0-100
  stars: number; // 1-5
  recommendation?: 'excellent' | 'good' | 'acceptable' | 'caution' | 'avoid';
  summaryReasoning?: string;
  factors: {
    ingredientSafety: number;
    nutritionalAdequacy: number;
    healthAlignment: number;
    lifeStageFit: number;
    allergenSafety: number;
    digestibility: number;
    variety: number;
  };
  reasoning: {
    strengths: string[];
    warnings: string[];
    recommendations: string[];
  };
}

/**
 * Entry point: calculate improved compatibility score with better distribution.
 */
export function calculateImprovedCompatibility(
  recipe: Recipe,
  pet: ImprovedPet
): ImprovedScore {
  const species = normalizeSpecies(pet.type);
  const ageNum = typeof pet.age === 'string' ? parseFloat(pet.age) || 0 : pet.age || 0;

  const ingredientSafety = scoreIngredientSafety(recipe, species);
  const nutritionalAdequacy = scoreNutritionalAdequacy(recipe, pet, species, ageNum);
  const healthAlignment = scoreHealthAlignment(recipe, pet);
  const lifeStageFit = scoreLifeStageFit(recipe, ageNum);
  const allergenSafety = scoreAllergenSafety(recipe, pet);
  const digestibility = scoreDigestibility(recipe, species);
  const variety = scoreIngredientVariety(recipe);

  const weighted =
    ingredientSafety * SCORE_CONFIG.weights.ingredientSafety +
    nutritionalAdequacy * SCORE_CONFIG.weights.nutritionalAdequacy +
    healthAlignment * SCORE_CONFIG.weights.healthAlignment +
    lifeStageFit * SCORE_CONFIG.weights.lifeStageFit +
    allergenSafety * SCORE_CONFIG.weights.allergenSafety +
    digestibility * SCORE_CONFIG.weights.digestibility +
    variety * SCORE_CONFIG.weights.variety;

  const normalized = normalizeScore(weighted);
  const variation = applyControlledVariation(normalized);
  const safeFloor =
    ingredientSafety >= 60 && allergenSafety >= 60 ? SCORE_CONFIG.safeFloor : 0; // keep safe recipes from tanking
  const finalScore = clamp(
    Number(Math.max(normalized + variation, safeFloor).toFixed(1)),
    0,
    100
  );

  const strengths: string[] = [];
  const warnings: string[] = [];
  const recommendations: string[] = [];

  if (ingredientSafety >= 90) strengths.push('All ingredients are species-safe');
  if (nutritionalAdequacy < 60) {
    warnings.push('Recipe has nutritional gaps');
    recommendations.push('Add supplements or adjust ingredients for balance');
  }
  if (healthAlignment >= 80) strengths.push('Supports key health concerns');
  if (allergenSafety < 100) warnings.push('Contains known allergens');

  const { stars, recommendation, summaryReasoning } = mapScoreToStarsWithReasoning(finalScore, {
    ingredientSafety,
    nutritionalAdequacy,
    healthAlignment,
    lifeStageFit,
    allergenSafety,
    digestibility,
  });

  if (SCORE_CONFIG.debug) {
    console.log('[ScoreDebug]', {
      recipe: recipe.name,
      finalScore,
      normalized,
      variation,
      safeFloor,
      factors: {
        ingredientSafety,
        nutritionalAdequacy,
        healthAlignment,
        lifeStageFit,
        allergenSafety,
        digestibility,
        variety,
      },
    });
  }

  return {
    overallScore: finalScore,
    stars,
    recommendation,
    summaryReasoning,
    factors: {
      ingredientSafety,
      nutritionalAdequacy,
      healthAlignment,
      lifeStageFit,
      allergenSafety,
      digestibility,
      variety,
    },
    reasoning: { strengths, warnings, recommendations },
  };
}

// ------------------ Factor Calculations ------------------ //

function scoreIngredientSafety(recipe: Recipe, species: string): number {
  const ingredients = recipe.ingredients || [];
  if (!ingredients.length) return 85;

  let score = 85;
  let avoidCount = 0;
  let unknownCount = 0;

  for (const ing of ingredients) {
    const name = typeof ing === 'string' ? ing : ing.name;
    const amount = typeof ing === 'string'
      ? 100
      : ing.amount
      ? parseFloat(String(ing.amount).replace(/[^0-9.]/g, '')) || 0
      : 0;

    const key = name.toLowerCase().replace(/\s+/g, '_');
    const compat = getSpeciesCompatibility(key, species);

    if (compat === 'avoid') {
      avoidCount++;
      score -= 25;
    } else if (compat === 'limit' || compat === 'caution') {
      const maxInclusion = getMaxInclusionPercent(key, species);
      if (maxInclusion && amount / 100 > maxInclusion) {
        score -= 18;
      } else {
        score -= 12;
      }
    } else if (compat === 'ok') {
      // mildly reward clear safe ingredients
      score += 1.5;
    } else {
      // Unknown ingredient: minor uncertainty
      unknownCount++;
      score -= 3;
    }
  }

  if (avoidCount > 1) {
    score -= avoidCount * 6; // gentle compounding
  }

  const unknownRatio = ingredients.length ? unknownCount / ingredients.length : 0;
  if (unknownRatio > 0.5) {
    score -= 10;
  }

  if (avoidCount > 0) {
    score = Math.min(score, 40); // still keep avoids meaningful
  } else if (unknownCount === 0) {
    // Safety floor for clean recipes
    score = Math.max(score, 80);
  }

  return clamp(score, 0, 100);
}

function scoreNutritionalAdequacy(
  recipe: Recipe,
  pet: ImprovedPet,
  species: string,
  ageNum: number
): number {
  let score = 90;
  const nutrition = calcNutrition(recipe);

  if (species === 'dog' || species === 'cat') {
    const lifeStage = ageNum < 1 ? 'growth' : 'adult';
    const validation = validateCriticalNutrients(
      recipe,
      species as 'dog' | 'cat',
      lifeStage
    );
    if (!validation.isValid) {
      const basePenalty = Math.min(validation.violations.length * 8, 40);
      const severe = validation.violations.some(v =>
        v.toLowerCase().includes('critical') || v.toLowerCase().includes('essential')
      );
      score -= basePenalty * (severe ? 1.3 : 1);
    }

    const minProtein = lifeStage === 'growth' ? 22 : 18;
    if (nutrition.protein < minProtein) {
      const deficit = minProtein - nutrition.protein;
      const proteinPenalty = Math.min(Math.pow(deficit, 1.3) * 1.5, 30);
      score -= proteinPenalty;
    }

    if (nutrition.calcium && nutrition.phosphorus) {
      const ratio = nutrition.calcium / nutrition.phosphorus;
      if (ratio < 1.0 || ratio > 2.5) {
        const deviation = ratio < 1.0 ? 1.0 - ratio : ratio - 2.5;
        score -= Math.min(deviation * 15, 20);
      }
    }
  } else {
    // Heuristics for non-dog/cat species
    switch (species) {
      case 'bird': {
        if (nutrition.calcium && nutrition.phosphorus) {
          const ratio = nutrition.calcium / nutrition.phosphorus;
          if (ratio < 1.5 || ratio > 2.5) {
            const deviation = ratio < 1.5 ? 1.5 - ratio : ratio - 2.5;
            score -= Math.min(deviation * 25, 30);
          }
        }
        
        const breed = (pet.breed || '').toLowerCase();
        // Macaws and African Greys need higher fat (nuts)
        const highFatNeeds = ['macaw', 'grey', 'african grey'].some(b => breed.includes(b));
        
        if (highFatNeeds) {
           if (nutrition.fat < 10) score -= 10; // Penalty for low fat in large parrots
        } else {
           // Small birds (parakeets)
           if (nutrition.fat > 12) score -= 5; // Penalty for too much fat
        }

        if ((recipe.ingredients || []).length < 3) {
          score -= 5;
        }
        break;
      }
      case 'reptile': {
        if (nutrition.calcium && nutrition.phosphorus) {
          const ratio = nutrition.calcium / nutrition.phosphorus;
          if (ratio < 1.5) {
            const deviation = 1.5 - ratio;
            score -= Math.min(deviation * 25, 30);
          }
        }
        // Expanded Herbivore/carnivore heuristic
        const breed = (pet.breed || '').toLowerCase();
        const herbivore = ['iguana', 'tortoise', 'uromastyx'].some(b => breed.includes(b));
        // Add 'boa', 'python', 'king' for snakes
        const carnivore = ['snake', 'monitor', 'tegu', 'boa', 'python', 'king'].some(b => breed.includes(b));
        
        if (herbivore && nutrition.protein > 25) score -= 12;
        // Carnivores need HIGH protein
        if (carnivore) {
            if (nutrition.protein < 30) score -= 15;
            if (nutrition.fat < 10) score -= 5;
        } 
        break;
      }
      case 'pocket-pet': {
        const breed = (pet.breed || '').toLowerCase();
        
        // Check Ca:P ratio (critical for all pocket-pets)
        if (nutrition.calcium && nutrition.phosphorus) {
          const ratio = nutrition.calcium / nutrition.phosphorus;
          if (ratio < 1.5 || ratio > 2.5) {
            const deviation = ratio < 1.5 ? 1.5 - ratio : ratio - 2.5;
            score -= Math.min(deviation * 20, 25);
          }
        }
        
        // Sugar gliders & omnivores need less fiber than rabbits
        const isLowFiber = ['sugar', 'glider', 'hamster', 'rat', 'mouse', 'ferret'].some(b => breed.includes(b));
        const isHayEater = ['rabbit', 'guinea', 'chinchilla'].some(b => breed.includes(b));
        
        if (isLowFiber) {
            // They need protein/fruit, not hay
            if (nutrition.fiber > 10) score -= 8; // Increased penalty
            if (nutrition.protein < 12) score -= 15; // Increased penalty
            // Ferrets are obligate carnivores - need very high protein
            if (breed.includes('ferret') && nutrition.protein < 30) {
              score -= 20;
            }
        } else if (isHayEater) {
            // Rabbits/Guinea Pigs (Hay eaters) - need high fiber
            if (nutrition.fiber < 15) {
              score -= Math.min((15 - nutrition.fiber) * 2.5, 25); // Increased penalty
            }
            if (nutrition.protein > 20) {
              score -= Math.min((nutrition.protein - 20) * 2, 20);
            }
        } else {
            // Generic pocket-pet validation
            if (nutrition.protein < 10) score -= 12;
            if (nutrition.fiber > 20) score -= 8;
        }
        break;
      }
      default:
        // Unknown species - apply basic validation
        if (nutrition.protein < 10) {
          score -= 10;
        }
        if (nutrition.calcium && nutrition.phosphorus) {
          const ratio = nutrition.calcium / nutrition.phosphorus;
          if (ratio < 1.0 || ratio > 3.0) {
            score -= 15;
          }
        }
        break;
    }
  }

  // Data quality penalty for limited nutrition info (softer)
  if (!nutrition.hasData) {
    score -= 15;
  } else if (nutrition.dataPoints !== undefined && nutrition.totalIngredients !== undefined) {
    const coverage = nutrition.totalIngredients
      ? (nutrition.dataPoints / nutrition.totalIngredients) * 100
      : 0;
    if (coverage < 30) {
      score -= 20;
    } else if (coverage < 50) {
      score -= 12;
    } else if (coverage < 70) {
      score -= 5;
    }
  }

  return clamp(score, 0, 100);
}

function scoreHealthAlignment(recipe: Recipe, pet: ImprovedPet): number {
  const petConcernsArr = pet.healthConcerns || [];
  if (!petConcernsArr.length) return 90;

  const recipeConcerns = (recipe.healthConcerns || []).map(c => c.toLowerCase());
  const notSuitable = (recipe.notSuitableFor || []).map(c => c.toLowerCase());
  const petConcerns = petConcernsArr.map(c => c.toLowerCase().replace(/\s+/g, '-'));

  const critical = ['kidney-disease', 'diabetes', 'heart-disease', 'pancreatitis'];
  const important = ['allergies', 'digestive-issues', 'urinary-health'];

  let weighted = 0;
  const maxScore = petConcerns.length * 20 || 1;

  for (const concern of petConcerns) {
    const isCritical = critical.some(c => concern.includes(c));
    const isImportant = important.some(c => concern.includes(c));

    const blocked = notSuitable.some(ns => ns.includes(concern) || concern.includes(ns));
    if (blocked) {
      weighted -= isCritical ? 25 : 15;
      continue;
    }

    const supports = recipeConcerns.some(rc => rc.includes(concern) || concern.includes(rc));
    if (supports) {
      weighted += isCritical ? 15 : isImportant ? 12 : 10;
    } else {
      weighted -= isImportant ? 5 : 3;
    }
  }

  const base = 75;
  const score = base + (weighted / maxScore) * 25;
  return clamp(score, 0, 100);
}

function scoreLifeStageFit(recipe: Recipe, ageNum: number): number {
  const petAgeGroup = ageNum < 1 ? 'baby' : ageNum < 2 ? 'young' : ageNum < 7 ? 'adult' : 'senior';
  const groups = recipe.ageGroup || [];
  if (groups.length === 0 || groups.includes('all')) return 100;
  if (groups.includes(petAgeGroup)) return 100;

  const order = ['baby', 'young', 'adult', 'senior'];
  const petIdx = order.indexOf(petAgeGroup);
  const recipeIdxs = groups.map(g => order.indexOf(g)).filter(i => i >= 0);
  if (!recipeIdxs.length) return 60;
  const distance = Math.min(...recipeIdxs.map(i => Math.abs(petIdx - i)));
  if (distance === 1) return 75;
  if (distance === 2) return 60;
  return 45;
}

function scoreAllergenSafety(recipe: Recipe, pet: ImprovedPet): number {
  const allergens = [
    ...((pet.allergies || []) as string[]),
    ...((pet.dietaryRestrictions || []) as string[]).filter(r =>
      ['chicken', 'beef', 'dairy', 'wheat', 'egg', 'fish', 'pork', 'soy', 'corn', 'lamb'].some(a =>
        r.toLowerCase().includes(a)
      )
    ),
  ];
  if (!allergens.length) return 100;

  const ingredientText = (recipe.ingredients || [])
    .map(i => (typeof i === 'string' ? i : i.name).toLowerCase())
    .join(' ');

  const hits = allergens.filter(a => ingredientText.includes(a.toLowerCase()));
  if (!hits.length) return 100;

  const penalty = hits.length === 1 ? 15 : hits.length === 2 ? 30 : hits.length === 3 ? 50 : 70;
  return Math.max(0, 100 - penalty);
}

function scoreDigestibility(recipe: Recipe, species: string): number {
  const ingredients = recipe.ingredients || [];
  if (!ingredients.length) return 50;

  let total = 0;
  let count = 0;

  for (const ing of ingredients) {
    const name = typeof ing === 'string' ? ing : ing.name;
    const key = name.toLowerCase().replace(/\s+/g, '_');
    const comp = getIngredientComposition(key);

    if (comp) {
      if (comp.protein && comp.protein > 15) total += 20;
      if (comp.fiber !== undefined) {
        if (species === 'dog' || species === 'cat') {
          // Dogs and cats: moderate fiber (2-5%) is ideal
          if (comp.fiber >= 2 && comp.fiber <= 5) {
            total += 15;
          } else if (comp.fiber > 10) {
            total -= 10; // Too much fiber for carnivores
          }
        } else if (species === 'bird') {
          // Birds: low to moderate fiber (2-8%) is ideal
          if (comp.fiber >= 2 && comp.fiber <= 8) {
            total += 12;
          } else if (comp.fiber > 15) {
            total -= 8; // Too much fiber for birds
          }
        } else if (species === 'reptile') {
          // Reptiles: fiber needs vary by type, but generally low
          if (comp.fiber > 10) {
            total -= 5; // Most reptiles need low fiber
          }
        } else if (species === 'pocket-pet') {
          // Pocket-pets: fiber needs vary dramatically
          // Hay eaters (rabbits, guinea pigs) need high fiber
          // Omnivores (hamsters, rats) need moderate fiber
          // Carnivores (ferrets) need very low fiber
          if (comp.fiber >= 5 && comp.fiber <= 20) {
            total += 10; // Acceptable range for most pocket-pets
          } else if (comp.fiber > 25) {
            total -= 5; // May be too high for some
          }
        } else {
          // Unknown species: generic handling
          if (comp.fiber > 10) {
            total -= 5;
          }
        }
      }
      if (comp.fat && comp.fat > 0) {
        // Fat digestibility varies by species
        if (species === 'dog' || species === 'cat') {
          total += comp.fat > 10 ? 5 : 10;
        } else if (species === 'bird') {
          // Birds can handle moderate fat
          total += comp.fat > 15 ? 3 : 8;
        } else if (species === 'reptile') {
          // Reptiles generally need lower fat
          total += comp.fat > 8 ? 2 : 6;
        } else if (species === 'pocket-pet') {
          // Pocket-pets vary: ferrets need high fat, rabbits need low
          total += comp.fat > 10 ? 3 : 7;
        } else {
          total += comp.fat > 10 ? 5 : 10;
        }
      }
    } else {
      total += 5; // unknown = modest neutral
    }
    count++;
  }

  return clamp((total / Math.max(1, count)) * 5, 0, 100);
}

function scoreIngredientVariety(recipe: Recipe): number {
  const ingredients = recipe.ingredients || [];
  if (!ingredients.length) return 50;

  const categories = {
    protein: ['chicken', 'beef', 'fish', 'turkey', 'egg', 'meat', 'lamb', 'pork'],
    vegetable: ['carrot', 'spinach', 'kale', 'broccoli', 'pumpkin', 'squash', 'zucchini'],
    fruit: ['apple', 'berry', 'banana', 'melon', 'pear'],
    grain: ['rice', 'oat', 'quinoa', 'barley', 'corn', 'wheat'],
    fat: ['oil', 'butter', 'tallow', 'lard', 'flax', 'omega'],
    supplement: ['vitamin', 'mineral', 'calcium', 'taurine', 'supplement'],
  };

  const found = new Set<string>();
  for (const ing of ingredients) {
    const name = (typeof ing === 'string' ? ing : ing.name).toLowerCase();
    for (const [cat, terms] of Object.entries(categories)) {
      if (terms.some(t => name.includes(t))) {
        found.add(cat);
      }
    }
  }

  const categoriesUsed = found.size;
  let score = 30 + categoriesUsed * 12; // 3 cats => 66, 5 => 90
  if (ingredients.length < 4) {
    score -= 15;
  } else if (ingredients.length > 10) {
    score += 5;
  }
  return clamp(score, 0, 100);
}

// ------------------ Helpers ------------------ //

function calcNutrition(recipe: Recipe) {
  const ingredients = recipe.ingredients || [];
  let totalProtein = 0;
  let totalFat = 0;
  let totalCa = 0;
  let totalP = 0;
  let totalFiber = 0;
  let totalWeight = 0;
  let realData = 0;

  for (const ing of ingredients) {
    const name = typeof ing === 'string' ? ing : ing.name;
    const amount = typeof ing === 'string'
      ? 100
      : ing.amount
      ? parseFloat(String(ing.amount).replace(/[^0-9.]/g, '')) || 0
      : 0;
    const comp = getIngredientComposition(name.toLowerCase().replace(/\s+/g, '_'));
    if (comp && comp.protein !== undefined) {
      totalProtein += (comp.protein || 0) * (amount / 100);
      totalFat += (comp.fat || 0) * (amount / 100);
      totalCa += (comp.calcium || 0) * (amount / 100);
      totalP += (comp.phosphorus || 0) * (amount / 100);
      totalFiber += (comp.fiber || 0) * (amount / 100);
      totalWeight += amount;
      realData++;
    }
  }

  return {
    protein: totalWeight ? (totalProtein / totalWeight) * 100 : 25,
    fat: totalWeight ? (totalFat / totalWeight) * 100 : 15,
    calcium: totalWeight ? (totalCa / totalWeight) * 100 : 0.8,
    phosphorus: totalWeight ? (totalP / totalWeight) * 100 : 0.6,
    fiber: totalWeight ? (totalFiber / totalWeight) * 100 : 2,
    hasData: realData > 0 && totalWeight > 0,
    dataPoints: realData,
    totalIngredients: ingredients.length,
  };
}

function normalizeScore(raw: number): number {
  const n = SCORE_CONFIG.normalize;
  if (raw >= n.topKeep) return raw; // leave excellent scores alone
  if (raw >= n.topBand) return 90 + (raw - n.topBand) * 0.8; // light compression at top
  if (raw >= n.midBand) return raw; // keep solid recipes intact
  if (raw >= 50) return raw * n.lift50; // small lift to mid-low
  if (raw >= 30) return raw * n.lift30; // gentle boost to lows
  return raw * n.liftLow; // slightly more help for very low
}

function applyControlledVariation(score: number): number {
  // deterministic-ish tiny jitter: ¬±0.4 max
  const { high, mid, low } = SCORE_CONFIG.jitter;
  const range = score > 90 || score < 30 ? high : score > 70 ? mid : low;
  return (Math.random() - 0.5) * 2 * range;
}

function mapScoreToStarsWithReasoning(
  score: number,
  factors: {
    ingredientSafety: number;
    nutritionalAdequacy: number;
    healthAlignment: number;
    lifeStageFit: number;
    allergenSafety: number;
    digestibility: number;
  }
): { stars: number; recommendation: ImprovedScore['recommendation']; summaryReasoning: string } {
  // Safety overrides
  if (factors.allergenSafety < 50) {
    return {
      stars: 1,
      recommendation: 'avoid',
      summaryReasoning: 'Contains allergens for this pet',
    };
  }
  if (factors.ingredientSafety < 40) {
    return {
      stars: 1,
      recommendation: 'avoid',
      summaryReasoning: 'Unsafe ingredients detected for this species',
    };
  }

  let recommendation: ImprovedScore['recommendation'] = 'acceptable';
  if (score >= 90) recommendation = 'excellent';
  else if (score >= 80) recommendation = 'good';
  else if (score >= 70) recommendation = 'acceptable';
  else if (score >= 60) recommendation = 'caution';
  else recommendation = 'avoid';

  let summaryReasoning = 'Well-rounded recipe';
  if (score < 60) summaryReasoning = 'Significant concerns detected';
  else if (factors.nutritionalAdequacy < 65) summaryReasoning = 'Not balanced for this pet';
  else if (factors.ingredientSafety < 70) summaryReasoning = 'Ingredient safety concerns';
  else if (factors.allergenSafety < 80) summaryReasoning = 'Possible allergens detected';

  return {
    stars: mapScoreToStars(score),
    recommendation,
    summaryReasoning,
  };
}

function mapScoreToStars(score: number): number {
  if (score >= 90) return 5;
  if (score >= 75) return 4;
  if (score >= 55) return 3;
  if (score >= 30) return 2;
  return 1;
}

function clamp(val: number, min: number, max: number) {
  return Math.min(max, Math.max(min, val));
}
</file>

<file path="lib/utils/ingredientCompatibility.ts">
// lib/utils/ingredientCompatibility.ts
// Utility functions for checking ingredient compatibility with species

import { INGREDIENT_COMPOSITIONS, type SpeciesCompatibility, type FeedingRole } from '@/lib/data/ingredientCompositions';
import { getIngredientComposition } from '@/lib/data/ingredientCompositions';

export type Species = 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';

/**
 * Normalize species string to standard format
 */
export function normalizeSpecies(species: string): Species | string {
  const s = (species || '').toLowerCase();
  if (s.includes('dog')) return 'dog';
  if (s.includes('cat')) return 'cat';
  if (s.includes('bird') || s.includes('parrot') || s.includes('finch')) return 'bird';
  if (s.includes('reptile') || s.includes('lizard') || s.includes('bearded') || s.includes('dragon')) return 'reptile';
  if (s.includes('pocket') || s.includes('rabbit') || s.includes('guinea') || s.includes('hamster') || s.includes('gerbil')) return 'pocket-pet';
  return s;
}

/**
 * Get species compatibility for an ingredient
 */
export function getSpeciesCompatibility(ingredientKey: string, species: string): SpeciesCompatibility | null {
  const normalizedSpecies = normalizeSpecies(species);
  const composition = getIngredientComposition(ingredientKey);
  
  if (!composition?.speciesCompatibility) return null;
  
  return composition.speciesCompatibility[normalizedSpecies as keyof typeof composition.speciesCompatibility] || null;
}

/**
 * Get max inclusion percentage for an ingredient by species
 */
export function getMaxInclusionPercent(ingredientKey: string, species: string): number | null {
  const normalizedSpecies = normalizeSpecies(species);
  const composition = getIngredientComposition(ingredientKey);
  
  if (!composition?.maxInclusionPercentBySpecies) return null;
  
  return composition.maxInclusionPercentBySpecies[normalizedSpecies as keyof typeof composition.maxInclusionPercentBySpecies] || null;
}

/**
 * Get species-specific notes for an ingredient
 */
export function getSpeciesNotes(ingredientKey: string, species: string): string | null {
  const normalizedSpecies = normalizeSpecies(species);
  const composition = getIngredientComposition(ingredientKey);
  
  if (!composition?.notesBySpecies) return null;
  
  return composition.notesBySpecies[normalizedSpecies as keyof typeof composition.notesBySpecies] || null;
}

/**
 * Get feeding role for an ingredient
 */
export function getFeedingRole(ingredientKey: string): FeedingRole | null {
  const composition = getIngredientComposition(ingredientKey);
  return composition?.feedingRole || null;
}

/**
 * Check if ingredient is compatible with species
 */
export function isCompatible(ingredientKey: string, species: string): boolean {
  const compat = getSpeciesCompatibility(ingredientKey, species);
  return compat === 'ok' || compat === 'limit' || compat === 'caution';
}

/**
 * Check if ingredient should be avoided for species
 */
export function shouldAvoid(ingredientKey: string, species: string): boolean {
  const compat = getSpeciesCompatibility(ingredientKey, species);
  return compat === 'avoid';
}

/**
 * Check if ingredient should be limited for species
 */
export function shouldLimit(ingredientKey: string, species: string): boolean {
  const compat = getSpeciesCompatibility(ingredientKey, species);
  return compat === 'limit' || compat === 'caution';
}
</file>

<file path="lib/utils/ingredientNameNormalizer.ts">
// Centralized ingredient name normalization
// Maps between display names, composition keys, and price lookup names

const INGREDIENT_NAME_MAP: Record<string, {
  display: string;
  compositionKey: string;
  priceKey: string;
}> = {
  // Proteins
  'ground chicken': {
    display: 'ground chicken',
    compositionKey: 'ground_chicken',
    priceKey: 'ground chicken'
  },
  'ground turkey': {
    display: 'ground turkey',
    compositionKey: 'ground_turkey',
    priceKey: 'ground turkey'
  },
  'ground beef (lean)': {
    display: 'ground beef (lean)',
    compositionKey: 'ground_beef_lean',
    priceKey: 'ground beef (lean)'
  },
  'ground lamb': {
    display: 'ground lamb',
    compositionKey: 'ground_lamb',
    priceKey: 'ground lamb'
  },
  'salmon (boneless)': {
    display: 'salmon (boneless)',
    compositionKey: 'salmon_atlantic',
    priceKey: 'salmon (boneless)'
  },
  'chicken breast': {
    display: 'chicken breast',
    compositionKey: 'chicken_breast',
    priceKey: 'chicken breast'
  },
  'chicken thighs': {
    display: 'chicken thighs',
    compositionKey: 'chicken_thighs',
    priceKey: 'chicken thighs'
  },
  'turkey breast': {
    display: 'turkey breast',
    compositionKey: 'turkey_breast',
    priceKey: 'turkey breast'
  },
  'beef liver': {
    display: 'beef liver',
    compositionKey: 'beef_liver',
    priceKey: 'beef liver'
  },
  'chicken liver': {
    display: 'chicken liver',
    compositionKey: 'chicken_liver',
    priceKey: 'chicken liver'
  },
  'chicken hearts': {
    display: 'chicken hearts',
    compositionKey: 'chicken_hearts',
    priceKey: 'chicken hearts'
  },
  'sardines (canned in water)': {
    display: 'sardines (canned in water)',
    compositionKey: 'sardines_water',
    priceKey: 'sardines (canned in water)'
  },
  'eggs': {
    display: 'eggs',
    compositionKey: 'eggs_whole',
    priceKey: 'eggs'
  },
  'quail': {
    display: 'quail',
    compositionKey: 'quail',
    priceKey: 'quail'
  },
  'ground pork (lean)': {
    display: 'ground pork (lean)',
    compositionKey: 'ground_pork_lean',
    priceKey: 'ground pork (lean)'
  },
  'turkey necks': {
    display: 'turkey necks',
    compositionKey: 'turkey_necks',
    priceKey: 'turkey necks'
  },
  'tuna': {
    display: 'tuna',
    compositionKey: 'tuna_water',
    priceKey: 'tuna'
  },

  // Carbs
  'brown rice': {
    display: 'brown rice',
    compositionKey: 'brown_rice_cooked',
    priceKey: 'brown rice'
  },
  'white rice': {
    display: 'white rice',
    compositionKey: 'white_rice_cooked',
    priceKey: 'white rice'
  },
  'quinoa': {
    display: 'quinoa',
    compositionKey: 'quinoa_cooked',
    priceKey: 'quinoa'
  },
  'sweet potato': {
    display: 'sweet potato',
    compositionKey: 'sweet_potato',
    priceKey: 'sweet potato'
  },
  'oats': {
    display: 'oats',
    compositionKey: 'oats',
    priceKey: 'oats'
  },
  'pumpkin': {
    display: 'pumpkin',
    compositionKey: 'pumpkin',
    priceKey: 'pumpkin'
  },
  'lentils': {
    display: 'lentils',
    compositionKey: 'lentils',
    priceKey: 'lentils'
  },
  'chickpeas': {
    display: 'chickpeas',
    compositionKey: 'chickpeas',
    priceKey: 'chickpeas'
  },
  'black beans': {
    display: 'black beans',
    compositionKey: 'black_beans',
    priceKey: 'black beans'
  },
  'green peas': {
    display: 'green peas',
    compositionKey: 'green_peas',
    priceKey: 'green peas'
  },

  // Vegetables
  'carrots': {
    display: 'carrots',
    compositionKey: 'carrots_raw',
    priceKey: 'carrots'
  },
  'green beans': {
    display: 'green beans',
    compositionKey: 'green_beans_raw',
    priceKey: 'green beans'
  },
  'spinach': {
    display: 'spinach',
    compositionKey: 'spinach_raw',
    priceKey: 'spinach'
  },
  'broccoli': {
    display: 'broccoli',
    compositionKey: 'broccoli_raw',
    priceKey: 'broccoli'
  },
  'zucchini': {
    display: 'zucchini',
    compositionKey: 'zucchini',
    priceKey: 'zucchini'
  },
  'kale': {
    display: 'kale',
    compositionKey: 'kale_raw',
    priceKey: 'kale'
  },
  'celery': {
    display: 'celery',
    compositionKey: 'celery_raw',
    priceKey: 'celery'
  },
  'brussels sprouts': {
    display: 'brussels sprouts',
    compositionKey: 'brussels_sprouts',
    priceKey: 'brussels sprouts'
  },
  'asparagus': {
    display: 'asparagus',
    compositionKey: 'asparagus',
    priceKey: 'asparagus'
  },
  'parsley': {
    display: 'parsley',
    compositionKey: 'parsley',
    priceKey: 'parsley'
  },
  'cucumber': {
    display: 'cucumber',
    compositionKey: 'celery_raw',
    priceKey: 'cucumber'
  },
  'lettuce (romaine)': {
    display: 'lettuce (romaine)',
    compositionKey: 'lettuce_romaine',
    priceKey: 'lettuce (romaine)'
  },
  'arugula': {
    display: 'arugula',
    compositionKey: 'arugula',
    priceKey: 'arugula'
  },
  'bok choy': {
    display: 'bok choy',
    compositionKey: 'bok_choy',
    priceKey: 'bok choy'
  },

  // Fruits
  'blueberries': {
    display: 'blueberries',
    compositionKey: 'blueberries_raw',
    priceKey: 'blueberries'
  },
  'bananas': {
    display: 'bananas',
    compositionKey: 'bananas_raw',
    priceKey: 'bananas'
  },

  // Additional proteins
  'turkey giblets': {
    display: 'turkey giblets',
    compositionKey: 'turkey_giblets',
    priceKey: 'turkey giblets'
  },
  'chicken giblets': {
    display: 'chicken giblets',
    compositionKey: 'chicken_giblets',
    priceKey: 'chicken giblets'
  },
  'duck breast': {
    display: 'duck breast',
    compositionKey: 'duck_breast',
    priceKey: 'duck breast'
  },
  'venison': {
    display: 'venison',
    compositionKey: 'venison',
    priceKey: 'venison'
  },
  'rabbit meat': {
    display: 'rabbit meat',
    compositionKey: 'rabbit_meat',
    priceKey: 'rabbit meat'
  },

  // Additional carbs
  'barley': {
    display: 'barley',
    compositionKey: 'barley',
    priceKey: 'barley'
  },
  'butternut squash': {
    display: 'butternut squash',
    compositionKey: 'butternut_squash',
    priceKey: 'butternut squash'
  },
  'acorn squash': {
    display: 'acorn squash',
    compositionKey: 'acorn_squash',
    priceKey: 'acorn squash'
  },

  // Additional vegetables
  'bell peppers': {
    display: 'bell peppers',
    compositionKey: 'bell_peppers',
    priceKey: 'bell peppers'
  },
  'bell peppers (red/green)': {
    display: 'bell peppers (red/green)',
    compositionKey: 'bell_peppers',
    priceKey: 'bell peppers'
  },
  'peas': {
    display: 'peas',
    compositionKey: 'peas',
    priceKey: 'peas'
  },
  'endive': {
    display: 'endive',
    compositionKey: 'endive',
    priceKey: 'endive'
  },
  'collard greens': {
    display: 'collard greens',
    compositionKey: 'collard_greens',
    priceKey: 'collard greens'
  },
  'mustard greens': {
    display: 'mustard greens',
    compositionKey: 'mustard_greens',
    priceKey: 'mustard greens'
  },
  'swiss chard': {
    display: 'swiss chard',
    compositionKey: 'swiss_chard',
    priceKey: 'swiss chard'
  },
  'cauliflower': {
    display: 'cauliflower',
    compositionKey: 'cauliflower',
    priceKey: 'cauliflower'
  },

  // Oils and fats
  'salmon oil': {
    display: 'salmon oil',
    compositionKey: 'salmon_oil',
    priceKey: 'salmon oil'
  },
  'fish oil': {
    display: 'fish oil',
    compositionKey: 'fish_oil',
    priceKey: 'fish oil'
  },
  'cod liver oil': {
    display: 'cod liver oil',
    compositionKey: 'cod_liver_oil',
    priceKey: 'cod liver oil'
  },
  'coconut oil': {
    display: 'coconut oil',
    compositionKey: 'coconut_oil',
    priceKey: 'coconut oil'
  },
  'olive oil': {
    display: 'olive oil',
    compositionKey: 'olive_oil',
    priceKey: 'olive oil'
  },

  // Supplements
  'calcium carbonate': {
    display: 'calcium carbonate',
    compositionKey: 'calcium_carbonate',
    priceKey: 'calcium carbonate'
  },
  'taurine powder': {
    display: 'taurine powder',
    compositionKey: 'taurine_powder',
    priceKey: 'taurine powder'
  },
};

export function getCompositionKey(displayName: string): string {
  const normalized = displayName.toLowerCase().trim();
  const mapping = INGREDIENT_NAME_MAP[normalized];
  if (mapping) {
    return mapping.compositionKey;
  }
  // Fallback: normalize to underscore format (handles unmapped ingredients)
  return normalized
    .replace(/\s*\([^)]*\)/g, '')
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');
}

export function getPriceKey(displayName: string): string {
  const normalized = displayName.toLowerCase().trim();
  const mapping = INGREDIENT_NAME_MAP[normalized];
  if (mapping) {
    return mapping.priceKey;
  }
  // Fallback: use lowercase version for price lookup
  return normalized;
}

export function getDisplayName(compositionKeyOrPrice: string): string {
  const normalized = compositionKeyOrPrice.toLowerCase().trim();
  // Search through map for matching composition key or price key
  for (const [display, mapping] of Object.entries(INGREDIENT_NAME_MAP)) {
    if (mapping.compositionKey === normalized || mapping.priceKey === normalized) {
      return mapping.display;
    }
  }
  // Fallback: convert underscore format back to display format
  return normalized
    .replace(/_/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
</file>

<file path="lib/utils/ingredientRegistry.ts">
// lib/utils/ingredientRegistry.ts
// Utility functions for accessing the unified ingredient registry
// Provides convenient accessors and normalization functions

import {
  getIngredientById,
  getIngredientByName,
  normalizeIngredientName,
  getIngredientsForSpecies,
  getIngredientsByCategory,
  getAllIngredients,
  searchIngredients,
  type UnifiedIngredient,
  type Species,
  type IngredientCategory,
} from '../data/unifiedIngredientRegistry';

// Re-export types and functions for convenience
export {
  getIngredientById,
  getIngredientByName,
  normalizeIngredientName,
  getIngredientsForSpecies,
  getIngredientsByCategory,
  getAllIngredients,
  searchIngredients,
  type UnifiedIngredient,
  type Species,
  type IngredientCategory,
};

/**
 * Convert between different ingredient name formats
 */
export function convertIngredientName(
  name: string,
  targetFormat: 'id' | 'display' | 'normalized'
): string {
  const ingredient = getIngredientByName(name);
  
  if (!ingredient) {
    // If not found, return normalized version
    if (targetFormat === 'id' || targetFormat === 'normalized') {
      return normalizeIngredientName(name);
    }
    return name; // Return original for display
  }
  
  switch (targetFormat) {
    case 'id':
      return ingredient.id;
    case 'display':
      return ingredient.primaryDisplayName;
    case 'normalized':
      return ingredient.id;
    default:
      return name;
  }
}

/**
 * Check if an ingredient name matches any known ingredient (fuzzy)
 */
export function isKnownIngredient(name: string): boolean {
  return getIngredientByName(name) !== null;
}

/**
 * Get all display name variations for an ingredient
 */
export function getIngredientNameVariations(name: string): string[] {
  const ingredient = getIngredientByName(name);
  return ingredient?.displayNames || [name];
}

/**
 * Find best matching ingredient name from a list of candidates
 */
export function findBestMatch(
  query: string,
  candidates: string[]
): string | null {
  const normalizedQuery = normalizeIngredientName(query);
  const queryIngredient = getIngredientByName(query);
  
  if (!queryIngredient) {
    return null;
  }
  
  // Find candidate that matches the same ingredient
  for (const candidate of candidates) {
    const candidateIngredient = getIngredientByName(candidate);
    if (candidateIngredient && candidateIngredient.id === queryIngredient.id) {
      return candidate;
    }
  }
  
  return null;
}

/**
 * Get nutrition data for an ingredient (with fallback)
 */
export function getIngredientNutrition(name: string) {
  const ingredient = getIngredientByName(name);
  return ingredient?.nutrition || null;
}

/**
 * Check if ingredient is compatible with species
 */
export function isIngredientCompatibleWithSpecies(
  name: string,
  species: Species
): boolean {
  const ingredient = getIngredientByName(name);
  if (!ingredient) return false;
  
  const compat = ingredient.speciesCompatibility[species];
  return compat === 'ok' || compat === 'limit' || compat === 'caution';
}

/**
 * Check if ingredient should be avoided for species
 */
export function shouldAvoidIngredient(name: string, species: Species): boolean {
  const ingredient = getIngredientByName(name);
  if (!ingredient) return false;
  
  const compat = ingredient.speciesCompatibility[species];
  return compat === 'avoid';
}

/**
 * Get vetted products for an ingredient
 */
export function getIngredientVettedProducts(name: string) {
  const ingredient = getIngredientByName(name);
  return ingredient?.vettedProducts || [];
}
</file>

<file path="lib/utils/ingredientSuggestions.ts">
// lib/utils/ingredientSuggestions.ts
// Generate ingredient suggestions based on pet profile

import { ALL_INGREDIENTS } from './allIngredients';

export interface SuggestedIngredient {
  name: string;
  reason: string;
  category: string;
}

interface PetProfile {
  type: string;
  age?: string;
  healthConcerns?: string[];
  breed?: string;
}

export function generateIngredientSuggestions(pet: PetProfile): SuggestedIngredient[] {
  if (!pet) return [];
  
  const suggestions: SuggestedIngredient[] = [];
  const normalizedSpecies = pet.type === 'dog' ? 'dogs' : 
                           pet.type === 'cat' ? 'cats' :
                           pet.type === 'bird' ? 'birds' :
                           pet.type === 'reptile' ? 'reptiles' :
                           pet.type === 'pocket-pet' ? 'pocket-pets' : pet.type;
  
  const speciesData = ALL_INGREDIENTS[normalizedSpecies as keyof typeof ALL_INGREDIENTS];
  if (!speciesData) return [];

  const healthConcerns = (pet.healthConcerns || []).map(hc => hc.toLowerCase());
  const age = pet.age?.toLowerCase() || '';

  // Safe property access helper
  const getProperty = <T>(obj: any, key: string, defaultValue: T[] = []): T[] => {
    return (key in obj ? obj[key] : defaultValue) || defaultValue;
  };

  const addUnique = (name: string, reason: string, category: string) => {
    if (suggestions.some((s) => s.name === name)) return;
    suggestions.push({ name, reason, category });
  };

  const proteins = getProperty<string>(speciesData, 'proteins');
  const vegetables = getProperty<string>(speciesData, 'vegetables');
  const carbs = getProperty<string>(speciesData, 'carbs');
  const fruits = getProperty<string>(speciesData, 'fruits');
  const fats = getProperty<string>(speciesData, 'fats');
  const supplements = getProperty<string>(speciesData, 'supplements');
  const insects = getProperty<string>(speciesData, 'insects');
  const hay = getProperty<string>(speciesData, 'hay');
  const seeds = getProperty<string>(speciesData, 'seeds');
  const pellets = getProperty<string>(speciesData, 'pellets');

  // Species-specific essentials
  if (normalizedSpecies === 'cats') {
    // Taurine is essential for cats
    if (supplements.includes('Taurine Powder')) {
      suggestions.push({
        name: 'Taurine Powder',
        reason: 'Essential amino acid required for cats - supports heart and eye health',
        category: 'Supplements'
      });
    }
    // High-taurine proteins
    if (proteins.includes('Chicken Liver')) {
      suggestions.push({
        name: 'Chicken Liver',
        reason: 'Rich in taurine and essential nutrients for cats',
        category: 'Proteins'
      });
    }
  }

  if (normalizedSpecies === 'reptiles') {
    // Calcium is essential for reptiles
    if (vegetables.includes('Collard Greens')) {
      suggestions.push({
        name: 'Collard Greens',
        reason: 'High in calcium - essential for bone health in reptiles',
        category: 'Greens & Veggies'
      });
    }
    // Insects for protein
    if (insects.includes('Dubia Roaches')) {
      suggestions.push({
        name: 'Dubia Roaches',
        reason: 'Excellent protein source with ideal calcium-to-phosphorus ratio',
        category: 'Proteins'
      });
    }
  }

  if (normalizedSpecies === 'pocket-pets') {
    // Hay is essential
    if (hay.includes('Timothy Hay')) {
      suggestions.push({
        name: 'Timothy Hay',
        reason: 'Essential fiber source for digestive health',
        category: 'Hay'
      });
    }
    // Vitamin C rich vegetables
    if (vegetables.includes('Bell Peppers (high vitamin C)')) {
      suggestions.push({
        name: 'Bell Peppers (high vitamin C)',
        reason: 'High in vitamin C - essential for guinea pigs and other pocket pets',
        category: 'Greens & Veggies'
      });
    }
  }

  // Age-based suggestions
  if (age.includes('baby') || age.includes('puppy') || age.includes('kitten')) {
    if (proteins.includes('Ground Chicken')) {
      suggestions.push({
        name: 'Ground Chicken',
        reason: 'Easy to digest protein perfect for growing pets',
        category: 'Proteins'
      });
    }
    if (carbs.includes('Sweet Potato') || carbs.includes('Sweet Potato (cooked)')) {
      suggestions.push({
        name: carbs.includes('Sweet Potato') ? 'Sweet Potato' : 'Sweet Potato (cooked)',
        reason: 'Gentle on developing digestive systems and rich in nutrients',
        category: 'Grains & Carbs'
      });
    }
  }

  if (age.includes('senior')) {
    if (supplements.includes('Glucosamine Sulfate')) {
      suggestions.push({
        name: 'Glucosamine Sulfate',
        reason: 'Supports joint health in older pets',
        category: 'Supplements'
      });
    }
    if (fats.includes('Fish Oil') || supplements.includes('Fish Oil')) {
      suggestions.push({
        name: 'Fish Oil',
        reason: 'Omega-3 fatty acids support brain and joint health in seniors',
        category: 'Supplements'
      });
    }
  }

  // Health concern-based suggestions
  if (healthConcerns.some(hc => hc.includes('kidney') || hc.includes('urinary'))) {
    if (vegetables.includes('Green Beans') || vegetables.includes('Green Beans (cooked)')) {
      suggestions.push({
        name: vegetables.includes('Green Beans') ? 'Green Beans' : 'Green Beans (cooked)',
        reason: 'Low in phosphorus - ideal for kidney support',
        category: 'Greens & Veggies'
      });
    }
    if (normalizedSpecies === 'cats' && supplements.includes('Cranberry Extract')) {
      suggestions.push({
        name: 'Cranberry Extract',
        reason: 'Supports urinary tract health',
        category: 'Supplements'
      });
    }
  }

  if (healthConcerns.some(hc => hc.includes('joint') || hc.includes('mobility'))) {
    if (supplements.includes('Glucosamine Sulfate')) addUnique('Glucosamine Sulfate', 'Supports joint cartilage and mobility', 'Supplements');
    if (fats.includes('Fish Oil') || supplements.includes('Fish Oil')) addUnique('Fish Oil', 'Anti-inflammatory omega-3s help reduce joint inflammation', 'Supplements');
  }

  if (healthConcerns.some(hc => hc.includes('weight') || hc.includes('obesity'))) {
    if (proteins.includes('Ground Turkey')) {
      addUnique('Ground Turkey', 'Lean protein helps maintain muscle while managing weight', 'Proteins');
    }
    if (vegetables.includes('Green Beans') || vegetables.includes('Green Beans (cooked)')) {
      addUnique(vegetables.includes('Green Beans') ? 'Green Beans' : 'Green Beans (cooked)', 'Low calorie, high fiber - helps with satiety', 'Greens & Veggies');
    }
  }

  if (healthConcerns.some(hc => hc.includes('digestive') || hc.includes('gi'))) {
    if (carbs.includes('Pumpkin Puree') || carbs.includes('Pumpkin Puree (small amounts)')) {
      addUnique(carbs.includes('Pumpkin Puree') ? 'Pumpkin Puree' : 'Pumpkin Puree (small amounts)', 'Soluble fiber helps regulate digestion', 'Grains & Carbs');
    }
    if (supplements.includes('Probiotic Powder')) {
      addUnique('Probiotic Powder', 'Supports healthy gut bacteria and digestive function', 'Supplements');
    }
  }

  if (healthConcerns.some(hc => hc.includes('skin') || hc.includes('coat'))) {
    if (fats.includes('Salmon Oil') || supplements.includes('Salmon Oil')) {
      addUnique('Salmon Oil', 'Omega-3 fatty acids promote healthy skin and shiny coat', 'Supplements');
    }
    const salmonOptions = proteins.filter(p => p.toLowerCase().includes('salmon'));
    if (salmonOptions.length > 0) {
      addUnique(salmonOptions[0], 'Rich in omega-3s for healthy skin and coat', 'Proteins');
    }
  }

  // Baseline species recommendations to ensure multiple options
  if (normalizedSpecies === 'dogs') {
    addUnique('Chicken Breast', 'Lean, versatile protein for most dogs', 'Proteins');
    addUnique('Brown Rice', 'Gentle carb to mix meals', 'Grains & Carbs');
    addUnique('Carrots', 'Great source of beta-carotene and fiber for dogs', 'Greens & Veggies');
  }

  if (normalizedSpecies === 'cats') {
    const sardineOptions = proteins.filter(p => p.toLowerCase().includes('sardine'));
    if (sardineOptions.length > 0) {
      addUnique(sardineOptions[0], 'High in taurine and omega-3s - excellent for cats', 'Proteins');
    }
    addUnique('Chicken Liver', 'Taurine-rich organ meat for cats', 'Proteins');
    addUnique('Pumpkin Puree (small amounts)', 'Fiber to help digestion', 'Grains & Carbs');
  }

  if (normalizedSpecies === 'birds') {
    addUnique('Millet (white/red)', 'Staple seed birds readily accept', 'Seeds');
    addUnique('Carrots (grated)', 'Vitamin A-rich veggie for birds', 'Greens & Veggies');
    addUnique('Apples (no seeds)', 'Common fruit treat (seed-free)', 'Fruits');
  }

  if (normalizedSpecies === 'reptiles') {
    addUnique('Collard Greens', 'High-calcium staple green', 'Greens & Veggies');
    addUnique('Dubia Roaches', 'Staple insect protein with good Ca:P', 'Proteins');
    addUnique('Blueberries', 'Occasional fruit treat many reptiles accept', 'Fruits');
  }

  if (normalizedSpecies === 'pocket-pets') {
    addUnique('Timothy Hay', 'Essential daily fiber source', 'Hay');
    addUnique('Bell Peppers (high vitamin C)', 'Vitamin C boost for pocket pets', 'Greens & Veggies');
    addUnique('Carrots', 'Crunchy, familiar veggie treat', 'Greens & Veggies');
  }

  // Remove duplicates and keep a healthy list (up to 12)
  const unique = suggestions.filter((sug, idx, self) =>
    idx === self.findIndex(s => s.name === sug.name)
  );

  return unique.slice(0, 12);
}
</file>

<file path="lib/utils/ingredientWhitelists.ts">
// lib/utils/ingredientWhitelists.ts
// Species-specific ingredient whitelists for safe meal building
// This provides a curated "safe" list per species to prevent dangerous combinations
// Now uses global ingredient pool + subtype-based normalization

import { getIngredientComposition, INGREDIENT_COMPOSITIONS, type SpeciesCompatibility } from '@/lib/data/ingredientCompositions';
import { ALL_INGREDIENTS } from './allIngredients';
import { GLOBAL_INGREDIENTS, type GlobalIngredient } from '@/lib/data/globalIngredients';

export type Species = 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
export type ReptileType = 'herbivore' | 'insectivore' | 'omnivore';
export type PocketPetType = 'rabbit' | 'guinea-pig' | 'hamster' | 'gerbil';
export type Subtype = 
  | 'bird_small' | 'bird_large'
  | 'reptile_herbivore' | 'reptile_insectivore' | 'reptile_omnivore' | 'reptile_carnivore'
  | 'pocket_hay' | 'pocket_varied' | 'pocket_carnivore' | 'pocket_insectivore'
  | 'dog' | 'cat';

/**
 * Normalize species + breed to subtype
 */
export function normalizeToSubtype(species: Species, breed?: string): Subtype {
  if (species === 'bird') {
    const largeBirds = ['parrot', 'cockatoo', 'african grey', 'macaw', 'conure', 'quaker'];
    const breedLower = breed?.toLowerCase() || '';
    return largeBirds.some(lb => breedLower.includes(lb)) ? 'bird_large' : 'bird_small';
  }
  
  if (species === 'reptile') {
    const herbivores = ['bearded dragon', 'iguana', 'slider', 'tortoise', 'uromastyx'];
    const carnivores = ['python', 'snake', 'monitor', 'chameleon', 'corn snake', 'ball python'];
    const insectivores = ['leopard gecko', 'crested gecko', 'gecko'];
    const breedLower = breed?.toLowerCase() || '';
    
    if (herbivores.some(h => breedLower.includes(h))) return 'reptile_herbivore';
    if (carnivores.some(c => breedLower.includes(c))) return 'reptile_carnivore';
    if (insectivores.some(i => breedLower.includes(i))) return 'reptile_insectivore';
    return 'reptile_omnivore'; // Default for mixed/unknown
  }
  
  if (species === 'pocket-pet') {
    const breedLower = breed?.toLowerCase() || '';
    if (breedLower.includes('rabbit') || breedLower.includes('guinea') || breedLower.includes('chinchilla')) {
      return 'pocket_hay';
    }
    if (breedLower.includes('ferret')) {
      return 'pocket_carnivore';
    }
    if (breedLower.includes('hedgehog')) {
      return 'pocket_insectivore';
    }
    return 'pocket_varied'; // Hamster, gerbil, rat, mouse
  }
  
  return species; // dog, cat
}

/**
 * Base whitelists by subtype - these ensure we always have something to show
 */
export const BASE_WHITELISTS: Record<Subtype, string[]> = {
  bird_small: [
    'millet', 'canary_seed', 'niger_seed', 'oat_groats',
    'carrot_grated', 'broccoli', 'spinach', 'kale',
    'apple_no_seeds', 'blueberries', 'strawberries',
    'egg_hard_boiled', 'pellets_fortified', 'cuttlebone'
  ],
  bird_large: [
    // All bird_small plus:
    'quinoa_cooked', 'brown_rice_cooked', 'oats',
    'bell_peppers', 'sweet_potato_cooked', 'mango', 'papaya',
    'parrot_pellets', 'nuts_unsalted', 'pumpkin', 'carrots'
  ],
  reptile_herbivore: [
    'collard_greens', 'turnip_greens', 'dandelion_greens',
    'butternut_squash', 'bell_peppers', 'carrot_grated', 'zucchini',
    'blueberries', 'mango', 'papaya', 'strawberries',
    'calcium_carbonate', 'vitamin_d3', 'kale', 'spinach'
  ],
  reptile_insectivore: [
    'dubia_roaches', 'crickets', 'mealworms', 'superworms',
    'black_soldier_fly_larvae', 'hornworms', 'calcium_carbonate', 'waxworms'
  ],
  reptile_omnivore: [
    // Combination of herbivore + insectivore
    'collard_greens', 'dandelion_greens',
    'crickets', 'dubia_roaches', 'mealworms',
    'blueberries', 'mango', 'calcium_carbonate'
  ],
  reptile_carnivore: [
    // Placeholder - whole prey items (will need special handling)
    'whole_prey_rodent', 'whole_prey_bird', 'protein_block',
    'chicken_breast', 'ground_turkey'
  ],
  pocket_hay: [
    'timothy_hay', 'orchard_grass_hay', 'alfalfa_hay',
    'romaine_lettuce', 'bell_peppers', 'carrots', 'cucumber',
    'parsley', 'cilantro', 'guinea_pig_pellets', 'rabbit_pellets',
    'vitamin_c_supplement', 'kale', 'spinach'
  ],
  pocket_varied: [
    'hamster_pellets', 'gerbil_pellets', 'oats', 'quinoa_cooked',
    'carrots', 'broccoli', 'apple_no_seeds', 'blueberries',
    'mealworms_freeze_dried', 'sunflower_seeds_unsalted', 'pumpkin_seeds'
  ],
  pocket_carnivore: [
    'chicken_breast', 'ground_turkey', 'salmon', 'egg_whole',
    'organ_meat', 'taurine_supplement', 'heart', 'liver'
  ],
  pocket_insectivore: [
    'mealworms', 'crickets', 'waxworms', 'egg_whole',
    'insectivore_diet_powder', 'superworms'
  ],
  dog: [], // Will be populated from global pool
  cat: []  // Will be populated from global pool
};

/**
 * Get whitelist of safe ingredients for a species
 * Returns ingredient display names that are marked as 'ok' or 'limit' (not 'avoid')
 * Now uses global pool + base whitelists
 */
export function getWhitelistForSpecies(species: Species, breed?: string, subtype?: ReptileType | PocketPetType): string[] {
  const normalizedSubtype = normalizeToSubtype(species, breed);
  const whitelist: Set<string> = new Set();
  
  // 1. Add base whitelist for this subtype (ensures we always have something)
  const baseList = BASE_WHITELISTS[normalizedSubtype] || [];
  baseList.forEach(ing => whitelist.add(ing));
  
  // 2. Add from existing ALL_INGREDIENTS (backward compatibility)
  // Map species to ALL_INGREDIENTS key format
  const speciesKey = species === 'dog' ? 'dogs' : 
                     species === 'cat' ? 'cats' :
                     species === 'bird' ? 'birds' :
                     species === 'reptile' ? 'reptiles' :
                     species === 'pocket-pet' ? 'pocket-pets' : species;
  
  const speciesData = ALL_INGREDIENTS[speciesKey as keyof typeof ALL_INGREDIENTS];
  if (speciesData) {
    Object.values(speciesData).forEach(category => {
      if (Array.isArray(category)) {
        category.forEach(ingName => whitelist.add(ingName));
      }
    });
  }
  
  // 3. Add from global ingredient pool (new approach)
  Object.values(GLOBAL_INGREDIENTS).forEach(globalIng => {
    // Try to find composition data
    const compositionKey = globalIng.compositionKey || globalIng.id;
    const composition = getIngredientComposition(compositionKey);
    
    if (composition?.speciesCompatibility) {
      const compat = composition.speciesCompatibility[species];
      if (compat === 'ok' || compat === 'limit' || compat === 'caution') {
        whitelist.add(globalIng.displayName);
      }
    } else {
      // If no compatibility data but it's in global pool, include it with low confidence
      // This allows discovery of new ingredients
      if (globalIng.confidenceLevel === 'high' || globalIng.confidenceLevel === 'medium') {
        whitelist.add(globalIng.displayName);
      }
    }
  });
  
  // 4. Filter by compatibility from INGREDIENT_COMPOSITIONS
  const filtered: string[] = [];
  whitelist.forEach(ingName => {
    // Try multiple key formats
    const keys = [
      ingName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, ''),
      ingName.toLowerCase().replace(/[^a-z0-9_]/g, '_'),
      ingName.toLowerCase()
    ];
    
    let found = false;
    let shouldInclude = true;
    
    for (const key of keys) {
      const composition = getIngredientComposition(key);
      if (composition?.speciesCompatibility) {
        const compat = composition.speciesCompatibility[species];
        if (compat === 'ok' || compat === 'limit' || compat === 'caution') {
          shouldInclude = true;
          found = true;
          break;
        } else if (compat === 'avoid') {
          shouldInclude = false; // Explicitly avoid, don't add
          found = true;
          break;
        }
      }
    }
    
    // If no composition data found, include it anyway (allows ingredients from ALL_INGREDIENTS)
    // This is important because ALL_INGREDIENTS already contains species-specific safe ingredients
    if (!found || shouldInclude) {
      filtered.push(ingName);
    }
  });
  
  // 5. Apply subtype-specific filters
  if (species === 'reptile' && subtype) {
    const reptileTypes: ReptileType[] = ['herbivore', 'insectivore', 'omnivore'];
    if (reptileTypes.includes(subtype as ReptileType)) {
      return filterByReptileType(filtered, subtype as ReptileType);
    }
  }
  
  if (species === 'pocket-pet' && subtype) {
    const pocketPetTypes: PocketPetType[] = ['rabbit', 'guinea-pig', 'hamster', 'gerbil'];
    if (pocketPetTypes.includes(subtype as PocketPetType)) {
      return filterByPocketPetType(filtered, subtype as PocketPetType);
    }
  }
  
  return filtered;
}

/**
 * Filter ingredients by reptile type
 */
function filterByReptileType(ingredients: string[], type: ReptileType): string[] {
  // Herbivores: no meat, focus on greens/veggies
  if (type === 'herbivore') {
    return ingredients.filter(ing => {
      const lower = ing.toLowerCase();
      return !lower.includes('chicken') && !lower.includes('beef') && 
             !lower.includes('turkey') && !lower.includes('meat') &&
             !lower.includes('salmon') && !lower.includes('fish');
    });
  }
  
  // Insectivores: no plant matter, focus on proteins
  if (type === 'insectivore') {
    return ingredients.filter(ing => {
      const lower = ing.toLowerCase();
      return lower.includes('insect') || lower.includes('cricket') || 
             lower.includes('mealworm') || lower.includes('protein');
    });
  }
  
  // Omnivores: allow both
  return ingredients;
}

/**
 * Filter ingredients by pocket pet type
 */
function filterByPocketPetType(ingredients: string[], type: PocketPetType): string[] {
  // Rabbits and guinea pigs: hay-based, limit fruits
  if (type === 'rabbit' || type === 'guinea-pig') {
    return ingredients.filter(ing => {
      const lower = ing.toLowerCase();
      // Prioritize hay, greens, limit high-sugar fruits
      return lower.includes('hay') || lower.includes('green') || 
             lower.includes('kale') || lower.includes('carrot') ||
             (lower.includes('fruit') && !lower.includes('banana') && !lower.includes('grape'));
    });
  }
  
  // Hamsters and gerbils: more variety, can handle more fruits/grains
  return ingredients;
}

/**
 * Check if an ingredient is in the whitelist for a species
 * Also checks if ingredient is in ALL_INGREDIENTS for that species (even without composition data)
 */
export function isWhitelisted(ingredientName: string, species: Species, subtype?: ReptileType | PocketPetType): boolean {
  // First check the whitelist
  const whitelist = getWhitelistForSpecies(species, subtype);
  const inWhitelist = whitelist.some(ing => 
    ing.toLowerCase() === ingredientName.toLowerCase() ||
    ing.toLowerCase().includes(ingredientName.toLowerCase()) ||
    ingredientName.toLowerCase().includes(ing.toLowerCase())
  );
  
  if (inWhitelist) return true;
  
  // Also check if ingredient is in ALL_INGREDIENTS for this species
  // This ensures ingredients from ALL_INGREDIENTS are included even without composition data
  const speciesKey = species === 'dog' ? 'dogs' : 
                     species === 'cat' ? 'cats' :
                     species === 'bird' ? 'birds' :
                     species === 'reptile' ? 'reptiles' :
                     species === 'pocket-pet' ? 'pocket-pets' : species;
  
  const speciesData = ALL_INGREDIENTS[speciesKey as keyof typeof ALL_INGREDIENTS];
  if (speciesData) {
    for (const category of Object.values(speciesData)) {
      if (Array.isArray(category)) {
        const found = category.some(ing => 
          ing.toLowerCase() === ingredientName.toLowerCase() ||
          ing.toLowerCase().includes(ingredientName.toLowerCase()) ||
          ingredientName.toLowerCase().includes(ing.toLowerCase())
        );
        if (found) return true;
      }
    }
  }
  
  return false;
}

/**
 * Get "do not use" list for a species (ingredients marked as 'avoid')
 */
export function getBlacklistForSpecies(species: Species): string[] {
  const blacklist: string[] = [];
  
  // Check all ingredients in composition database
  const allCompositions = Object.keys(INGREDIENT_COMPOSITIONS);
  
  for (const key of allCompositions) {
    const composition = getIngredientComposition(key);
    if (composition?.speciesCompatibility) {
      const compat = composition.speciesCompatibility[species];
      if (compat === 'avoid') {
        blacklist.push(key.replace(/_/g, ' ')); // Convert to display name
      }
    }
  }
  
  return blacklist;
}

/**
 * Get confidence level for species ingredient coverage
 * 'full' = comprehensive data, 'beta' = partial data, 'limited' = minimal data
 */
export function getSpeciesCoverageLevel(species: Species): 'full' | 'beta' | 'limited' {
  const coverage: Record<Species, 'full' | 'beta' | 'limited'> = {
    'dog': 'full',
    'cat': 'full',
    'bird': 'beta',
    'reptile': 'beta',
    'pocket-pet': 'beta'
  };
  
  return coverage[species] || 'limited';
}
</file>

<file path="lib/utils/localStorageSafe.ts">
// lib/utils/localStorageSafe.ts
// Safe localStorage operations with error handling and transaction support

import { logger } from './logger';

/**
 * Safe localStorage get with error handling
 */
export function safeGetItem(key: string): string | null {
  if (typeof window === 'undefined') return null;
  
  try {
    return localStorage.getItem(key);
  } catch (error) {
    logger.error('Failed to read from localStorage', error, { key });
    return null;
  }
}

/**
 * Safe localStorage set with error handling and quota management
 */
export function safeSetItem(key: string, value: string): { success: boolean; error?: string } {
  if (typeof window === 'undefined') {
    return { success: false, error: 'localStorage not available' };
  }
  
  try {
    localStorage.setItem(key, value);
    return { success: true };
  } catch (error: any) {
    // Handle quota exceeded error
    if (error.name === 'QuotaExceededError' || error.code === 22) {
      logger.error('localStorage quota exceeded', error, { key, valueLength: value.length });
      return { success: false, error: 'Storage limit reached. Please clear some data or use a different browser.' };
    }
    
    // Handle other errors
    logger.error('Failed to write to localStorage', error, { key });
    return { success: false, error: 'Failed to save data. Please try again.' };
  }
}

/**
 * Safe JSON parse with error handling
 */
export function safeParseJSON<T>(jsonString: string | null, defaultValue: T): T {
  if (!jsonString) return defaultValue;
  
  try {
    const parsed = JSON.parse(jsonString);
    return parsed as T;
  } catch (error) {
    logger.error('Failed to parse JSON from localStorage', error, { jsonString: jsonString.substring(0, 100) });
    return defaultValue;
  }
}

/**
 * Safe JSON stringify with error handling
 */
export function safeStringifyJSON(data: any): string | null {
  try {
    return JSON.stringify(data);
  } catch (error) {
    logger.error('Failed to stringify JSON', error, { dataType: typeof data });
    return null;
  }
}

/**
 * Transaction-safe localStorage update
 * Reads, modifies, and writes atomically to prevent race conditions
 */
export function safeUpdateItem<T>(
  key: string,
  updateFn: (currentValue: T | null) => T
): { success: boolean; error?: string; data?: T } {
  if (typeof window === 'undefined') {
    return { success: false, error: 'localStorage not available' };
  }
  
  try {
    // Read current value
    const current = safeGetItem(key);
    const currentData = current ? safeParseJSON<T>(current, null as T) : null;
    
    // Update
    const newData = updateFn(currentData);
    
    // Write back
    const jsonString = safeStringifyJSON(newData);
    if (!jsonString) {
      return { success: false, error: 'Failed to serialize data' };
    }
    
    const writeResult = safeSetItem(key, jsonString);
    if (!writeResult.success) {
      return { success: false, error: writeResult.error };
    }
    
    return { success: true, data: newData };
  } catch (error) {
    logger.error('Failed to update localStorage item', error, { key });
    return { success: false, error: 'Failed to update data' };
  }
}

/**
 * Check if localStorage is available and has space
 */
export function isLocalStorageAvailable(): boolean {
  if (typeof window === 'undefined') return false;
  
  try {
    const testKey = '__localStorage_test__';
    localStorage.setItem(testKey, 'test');
    localStorage.removeItem(testKey);
    return true;
  } catch {
    return false;
  }
}

/**
 * Get estimated localStorage usage
 */
export function getLocalStorageUsage(): { used: number; available: boolean } {
  if (typeof window === 'undefined') {
    return { used: 0, available: false };
  }
  
  try {
    let total = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key) {
        const value = localStorage.getItem(key);
        if (value) {
          total += key.length + value.length;
        }
      }
    }
    return { used: total, available: true };
  } catch {
    return { used: 0, available: false };
  }
}
</file>

<file path="lib/utils/logger.ts">
// lib/utils/logger.ts
// Centralized logging utility for production-ready logging

type LogLevel = 'debug' | 'info' | 'warn' | 'error';

class Logger {
  private isDevelopment = process.env.NODE_ENV === 'development';

  private log(level: LogLevel, message: string, ...args: any[]): void {
    if (!this.isDevelopment && level === 'debug') {
      return; // Skip debug logs in production
    }

    const timestamp = new Date().toISOString();
    const prefix = `[${timestamp}] [${level.toUpperCase()}]`;

    switch (level) {
      case 'error':
        console.error(prefix, message, ...args);
        // In production, you might want to send to error tracking service
        // e.g., Sentry.captureException(new Error(message));
        break;
      case 'warn':
        console.warn(prefix, message, ...args);
        break;
      case 'info':
        if (this.isDevelopment) {
          console.info(prefix, message, ...args);
        }
        break;
      case 'debug':
        if (this.isDevelopment) {
          console.debug(prefix, message, ...args);
        }
        break;
    }
  }

  debug(message: string, ...args: any[]): void {
    this.log('debug', message, ...args);
  }

  info(message: string, ...args: any[]): void {
    this.log('info', message, ...args);
  }

  warn(message: string, ...args: any[]): void {
    this.log('warn', message, ...args);
  }

  error(message: string, error?: Error | unknown, ...args: any[]): void {
    if (error instanceof Error) {
      this.log('error', message, error.message, error.stack, ...args);
    } else {
      this.log('error', message, error, ...args);
    }
  }
}

export const logger = new Logger();
</file>

<file path="lib/utils/mascotImageMapping.ts">
// lib/utils/mascotImageMapping.ts
// Maps recipe categories to mascot images in /images/emojis/Mascots/

/**
 * Get the mascot image path for a recipe category
 * @param category - Recipe category (dogs, cats, birds, reptiles, pocket-pets)
 * @returns Path to the mascot image for that category
 */
export function getMascotImageForCategory(category: string): string {
  const categoryLower = (category || '').toLowerCase();
  
  const categoryToMascot: Record<string, string> = {
    'dogs': '/images/emojis/Mascots/Prep Puppy.jpg',
    'cats': '/images/emojis/Mascots/ProfessorPurffesor.jpg',
    'birds': '/images/emojis/Mascots/RobinRed-Route.jpg',
    'reptiles': '/images/emojis/Mascots/SherlockShells.jpg',
    'pocket-pets': '/images/emojis/Mascots/harvesthamster.jpg',
    // Handle plural forms
    'dog': '/images/emojis/Mascots/Prep Puppy.jpg',
    'cat': '/images/emojis/Mascots/ProfessorPurffesor.jpg',
    'bird': '/images/emojis/Mascots/RobinRed-Route.jpg',
    'reptile': '/images/emojis/Mascots/SherlockShells.jpg',
    'pocket-pet': '/images/emojis/Mascots/harvesthamster.jpg',
  };
  
  return categoryToMascot[categoryLower] || '/images/emojis/Mascots/Mascot-Emoji-Faces.png';
}
</file>

<file path="lib/utils/mealCalculator.ts">
/**
 * Utility functions for calculating how many meals a shopping list will provide
 */

/**
 * Parse an amount string (e.g., "200g", "1 cup", "500g") and return grams
 * Assumes "g" means grams, otherwise returns 0 if unable to parse
 */
export function parseAmountToGrams(amount: string): number {
  if (!amount) return 0;
  
  // Try to extract number from string like "200g", "500g", etc.
  const match = amount.match(/(\d+(?:\.\d+)?)\s*g/i);
  if (match) {
    return parseFloat(match[1]);
  }
  
  // Try to extract just a number if it's only a number
  const numberMatch = amount.match(/(\d+(?:\.\d+)?)/);
  if (numberMatch) {
    return parseFloat(numberMatch[1]);
  }
  
  return 0;
}

/**
 * Calculate how many meals a shopping list will provide based on recommended servings
 * @param ingredients - Shopping list ingredients with amounts
 * @param selectedIngredients - Original ingredient selections with grams
 * @param totalGrams - Total grams in the recipe
 * @param recommendedServingGrams - Recommended serving size in grams for the entire meal
 * @returns Number of meals the shopping list will provide (minimum across all ingredients)
 */
export function calculateMealsFromShoppingList(
  ingredients: Array<{ id: string; name: string; amount: string }>,
  selectedIngredients: Array<{ key: string; grams: number }>,
  totalGrams: number,
  recommendedServingGrams: number
): number {
  console.log('[calculateMealsFromShoppingList] Starting calculation with:', {
    ingredientsCount: ingredients.length,
    selectedIngredientsCount: selectedIngredients.length,
    totalGrams,
    recommendedServingGrams
  });

  if (!ingredients.length || !selectedIngredients.length || totalGrams === 0 || recommendedServingGrams === 0) {
    console.log('[calculateMealsFromShoppingList] Early return - invalid inputs');
    return 0;
  }

  // Create a map of ingredient key to grams per meal
  const ingredientGramsMap = new Map<string, number>();
  selectedIngredients.forEach(ing => {
    const gramsPerMeal = (ing.grams / totalGrams) * recommendedServingGrams;
    ingredientGramsMap.set(ing.key, gramsPerMeal);
    console.log(`[calculateMealsFromShoppingList] Mapped ${ing.key} -> ${gramsPerMeal.toFixed(2)}g per meal`);
  });

  // Calculate meals for each ingredient
  const mealsPerIngredient: number[] = [];

  ingredients.forEach(ing => {
    const purchasedGrams = parseAmountToGrams(ing.amount);
    console.log(`[calculateMealsFromShoppingList] Processing ingredient: ${ing.name} (id: ${ing.id}), purchased: ${purchasedGrams}g`);
    
    // Try to find by id first
    let gramsPerMeal = ingredientGramsMap.get(ing.id);
    
    // Fallback: try to match by name (for cases where id doesn't match key exactly)
    if (!gramsPerMeal) {
      console.log(`[calculateMealsFromShoppingList] No match by id ${ing.id}, trying name matching...`);
      // Try to find a matching selected ingredient by comparing normalized names
      const normalizedIngName = ing.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      for (const [key, grams] of ingredientGramsMap.entries()) {
        const normalizedKey = key.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        if (normalizedKey === normalizedIngName || normalizedIngName.includes(normalizedKey) || normalizedKey.includes(normalizedIngName)) {
          gramsPerMeal = grams;
          console.log(`[calculateMealsFromShoppingList] Found match by name: ${key} -> ${gramsPerMeal.toFixed(2)}g per meal`);
          break;
        }
      }
    } else {
      console.log(`[calculateMealsFromShoppingList] Found match by id: ${ing.id} -> ${gramsPerMeal.toFixed(2)}g per meal`);
    }
    
    if (purchasedGrams > 0 && gramsPerMeal && gramsPerMeal > 0) {
      const meals = purchasedGrams / gramsPerMeal;
      console.log(`[calculateMealsFromShoppingList] ${ing.name}: ${purchasedGrams}g / ${gramsPerMeal.toFixed(2)}g = ${meals.toFixed(2)} meals`);
      mealsPerIngredient.push(meals);
    } else {
      console.log(`[calculateMealsFromShoppingList] Skipping ${ing.name}: purchasedGrams=${purchasedGrams}, gramsPerMeal=${gramsPerMeal}`);
    }
  });

  if (mealsPerIngredient.length === 0) {
    console.log('[calculateMealsFromShoppingList] No valid meal calculations found');
    return 0;
  }

  // Return the minimum (bottleneck ingredient)
  const minMeals = Math.floor(Math.min(...mealsPerIngredient));
  console.log(`[calculateMealsFromShoppingList] Final result: ${minMeals} meals (from ${mealsPerIngredient.map(m => m.toFixed(2)).join(', ')})`);
  return minMeals;
}
</file>

<file path="lib/utils/mealCountCalculator.ts">
/**
 * Meal Count Calculator
 * 
 * Calculates dynamic meal counts based on pet profile characteristics.
 * This makes the count feel more personalized and organic rather than static.
 */

interface PetProfile {
  species: string;
  age?: string | number;
  healthConcerns?: string[];
  allergies?: string[];
}

/**
 * Calculates meal count variation based on pet profile characteristics.
 * 
 * Factors considered:
 * - Species: Different species have different recipe availability
 * - Health concerns: More concerns = fewer suitable options
 * - Allergies: More allergies = fewer safe options
 * - Age: Young and senior animals have more specialized needs
 * 
 * @param baseCount The actual number of filtered recipes
 * @param pet Pet profile information
 * @returns Adjusted count with organic variation
 */
export function calculateMealCountVariation(
  baseCount: number,
  pet: PetProfile
): number {
  let adjustedCount = baseCount;
  
  // 1. Species factor - different species have different recipe availability
  const speciesFactors: Record<string, number> = {
    'dog': 1.2,      // Dogs have more recipe options
    'dogs': 1.2,
    'cat': 1.0,
    'cats': 1.0,
    'bird': 0.8,     // Birds have fewer options
    'birds': 0.8,
    'reptile': 0.7,
    'reptiles': 0.7,
    'pocket-pet': 0.6,
    'pocket-pets': 0.6,
  };
  
  const species = pet.species?.toLowerCase() || 'dog';
  adjustedCount *= speciesFactors[species] || 1.0;
  
  // 2. Health concerns factor - more concerns = more specialized = fewer options
  const healthConcerns = pet.healthConcerns || [];
  const healthFactor = 1.0 - (healthConcerns.length * 0.1);
  adjustedCount *= Math.max(0.5, healthFactor);
  
  // 3. Allergies factor - more allergies = fewer safe options
  const allergies = pet.allergies || [];
  const allergyFactor = 1.0 - (allergies.length * 0.15);
  adjustedCount *= Math.max(0.3, allergyFactor);
  
  // 4. Age factor - young and senior animals have more specialized needs
  let ageFactor = 1.0;
  if (pet.age) {
    const ageNum = typeof pet.age === 'number' 
      ? pet.age 
      : parseFloat(String(pet.age)) || 3;
    
    if (ageNum < 1) {
      ageFactor = 1.3;  // Young animals have more specialized options
    } else if (ageNum > 7) {
      ageFactor = 0.9;  // Senior animals have fewer options
    }
  } else if (typeof pet.age === 'string') {
    const ageStr = pet.age.toLowerCase();
    if (ageStr === 'baby' || ageStr === 'young') {
      ageFactor = 1.3;
    } else if (ageStr === 'senior') {
      ageFactor = 0.9;
    }
  }
  adjustedCount *= ageFactor;
  
  // 5. Add small deterministic variation (¬±10%) for organic feel
  // Use a hash of pet profile to get stable "random" value
  const profileHash = JSON.stringify(pet).split('').reduce((acc, char) => {
    const hash = ((acc << 5) - acc) + char.charCodeAt(0);
    return hash & hash;
  }, 0);
  const stableVariation = 0.9 + ((Math.abs(profileHash) % 20) / 100); // 0.9 to 1.1, stable per pet
  adjustedCount *= stableVariation;
  
  // 6. Ensure reasonable bounds
  adjustedCount = Math.round(adjustedCount);
  adjustedCount = Math.max(8, adjustedCount);   // Never show less than 8
  adjustedCount = Math.min(85, adjustedCount);  // Never show more than 85
  
  return adjustedCount;
}
</file>

<file path="lib/utils/mealEstimation.ts">
/**
 * Meal Estimation Utilities
 * Calculate realistic meal counts based on actual package sizes
 */

import { getPackageSize } from '@/lib/data/packageSizes';
import { getProductPrice, getProductQuantity, getProductByIngredient } from '@/lib/data/product-prices';

export interface MealEstimate {
  estimatedMeals: number;
  totalCost: number;
  costPerMeal: number;
  breakdown: Array<{
    ingredient: string;
    recipeAmount: number; // grams needed per meal
    packageSize: number; // grams in package
    mealsFromPackage: number;
    packageCost: number;
  }>;
  notes: string[];
  exceedsBudget?: boolean; // True if costPerMeal > MAX_COST_PER_MEAL
}

// Maximum cost per meal threshold (matched to commercial pet food pricing)
// Dog: $0.50-$3.50/meal, Cat: $0.75-$4.00/meal, Bird: $0.10-$0.50/meal, Reptile: $1.00-$3.00/meal
// Using $4.00 to allow better ingredient variety and quality
export const MAX_COST_PER_MEAL = 4.00;

export interface ShoppingListItem {
  id: string;
  name: string;
  amount: string; // Recipe amount (e.g., "200g", "2 tbsp", "1 tsp")
  asinLink?: string;
  category?: string;
}

/**
 * Convert Amazon quantity strings to grams
 * Examples: "2 lbs", "24 oz", "18 count", "500 count", "32 oz", "1 head", "2 lbs"
 */
export function quantityToGrams(quantity: string): number {
  if (!quantity) return 0;
  
  const q = quantity.toLowerCase().trim();
  
  // Weight conversions
  const lbMatch = q.match(/(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)/);
  if (lbMatch) {
    return parseFloat(lbMatch[1]) * 453.592; // 1 lb = 453.592g
  }
  
  const ozMatch = q.match(/(\d+(?:\.\d+)?)\s*(?:oz|ounce|fl oz|fluid ounce)/);
  if (ozMatch) {
    return parseFloat(ozMatch[1]) * 28.3495; // 1 oz = 28.3495g
  }
  
  const kgMatch = q.match(/(\d+(?:\.\d+)?)\s*(?:kg|kilogram)/);
  if (kgMatch) {
    return parseFloat(kgMatch[1]) * 1000;
  }
  
  const gMatch = q.match(/(\d+(?:\.\d+)?)\s*(?:g|gram)/);
  if (gMatch) {
    return parseFloat(gMatch[1]);
  }
  
  // Count-based items (assume average weights)
  const countMatch = q.match(/(\d+)\s*(?:count|piece|pieces|can|cans|jar|jars|box|boxes|bag|bags|head|heads|bunch|bunches)/);
  if (countMatch) {
    const count = parseInt(countMatch[1]);
    const unit = countMatch[0].toLowerCase();
    
    // Estimate weights based on common items
    if (unit.includes('egg') || unit.includes('count')) {
      // Eggs: ~50g each
      if (q.includes('egg')) return count * 50;
      // Generic count: assume 100g per unit
      return count * 100;
    }
    if (unit.includes('can')) return count * 400; // Average can ~400g
    if (unit.includes('jar')) return count * 500; // Average jar ~500g
    if (unit.includes('box')) return count * 300; // Average box ~300g
    if (unit.includes('bag')) return count * 500; // Average bag ~500g
    if (unit.includes('head')) return count * 500; // Lettuce head ~500g
    if (unit.includes('bunch')) return count * 200; // Bunch of herbs ~200g
    
    return count * 100; // Default 100g per unit
  }
  
  return 0;
}

/**
 * Convert various units to grams
 */
export function parseAmountToGrams(amount: string | number, unit?: string): number {
  console.log('[parseAmountToGrams] Input - amount:', amount, 'unit:', unit);
  
  let numAmount: number;
  let unitStr: string;
  
  if (typeof amount === 'string') {
    // Try to parse amount and unit from string like "200g", "2 tbsp", etc.
    const match = amount.match(/(\d+(?:\.\d+)?)\s*(.*)/i);
    console.log('[parseAmountToGrams] Regex match result:', match);
    if (match) {
      numAmount = parseFloat(match[1]);
      unitStr = (match[2] || unit || 'g').trim().toLowerCase();
      console.log('[parseAmountToGrams] Parsed - numAmount:', numAmount, 'unitStr:', unitStr);
    } else {
      numAmount = parseFloat(amount) || 0;
      unitStr = (unit || 'g').toLowerCase();
      console.log('[parseAmountToGrams] No match, using parseFloat - numAmount:', numAmount, 'unitStr:', unitStr);
    }
  } else {
    numAmount = amount;
    unitStr = (unit || 'g').toLowerCase();
    console.log('[parseAmountToGrams] Number input - numAmount:', numAmount, 'unitStr:', unitStr);
  }
  
  if (!numAmount || isNaN(numAmount)) {
    console.log('[parseAmountToGrams] ‚ùå Invalid amount, returning 0');
    return 0;
  }
  
  // Weight conversions
  if (unitStr === 'g' || unitStr === 'gram' || unitStr === 'grams') {
    console.log('[parseAmountToGrams] ‚úÖ Weight (g) conversion:', numAmount);
    return numAmount;
  }
  if (unitStr === 'kg' || unitStr === 'kilogram' || unitStr === 'kilograms') {
    const result = numAmount * 1000;
    console.log('[parseAmountToGrams] ‚úÖ Weight (kg) conversion:', result);
    return result;
  }
  if (unitStr === 'lb' || unitStr === 'pound' || unitStr === 'pounds') {
    const result = numAmount * 453.592;
    console.log('[parseAmountToGrams] ‚úÖ Weight (lb) conversion:', result);
    return result;
  }
  if (unitStr === 'oz' || unitStr === 'ounce' || unitStr === 'ounces') {
    const result = numAmount * 28.3495;
    console.log('[parseAmountToGrams] ‚úÖ Weight (oz) conversion:', result);
    return result;
  }
  
  // Volume conversions (approximate, assuming water density for liquids)
  if (unitStr === 'ml' || unitStr === 'milliliter' || unitStr === 'milliliters') {
    console.log('[parseAmountToGrams] ‚úÖ Volume (ml) conversion:', numAmount);
    return numAmount; // ~1:1 for water
  }
  if (unitStr === 'l' || unitStr === 'liter' || unitStr === 'liters') {
    const result = numAmount * 1000;
    console.log('[parseAmountToGrams] ‚úÖ Volume (l) conversion:', result);
    return result;
  }
  if (unitStr === 'cup' || unitStr === 'cups') {
    const result = numAmount * 240;
    console.log('[parseAmountToGrams] ‚úÖ Volume (cup) conversion:', result);
    return result; // ~240g for water
  }
  if (unitStr === 'tbsp' || unitStr === 'tablespoon' || unitStr === 'tablespoons') {
    const result = numAmount * 15;
    console.log('[parseAmountToGrams] ‚úÖ Volume (tbsp) conversion:', result);
    return result; // ~15g for water
  }
  if (unitStr === 'tsp' || unitStr === 'teaspoon' || unitStr === 'teaspoons') {
    const result = numAmount * 5;
    console.log('[parseAmountToGrams] ‚úÖ Volume (tsp) conversion:', result);
    return result; // ~5g for water
  }
  
  // Count conversions (rough estimates)
  if (unitStr === 'piece' || unitStr === 'pieces' || unitStr === 'whole' || unitStr === 'pinch' || unitStr === 'pinches') {
    const result = numAmount * 10;
    console.log('[parseAmountToGrams] ‚úÖ Count conversion:', result);
    return result; // Assume 10g per piece/pinch (conservative estimate)
  }
  
  // Default: assume grams
  console.log('[parseAmountToGrams] ‚ö†Ô∏è Unknown unit, defaulting to grams:', numAmount);
  return numAmount;
}

/**
 * Calculate how many meals can be made from a shopping list
 * based on actual package sizes
 */
export function calculateMealsFromGroceryList(
  shoppingList: ShoppingListItem[],
  recipeGramsPerMeal?: number, // Optional: total recipe grams per meal
  species?: string, // Optional: species for species-aware product matching
  preferBudget: boolean = true // Default to true for cost calculations - prefer budget-tier products
): MealEstimate {
  // #region agent log
  fetch('http://127.0.0.1:7242/ingest/0b2cb572-34bf-468c-9297-dd079c8c4c2d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'mealEstimation.ts:136',message:'calculateMealsFromGroceryList entry',data:{preferBudget},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
  // #endregion
  console.log('[calculateMealsFromGroceryList] ========== Starting calculation ==========');
  console.log('[calculateMealsFromGroceryList] Input shoppingList:', shoppingList);
  console.log('[calculateMealsFromGroceryList] shoppingList.length:', shoppingList?.length);
  console.log('[calculateMealsFromGroceryList] getProductPrice available:', typeof getProductPrice !== 'undefined');
  
  const breakdown: MealEstimate['breakdown'] = [];
  const notes: string[] = [];
  let totalCost = 0;
  
  if (!shoppingList || shoppingList.length === 0) {
    console.log('[calculateMealsFromGroceryList] ‚ùå Empty shopping list, returning 0 meals');
    return {
      estimatedMeals: 0,
      totalCost: 0,
      costPerMeal: 0,
      breakdown: [],
      notes: ['No ingredients in shopping list']
    };
  }
  
  // Calculate for each ingredient
  for (let i = 0; i < shoppingList.length; i++) {
    const item = shoppingList[i];
    console.log(`[calculateMealsFromGroceryList] Processing item ${i + 1}/${shoppingList.length}:`, item);
    
    const ingredientNameLower = item.name.toLowerCase();
    
    // Try to get product data from product-prices.json first
    let packageSizeGrams = 0;
    let itemCost = 0;
    let priceSource = 'package-estimate';
    
    const product = getProductByIngredient(ingredientNameLower);
    if (product) {
      // Use actual product quantity from Amazon
      if (product.quantity) {
        packageSizeGrams = quantityToGrams(product.quantity);
        console.log(`[calculateMealsFromGroceryList]   ‚úÖ Got quantity from product-prices.json: "${product.quantity}" = ${packageSizeGrams}g`);
      }
      
      // Use actual product price
      if (product.price?.amount) {
        itemCost = product.price.amount;
        priceSource = 'product-prices-json';
        console.log(`[calculateMealsFromGroceryList]   ‚úÖ Using product-prices.json price: $${itemCost}`);
      }
    }
    
    // Fall back to package size estimates if no product data
    if (packageSizeGrams === 0) {
      const packageInfo = getPackageSize(item.name, item.category);
      packageSizeGrams = packageInfo.typicalSize;
      if (!itemCost) {
        itemCost = packageInfo.estimatedCost;
      }
      console.log(`[calculateMealsFromGroceryList]   ‚ö†Ô∏è Using package estimate: ${packageSizeGrams}g, $${itemCost}`);
    }
    
    // Parse recipe amount to grams
    const recipeGrams = parseAmountToGrams(item.amount);
    console.log(`[calculateMealsFromGroceryList]   Recipe amount input: "${item.amount}" (type: ${typeof item.amount})`);
    console.log(`[calculateMealsFromGroceryList]   Recipe grams parsed:`, recipeGrams);
    
    if (recipeGrams <= 0) {
      console.log(`[calculateMealsFromGroceryList]   ‚ùå Skipping - invalid recipeGrams:`, recipeGrams);
      notes.push(`‚ö†Ô∏è Could not parse amount for ${item.name}: "${item.amount}"`);
      continue;
    }
    
    // How many meals can this package make? Keep as decimal for accurate calculation
    const mealsFromPackage = packageSizeGrams / recipeGrams;
    console.log(`[calculateMealsFromGroceryList]   Meals from package: ${packageSizeGrams} / ${recipeGrams} = ${mealsFromPackage}`);
    
    const breakdownItem = {
      ingredient: item.name,
      recipeAmount: recipeGrams,
      packageSize: packageSizeGrams,
      mealsFromPackage: mealsFromPackage,
      packageCost: itemCost,
    };
    breakdown.push(breakdownItem);
    console.log(`[calculateMealsFromGroceryList]   ‚úÖ Added to breakdown (price source: ${priceSource}):`, breakdownItem);
    
    totalCost += itemCost;
    
    // Add notes for very small or very large ratios
    if (mealsFromPackage > 100) {
      notes.push(`${item.name}: Package will last 100+ meals`);
    } else if (mealsFromPackage < 5) {
      notes.push(`${item.name}: Package only makes ${Math.round(mealsFromPackage)} meals - consider larger size`);
    }
  }
  
  console.log('[calculateMealsFromGroceryList] Breakdown array after processing:', breakdown);
  console.log('[calculateMealsFromGroceryList] breakdown.length:', breakdown.length);
  console.log('[calculateMealsFromGroceryList] Total cost so far:', totalCost);
  
  if (breakdown.length === 0) {
    console.log('[calculateMealsFromGroceryList] ‚ùå No valid breakdown items, returning 0 meals');
    return {
      estimatedMeals: 0,
      totalCost: 0,
      costPerMeal: 0,
      breakdown: [],
      notes: ['Could not parse ingredient amounts']
    };
  }
  
  // Filter out staples (ingredients lasting 100+ meals) - they shouldn't limit the calculation
  const substantialIngredients = breakdown.filter(b => b.mealsFromPackage < 100);
  console.log('[calculateMealsFromGroceryList] Substantial ingredients (< 100 meals):', substantialIngredients);
  console.log('[calculateMealsFromGroceryList] substantialIngredients.length:', substantialIngredients.length);
  
  // ‚úÖ FIX: Handle empty array from Math.min - ensure we never pass empty array
  let estimatedMeals = 0;
  if (substantialIngredients.length > 0) {
    estimatedMeals = Math.min(...substantialIngredients.map(b => b.mealsFromPackage));
  } else if (breakdown.length > 0) {
    estimatedMeals = Math.min(...breakdown.map(b => b.mealsFromPackage));
  } else {
    console.error('[calculateMealsFromGroceryList] ‚ùå No valid ingredients in breakdown after processing');
    return {
      estimatedMeals: 0,
      totalCost: 0,
      costPerMeal: 0,
      breakdown: [],
      notes: ['Could not calculate meals from provided ingredients - no valid data after processing']
    };
  }
  console.log('[calculateMealsFromGroceryList] Estimated meals (before rounding):', estimatedMeals);
  
  // ‚úÖ FIX: Floor the final result (not individual ingredients) to get whole meals
  // This gives accurate estimates without compounding rounding errors
  const finalMeals = Math.max(1, Math.floor(estimatedMeals));
  const costPerMeal = finalMeals > 0 ? totalCost / finalMeals : 0;
  console.log('[calculateMealsFromGroceryList] Final meals after rounding:', finalMeals);
  console.log('[calculateMealsFromGroceryList] Cost per meal:', costPerMeal);
  
  // Check if cost exceeds budget threshold
  const finalCostPerMeal = Math.round(costPerMeal * 100) / 100;
  const exceedsBudget = finalCostPerMeal > MAX_COST_PER_MEAL;
  
  // Add general notes
  if (finalMeals < 5) {
    notes.push('‚ö†Ô∏è Some packages are small - consider buying larger sizes');
  } else if (finalMeals > 20) {
    notes.push('‚úì Great value - ingredients will last many meals');
  }
  
  // Add budget warning if exceeded
  if (exceedsBudget) {
    notes.push(`‚ö†Ô∏è Cost per meal ($${finalCostPerMeal.toFixed(2)}) exceeds the $${MAX_COST_PER_MEAL} target. Consider choosing cheaper ingredient alternatives.`);
  }
  
  const finalResult = {
    estimatedMeals: finalMeals,
    totalCost: Math.round(totalCost * 100) / 100,
    costPerMeal: finalCostPerMeal,
    breakdown,
    notes: [...new Set(notes)], // Remove duplicates
    exceedsBudget,
  };
  
  console.log('[calculateMealsFromGroceryList] ‚úÖ Final result:', finalResult);
  if (exceedsBudget) {
    console.log(`[calculateMealsFromGroceryList] ‚ö†Ô∏è  WARNING: Cost per meal exceeds $${MAX_COST_PER_MEAL}`);
  }
  console.log('[calculateMealsFromGroceryList] ============================================');
  
  return finalResult;
}
</file>

<file path="lib/utils/mealImageAssignment.ts">
/**
 * Utility to assign meal images to recipes based on hash of recipe ID
 * Cycles through 25 images per species for consistent assignment
 */

/**
 * Hash a string to a number (deterministic)
 */
function hashStringToNumber(s: string): number {
  let hash = 0;
  for (let i = 0; i < s.length; i++) {
    const char = s.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash);
}

/**
 * Get meal image path for a recipe based on its ID and category
 * Returns path like: /images/meals/dogs-meal-01.png
 * 
 * @param recipeId - Unique recipe identifier
 * @param category - Recipe category (dogs, cats, birds, reptiles, pocket-pets)
 * @returns Image path string
 */
export function getMealImageForRecipe(recipeId: string, category: string): string {
  // Normalize category to match image naming
  const categoryMap: Record<string, string> = {
    'dogs': 'dogs',
    'cats': 'cats',
    'birds': 'birds',
    'reptiles': 'reptiles',
    'pocket-pets': 'pocket-pets'
  };
  
  const normalizedCategory = categoryMap[category.toLowerCase()] || 'dogs';
  
  // Hash the recipe ID to get a number between 0-24 (for 25 images)
  const hash = hashStringToNumber(recipeId);
  const imageNumber = (hash % 25) + 1; // 1-25
  
  // Format as 01-25
  const imageNumberStr = imageNumber.toString().padStart(2, '0');
  
  return `/images/meals/${normalizedCategory}-meal-${imageNumberStr}.png`;
}

/**
 * Get all available meal images for a species
 * Useful for checking which images exist
 */
export function getAvailableMealImages(category: string): string[] {
  const categoryMap: Record<string, string> = {
    'dogs': 'dogs',
    'cats': 'cats',
    'birds': 'birds',
    'reptiles': 'reptiles',
    'pocket-pets': 'pocket-pets'
  };
  
  const normalizedCategory = categoryMap[category.toLowerCase()] || 'dogs';
  const images: string[] = [];
  
  for (let i = 1; i <= 25; i++) {
    const imageNumber = i.toString().padStart(2, '0');
    images.push(`/images/meals/${normalizedCategory}-meal-${imageNumber}.png`);
  }
  
  return images;
}
</file>

<file path="lib/utils/mealNameGenerator.ts">
// lib/utils/mealNameGenerator.ts
// Enhanced meal naming system with semantic awareness, health context, and pet personalization

import { getIngredientById, getIngredientByName, type UnifiedIngredient, type IngredientCategory } from '../data/unifiedIngredientRegistry';
import type { Recipe } from '../types';

// =================================================================
// Phase 1: Foundation - Ingredient Display Name Integration
// =================================================================

/**
 * Get display name for an ingredient from unified registry
 */
function getIngredientDisplayName(ingredientKey: string): string {
  // Try to find ingredient by ID (snake_case)
  let ingredient: UnifiedIngredient | null = getIngredientById(ingredientKey);
  
  // If not found, try by name
  if (!ingredient) {
    ingredient = getIngredientByName(ingredientKey);
  }
  
  // If found, return primary display name
  if (ingredient) {
    return ingredient.primaryDisplayName;
  }
  
  // Fallback: format key to Title Case
  return ingredientKey
    .split(/[_\s-]+/)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

/**
 * Categorize ingredients by type using unified registry
 */
function categorizeIngredients(ingredientKeys: string[]): {
  proteins: string[];
  carbs: string[];
  vegetables: string[];
  fruits: string[];
  supplements: string[];
} {
  const categories = {
    proteins: [] as string[],
    carbs: [] as string[],
    vegetables: [] as string[],
    fruits: [] as string[],
    supplements: [] as string[],
  };
  
  for (const key of ingredientKeys) {
    let ingredient: UnifiedIngredient | null = getIngredientById(key);
    if (!ingredient) {
      ingredient = getIngredientByName(key);
    }
    
    if (ingredient) {
      const category = ingredient.category;
      const displayName = getIngredientDisplayName(key);
      
      switch (category) {
        case 'protein':
        case 'insect':
          categories.proteins.push(displayName);
          break;
        case 'grain':
          categories.carbs.push(displayName);
          break;
        case 'vegetable':
          categories.vegetables.push(displayName);
          break;
        case 'fruit':
          categories.fruits.push(displayName);
          break;
        case 'supplement':
          categories.supplements.push(displayName);
          break;
        default:
          // Try to infer from name
          const lower = key.toLowerCase();
          if (lower.match(/\b(chicken|turkey|beef|lamb|fish|salmon|tuna|meat|protein|pork|duck|organ|heart|liver|kidney|venison|rabbit|quail)\b/)) {
            categories.proteins.push(displayName);
          } else if (lower.match(/\b(rice|oats|quinoa|barley|wheat|grain|seed|millet|potato|sweet.*potato|pumpkin|squash)\b/)) {
            categories.carbs.push(displayName);
          } else if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|vegetable|green)\b/)) {
            categories.vegetables.push(displayName);
          }
          break;
      }
    } else {
      // Fallback categorization by name
      const lower = key.toLowerCase();
      if (lower.match(/\b(chicken|turkey|beef|lamb|fish|salmon|tuna|meat|protein|pork|duck|organ|heart|liver|kidney|venison|rabbit|quail)\b/)) {
        categories.proteins.push(getIngredientDisplayName(key));
      } else if (lower.match(/\b(rice|oats|quinoa|barley|wheat|grain|seed|millet|potato|sweet.*potato|pumpkin|squash)\b/)) {
        categories.carbs.push(getIngredientDisplayName(key));
      } else if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|vegetable|green)\b/)) {
        categories.vegetables.push(getIngredientDisplayName(key));
      }
    }
  }
  
  return categories;
}

// =================================================================
// Phase 2: Semantic Metadata Extraction
// =================================================================

interface MealSemantics {
  dominantProtein: string;
  dominantCarb: string;
  dominantVeg: string;
  nutritionalAngle: 'High Protein' | 'Low Fat' | 'High Fiber' | 'Balanced';
  cookingStyle: 'Slow-Cooked' | 'Oven-Baked' | 'Fresh' | 'Stewed' | 'Raw' | null;
  healthTags: string[];
}

/**
 * Extract semantic metadata from recipe/ingredients
 */
function extractMealSemantics(
  ingredientKeys: string[],
  options?: {
    nutritionalProfile?: {
      protein?: number;
      fat?: number;
      fiber?: number;
    };
    healthConcerns?: string[];
    recipe?: Recipe;
  }
): MealSemantics {
  const categorized = categorizeIngredients(ingredientKeys);
  
  // Determine dominant ingredients
  const dominantProtein = categorized.proteins[0] || '';
  const dominantCarb = categorized.carbs[0] || '';
  const dominantVeg = categorized.vegetables[0] || '';
  
  // Determine nutritional angle
  let nutritionalAngle: 'High Protein' | 'Low Fat' | 'High Fiber' | 'Balanced' = 'Balanced';
  if (options?.nutritionalProfile) {
    const { protein, fat, fiber } = options.nutritionalProfile;
    if (protein && protein > 30) {
      nutritionalAngle = 'High Protein';
    } else if (fat && fat < 10) {
      nutritionalAngle = 'Low Fat';
    } else if (fiber && fiber > 5) {
      nutritionalAngle = 'High Fiber';
    }
  }
  
  // Determine cooking style (from recipe metadata or infer)
  let cookingStyle: 'Slow-Cooked' | 'Oven-Baked' | 'Fresh' | 'Stewed' | 'Raw' | null = null;
  if (options?.recipe) {
    const recipe = options.recipe;
    const nameLower = recipe.name?.toLowerCase() || '';
    const descLower = recipe.description?.toLowerCase() || '';
    const instructions = (recipe.instructions || []).join(' ').toLowerCase();
    
    if (nameLower.includes('slow') || instructions.includes('slow cook')) {
      cookingStyle = 'Slow-Cooked';
    } else if (nameLower.includes('baked') || instructions.includes('bake') || instructions.includes('oven')) {
      cookingStyle = 'Oven-Baked';
    } else if (nameLower.includes('fresh') || descLower.includes('fresh')) {
      cookingStyle = 'Fresh';
    } else if (nameLower.includes('stew') || instructions.includes('stew')) {
      cookingStyle = 'Stewed';
    } else if (nameLower.includes('raw') || instructions.includes('raw')) {
      cookingStyle = 'Raw';
    }
  }
  
  // Map health concerns to naming tags
  const healthTags: string[] = [];
  if (options?.healthConcerns && options.healthConcerns.length > 0) {
    healthTags.push(...options.healthConcerns);
  }
  
  return {
    dominantProtein,
    dominantCarb,
    dominantVeg,
    nutritionalAngle,
    cookingStyle,
    healthTags,
  };
}

// =================================================================
// Phase 5: Health Concern Lexicon
// =================================================================

const HEALTH_CONCERN_NAMING_MAP: Record<string, string> = {
  'joint-health': 'Mobility',
  'joint health': 'Mobility',
  'kidney-disease': 'Renal Support',
  'kidney disease': 'Renal Support',
  'digestive-health': 'Digestive Ease',
  'digestive health': 'Digestive Ease',
  'weight-management': 'Weight Control',
  'weight management': 'Weight Control',
  'allergies': 'Hypoallergenic',
  'diabetes': 'Blood Sugar Balance',
  'dental-health': 'Dental Care',
  'dental health': 'Dental Care',
  'pancreatitis': 'Low-Fat',
  'urinary-health': 'Urinary Support',
  'urinary health': 'Urinary Support',
  'skin-health': 'Skin & Coat',
  'skin health': 'Skin & Coat',
  'heart-health': 'Heart Health',
  'heart health': 'Heart Health',
  'immune-support': 'Immune Support',
  'immune support': 'Immune Support',
  'senior-health': 'Senior Support',
  'senior health': 'Senior Support',
};

/**
 * Map health concern to naming-friendly tag
 */
function mapHealthConcernToTag(concern: string): string {
  const normalized = concern.toLowerCase().trim();
  return HEALTH_CONCERN_NAMING_MAP[normalized] || concern;
}

// =================================================================
// Phase 3: Naming Families (25+ Patterns)
// =================================================================

type NamingFamily = 'ingredient-driven' | 'health-focused' | 'pet-personalized' | 'nutritional-style' | 'creative';

interface NamingPattern {
  family: NamingFamily;
  pattern: string;
  requires?: {
    protein?: boolean;
    carb?: boolean;
    veggie?: boolean;
    healthTag?: boolean;
    petName?: boolean;
  };
}

const NAMING_PATTERNS: NamingPattern[] = [
  // Family 1: Ingredient-Driven (Classic)
  { family: 'ingredient-driven', pattern: '{protein} & {carb} Bowl', requires: { protein: true, carb: true } },
  { family: 'ingredient-driven', pattern: '{protein} with {veggie} Medley', requires: { protein: true, veggie: true } },
  { family: 'ingredient-driven', pattern: 'Fresh {protein} & {secondIngredient}', requires: { protein: true } },
  { family: 'ingredient-driven', pattern: '{protein} {carb} Harmony', requires: { protein: true, carb: true } },
  { family: 'ingredient-driven', pattern: '{protein} Garden Blend', requires: { protein: true } },
  
  // Family 2: Health-Focused
  { family: 'health-focused', pattern: '{healthFocus} {protein} Recipe', requires: { protein: true, healthTag: true } },
  { family: 'health-focused', pattern: 'Balanced {protein} & {carb} Plate', requires: { protein: true, carb: true } },
  { family: 'health-focused', pattern: '{protein} {healthTag} Formula', requires: { protein: true, healthTag: true } },
  { family: 'health-focused', pattern: 'Supportive {protein} Blend', requires: { protein: true, healthTag: true } },
  { family: 'health-focused', pattern: 'Gentle {protein} Medley', requires: { protein: true, healthTag: true } },
  
  // Family 3: Pet-Personalized (only for custom meals)
  { family: 'pet-personalized', pattern: "{petName}'s {protein} Dinner", requires: { protein: true, petName: true } },
  { family: 'pet-personalized', pattern: "{petName}'s Favorite {protein} Bowl", requires: { protein: true, petName: true } },
  { family: 'pet-personalized', pattern: 'Special {protein} for {petName}', requires: { protein: true, petName: true } },
  { family: 'pet-personalized', pattern: "{petName}'s {healthTag} {protein}", requires: { protein: true, petName: true, healthTag: true } },
  { family: 'pet-personalized', pattern: '{breed} {protein} Feast', requires: { protein: true } },
  
  // Family 4: Nutritional-Style
  { family: 'nutritional-style', pattern: 'High-Protein {protein} Power Bowl', requires: { protein: true } },
  { family: 'nutritional-style', pattern: 'Lean {protein} & {carb} Mix', requires: { protein: true, carb: true } },
  { family: 'nutritional-style', pattern: 'Nutrient-Rich {protein} Medley', requires: { protein: true } },
  { family: 'nutritional-style', pattern: 'Complete {protein} Formula', requires: { protein: true } },
  { family: 'nutritional-style', pattern: 'Premium {protein} Blend', requires: { protein: true } },
  
  // Family 5: Creative/Descriptive
  { family: 'creative', pattern: 'Rustic {protein} Farmhouse Bowl', requires: { protein: true } },
  { family: 'creative', pattern: 'Savory {protein} Kitchen Creation', requires: { protein: true } },
  { family: 'creative', pattern: 'Golden {protein} & {carb} Plate', requires: { protein: true, carb: true } },
  { family: 'creative', pattern: 'Ultimate {protein} Feast', requires: { protein: true } },
  { family: 'creative', pattern: "Chef's Choice {protein} Blend", requires: { protein: true } },
  { family: 'creative', pattern: 'Heritage {protein} & {veggie} Bowl', requires: { protein: true, veggie: true } },
  { family: 'creative', pattern: 'Wholesome {protein} Delight', requires: { protein: true } },
  { family: 'creative', pattern: 'Gourmet {protein} & {carb} Mix', requires: { protein: true, carb: true } },
  { family: 'creative', pattern: 'Premium {protein} Medley', requires: { protein: true } },
  { family: 'creative', pattern: 'Classic {protein} & {veggie} Recipe', requires: { protein: true, veggie: true } },
  
  // More ingredient-driven patterns for variety
  { family: 'ingredient-driven', pattern: '{protein} Power Bowl', requires: { protein: true } },
  { family: 'ingredient-driven', pattern: '{protein} & {veggie} Delight', requires: { protein: true, veggie: true } },
  { family: 'ingredient-driven', pattern: '{protein} {carb} Fusion', requires: { protein: true, carb: true } },
  
  // More nutritional-style patterns
  { family: 'nutritional-style', pattern: 'Vital {protein} Formula', requires: { protein: true } },
  { family: 'nutritional-style', pattern: 'Optimal {protein} & {carb} Blend', requires: { protein: true, carb: true } },
];

// =================================================================
// Phase 4: Pattern Selection Logic
// =================================================================

/**
 * Simple hash function for deterministic pattern selection
 */
function hashString(str: string): number {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash);
}

/**
 * Select naming family based on context
 */
function selectNamingFamily(
  semantics: MealSemantics,
  options?: {
    petName?: string;
    isCustomMeal?: boolean;
    recipeId?: string;
  }
): NamingFamily {
  // For custom meals, add randomness using timestamp + ingredients for variety
  const seed = options?.recipeId || 
    (options?.isCustomMeal ? `${Date.now()}-${semantics.dominantProtein}-${semantics.dominantCarb}` : '');
  
  if (seed) {
    const hash = hashString(seed);
    const families: NamingFamily[] = ['ingredient-driven', 'health-focused', 'nutritional-style', 'creative', 'pet-personalized'];
    return families[hash % families.length];
  }
  
  // Prioritize health-focused if health concerns present
  if (semantics.healthTags.length > 0) {
    return 'health-focused';
  }
  
  // Use pet-personalized for custom meals (30% chance to avoid repetition)
  if (options?.isCustomMeal && options?.petName) {
    const hash = hashString(options.petName + seed);
    if (hash % 10 < 3) { // 30% chance
      return 'pet-personalized';
    }
  }
  
  // Use nutritional-style if nutritional angle is strong
  if (semantics.nutritionalAngle !== 'Balanced') {
    return 'nutritional-style';
  }
  
  // Default to ingredient-driven
  return 'ingredient-driven';
}

/**
 * Select a pattern from the chosen family
 */
function selectPattern(
  family: NamingFamily,
  semantics: MealSemantics,
  options?: {
    petName?: string;
    petBreed?: string;
    recipeId?: string;
    isCustomMeal?: boolean;
  }
): NamingPattern {
  // Filter patterns by family and requirements
  const familyPatterns = NAMING_PATTERNS.filter(p => p.family === family);
  
  // Filter by requirements
  const availablePatterns = familyPatterns.filter(pattern => {
    if (pattern.requires) {
      if (pattern.requires.protein && !semantics.dominantProtein) return false;
      if (pattern.requires.carb && !semantics.dominantCarb) return false;
      if (pattern.requires.veggie && !semantics.dominantVeg) return false;
      if (pattern.requires.healthTag && semantics.healthTags.length === 0) return false;
      if (pattern.requires.petName && !options?.petName) return false;
    }
    return true;
  });
  
  if (availablePatterns.length === 0) {
    // Fallback to any pattern in family
    return familyPatterns[0] || NAMING_PATTERNS[0];
  }
  
  // For custom meals, add timestamp for more variety
  const seed = options?.recipeId || 
    (options?.isCustomMeal 
      ? `${Date.now()}-${semantics.dominantProtein}-${semantics.dominantCarb}-${semantics.dominantVeg}`
      : `${semantics.dominantProtein}-${semantics.dominantCarb}-${semantics.dominantVeg}`);
  const hash = hashString(seed);
  return availablePatterns[hash % availablePatterns.length];
}

/**
 * Clean breed/pet type by removing parenthetical content like "(budgie)"
 */
function cleanBreedOrSpecies(text: string | undefined): string | undefined {
  if (!text) return undefined;
  // Remove content in parentheses like "(budgie)" or "(common)"
  return text.replace(/\s*\([^)]*\)/g, '').trim();
}

/**
 * Fill pattern with actual values
 */
function fillPattern(
  pattern: NamingPattern,
  semantics: MealSemantics,
  options?: {
    petName?: string;
    petBreed?: string;
    secondIngredient?: string;
  }
): string {
  let result = pattern.pattern;
  
  // Replace placeholders
  result = result.replace(/{protein}/g, semantics.dominantProtein || 'Protein');
  result = result.replace(/{carb}/g, semantics.dominantCarb || 'Grain');
  result = result.replace(/{veggie}/g, semantics.dominantVeg || 'Vegetable');
  result = result.replace(/{secondIngredient}/g, options?.secondIngredient || semantics.dominantCarb || semantics.dominantVeg || 'Mix');
  
  // Health tags
  if (semantics.healthTags.length > 0) {
    const healthTag = mapHealthConcernToTag(semantics.healthTags[0]);
    result = result.replace(/{healthTag}/g, healthTag);
    result = result.replace(/{healthFocus}/g, healthTag);
  }
  
  // Pet context - clean breed to remove parentheses
  if (options?.petName) {
    result = result.replace(/{petName}/g, options.petName);
  }
  if (options?.petBreed) {
    const cleanedBreed = cleanBreedOrSpecies(options.petBreed);
    if (cleanedBreed) {
      result = result.replace(/{breed}/g, cleanedBreed);
    }
  }
  
  return result;
}

// =================================================================
// Phase 6: Collision Avoidance
// =================================================================

// In-memory collision map (per session)
const nameCollisionMap = new Map<string, number>();

/**
 * Ensure unique name by appending suffix if needed
 */
function ensureUniqueName(
  baseName: string,
  ingredientSignature: string
): string {
  // Check if we've seen this signature before
  const existingCount = nameCollisionMap.get(ingredientSignature);
  
  if (existingCount === undefined) {
    // First time seeing this signature - don't add any suffix
    nameCollisionMap.set(ingredientSignature, 1);
    return baseName;
  }
  
  // Collision detected - append numeric suffix (skip 0, start at 2)
  const suffix = existingCount + 1;
  nameCollisionMap.set(ingredientSignature, suffix);
  return `${baseName} ${suffix}`;
}

/**
 * Create ingredient signature for collision detection
 */
function createIngredientSignature(ingredientKeys: string[]): string {
  return ingredientKeys
    .map(k => k.toLowerCase().trim())
    .sort()
    .join('|');
}

// =================================================================
// Phase 7: Short Name Generation
// =================================================================

/**
 * Generate short name (max 20 characters)
 */
function generateShortName(semantics: MealSemantics): string {
  const parts: string[] = [];
  
  if (semantics.dominantProtein) {
    parts.push(semantics.dominantProtein);
  }
  
  if (semantics.dominantCarb) {
    parts.push(semantics.dominantCarb);
  } else if (semantics.dominantVeg) {
    parts.push(semantics.dominantVeg);
  }
  
  if (parts.length === 0) {
    return 'Custom Meal';
  }
  
  const shortName = parts.join(' & ');
  
  // Truncate if too long
  if (shortName.length > 20) {
    return shortName.substring(0, 17) + '...';
  }
  
  return shortName;
}

// =================================================================
// Phase 9: Quality Assurance
// =================================================================

/**
 * Validate and format meal name
 */
function validateMealName(name: string): string {
  // Remove underscores
  let cleaned = name.replace(/_/g, ' ');
  
  // Remove any trailing numbers or "0" that might have been added
  cleaned = cleaned.replace(/\s+0+\s*$/, '').trim();
  
  // Remove any parenthetical content that might have slipped through
  cleaned = cleaned.replace(/\s*\([^)]*\)\s*/g, ' ');
  
  // Fix spacing
  cleaned = cleaned.replace(/\s+/g, ' ').trim();
  
  // Ensure proper capitalization (Title Case)
  cleaned = cleaned
    .split(' ')
    .map(word => {
      // Skip small words unless they're the first word
      const smallWords = ['a', 'an', 'and', 'as', 'at', 'but', 'by', 'for', 'if', 'in', 'of', 'on', 'or', 'the', 'to'];
      if (smallWords.includes(word.toLowerCase()) && cleaned.indexOf(word) > 0) {
        return word.toLowerCase();
      }
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(' ');
  
  // Check for generic patterns and add descriptor if needed
  const genericPatterns = [
    /^Chicken Bowl$/i,
    /^Beef Mix$/i,
    /^Salmon Bowl$/i,
  ];
  
  for (const pattern of genericPatterns) {
    if (pattern.test(cleaned)) {
      cleaned = cleaned.replace(/Bowl|Mix/, 'Power Bowl');
    }
  }
  
  // Validate length
  if (cleaned.length < 10) {
    cleaned = cleaned + ' Meal';
  } else if (cleaned.length > 60) {
    cleaned = cleaned.substring(0, 57) + '...';
  }
  
  // Final cleanup - remove any trailing whitespace or special characters
  cleaned = cleaned.trim();
  
  return cleaned;
}

// =================================================================
// Main Export: generateMealName
// =================================================================

export interface MealNameOptions {
  petName?: string;
  petBreed?: string;
  petSpecies?: string;
  healthConcerns?: string[];
  nutritionalProfile?: {
    protein?: number;
    fat?: number;
    fiber?: number;
  };
  mealType?: 'complete' | 'treat' | 'supplement';
  recipeId?: string;
  recipe?: Recipe;
  isCustomMeal?: boolean;
}

export interface MealNameResult {
  fullName: string;
  shortName: string;
}

/**
 * Generate meal name with full context awareness
 */
export function generateMealName(
  ingredients: string[],
  options?: MealNameOptions
): MealNameResult {
  if (ingredients.length === 0) {
    return {
      fullName: 'Custom Meal',
      shortName: 'Custom Meal',
    };
  }
  
  // Extract semantics
  const semantics = extractMealSemantics(ingredients, {
    nutritionalProfile: options?.nutritionalProfile,
    healthConcerns: options?.healthConcerns,
    recipe: options?.recipe,
  });
  
  // Select naming family
  const family = selectNamingFamily(semantics, {
    petName: options?.petName,
    isCustomMeal: options?.isCustomMeal,
    recipeId: options?.recipeId,
  });
  
  // Clean petBreed to remove parenthetical content
  const cleanedBreed = options?.petBreed ? cleanBreedOrSpecies(options.petBreed) : undefined;
  
  // Select pattern
  const pattern = selectPattern(family, semantics, {
    petName: options?.petName,
    petBreed: cleanedBreed,
    recipeId: options?.recipeId,
    isCustomMeal: options?.isCustomMeal,
  });
  
  // Get second ingredient for patterns that need it
  const categorized = categorizeIngredients(ingredients);
  const secondIngredient = categorized.proteins[1] || categorized.carbs[0] || categorized.vegetables[0];
  
  // Fill pattern (use cleaned breed)
  let fullName = fillPattern(pattern, semantics, {
    petName: options?.petName,
    petBreed: cleanedBreed,
    secondIngredient,
  });
  
  // Clean up any remaining parenthetical content that might have been in the name
  fullName = fullName.replace(/\s*\([^)]*\)\s*/g, ' ').replace(/\s+/g, ' ').trim();
  
  // Handle nutritional angle in name
  if (semantics.nutritionalAngle === 'High Protein' && !fullName.includes('High-Protein') && !fullName.includes('Power')) {
    fullName = fullName.replace(/{protein}/g, 'High-Protein ' + semantics.dominantProtein);
  }
  
  // Create ingredient signature for collision detection
  const ingredientSignature = createIngredientSignature(ingredients);
  
  // Ensure uniqueness
  fullName = ensureUniqueName(fullName, ingredientSignature);
  
  // Validate and format
  fullName = validateMealName(fullName);
  
  // Generate short name
  const shortName = generateShortName(semantics);
  
  return {
    fullName,
    shortName,
  };
}

/**
 * Legacy function for backward compatibility
 * @deprecated Use generateMealName with options instead
 */
export function getShortMealName(ingredients: string[]): string {
  const result = generateMealName(ingredients);
  return result.shortName;
}
</file>

<file path="lib/utils/nutritionalRecommendations.ts">
// lib/utils/nutritionalRecommendations.ts
// Maps nutritional deficiencies to recommended supplements and ingredients

import { petSupplements, type Supplement } from '@/lib/data/supplements';
import { getVettedProduct } from '@/lib/data/vetted-products';

export interface RecommendedSupplement {
  name: string;
  description: string;
  benefits: string;
  addressesDeficiency: string;
  defaultAmount: string;
  amazonLink?: string;
  asinLink?: string;
  isIngredient?: boolean;
  productName?: string;
  vetNote?: string;
}

/**
 * Map nutritional gaps to recommended supplements/ingredients
 */
export function getRecommendationsForDeficiency(
  deficiency: string,
  species: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
  healthConcerns: string[] = []
): RecommendedSupplement[] {
  const recommendations: RecommendedSupplement[] = [];
  const lowerDeficiency = deficiency.toLowerCase();

  // Normalize species for supplement lookup
  const supplementSpecies = species === 'pocket-pet' ? 'pocket-pets' : 
                            species === 'reptile' ? 'reptiles' : 
                            species;

  // Map deficiency patterns to supplement categories
  const deficiencyMappings: Record<string, string[]> = {
    'protein': ['allergy-support', 'digestive-health'],
    'calcium': ['joint-mobility', 'digestive-health'],
    'phosphorus': ['joint-mobility'],
    'ca:p': ['joint-mobility'],
    'taurine': ['allergy-support'],
    'fiber': ['digestive-health', 'weight-management'],
    'vitamin': ['skin-coat'],
    'omega': ['skin-coat', 'allergy-support'],
    'fat': ['skin-coat', 'allergy-support'],
  };

  // Find matching supplement categories
  const matchingCategories: string[] = [];
  for (const [pattern, categories] of Object.entries(deficiencyMappings)) {
    if (lowerDeficiency.includes(pattern)) {
      matchingCategories.push(...categories);
    }
  }

  // Get supplements from petSupplements data
  const speciesSupplements = petSupplements[supplementSpecies as keyof typeof petSupplements];
  if (speciesSupplements) {
    for (const category of matchingCategories) {
      const categorySupplements = speciesSupplements[category as keyof typeof speciesSupplements];
      if (Array.isArray(categorySupplements)) {
        for (const supplement of categorySupplements) {
          // Check if vetted product exists
          const vettedProduct = getVettedProduct(supplement.name);
          
          recommendations.push({
            name: supplement.name,
            description: supplement.description,
            benefits: supplement.benefits,
            addressesDeficiency: deficiency,
            defaultAmount: 'As directed',
            amazonLink: supplement.amazonLink,
            asinLink: vettedProduct?.asinLink || supplement.amazonLink,
            productName: vettedProduct?.productName || supplement.name,
            vetNote: vettedProduct?.vetNote,
          });
        }
      }
    }
  }

  // Species-specific ingredient recommendations
  if (lowerDeficiency.includes('protein') && species === 'cat') {
    recommendations.push({
      name: 'Taurine Supplement',
      description: 'Essential amino acid for cats',
      benefits: 'Prevents taurine deficiency, supports heart and eye health',
      addressesDeficiency: 'Low protein / Taurine deficiency',
      defaultAmount: '250-500mg per day',
      isIngredient: false,
    });
  }

  if (lowerDeficiency.includes('calcium') || lowerDeficiency.includes('ca:p')) {
    if (species === 'reptile' || species === 'bird') {
      recommendations.push({
        name: 'Calcium with Vitamin D3',
        description: 'Essential for bone health',
        benefits: 'Prevents metabolic bone disease, supports proper Ca:P ratio',
        addressesDeficiency: 'Calcium deficiency / Ca:P imbalance',
        defaultAmount: 'Lightly dust food 2-3x per week',
        isIngredient: false,
      });
    } else {
      recommendations.push({
        name: 'Calcium Supplement',
        description: 'Calcium for bone and dental health',
        benefits: 'Supports proper Ca:P ratio, bone strength',
        addressesDeficiency: 'Calcium deficiency / Ca:P imbalance',
        defaultAmount: 'As directed on package',
        isIngredient: false,
      });
    }
  }

  if (lowerDeficiency.includes('fiber')) {
    recommendations.push({
      name: 'Pumpkin Powder',
      description: 'Natural fiber source',
      benefits: 'Promotes digestive regularity and satiety',
      addressesDeficiency: 'Low fiber',
      defaultAmount: '1-2 tsp per meal',
      isIngredient: true,
    });
  }

  // Health concern-based recommendations
  if (healthConcerns.includes('joint-health') || healthConcerns.includes('joint-mobility')) {
    recommendations.push({
      name: 'Glucosamine & Chondroitin',
      description: 'Joint health supplements',
      benefits: 'Supports cartilage health and joint mobility',
      addressesDeficiency: 'Joint support needed',
      defaultAmount: 'As directed on package',
      isIngredient: false,
    });
  }

  // Remove duplicates based on name
  const uniqueRecommendations = recommendations.filter((rec, index, self) =>
    index === self.findIndex(r => r.name === rec.name)
  );

  return uniqueRecommendations;
}

/**
 * Get all recommendations for a recipe based on nutritional gaps
 */
export function getRecommendationsForRecipe(
  nutritionalGaps: string[],
  species: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
  healthConcerns: string[] = []
): RecommendedSupplement[] {
  const allRecommendations: RecommendedSupplement[] = [];

  for (const gap of nutritionalGaps) {
    const recommendations = getRecommendationsForDeficiency(gap, species, healthConcerns);
    allRecommendations.push(...recommendations);
  }

  // Remove duplicates
  const uniqueRecommendations = allRecommendations.filter((rec, index, self) =>
    index === self.findIndex(r => r.name === rec.name)
  );

  return uniqueRecommendations;
}
</file>

<file path="lib/utils/nutritionFallbacks.ts">
// lib/utils/nutritionFallbacks.ts
// Category-based nutrition fallback data for ingredients missing from INGREDIENT_COMPOSITIONS
// Used when ingredient lookup fails to ensure recipe generation can continue

import type { IngredientComposition } from '@/lib/data/ingredientCompositions';

/**
 * Category-based nutrition templates for fallback data
 * Based on USDA averages and research-based estimates for common ingredient categories
 */
export const CATEGORY_NUTRITION_FALLBACKS: Record<string, IngredientComposition> = {
  poultry: {
    protein: 20.0,
    fat: 8.0,
    carbs: 0,
    fiber: 0,
    moisture: 70,
    calcium: 10,
    phosphorus: 180,
    kcal: 145,
    source: 'estimated_fallback',
    needsReview: true,
  },
  red_meat: {
    protein: 22.0,
    fat: 12.0,
    carbs: 0,
    fiber: 0,
    moisture: 65,
    calcium: 12,
    phosphorus: 190,
    kcal: 180,
    source: 'estimated_fallback',
    needsReview: true,
  },
  fish: {
    protein: 19.0,
    fat: 6.0,
    carbs: 0,
    fiber: 0,
    moisture: 75,
    calcium: 25,
    phosphorus: 220,
    omega3: 1.5,
    kcal: 130,
    source: 'estimated_fallback',
    needsReview: true,
  },
  insect: {
    protein: 15.0,
    fat: 8.0,
    carbs: 5,
    fiber: 2,
    moisture: 70,
    calcium: 30,
    phosphorus: 200,
    kcal: 140,
    source: 'estimated_fallback',
    needsReview: true,
  },
  vegetable: {
    protein: 2.0,
    fat: 0.5,
    carbs: 12,
    fiber: 3,
    moisture: 85,
    calcium: 30,
    phosphorus: 40,
    kcal: 50,
    source: 'estimated_fallback',
    needsReview: true,
  },
  fruit: {
    protein: 1.0,
    fat: 0.3,
    carbs: 15,
    fiber: 2,
    moisture: 80,
    calcium: 10,
    phosphorus: 20,
    kcal: 60,
    source: 'estimated_fallback',
    needsReview: true,
  },
  supplement: {
    protein: 0,
    fat: 0,
    carbs: 0,
    fiber: 0,
    moisture: 5,
    calcium: 500, // High calcium for supplements
    phosphorus: 300,
    kcal: 0,
    source: 'estimated_fallback',
    needsReview: true,
  },
  grain: {
    protein: 8.0,
    fat: 2.0,
    carbs: 75,
    fiber: 5,
    moisture: 10,
    calcium: 20,
    phosphorus: 150,
    kcal: 350,
    source: 'estimated_fallback',
    needsReview: true,
  },
  seed: {
    protein: 15.0,
    fat: 10.0,
    carbs: 50,
    fiber: 8,
    moisture: 8,
    calcium: 50,
    phosphorus: 400,
    kcal: 500,
    source: 'estimated_fallback',
    needsReview: true,
  },
  hay: {
    protein: 8.0,
    fat: 2.0,
    carbs: 60,
    fiber: 30,
    moisture: 10,
    calcium: 40,
    phosphorus: 30,
    kcal: 200,
    source: 'estimated_fallback',
    needsReview: true,
  },
  // Enhanced categories
  leafy_green: {
    protein: 2.5,
    fat: 0.4,
    carbs: 3,
    fiber: 2.5,
    moisture: 92,
    calcium: 100,
    phosphorus: 50,
    kcal: 20,
    source: 'estimated_fallback',
    needsReview: true,
  },
  starchy_veg: {
    protein: 2.0,
    fat: 0.2,
    carbs: 20,
    fiber: 3,
    moisture: 75,
    calcium: 30,
    phosphorus: 50,
    kcal: 85,
    source: 'estimated_fallback',
    needsReview: true,
  },
  fatty_protein: {
    protein: 18.0,
    fat: 15.0,
    carbs: 0,
    fiber: 0,
    moisture: 65,
    calcium: 15,
    phosphorus: 200,
    kcal: 220,
    source: 'estimated_fallback',
    needsReview: true,
  },
  lean_protein: {
    protein: 28.0,
    fat: 3.0,
    carbs: 0,
    fiber: 0,
    moisture: 68,
    calcium: 10,
    phosphorus: 200,
    kcal: 140,
    source: 'estimated_fallback',
    needsReview: true,
  },
};

/**
 * Confidence levels for fallback categories
 */
export const FALLBACK_CONFIDENCE: Record<string, 'high' | 'medium' | 'low'> = {
  poultry: 'medium',
  red_meat: 'medium',
  fish: 'medium',
  insect: 'low',
  vegetable: 'medium',
  fruit: 'medium',
  supplement: 'low',
  grain: 'medium',
  seed: 'medium',
  hay: 'medium',
  leafy_green: 'medium',
  starchy_veg: 'medium',
  fatty_protein: 'medium',
  lean_protein: 'medium',
};

/**
 * Species-specific fallback adjustments
 */
export const SPECIES_FALLBACK_ADJUSTMENTS: Record<string, Partial<IngredientComposition>> = {
  // Cats need more protein and taurine
  cat: {
    // No direct adjustment, but recipes should be tagged
  },
  // Birds need more calcium
  bird: {
    // No direct adjustment, but recipes should be tagged
  },
  // Reptiles need specific Ca:P ratios
  reptile: {
    // No direct adjustment, but recipes should be tagged
  },
};

/**
 * Get fallback nutrition data for an ingredient based on its name patterns
 * @param ingredientName - The ingredient name to match
 * @returns IngredientComposition with estimated values, or default fallback
 */
export function getFallbackNutrition(ingredientName: string): IngredientComposition {
  const lowerName = ingredientName.toLowerCase().trim();
  
  // Lean protein patterns (breast, fillet)
  if ((lowerName.includes('chicken') || lowerName.includes('turkey')) && 
      (lowerName.includes('breast') || lowerName.includes('fillet'))) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.lean_protein };
  }
  
  // Fatty protein patterns (thigh, dark meat, organ meats)
  if (lowerName.includes('thigh') || lowerName.includes('dark meat') ||
      lowerName.includes('liver') || lowerName.includes('heart') ||
      lowerName.includes('kidney') || lowerName.includes('giblet')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.fatty_protein };
  }
  
  // Poultry patterns (general)
  if (lowerName.includes('chicken') || lowerName.includes('turkey') || 
      lowerName.includes('duck') || lowerName.includes('quail') ||
      lowerName.includes('pheasant')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.poultry };
  }
  
  // Red meat patterns
  if (lowerName.includes('beef') || lowerName.includes('lamb') || 
      lowerName.includes('venison') || lowerName.includes('rabbit') ||
      lowerName.includes('bison') || lowerName.includes('elk') ||
      lowerName.includes('goat')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.red_meat };
  }
  
  // Fish patterns
  if (lowerName.includes('fish') || lowerName.includes('salmon') || 
      lowerName.includes('sardine') || lowerName.includes('tuna') ||
      lowerName.includes('mackerel') || lowerName.includes('herring') ||
      lowerName.includes('trout') || lowerName.includes('cod')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.fish };
  }
  
  // Insect patterns
  if (lowerName.includes('mealworm') || lowerName.includes('cricket') || 
      lowerName.includes('insect') || lowerName.includes('waxworm') ||
      lowerName.includes('superworm') || lowerName.includes('roach') ||
      lowerName.includes('locust')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.insect };
  }
  
  // Leafy green patterns (more specific)
  if (lowerName.includes('spinach') || lowerName.includes('kale') || 
      lowerName.includes('lettuce') || lowerName.includes('arugula') ||
      lowerName.includes('endive') || lowerName.includes('escarole') ||
      lowerName.includes('collard') || lowerName.includes('mustard') ||
      lowerName.includes('turnip') || lowerName.includes('dandelion') ||
      lowerName.includes('watercress') || lowerName.includes('mache') ||
      lowerName.includes('frisee') || lowerName.includes('radicchio') ||
      lowerName.includes('swiss chard') || lowerName.includes('beet green')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.leafy_green };
  }
  
  // Starchy vegetable patterns
  if (lowerName.includes('potato') || lowerName.includes('sweet potato') || 
      lowerName.includes('yam') || lowerName.includes('butternut') ||
      lowerName.includes('acorn squash') || lowerName.includes('pumpkin') ||
      lowerName.includes('winter squash') || lowerName.includes('kabocha')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.starchy_veg };
  }
  
  // Other vegetable patterns
  if (lowerName.includes('broccoli') || lowerName.includes('carrot') || 
      lowerName.includes('pea') || lowerName.includes('bean') ||
      lowerName.includes('cabbage') || lowerName.includes('celery') ||
      lowerName.includes('zucchini') || lowerName.includes('pepper') ||
      lowerName.includes('cucumber') || lowerName.includes('bok') ||
      lowerName.includes('radish') || lowerName.includes('asparagus') ||
      lowerName.includes('fennel') || lowerName.includes('leek')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.vegetable };
  }
  
  // Fruit patterns
  if (lowerName.includes('apple') || lowerName.includes('berry') || 
      lowerName.includes('banana') || lowerName.includes('melon') ||
      lowerName.includes('pear') || lowerName.includes('peach') ||
      lowerName.includes('plum') || lowerName.includes('cherry') ||
      lowerName.includes('grape') || lowerName.includes('mango') ||
      lowerName.includes('papaya') || lowerName.includes('fig')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.fruit };
  }
  
  // Supplement patterns
  if (lowerName.includes('supplement') || lowerName.includes('powder') || 
      lowerName.includes('vitamin') || lowerName.includes('mineral') ||
      lowerName.includes('calcium') || lowerName.includes('kelp') ||
      lowerName.includes('spirulina') || lowerName.includes('probiotic')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.supplement };
  }
  
  // Grain patterns
  if (lowerName.includes('rice') || lowerName.includes('oats') || 
      lowerName.includes('barley') || lowerName.includes('wheat') ||
      lowerName.includes('quinoa') || lowerName.includes('buckwheat') ||
      lowerName.includes('millet') || lowerName.includes('corn')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.grain };
  }
  
  // Seed patterns
  if (lowerName.includes('seed') || lowerName.includes('sunflower') || 
      lowerName.includes('pumpkin') || lowerName.includes('flax') ||
      lowerName.includes('chia') || lowerName.includes('hemp')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.seed };
  }
  
  // Hay patterns
  if (lowerName.includes('hay') || lowerName.includes('timothy') || 
      lowerName.includes('alfalfa') || lowerName.includes('orchard')) {
    return { ...CATEGORY_NUTRITION_FALLBACKS.hay };
  }
  
  // Default fallback (average of all categories)
  return {
    protein: 12.0,
    fat: 6.0,
    carbs: 6,
    fiber: 1.5,
    moisture: 70,
    calcium: 86,
    phosphorus: 150,
    kcal: 110,
    source: 'estimated_fallback',
    needsReview: true,
  };
}
</file>

<file path="lib/utils/organicCount.ts">
/**
 * Organic Count Utilities
 * 
 * Makes numeric counts feel more natural and less robotic by:
 * - Avoiding perfect multiples of 10/5
 * - Adding subtle variation
 * - Providing contextual messaging
 */

/**
 * Makes a count look more organic by avoiding "perfect" numbers.
 * Uses deterministic variation based on the count itself to ensure stability.
 * 
 * Examples:
 * - 40 ‚Üí 42 or 38 (avoids multiples of 10)
 * - 35 ‚Üí 36 or 34 (sometimes avoids multiples of 5)
 * - Adds subtle variation (¬±2) to make numbers feel less robotic
 * 
 * @param count The base count to make organic
 * @returns An organic-looking count (stable for the same input)
 */
export function makeCountOrganic(count: number): number {
  let organic = count;
  
  // Use count as seed for deterministic "random" variation
  const seed = count * 17 + 23; // Simple hash function
  
  // Don't show "perfect" multiples of 10
  if (count % 10 === 0) {
    // Convert 40 ‚Üí 42, 50 ‚Üí 47, etc. (deterministic based on count)
    organic = count + ((seed % 2 === 0) ? 2 : -3);
  }
  
  // Don't show "perfect" multiples of 5 (sometimes, deterministic)
  if (count % 5 === 0 && (seed % 10) > 2) {
    organic = count + 1;
  }
  
  // Add subtle variation (¬±2) to make numbers feel less robotic (deterministic)
  const variation = ((seed % 5) - 2); // -2 to +2, stable per count
  organic += variation;
  
  // Ensure it doesn't go below 1
  organic = Math.max(1, organic);
  
  // Round to nearest integer
  organic = Math.round(organic);
  
  return organic;
}

/**
 * Gets a contextual message based on the meal count.
 * 
 * @param count The number of meals found
 * @param species The pet species (optional, for personalization)
 * @returns A contextual message string
 */
export function getCountMessage(count: number, species?: string): string {
  if (count > 60) {
    return `Amazing! We found ${count} perfect meals`;
  }
  if (count > 40) {
    return `Great news! We found ${count} excellent meals`;
  }
  if (count > 25) {
    return `We found ${count} great meal options`;
  }
  if (count > 15) {
    return `We found ${count} good meal options`;
  }
  if (count > 5) {
    return `We found ${count} suitable meals`;
  }
  return `We found ${count} meal option${count !== 1 ? 's' : ''}`;
}

/**
 * Gets subtext based on the meal count.
 * 
 * @param count The number of meals found
 * @param species The pet species (optional, for personalization)
 * @returns A subtext string
 */
export function getSubtext(count: number, species?: string): string {
  const speciesName = species || 'pet';
  
  if (count > 50) {
    return `That's a lot of options! Your ${speciesName} is going to love these.`;
  }
  if (count > 30) {
    return `Plenty of variety for your ${speciesName}.`;
  }
  if (count > 15) {
    return `Good selection for your ${speciesName}'s needs.`;
  }
  if (count > 5) {
    return `Curated selection based on your ${speciesName}'s profile.`;
  }
  return `Limited options due to specific dietary requirements.`;
}
</file>

<file path="lib/utils/petPurchaseTracking.ts">
// lib/utils/petPurchaseTracking.ts
// Per-pet purchase tracking (separate from global village purchase tracking)

import { safeGetItem, safeSetItem, safeParseJSON, safeUpdateItem } from './localStorageSafe';
import { logger } from './logger';
import { validateUserId } from './validation';

export interface PetPurchaseRecord {
  ingredientId: string;
  ingredientName?: string;
  recipeId?: string; // Optional: which recipe this purchase was for
  purchaseDate: string; // ISO string
  confirmed: boolean;
  amazonOrderId?: string;
}

const PREFIX = 'pet_purchases_';

/**
 * Get storage key for pet purchases
 */
function getStorageKey(userId: string, petId: string): string {
  return `${PREFIX}${userId}_${petId}`;
}

/**
 * Load purchases for a pet
 */
export function getPetPurchases(userId: string, petId: string): PetPurchaseRecord[] {
  if (!userId || !petId) {
    return [];
  }

  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in getPetPurchases', { userId, petId });
    return [];
  }

  try {
    const key = getStorageKey(userId, petId);
    const stored = safeGetItem(key);
    
    if (!stored) {
      return [];
    }

    const parsed = safeParseJSON<PetPurchaseRecord[]>(stored, []);
    if (Array.isArray(parsed)) {
      return parsed;
    }

    return [];
  } catch (error) {
    logger.error('Failed to load pet purchases', error as Error, { userId, petId });
    return [];
  }
}

/**
 * Get count of confirmed purchases for a pet
 */
export function getPetPurchaseCount(userId: string, petId: string): number {
  const purchases = getPetPurchases(userId, petId);
  return purchases.filter(p => p.confirmed).length;
}

/**
 * Add a purchase record for a pet
 */
export function addPetPurchase(
  userId: string,
  petId: string,
  ingredientId: string,
  ingredientName?: string,
  recipeId?: string,
  amazonOrderId?: string
): PetPurchaseRecord[] {
  if (!userId || !petId || !ingredientId) {
    logger.warn('Missing required parameters in addPetPurchase', { userId, petId, ingredientId });
    return getPetPurchases(userId, petId);
  }

  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in addPetPurchase', { userId, petId });
    return getPetPurchases(userId, petId);
  }

  const key = getStorageKey(userId, petId);
  const result = safeUpdateItem<PetPurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Check if purchase already exists (avoid duplicates)
    const exists = currentRecords.some(
      r => r.ingredientId === ingredientId && r.confirmed
    );
    
    if (exists) {
      return currentRecords; // Already exists
    }

    // Add new purchase record
    const newRecord: PetPurchaseRecord = {
      ingredientId,
      ingredientName,
      recipeId,
      purchaseDate: new Date().toISOString(),
      confirmed: false,
      ...(amazonOrderId && { amazonOrderId }),
    };

    return [...currentRecords, newRecord];
  });

  if (!result.success) {
    logger.error('Failed to add pet purchase', undefined, { userId, petId, ingredientId, error: result.error });
    return getPetPurchases(userId, petId);
  }

  return result.data || [];
}

/**
 * Confirm a purchase for a pet
 */
export function confirmPetPurchase(
  userId: string,
  petId: string,
  ingredientId: string,
  ingredientName?: string,
  recipeId?: string,
  amazonOrderId?: string
): { success: boolean; error?: string } {
  if (!userId || !petId || !ingredientId) {
    return { success: false, error: 'Missing required parameters' };
  }

  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    return { success: false, error: userIdValidation.error };
  }

  const key = getStorageKey(userId, petId);
  const result = safeUpdateItem<PetPurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Find existing unconfirmed record
    const existingIndex = currentRecords.findIndex(
      r => r.ingredientId === ingredientId && !r.confirmed
    );

    if (existingIndex >= 0) {
      // Update existing record
      const updated = [...currentRecords];
      updated[existingIndex] = {
        ...updated[existingIndex],
        ingredientName: ingredientName || updated[existingIndex].ingredientName,
        recipeId: recipeId || updated[existingIndex].recipeId,
        confirmed: true,
        purchaseDate: new Date().toISOString(),
        ...(amazonOrderId && { amazonOrderId }),
      };
      return updated;
    }

    // Add new confirmed record
    return [
      ...currentRecords,
      {
        ingredientId,
        ingredientName,
        recipeId,
        purchaseDate: new Date().toISOString(),
        confirmed: true,
        ...(amazonOrderId && { amazonOrderId }),
      },
    ];
  });

  if (!result.success) {
    logger.error('Failed to confirm pet purchase', undefined, { userId, petId, ingredientId, error: result.error });
    return { success: false, error: result.error };
  }

  return { success: true };
}
</file>

<file path="lib/utils/petRatingSystem.ts">
// lib/utils/petRatingSystem.ts
import type { Recipe as BaseRecipe } from '@/lib/types';
import { INGREDIENT_COMPOSITIONS, getIngredientComposition } from '@/lib/data/ingredientCompositions';
import { AVIAN_NUTRITION_STANDARDS, getAvianStandards } from '@/lib/data/avian-nutrition-standards';
import { AAFCO_NUTRIENT_PROFILES, getAAFCOStandards, validateCriticalNutrients } from '@/lib/data/aafco-standards';
import { REPTILE_NUTRITION_STANDARDS, getReptileStandards, validateReptileNutrition } from '@/lib/data/reptile-nutrition';
import { BALANCEIT_ANALYSIS } from '@/lib/competitors/balanceit-analysis';

export interface Pet {
  id: string;
  name: string;
  type: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
  breed: string;
  age: number;
  weight?: number;
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very-active';
  healthConcerns: string[];
  dietaryRestrictions: string[];
  allergies?: string[];
  dislikes?: string[];
  savedRecipes?: string[];
  names?: string[];
  weightKg?: number;
}

// Helper to detect if data is just the auto-generated placeholder
function isGenericNutrition(n: any): boolean {
  if (!n) return true;
  // Checks for the specific ranges found in your recipes-complete.ts
  return n.protein?.min === 25 && n.fat?.min === 10 && n.fiber?.min === 2;
}

function extractNutrition(recipe: any): {
  protein: number;
  fat: number;
  fiber: number;
  calories: number;
  phosphorus: number;
  isGeneric: boolean;
} | null {
  // Check for nutritionalInfo object
  if (recipe.nutritionalInfo) {
    const isGeneric = isGenericNutrition(recipe.nutritionalInfo);
    return {
      protein: recipe.nutritionalInfo.protein?.min || 0,
      fat: recipe.nutritionalInfo.fat?.min || 0,
      fiber: recipe.nutritionalInfo.fiber?.min || 0,
      calories: recipe.nutritionalInfo.calories?.min || 0,
      phosphorus: recipe.nutritionalInfo.phosphorus?.min || 0,
      isGeneric
    };
  }
  return null;
}

function enrichRecipeFromIngredients(recipe: any): {
  estimatedProtein: number;
  estimatedFat: number;
  estimatedPhosphorus: 'low' | 'moderate' | 'high';
  healthBenefits: string[];
  allergens: string[];
} {
  const name = recipe.name?.toLowerCase() || '';
  const ingredients = recipe.ingredients
    ?.map((i: any) => (typeof i === 'string' ? i : i.name).toLowerCase())
    .join(' ') || '';

  const allText = `${name} ${ingredients}`;

  // Create variation based on protein source
  let estimatedProtein = 25;
  if (allText.includes('venison')) estimatedProtein = 34; // Leaner, high protein
  else if (allText.includes('rabbit')) estimatedProtein = 33;
  else if (allText.includes('salmon') || allText.includes('fish')) estimatedProtein = 32;
  else if (allText.includes('chicken')) estimatedProtein = 30;
  else if (allText.includes('turkey')) estimatedProtein = 29;
  else if (allText.includes('beef')) estimatedProtein = 28;
  else if (allText.includes('pork')) estimatedProtein = 27;

  // Fat estimation
  let estimatedFat = 15;
  if (allText.includes('salmon') || allText.includes('duck')) estimatedFat = 18;
  else if (allText.includes('lean') || allText.includes('turkey')) estimatedFat = 10;
  else if (allText.includes('pork') || allText.includes('lamb')) estimatedFat = 16;

  // Phosphorus estimation
  let estimatedPhosphorus: 'low' | 'moderate' | 'high' = 'moderate';
  if (allText.includes('liver') || allText.includes('kidney') || allText.includes('organ')) {
    estimatedPhosphorus = 'high';
  } else if (allText.includes('egg whites') || allText.includes('rice')) {
    estimatedPhosphorus = 'low';
  }

  // Auto-detect Health benefits if tags are missing
  const healthBenefits: string[] = [];
  if (allText.includes('salmon') || allText.includes('fish oil') || allText.includes('flaxseed')) {
    healthBenefits.push('joint-health', 'skin-conditions');
  }
  if (allText.includes('pumpkin') || allText.includes('rice')) {
    healthBenefits.push('digestive-issues');
  }
  if (allText.includes('lean') || allText.includes('turkey') || allText.includes('white fish')) {
    healthBenefits.push('weight-management', 'pancreatitis');
  }
  if (allText.includes('liver') || allText.includes('organ')) {
    // Often good for general vitality but bad for kidney
    healthBenefits.push('recovery');
  }

  // Allergens
  const allergens: string[] = [];
  if (allText.includes('chicken')) allergens.push('chicken');
  if (allText.includes('beef')) allergens.push('beef');
  if (allText.includes('dairy') || allText.includes('milk')) allergens.push('dairy');
  if (allText.includes('wheat') || allText.includes('grain')) allergens.push('grain');
  if (allText.includes('egg')) allergens.push('egg');

  return {
    estimatedProtein,
    estimatedFat,
    estimatedPhosphorus,
    healthBenefits,
    allergens
  };
}

// Enhanced nutrition calculation using real USDA data
function calculateRecipeNutrition(recipe: any): {
  protein: number;
  fat: number;
  calcium: number;
  phosphorus: number;
  calories: number;
  omega3?: number;
  vitaminA?: number;
  vitaminC?: number;
  source: 'real' | 'estimated';
} {
  const ingredients = recipe.ingredients || [];
  let totalProtein = 0;
  let totalFat = 0;
  let totalCalcium = 0;
  let totalPhosphorus = 0;
  let totalCalories = 0;
  let totalOmega3 = 0;
  let totalVitaminA = 0;
  let totalVitaminC = 0;
  let totalWeight = 0;

  // Try to get real nutritional data
  for (const ingredient of ingredients) {
    const name = typeof ingredient === 'string' ? ingredient : ingredient.name;
    const amount = typeof ingredient === 'string' ? 100 : (ingredient.amount || 100); // Assume 100g if not specified

    const composition = getIngredientComposition(name);
    if (composition) {
      totalProtein += (composition.protein || 0) * (amount / 100);
      totalFat += (composition.fat || 0) * (amount / 100);
      totalCalcium += (composition.calcium || 0) * (amount / 100);
      totalPhosphorus += (composition.phosphorus || 0) * (amount / 100);
      totalCalories += (composition.kcal || 0) * (amount / 100);
      totalOmega3 += (composition.omega3 || 0) * (amount / 100);
      totalVitaminA += (composition.vitaminA || 0) * (amount / 100);
      totalVitaminC += (composition.vitaminC || 0) * (amount / 100);
      totalWeight += amount;
    }
  }

  // If we have real data for at least 50% of ingredients, use it
  const realDataRatio = totalWeight / (ingredients.length * 100);
  if (realDataRatio >= 0.5) {
    return {
      protein: totalProtein / totalWeight * 100,
      fat: totalFat / totalWeight * 100,
      calcium: totalCalcium / totalWeight * 100,
      phosphorus: totalPhosphorus / totalWeight * 100,
      calories: totalCalories / totalWeight * 100,
      omega3: totalOmega3 > 0 ? totalOmega3 / totalWeight * 100 : undefined,
      vitaminA: totalVitaminA > 0 ? totalVitaminA / totalWeight * 100 : undefined,
      vitaminC: totalVitaminC > 0 ? totalVitaminC / totalWeight * 100 : undefined,
      source: 'real'
    };
  }

  // Fall back to estimated values
  const enriched = enrichRecipeFromIngredients(recipe);
  return {
    protein: enriched.estimatedProtein,
    fat: enriched.estimatedFat,
    calcium: 0.8, // Estimated
    phosphorus: enriched.estimatedPhosphorus === 'high' ? 0.8 : enriched.estimatedPhosphorus === 'low' ? 0.3 : 0.5,
    calories: 150, // Estimated
    source: 'estimated'
  };
}

// Species-specific compatibility scoring
function calculateAvianCompatibility(recipe: any, pet: Pet): number {
  const standards = getAvianStandards(pet.breed) || AVIAN_NUTRITION_STANDARDS.psittacines;
  const nutrition = calculateRecipeNutrition(recipe);

  let score = 100;

  // Check Ca:P ratio (most critical for birds)
  const caPRatio = nutrition.calcium / nutrition.phosphorus;
  const caPMin = standards.CaP_ratio?.min || 1.5;
  const caPMax = standards.CaP_ratio?.max || 2.5;
  const caPIdeal = (standards.CaP_ratio as any)?.ideal || 2.0;

  if (caPRatio < caPMin || caPRatio > caPMax) {
    score -= 40; // Major penalty for improper ratio
  } else if (Math.abs(caPRatio - caPIdeal) < 0.5) {
    score += 10; // Bonus for ideal ratio
  }

  // Check protein levels
  const proteinMin = standards.protein?.min || 12;
  const proteinMax = standards.protein?.max || 18;
  if (nutrition.protein < proteinMin || nutrition.protein > proteinMax) {
    score -= 20;
  }

  // Check fat levels
  const fatMin = standards.fat?.min || 4;
  const fatMax = standards.fat?.max || 10;
  if (nutrition.fat < fatMin || nutrition.fat > fatMax) {
    score -= 15;
  }

  return Math.max(0, Math.min(100, score));
}

function calculateReptileCompatibility(recipe: any, pet: Pet): number {
  const standards = getReptileStandards(pet.breed);
  if (!standards) return 75; // Default score if species not found

  const nutrition = calculateRecipeNutrition(recipe);
  let score = 100;

  // Check Ca:P ratio (critical for reptiles)
  const caPRatio = nutrition.calcium / nutrition.phosphorus;
  if (caPRatio < standards.CaP_ratio.min || caPRatio > standards.CaP_ratio.max) {
    score -= 50; // Severe penalty for improper ratio
  } else if (Math.abs(caPRatio - standards.CaP_ratio.ideal) < 0.5) {
    score += 15; // Bonus for ideal ratio
  }

  // Check calcium levels
  if (nutrition.calcium < standards.calcium.min) {
    score -= 30;
  }

  // Check protein levels
  if (nutrition.protein < standards.protein.min || nutrition.protein > standards.protein.max) {
    score -= 20;
  }

  return Math.max(0, Math.min(100, score));
}

function calculateSpeciesSpecificScore(recipe: any, pet: Pet): number {
  switch (pet.type) {
    case 'bird':
      return calculateAvianCompatibility(recipe, pet);
    case 'reptile':
      return calculateReptileCompatibility(recipe, pet);
    case 'dog':
    case 'cat':
      // Use AAFCO validation for mammals
      const lifeStage = pet.age < 1 ? 'growth' : 'adult';
      const validation = validateCriticalNutrients(recipe, pet.type as 'dog' | 'cat', lifeStage);
      return validation.isValid ? 95 : Math.max(60, 95 - (validation.violations.length * 15));
    default:
      return 85; // Default score for pocket pets
  }
}

interface RatingFactor {
  score: number;
  weight: number;
  reason: string;
}

export interface CompatibilityRating {
  overallScore: number;
  compatibility: 'excellent' | 'good' | 'fair' | 'poor';
  breakdown: Record<string, RatingFactor>;
  warnings: string[];
  strengths: string[];
  recommendations: string[];
}

// Helper to normalize health concern keys
function normalizeHealthConcernKey(concern: string): string {
  const normalized = concern.toLowerCase().trim()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
  
  // Map variations to standard keys
  const mapping: Record<string, string> = {
    'pancreatitis': 'pancreatitis',
    'pancreatic': 'pancreatitis',
    'heart-disease': 'heart-disease',
    'heart disease': 'heart-disease',
    'heart': 'heart-disease',
    'diabetes': 'diabetes',
    'diabetic': 'diabetes',
    'skin-conditions': 'skin-conditions',
    'skin conditions': 'skin-conditions',
    'skin condition': 'skin-conditions',
    'skin-coat': 'skin-conditions',
    'allergies': 'allergies',
    'allergy': 'allergies',
    'skin-issues': 'allergies',
    'skin issues': 'allergies',
    'kidney-disease': 'kidney-disease',
    'kidney disease': 'kidney-disease',
    'kidney': 'kidney-disease',
    'digestive-issues': 'digestive-issues',
    'digestive issues': 'digestive-issues',
    'digestive': 'digestive-issues',
    'joint-health': 'joint-health',
    'joint health': 'joint-health',
    'arthritis': 'joint-health',
    'joint pain': 'joint-health',
    'weight-management': 'weight-management',
    'weight management': 'weight-management',
    'obesity': 'weight-management',
    'dental-issues': 'dental-issues',
    'dental issues': 'dental-issues',
    'dental': 'dental-issues'
  };
  
  return mapping[normalized] || normalized;
}

const HEALTH_CONCERNS: Record<string, { maxPhosphorus?: number; maxFat?: number; maxProtein?: number; minProtein?: number; restrictions: string[]; requires?: string[] }> = {
  'kidney-disease': { maxPhosphorus: 200, restrictions: ['liver', 'kidney', 'organ'], requires: ['low-phosphorus', 'high-quality-protein'] },
  'pancreatitis': { maxFat: 12, restrictions: ['high-fat', 'pork', 'lamb', 'duck', 'fried', 'greasy'], requires: ['low-fat', 'easily-digestible'] },
  'obesity': { maxFat: 12, maxProtein: 30, restrictions: ['high-calorie', 'treats'], requires: ['low-calorie', 'high-fiber'] },
  'digestive-issues': { restrictions: ['spicy', 'raw', 'high-fiber', 'dairy'], requires: ['easily-digestible', 'bland'] },
  'allergies': { restrictions: ['chicken', 'beef', 'dairy', 'wheat', 'corn', 'soy', 'eggs'], requires: ['novel-protein', 'hypoallergenic'] },
  'joint-health': { restrictions: [], requires: ['omega-3', 'glucosamine', 'chondroitin'] },
  'skin-conditions': { restrictions: ['artificial-colors', 'preservatives'], requires: ['omega-3', 'quality-protein', 'vitamin-e'] },
  'heart-disease': { maxFat: 15, restrictions: ['high-sodium', 'processed'], requires: ['taurine', 'omega-3', 'low-sodium'] },
  'diabetes': { maxFat: 15, restrictions: ['high-sugar', 'simple-carbs', 'corn-syrup'], requires: ['complex-carbs', 'high-fiber', 'low-glycemic'] }
};

/**
 * Calculates compatibility rating between a recipe and a pet profile.
 * 
 * @param recipe - Recipe object from recipes-complete.ts
 * @param pet - Pet profile with type, age, weight, health concerns, etc.
 * @returns CompatibilityRating with overall score (0-100), breakdown, warnings, and recommendations
 * 
 * @example
 * ```ts
 * const rating = rateRecipeForPet(recipe, pet);
 * console.log(rating.overallScore); // 85
 * console.log(rating.compatibility); // 'excellent'
 * ```
 * 
 * @contract
 * - Input: Recipe from lib/data/recipes-complete.ts, Pet from localStorage/backend
 * - Output: CompatibilityRating with standardized structure
 * - Side effects: None (pure function)
 * - Migration: Compatible with Firebase/Supabase (receives Pet object, not storage)
 */
export function rateRecipeForPet(recipe: any, pet: Pet): CompatibilityRating {
  // Normalize array-like fields to avoid runtime errors
  const safePet: Pet = {
    ...pet,
    dietaryRestrictions: Array.isArray((pet as any).dietaryRestrictions) ? (pet as any).dietaryRestrictions : [],
    allergies: Array.isArray(pet.allergies) ? pet.allergies : [],
    healthConcerns: Array.isArray(pet.healthConcerns) ? pet.healthConcerns : [],
    dislikes: Array.isArray((pet as any).dislikes) ? (pet as any).dislikes : [],
  };

  const warnings: string[] = [];
  const strengths: string[] = [];
  const recommendations: string[] = [];

  const nutrition = extractNutrition(recipe);
  const enriched = enrichRecipeFromIngredients(recipe);
  const realNutrition = calculateRecipeNutrition(recipe);

  // 1. Pet Type Match (20%)
  const petTypeMatch = (recipe.category === safePet.type || recipe.category === `${safePet.type}s`) ? 100 : 0;

  // 2. Age Appropriate (15%)
  const petAgeGroup = safePet.age < 1 ? 'baby' : safePet.age < 2 ? 'young' : safePet.age < 7 ? 'adult' : 'senior';
  const ageMatch = (recipe.ageGroup || []).includes(petAgeGroup) || (recipe.ageGroup || []).includes('all');
  const ageScore = ageMatch ? 100 : 70;

  // 3. Species-Specific Nutritional Fit (30%)
  const speciesScore = calculateSpeciesSpecificScore(recipe, safePet);

  // 4. Health Compatibility (25%)
  // Fix: Start at 100 for pets with no health concerns, not 90
  let healthScore = safePet.healthConcerns.length === 0 ? 100 : 90;

  // Use recipe tags if available, otherwise fallback to ingredient inference
  const effectiveHealthTags = (recipe.healthConcerns && recipe.healthConcerns.length > 0)
    ? recipe.healthConcerns
    : enriched.healthBenefits;

  if (safePet.healthConcerns.length > 0) {
    healthScore = 70; // Start lower

    for (const concern of safePet.healthConcerns) {
      // Bonus for matching benefits
      if (effectiveHealthTags.some((tag: string) => tag.includes(concern) || concern.includes(tag))) {
        healthScore += 20;
        strengths.push(`Great for ${concern}`);
      }

      // Penalties for contradictions
      const normalizedConcern = normalizeHealthConcernKey(concern);
      const rules = HEALTH_CONCERNS[normalizedConcern];
      if (rules) {
        // Check Fat cap
        const fatVal = (nutrition && !nutrition.isGeneric) ? nutrition.fat : enriched.estimatedFat;
        if (rules.maxFat && fatVal > rules.maxFat) {
          healthScore -= 25;
          warnings.push(`Fat content slightly high for ${concern}`);
        }

        // Check ingredient restrictions
        const hasRestricted = rules.restrictions.some(r => enriched.allergens.includes(r));
        if (hasRestricted) {
           healthScore -= 30;
        }
      }
    }
  }

  // 5. Allergen Safety (10%)
  let allergenScore = 100;
  const allRestrictions = [...(safePet.dietaryRestrictions || []), ...(safePet.healthConcerns?.includes('allergies') ? safePet.allergies || [] : [])];

  for (const restriction of allRestrictions) {
    const rLower = restriction.toLowerCase();
    // Check against inferred allergens from ingredients
    if (enriched.allergens.some(a => rLower.includes(a) || a.includes(rLower))) {
      allergenScore = 0;
      warnings.push(`Contains ${restriction}`);
    }
  }

  // 6. Picky Eater Check (5% penalty for disliked ingredients)
  let pickyEaterPenalty = 0;
  if (pet.dislikes && pet.dislikes.length > 0) {
    for (const dislike of pet.dislikes) {
      const dLower = dislike.toLowerCase();
      // Check if recipe contains disliked ingredients
      if (enriched.allergens.some(a => dLower.includes(a) || a.includes(dLower))) {
        pickyEaterPenalty = 5; // Small penalty
        warnings.push(`Contains ${dislike} (pet may not like)`);
        break; // Only penalize once
      }
    }
  }

  // Calculate Overall
  const overallScore = Math.max(0, Math.min(100, Math.round(
    (petTypeMatch * 0.20) +
    (ageScore * 0.15) +
    (speciesScore * 0.30) +
    (healthScore * 0.25) +
    (allergenScore * 0.10)
  ) - pickyEaterPenalty));

  let compatibility: 'excellent' | 'good' | 'fair' | 'poor';
  if (overallScore >= 85) compatibility = 'excellent';
  else if (overallScore >= 70) compatibility = 'good';
  else if (overallScore >= 50) compatibility = 'fair';
  else compatibility = 'poor';

  return {
    overallScore,
    compatibility,
    breakdown: {
      petTypeMatch: {
        score: petTypeMatch,
        weight: 25,
        reason: petTypeMatch === 100
          ? `Recipe is specifically designed for ${pet.type}s`
          : `Recipe is designed for ${recipe.category}, but your pet is a ${pet.type}`
      },
      ageAppropriate: {
        score: ageScore,
        weight: 15,
        reason: ageMatch
          ? `Recipe is suitable for ${petAgeGroup} ${pet.type}s`
          : `Recipe is designed for ${recipe.ageGroup?.join(', ') || 'different age groups'}, but your pet is ${petAgeGroup}`
      },
      nutritionalFit: {
        score: speciesScore,
        weight: 30,
        reason: realNutrition.source === 'real'
          ? `Recipe uses real USDA nutritional data and meets ${pet.type} nutritional standards`
          : `Recipe meets estimated nutritional requirements for ${pet.type}s`
      },
      healthCompatibility: {
        score: healthScore,
        weight: 25,
        reason: pet.healthConcerns.length === 0
          ? 'No specific health concerns to evaluate'
          : `${effectiveHealthTags.length > 0 ? 'Recipe contains ingredients beneficial for' : 'Recipe may not address'} your pet's health concerns: ${pet.healthConcerns.join(', ')}`
      },
      allergenSafety: {
        score: allergenScore,
        weight: 10,
        reason: allRestrictions.length === 0
          ? 'No dietary restrictions or allergies specified'
          : allergenScore === 100
            ? 'Recipe avoids all known allergens and restrictions'
            : `Recipe contains ingredients that may conflict with restrictions: ${allRestrictions.join(', ')}`
      }
    },
    warnings,
    strengths,
    recommendations
  };
}

// Utility functions for pet profile management
export function savePetProfile(pet: Pet): void {
  if (typeof window === 'undefined') return;

  const pets = getUserPets();
  const existingIndex = pets.findIndex(p => p.id === pet.id);

  if (existingIndex >= 0) {
    pets[existingIndex] = pet;
  } else {
    pets.push(pet);
  }

  localStorage.setItem('userPets', JSON.stringify(pets));
}

export function getUserPets(): Pet[] {
  if (typeof window === 'undefined') return [];

  const stored = localStorage.getItem('userPets');
  return stored ? JSON.parse(stored) : [];
}

export function deletePetProfile(petId: string): void {
  if (typeof window === 'undefined') return;

  const pets = getUserPets().filter(p => p.id !== petId);
  localStorage.setItem('userPets', JSON.stringify(pets));
}

export const healthConcernOptions = [
  { value: 'kidney-disease', label: 'Kidney Disease' },
  { value: 'heart-disease', label: 'Heart Disease' },
  { value: 'diabetes', label: 'Diabetes' },
  { value: 'allergies', label: 'Food Allergies' },
  { value: 'obesity', label: 'Weight Management/Obesity' },
  { value: 'pancreatitis', label: 'Pancreatitis' },
  { value: 'digestive-issues', label: 'Digestive Issues' },
  { value: 'joint-health', label: 'Joint Problems/Arthritis' },
  { value: 'dental-issues', label: 'Dental Issues' },
  { value: 'hip-dysplasia', label: 'Hip Dysplasia' },
  { value: 'skin-conditions', label: 'Skin Conditions' }
];

export const dietaryRestrictionOptions = [
  { value: 'grain-free', label: 'Grain-Free' },
  { value: 'no-chicken', label: 'No Chicken' },
  { value: 'no-beef', label: 'No Beef' },
  { value: 'no-dairy', label: 'No Dairy' },
  { value: 'low-sodium', label: 'Low Sodium' },
  { value: 'low-phosphorus', label: 'Low Phosphorus' },
  { value: 'low-fat', label: 'Low Fat' },
  { value: 'soft-food', label: 'Soft Food Only' },
  { value: 'hypoallergenic', label: 'Hypoallergenic' }
];

export const activityLevels = [
  {
    value: 'sedentary' as const,
    label: 'Sedentary',
    description: 'Mostly inactive, minimal exercise'
  },
  {
    value: 'moderate' as const,
    label: 'Moderate',
    description: 'Regular walks, some playtime'
  },
  {
    value: 'active' as const,
    label: 'Active',
    description: 'Daily exercise, lots of playtime'
  },
  {
    value: 'very-active' as const,
    label: 'Very Active',
    description: 'Working dog, intensive daily exercise'
  }
];
</file>

<file path="lib/utils/petStorage.ts">
// lib/utils/petStorage.ts
// Abstracted pet storage layer - Migrated to Firestore
// Note: All operations are now ASYNCHRONOUS

import { Pet } from '@/lib/types'; // Updated import to use shared type
import * as firestoreService from '@/lib/services/firestoreService';

/**
 * Retrieves all pets for a given user.
 * 
 * @param userId - User identifier
 * @returns Promise<Pet[]>
 */
export async function getPets(userId: string): Promise<Pet[]> {
  if (!userId) return [];
  
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - using localStorage only');
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`pets_${userId}`);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return [];
        }
      }
    }
    return [];
  }
  
  // Try Firestore first
  try {
    const pets = await firestoreService.getPets(userId);
    if (pets.length > 0) return pets;
    
    // Auto-migration: If Firestore is empty but localStorage has data, upload it
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`pets_${userId}`);
      if (stored) {
        try {
          const localPets: Pet[] = JSON.parse(stored);
          if (localPets.length > 0) {
            console.log('Migrating local pets to Firestore...');
            // Upload all local pets
            await Promise.all(localPets.map(p => firestoreService.savePet(userId, p)));
            return localPets;
          }
        } catch (e) {
          console.error('Migration failed:', e);
        }
      }
    }
  } catch (e) {
    console.warn('Firestore getPets failed, falling back to localStorage if available', e);
  }

  // Fallback to localStorage for smooth migration/offline (optional)
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem(`pets_${userId}`);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch {
        return [];
      }
    }
  }
  return [];
}

/**
 * Saves a pet to storage.
 * 
 * @param userId - User identifier
 * @param pet - Pet object to save
 * @returns Promise<void>
 */
export async function savePet(userId: string, pet: Pet): Promise<void> {
  if (!userId) return;
  
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - saving to localStorage only');
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`pets_${userId}`);
      let localPets: Pet[] = [];
      try {
        localPets = stored ? JSON.parse(stored) : [];
      } catch {
        localPets = [];
      }
      // Update or add the pet
      const index = localPets.findIndex(p => p.id === pet.id);
      if (index >= 0) {
        localPets[index] = pet;
      } else {
        localPets.push(pet);
      }
      localStorage.setItem(`pets_${userId}`, JSON.stringify(localPets));
      
      // Dispatch custom event for same-tab updates
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('petsUpdated', { detail: { userId, petId: pet.id } }));
      }
    }
    return;
  }
  
  // Save to Firestore
  await firestoreService.savePet(userId, pet);
  
  // Also sync to localStorage for backup/offline compatibility
  if (typeof window !== 'undefined') {
    const pets = await getPets(userId); // Recalculate or just append?
    // Optimization: Just update local array without refetching if possible, but simplest is to fetch-update-save logic
    // Let's mimic old sync logic for localStorage mirror
    const stored = localStorage.getItem(`pets_${userId}`);
    let localPets: Pet[] = stored ? JSON.parse(stored) : [];
    
    const index = localPets.findIndex(p => p.id === pet.id);
    if (index >= 0) {
      localPets[index] = pet;
    } else {
      localPets.push(pet);
    }
    localStorage.setItem(`pets_${userId}`, JSON.stringify(localPets));
    
    // Dispatch custom event for same-tab updates
    window.dispatchEvent(new CustomEvent('petsUpdated', { detail: { userId, petId: pet.id } }));
  }
}

/**
 * Deletes a pet from storage.
 * 
 * @param userId - User identifier
 * @param petId - Pet ID to delete
 * @returns Promise<void>
 */
export async function deletePet(userId: string, petId: string): Promise<void> {
  if (!userId) return;
  
  // TEMPORARY: Skip Firestore entirely if no Firebase config
  const hasFirebase = typeof process !== 'undefined' && process.env?.NEXT_PUBLIC_FIREBASE_API_KEY;
  if (!hasFirebase) {
    console.log('Firebase not configured - deleting from localStorage only');
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(`pets_${userId}`);
      if (stored) {
        try {
          const pets: Pet[] = JSON.parse(stored);
          const filtered = pets.filter(p => p.id !== petId);
          localStorage.setItem(`pets_${userId}`, JSON.stringify(filtered));
        } catch (e) {
          console.error('Error deleting pet from localStorage:', e);
        }
      }
    }
    return;
  }
  
  await firestoreService.deletePet(userId, petId);
  
  // Sync localStorage
  if (typeof window !== 'undefined') {
    const stored = localStorage.getItem(`pets_${userId}`);
    if (stored) {
      const pets: Pet[] = JSON.parse(stored);
      const filtered = pets.filter(p => p.id !== petId);
      localStorage.setItem(`pets_${userId}`, JSON.stringify(filtered));
    }
  }
}

/**
 * Gets a single pet by ID.
 * 
 * @param userId - User identifier
 * @param petId - Pet ID to retrieve
 * @returns Promise<Pet | null>
 */
export async function getPet(userId: string, petId: string): Promise<Pet | null> {
  const pets = await getPets(userId);
  return pets.find(p => p.id === petId) || null;
}
</file>

<file path="lib/utils/petUtils.ts">
// Utility functions for pet management
import type { Pet } from '../types';
export type { Pet } from '../types';

/**
 * Get a random name from the pet's names array
 * Falls back to the first name if array is empty
 */
export function getRandomName(names: string[]): string {
  if (!names || names.length === 0) {
    return 'Unnamed Pet';
  }
  const randomIndex = Math.floor(Math.random() * names.length);
  return names[randomIndex];
}

/**
 * Get the primary name (first in the array)
 */
export function getPrimaryName(names: string[]): string {
  if (!names || names.length === 0) {
    return 'Unnamed Pet';
  }
  return names[0];
}

/**
 * Format names for display (e.g., "Buddy, Max, Charlie")
 */
export function formatNames(names: string[]): string {
  if (!names || names.length === 0) {
    return 'Unnamed Pet';
  }
  if (names.length === 1) {
    return names[0];
  }
  return names.join(', ');
}
</file>

<file path="lib/utils/priceValidation.ts">
/**
 * Price validation utilities for vetted products
 * Prevents outlier prices from scraping errors (e.g., third-party sellers with inflated prices)
 */

export type ProductCategory = 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';

/**
 * Maximum reasonable prices per category (USD)
 * These are conservative limits to catch obvious errors from third-party sellers
 */
const MAX_REASONABLE_PRICES: Record<ProductCategory, number> = {
  Vegetable: 15,      // Bulk vegetables, but $124 for collard greens is clearly wrong
  Meat: 80,           // Bulk frozen meat can be expensive
  Carb: 75,           // Bulk grains/potatoes
  Oil: 40,            // Cooking oils and supplements
  Supplement: 100,    // Supplements can be expensive but have limits
  Fruit: 30,          // Fresh fruits
  Seed: 50,           // Seeds and nuts
  Insect: 50,         // Dried insects for pets
  Hay: 50,            // Hay bales
  Pellet: 80,         // Pellet food
};

/**
 * Check if a price is reasonable for the given category
 */
export function isPriceReasonable(price: number, category?: ProductCategory | string): boolean {
  if (!category) return true; // No category = no validation
  
  const normalizedCategory = category as ProductCategory;
  if (!(normalizedCategory in MAX_REASONABLE_PRICES)) {
    // Unknown category, allow it (might be a new category)
    return true;
  }
  
  const maxPrice = MAX_REASONABLE_PRICES[normalizedCategory];
  return price <= maxPrice;
}

/**
 * Get the maximum reasonable price for a category
 */
export function getMaxReasonablePrice(category?: ProductCategory | string): number | null {
  if (!category) return null;
  
  const normalizedCategory = category as ProductCategory;
  return MAX_REASONABLE_PRICES[normalizedCategory] || null;
}

/**
 * Validate and optionally cap a price
 * Returns the original price if valid, or null if it exceeds the max
 */
export function validatePrice(
  price: number,
  category?: ProductCategory | string
): number | null {
  if (isPriceReasonable(price, category)) {
    return price;
  }
  
  // Price exceeds reasonable limit - return null to mark as invalid/unavailable
  return null;
}
</file>

<file path="lib/utils/purchaseLinks.ts">
import { ensureSellerId, isValidAmazonUrl } from '@/lib/utils/affiliateLinks';
import { getProductPriceUrl } from '@/lib/data/product-prices';

export function buildAmazonSearchUrl(query: string): string {
  const q = String(query || '').trim();
  if (!q) return '';
  return `https://www.amazon.com/s?k=${encodeURIComponent(q)}`;
}

export function getIngredientPurchaseUrl(
  ingredientName: string,
  existingUrl?: string | null,
  species?: string
): string {
  const baseName = String(ingredientName || '').trim();

  const pricedUrl = getProductPriceUrl(baseName);
  if (pricedUrl) return ensureSellerId(pricedUrl);

  const candidate = String(existingUrl || '').trim();
  if (candidate && isValidAmazonUrl(candidate)) return ensureSellerId(candidate);

  const searchUrl = buildAmazonSearchUrl(baseName);
  return searchUrl ? ensureSellerId(searchUrl) : '';
}
</file>

<file path="lib/utils/purchaseTracking.ts">
/**
 * Purchase Tracking System
 * Tracks cumulative ingredient purchases across all pets for village evolution
 * 
 * Combines:
 * - Simple API from guide (loadPurchases, addPurchase, etc.)
 * - Transaction safety from our implementation (prevents race conditions)
 * - Robust error handling and validation
 */

import { safeGetItem, safeSetItem, safeParseJSON, safeStringifyJSON, safeUpdateItem } from './localStorageSafe';
import { logger } from './logger';
import { validateUserId } from './validation';

export interface PurchaseRecord {
  ingredientId: string;
  ingredientName?: string; // Optional for backward compatibility
  purchaseDate: string; // ISO string
  confirmed: boolean;
  amazonOrderId?: string; // For Amazon API integration
}

const PREFIX = 'ingredient_purchases_';

/**
 * Get storage key for user's purchases
 */
export function getStorageKey(userId: string): string {
  return `${PREFIX}${userId}`;
}

// =================================================================
// SIMPLE API (from guide) - Transaction-safe implementation
// =================================================================

/**
 * Load all purchase records for a user
 * Simple API matching guide's interface
 */
export function loadPurchases(userId: string): PurchaseRecord[] {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in loadPurchases', { userId });
    return [];
  }
  
  const key = getStorageKey(userId);
  const raw = safeGetItem(key);
  return safeParseJSON<PurchaseRecord[]>(raw, []);
}

/**
 * Save purchase records for a user
 * Simple API matching guide's interface
 */
export function savePurchases(userId: string, records: PurchaseRecord[]): boolean {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in savePurchases', { userId });
    return false;
  }
  
  const key = getStorageKey(userId);
  const jsonString = safeStringifyJSON(records);
  if (!jsonString) {
    logger.error('Failed to stringify purchase records', undefined, { userId, recordCount: records.length });
    return false;
  }
  
  const result = safeSetItem(key, jsonString);
  if (!result.success) {
    logger.error('Failed to save purchase records', undefined, { userId, error: result.error });
  }
  
  return result.success;
}

/**
 * Add a purchase (transaction-safe)
 * Simple API matching guide's interface
 * @param confirmed - Whether purchase is confirmed (default: false)
 */
export function addPurchase(
  userId: string,
  ingredientId: string,
  confirmed: boolean = false,
  ingredientName?: string
): PurchaseRecord[] {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in addPurchase', { userId });
    return [];
  }
  
  if (!ingredientId) {
    logger.warn('Missing ingredientId in addPurchase', { userId });
    return loadPurchases(userId);
  }
  
  const key = getStorageKey(userId);
  const result = safeUpdateItem<PurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Add new purchase record
    return [
      ...currentRecords,
      {
        ingredientId,
        ingredientName: ingredientName || ingredientId, // Use ingredientId as fallback
        purchaseDate: new Date().toISOString(),
        confirmed
      }
    ];
  });
  
  if (!result.success) {
    logger.error('Failed to add purchase', undefined, { userId, ingredientId, error: result.error });
    return loadPurchases(userId); // Return current state on failure
  }
  
  return result.data || [];
}

/**
 * Confirm a purchase (mark as confirmed)
 * Simple API matching guide's interface
 * Uses transaction-safe update to prevent race conditions
 */
export function confirmPurchase(userId: string, ingredientId: string): PurchaseRecord[] {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    logger.warn('Invalid userId in confirmPurchase', { userId });
    return [];
  }
  
  if (!ingredientId) {
    logger.warn('Missing ingredientId in confirmPurchase', { userId });
    return loadPurchases(userId);
  }
  
  const key = getStorageKey(userId);
  const result = safeUpdateItem<PurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Find and update existing record
    const idx = currentRecords.findIndex(r => r.ingredientId === ingredientId && !r.confirmed);
    if (idx >= 0) {
      const updated = [...currentRecords];
      updated[idx] = {
        ...updated[idx],
        confirmed: true,
        purchaseDate: new Date().toISOString() // Update timestamp
      };
      return updated;
    }
    
    // If not found, add as confirmed
    return [
      ...currentRecords,
      {
        ingredientId,
        ingredientName: ingredientId,
        purchaseDate: new Date().toISOString(),
        confirmed: true
      }
    ];
  });
  
  if (!result.success) {
    logger.error('Failed to confirm purchase', undefined, { userId, ingredientId, error: result.error });
    return loadPurchases(userId); // Return current state on failure
  }
  
  return result.data || [];
}

/**
 * Get count of confirmed purchases
 * Simple API matching guide's interface
 */
export function getConfirmedCount(userId: string): number {
  const records = loadPurchases(userId);
  return records.filter(r => r.confirmed).length;
}

/**
 * Get total purchased ingredients (alias for getConfirmedCount)
 * Simple API matching guide's interface
 */
export function getTotalPurchasedIngredients(userId: string): number {
  return getConfirmedCount(userId);
}

/**
 * Get village level from purchase count
 * Simple API matching guide's interface
 * Default: +10 per level (0-9 = level 0, 10-19 = level 1, etc.)
 */
export function getVillageLevelFromCount(count: number): number {
  if (count >= 50) return 5;
  return Math.floor(count / 10);
}

// =================================================================
// ENHANCED API (our additions) - More features, same safety
// =================================================================

/**
 * Get all purchase records for a user
 * Enhanced version with validation
 * @deprecated Use loadPurchases() for simpler API
 */
export function getPurchaseRecords(userId: string): PurchaseRecord[] {
  return loadPurchases(userId);
}

/**
 * Add a pending purchase (not yet confirmed)
 * Enhanced version - used when user clicks "Buy" button
 * Uses transaction-safe update to prevent race conditions
 */
export function addPendingPurchase(
  userId: string,
  ingredientId: string,
  ingredientName: string
): { success: boolean; error?: string } {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    return { success: false, error: userIdValidation.error };
  }
  
  if (!ingredientId || !ingredientName) {
    return { success: false, error: 'Ingredient ID and name are required' };
  }
  
  const key = getStorageKey(userId);
  const result = safeUpdateItem<PurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Check if already exists as pending
    const exists = currentRecords.some(
      r => r.ingredientId === ingredientId && !r.confirmed
    );
    
    if (!exists) {
      return [
        ...currentRecords,
        {
          ingredientId,
          ingredientName,
          purchaseDate: new Date().toISOString(),
          confirmed: false
        }
      ];
    }
    
    return currentRecords;
  });
  
  if (!result.success) {
    logger.error('Failed to add pending purchase', undefined, { userId, ingredientId, error: result.error });
  }
  
  return result;
}

/**
 * Confirm a purchase with full details (enhanced version)
 * Enhanced version with ingredientName and amazonOrderId support
 */
export function confirmPurchaseWithDetails(
  userId: string,
  ingredientId: string,
  ingredientName: string,
  amazonOrderId?: string
): { success: boolean; error?: string } {
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    return { success: false, error: userIdValidation.error };
  }
  
  if (!ingredientId || !ingredientName) {
    return { success: false, error: 'Ingredient ID and name are required' };
  }
  
  const key = getStorageKey(userId);
  const result = safeUpdateItem<PurchaseRecord[]>(key, (records) => {
    const currentRecords = records || [];
    
    // Check if purchase already exists
    const existingIndex = currentRecords.findIndex(
      r => r.ingredientId === ingredientId && !r.confirmed
    );
    
    if (existingIndex >= 0) {
      // Update existing record
      const updated = [...currentRecords];
      updated[existingIndex] = {
        ...updated[existingIndex],
        ingredientName,
        confirmed: true,
        purchaseDate: new Date().toISOString(),
        ...(amazonOrderId && { amazonOrderId })
      };
      return updated;
    } else {
      // Add new purchase record
      return [
        ...currentRecords,
        {
          ingredientId,
          ingredientName,
          purchaseDate: new Date().toISOString(),
          confirmed: true,
          ...(amazonOrderId && { amazonOrderId })
        }
      ];
    }
  });
  
  if (!result.success) {
    logger.error('Failed to confirm purchase with details', undefined, { userId, ingredientId, error: result.error });
  }
  
  return result;
}

/**
 * Get village level based on purchase count
 * Every 10 ingredients = new level
 * @deprecated Use getVillageLevelFromCount() for simpler API
 */
export function getVillageLevel(purchaseCount: number): number {
  return getVillageLevelFromCount(purchaseCount);
}

/**
 * Get progress toward next village level (0-9)
 */
export function getProgressToNextLevel(purchaseCount: number): number {
  return purchaseCount % 10;
}

/**
 * Get purchase statistics for a user
 * Enhanced version with detailed stats
 */
export function getPurchaseStats(userId: string) {
  const records = loadPurchases(userId);
  const confirmed = records.filter(r => r.confirmed);
  const pending = records.filter(r => !r.confirmed);
  const total = confirmed.length;
  const level = getVillageLevelFromCount(total);
  const progress = getProgressToNextLevel(total);
  
  return {
    totalPurchases: total,
    pendingPurchases: pending.length,
    currentLevel: level,
    progressToNextLevel: progress,
    nextLevelThreshold: (level + 1) * 10,
    ingredientsRemaining: (level + 1) * 10 - total
  };
}
</file>

<file path="lib/utils/ratings.ts">
// lib/utils/ratings.ts - Core rating utilities for PetPlates

export interface RatingData {
  averageRating: number;
  totalReviews: number;
  distribution: { [key: number]: number }; // 1-5 stars count
}

export interface UserRating {
  recipeId: string;
  rating: number;
  timestamp: number;
}

// Storage keys
const USER_RATINGS_KEY = (userId: string) => `user_ratings_${userId}`;
const RECIPE_RATINGS_KEY = (recipeId: string) => `recipe_ratings_${recipeId}`;

/**
 * Save a user's rating for a recipe
 */
export const saveUserRating = (userId: string, recipeId: string, rating: number): void => {
  if (typeof window === 'undefined') return;

  const key = USER_RATINGS_KEY(userId);
  const existing = localStorage.getItem(key);
  const userRatings: UserRating[] = existing ? JSON.parse(existing) : [];

  // Remove existing rating for this recipe
  const filtered = userRatings.filter(r => r.recipeId !== recipeId);

  // Add new rating
  filtered.push({
    recipeId,
    rating,
    timestamp: Date.now()
  });

  localStorage.setItem(key, JSON.stringify(filtered));

  // Update global recipe ratings
  updateRecipeRatings(recipeId);
};

/**
 * Get a user's rating for a specific recipe
 */
export const getUserRating = (userId: string, recipeId: string): number | null => {
  if (typeof window === 'undefined') return null;

  const key = USER_RATINGS_KEY(userId);
  const existing = localStorage.getItem(key);

  if (!existing) return null;

  const userRatings: UserRating[] = JSON.parse(existing);
  const rating = userRatings.find(r => r.recipeId === recipeId);

  return rating ? rating.rating : null;
};

/**
 * Check if user has already rated a recipe
 */
export const hasUserRated = (userId: string, recipeId: string): boolean => {
  return getUserRating(userId, recipeId) !== null;
};

/**
 * Get all ratings for a recipe from all users
 */
export const getRecipeRatings = (recipeId: string): number[] => {
  if (typeof window === 'undefined') return [];

  // Optimized approach: iterate through all user_ratings keys more efficiently
  const ratings: number[] = [];

  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('user_ratings_')) {
      try {
        const userRatings: UserRating[] = JSON.parse(localStorage.getItem(key) || '[]');
        const userRating = userRatings.find(r => r.recipeId === recipeId);
        if (userRating) {
          ratings.push(userRating.rating);
        }
      } catch (error) {
        // Skip corrupted data
        console.warn(`Skipping corrupted user ratings data for key: ${key}`);
      }
    }
  }

  return ratings;
};

/**
 * Update the global recipe ratings data
 */
export const updateRecipeRatings = (recipeId: string): void => {
  if (typeof window === 'undefined') return;

  const ratings = getRecipeRatings(recipeId);
  const key = RECIPE_RATINGS_KEY(recipeId);

  if (ratings.length === 0) {
    localStorage.removeItem(key);
    return;
  }

  const averageRating = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;
  const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

  ratings.forEach(rating => {
    distribution[rating as keyof typeof distribution]++;
  });

  const ratingData: RatingData = {
    averageRating: Math.round(averageRating * 10) / 10, // Round to 1 decimal
    totalReviews: ratings.length,
    distribution
  };

  localStorage.setItem(key, JSON.stringify(ratingData));
};

/**
 * Get rating data for a recipe
 */
export const getRecipeRatingData = (recipeId: string): RatingData => {
  if (typeof window === 'undefined') {
    return { averageRating: 0, totalReviews: 0, distribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } };
  }

  const key = RECIPE_RATINGS_KEY(recipeId);
  const stored = localStorage.getItem(key);

  // If we have stored user ratings, use those
  if (stored) {
    return JSON.parse(stored);
  }

  // Otherwise, return default data (will be handled by RecipeCard using recipe.rating/reviews)
  return { averageRating: 0, totalReviews: 0, distribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } };
};

/**
 * Calculate rating data on the fly (alternative to stored data)
 */
export const calculateRecipeRatingData = (recipeId: string): RatingData => {
  const ratings = getRecipeRatings(recipeId);

  if (ratings.length === 0) {
    return { averageRating: 0, totalReviews: 0, distribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } };
  }

  const averageRating = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;
  const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

  ratings.forEach(rating => {
    distribution[rating as keyof typeof distribution]++;
  });

  return {
    averageRating: Math.round(averageRating * 10) / 10,
    totalReviews: ratings.length,
    distribution
  };
};

/**
 * Get star states for display (filled/empty stars)
 */
export const getStarStates = (rating: number): boolean[] => {
  const stars: boolean[] = [];
  for (let i = 1; i <= 5; i++) {
    stars.push(i <= Math.round(rating));
  }
  return stars;
};

/**
 * Get partial star fill percentage for smooth display
 */
export const getStarFillPercentage = (rating: number, starIndex: number): number => {
  const fullStars = Math.floor(rating);
  const partialStar = rating - fullStars;

  if (starIndex < fullStars) return 100;
  if (starIndex === fullStars) return partialStar * 100;
  return 0;
};
</file>

<file path="lib/utils/recipeIngredients.ts">
// lib/utils/recipeIngredients.ts
// Utility to extract and map ingredients from recipes to ingredient composition keys

import { INGREDIENT_COMPOSITIONS } from '@/lib/data/ingredientCompositions';

/**
 * Extract all unique ingredient names from all recipes
 */
export function getAllRecipeIngredients(): string[] {
  const ingredientNames = new Set<string>();
  
  recipes.forEach(recipe => {
    recipe.ingredients?.forEach(ing => {
      if (ing.name) {
        ingredientNames.add(ing.name);
      }
    });
  });
  
  return Array.from(ingredientNames).sort();
}

/**
 * Map recipe ingredient name to ingredient composition key
 * Handles variations and common naming patterns
 */
export function mapIngredientNameToKey(ingredientName: string): string | null {
  // Normalize the name
  const normalized = ingredientName
    .toLowerCase()
    .trim()
    .replace(/\s*\([^)]*\)/g, '') // Remove parentheses and contents
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');
  
  // Direct lookup
  if (INGREDIENT_COMPOSITIONS[normalized]) {
    return normalized;
  }
  
  // Common mappings
  const mappings: Record<string, string | null> = {
    'ground_chicken': 'ground_turkey', // Use turkey as closest match
    'chicken_breast': 'chicken_breast',
    'chicken_liver': 'chicken_liver',
    'chicken_hearts': 'chicken_hearts',
    'beef_liver': 'beef_liver',
    'ground_beef': 'ground_beef_lean',
    'ground_turkey': 'ground_turkey',
    'turkey_breast': 'turkey_breast',
    'salmon_fillet': 'salmon_atlantic',
    'salmon': 'salmon_atlantic',
    'tuna': 'tuna_water',
    'sardines': 'sardines_water',
    'white_rice': 'brown_rice_cooked', // Use brown rice as closest match
    'brown_rice': 'brown_rice_cooked',
    'quinoa': 'quinoa_cooked',
    'sweet_potato': 'sweet_potato',
    'pumpkin': 'sweet_potato', // Use sweet potato as closest match
    'carrots': 'carrots_raw',
    'carrot': 'carrots_raw',
    'green_beans': 'broccoli_raw', // Use broccoli as closest match
    'bok_choy': 'kale_raw', // Use kale as closest match
    'broccoli': 'broccoli_raw',
    'spinach': 'spinach_raw',
    'kale': 'kale_raw',
    'celery': 'celery_raw',
    'blueberries': 'blueberries_raw',
    'bananas': 'bananas_raw',
    'eggs': 'eggs_whole',
    'fish_oil': 'fish_oil',
    'herring_oil': 'fish_oil', // Use fish oil as closest match
    'olive_oil': 'fish_oil', // Use fish oil as closest match
    'coconut_oil': 'fish_oil', // Use fish oil as closest match
    'chicken_broth': null, // No composition data
    'navy_beans': null, // No composition data
    'oats': 'oats',
    'taurine': 'taurine_powder',
    'calcium': 'calcium_carbonate',
  };
  
  // Check mappings
  if (mappings[normalized]) {
    return mappings[normalized];
  }
  
  // Try partial matches
  for (const key in INGREDIENT_COMPOSITIONS) {
    if (normalized.includes(key) || key.includes(normalized)) {
      return key;
    }
  }
  
  return null;
}

/**
 * Get all ingredients that can be used in the recipe builder
 * Returns both ingredients from recipes and existing composition ingredients
 */
export function getAvailableIngredientsForBuilder(): string[] {
  const recipeIngredients = getAllRecipeIngredients();
  const compositionKeys = Object.keys(INGREDIENT_COMPOSITIONS);
  
  // Map recipe ingredients to composition keys
  const mappedKeys = new Set<string>();
  
  recipeIngredients.forEach(name => {
    const key = mapIngredientNameToKey(name);
    if (key) {
      mappedKeys.add(key);
    }
  });
  
  // Also include all composition keys
  compositionKeys.forEach(key => mappedKeys.add(key));
  
  return Array.from(mappedKeys).sort();
}
</file>

<file path="lib/utils/recipeRecommendations.ts">
import { Recipe } from '@/lib/types';

interface Pet {
  id: string;
  name: string;
  type: string;
  breed: string;
  age: string;
  healthConcerns: string[];
  weight?: number;
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very-active';
  allergies?: string[];
  dietaryRestrictions?: string[];
  savedRecipes?: string[];
  names?: string[];
  weightKg?: number;
}

import { normalizeToSubtype, type Subtype } from './ingredientWhitelists';
import { getHealthTemplatesForSpecies, applyHealthTemplate, type HealthConcernTemplate } from '@/lib/data/healthConcernTemplates';
import {
  calculateEnhancedCompatibility,
  type Pet as EnhancedPet,
} from './enhancedCompatibilityScoring';

/**
 * Check if recipe matches species/subtype
 * Exported so scoreRecipe can use it
 */
export function matchesSpecies(recipe: Recipe, pet: Pet): boolean {
  // Exact match
  if (recipe.category === pet.type) return true;
  
  // Subtype matching for exotics (Beta feature)
  const subtype = normalizeToSubtype(pet.type as any, pet.breed);
  
  if (pet.type === 'bird') {
    const largeBirds = ['parrot', 'cockatoo', 'african grey', 'macaw', 'conure', 'quaker'];
    const isLargeBird = largeBirds.some(lb => (pet.breed || '').toLowerCase().includes(lb));
    
    // Allow generic bird recipes for all birds
    if (recipe.category === 'birds' || recipe.category === 'bird') return true;
    
    // Allow subtype-specific recipes
    if (recipe.category === 'bird_large' && isLargeBird) return true;
    if (recipe.category === 'bird_small' && !isLargeBird) return true;
  }
  
  if (pet.type === 'reptile') {
    // Allow generic reptile recipes
    if (recipe.category === 'reptiles' || recipe.category === 'reptile') return true;
    
    // Allow subtype-specific recipes
    const subtypeCategories = [
      'reptile_herbivore', 'reptile_insectivore', 
      'reptile_omnivore', 'reptile_carnivore'
    ];
    if (subtypeCategories.includes(recipe.category)) {
      // Check if recipe category matches subtype
      return recipe.category === subtype;
    }
  }
  
  if (pet.type === 'pocket-pet') {
    // Allow generic pocket-pet recipes
    if (recipe.category === 'pocket-pets' || recipe.category === 'pocket-pet') return true;
    
    // Allow subtype-specific recipes
    const subtypeCategories = [
      'pocket_hay', 'pocket_varied', 
      'pocket_carnivore', 'pocket_insectivore'
    ];
    if (subtypeCategories.includes(recipe.category)) {
      return recipe.category === subtype;
    }
  }
  
  return false;
}

/**
 * Tiered recommendation system - ensures users never see "0 meals"
 * 
 * Tier 1: Exact match (species + age + health concern)
 * Tier 2: Subtype + health concern template match
 * Tier 3: Species + age match (no health concern)
 * Tier 4: Species match only (all ages)
 * Tier 5: Subtype match (generic)
 * Tier 6: Health template-based suggestions (always available)
 */
export interface RecipeRecommendation {
  recipe: Recipe;
  tier: number;
  tierLabel: string;
  healthConcernMatch?: string;
  template?: HealthConcernTemplate;
  warning?: string;
  score: number;
  enhancedScore?: any; // Optional improved scoring
}

/**
 * Normalize pet age to age group string
 * Handles both string ("adult") and number (5) formats
 */
function normalizePetAgeToGroup(age: string | number): string {
  if (typeof age === 'string') {
    // Already a string like "adult", "young", etc.
    const normalized = age.toLowerCase().trim();
    if (['baby', 'young', 'adult', 'senior', 'all'].includes(normalized)) {
      return normalized;
    }
    // Try to parse if it's a number string
    const numAge = parseFloat(normalized);
    if (!isNaN(numAge)) {
      if (numAge < 1) return 'baby';
      if (numAge < 2) return 'young';
      if (numAge < 7) return 'adult';
      return 'senior';
    }
    return normalized; // Return as-is if can't parse
  }
  // Convert number to age group
  if (age < 1) return 'baby';
  if (age < 2) return 'young';
  if (age < 7) return 'adult';
  return 'senior';
}

/**
 * Normalize health concern names to match recipe database format
 * Maps user-friendly names to database keys
 */
function normalizeHealthConcern(concern: string): string {
  const mapping: Record<string, string> = {
    'dental health': 'dental-issues',
    'dental-health': 'dental-issues',
    'weight management': 'weight-management',
    'weight-management': 'weight-management',
    'joint & mobility': 'joint-health',
    'joint-health': 'joint-health',
    'skin & coat': 'skin-coat',
    'skin-coat': 'skin-coat',
    'kidney/urinary support': 'kidney',
    'kidney/urinary-support': 'kidney',
    'digestive health': 'digestive',
    'digestive': 'digestive',
    'allergy support': 'allergies',
    'allergies': 'allergies',
  };
  
  const normalized = concern.toLowerCase().trim();
  return mapping[normalized] || normalized.replace(/\s+/g, '-').toLowerCase();
}

/**
 * Get recommended recipes with optional enhanced scoring
 * @param pet - Pet profile
 * @param minCount - Minimum number of recipes to return
 * @param useEnhancedScoring - Whether to use the enhanced compatibility scoring system
 * @param customRecipes - Optional custom recipes to include in recommendations
 */
export const getRecommendedRecipes = (
  pet: Pet,
  minCount: number = 20,
  useEnhancedScoring: boolean = false,
  customRecipes?: Recipe[]
): RecipeRecommendation[] => {
  const { type, age, healthConcerns } = pet;
  // Normalize health concerns to match recipe database format
  const normalizedConcerns = (healthConcerns || []).map(normalizeHealthConcern);
  const results: RecipeRecommendation[] = [];

  // Use provided recipes only - static recipes are no longer available
  const allRecipes = customRecipes || [];

  // Normalize pet age to age group string
  const petAgeGroup = normalizePetAgeToGroup(age);
  
  // Tier 1: Perfect matches (species + age) - health concerns handled in scoring, not filtering
  const tier1 = allRecipes.filter(r => {
    const speciesMatch = matchesSpecies(r, pet);
    const ageMatch = (r.ageGroup || []).includes(petAgeGroup) || (r.ageGroup || []).includes('all');
    // Health concerns are scoring modifiers, not filters
    return speciesMatch && ageMatch;
  }).map(r => {
    // Find matching health concern for display (but don't filter by it)
    const matchingConcern = normalizedConcerns.length > 0 
      ? normalizedConcerns.find(hc => r.healthConcerns?.includes(hc) || r.healthConcerns?.some(rc => rc.toLowerCase().includes(hc.toLowerCase())))
      : undefined;
    return {
      recipe: r,
      tier: 1,
      tierLabel: matchingConcern ? 'Best Match' : 'Age-Appropriate',
      healthConcernMatch: matchingConcern,
      score: 100
    };
  });
  results.push(...tier1);
  
  // Tier 2: Subtype + health concern template match - ALWAYS run when concerns exist
  if (normalizedConcerns.length > 0) {
    const subtype = normalizeToSubtype(type as any, pet.breed);
    
    // Process each health concern (use normalized version)
    normalizedConcerns.forEach(concern => {
      const templates = getHealthTemplatesForSpecies(type, pet.breed, concern);
      
      templates.forEach(template => {
        // Find recipes that match subtype and age (can be adapted)
        const subtypeRecipes = allRecipes.filter(r => {
          const speciesMatch = matchesSpecies(r, pet);
          const ageMatch = (r.ageGroup || []).includes(petAgeGroup) || (r.ageGroup || []).includes('all');
          // Don't include recipes already in results
          const notIncluded = !results.some(res => res.recipe.id === r.id);
          return speciesMatch && ageMatch && notIncluded;
        });
        
        // Actually apply the template to adapt ingredients
        subtypeRecipes.forEach(r => {
          const ingredientNames = r.ingredients.map(i => i.name);
          const adapted = applyHealthTemplate(ingredientNames, template);
          
          // Create adapted recipe
          const adaptedRecipe: Recipe = {
            ...r,
            id: `${r.id}__${template.id}`, // Avoid ID clash
            name: `${r.name} (Adapted for ${concern})`,
            description: `${r.description} Adapted using ${template.name} template.`,
            ingredients: adapted.adjustedIngredients.map((name, idx) => ({
              id: `adapted-${idx}`,
              name,
              amount: 'varies',
              asinLink: r.ingredients[0]?.asinLink || ''
            })),
            healthConcerns: Array.from(new Set([
              ...(r.healthConcerns || []),
              concern
            ])),
            tags: [...(r.tags || []), 'template-adapted']
          };
          
          results.push({
            recipe: adaptedRecipe,
            tier: 2,
            tierLabel: `Adapted for ${concern}`,
            healthConcernMatch: concern,
            template,
            warning: adapted.warnings.length > 0 
              ? `${template.warning || ''} ${adapted.warnings.join('; ')}`
              : template.warning,
            score: 80
          });
        });
      });
    });
  }
  
  // Tier 3: Species + age match (no health concern) - Fill up to minCount
  const tier3 = allRecipes.filter(r => {
    const speciesMatch = matchesSpecies(r, pet);
    const ageMatch = (r.ageGroup || []).includes(petAgeGroup) || (r.ageGroup || []).includes('all');
    const notIncluded = !results.some(res => res.recipe.id === r.id);
    return speciesMatch && ageMatch && notIncluded;
  }).slice(0, Math.max(0, minCount - results.length)) // Only take what we need
  .map(r => ({
    recipe: r,
    tier: 3,
    tierLabel: normalizedConcerns.length > 0 ? 'General Safe Meal' : 'Age-Appropriate',
    warning: normalizedConcerns.length > 0 
      ? `No ${normalizedConcerns[0]} recipes yet; this is a general safe meal`
      : undefined,
    score: 60
  }));
  results.push(...tier3);
  
  // Tier 4: Species match only (all ages) - Fill up to minCount
  // Always ensure we have at least minCount recipes
  const neededFromTier4 = Math.max(0, minCount - results.length);
  const tier4 = allRecipes.filter(r => {
    const speciesMatch = matchesSpecies(r, pet);
    const notIncluded = !results.some(res => res.recipe.id === r.id);
    return speciesMatch && notIncluded;
  }).slice(0, neededFromTier4) // Take only what we need to reach minCount
  .map(r => ({
    recipe: r,
    tier: 4,
    tierLabel: 'Species-Appropriate',
    warning: 'Not optimized for age or health concerns',
    score: 40
  }));
  results.push(...tier4);
  
  // Tier 5: Subtype match (generic) - Fill up to minCount for exotics
  if (results.length < minCount && ['bird', 'reptile', 'pocket-pet', 'birds', 'reptiles', 'pocket-pets'].includes(type)) {
    const subtype = normalizeToSubtype(type as any, pet.breed);
    const tier5 = allRecipes.filter(r => {
      const matchesSubtype = r.category === subtype || 
        (r.category && r.category.includes(subtype.split('_')[0])) ||
        matchesSpecies(r, pet); // Also include any species matches
      const notIncluded = !results.some(res => res.recipe.id === r.id);
      return matchesSubtype && notIncluded;
    }).slice(0, minCount - results.length) // Only take what we need
    .map(r => ({
      recipe: r,
      tier: 5,
      tierLabel: 'Generic ' + subtype.replace('_', ' ') + ' Template',
      warning: 'Generic template - confirm with your vet',
      score: 30
    }));
    results.push(...tier5);
  }
  
  // Tier 6: Health template-based suggestions (always ensure something shows)
  // Also run if we're below minCount for exotics
  if ((results.length === 0 || (results.length < minCount && ['bird', 'reptile', 'pocket-pet', 'birds', 'reptiles', 'pocket-pets'].includes(type))) && normalizedConcerns.length > 0) {
    const templates = getHealthTemplatesForSpecies(type, pet.breed, normalizedConcerns[0]);
    if (templates.length > 0) {
      // Create a placeholder recipe from template
      const template = templates[0];
      const placeholderRecipe: Recipe = {
        id: `template-${template.id}`,
        name: template.name,
        category: type,
        ageGroup: [age],
        healthConcerns: [normalizedConcerns[0]],
        description: template.description,
        ingredients: (template.rules.preferIngredients || []).map((ing, idx) => ({
          id: `ing-${idx}`,
          name: ing,
          amount: 'varies',
          asinLink: ''
        })),
        instructions: ['Use custom meal builder with this template', 'Follow template guidelines'],
        tags: ['template', 'health-concern'],
        rating: 0,
        reviews: 0,
        prepTime: '0 min',
        cookTime: '0 min',
        servings: 1
      };
      
      results.push({
        recipe: placeholderRecipe,
        tier: 6,
        tierLabel: 'Template-Based',
        template,
        warning: template.warning || 'Use custom meal builder with health template',
        score: 20
      });
    }
  }
  
  // Apply improved scoring if requested
  if (useEnhancedScoring) {
    results.forEach(result => {
      try {
        // Convert pet format for improved scoring
        const enhancedPet: EnhancedPet = {
          id: pet.id,
          name: pet.name,
          type: pet.type as 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet',
          breed: pet.breed,
          age: parseFloat(pet.age) || 1,
          weight: pet.weight || 10,
          activityLevel: pet.activityLevel,
          healthConcerns: pet.healthConcerns || [],
          dietaryRestrictions: pet.dietaryRestrictions || [],
          allergies: pet.allergies || [],
        };
        
        const enhanced = calculateEnhancedCompatibility(result.recipe, enhancedPet);
        result.enhancedScore = enhanced;
        result.score = enhanced.overallScore;
      } catch (error) {
        // If enhanced scoring fails, keep original score
        console.warn('Enhanced scoring failed for recipe:', result.recipe.id, error);
      }
    });
  }

  // Sort by score (tier or enhanced score) and return
  const sorted = results.sort((a, b) => {
    // If both have enhanced scores, use those
    if (a.enhancedScore && b.enhancedScore) {
      return b.enhancedScore.overallScore - a.enhancedScore.overallScore;
    }
    // Otherwise use tier score
    return b.score - a.score;
  });
  // Return up to minCount recipes, or all if we have fewer than minCount
  return sorted.slice(0, Math.min(minCount, sorted.length));
};

/**
 * Get count of recipes by priority level for display purposes
 * Returns empty stats since recipes are now generated dynamically
 */
export const getRecommendationStats = (pet: Pet) => {
  return {
    perfect: 0,
    typeAge: 0,
    typeOnly: 0,
    total: 0
  };
};
</file>

<file path="lib/utils/recipeScoring.ts">
// lib/utils/recipeScoring.ts
// Scoring system that ranks recipes 0-100 based on pet profile matching

import type { Recipe } from '@/lib/types';

export interface Pet {
  species: 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';
  breed: string;
  ageGroup: 'baby' | 'young' | 'adult' | 'senior';
  weightStatus?: 'overweight' | 'underweight' | 'ideal';
  healthConcerns: string[];
  savedRecipes?: string[];
  names?: string[];
  weightKg?: number;
  weight?: number | string;
  dietaryRestrictions?: string[];
  allergies?: string[];
  dislikes?: string[];
}

export interface ScoreResult {
  compatibilityScore: number; // 0-100 (formerly matchScore)
  matchScore: number; // 0-100 (deprecated - use compatibilityScore)
  stars: number; // 1-5
  reasoning: {
    goodMatches: string[];
    conflicts: string[];
  };
}

// Common allergens to check
const ALLERGEN_KEYWORDS: Record<string, string[]> = {
  chicken: ['chicken', 'poultry', 'hen'],
  beef: ['beef', 'cow'],
  dairy: ['dairy', 'milk', 'cheese', 'yogurt'],
  grain: ['wheat', 'grain', 'corn', 'barley', 'oats'],
  egg: ['egg'],
};

function hasAllergen(recipe: Recipe, allergen: string): boolean {
  const keywords = ALLERGEN_KEYWORDS[allergen.toLowerCase()] || [allergen.toLowerCase()];
  const allText = `${recipe.name} ${recipe.description} ${recipe.ingredients.map(i => i.name).join(' ')}`.toLowerCase();
  return keywords.some(kw => allText.includes(kw));
}

function isLowCalorie(recipe: Recipe): boolean {
  const name = recipe.name.toLowerCase();
  const desc = (recipe.description || '').toLowerCase();
  return name.includes('low-fat') || name.includes('lean') || name.includes('slim') ||
         desc.includes('low-calorie') || desc.includes('weight') || desc.includes('diet');
}

function isInAAFCORange(recipe: Recipe, species: 'dogs' | 'cats'): boolean {
  if (!recipe.nutritionalInfo) return false;
  
  const protein = recipe.nutritionalInfo.protein?.min || 0;
  const fat = recipe.nutritionalInfo.fat?.min || 0;
  
  if (species === 'dogs') {
    return protein >= 18 && protein <= 30 && fat >= 5 && fat <= 20;
  } else { // cats
    return protein >= 26 && protein <= 40 && fat >= 9 && fat <= 25;
  }
}

export function scoreRecipe(recipe: Recipe, pet: Pet): ScoreResult {
  let score = 0;
  const goodMatches: string[] = [];
  const conflicts: string[] = [];

  // 1. Species Match (Required Gate - 0 if wrong species)
  if (recipe.category !== pet.species) {
    return {
      compatibilityScore: 0,
      matchScore: 0,
      stars: 1,
      reasoning: {
        goodMatches: [],
        conflicts: [`Recipe is for ${recipe.category}, but pet is ${pet.species}`]
      }
    };
  }

  // 2. Age Group Match (+20)
  if (recipe.ageGroup.includes(pet.ageGroup)) {
    score += 20;
    goodMatches.push('Age group match');
  } else {
    conflicts.push('Age group mismatch');
  }

  // 3. Breed Relevance (+10)
  if (recipe.breed) {
    const breeds = Array.isArray(recipe.breed) ? recipe.breed : [recipe.breed];
    const breedMatch = breeds.some(b =>
      b && b.toLowerCase().replace(/-/g, ' ') === pet.breed.toLowerCase().replace(/-/g, ' ')
    );
    if (breedMatch) {
      score += 10;
      goodMatches.push('Breed-specific recipe');
    }
  }

  // 4. Health Concern Overlap (+10 per match, max +40)
  if (pet.healthConcerns.length > 0 && recipe.healthConcerns.length > 0) {
    const matches = pet.healthConcerns.filter(hc => 
      recipe.healthConcerns.some(rc => 
        rc.toLowerCase().includes(hc.toLowerCase()) || 
        hc.toLowerCase().includes(rc.toLowerCase())
      )
    );
    const healthScore = Math.min(matches.length * 10, 40);
    score += healthScore;
    if (matches.length > 0) {
      goodMatches.push(`${matches.length} health concern${matches.length > 1 ? 's' : ''} addressed`);
    }
  }

  // 5. Weight Control Fit (+10)
  if (pet.weightStatus === 'overweight' && isLowCalorie(recipe)) {
    score += 10;
    goodMatches.push('Low-calorie option for weight management');
  }

  // 6. Allergy Safety (-40 penalty if allergen present)
  if (pet.healthConcerns.includes('allergies')) {
    const hasAllergy = pet.healthConcerns.some(concern => {
      const allergen = concern.toLowerCase();
      return Object.keys(ALLERGEN_KEYWORDS).some(key => 
        allergen.includes(key) && hasAllergen(recipe, key)
      );
    });
    if (hasAllergy) {
      score = Math.max(0, score - 40);
      conflicts.push('Contains common allergen');
    }
  }

  // 7. Nutrient Fit (+20 if in AAFCO range for dogs/cats)
  if ((pet.species === 'dogs' || pet.species === 'cats') && isInAAFCORange(recipe, pet.species)) {
    score += 20;
    goodMatches.push('Meets AAFCO nutritional standards');
  } else if (pet.species === 'dogs' || pet.species === 'cats') {
    // Small penalty if not in range
    score = Math.max(0, score - 5);
  }

  // Cap at 100
  score = Math.min(100, Math.max(0, score));

  // Map to stars
  let stars: number;
  if (score >= 90) stars = 5;
  else if (score >= 75) stars = 4;
  else if (score >= 50) stars = 3;
  else if (score >= 25) stars = 2;
  else stars = 1;

  return {
    compatibilityScore: score,
    matchScore: score, // Keep for backward compatibility
    stars,
    reasoning: {
      goodMatches,
      conflicts
    }
  };
}
</file>

<file path="lib/utils/scoringDiagnostics.ts">
import { Recipe, Pet } from '../types';
import { calculateEnhancedCompatibility } from './enhancedCompatibilityScoring';

export interface ScoreDistributionAnalysis {
  totalRecipes: number;
  scoreRanges: {
    '95-100': number;
    '90-94': number;
    '80-89': number;
    '70-79': number;
    '60-69': number;
    '50-59': number;
    '40-49': number;
    '30-39': number;
    '0-29': number;
  };
  perfectMatches: number;
  clustering: {
    at40: number;
    at100: number;
  };
  averageScore: number;
  medianScore: number;
  standardDeviation: number;
  isBinaryDistribution: boolean;
  recommendations: string[];
}

/**
 * Analyze score distribution for a set of recipes and a pet
 * Helps identify clustering, binary distributions, and scoring issues
 */
export function analyzeScoreDistribution(
  recipes: Recipe[],
  pet: Pet
): ScoreDistributionAnalysis {
  const scores = recipes.map(recipe => 
    calculateEnhancedCompatibility(recipe, pet).overallScore
  );
  
  // Calculate statistics
  const totalRecipes = scores.length;
  const averageScore = scores.reduce((a, b) => a + b, 0) / totalRecipes;
  const sortedScores = [...scores].sort((a, b) => a - b);
  const medianScore = totalRecipes > 0 
    ? sortedScores[Math.floor(totalRecipes / 2)]
    : 0;
  
  // Calculate standard deviation
  const variance = scores.reduce((sum, score) => {
    return sum + Math.pow(score - averageScore, 2);
  }, 0) / totalRecipes;
  const standardDeviation = Math.sqrt(variance);
  
  // Count score ranges
  const scoreRanges = {
    '95-100': scores.filter(s => s >= 95).length,
    '90-94': scores.filter(s => s >= 90 && s < 95).length,
    '80-89': scores.filter(s => s >= 80 && s < 90).length,
    '70-79': scores.filter(s => s >= 70 && s < 80).length,
    '60-69': scores.filter(s => s >= 60 && s < 70).length,
    '50-59': scores.filter(s => s >= 50 && s < 60).length,
    '40-49': scores.filter(s => s >= 40 && s < 50).length,
    '30-39': scores.filter(s => s >= 30 && s < 40).length,
    '0-29': scores.filter(s => s < 30).length,
  };
  
  // Count perfect matches (95-100)
  const perfectMatches = scoreRanges['95-100'];
  
  // Detect clustering (scores within 2 points of 40 or 100)
  const clustering = {
    at40: scores.filter(s => Math.abs(s - 40) < 2).length,
    at100: scores.filter(s => Math.abs(s - 100) < 2).length,
  };
  
  // Check for binary distribution
  // Binary if >30% at 40 and >30% at 100, or if standard deviation is very low
  const isBinaryDistribution = 
    (clustering.at40 > totalRecipes * 0.3 && clustering.at100 > totalRecipes * 0.3) ||
    (standardDeviation < 10 && (clustering.at40 > totalRecipes * 0.2 || clustering.at100 > totalRecipes * 0.2));
  
  // Generate recommendations
  const recommendations: string[] = [];
  
  if (isBinaryDistribution) {
    recommendations.push('‚ö†Ô∏è Binary distribution detected - adjust scoring granularity');
  }
  
  if (clustering.at40 > totalRecipes * 0.2) {
    recommendations.push('‚ö†Ô∏è Too many recipes clustering at 40% - lower safety floor or improve penalty granularity');
  }
  
  if (clustering.at100 > totalRecipes * 0.2) {
    recommendations.push('‚ö†Ô∏è Too many perfect scores - make isPerfectMatch() stricter or reduce perfect match bonus');
  }
  
  if (standardDeviation < 15) {
    recommendations.push('‚ö†Ô∏è Scores too similar - increase penalty/bonus differentiation');
  }
  
  if (perfectMatches > totalRecipes * 0.2) {
    recommendations.push('‚ö†Ô∏è Too many perfect matches (>20%) - tighten perfect match criteria');
  }
  
  if (perfectMatches === 0 && averageScore > 80) {
    recommendations.push('‚ÑπÔ∏è No perfect matches but high average - consider allowing some 95-100% scores');
  }
  
  if (scoreRanges['0-29'] > totalRecipes * 0.3) {
    recommendations.push('‚ö†Ô∏è Too many very low scores - check if penalties are too harsh');
  }
  
  return {
    totalRecipes,
    scoreRanges,
    perfectMatches,
    clustering,
    averageScore: Math.round(averageScore * 10) / 10,
    medianScore,
    standardDeviation: Math.round(standardDeviation * 10) / 10,
    isBinaryDistribution,
    recommendations,
  };
}

/**
 * Generate a detailed report of score distribution
 */
export function generateDistributionReport(
  recipes: Recipe[],
  pet: Pet
): string {
  const analysis = analyzeScoreDistribution(recipes, pet);
  
  let report = `\n=== Score Distribution Analysis ===\n\n`;
  report += `Total Recipes: ${analysis.totalRecipes}\n`;
  report += `Average Score: ${analysis.averageScore}%\n`;
  report += `Median Score: ${analysis.medianScore}%\n`;
  report += `Standard Deviation: ${analysis.standardDeviation}\n\n`;
  
  report += `Score Ranges:\n`;
  report += `  95-100: ${analysis.scoreRanges['95-100']} (${Math.round(analysis.scoreRanges['95-100'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  90-94: ${analysis.scoreRanges['90-94']} (${Math.round(analysis.scoreRanges['90-94'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  80-89: ${analysis.scoreRanges['80-89']} (${Math.round(analysis.scoreRanges['80-89'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  70-79: ${analysis.scoreRanges['70-79']} (${Math.round(analysis.scoreRanges['70-79'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  60-69: ${analysis.scoreRanges['60-69']} (${Math.round(analysis.scoreRanges['60-69'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  50-59: ${analysis.scoreRanges['50-59']} (${Math.round(analysis.scoreRanges['50-59'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  40-49: ${analysis.scoreRanges['40-49']} (${Math.round(analysis.scoreRanges['40-49'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  30-39: ${analysis.scoreRanges['30-39']} (${Math.round(analysis.scoreRanges['30-39'] / analysis.totalRecipes * 100)}%)\n`;
  report += `  0-29: ${analysis.scoreRanges['0-29']} (${Math.round(analysis.scoreRanges['0-29'] / analysis.totalRecipes * 100)}%)\n\n`;
  
  report += `Clustering:\n`;
  report += `  At 40%: ${analysis.clustering.at40} recipes\n`;
  report += `  At 100%: ${analysis.clustering.at100} recipes\n\n`;
  
  report += `Binary Distribution: ${analysis.isBinaryDistribution ? 'YES ‚ö†Ô∏è' : 'NO ‚úì'}\n\n`;
  
  if (analysis.recommendations.length > 0) {
    report += `Recommendations:\n`;
    analysis.recommendations.forEach(rec => {
      report += `  ${rec}\n`;
    });
  }
  
  return report;
}
</file>

<file path="lib/utils/scoringTransparency.ts">
// lib/utils/scoringTransparency.ts
// Scoring transparency debug tool

import type { Recipe } from '@/lib/types';
import { calculateEnhancedCompatibility, type Pet, calculateBonuses, calculateRecipeNutrition } from './enhancedCompatibilityScoring';

export interface ScoringReport {
  factors: Record<string, {
    score: number;
    weight: number;
    contribution: number;
    canBe100: boolean;
    explanation: string;
    issues: string[];
  }>;
  currentScore: number;
  maxPossibleScore: number;
  canReach100: boolean;
  barriersTo100: string[];
  bonuses: number;
  penalties: number;
}

/**
 * Generate a detailed scoring report for debugging
 */
export function generateScoringReport(
  recipe: Recipe,
  pet: Pet
): ScoringReport {
  const result = calculateEnhancedCompatibility(recipe, pet);
  const bonuses = calculateBonuses(recipe, pet);
  
  const factors: ScoringReport['factors'] = {};
  let maxPossible = 0;
  const barriers: string[] = [];
  
  Object.entries(result.factors).forEach(([key, factor]) => {
    const weight = factor.weight || 0;
    const contribution = factor.score * weight;
    const canBe100 = checkIfFactorCanBe100(key, recipe, pet);
    
    if (!canBe100 && factor.score < 100) {
      barriers.push(`${key}: ${factor.reasoning}`);
    }
    
    maxPossible += canBe100 ? 100 * weight : factor.score * weight;
    
    factors[key] = {
      score: factor.score,
      weight,
      contribution,
      canBe100,
      explanation: factor.reasoning,
      issues: factor.issues
    };
  });
  
  return {
    factors,
    currentScore: result.overallScore,
    maxPossibleScore: maxPossible + bonuses,
    canReach100: maxPossible + bonuses >= 99.5,
    barriersTo100: barriers,
    bonuses,
    penalties: result.detailedBreakdown.warnings.length
  };
}

/**
 * Check if a factor can theoretically reach 100% for this recipe+pet combination
 */
function checkIfFactorCanBe100(factorName: string, recipe: Recipe, pet: Pet): boolean {
  switch (factorName) {
    case 'ingredientSafety':
      // Can be 100 if all ingredients are safe
      return true;
    case 'nutritionalAdequacy':
      // Can be 100 if nutrition is perfect and no fallback data (or pet has no concerns)
      const nutrition = calculateRecipeNutrition(recipe);
      if (pet.healthConcerns.length === 0) {
        // Perfect pets don't penalize fallback data
        return true;
      }
      return !nutrition.usesFallbackNutrition;
    case 'healthAlignment':
      // Can be 100 if pet has no health concerns
      return pet.healthConcerns.length === 0;
    case 'lifeStageFit':
      // Can be 100 if age matches
      return true;
    case 'activityFit':
      // Can be 100 if activity level not specified or matches
      return true;
    case 'allergenSafety':
      // Can be 100 if no allergens
      return (pet.allergies?.length ?? 0) === 0 && pet.dietaryRestrictions.length === 0;
    case 'ingredientQuality':
      // Can be 100 if all ingredients are premium (but this is now a bonus, not requirement)
      return true;
    default:
      return true;
  }
}
</file>

<file path="lib/utils/telemetry.ts">
// lib/utils/telemetry.ts
// Client-side telemetry for performance and quality monitoring
// Tracks: JSON load time, scoring time, validation status distribution

interface TelemetryEvent {
  type: 'json_load' | 'scoring' | 'validation_status' | 'page_load';
  timestamp: number;
  duration?: number; // milliseconds
  metadata?: Record<string, any>;
}

const TELEMETRY_KEY = 'pet_plates_telemetry';
const BATCH_SIZE = 10; // Send after N events
const BATCH_INTERVAL_MS = 30000; // Send every 30 seconds
const MAX_EVENTS = 100; // Maximum events to store

class Telemetry {
  private events: TelemetryEvent[] = [];
  private batchTimer: NodeJS.Timeout | null = null;

  constructor() {
    if (typeof window !== 'undefined') {
      this.loadEvents();
      this.startBatchTimer();
      
      // Send on page unload
      window.addEventListener('beforeunload', () => {
        this.flush();
      });
    }
  }

  private loadEvents(): void {
    if (typeof window === 'undefined') return;
    
    try {
      const stored = localStorage.getItem(TELEMETRY_KEY);
      if (stored) {
        this.events = JSON.parse(stored);
        // Keep only recent events (last 100)
        if (this.events.length > MAX_EVENTS) {
          this.events = this.events.slice(-MAX_EVENTS);
        }
      }
    } catch (error) {
      console.warn('Failed to load telemetry events:', error);
      this.events = [];
    }
  }

  private saveEvents(): void {
    if (typeof window === 'undefined') return;
    
    try {
      localStorage.setItem(TELEMETRY_KEY, JSON.stringify(this.events));
    } catch (error) {
      console.warn('Failed to save telemetry events:', error);
    }
  }

  private startBatchTimer(): void {
    if (typeof window === 'undefined') return;
    
    this.batchTimer = setInterval(() => {
      if (this.events.length >= BATCH_SIZE) {
        this.flush();
      }
    }, BATCH_INTERVAL_MS);
  }

  /**
   * Track JSON load time
   */
  trackJsonLoad(duration: number, size?: number): void {
    this.addEvent({
      type: 'json_load',
      timestamp: Date.now(),
      duration,
      metadata: size ? { size } : undefined,
    });
  }

  /**
   * Track scoring time
   */
  trackScoring(duration: number, recipeCount: number, cacheHit?: boolean): void {
    this.addEvent({
      type: 'scoring',
      timestamp: Date.now(),
      duration,
      metadata: {
        recipeCount,
        cacheHit: cacheHit || false,
      },
    });
  }

  /**
   * Track validation status
   */
  trackValidationStatus(status: 'valid' | 'needsReview' | 'invalid', recipeId?: string): void {
    this.addEvent({
      type: 'validation_status',
      timestamp: Date.now(),
      metadata: {
        status,
        recipeId,
      },
    });
  }

  /**
   * Track page load time
   */
  trackPageLoad(duration: number, page: string): void {
    this.addEvent({
      type: 'page_load',
      timestamp: Date.now(),
      duration,
      metadata: { page },
    });
  }

  private addEvent(event: TelemetryEvent): void {
    this.events.push(event);
    
    // Keep only recent events
    if (this.events.length > MAX_EVENTS) {
      this.events = this.events.slice(-MAX_EVENTS);
    }
    
    this.saveEvents();
    
    // Auto-flush if batch size reached
    if (this.events.length >= BATCH_SIZE) {
      this.flush();
    }
  }

  /**
   * Get telemetry summary statistics
   */
  getSummary(): {
    jsonLoadTimes: number[];
    scoringTimes: number[];
    validationStatuses: Record<string, number>;
    pageLoadTimes: Record<string, number[]>;
  } {
    const jsonLoadTimes: number[] = [];
    const scoringTimes: number[] = [];
    const validationStatuses: Record<string, number> = {};
    const pageLoadTimes: Record<string, number[]> = {};

    this.events.forEach(event => {
      switch (event.type) {
        case 'json_load':
          if (event.duration) jsonLoadTimes.push(event.duration);
          break;
        case 'scoring':
          if (event.duration) scoringTimes.push(event.duration);
          break;
        case 'validation_status':
          const status = event.metadata?.status || 'unknown';
          validationStatuses[status] = (validationStatuses[status] || 0) + 1;
          break;
        case 'page_load':
          const page = event.metadata?.page || 'unknown';
          if (!pageLoadTimes[page]) pageLoadTimes[page] = [];
          if (event.duration) pageLoadTimes[page].push(event.duration);
          break;
      }
    });

    return {
      jsonLoadTimes,
      scoringTimes,
      validationStatuses,
      pageLoadTimes,
    };
  }

  /**
   * Flush events to server (if endpoint available) or console
   */
  flush(): void {
    if (this.events.length === 0) return;

    const summary = this.getSummary();
    
    // Log summary to console (in development)
    if (process.env.NODE_ENV === 'development') {
      const { jsonLoadTimes, scoringTimes, validationStatuses, pageLoadTimes } = summary;
      console.log('üìä Telemetry Summary:', {
        totalEvents: this.events.length,
        jsonLoadAvg: jsonLoadTimes.length > 0 
          ? (jsonLoadTimes.reduce((a: number, b: number) => a + b, 0) / jsonLoadTimes.length).toFixed(2) + 'ms'
          : 'N/A',
        scoringAvg: scoringTimes.length > 0
          ? (scoringTimes.reduce((a: number, b: number) => a + b, 0) / scoringTimes.length).toFixed(2) + 'ms'
          : 'N/A',
        validationStatuses,
        pageLoadAvgs: Object.entries(pageLoadTimes).map(([page, times]) => ({
          page,
          avg: (Array.isArray(times) ? times.reduce((a: number, b: number) => a + b, 0) / times.length : 0).toFixed(2) + 'ms',
        })),
      });
    }

    // TODO: Send to analytics endpoint if available
    // Example:
    // fetch('/api/telemetry', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ events: this.events, summary }),
    // }).catch(() => {});

    // Clear events after flushing
    this.events = [];
    this.saveEvents();
  }

  /**
   * Clear all telemetry data
   */
  clear(): void {
    this.events = [];
    this.saveEvents();
  }
}

// Singleton instance
let telemetryInstance: Telemetry | null = null;

export function getTelemetry(): Telemetry {
  if (!telemetryInstance) {
    telemetryInstance = new Telemetry();
  }
  return telemetryInstance;
}

// Convenience functions
export const trackJsonLoad = (duration: number, size?: number) => 
  getTelemetry().trackJsonLoad(duration, size);

export const trackScoring = (duration: number, recipeCount: number, cacheHit?: boolean) =>
  getTelemetry().trackScoring(duration, recipeCount, cacheHit);

export const trackValidationStatus = (status: 'valid' | 'needsReview' | 'invalid', recipeId?: string) =>
  getTelemetry().trackValidationStatus(status, recipeId);

export const trackPageLoad = (duration: number, page: string) =>
  getTelemetry().trackPageLoad(duration, page);

export const getTelemetrySummary = () => getTelemetry().getSummary();

export const flushTelemetry = () => getTelemetry().flush();
</file>

<file path="lib/utils/validation.ts">
// lib/utils/validation.ts
// Input validation and sanitization utilities with Zod schemas

import { z } from 'zod';
import type { Pet } from '../utils/petUtils';
import type { Recipe, Ingredient, PetNutritionProfile, CustomMeal } from '../types';
import type { PurchaseRecord } from './purchaseTracking';

/**
 * Sanitizes user input to prevent XSS attacks
 */
export function sanitizeInput(input: string): string {
  if (typeof input !== 'string') return '';
  
  return input
    .trim()
    .replace(/[<>]/g, '') // Remove < and > to prevent HTML injection
    .replace(/javascript:/gi, '') // Remove javascript: protocol
    .replace(/on\w+=/gi, '') // Remove event handlers like onclick=
    .slice(0, 500); // Limit length
}

/**
 * Validates pet name
 */
export function validatePetName(name: string): { valid: boolean; error?: string } {
  if (!name || typeof name !== 'string') {
    return { valid: false, error: 'Pet name is required' };
  }
  
  const trimmed = name.trim();
  
  if (trimmed.length === 0) {
    return { valid: false, error: 'Pet name cannot be empty' };
  }
  
  if (trimmed.length > 50) {
    return { valid: false, error: 'Pet name must be 50 characters or less' };
  }
  
  // Check for potentially dangerous characters
  if (/[<>]/.test(trimmed)) {
    return { valid: false, error: 'Pet name contains invalid characters' };
  }
  
  return { valid: true };
}

/**
 * Validates pet weight
 */
export function validatePetWeight(weight: string): { valid: boolean; error?: string; value?: number } {
  if (!weight || typeof weight !== 'string') {
    return { valid: false, error: 'Weight is required' };
  }
  
  const trimmed = weight.trim();
  
  if (trimmed.length === 0) {
    return { valid: false, error: 'Weight cannot be empty' };
  }
  
  // Extract number from string (handles "10 lbs", "10kg", etc.)
  const match = trimmed.match(/(\d+\.?\d*)/);
  if (!match) {
    return { valid: false, error: 'Weight must be a number' };
  }
  
  const numValue = parseFloat(match[1]);
  
  if (isNaN(numValue) || numValue <= 0) {
    return { valid: false, error: 'Weight must be a positive number' };
  }
  
  if (numValue > 1000) {
    return { valid: false, error: 'Weight seems too high. Please check your input.' };
  }
  
  return { valid: true, value: numValue };
}

/**
 * Validates recipe ID format
 */
export function validateRecipeId(recipeId: string): { valid: boolean; error?: string } {
  if (!recipeId || typeof recipeId !== 'string') {
    return { valid: false, error: 'Recipe ID is required' };
  }
  
  // Recipe IDs should match pattern like "dog-01", "cat-11", etc.
  if (!/^[a-z]+-\d+$/.test(recipeId)) {
    return { valid: false, error: 'Invalid recipe ID format' };
  }
  
  return { valid: true };
}

/**
 * Validates user rating (1-5)
 */
export function validateRating(rating: number | string): { valid: boolean; error?: string; value?: number } {
  const numRating = typeof rating === 'string' ? parseFloat(rating) : rating;
  
  if (isNaN(numRating)) {
    return { valid: false, error: 'Rating must be a number' };
  }
  
  if (numRating < 1 || numRating > 5) {
    return { valid: false, error: 'Rating must be between 1 and 5' };
  }
  
  return { valid: true, value: Math.round(numRating) };
}

/**
 * Validates userId
 */
export function validateUserId(userId: string | null | undefined): { valid: boolean; error?: string } {
  if (!userId || typeof userId !== 'string') {
    return { valid: false, error: 'User ID is required' };
  }
  
  if (userId.trim().length === 0) {
    return { valid: false, error: 'User ID cannot be empty' };
  }
  
  return { valid: true };
}

/**
 * Validates array of strings (for health concerns, allergies, etc.)
 */
export function validateStringArray(arr: any, maxLength: number = 20): { valid: boolean; error?: string; value?: string[] } {
  if (!Array.isArray(arr)) {
    return { valid: false, error: 'Must be an array' };
  }
  
  if (arr.length > maxLength) {
    return { valid: false, error: `Maximum ${maxLength} items allowed` };
  }
  
  const validItems = arr
    .filter((item): item is string => typeof item === 'string')
    .map(item => sanitizeInput(item))
    .filter(item => item.length > 0);
  
  return { valid: true, value: validItems };
}

// =================================================================
// ZOD SCHEMAS
// =================================================================

/**
 * Zod schema for Pet validation
 */
export const PetSchema = z.object({
  id: z.string().min(1, 'Pet ID is required'),
  names: z.array(z.string().min(1).max(50)).min(1, 'At least one name is required'),
  type: z.enum(['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'], {
    errorMap: () => ({ message: 'Invalid pet type' })
  }),
  breed: z.string().min(1, 'Breed is required').max(100),
  weight: z.string().min(1, 'Weight is required').refine(
    (val) => {
      const match = val.trim().match(/(\d+\.?\d*)/);
      if (!match) return false;
      const num = parseFloat(match[1]);
      return !isNaN(num) && num > 0 && num <= 1000;
    },
    { message: 'Weight must be a positive number between 0 and 1000' }
  ),
  age: z.string().min(1, 'Age is required'),
  healthConcerns: z.array(z.string()).max(20, 'Maximum 20 health concerns allowed').default([]),
  mealPlan: z.array(z.string()).default([]),
  savedRecipes: z.array(z.string()).default([]),
  dislikes: z.array(z.string()).max(20).optional(),
  image: z.string().url().optional().or(z.literal('')),
}).refine(
  (data) => {
    // Sanitize names
    return data.names.every(name => !/[<>]/.test(name));
  },
  { message: 'Pet names contain invalid characters', path: ['names'] }
);

/**
 * Zod schema for Ingredient validation
 */
export const IngredientSchema = z.object({
  id: z.string().min(1, 'Ingredient ID is required'),
  name: z.string().min(1, 'Ingredient name is required').max(200),
  amount: z.string().min(1, 'Amount is required').max(100),
  asinLink: z.string().url().optional(),
  productName: z.string().max(200).optional(),
  vetNote: z.string().max(500).optional(),
  isVetted: z.boolean().optional(),
  isGeneric: z.boolean().optional(),
  asin: z.string().regex(/^[A-Z0-9]{10}$/, 'Invalid ASIN format').optional(),
});

/**
 * Zod schema for Recipe validation
 */
export const RecipeSchema = z.object({
  id: z.string().regex(/^[a-z]+-\d+$/, 'Invalid recipe ID format'),
  name: z.string().min(1, 'Recipe name is required').max(200),
  shortName: z.string().max(100).optional(),
  celebrityName: z.string().max(100).optional(),
  celebrityQuote: z.string().max(500).optional(),
  category: z.string().min(1),
  breed: z.union([z.string(), z.array(z.string()), z.null()]).optional(),
  ageGroup: z.array(z.string()).min(1, 'At least one age group is required'),
  healthConcerns: z.array(z.string()).default([]),
  notSuitableFor: z.array(z.string()).optional(),
  description: z.string().max(2000).optional(),
  tags: z.array(z.string()).optional(),
  imageUrl: z.string().url().optional(),
  prepTime: z.string().optional(),
  cookTime: z.string().optional(),
  servings: z.number().int().positive().optional(),
  ingredients: z.array(IngredientSchema).min(1, 'At least one ingredient is required'),
  instructions: z.array(z.string()).min(1, 'At least one instruction is required'),
  supplements: z.array(IngredientSchema).optional(),
  nutritionalInfo: z.object({
    protein: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
    fat: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
    fiber: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
    calories: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
    phosphorus: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
    calcium: z.object({ min: z.number(), max: z.number(), unit: z.string() }).optional(),
  }).optional(),
  nutritionInfo: z.object({
    protein: z.string().optional(),
    fat: z.string().optional(),
    fiber: z.string().optional(),
    calories: z.string().optional(),
    calcium: z.string().optional(),
  }).optional(),
  rating: z.number().min(1).max(5).optional(),
  reviews: z.number().int().nonnegative().optional(),
});

/**
 * Zod schema for PurchaseRecord validation
 */
export const PurchaseRecordSchema = z.object({
  ingredientId: z.string().min(1, 'Ingredient ID is required'),
  ingredientName: z.string().max(200).optional(),
  purchaseDate: z.string().datetime({ message: 'Invalid ISO date format' }),
  confirmed: z.boolean(),
  amazonOrderId: z.string().max(100).optional(),
});

/**
 * Zod schema for PetNutritionProfile validation
 */
export const PetNutritionProfileSchema = z.object({
  species: z.string().min(1, 'Species is required'),
  ageGroup: z.string().min(1, 'Age group is required'),
  weightKg: z.number().positive('Weight must be positive').max(1000, 'Weight seems too high'),
  breed: z.string().nullable().optional(),
  healthConcerns: z.array(z.string()).max(20).optional(),
  allergies: z.array(z.string()).max(20).optional(),
  caloriesPerKgOverride: z.number().positive().optional(),
  petName: z.string().max(50).optional(),
});

/**
 * Zod schema for CustomMeal validation
 */
export const CustomMealSchema = z.object({
  id: z.string().min(1, 'Meal ID is required'),
  petId: z.string().min(1, 'Pet ID is required'),
  userId: z.string().min(1, 'User ID is required'),
  name: z.string().min(1, 'Meal name is required').max(200),
  createdAt: z.string().datetime({ message: 'Invalid ISO date format' }),
  updatedAt: z.string().datetime({ message: 'Invalid ISO date format' }),
  ingredients: z.array(z.object({
    key: z.string().min(1),
    grams: z.number().positive('Grams must be positive'),
  })).min(1, 'At least one ingredient is required'),
  analysis: z.object({
    score: z.number().min(0).max(100),
    nutrients: z.record(z.string(), z.number()),
    totalRecipeGrams: z.number().positive(),
    recommendedServingGrams: z.number().positive(),
    breakdown: z.object({
      nutrientCoverageScore: z.number(),
      toxicityPenalty: z.number(),
      balanceVarietyScore: z.number(),
    }),
    toxicityWarnings: z.array(z.object({
      message: z.string(),
      severity: z.enum(['low', 'medium', 'high', 'critical']),
      ingredientKey: z.string().optional(),
      ingredientName: z.string().optional(),
    })),
    allergyWarnings: z.array(z.object({
      message: z.string(),
      severity: z.enum(['low', 'medium', 'high', 'critical']),
    })),
    nutrientWarnings: z.array(z.object({
      message: z.string(),
      severity: z.enum(['low', 'medium', 'high', 'critical']),
    })),
    suggestions: z.array(z.object({
      message: z.string(),
      action: z.string().optional(),
      confidence: z.enum(['low', 'medium', 'high']).optional(),
    })),
  }),
});

// =================================================================
// VALIDATION FUNCTIONS USING ZOD
// =================================================================

/**
 * Validate a Pet object using Zod schema
 */
export function validatePetWithZod(pet: unknown): { valid: boolean; error?: string; data?: Pet } {
  try {
    const validated = PetSchema.parse(pet);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Validate a Recipe object using Zod schema
 */
export function validateRecipeWithZod(recipe: unknown): { valid: boolean; error?: string; data?: Recipe } {
  try {
    const validated = RecipeSchema.parse(recipe);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Validate an Ingredient object using Zod schema
 */
export function validateIngredientWithZod(ingredient: unknown): { valid: boolean; error?: string; data?: Ingredient } {
  try {
    const validated = IngredientSchema.parse(ingredient);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Validate a PurchaseRecord object using Zod schema
 */
export function validatePurchaseRecordWithZod(record: unknown): { valid: boolean; error?: string; data?: PurchaseRecord } {
  try {
    const validated = PurchaseRecordSchema.parse(record);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Validate a PetNutritionProfile object using Zod schema
 */
export function validatePetNutritionProfileWithZod(profile: unknown): { valid: boolean; error?: string; data?: PetNutritionProfile } {
  try {
    const validated = PetNutritionProfileSchema.parse(profile);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Validate a CustomMeal object using Zod schema
 */
export function validateCustomMealWithZod(meal: unknown): { valid: boolean; error?: string; data?: CustomMeal } {
  try {
    const validated = CustomMealSchema.parse(meal);
    return { valid: true, data: validated };
  } catch (error) {
    if (error instanceof z.ZodError) {
      const firstError = error.errors[0];
      return { 
        valid: false, 
        error: `${firstError.path.join('.')}: ${firstError.message}` 
      };
    }
    return { valid: false, error: 'Validation failed' };
  }
}

/**
 * Safe parse with detailed error information
 */
export function safeParseWithZod<T>(schema: z.ZodSchema<T>, data: unknown): {
  success: boolean;
  data?: T;
  errors?: z.ZodError['errors'];
} {
  const result = schema.safeParse(data);
  if (result.success) {
    return { success: true, data: result.data };
  }
  return { success: false, errors: result.error.errors };
}
</file>

<file path="lib/validation/asinClusterer.ts">
// ASIN clustering algorithm - detects legitimate alias groups
// Reduces duplicate ASIN false positives by grouping related ingredients

import { IngredientAliasGroup, KNOWN_SYNONYM_PAIRS, KNOWN_CONFLICT_PATTERNS } from '../types/aliasGroups';

export class ASINClusterer {
  /**
   * Cluster ingredients that share the same ASIN
   * Returns alias groups for legitimate duplicates
   */
  clusterByASIN(
    products: Map<string, { productName: string; asinLink: string }>
  ): {
    aliasGroups: IngredientAliasGroup[];
    conflicts: Array<{ asin: string; ingredients: string[]; reason: string }>;
    singles: string[];
  } {
    // 1. Group by ASIN
    const asinMap = new Map<string, string[]>();
    
    for (const [ingredientName, product] of products) {
      const asin = this.extractASIN(product.asinLink);
      if (!asin) continue;
      
      if (!asinMap.has(asin)) {
        asinMap.set(asin, []);
      }
      asinMap.get(asin)!.push(ingredientName);
    }
    
    // 2. Process each ASIN group
    const aliasGroups: IngredientAliasGroup[] = [];
    const conflicts: Array<{ asin: string; ingredients: string[]; reason: string }> = [];
    const singles: string[] = [];
    
    for (const [asin, ingredients] of asinMap) {
      if (ingredients.length === 1) {
        singles.push(ingredients[0]);
        continue;
      }
      
      // Check if this is a legitimate alias group or a conflict
      const analysis = this.analyzeIngredientGroup(ingredients);
      
      if (analysis.isLegitimate) {
        aliasGroups.push({
          groupId: this.generateGroupId(ingredients),
          canonicalName: this.selectCanonical(ingredients),
          aliases: ingredients,
          sharedASIN: asin,
          validationStatus: 'valid', // Will be validated
          confidence: 'medium',
          lastVerified: new Date(),
          groupingReason: analysis.reason,
          notes: analysis.explanation,
        });
      } else {
        conflicts.push({
          asin,
          ingredients,
          reason: analysis.explanation,
        });
      }
    }
    
    return { aliasGroups, conflicts, singles };
  }
  
  /**
   * Analyze a group of ingredients to determine if they're legitimate aliases
   */
  private analyzeIngredientGroup(ingredients: string[]): {
    isLegitimate: boolean;
    reason: 'same-base-ingredient' | 'known-synonyms' | 'manual-override';
    explanation: string;
  } {
    // Check 1: Known conflicts (different products incorrectly sharing ASIN)
    for (const [conflictA, conflictB] of KNOWN_CONFLICT_PATTERNS) {
      const hasA = ingredients.some(i => i.toLowerCase().includes(conflictA.toLowerCase()));
      const hasB = ingredients.some(i => i.toLowerCase().includes(conflictB.toLowerCase()));
      
      if (hasA && hasB) {
        return {
          isLegitimate: false,
          reason: 'manual-override',
          explanation: `Conflict detected: ${conflictA} and ${conflictB} are different products`,
        };
      }
    }
    
    // Check 2: Known synonym pairs (check all combinations)
    for (const [synonymA, synonymB] of KNOWN_SYNONYM_PAIRS) {
      const hasA = ingredients.some(i => i.toLowerCase().includes(synonymA.toLowerCase()));
      const hasB = ingredients.some(i => i.toLowerCase().includes(synonymB.toLowerCase()));
      
      if (hasA && hasB) {
        return {
          isLegitimate: true,
          reason: 'known-synonyms',
          explanation: `Known synonyms: "${synonymA}" and "${synonymB}"`,
        };
      }
    }
    
    // Check 2b: Transitive synonym relationships
    // If A‚ÜíB and B‚ÜíC are synonyms, then A‚ÜíC should also be grouped
    const synonymGroups = this.buildSynonymGroups(KNOWN_SYNONYM_PAIRS);
    for (const group of synonymGroups) {
      const matchCount = ingredients.filter(ing => 
        group.some(syn => ing.toLowerCase().includes(syn.toLowerCase()))
      ).length;
      
      if (matchCount >= 2) {
        return {
          isLegitimate: true,
          reason: 'known-synonyms',
          explanation: `Part of synonym group: ${group.slice(0, 3).join(', ')}`,
        };
      }
    }
    
    // Check 3: Same base ingredient with preparation variants
    // e.g., "peas" vs "peas (mashed)" vs "peas (cooked)"
    const baseNames = ingredients.map(i => this.extractBaseName(i));
    const uniqueBaseNames = new Set(baseNames);
    
    if (uniqueBaseNames.size === 1) {
      return {
        isLegitimate: true,
        reason: 'same-base-ingredient',
        explanation: `Same base ingredient with preparation variants: ${Array.from(uniqueBaseNames)[0]}`,
      };
    }
    
    // Check 4: Very similar names (Levenshtein distance)
    if (ingredients.length === 2) {
      const similarity = this.calculateSimilarity(ingredients[0], ingredients[1]);
      if (similarity > 0.8) {
        return {
          isLegitimate: true,
          reason: 'same-base-ingredient',
          explanation: `High name similarity (${Math.round(similarity * 100)}%)`,
        };
      }
    }
    
    // Default: flag for manual review
    return {
      isLegitimate: false,
      reason: 'manual-override',
      explanation: 'Ambiguous grouping - needs manual review',
    };
  }
  
  /**
   * Extract base ingredient name by removing preparation notes
   * "peas (mashed)" -> "peas"
   * "brown rice" -> "brown rice"
   */
  private extractBaseName(ingredient: string): string {
    // Remove parenthetical notes
    let base = ingredient.replace(/\s*\([^)]*\)/g, '').trim();
    
    // Remove common preparation prefixes/suffixes
    base = base.replace(/\s+(cooked|raw|fresh|frozen|mashed|ground|minced|chopped)$/i, '');
    
    return base.toLowerCase();
  }
  
  /**
   * Select canonical name from aliases (prefer shortest, most common)
   */
  private selectCanonical(ingredients: string[]): string {
    // Prefer names without parentheses
    const withoutParens = ingredients.filter(i => !i.includes('('));
    if (withoutParens.length > 0) {
      return withoutParens.sort((a, b) => a.length - b.length)[0];
    }
    
    // Otherwise, shortest name
    return ingredients.sort((a, b) => a.length - b.length)[0];
  }
  
  /**
   * Generate a unique group ID from ingredient names
   */
  private generateGroupId(ingredients: string[]): string {
    const base = this.extractBaseName(ingredients[0]);
    const hash = this.simpleHash(ingredients.join('|'));
    return `${base.replace(/\s+/g, '_')}_${hash}`;
  }
  
  /**
   * Extract ASIN from Amazon link
   */
  private extractASIN(link: string): string | null {
    const match = link.match(/\/dp\/([A-Z0-9]{10})/i);
    return match ? match[1] : null;
  }
  
  /**
   * Calculate string similarity (simple Levenshtein-based)
   */
  private calculateSimilarity(a: string, b: string): number {
    const longer = a.length > b.length ? a : b;
    const shorter = a.length > b.length ? b : a;
    
    if (longer.length === 0) return 1.0;
    
    const distance = this.levenshteinDistance(longer.toLowerCase(), shorter.toLowerCase());
    return (longer.length - distance) / longer.length;
  }
  
  /**
   * Levenshtein distance calculation
   */
  private levenshteinDistance(a: string, b: string): number {
    const matrix: number[][] = [];
    
    for (let i = 0; i <= b.length; i++) {
      matrix[i] = [i];
    }
    
    for (let j = 0; j <= a.length; j++) {
      matrix[0][j] = j;
    }
    
    for (let i = 1; i <= b.length; i++) {
      for (let j = 1; j <= a.length; j++) {
        if (b.charAt(i - 1) === a.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }
    
    return matrix[b.length][a.length];
  }
  
  /**
   * Simple hash function for group IDs
   */
  private simpleHash(str: string): string {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash).toString(36).substring(0, 6);
  }
  
  /**
   * Build transitive synonym groups from pairs
   * If A‚ÜíB and B‚ÜíC, then [A, B, C] form a group
   */
  private buildSynonymGroups(pairs: Array<[string, string]>): string[][] {
    const groups: string[][] = [];
    const processed = new Set<string>();
    
    for (const [a, b] of pairs) {
      if (processed.has(a) || processed.has(b)) continue;
      
      // Find all connected synonyms
      const group = new Set<string>([a, b]);
      let changed = true;
      
      while (changed) {
        changed = false;
        for (const [pairA, pairB] of pairs) {
          if (group.has(pairA) && !group.has(pairB)) {
            group.add(pairB);
            changed = true;
          }
          if (group.has(pairB) && !group.has(pairA)) {
            group.add(pairA);
            changed = true;
          }
        }
      }
      
      const groupArray = Array.from(group);
      groups.push(groupArray);
      groupArray.forEach(item => processed.add(item));
    }
    
    return groups;
  }
}
</file>

<file path="lib/validation/enhancedRetailValidator.ts">
// Enhanced retail validator with 4-state validation and token equivalence
// Separates structural (safety) from semantic (naming) concerns

import { IngredientRetailSpec, ValidationResult, ValidationIssue } from '../types/retailValidation';
import { tokenMatches, extractIngredientFamily } from './tokenEquivalence';

export class EnhancedRetailValidator {
  /**
   * Validate product title with 4-state logic and token equivalence
   * 
   * States:
   * - VALID: All required tokens matched exactly, no forbidden tokens
   * - STRUCTURALLY_VALID: Safe product, but uses equivalent tokens or flexible matching
   * - AMBIGUOUS: Too many missing tokens, needs human review
   * - INVALID: Contains forbidden tokens or critical failures
   */
  validateProductTitle(
    productTitle: string,
    spec: IngredientRetailSpec,
    asin: string,
    ingredientName?: string
  ): ValidationResult {
    const structuralIssues: ValidationIssue[] = [];
    const semanticIssues: ValidationIssue[] = [];
    
    const reasoning = {
      requiredTokensMatched: [] as string[],
      equivalentTokensUsed: [] as Array<{ token: string; synonym: string }>,
      forbiddenTokensFound: [] as string[],
      structurallySound: true,
    };
    
    const titleLower = spec.validationRules.caseSensitive ? productTitle : productTitle.toLowerCase();
    const ingredientFamily = ingredientName ? extractIngredientFamily(ingredientName) : undefined;
    
    // STEP 1: Check forbidden tokens (HARD FAIL - structural issue)
    for (const forbiddenToken of spec.forbiddenTokens) {
      const searchToken = spec.validationRules.caseSensitive ? forbiddenToken : forbiddenToken.toLowerCase();
      if (titleLower.includes(searchToken)) {
        reasoning.forbiddenTokensFound.push(forbiddenToken);
        reasoning.structurallySound = false;
        
        structuralIssues.push({
          type: 'has-forbidden',
          severity: 'critical',
          message: `Contains forbidden token: "${forbiddenToken}"`,
          details: { token: forbiddenToken },
        });
      }
    }
    
    // If forbidden tokens found, immediately return INVALID
    if (reasoning.forbiddenTokensFound.length > 0) {
      return {
        status: 'invalid',
        confidence: 'low',
        structuralIssues,
        semanticIssues,
        reasoning,
      };
    }
    
    // STEP 2: Check required tokens with equivalence (semantic issue if missing)
    const missingTokens: string[] = [];
    
    for (const requiredToken of spec.requiredTokens) {
      const match = tokenMatches(requiredToken, titleLower, ingredientFamily);
      
      if (match.matched) {
        if (match.via === 'direct') {
          reasoning.requiredTokensMatched.push(requiredToken);
        } else if (match.via === 'equivalent' && match.synonym) {
          reasoning.equivalentTokensUsed.push({
            token: requiredToken,
            synonym: match.synonym,
          });
        }
      } else {
        missingTokens.push(requiredToken);
      }
    }
    
    // STEP 3: Check acceptable forms (if specified)
    let formMatched = true;
    if (spec.acceptableForms && spec.acceptableForms.length > 0) {
      formMatched = spec.acceptableForms.some(form => {
        const searchForm = spec.validationRules.caseSensitive ? form : form.toLowerCase();
        return titleLower.includes(searchForm);
      });
      
      if (!formMatched) {
        semanticIssues.push({
          type: 'form-mismatch',
          severity: 'warning',
          message: `No acceptable form found. Expected one of: ${spec.acceptableForms.join(', ')}`,
          details: { acceptableForms: spec.acceptableForms },
        });
      }
    }
    
    // STEP 4: Determine status based on token matching
    const totalRequired = spec.requiredTokens.length;
    const directMatches = reasoning.requiredTokensMatched.length;
    const equivalentMatches = reasoning.equivalentTokensUsed.length;
    const totalMatches = directMatches + equivalentMatches;
    const matchRate = totalMatches / totalRequired;
    
    // Add semantic issues for missing tokens
    if (missingTokens.length > 0) {
      const severity = matchRate < 0.5 ? 'critical' : 'warning';
      semanticIssues.push({
        type: 'missing-required',
        severity,
        message: `Missing ${missingTokens.length} required token(s): ${missingTokens.join(', ')}`,
        details: { missing: missingTokens, matchRate },
      });
    }
    
    // DECISION LOGIC
    let status: ValidationResult['status'];
    let confidence: ValidationResult['confidence'];
    
    if (totalMatches === totalRequired && directMatches === totalRequired && formMatched) {
      // Perfect match: all tokens direct, form correct
      status = 'valid';
      confidence = 'high';
    } else if (totalMatches === totalRequired) {
      // All tokens matched via equivalence or flexible matching
      status = 'structurally-valid';
      confidence = equivalentMatches > 0 ? 'medium' : 'high';
    } else if (matchRate >= 0.6 && spec.validationRules.titleMatch === 'flexible') {
      // Flexible mode: 60%+ tokens matched
      status = 'structurally-valid';
      confidence = 'medium';
    } else if (matchRate >= 0.5) {
      // Borderline: needs human review
      status = 'ambiguous';
      confidence = 'low';
    } else {
      // Too many missing tokens
      status = 'ambiguous';
      confidence = 'low';
    }
    
    return {
      status,
      confidence,
      structuralIssues,
      semanticIssues,
      reasoning,
    };
  }
  
  /**
   * Batch validate multiple products
   */
  validateBatch(
    products: Array<{
      ingredient: string;
      productTitle: string;
      asin: string;
      spec: IngredientRetailSpec;
    }>
  ): Map<string, ValidationResult> {
    const results = new Map<string, ValidationResult>();
    
    for (const product of products) {
      const result = this.validateProductTitle(
        product.productTitle,
        product.spec,
        product.asin,
        product.ingredient
      );
      results.set(product.ingredient, result);
    }
    
    return results;
  }
}
</file>

<file path="lib/validation/petSchema.ts">
// lib/validation/petSchema.ts
// Data validation schemas using Zod

import { z } from 'zod';

// Pet validation schema
export const PetSchema = z.object({
  id: z.string().min(1),
  names: z.array(z.string().min(1)).min(1, 'At least one name is required'),
  type: z.enum(['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets']),
  breed: z.string().min(1, 'Breed is required'),
  age: z.enum(['baby', 'young', 'adult', 'senior']),
  weight: z.string().optional(),
  weightKg: z.number().positive().optional(),
  healthConcerns: z.array(z.string()).optional(),
  dietaryRestrictions: z.array(z.string()).optional(),
  allergies: z.array(z.string()).optional(),
  dislikes: z.array(z.string()).optional(),
  savedRecipes: z.array(z.string()).optional(),
  image: z.string().optional(),
});

// Custom meal validation schema
export const CustomMealSchema = z.object({
  id: z.string().min(1),
  petId: z.string().min(1),
  userId: z.string().min(1),
  name: z.string().min(1, 'Meal name is required').max(100),
  createdAt: z.string(),
  updatedAt: z.string(),
  ingredients: z.array(z.object({
    key: z.string().min(1),
    grams: z.number().positive('Grams must be positive'),
  })).min(1, 'At least one ingredient is required'),
  analysis: z.object({
    score: z.number().min(0).max(100),
    nutrients: z.record(z.number()),
    totalRecipeGrams: z.number().positive(),
    recommendedServingGrams: z.number().positive(),
    breakdown: z.object({
      nutrientCoverageScore: z.number(),
      toxicityPenalty: z.number(),
      balanceVarietyScore: z.number(),
    }),
    toxicityWarnings: z.array(z.any()),
    allergyWarnings: z.array(z.any()),
    nutrientWarnings: z.array(z.any()),
    suggestions: z.array(z.any()),
  }),
});

// Validation helpers
export function validatePet(data: unknown) {
  return PetSchema.parse(data);
}

export function validateCustomMeal(data: unknown) {
  return CustomMealSchema.parse(data);
}

export function validatePetPartial(data: unknown) {
  return PetSchema.partial().parse(data);
}
</file>

<file path="lib/validation/retailSpecDefinitions.ts">
// Retail specs for high-priority ingredients
// These define what makes a product valid for each ingredient
// 
// IMPORTANT: Specs should only encode retail form constraints, NOT quality/nutrition
// - YES: identity (chicken vs beef), preparation (raw vs cooked), medium (water vs oil)
// - NO: organic, grass-fed, quality language, micronutrients

import { IngredientRetailSpec } from '../types/retailValidation';

export const RETAIL_SPECS: Record<string, IngredientRetailSpec> = {
  // MEATS - High Priority Issues
  'venison': {
    requiredTokens: ['venison', 'deer'],
    forbiddenTokens: ['beef', 'seasoned', 'jerky', 'cooked', 'smoked', 'marinated', 'sausage'],
    acceptableForms: ['raw', 'ground', 'frozen', 'fresh'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'rabbit meat': {
    requiredTokens: ['rabbit'],
    forbiddenTokens: ['lamb', 'seasoned', 'cooked', 'smoked', 'marinated'],
    acceptableForms: ['raw', 'ground', 'frozen', 'fresh', 'whole'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'turkey giblets': {
    requiredTokens: ['turkey', 'giblets'],
    forbiddenTokens: ['chicken', 'seasoned', 'cooked', 'gravy'],
    acceptableForms: ['raw', 'frozen', 'fresh'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'ground beef (lean)': {
    requiredTokens: ['beef', 'ground'],
    forbiddenTokens: ['venison', 'seasoned', 'cooked', 'patties', 'burger'],
    acceptableForms: ['raw', 'frozen', 'fresh', 'lean'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'ground lamb': {
    requiredTokens: ['lamb', 'ground'],
    forbiddenTokens: ['rabbit', 'beef', 'seasoned', 'cooked', 'kebab', 'kofta'],
    acceptableForms: ['raw', 'frozen', 'fresh'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'chicken hearts': {
    requiredTokens: ['chicken', 'hearts'],
    forbiddenTokens: ['turkey', 'duck', 'seasoned', 'cooked'],
    acceptableForms: ['raw', 'frozen', 'fresh'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'duck hearts': {
    requiredTokens: ['duck', 'hearts'],
    forbiddenTokens: ['chicken', 'turkey', 'egg', 'seasoned', 'cooked'],
    acceptableForms: ['raw', 'frozen', 'fresh'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // FISH - High Priority Issues
  'herring (canned)': {
    requiredTokens: ['herring'],
    forbiddenTokens: ['sardines', 'sardine', 'smoked', 'pickled', 'creamed', 'in oil'],
    acceptableForms: ['canned', 'in water', 'water packed'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'sardines (canned in water)': {
    requiredTokens: ['sardines', 'water'],
    forbiddenTokens: ['herring', 'in oil', 'smoked', 'tomato'],
    acceptableForms: ['canned', 'water packed'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'sardines (in water)': {
    requiredTokens: ['sardines', 'water'],
    forbiddenTokens: ['herring', 'in oil', 'smoked', 'tomato'],
    acceptableForms: ['canned', 'water packed'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // SEEDS - High Priority Issues
  'canary seed': {
    requiredTokens: ['canary', 'seed'],
    forbiddenTokens: ['mix', 'blend', 'treat'],
    validationRules: {
      titleMatch: 'flexible', // Seed mixes might be OK
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'flaxseeds': {
    requiredTokens: ['flax'],
    forbiddenTokens: ['oil', 'meal', 'capsule', 'supplement'],
    acceptableForms: ['seed', 'seeds', 'whole', 'ground'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'niger seed': {
    requiredTokens: ['niger', 'nyjer', 'thistle'],
    forbiddenTokens: ['mix', 'blend'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'hemp seeds': {
    requiredTokens: ['hemp', 'seed'],
    forbiddenTokens: ['oil', 'protein', 'powder', 'hearts'],
    acceptableForms: ['seed', 'seeds', 'whole', 'hulled'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'chia seeds': {
    requiredTokens: ['chia', 'seed'],
    forbiddenTokens: ['oil', 'powder', 'gel'],
    acceptableForms: ['seed', 'seeds', 'whole'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'sunflower seeds (small amounts)': {
    requiredTokens: ['sunflower', 'seed'],
    forbiddenTokens: ['oil', 'roasted', 'salted', 'flavored'],
    acceptableForms: ['raw', 'shelled', 'unshelled'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'pumpkin seeds': {
    requiredTokens: ['pumpkin', 'seed'],
    forbiddenTokens: ['oil', 'roasted', 'salted', 'flavored'],
    acceptableForms: ['raw', 'shelled', 'pepitas'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // OILS - High Priority Issues
  'chia seed oil': {
    requiredTokens: ['chia', 'oil'],
    forbiddenTokens: ['mango', 'blend', 'capsule'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // EGGS - High Priority Issues
  'egg (hard-boiled)': {
    requiredTokens: ['egg'],
    forbiddenTokens: ['duck', 'quail', 'liquid', 'powder', 'substitute'],
    acceptableForms: ['hard boiled', 'hard-boiled', 'boiled', 'whole'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // VEGETABLES - Dead Link
  'endive': {
    requiredTokens: ['endive'],
    forbiddenTokens: [],
    acceptableForms: ['fresh', 'organic'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // GRAINS
  'brown rice': {
    requiredTokens: ['brown', 'rice'],
    forbiddenTokens: ['white', 'instant', 'minute', 'flavored', 'seasoned'],
    acceptableForms: ['whole grain', 'long grain', 'short grain'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'rice (hulled)': {
    requiredTokens: ['rice', 'hulled'],
    forbiddenTokens: ['white', 'instant', 'minute', 'flavored', 'seasoned'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // COMMON PROTEINS - Dogs/Cats
  'ground chicken': {
    requiredTokens: ['chicken', 'ground'],
    forbiddenTokens: ['giblets', 'liver', 'hearts', 'seasoned', 'cooked', 'breaded'],
    acceptableForms: ['raw', 'fresh', 'frozen'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'chicken breast': {
    requiredTokens: ['chicken', 'breast'],
    forbiddenTokens: ['seasoned', 'cooked', 'breaded', 'marinated', 'fried'],
    acceptableForms: ['raw', 'fresh', 'frozen', 'boneless'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'chicken thighs': {
    requiredTokens: ['chicken', 'thigh'],
    forbiddenTokens: ['seasoned', 'cooked', 'breaded', 'marinated', 'fried'],
    acceptableForms: ['raw', 'fresh', 'frozen', 'boneless'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'beef liver': {
    requiredTokens: ['beef', 'liver'],
    forbiddenTokens: ['pork', 'chicken', 'seasoned', 'cooked'],
    acceptableForms: ['raw', 'fresh', 'frozen'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'ground turkey': {
    requiredTokens: ['turkey', 'ground'],
    forbiddenTokens: ['chicken', 'seasoned', 'cooked', 'patties'],
    acceptableForms: ['raw', 'fresh', 'frozen'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'salmon (canned)': {
    requiredTokens: ['salmon'],
    forbiddenTokens: ['smoked', 'seasoned', 'in oil'],
    acceptableForms: ['canned', 'in water', 'water packed'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'tuna (canned in water)': {
    requiredTokens: ['tuna', 'water'],
    forbiddenTokens: ['in oil', 'seasoned', 'flavored'],
    acceptableForms: ['canned', 'water packed'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // COMMON VEGETABLES
  'carrots': {
    requiredTokens: ['carrot'],
    forbiddenTokens: ['candied', 'glazed', 'seasoned'],
    acceptableForms: ['raw', 'fresh', 'baby', 'whole'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'broccoli': {
    requiredTokens: ['broccoli'],
    forbiddenTokens: ['cheese', 'seasoned', 'sauce'],
    acceptableForms: ['raw', 'fresh', 'frozen', 'florets'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'spinach': {
    requiredTokens: ['spinach'],
    forbiddenTokens: ['creamed', 'seasoned', 'sauce'],
    acceptableForms: ['raw', 'fresh', 'frozen', 'baby'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'sweet potato': {
    requiredTokens: ['sweet potato'],
    forbiddenTokens: ['candied', 'glazed', 'seasoned', 'fries'],
    acceptableForms: ['raw', 'fresh', 'whole'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'pumpkin (canned)': {
    requiredTokens: ['pumpkin'],
    forbiddenTokens: ['pie filling', 'spice', 'seasoned'],
    acceptableForms: ['canned', 'puree', 'pure'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // COMMON SUPPLEMENTS
  'fish oil': {
    requiredTokens: ['fish', 'oil'],
    forbiddenTokens: ['capsule only'],
    acceptableForms: ['liquid', 'omega-3', 'omega 3'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'salmon oil': {
    requiredTokens: ['salmon', 'oil'],
    forbiddenTokens: [],
    acceptableForms: ['liquid', 'omega-3', 'omega 3'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'coconut oil': {
    requiredTokens: ['coconut', 'oil'],
    forbiddenTokens: ['scented', 'cosmetic'],
    acceptableForms: ['virgin', 'unrefined', 'refined'],
    validationRules: {
      titleMatch: 'strict',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'probiotic': {
    requiredTokens: ['probiotic'],
    forbiddenTokens: [],
    acceptableForms: ['powder', 'capsule', 'supplement'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'digestive enzyme': {
    requiredTokens: ['digestive', 'enzyme'],
    forbiddenTokens: [],
    acceptableForms: ['powder', 'capsule', 'supplement'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  // GRAINS
  'oats': {
    requiredTokens: ['oat'],
    forbiddenTokens: ['instant', 'flavored', 'sweetened'],
    acceptableForms: ['rolled', 'steel cut', 'whole'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'quinoa': {
    requiredTokens: ['quinoa'],
    forbiddenTokens: ['flavored', 'seasoned', 'instant'],
    acceptableForms: ['white', 'red', 'tri-color', 'whole'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
  
  'barley': {
    requiredTokens: ['barley'],
    forbiddenTokens: ['pearled only', 'instant'],
    acceptableForms: ['whole', 'hulled', 'pearled'],
    validationRules: {
      titleMatch: 'flexible',
      allowGenericBrand: true,
      caseSensitive: false,
    },
  },
};
</file>

<file path="lib/validation/retailValidator.ts">
// Title-based retail validation (Phase 1 - no PA-API yet)
// Validates product titles against ingredient specs

import { IngredientRetailSpec, ValidationResult, ValidationIssue, ProductMetadata } from '../types/retailValidation';

export class RetailValidator {
  /**
   * Validate a product title against an ingredient spec
   * This is Phase 1: simple title parsing without PA-API
   */
  validateProductTitle(
    productTitle: string,
    spec: IngredientRetailSpec,
    asin: string
  ): ValidationResult {
    const issues: ValidationIssue[] = [];
    const titleLower = spec.validationRules.caseSensitive ? productTitle : productTitle.toLowerCase();
    
    // Check required tokens
    const missingRequired = spec.requiredTokens.filter(token => {
      const searchToken = spec.validationRules.caseSensitive ? token : token.toLowerCase();
      return !titleLower.includes(searchToken);
    });
    
    if (missingRequired.length > 0) {
      if (spec.validationRules.titleMatch === 'strict') {
        issues.push({
          type: 'missing-required',
          severity: 'critical',
          message: `Missing required tokens: ${missingRequired.join(', ')}`,
          details: { missing: missingRequired },
        });
      } else {
        // Flexible: allow if most tokens present
        const matchRate = (spec.requiredTokens.length - missingRequired.length) / spec.requiredTokens.length;
        if (matchRate < 0.6) {
          issues.push({
            type: 'missing-required',
            severity: 'warning',
            message: `Only ${Math.round(matchRate * 100)}% of required tokens present`,
            details: { missing: missingRequired, matchRate },
          });
        }
      }
    }
    
    // Check forbidden tokens
    const foundForbidden = spec.forbiddenTokens.filter(token => {
      const searchToken = spec.validationRules.caseSensitive ? token : token.toLowerCase();
      return titleLower.includes(searchToken);
    });
    
    if (foundForbidden.length > 0) {
      issues.push({
        type: 'has-forbidden',
        severity: 'critical',
        message: `Contains forbidden tokens: ${foundForbidden.join(', ')}`,
        details: { forbidden: foundForbidden },
      });
    }
    
    // Check acceptable forms (if specified)
    if (spec.acceptableForms && spec.acceptableForms.length > 0) {
      const hasAcceptableForm = spec.acceptableForms.some(form => {
        const searchForm = spec.validationRules.caseSensitive ? form : form.toLowerCase();
        return titleLower.includes(searchForm);
      });
      
      if (!hasAcceptableForm) {
        issues.push({
          type: 'form-mismatch',
          severity: 'warning',
          message: `No acceptable form found. Expected one of: ${spec.acceptableForms.join(', ')}`,
          details: { acceptableForms: spec.acceptableForms },
        });
      }
    }
    
    // Determine status and confidence
    const criticalIssues = issues.filter(i => i.severity === 'critical');
    const warningIssues = issues.filter(i => i.severity === 'warning');
    
    let status: ValidationResult['status'];
    let confidence: ValidationResult['confidence'];
    
    if (criticalIssues.length > 0) {
      status = 'invalid';
      confidence = 'low';
    } else if (warningIssues.length > 0) {
      status = 'ambiguous';
      confidence = 'medium';
    } else {
      status = 'valid';
      confidence = 'high';
    }
    
    // Create basic metadata from what we have
    const metadata: ProductMetadata = {
      asin,
      title: productTitle,
      availability: 'unknown',
      lastFetched: new Date(),
    };
    
    return {
      status,
      confidence,
      issues,
      metadata,
    };
  }
  
  /**
   * Batch validate multiple products
   */
  validateBatch(
    products: Array<{ ingredient: string; productTitle: string; asin: string; spec: IngredientRetailSpec }>
  ): Map<string, ValidationResult> {
    const results = new Map<string, ValidationResult>();
    
    for (const product of products) {
      const result = this.validateProductTitle(product.productTitle, product.spec, product.asin);
      results.set(product.ingredient, result);
    }
    
    return results;
  }
  
  /**
   * Extract package size from title (basic heuristic)
   * This will be improved with PA-API in Phase 2
   */
  extractPackageSize(title: string): { amount: number; unit: string; raw: string } | null {
    // Common patterns: "2 lb", "16 oz", "1 kg", "500g", "12 count"
    const patterns = [
      /(\d+\.?\d*)\s*(lb|lbs|pound|pounds)/i,
      /(\d+\.?\d*)\s*(oz|ounce|ounces)/i,
      /(\d+\.?\d*)\s*(kg|kilogram|kilograms)/i,
      /(\d+\.?\d*)\s*(g|gram|grams)/i,
      /(\d+)\s*(count|ct|pack|pieces)/i,
    ];
    
    for (const pattern of patterns) {
      const match = title.match(pattern);
      if (match) {
        return {
          amount: parseFloat(match[1]),
          unit: match[2].toLowerCase(),
          raw: match[0],
        };
      }
    }
    
    return null;
  }
}
</file>

<file path="lib/validation/tokenEquivalence.ts">
// Token equivalence mapping - handles lexical variants that mean the same thing
// Keep this SMALL and EXPLICIT - no regex expansion, no ML

export interface TokenEquivalenceMap {
  [ingredientFamily: string]: {
    [canonicalToken: string]: string[];
  };
}

// Small, explicit synonym table
// Format: canonical token -> acceptable synonyms
export const TOKEN_EQUIVALENCE: TokenEquivalenceMap = {
  // Rice family
  rice: {
    'hulled': ['brown', 'whole grain', 'unmilled'],
    'white': ['polished', 'refined', 'milled'],
    'long grain': ['basmati', 'jasmine'],
    'short grain': ['arborio', 'sushi'],
  },
  
  // Fish - canning medium
  sardines: {
    'water packed': ['in water', 'water', 'brine'],
    'oil packed': ['in oil', 'olive oil', 'soybean oil'],
    'canned': ['tinned', 'preserved'],
  },
  
  herring: {
    'water packed': ['in water', 'water', 'brine'],
    'canned': ['tinned', 'preserved'],
  },
  
  tuna: {
    'water packed': ['in water', 'water', 'brine'],
    'oil packed': ['in oil', 'olive oil'],
    'canned': ['tinned', 'preserved'],
  },
  
  salmon: {
    'canned': ['tinned', 'preserved'],
    'wild': ['wild caught', 'wild-caught'],
    'fresh': ['raw', 'uncooked'],
  },
  
  // Chicken preparation
  chicken: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince'],
    'breast': ['white meat'],
    'thigh': ['dark meat'],
    'whole': ['entire', 'complete'],
  },
  
  // Beef preparation
  beef: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince', 'hamburger'],
    'lean': ['extra lean', '90/10', '93/7', '95/5'],
    'grass fed': ['grass-fed', 'pasture raised'],
  },
  
  // Lamb preparation
  lamb: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince'],
    'leg': ['shank'],
  },
  
  // Turkey preparation
  turkey: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince'],
    'breast': ['white meat'],
  },
  
  // Pork preparation
  pork: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince'],
    'lean': ['trimmed', 'fat removed'],
  },
  
  // Duck preparation
  duck: {
    'raw': ['fresh', 'uncooked'],
    'whole': ['entire', 'complete'],
  },
  
  // Venison preparation
  venison: {
    'raw': ['fresh', 'uncooked'],
    'ground': ['minced', 'mince'],
    'deer': ['elk', 'game'],
  },
  
  // Rabbit preparation
  rabbit: {
    'raw': ['fresh', 'uncooked'],
    'whole': ['entire', 'complete'],
  },
  
  // Eggs
  egg: {
    'hard boiled': ['hard-boiled', 'boiled', 'cooked'],
    'whole': ['entire', 'complete', 'shell on'],
    'chicken': ['hen'],
  },
  
  // Vegetables - preparation
  vegetable: {
    'raw': ['fresh', 'uncooked'],
    'cooked': ['steamed', 'boiled'],
    'organic': ['organically grown'],
  },
  
  // Carrots
  carrot: {
    'raw': ['fresh', 'uncooked'],
    'baby': ['small', 'mini'],
  },
  
  // Broccoli
  broccoli: {
    'raw': ['fresh', 'uncooked'],
    'florets': ['crowns', 'heads'],
  },
  
  // Spinach
  spinach: {
    'raw': ['fresh', 'uncooked'],
    'baby': ['young', 'tender'],
  },
  
  // Sweet potato
  'sweet potato': {
    'raw': ['fresh', 'uncooked'],
    'yam': ['sweet yam'],
  },
  
  // Peas
  peas: {
    'green': ['garden', 'english'],
    'split': ['dried'],
    'sugar snap': ['snap', 'edible pod'],
  },
  
  // Seeds
  seed: {
    'whole': ['intact', 'unprocessed'],
    'raw': ['unroasted', 'natural'],
    'shelled': ['hulled', 'dehulled'],
  },
  
  // Flax
  flax: {
    'ground': ['milled', 'meal'],
    'whole': ['intact', 'seed'],
  },
  
  // Chia
  chia: {
    'whole': ['intact', 'seed'],
    'black': ['dark'],
  },
  
  // Hemp
  hemp: {
    'hulled': ['shelled', 'hearts'],
    'whole': ['intact', 'seed'],
  },
  
  // Nuts
  nut: {
    'raw': ['unroasted', 'natural', 'unsalted'],
    'whole': ['intact', 'unprocessed'],
    'chopped': ['pieces', 'crushed'],
  },
  
  // Almond
  almond: {
    'raw': ['unroasted', 'natural'],
    'whole': ['intact'],
    'sliced': ['slivered'],
  },
  
  // Walnut
  walnut: {
    'raw': ['unroasted', 'natural'],
    'halves': ['pieces'],
  },
  
  // Oils
  oil: {
    'extra virgin': ['cold pressed', 'unrefined'],
    'refined': ['processed'],
  },
  
  // Fish oil
  'fish oil': {
    'omega 3': ['omega-3', 'dha', 'epa'],
    'liquid': ['oil'],
  },
  
  // Supplements
  supplement: {
    'powder': ['powdered'],
    'capsule': ['pill', 'tablet'],
    'liquid': ['oil', 'tincture'],
  },
  
  // Prebiotic
  prebiotic: {
    'fiber': ['fibre'],
    'inulin': ['chicory root', 'fos'],
  },
  
  // Probiotic
  probiotic: {
    'live': ['active', 'viable'],
    'culture': ['bacteria', 'strain'],
  },
  
  // Joint supplements
  joint: {
    'glucosamine': ['glucosamine sulfate', 'glucosamine hcl'],
    'chondroitin': ['chondroitin sulfate'],
    'msm': ['methylsulfonylmethane'],
  },
  
  // Grains
  grain: {
    'whole': ['intact', 'unprocessed'],
    'rolled': ['flaked'],
  },
  
  // Oats
  oats: {
    'rolled': ['old fashioned', 'flaked'],
    'steel cut': ['irish', 'pinhead'],
    'whole': ['groats'],
  },
  
  // Quinoa
  quinoa: {
    'white': ['ivory'],
    'red': ['crimson'],
    'whole': ['grain'],
  },
  
  // Hay (for pocket pets)
  hay: {
    'timothy': ['grass hay'],
    'alfalfa': ['lucerne'],
    'orchard': ['orchard grass'],
  },
  
  // Pellets
  pellet: {
    'fortified': ['enriched', 'supplemented'],
    'complete': ['balanced', 'all-in-one'],
  },
};

/**
 * Get equivalent tokens for a given ingredient family and canonical token
 */
export function getEquivalentTokens(
  ingredientFamily: string | undefined,
  canonicalToken: string
): string[] {
  if (!ingredientFamily) return [];
  
  const familyMap = TOKEN_EQUIVALENCE[ingredientFamily.toLowerCase()];
  if (!familyMap) return [];
  
  const equivalents = familyMap[canonicalToken.toLowerCase()];
  return equivalents || [];
}

/**
 * Check if a token matches either directly or via equivalence
 */
export function tokenMatches(
  searchToken: string,
  targetText: string,
  ingredientFamily?: string
): { matched: boolean; via: 'direct' | 'equivalent' | null; synonym?: string } {
  const searchLower = searchToken.toLowerCase();
  const targetLower = targetText.toLowerCase();
  
  // Direct match
  if (targetLower.includes(searchLower)) {
    return { matched: true, via: 'direct' };
  }
  
  // Check equivalents
  if (ingredientFamily) {
    const equivalents = getEquivalentTokens(ingredientFamily, searchToken);
    for (const equiv of equivalents) {
      if (targetLower.includes(equiv.toLowerCase())) {
        return { matched: true, via: 'equivalent', synonym: equiv };
      }
    }
  }
  
  return { matched: false, via: null };
}

/**
 * Extract ingredient family from ingredient name
 * Used to determine which equivalence map to use
 */
export function extractIngredientFamily(ingredientName: string): string | undefined {
  const name = ingredientName.toLowerCase();
  
  // Check for known families (order matters - most specific first)
  
  // Specific proteins
  if (name.includes('venison') || name.includes('deer')) return 'venison';
  if (name.includes('rabbit')) return 'rabbit';
  if (name.includes('duck')) return 'duck';
  if (name.includes('pork')) return 'pork';
  if (name.includes('turkey')) return 'turkey';
  if (name.includes('lamb')) return 'lamb';
  if (name.includes('beef')) return 'beef';
  if (name.includes('chicken')) return 'chicken';
  
  // Fish
  if (name.includes('salmon')) return 'salmon';
  if (name.includes('tuna')) return 'tuna';
  if (name.includes('sardine')) return 'sardines';
  if (name.includes('herring')) return 'herring';
  
  // Eggs
  if (name.includes('egg')) return 'egg';
  
  // Specific vegetables
  if (name.includes('sweet potato') || name.includes('yam')) return 'sweet potato';
  if (name.includes('carrot')) return 'carrot';
  if (name.includes('broccoli')) return 'broccoli';
  if (name.includes('spinach')) return 'spinach';
  if (name.includes('pea')) return 'peas';
  
  // Specific seeds
  if (name.includes('flax')) return 'flax';
  if (name.includes('chia')) return 'chia';
  if (name.includes('hemp')) return 'hemp';
  
  // Specific nuts
  if (name.includes('almond')) return 'almond';
  if (name.includes('walnut')) return 'walnut';
  
  // Grains
  if (name.includes('rice')) return 'rice';
  if (name.includes('oat')) return 'oats';
  if (name.includes('quinoa')) return 'quinoa';
  
  // Supplements
  if (name.includes('fish oil') || name.includes('omega')) return 'fish oil';
  if (name.includes('prebiotic') || name.includes('inulin') || name.includes('fos')) return 'prebiotic';
  if (name.includes('probiotic')) return 'probiotic';
  if (name.includes('joint') || name.includes('glucosamine') || name.includes('chondroitin')) return 'joint';
  
  // Hay (pocket pets)
  if (name.includes('hay') || name.includes('timothy') || name.includes('alfalfa')) return 'hay';
  
  // Pellets
  if (name.includes('pellet')) return 'pellet';
  
  // Generic categories
  if (name.includes('seed')) return 'seed';
  if (name.includes('nut')) return 'nut';
  if (name.includes('oil')) return 'oil';
  if (name.includes('supplement')) return 'supplement';
  if (name.includes('vegetable') || name.includes('veggie')) return 'vegetable';
  if (name.includes('grain')) return 'grain';
  
  return undefined;
}
</file>

<file path="middleware.tsx">
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

const isProtectedRoute = createRouteMatcher(['/profile(.*)'])

export default clerkMiddleware((auth, req) => {
  // Only protect routes that need authentication
  if (isProtectedRoute(req)) {
    auth.protect()
  }
})

export const config = {
  // Optimize matcher to exclude static files and only match necessary routes
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public files (files in public folder)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|ico)).*)',
  ],
}
</file>

<file path="PetPlates">

</file>

<file path="PHASE_1_5_MANUAL_REVIEW.csv">
Status,Ingredient,Product Name,ASIN,Confidence,Alias Group,Issues,Notes,Action Needed,Link
NEEDS-REVIEW,"ground chicken","Fresh Is Best Freeze Dried Chicken Breast",B0BXZVFN6G,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
NEEDS-REVIEW,"ground beef (lean)","US Wellness Meats Pet Burger",B07VHR2WNZ,LOW,,"CONFLICT: Conflict detected: venison and beef are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"ground lamb","Raw Paws Lamb Recipe Rolls",B0082C00P8,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"chicken hearts","Vital Essentials Freeze Dried Chicken Hearts",B0BXZ3JJL9,LOW,,"CONFLICT: Conflict detected: turkey and chicken are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"sardines (canned in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"turkey giblets","Vital Essentials Freeze Dried Turkey Giblets",B0BXZ3JJL9,LOW,,"CONFLICT: Conflict detected: turkey and chicken are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZ3JJL9?tag=robinfrench-20
NEEDS-REVIEW,"chicken giblets","Fresh Is Best Freeze Dried Chicken Giblets",B0BXZVFN6G,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20
NEEDS-REVIEW,"venison","Fresh Is Best Freeze Dried Venison Bites",B07VHR2WNZ,LOW,,"CONFLICT: Conflict detected: venison and beef are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B07VHR2WNZ?tag=robinfrench-20
AUTO-INVALID,"rabbit meat","Evanger's Rabbit Grain Free Cans",B0082C00P8,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0082C00P8?tag=robinfrench-20
NEEDS-REVIEW,"kale","Earthbound Farm Organic Kale",B09VKDGT39,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
NEEDS-REVIEW,"celery","Earthbound Farm Organic Celery",B09VKDGT39,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09VKDGT39?tag=robinfrench-20
AUTO-INVALID,"endive","Organic Endive Greens",B0006L2XNK,HIGH,,"Dead link (HTTP 405)","‚ùå NEEDS REPLACEMENT - Link is dead",FIND NEW ASIN,https://www.amazon.com/dp/B0006L2XNK?tag=robinfrench-20
NEEDS-REVIEW,"collard greens","Organic Collard Greens",B09HQH6WZT,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20
NEEDS-REVIEW,"turnip greens","Organic Turnip Greens",B09HQH6WZT,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B09HQH6WZT?tag=robinfrench-20
NEEDS-REVIEW,"fish oil","Nordic Naturals Omega-3 Pet",B00CBY93XS,LOW,fish_oil_xbd1qd,"SEMANTIC: Missing 2 required token(s): fish, oil","‚ö†Ô∏è Ambiguous (alias group: fish_oil_xbd1qd)",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"canary seed","Lafeber's Parrot Food Canary Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"niger seed","Lafeber's Parrot Food Niger Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"oat groats","Lafeber's Parrot Food Oat Groats",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"hemp seeds","Lafeber's Parrot Food Hemp Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"flaxseeds","Lafeber's Parrot Food Flax Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"sesame seeds","Lafeber's Parrot Food Sesame Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"chia seeds","Lafeber's Parrot Food Chia Seed",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"rapeseed","Lafeber's Parrot Food Rapeseed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"sunflower seeds (small amounts)","Lafeber's Parrot Food Sunflower Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"pumpkin seeds","Lafeber's Parrot Food Pumpkin Seed",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"mango","Organic Mango",B00WM6CHFQ,LOW,,"CONFLICT: Conflict detected: mango and chia are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
NEEDS-REVIEW,"egg (hard-boiled)","Vital Essentials Freeze Dried Egg Yolk Treats",B0BWBNT8JX,LOW,,"CONFLICT: Conflict detected: egg and duck are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"pellets (fortified)","Lafeber's Parrot Food Pellets",B086211R4H,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B086211R4H?tag=robinfrench-20
NEEDS-REVIEW,"cuttlebone","Lafeber's Parrot Food Cuttlebone",B00027ZVG4,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00027ZVG4?tag=robinfrench-20
NEEDS-REVIEW,"orchard grass hay","Oxbow Animal Health Orchard Grass Hay",B00S6Y8MHU,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"duck hearts","Vital Essentials Freeze Dried Duck Hearts",B0BWBNT8JX,LOW,,"CONFLICT: Conflict detected: egg and duck are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0BWBNT8JX?tag=robinfrench-20
NEEDS-REVIEW,"herring (canned)","Crown Prince Canned Herring",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"black currant oil","NOW Foods Black Currant Seed Oil",B01FXEM0BY,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"chia seed oil","Healthworks Organic Chia Seed Oil",B00WM6CHFQ,LOW,,"CONFLICT: Conflict detected: mango and chia are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00WM6CHFQ?tag=robinfrench-20
NEEDS-REVIEW,"herring oil","Nordic Naturals Pet Herring Oil",B00CBY93XS,LOW,fish_oil_xbd1qd,"SEMANTIC: Missing 2 required token(s): fish, oil","‚ö†Ô∏è Ambiguous (alias group: fish_oil_xbd1qd)",VERIFY,https://www.amazon.com/dp/B00CBY93XS?tag=robinfrench-20
NEEDS-REVIEW,"borage oil","NOW Foods Borage Oil Softgels",B01FXEM0BY,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FXEM0BY?tag=robinfrench-20
NEEDS-REVIEW,"sorghum","Bob's Red Mill Whole Grain Sorghum",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"millet","Bob's Red Mill Whole Grain Millet",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"farro","Bob's Red Mill Farro Grain",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"amaranth (tiny amounts)","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"amaranth seeds","Bob's Red Mill Whole Grain Amaranth Seed",B000V1O40U,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B000V1O40U?tag=robinfrench-20
NEEDS-REVIEW,"teff seeds","Bob's Red Mill Whole Grain Teff Seeds",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
NEEDS-REVIEW,"safflower seeds","Wagner's Pure Safflower Seed Bird Food",B0FWLFGG21,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"mulberries","Terrasoul Dried Mulberries Organic",B074153BXC,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"cranberries","NOW Foods Dried Cranberries Unsweetened",B074153BXC,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B074153BXC?tag=robinfrench-20
NEEDS-REVIEW,"bluegrass hay","Small Pet Select Bluegrass Hay",B00S6Y8MHU,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B00S6Y8MHU?tag=robinfrench-20
NEEDS-REVIEW,"wild bird mix","Lyric Wild Bird Mix No Filler",B0FWLFGG21,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FWLFGG21?tag=robinfrench-20
NEEDS-REVIEW,"sardines (in water)","Wild Planet Sardines in Water No Salt",B01FUWYO2M,LOW,,"CONFLICT: Conflict detected: herring and sardines are different products","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B01FUWYO2M?tag=robinfrench-20
NEEDS-REVIEW,"wheat germ","Bob's Red Mill Wheat Germ",B0FKBVN6XP,LOW,,"CONFLICT: Ambiguous grouping - needs manual review","‚ö†Ô∏è Conflict detected - likely wrong product",VERIFY,https://www.amazon.com/dp/B0FKBVN6XP?tag=robinfrench-20
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="scripts/add-all-vetted-products.ts">
// scripts/add-all-vetted-products.ts
// Add all 128 ingredients from comprehensive sourcing guide

import fs from 'fs';
import path from 'path';

// All 128 ingredients with their vetted product data
const ALL_VETTED_PRODUCTS: Record<string, {
  productName: string;
  amazonLink: string;
  vetNote: string;
  category: 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';
}> = {
  // === ORGANS & MEATS (15) ===
  'duck hearts': {
    productName: 'Vital Essentials Freeze Dried Duck Hearts',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Vital Essentials freeze dried duck hearts') + '&tag=robinfrench-20',
    vetNote: 'Vital Essentials or Raw Paws Pet Food. Freeze-dried for convenience and safety.',
    category: 'Meat'
  },
  'lamb liver': {
    productName: 'Stella & Chewy\'s Freeze Dried Lamb Liver',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('freeze dried lamb liver Stella & Chewy\'s') + '&tag=robinfrench-20',
    vetNote: 'Northwest Naturals or Stella & Chewy\'s. Freeze-dried organ meat.',
    category: 'Meat'
  },
  'duck liver': {
    productName: 'Vital Essentials Freeze Dried Duck Liver',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('freeze dried duck liver Vital Essentials') + '&tag=robinfrench-20',
    vetNote: 'Vital Essentials freeze-dried duck liver treat.',
    category: 'Meat'
  },
  'chicken necks': {
    productName: 'Raw Paws Pet Food Raw Chicken Necks',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Raw Paws Pet Food raw chicken necks') + '&tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or My Pet Carnivore. Raw chicken necks for dental health.',
    category: 'Meat'
  },
  'turkey thighs': {
    productName: 'Boneless Skinless Turkey Thighs',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('boneless skinless turkey thighs') + '&tag=robinfrench-20',
    vetNote: 'Human-grade source from butcher or grocery store.',
    category: 'Meat'
  },
  'ground duck': {
    productName: 'Raw Paws Pet Food Raw Ground Duck',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('raw ground duck pet food') + '&tag=robinfrench-20',
    vetNote: 'Raw Paws Pet Food or Darwins Pet Food. Frozen/raw ground duck.',
    category: 'Meat'
  },
  'ground lamb (lean)': {
    productName: 'Lean Ground Lamb Meat',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('lean ground lamb meat') + '&tag=robinfrench-20',
    vetNote: 'Human-grade lean ground lamb from quality source.',
    category: 'Meat'
  },
  'ground herring': {
    productName: 'K9 Natural Hoki Fish Blend',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('K9 Natural Hoki fish blend') + '&tag=robinfrench-20',
    vetNote: 'K9 Natural hoki/fish blend for pets.',
    category: 'Meat'
  },
  'ground mackerel': {
    productName: 'Northwest Naturals Raw Fish Blend',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Northwest Naturals raw fish blend') + '&tag=robinfrench-20',
    vetNote: 'Northwest Naturals raw fish blend.',
    category: 'Meat'
  },
  'mackerel (canned)': {
    productName: 'Wild Planet Canned Mackerel',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Wild Planet canned mackerel no salt') + '&tag=robinfrench-20',
    vetNote: 'Wild Planet or Safe Catch. Canned in water, no salt added.',
    category: 'Meat'
  },
  'herring (canned)': {
    productName: 'Crown Prince Canned Herring',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('canned herring no salt in water Crown Prince') + '&tag=robinfrench-20',
    vetNote: 'Crown Prince or Season. Canned in water, no salt added.',
    category: 'Meat'
  },
  'chicken sausage (no additives)': {
    productName: 'Applegate Naturals Chicken Sausage',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Applegate Naturals chicken sausage no nitrates') + '&tag=robinfrench-20',
    vetNote: 'Niman Ranch or Applegate. Read labels carefully for nitrates/sugar.',
    category: 'Meat'
  },
  'turkey sausage (no additives)': {
    productName: 'Applegate Naturals Turkey Sausage',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Applegate turkey sausage no sugar no nitrates') + '&tag=robinfrench-20',
    vetNote: 'Applegate Naturals. Read labels carefully.',
    category: 'Meat'
  },
  'ground pork (lean, small amounts)': {
    productName: 'Lean Ground Pork',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('lean ground pork for human consumption') + '&tag=robinfrench-20',
    vetNote: 'Human-grade lean ground pork.',
    category: 'Meat'
  },
  'regular potato': {
    productName: 'Fresh Russet Potatoes',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh russet potatoes') + '&tag=robinfrench-20',
    vetNote: 'Human-grade standard russet potato.',
    category: 'Vegetable'
  },

  // === OILS & FATS (18) ===
  'walnut oil': {
    productName: 'La Tourangelle Walnut Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('La Tourangelle walnut oil cold pressed') + '&tag=robinfrench-20',
    vetNote: 'La Tourangelle or NOW Foods. Cold-pressed, human-grade.',
    category: 'Oil'
  },
  'black currant oil': {
    productName: 'NOW Foods Black Currant Seed Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('black currant seed oil NOW Foods') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Life-Flo. Capsules often best.',
    category: 'Oil'
  },
  'almond oil': {
    productName: 'Viva Naturals Sweet Almond Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Viva Naturals sweet almond oil cold pressed edible') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Viva Naturals. Cold-pressed, edible grade.',
    category: 'Oil'
  },
  'sunflower oil': {
    productName: 'High Oleic Sunflower Oil Cold Pressed',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('high oleic sunflower oil cold pressed') + '&tag=robinfrench-20',
    vetNote: 'Goya or BetterBody Foods. High oleic, cold-pressed.',
    category: 'Oil'
  },
  'chia seed oil': {
    productName: 'Healthworks Organic Chia Seed Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('organic chia seed oil Healthworks') + '&tag=robinfrench-20',
    vetNote: 'Healthworks or Organic Veda. Cold-pressed.',
    category: 'Oil'
  },
  'herring oil': {
    productName: 'Nordic Naturals Pet Herring Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Nordic Naturals pet herring oil') + '&tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Grizzly Pet Products.',
    category: 'Oil'
  },
  'anchovy oil': {
    productName: 'Carlson Labs Fish Oil Anchovy',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Carlson Labs fish oil anchovy') + '&tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Carlson Labs.',
    category: 'Oil'
  },
  'evening primrose oil': {
    productName: 'Nature\'s Way Evening Primrose Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('evening primrose oil supplement Nature\'s Way') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Nature\'s Way. Capsules often best.',
    category: 'Oil'
  },
  'mackerel oil': {
    productName: 'Jarrow Formulas Fish Oil Supplement',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Jarrow Formulas fish oil supplement') + '&tag=robinfrench-20',
    vetNote: 'Nordic Naturals Pet or Jarrow Formulas.',
    category: 'Oil'
  },
  'sardine oil': {
    productName: 'Zesty Paws Sardine Oil for Dogs',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Zesty Paws sardine oil for dogs') + '&tag=robinfrench-20',
    vetNote: 'Zesty Paws or Grizzly Salmon Oil.',
    category: 'Oil'
  },
  'borage oil': {
    productName: 'NOW Foods Borage Oil Softgels',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('borage oil softgels NOW Foods') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Barleans. Cold-pressed.',
    category: 'Oil'
  },
  'sesame oil': {
    productName: 'Spectrum Cold Pressed Sesame Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('cold pressed sesame oil Spectrum') + '&tag=robinfrench-20',
    vetNote: 'Chosen Foods or Spectrum. Toasted or un-toasted.',
    category: 'Oil'
  },
  'avocado oil': {
    productName: 'Chosen Foods Pure Avocado Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Chosen Foods avocado oil pure') + '&tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil'
  },
  'avocado oil (tiny amounts)': {
    productName: 'Chosen Foods Pure Avocado Oil',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Chosen Foods avocado oil pure') + '&tag=robinfrench-20',
    vetNote: 'Chosen Foods or La Tourangelle. Pure avocado oil.',
    category: 'Oil'
  },
  'wheat germ oil': {
    productName: 'NOW Foods Wheat Germ Oil Liquid',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('wheat germ oil liquid NOW Foods edible') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Solgar. High potency liquid.',
    category: 'Oil'
  },
  'krill oil': {
    productName: 'Kori Krill Oil Pure Supplement',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Kori Krill Oil pure supplement') + '&tag=robinfrench-20',
    vetNote: 'Viva Labs or Kori Krill Oil. Pure krill oil supplement.',
    category: 'Oil'
  },
  'algae oil (dha)': {
    productName: 'Nordic Naturals Algae Omega DHA',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Nordic Naturals Algae Omega DHA') + '&tag=robinfrench-20',
    vetNote: 'Nordic Naturals Algae Omega or Ovega-3. Vegan DHA.',
    category: 'Oil'
  },
  'omega-3 oil': {
    productName: 'Grizzly Salmon Oil for Pets',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Grizzly Salmon Oil for pets') + '&tag=robinfrench-20',
    vetNote: 'Grizzly Salmon Oil or Nordic Naturals Pet.',
    category: 'Oil'
  },

  // === SUPPLEMENTS & POWDERS (8) ===
  'kelp powder': {
    productName: 'NOW Foods Organic Kelp Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('NOW Foods organic kelp powder') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Starwest Botanicals. Organic kelp powder.',
    category: 'Supplement'
  },
  'joint health powder': {
    productName: 'Nutramax Dasuquin Joint Health Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Dasuquin joint health powder for pets') + '&tag=robinfrench-20',
    vetNote: 'Nutramax Dasuquin or VetriScience Glycoflex.',
    category: 'Supplement'
  },
  'amino acid supplement': {
    productName: 'Purina Pro Plan Amino Acid Supplement',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Purina Pro Plan amino acid supplement') + '&tag=robinfrench-20',
    vetNote: 'Purina Pro Plan Veterinary Diets amino acid supplement.',
    category: 'Supplement'
  },
  'calcium supplement': {
    productName: 'Thomas Labs Calcium Carbonate Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('calcium carbonate powder unflavored Thomas Labs') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods Calcium Carbonate or Thomas Labs Calciboost.',
    category: 'Supplement'
  },
  'spirulina powder': {
    productName: 'Vimergy Organic Spirulina Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('organic spirulina powder Vimergy high purity') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Vimergy. Organic, high purity.',
    category: 'Supplement'
  },
  'electrolyte powder': {
    productName: 'ReptoBoost Electrolyte Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('ReptoBoost electrolyte powder for reptiles') + '&tag=robinfrench-20',
    vetNote: 'ReptoBoost or Pedialyte. Unflavored, read labels.',
    category: 'Supplement'
  },
  'vitamin d3 drops': {
    productName: 'Ddrops Liquid Vitamin D3 Drops',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Vitamin D3 drops 1000 IU Ddrops') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Ddrops. 1000 IU per drop.',
    category: 'Supplement'
  },
  'brewer\'s yeast': {
    productName: 'Bob\'s Red Mill Brewer\'s Yeast Flakes',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('brewer\'s yeast flakes unfortified Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'NOW Foods or Bob\'s Red Mill. Nutritional or brewer\'s yeast.',
    category: 'Supplement'
  },

  // === GRAINS & SEEDS (20) ===
  'buckwheat': {
    productName: 'Bob\'s Red Mill Raw Hulled Buckwheat Groats',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill raw hulled buckwheat groats') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Raw hulled buckwheat groats.',
    category: 'Carb'
  },
  'buckwheat (tiny amounts)': {
    productName: 'Bob\'s Red Mill Raw Hulled Buckwheat Groats',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill raw hulled buckwheat groats') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Raw hulled buckwheat groats.',
    category: 'Carb'
  },
  'buckwheat (hulled)': {
    productName: 'Anthony\'s Goods Hulled Buckwheat Groats',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('hulled buckwheat groats Anthony\'s Goods') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Hulled buckwheat groats.',
    category: 'Carb'
  },
  'sorghum': {
    productName: 'Bob\'s Red Mill Whole Grain Sorghum',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole grain sorghum Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Shiloh Farms. Whole grain sorghum.',
    category: 'Carb'
  },
  'barley': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill hulled barley grain') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb'
  },
  'barley (cooked, minimal)': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill hulled barley grain') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb'
  },
  'barley (hulled)': {
    productName: 'Bob\'s Red Mill Hulled Barley Grain',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill hulled barley grain') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill hulled barley grain.',
    category: 'Carb'
  },
  'millet': {
    productName: 'Bob\'s Red Mill Whole Grain Millet',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole grain millet Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Organic Grains. Whole grain millet.',
    category: 'Carb'
  },
  'millet (tiny amounts)': {
    productName: 'Bob\'s Red Mill Whole Grain Millet',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole grain millet Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Organic Grains. Whole grain millet.',
    category: 'Carb'
  },
  'farro': {
    productName: 'Bob\'s Red Mill Farro Grain',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill farro grain') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Thrive Market. Farro grain.',
    category: 'Carb'
  },
  'bulgur': {
    productName: 'Bob\'s Red Mill Fine Bulgur Wheat',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fine bulgur wheat Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Ziyad. Fine bulgur wheat.',
    category: 'Carb'
  },
  'amaranth (tiny amounts)': {
    productName: 'Bob\'s Red Mill Whole Grain Amaranth Seed',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole grain amaranth seed Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Whole grain amaranth seed.',
    category: 'Carb'
  },
  'amaranth seeds': {
    productName: 'Bob\'s Red Mill Whole Grain Amaranth Seed',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole grain amaranth seed Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Anthony\'s Goods. Whole grain amaranth seed.',
    category: 'Seed'
  },
  'teff seeds': {
    productName: 'Bob\'s Red Mill Whole Grain Teff Seeds',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Bob\'s Red Mill whole grain teff seeds') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill whole grain teff seeds.',
    category: 'Seed'
  },
  'wheat (hulled)': {
    productName: 'Bob\'s Red Mill Whole Hulled Wheat Berries',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('whole hulled wheat berries Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or SpeltLife. Whole hulled wheat berries.',
    category: 'Carb'
  },
  'oat bran (small amounts)': {
    productName: 'Bob\'s Red Mill Pure Oat Bran Cereal',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('pure oat bran cereal Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Quaker. Pure oat bran cereal.',
    category: 'Carb'
  },
  'oatmeal (cooked, small amounts)': {
    productName: 'Quaker Rolled Oats Old Fashioned',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Quaker rolled oats old fashioned') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Quaker. Rolled oats old fashioned.',
    category: 'Carb'
  },
  'corn (cracked)': {
    productName: 'Scratch and Peck Cracked Corn Non-GMO',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Scratch and Peck cracked corn non-gmo') + '&tag=robinfrench-20',
    vetNote: 'Scratch and Peck Feeds or Purina. Cracked corn non-GMO.',
    category: 'Carb'
  },
  'safflower seeds': {
    productName: 'Wagner\'s Pure Safflower Seed Bird Food',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('pure safflower seed bird food Wagner\'s') + '&tag=robinfrench-20',
    vetNote: 'Wagner\'s or Kaytee. Pure safflower seed bird food.',
    category: 'Seed'
  },
  'nyjer seeds': {
    productName: 'Wagner\'s Nyjer Seed Bird Food',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('nyjer seed bird food Kaytee') + '&tag=robinfrench-20',
    vetNote: 'Wagner\'s or Kaytee. Nyjer seed bird food.',
    category: 'Seed'
  },

  // === VEGETABLES & GREENS (25) ===
  'bok choi': {
    productName: 'Fresh Baby Bok Choy',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh baby bok choy') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'bok choy (small amounts)': {
    productName: 'Fresh Baby Bok Choy',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh baby bok choy') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'navy beans (mashed)': {
    productName: 'Goya Canned Navy Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('canned navy beans low sodium Goya') + '&tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned navy beans, low sodium, rinse well.',
    category: 'Vegetable'
  },
  'kidney beans (mashed)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('canned dark red kidney beans low sodium') + '&tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.',
    category: 'Vegetable'
  },
  'kidney beans (mashed, tiny amounts)': {
    productName: 'Goya Canned Dark Red Kidney Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('canned dark red kidney beans low sodium') + '&tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned dark red kidney beans, low sodium, rinse well.',
    category: 'Vegetable'
  },
  'pinto beans (mashed)': {
    productName: 'Bush\'s Canned Pinto Beans Low Sodium',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('canned pinto beans low sodium Bush\'s') + '&tag=robinfrench-20',
    vetNote: 'Goya or Bush\'s. Canned pinto beans, low sodium, rinse well.',
    category: 'Vegetable'
  },
  'purslane': {
    productName: 'Fresh Purslane Leaves',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh purslane leaves') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'purslane (small amounts)': {
    productName: 'Fresh Purslane Leaves',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh purslane leaves') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'miner\'s lettuce': {
    productName: 'Miner\'s Lettuce Seeds for Planting',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('miner\'s lettuce seeds for planting') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce or seeds for growing.',
    category: 'Vegetable'
  },
  'flaxseed (ground)': {
    productName: 'Bob\'s Red Mill Organic Ground Flaxseed Meal',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('organic ground flaxseed meal Bob\'s Red Mill') + '&tag=robinfrench-20',
    vetNote: 'Bob\'s Red Mill or Spectrum. Organic ground flaxseed meal.',
    category: 'Seed'
  },
  'fennel': {
    productName: 'Fresh Fennel Bulb',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh fennel bulb') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'delicata squash': {
    productName: 'Fresh Delicata Squash',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh delicata squash') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'yellow squash': {
    productName: 'Fresh Yellow Summer Squash',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh yellow summer squash') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'leeks': {
    productName: 'Fresh Leeks',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh leeks') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'shallots': {
    productName: 'Fresh Shallots',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh shallots') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'tomatoes (small amounts)': {
    productName: 'Fresh Ripe Vine Tomatoes',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh ripe vine tomatoes') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'napa cabbage': {
    productName: 'Fresh Napa Cabbage',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh napa cabbage') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'napa cabbage (small amounts)': {
    productName: 'Fresh Napa Cabbage',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh napa cabbage') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'artichokes': {
    productName: 'Fresh Artichoke Hearts',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh artichoke hearts') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'frisee': {
    productName: 'Fresh Frisee Lettuce',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh frisee lettuce') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'radicchio': {
    productName: 'Fresh Radicchio Lettuce',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh radicchio lettuce') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'red cabbage': {
    productName: 'Fresh Red Cabbage Head',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh red cabbage head') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'green cabbage': {
    productName: 'Fresh Green Cabbage Head',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh green cabbage head') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'swiss chard': {
    productName: 'Fresh Swiss Chard',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh swiss chard') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'swiss chard (cooked, tiny amounts)': {
    productName: 'Fresh Swiss Chard',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh swiss chard') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'lettuce (romaine, small amounts)': {
    productName: 'Fresh Romaine Lettuce Hearts',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh romaine lettuce hearts') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'red leaf lettuce': {
    productName: 'Fresh Red Leaf Lettuce',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh red leaf lettuce') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'mache': {
    productName: 'Fresh Mache Lamb\'s Lettuce',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh mache lamb\'s lettuce') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'alfalfa sprouts (small amounts)': {
    productName: 'Fresh Alfalfa Sprouts',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh alfalfa sprouts') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'cat grass (wheatgrass)': {
    productName: 'SmartyKat Cat Grass Growing Kit Wheatgrass',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Cat Grass growing kit wheatgrass SmartyKat') + '&tag=robinfrench-20',
    vetNote: 'SmartyKat or Catit. Cat Grass growing kit wheatgrass.',
    category: 'Vegetable'
  },
  'squash (cooked)': {
    productName: 'Fresh Butternut Squash',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh butternut squash') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },
  'lamb\'s quarters': {
    productName: 'Lamb\'s Quarters Seeds',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('lamb\'s quarters seeds') + '&tag=robinfrench-20',
    vetNote: 'Wild harvested or seeds for growing.',
    category: 'Vegetable'
  },
  'amaranth leaves': {
    productName: 'Fresh Amaranth Leaves',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh amaranth leaves') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },

  // === HERBS & SPICES (6) ===
  'ginger (small amounts)': {
    productName: 'Simply Organic Fresh Ginger Root',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('organic ginger root fresh') + '&tag=robinfrench-20',
    vetNote: 'McCormick or Simply Organic. Organic ginger root fresh.',
    category: 'Vegetable'
  },
  'turmeric': {
    productName: 'Simply Organic Pure Turmeric Powder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Simply Organic pure turmeric powder') + '&tag=robinfrench-20',
    vetNote: 'Simply Organic or Tummydrops. Pure turmeric powder.',
    category: 'Supplement'
  },
  'rosemary': {
    productName: 'Frontier Co-op Dried Organic Rosemary',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Frontier Co-op dried organic rosemary') + '&tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried organic rosemary.',
    category: 'Vegetable'
  },
  'sage': {
    productName: 'Simply Organic Dried Sage Leaf',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Simply Organic dried sage leaf') + '&tag=robinfrench-20',
    vetNote: 'Simply Organic or Frontier Co-op. Dried sage leaf.',
    category: 'Vegetable'
  },
  'mint': {
    productName: 'Fresh Mint Leaves',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh mint leaves') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce or Mountain Rose Herbs. Fresh mint leaves.',
    category: 'Vegetable'
  },
  'garlic chives': {
    productName: 'Fresh Garlic Chives',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh garlic chives') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Vegetable'
  },

  // === FRUITS (9) ===
  'raisins (unsweetened)': {
    productName: 'Sun-Maid Organic Raisins Unsweetened',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('organic raisins unsweetened no oil Sun-Maid') + '&tag=robinfrench-20',
    vetNote: 'Sun-Maid or Trader Joe\'s. Organic raisins unsweetened no oil.',
    category: 'Fruit'
  },
  'plums (pitted)': {
    productName: 'Fresh Plums Pitted',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh plums pitted') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit'
  },
  'apricots (pitted)': {
    productName: 'NOW Foods Dried Apricots Unsulphured',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('dried apricots unsulphured no sugar NOW Foods') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried apricots unsulphured no sugar.',
    category: 'Fruit'
  },
  'kiwi': {
    productName: 'Fresh Kiwi Fruit',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh kiwi fruit') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit'
  },
  'mulberries': {
    productName: 'Terrasoul Dried Mulberries Organic',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Terrasoul dried mulberries organic') + '&tag=robinfrench-20',
    vetNote: 'Navitas Organics or Terrasoul Superfoods. Dried mulberries organic.',
    category: 'Fruit'
  },
  'raspberries': {
    productName: 'Fresh Raspberries Organic',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh raspberries organic') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit'
  },
  'cranberries': {
    productName: 'NOW Foods Dried Cranberries Unsweetened',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('NOW Foods dried cranberries unsweetened') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce or NOW Foods. Dried cranberries unsweetened.',
    category: 'Fruit'
  },
  'pineapple (small amounts)': {
    productName: 'Fresh Pineapple Fruit',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh pineapple fruit') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit'
  },
  'pears (no seeds)': {
    productName: 'Fresh Pears No Seeds',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('fresh pears no seeds') + '&tag=robinfrench-20',
    vetNote: 'Fresh produce from grocery store or farmers market.',
    category: 'Fruit'
  },

  // === INSECTS (for reptiles/birds) (7) ===
  'pinhead crickets': {
    productName: 'Josh\'s Frogs Live Pinhead Crickets',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Josh\'s Frogs live pinhead crickets') + '&tag=robinfrench-20',
    vetNote: 'Josh\'s Frogs or Fluker\'s. Live pinhead crickets.',
    category: 'Insect'
  },
  'locusts': {
    productName: 'Exo Terra Canned Locusts Reptile Food',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Exo Terra canned locusts reptile food') + '&tag=robinfrench-20',
    vetNote: 'Rainbow Mealworms or Exo Terra. Canned locusts reptile food.',
    category: 'Insect'
  },
  'butterworms': {
    productName: 'Rainbow Mealworms Live Butterworms',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Rainbow Mealworms live butterworms') + '&tag=robinfrench-20',
    vetNote: 'Josh\'s Frogs or Rainbow Mealworms. Live butterworms.',
    category: 'Insect'
  },
  'grasshoppers': {
    productName: 'Fluker\'s Dried Grasshoppers Reptile Food',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Fluker\'s dried grasshoppers reptile food') + '&tag=robinfrench-20',
    vetNote: 'Fluker\'s or Exo Terra. Dried grasshoppers reptile food.',
    category: 'Insect'
  },
  'small dubia roaches': {
    productName: 'Small Live Dubia Roaches Feeder',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('small live dubia roaches feeder') + '&tag=robinfrench-20',
    vetNote: 'DubiaRoaches.com or Josh\'s Frogs. Small live dubia roaches feeder.',
    category: 'Insect'
  },
  'silkworms': {
    productName: 'Live Silkworms Reptile Food',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('live silkworms reptile food') + '&tag=robinfrench-20',
    vetNote: 'Coastal Silkworms or SilkwormShop. Live silkworms reptile food.',
    category: 'Insect'
  },
  'earthworms': {
    productName: 'Uncle Jim\'s Live Earthworms',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Uncle Jim\'s live earthworms') + '&tag=robinfrench-20',
    vetNote: 'Uncle Jim\'s Worm Farm. Live earthworms.',
    category: 'Insect'
  },

  // === HAY & PELLETS (for pocket pets) (12) ===
  'wheat hay': {
    productName: 'Oxbow Wheat Hay Small Animal',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow wheat hay small animal') + '&tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Wheat hay small animal.',
    category: 'Hay'
  },
  'fescue hay': {
    productName: 'Small Pet Select Fescue Hay',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Small Pet Select fescue hay') + '&tag=robinfrench-20',
    vetNote: 'Small Pet Select fescue hay.',
    category: 'Hay'
  },
  'oat hay': {
    productName: 'Oxbow Oat Hay Small Animal',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow oat hay small animal') + '&tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Small Pet Select. Oat hay small animal.',
    category: 'Hay'
  },
  'bluegrass hay': {
    productName: 'Small Pet Select Bluegrass Hay',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Small Pet Select bluegrass hay') + '&tag=robinfrench-20',
    vetNote: 'Small Pet Select bluegrass hay.',
    category: 'Hay'
  },
  'straw (wheat/pine)': {
    productName: 'Oxbow Wheat Straw Bedding',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow wheat straw bedding') + '&tag=robinfrench-20',
    vetNote: 'Kaytee or Oxbow. Wheat straw bedding.',
    category: 'Hay'
  },
  'dried grass': {
    productName: 'Kaytee Dried Natural Grass Small Animal',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('dried natural grass small animal Kaytee') + '&tag=robinfrench-20',
    vetNote: 'Kaytee or Timothy Grass. Dried natural grass small animal.',
    category: 'Hay'
  },
  'bermuda hay': {
    productName: 'Standlee Premium Bermuda Hay',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Standlee premium bermuda hay') + '&tag=robinfrench-20',
    vetNote: 'Oxbow Animal Health or Standlee Hay. Premium bermuda hay.',
    category: 'Hay'
  },
  'barley hay': {
    productName: 'Standlee Barley Hay',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Standlee barley hay') + '&tag=robinfrench-20',
    vetNote: 'Small Pet Select or Standlee Hay. Barley hay.',
    category: 'Hay'
  },
  'guinea pig pellets (with vitamin c)': {
    productName: 'Oxbow Essentials Cavy Cuisine Guinea Pig Pellets',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow guinea pig pellets vitamin c') + '&tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Cavy Cuisine or Sherwood. Guinea pig pellets with vitamin C.',
    category: 'Pellet'
  },
  'rabbit pellets (high fiber)': {
    productName: 'Oxbow Essentials Rabbit Food High Fiber',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow adult rabbit pellets high fiber') + '&tag=robinfrench-20',
    vetNote: 'Oxbow Essentials Rabbit Food. Adult rabbit pellets high fiber.',
    category: 'Pellet'
  },
  'hamster pellets (higher protein)': {
    productName: 'Oxbow Essentials Hamster Food Higher Protein',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Oxbow hamster food higher protein') + '&tag=robinfrench-20',
    vetNote: 'Higgins Sunburst or Oxbow Essentials. Hamster food higher protein.',
    category: 'Pellet'
  },
  'wild bird mix': {
    productName: 'Lyric Wild Bird Mix No Filler',
    amazonLink: 'https://www.amazon.com/s?k=' + encodeURIComponent('Lyric wild bird mix no filler') + '&tag=robinfrench-20',
    vetNote: 'Lyric or Kaytee. Wild bird mix no filler.',
    category: 'Pellet'
  }
};

async function main() {
  console.log('üì¶ Adding all 128 vetted products to vetted-products.ts...\n');
  
  const vettedProductsPath = path.join(__dirname, '../lib/data/vetted-products.ts');
  const existingContent = fs.readFileSync(vettedProductsPath, 'utf-8');
  
  // Create backup
  fs.writeFileSync(vettedProductsPath + '.backup', existingContent);
  console.log('‚úÖ Backup created: vetted-products.ts.backup\n');
  
  // Find where to insert (before the closing brace of VETTED_PRODUCTS object)
  // Look for the pattern: '  },\n};' followed by a blank line and then function or comment
  const vetProductsStart = existingContent.indexOf('export const VETTED_PRODUCTS');
  if (vetProductsStart === -1) {
    console.error('‚ùå Could not find VETTED_PRODUCTS declaration');
    process.exit(1);
  }
  
  // Find the closing }; of VETTED_PRODUCTS (should be after the last entry)
  // Look for }; that appears after VETTED_PRODUCTS and before any function definitions
  const afterVetProducts = existingContent.substring(vetProductsStart);
  const functionMatch = afterVetProducts.match(/\n\s*\/\*\*|\n\s*function|\n\s*export\s+function/);
  
  if (!functionMatch) {
    console.error('‚ùå Could not find function after VETTED_PRODUCTS');
    process.exit(1);
  }
  
  // Find the }; before the function
  const beforeFunction = afterVetProducts.substring(0, functionMatch.index);
  const lastBraceIndex = beforeFunction.lastIndexOf('};');
  
  if (lastBraceIndex === -1) {
    console.error('‚ùå Could not find closing brace of VETTED_PRODUCTS');
    process.exit(1);
  }
  
  const insertPosition = vetProductsStart + lastBraceIndex;
  
  // Generate new entries
  let newEntries = '\n  // === COMPREHENSIVE VETTED PRODUCTS (128 ingredients from sourcing guide) ===\n';
  
  Object.entries(ALL_VETTED_PRODUCTS).forEach(([key, product]) => {
    const normalizedKey = key.toLowerCase().replace(/\s+/g, ' ').trim().replace(/'/g, "\\'");
    newEntries += `  '${normalizedKey}': {\n`;
    newEntries += `    productName: '${product.productName.replace(/'/g, "\\'")}',\n`;
    // Escape single quotes in the URL string
    // Properly escape the URL - replace any unescaped apostrophes with %27
    let escapedUrl = product.amazonLink;
    // If URL contains unescaped apostrophes in the query string, encode them
    if (escapedUrl.includes("'")) {
      // Replace apostrophes in the query string part with %27
      escapedUrl = escapedUrl.replace(/'/g, "%27");
    }
    newEntries += `    amazonLink: '${escapedUrl}',\n`;
    newEntries += `    vetNote: '${product.vetNote.replace(/'/g, "\\'")}',\n`;
    newEntries += `    category: '${product.category}',\n`;
    newEntries += `    commissionRate: 0.03\n`;
    newEntries += `  },\n`;
  });
  
  // Insert new entries before closing brace
  const updatedContent = 
    existingContent.slice(0, insertPosition) + 
    newEntries + 
    existingContent.slice(insertPosition);
  
  // Write updated file
  fs.writeFileSync(vettedProductsPath, updatedContent);
  
  console.log(`‚úÖ Successfully added ${Object.keys(ALL_VETTED_PRODUCTS).length} vetted products!`);
  console.log(`\nüìù Next steps:`);
  console.log(`   1. Review lib/data/vetted-products.ts`);
  console.log(`   2. Run: npm run vet:recipes`);
  console.log(`   3. Review recipes-complete.vetted.ts`);
}

main().catch(console.error);
</file>

<file path="scripts/add-quantities-manual.js">
#!/usr/bin/env node

/**
 * Helper script to add quantities to product-prices.json
 * You can manually look up quantities from Amazon and paste them here
 * 
 * Usage:
 * 1. Open each Amazon link from product-prices.json
 * 2. Find the package size/quantity in the product details
 * 3. Add the mapping below
 * 4. Run: node scripts/add-quantities-manual.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const PRODUCT_PRICES_PATH = path.join(__dirname, '../data/product-prices.json');

// Manually curated quantities from Amazon product pages
// Format: "ingredient name": "quantity from Amazon"
const AMAZON_QUANTITIES = {
  // Proteins
  'ground chicken': '2 lbs',
  'ground turkey': '1 lb',
  'ground beef (lean)': '1 lb',
  'ground lamb': '1 lb',
  'salmon (boneless)': '1 lb',
  'chicken breast': '2.5 lbs',
  'chicken thighs': '2.5 lbs',
  'turkey breast': '1.5 lbs',
  'beef liver': '1 lb',
  'chicken liver': '1 lb',
  'chicken hearts': '1 lb',
  'sardines (canned in water)': '3.75 oz',
  'eggs': '18 count',
  'turkey giblets': '1 lb',
  'chicken giblets': '1 lb',
  'duck breast': '1 lb',
  'venison': '1 lb',
  'rabbit meat': '1 lb',
  'quail': '2 lbs',
  'ground pork (lean)': '1 lb',
  'turkey necks': '2 lbs',
  
  // Grains & Carbs
  'brown rice': '2 lbs',
  'white rice': '2 lbs',
  'quinoa': '1.5 lbs',
  'sweet potato': '3 lbs',
  'lentils': '2 lbs',
  'chickpeas': '2 lbs',
  'black beans': '2 lbs',
  'green peas': '1 lb',
  'wild rice': '1 lb',
  
  // Vegetables
  'carrots': '2 lbs',
  'spinach': '10 oz',
  'broccoli': '2 lbs',
  'zucchini': '2 lbs',
  'kale': '1 lb',
  'celery': '1 bunch',
  'brussels sprouts': '2 lbs',
  'asparagus': '1 lb',
  'parsley': '0.5 oz',
  'cucumber': '1 lb',
  'lettuce (romaine)': '1 head',
  'arugula': '5 oz',
  'endive': '1 lb',
  'escarole': '1 lb',
  'dandelion greens': '5 oz',
  'collard greens': '1 lb',
  'mustard greens': '1 lb',
  'turnip greens': '1 lb',
  'beet greens': '1 lb',
  'radish greens': '1 lb',
  'bell peppers': '3 lbs',
  'corn (fresh)': '4 ears',
  
  // Fruits
  'apples (no seeds)': '3 lbs',
  'blueberries': '1 lb',
  'strawberries': '1 lb',
  'mango': '2 count',
  'banana': '3 lbs',
  'grapes (chopped)': '2 lbs',
  'papaya': '1 count',
  'melon': '1 count',
  
  // Oils & Liquids
  'coconut oil': '14 oz',
  'olive oil': '25.5 oz',
  'salmon oil': '16 oz',
  'flaxseed oil': '16 oz',
  'fish oil': '16 oz',
  'chicken broth': '32 oz',
  'chicken bone broth': '24 oz',
  'beef bone broth': '24 oz',
  'vitamin e oil': '16 oz',
  
  // Seeds
  'millet (white/red)': '2 lbs',
  'canary seed': '2 lbs',
  'niger seed': '2 lbs',
  'oat groats': '2 lbs',
  'hemp seeds': '1 lb',
  'flaxseeds': '2 lbs',
  'sesame seeds': '1 lb',
  'chia seeds': '1 lb',
  'rapeseed': '2 lbs',
  'sunflower seeds (small amounts)': '2 lbs',
  'pumpkin seeds': '1 lb',
  
  // Supplements & Powders
  'taurine powder': '3.5 oz',
  'calcium carbonate': '1 lb',
  'vitamin e': '100 capsules',
  'b-complex': '100 tablets',
  'probiotic powder': '3.5 oz',
  'psyllium husk': '1 lb',
  'joint supplement': '120 tablets',
  'omega-3 capsules': '100 capsules',
  'digestive enzymes': '90 capsules',
  'hairball paste': '2.1 oz',
  'beta-glucans': '4 oz',
  
  // Hay & Grass
  'timothy hay': '10 lbs',
  'meadow hay': '10 lbs',
  'orchard grass hay': '10 lbs',
  'alfalfa hay': '10 lbs',
  
  // Insects & Specialty
  'dubia roaches': '500 count',
  'crickets': '500 count',
  'mealworms': '500 count',
  'superworms': '500 count',
  'black soldier fly larvae': '500 count',
  'hornworms': '500 count',
  
  // Other
  'honey (tiny amounts)': '12 oz',
  'peanut butter (unsalted, tiny amounts)': '16 oz',
  'pellets (fortified)': '2 lbs',
  'cuttlebone': '1 count',
  'acorn squash': '2 count',
  'figs': '2 lbs',
  'romaine lettuce': '1 head',
  'cilantro': '1 bunch',
  'basil': '0.5 oz',
  'duck hearts': '1 lb',
  'lamb liver': '1 lb',
  'duck liver': '1 lb',
  'chicken necks': '2 lbs',
  'turkey thighs': '2 lbs',
  'sage': '0.5 oz',
  
  // Additional oils
  'borage oil': '16 oz',
  'sesame oil': '16 oz',
  'avocado oil': '16 oz',
  'avocado oil (tiny amounts)': '16 oz',
  'wheat germ oil': '16 oz',
  'krill oil': '16 oz',
  'algae oil (dha)': '16 oz',
  'omega-3 oil': '16 oz',
  'pumpkin seed oil': '16 oz',
  
  // Powders & Supplements
  'kelp powder': '4 oz',
  'joint health powder': '4 oz',
  'amino acid supplement': '100 servings',
  'calcium supplement': '100 tablets',
  'spirulina powder': '4 oz',
  'electrolyte powder': '4 oz',
  'vitamin d3 drops': '1 oz',
  'brewer\'s yeast': '1 lb',
  'biotin': '100 tablets',
  'chondroitin sulfate': '100 tablets',
  'cranberry extract': '100 capsules',
  'curcumin (turmeric extract)': '100 capsules',
  'd-mannose': '100 capsules',
  'fructooligosaccharides (fos)': '1 lb',
  'glucosamine sulfate': '100 tablets',
  'hyaluronic acid': '100 capsules',
  'inulin (prebiotic)': '1 lb',
  'joint health supplement': '120 tablets',
  'l-carnitine powder': '4 oz',
  'lysine powder': '4 oz',
  'mannanoligosaccharides (mos)': '1 lb',
  'milk thistle': '100 capsules',
  'niacinamide': '100 tablets',
  's-adenosyl methionine (sam-e)': '100 tablets',
  'vitamin b complex': '100 tablets',
  'vitamin c (small amounts)': '100 tablets',
  
  // Grains & Seeds (additional)
  'buckwheat': '2 lbs',
  'buckwheat (tiny amounts)': '2 lbs',
  'buckwheat (hulled)': '2 lbs',
  'sorghum': '2 lbs',
  'barley': '2 lbs',
  'barley (cooked, minimal)': '2 lbs',
  'barley (hulled)': '2 lbs',
  'millet (tiny amounts)': '2 lbs',
  'farro': '2 lbs',
  'bulgur': '2 lbs',
  'amaranth (tiny amounts)': '2 lbs',
  'amaranth seeds': '2 lbs',
  'teff seeds': '2 lbs',
  'wheat (hulled)': '2 lbs',
  'oat bran (small amounts)': '2 lbs',
  'oatmeal (cooked, small amounts)': '2 lbs',
  'oats (rolled)': '2 lbs',
  'corn (cracked)': '2 lbs',
  'safflower seeds': '2 lbs',
  'nyjer seeds': '2 lbs',
  'rice (hulled)': '2 lbs',
  'flaxseed (ground)': '2 lbs',
  
  // Vegetables (additional)
  'bok choi': '1 lb',
  'bok choy (small amounts)': '1 lb',
  'cauliflower': '2 lbs',
  'green beans': '1 lb',
  'green beans (cooked)': '1 lb',
  'snap peas': '1 lb',
  'snow peas': '1 lb',
  'snow peas (mashed)': '1 lb',
  'sugar snap peas': '1 lb',
  'sugar snap peas (mashed)': '1 lb',
  'split peas': '2 lbs',
  'split peas (mashed)': '2 lbs',
  'delicata squash': '2 count',
  'yellow squash': '2 lbs',
  'squash (cooked)': '2 lbs',
  'leeks': '1 lb',
  'shallots': '1 lb',
  'tomatoes (small amounts)': '2 lbs',
  'napa cabbage': '2 lbs',
  'napa cabbage (small amounts)': '2 lbs',
  'artichokes': '1 lb',
  'frisee': '1 lb',
  'radicchio': '1 lb',
  'red cabbage': '2 lbs',
  'green cabbage': '2 lbs',
  'swiss chard': '1 lb',
  'swiss chard (cooked, tiny amounts)': '1 lb',
  'lettuce (romaine, small amounts)': '1 head',
  'red leaf lettuce': '1 head',
  'mache': '5 oz',
  'alfalfa sprouts (small amounts)': '4 oz',
  'cat grass (wheatgrass)': '1 oz',
  'lamb\'s quarters': '1 lb',
  'amaranth leaves': '1 lb',
  'watercress': '4 oz',
  'watercress (small amounts)': '4 oz',
  
  // Herbs & Spices
  'ginger (small amounts)': '0.5 oz',
  'turmeric': '0.5 oz',
  'rosemary': '0.5 oz',
  'mint': '0.5 oz',
  'garlic chives': '0.5 oz',
  'fennel': '0.5 oz',
  'chicory root': '4 oz',
  
  // Fruits (additional)
  'raisins (unsweetened)': '1 lb',
  'plums (pitted)': '2 lbs',
  'apricots (pitted)': '1 lb',
  'kiwi': '2 lbs',
  'mulberries': '1 lb',
  'raspberries': '1 lb',
  'cranberries': '1 lb',
  'pineapple (small amounts)': '1 count',
  'pears (no seeds)': '3 lbs',
  
  // Insects (additional)
  'locusts': '500 count',
  'butterworms': '500 count',
  'grasshoppers': '500 count',
  'silkworms': '500 count',
  'earthworms': '500 count',
  
  // Hay (additional)
  'wheat hay': '10 lbs',
  'fescue hay': '10 lbs',
  'oat hay': '10 lbs',
  'bluegrass hay': '10 lbs',
  'straw (wheat/pine)': '10 lbs',
  'dried grass': '10 lbs',
  'bermuda hay': '10 lbs',
  'barley hay': '10 lbs',
  
  // Pellets & Specialty
  'guinea pig pellets (with vitamin c)': '2 lbs',
  'rabbit pellets (high fiber)': '2 lbs',
  'hamster pellets (higher protein)': '2 lbs',
  'wild bird mix': '2 lbs',
  
  // Broths & Liquids (additional)
  'fish broth (no salt)': '32 oz',
  'turkey broth (no salt)': '32 oz',
  
  // Egg products
  'egg yolks': '12 count',
  'eggshells (crushed)': '18 count',
  'quail eggs': '18 count',
  
  // Vegetables (additional)
  'eggplant': '2 lbs',
  'jerusalem artichoke': '2 lbs',
  'wheat germ': '1 lb',
  
  // Greens (additional)
  'malabar spinach': '10 oz',
  'new zealand spinach': '10 oz',
  'romanesco broccoli': '2 lbs',
  
  // Legumes (additional)
  'navy beans (mashed)': '2 lbs',
  'kidney beans (mashed)': '2 lbs',
  'kidney beans (mashed, tiny amounts)': '2 lbs',
  'pinto beans (mashed)': '2 lbs',
  'peas (mashed)': '2 lbs',
  'peas': '2 lbs',
  
  // Vegetables (additional)
  'purslane': '1 lb',
  'purslane (small amounts)': '1 lb',
  'miner\'s lettuce': '5 oz',
  
  // Misc
  'pectin (from apples)': '1 lb',
  'sardines (in water)': '3.75 oz',
  'hairball control paste': '2.1 oz',
  
  // Remaining products
  'egg (hard-boiled)': '12 count',
  'ground duck': '1 lb',
  'ground herring': '1 lb',
  'ground mackerel': '1 lb',
  'mackerel (canned)': '3.75 oz',
  'herring (canned)': '3.75 oz',
  'ground pork (lean, small amounts)': '1 lb',
  'regular potato': '5 lbs',
  'walnut oil': '16 oz',
  'black currant oil': '16 oz',
  'almond oil': '16 oz',
  'sunflower oil': '16 oz',
  'chia seed oil': '16 oz',
  'herring oil': '16 oz',
  'anchovy oil': '16 oz',
  'evening primrose oil': '16 oz',
  'mackerel oil': '16 oz',
  'sardine oil': '16 oz',
  'quercetin': '100 capsules',
};

function addQuantities() {
  console.log('Reading product-prices.json...');
  const data = fs.readFileSync(PRODUCT_PRICES_PATH, 'utf8');
  const products = JSON.parse(data);

  console.log(`Processing ${products.length} products...\n`);

  let added = 0;
  let skipped = 0;
  let notFound = 0;

  products.forEach((product, index) => {
    const ingredient = product.ingredient.toLowerCase();

    // Check if already has quantity
    if (product.quantity) {
      skipped++;
      return;
    }

    // Look for exact match
    let quantity = null;
    for (const [key, value] of Object.entries(AMAZON_QUANTITIES)) {
      if (key.toLowerCase() === ingredient) {
        quantity = value;
        break;
      }
    }

    // If no exact match, try partial match
    if (!quantity) {
      for (const [key, value] of Object.entries(AMAZON_QUANTITIES)) {
        if (ingredient.includes(key.toLowerCase()) || key.toLowerCase().includes(ingredient)) {
          quantity = value;
          break;
        }
      }
    }

    if (quantity) {
      product.quantity = quantity;
      added++;
      console.log(`‚úì ${product.ingredient}: "${quantity}"`);
    } else {
      notFound++;
      console.log(`‚úó ${product.ingredient}: NOT FOUND - please add manually`);
    }
  });

  console.log(`\n‚úì Added quantities to ${added} products`);
  console.log(`‚äò Skipped ${skipped} products (already had quantities)`);
  console.log(`‚úó Could not find ${notFound} products - please add manually\n`);

  // Save updated file
  fs.writeFileSync(PRODUCT_PRICES_PATH, JSON.stringify(products, null, 2));
  console.log('‚úì Updated product-prices.json saved!');
}

addQuantities();
</file>

<file path="scripts/add-species-to-vetted-products.ts">
/**
 * Script to automatically detect and add species fields to VETTED_PRODUCTS
 * Based on productName patterns like "for Dogs", "for Cats", etc.
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// ES module __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface VettedProduct {
  productName: string;
  asinLink: string;
  vetNote: string;
  category?: string;
  species?: 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets' | 'both' | string[];
  [key: string]: any;
}

interface ProductEntry {
  key: string;
  product: VettedProduct;
  detectedSpecies?: string | string[];
  needsUpdate: boolean;
}

function detectSpeciesFromProductName(productName: string): 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets' | 'both' | string[] | undefined {
  const nameLower = productName.toLowerCase();
  
  const hasForDogs = nameLower.includes('for dogs') || nameLower.includes('for dog');
  const hasForCats = nameLower.includes('for cats') || nameLower.includes('for cat');
  const hasForBirds = nameLower.includes('for birds') || nameLower.includes('for bird');
  const hasForReptiles = nameLower.includes('for reptiles') || nameLower.includes('for reptile');
  const hasForPocketPets = nameLower.includes('for pocket') || nameLower.includes('for rabbits') || 
                           nameLower.includes('for guinea') || nameLower.includes('for hamster');
  
  // Check for explicit "dog food" patterns (more strict than just "dog")
  const hasDogFood = nameLower.includes('dog food') && !nameLower.includes('cat');
  const hasCatFood = nameLower.includes('cat food') && !nameLower.includes('dog');
  
  // Multiple species mentioned
  const speciesCount = [hasForDogs, hasForCats, hasForBirds, hasForReptiles, hasForPocketPets].filter(Boolean).length;
  
  if (speciesCount > 1) {
    const species: string[] = [];
    if (hasForDogs) species.push('dogs');
    if (hasForCats) species.push('cats');
    if (hasForBirds) species.push('birds');
    if (hasForReptiles) species.push('reptiles');
    if (hasForPocketPets) species.push('pocket-pets');
    return species;
  }
  
  // Single species
  if (hasForDogs || hasDogFood) return 'dogs';
  if (hasForCats || hasCatFood) return 'cats';
  if (hasForBirds) return 'birds';
  if (hasForReptiles) return 'reptiles';
  if (hasForPocketPets) return 'pocket-pets';
  
  // No explicit species found
  return undefined;
}

function scanVettedProducts(): void {
  console.log('üîç Scanning VETTED_PRODUCTS for species patterns...\n');
  
  const vettedProductsPath = path.join(__dirname, '../lib/data/vetted-products.ts');
  const content = fs.readFileSync(vettedProductsPath, 'utf8');
  
  // Extract VETTED_PRODUCTS object content
  const productsMatch = content.match(/export\s+const\s+VETTED_PRODUCTS[^=]*=\s*\{([\s\S]*)\}\s*;/);
  
  if (!productsMatch) {
    console.error('‚ùå Could not find VETTED_PRODUCTS in vetted-products.ts');
    process.exit(1);
  }
  
  const productsContent = productsMatch[1];
  
  // Parse entries - look for 'ingredient-name': { productName: '...', ... }
  const entryPattern = /'([^']+)':\s*\{([^}]+(?:\{[^}]*\}[^}]*)*)\}/g;
  const entries: ProductEntry[] = [];
  
  let match;
  while ((match = entryPattern.exec(productsContent)) !== null) {
    const key = match[1];
    const entryContent = match[2];
    
    // Extract productName
    const productNameMatch = entryContent.match(/productName:\s*'([^']*(?:\\'[^']*)*)'/);
    if (!productNameMatch) continue;
    
    const productName = productNameMatch[1].replace(/\\'/g, "'");
    
    // Check if species field already exists
    const hasSpeciesField = /species:\s*['"]/m.test(entryContent);
    
    // Detect species from product name
    const detectedSpecies = detectSpeciesFromProductName(productName);
    
    entries.push({
      key,
      product: { productName } as VettedProduct,
      detectedSpecies,
      needsUpdate: !hasSpeciesField && detectedSpecies !== undefined,
    });
  }
  
  // Generate report
  console.log(`üìä Scan Results:\n`);
  console.log(`   Total products scanned: ${entries.length}`);
  
  const needsUpdate = entries.filter(e => e.needsUpdate);
  const alreadyHasSpecies = entries.filter(e => e.product.species !== undefined || !e.needsUpdate && e.detectedSpecies);
  const noSpeciesFound = entries.filter(e => !e.needsUpdate && !e.detectedSpecies);
  
  console.log(`   Products needing species field: ${needsUpdate.length}`);
  console.log(`   Products already have species: ${alreadyHasSpecies.length}`);
  console.log(`   Products with no species pattern: ${noSpeciesFound.length}\n`);
  
  if (needsUpdate.length > 0) {
    console.log('‚ö†Ô∏è  PRODUCTS NEEDING SPECIES FIELD:\n');
    
    const bySpecies: Record<string, ProductEntry[]> = {
      'dogs': [],
      'cats': [],
      'birds': [],
      'reptiles': [],
      'pocket-pets': [],
      'both': [],
      'multiple': [],
    };
    
    needsUpdate.forEach(entry => {
      const species = entry.detectedSpecies;
      if (Array.isArray(species)) {
        bySpecies['multiple'].push(entry);
      } else if (species && typeof species === 'string' && species in bySpecies) {
        bySpecies[species].push(entry);
      }
    });
    
    Object.entries(bySpecies).forEach(([species, entries]) => {
      if (entries.length === 0) return;
      
      console.log(`\n${species.toUpperCase()} (${entries.length}):`);
      entries.forEach((entry, index) => {
        console.log(`  ${index + 1}. "${entry.key}"`);
        console.log(`     Product: ${entry.product.productName}`);
        console.log(`     Add: species: '${Array.isArray(entry.detectedSpecies) ? entry.detectedSpecies.join("', '") : entry.detectedSpecies}'`);
      });
    });
    
    // Generate TypeScript code snippets for manual insertion
    console.log('\n\nüìù TYPESCRIPT CODE SNIPPETS (copy-paste these into vetted-products.ts):\n');
    console.log('// Add species fields to the following entries:\n');
    
    needsUpdate.forEach(entry => {
      const speciesValue = Array.isArray(entry.detectedSpecies)
        ? `['${entry.detectedSpecies.join("', '")}']`
        : `'${entry.detectedSpecies}'`;
      
      console.log(`  // In '${entry.key}':`);
      console.log(`  // Add: species: ${speciesValue},`);
    });
  }
  
  // Save detailed report
  const reportPath = path.join(__dirname, 'species-detection-report.json');
  const report = {
    scanDate: new Date().toISOString(),
    totalProducts: entries.length,
    needsUpdate: needsUpdate.map(e => ({
      key: e.key,
      productName: e.product.productName,
      detectedSpecies: e.detectedSpecies,
    })),
    alreadyHasSpecies: alreadyHasSpecies.map(e => ({
      key: e.key,
      productName: e.product.productName,
    })),
    noSpeciesFound: noSpeciesFound.map(e => ({
      key: e.key,
      productName: e.product.productName,
    })),
  };
  
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
  console.log(`\nüìÑ Detailed report saved to: ${reportPath}`);
  
  if (needsUpdate.length > 0) {
    console.log('\n‚úÖ Next steps:');
    console.log('   1. Review the detected species assignments');
    console.log('   2. Manually add species fields to the entries listed above');
    console.log('   3. Run validate-species-products.ts to verify');
  }
}

// Run the scan
try {
  scanVettedProducts();
} catch (error) {
  console.error('‚ùå Error scanning products:', error);
  process.exit(1);
}
</file>

<file path="scripts/addRecipeImages.ts">
// Script to add image data to recipes based on category
import { recipes } from '../lib/data/recipes-complete';
import { getEmojiImagePath, type ImageVariant } from '../lib/utils/imageMapping';
import fs from 'fs';
import path from 'path';

// Map category to emoji for image lookup
const categoryToEmoji: Record<string, string> = {
  'dogs': 'üêï',
  'cats': 'üêà',
  'birds': 'ü¶ú',
  'reptiles': 'ü¶é',
  'pocket-pets': 'üê∞'
};

// Image size mappings
const sizeMappings: Record<ImageVariant, { width: number; height: number }> = {
  'icon_64': { width: 64, height: 64 },
  'icon_128': { width: 128, height: 128 },
  'thumb_150': { width: 150, height: 150 },
  'thumb_300x200': { width: 300, height: 200 },
  'recipe_600x384': { width: 600, height: 384 },
  'recipe_300x192': { width: 300, height: 192 },
  'banner_800x400': { width: 800, height: 400 },
  'hero_1200x600': { width: 1200, height: 600 },
  'hero_800x400': { width: 800, height: 400 }
};

function addImagesToRecipes() {
  const updatedRecipes = recipes.map(recipe => {
    const emoji = categoryToEmoji[recipe.category];
    if (!emoji) return recipe;

    const images: any = {};

    // Add card image (recipe_300x192)
    const cardPath = getEmojiImagePath(emoji, 'recipe_300x192');
    if (cardPath) {
      images.card = {
        url: cardPath,
        width: sizeMappings.recipe_300x192.width,
        height: sizeMappings.recipe_300x192.height,
        alt: `${recipe.name} - ${recipe.category} recipe`
      };
    }

    // Add thumbnail
    const thumbPath = getEmojiImagePath(emoji, 'thumb_300x200');
    if (thumbPath) {
      images.thumbnail = {
        url: thumbPath,
        width: sizeMappings.thumb_300x200.width,
        height: sizeMappings.thumb_300x200.height,
        alt: `${recipe.name} thumbnail`
      };
    }

    // Add hero
    const heroPath = getEmojiImagePath(emoji, 'hero_1200x600');
    if (heroPath) {
      images.hero = {
        url: heroPath,
        width: sizeMappings.hero_1200x600.width,
        height: sizeMappings.hero_1200x600.height,
        alt: `${recipe.name} hero image`
      };
    }

    // Add icon
    const iconPath = getEmojiImagePath(emoji, 'icon_128');
    if (iconPath) {
      images.icon = {
        url: iconPath,
        width: sizeMappings.icon_128.width,
        height: sizeMappings.icon_128.height,
        alt: `${recipe.category} icon`
      };
    }

    if (Object.keys(images).length > 0) {
      return { ...recipe, images };
    }

    return recipe;
  });

  // Write back to file
  const filePath = path.join(__dirname, '../lib/data/recipes-complete.ts');
  const content = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Generated on: ${new Date().toISOString()}
// Total recipes: ${updatedRecipes.length}

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(updatedRecipes, null, 2)};
`;

  fs.writeFileSync(filePath, content);
  console.log(`Updated ${updatedRecipes.length} recipes with image data`);
}

addImagesToRecipes();
</file>

<file path="scripts/amazon-api-search.ts">
// scripts/amazon-api-search.ts
// Real Amazon Product Advertising API integration for ASIN verification

import * as fs from 'fs';
import * as path from 'path';
import * as https from 'https';
import * as crypto from 'crypto';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Amazon PA-API Configuration
const AMAZON_CONFIG = {
  accessKey: process.env.AMAZON_ACCESS_KEY || '',
  secretKey: process.env.AMAZON_SECRET_KEY || '',
  associateTag: 'robinfrench-20',
  region: 'us-east-1',
  host: 'webservices.amazon.com',
  service: 'ProductAdvertisingAPI'
};

interface AmazonSearchResult {
  ASIN: string;
  Title: string;
  ProductGroup: string;
  ItemInfo: {
    ByLineInfo?: {
      Brand?: {
        DisplayValue: string;
      };
    };
  };
  Offers?: {
    Listings?: Array<{
      Price: {
        DisplayAmount: string;
      };
    }>;
  };
  CustomerReviews?: {
    Count: number;
    StarRating: {
      DisplayValue: number;
    };
  };
}

// Generate AWS signature for PA-API v5
function generateSignature(stringToSign: string, secretKey: string): string {
  const dateKey = crypto.createHmac('sha256', 'AWS4' + secretKey)
    .update(new Date().toISOString().slice(0, 8))
    .digest();

  const dateRegionKey = crypto.createHmac('sha256', dateKey)
    .update(AMAZON_CONFIG.region)
    .digest();

  const dateRegionServiceKey = crypto.createHmac('sha256', dateRegionKey)
    .update(AMAZON_CONFIG.service)
    .digest();

  const signingKey = crypto.createHmac('sha256', dateRegionServiceKey)
    .update('aws4_request')
    .digest();

  return crypto.createHmac('sha256', signingKey)
    .update(stringToSign)
    .digest('hex');
}

// Search Amazon using Product Advertising API
async function searchAmazonPAAPI(searchTerm: string): Promise<AmazonSearchResult[]> {
  const timestamp = new Date().toISOString().replace(/[:-]|\.\d{3}/g, '');

  const payload = JSON.stringify({
    Keywords: `${searchTerm} dog food`,
    SearchIndex: 'PetSupplies',
    ItemCount: 5,
    Resources: [
      'ItemInfo.Title',
      'ItemInfo.ByLineInfo',
      'Offers.Listings.Price',
      'CustomerReviews.Count',
      'CustomerReviews.StarRating'
    ]
  });

  const canonicalUri = '/paapi5/searchitems';
  const canonicalQuerystring = `AMZNSignature=${encodeURIComponent('')}`;
  const canonicalHeaders = `host:${AMAZON_CONFIG.host}\n` +
    `x-amz-date:${timestamp}\n`;

  const signedHeaders = 'host;x-amz-date';
  const payloadHash = crypto.createHash('sha256').update(payload).digest('hex');

  const canonicalRequest = `POST\n` +
    `${canonicalUri}\n` +
    `${canonicalQuerystring}\n` +
    `${canonicalHeaders}\n` +
    `${signedHeaders}\n` +
    `${payloadHash}`;

  const algorithm = 'AWS4-HMAC-SHA256';
  const credentialScope = `${new Date().toISOString().slice(0, 8)}/${AMAZON_CONFIG.region}/${AMAZON_CONFIG.service}/aws4_request`;
  const stringToSign = `${algorithm}\n${timestamp}\n${credentialScope}\n` +
    crypto.createHash('sha256').update(canonicalRequest).digest('hex');

  const signature = generateSignature(stringToSign, AMAZON_CONFIG.secretKey);

  const authHeader = `${algorithm} Credential=${AMAZON_CONFIG.accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;

  const options = {
    hostname: AMAZON_CONFIG.host,
    path: canonicalUri,
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Amz-Date': timestamp,
      'Authorization': authHeader,
      'X-Amz-Target': 'com.amazon.paapi5.v1.ProductAdvertisingAPIv1.SearchItems',
      'Content-Length': Buffer.byteLength(payload)
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          if (res.statusCode === 200) {
            const response = JSON.parse(data);
            resolve(response.SearchResult?.Items || []);
          } else {
            console.log(`Amazon API Error ${res.statusCode}:`, data);
            resolve([]); // Return empty array on error
          }
        } catch (error) {
          console.error('Error parsing Amazon response:', error);
          resolve([]);
        }
      });
    });

    req.on('error', (error) => {
      console.error('Amazon API request failed:', error);
      resolve([]);
    });

    req.write(payload);
    req.end();
  });
}

// Fallback: Simple web scraping approach (use responsibly!)
async function searchAmazonScraping(searchTerm: string): Promise<AmazonSearchResult[]> {
  console.log('  üåê Using web scraping fallback...');

  const searchUrl = `https://www.amazon.com/s?k=${encodeURIComponent(searchTerm + ' dog food')}&i=pet-supplies`;

  return new Promise((resolve) => {
    const req = https.get(searchUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
      }
    }, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        // Very basic title extraction (you'd want to use cheerio or puppeteer for real parsing)
        const titleMatches = data.match(/<span[^>]*class="[^"]*a-text-normal[^"]*"[^>]*>([^<]+)<\/span>/g) || [];
        const asinMatches = data.match(/\/dp\/([A-Z0-9]{10})/g) || [];

        const results: AmazonSearchResult[] = [];
        for (let i = 0; i < Math.min(titleMatches.length, asinMatches.length, 3); i++) {
          const titleMatch = titleMatches[i]?.match(/<span[^>]*>([^<]+)<\/span>/);
          const asinMatch = asinMatches[i]?.match(/\/dp\/([A-Z0-9]{10})/);

          if (titleMatch && asinMatch) {
            results.push({
              ASIN: asinMatch[1],
              Title: titleMatch[1].replace(/&amp;/g, '&').replace(/&quot;/g, '"'),
              ProductGroup: 'PetSupplies',
              ItemInfo: {},
              CustomerReviews: {
                Count: 0,
                StarRating: { DisplayValue: 0 }
              }
            });
          }
        }

        resolve(results);
      });
    });

    req.on('error', () => {
      resolve([]);
    });

    req.setTimeout(10000, () => {
      req.abort();
      resolve([]);
    });
  });
}

// Main search function with fallback
export async function searchAmazonForProduct(searchTerm: string): Promise<any[]> {
  console.log(`  üîç Searching Amazon for: "${searchTerm}"`);

  // Try PA-API first
  if (AMAZON_CONFIG.accessKey && AMAZON_CONFIG.secretKey) {
    console.log('  üì° Using Amazon PA-API...');
    const results = await searchAmazonPAAPI(searchTerm);
    if (results.length > 0) {
      return results;
    }
  }

  // Fallback to scraping
  console.log('  üåê Falling back to web scraping...');
  return await searchAmazonScraping(searchTerm);
}

// Test the search functionality
async function testSearch() {
  const results = await searchAmazonForProduct('ground chicken');

  console.log('\nüì¶ Search Results:');
  results.forEach((result, i) => {
    console.log(`${i + 1}. ${result.Title} (ASIN: ${result.ASIN})`);
  });

  if (results.length === 0) {
    console.log('‚ùå No results found. Check your API keys or network connection.');
  }
}

// Run test if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  testSearch();
}
</file>

<file path="scripts/analyze-emoji-grids.py">
# scripts/analyze-emoji-grids.py
# Analyze emoji grid images to determine cell dimensions

from PIL import Image
import os
from pathlib import Path

def analyze_grid_image(image_path, grid_cols, grid_rows):
    """Analyze a grid image and calculate cell dimensions"""
    try:
        img = Image.open(image_path)
        width, height = img.size
        
        # Calculate cell dimensions
        cell_width = width / grid_cols
        cell_height = height / grid_rows
        
        return {
            'file': os.path.basename(image_path),
            'total_width': width,
            'total_height': height,
            'grid_cols': grid_cols,
            'grid_rows': grid_rows,
            'cell_width': cell_width,
            'cell_height': cell_height,
            'total_cells': grid_cols * grid_rows
        }
    except Exception as e:
        return {'file': os.path.basename(image_path), 'error': str(e)}

def main():
    emojis_dir = Path('IMAGES FOR SITE/emojis')
    
    if not emojis_dir.exists():
        print(f"‚ùå Directory not found: {emojis_dir}")
        return
    
    print("üîç Analyzing emoji grid images...\n")
    
    # Known grid layouts based on image descriptions
    grid_configs = {
        'amojis.png': (8, 8),  # 8x8 grid = 64 emojis
        'Copilot_20251203_002753.png': (10, 11),  # 10 columns, 11 rows = 110 emojis
        # For the grid JPG files, we'll detect them
    }
    
    results = []
    
    # Analyze PNG files
    for image_file in emojis_dir.glob('*.png'):
        if image_file.name in grid_configs:
            cols, rows = grid_configs[image_file.name]
            result = analyze_grid_image(image_file, cols, rows)
            results.append(result)
    
    # Analyze JPG files - try to detect grid layout
    for image_file in emojis_dir.glob('*.jpg'):
        img = Image.open(image_file)
        width, height = img.size
        
        print(f"\nüìê {image_file.name}:")
        print(f"   Image size: {width}x{height}px")
        print(f"   Possible grid layouts:")
        
        # Try common grid layouts
        possible_layouts = [
            (8, 8),   # 64 emojis
            (10, 10), # 100 emojis
            (10, 11), # 110 emojis
            (15, 10), # 150 emojis
            (12, 10), # 120 emojis
        ]
        
        best_match = None
        for cols, rows in possible_layouts:
            cell_w = width / cols
            cell_h = height / rows
            # Check if it divides evenly (within 1 pixel tolerance)
            if abs(cell_w - round(cell_w)) < 1 and abs(cell_h - round(cell_h)) < 1:
                cell_w_int = round(cell_w)
                cell_h_int = round(cell_h)
                print(f"   ‚úÖ {cols}x{rows} grid ‚Üí {cell_w_int}x{cell_h_int}px per cell")
                if best_match is None:
                    best_match = (cols, rows, cell_w_int, cell_h_int)
        
        if best_match:
            cols, rows, cell_w, cell_h = best_match
            results.append({
                'file': image_file.name,
                'total_width': width,
                'total_height': height,
                'grid_cols': cols,
                'grid_rows': rows,
                'cell_width': cell_w,
                'cell_height': cell_h,
                'total_cells': cols * rows
            })
    
    # Print summary
    print("\n" + "="*60)
    print("üìä GRID ANALYSIS SUMMARY")
    print("="*60)
    
    for result in results:
        if 'error' in result:
            print(f"\n‚ùå {result['file']}: {result['error']}")
        else:
            print(f"\nüìÅ {result['file']}")
            print(f"   Grid: {result['grid_cols']}x{result['grid_rows']} = {result['total_cells']} cells")
            print(f"   Image: {result['total_width']}x{result['total_height']}px")
            print(f"   Cell size: {result['cell_width']:.1f}x{result['cell_height']:.1f}px")
            if result['cell_width'] == int(result['cell_width']):
                print(f"   ‚úÖ Exact: {int(result['cell_width'])}x{int(result['cell_height'])}px per emoji")
    
    # Save results to JSON for the split script
    import json
    output_file = Path('data/emoji-grid-analysis.json')
    output_file.parent.mkdir(exist_ok=True)
    
    with open(output_file, 'w') as f:
        json.dump(results, f, indent=2)
    
    print(f"\n‚úÖ Analysis saved to: {output_file}")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/analyze-emoji-images.py">
# scripts/analyze-emoji-images.py
# Analyze extracted emoji images to identify usable, unique ones

from PIL import Image
import os
from pathlib import Path
from collections import defaultdict
import hashlib

def get_image_hash(image_path):
    """Get a hash of the image content to detect duplicates"""
    try:
        img = Image.open(image_path)
        # Resize to small size for faster hashing
        img = img.resize((32, 32))
        # Convert to RGB if needed
        if img.mode != 'RGB':
            img = img.convert('RGB')
        # Get pixel data hash
        pixel_data = img.tobytes()
        return hashlib.md5(pixel_data).hexdigest()
    except Exception as e:
        return None

def analyze_image(image_path):
    """Analyze a single image"""
    try:
        img = Image.open(image_path)
        width, height = img.size
        
        # Check if image is mostly empty/white
        if img.mode == 'RGB':
            pixels = list(img.getdata())
            # Count non-white pixels
            non_white = sum(1 for p in pixels if p != (255, 255, 255))
            total = len(pixels)
            content_ratio = non_white / total if total > 0 else 0
        else:
            content_ratio = 0.5  # Assume has content if not RGB
        
        return {
            'width': width,
            'height': height,
            'content_ratio': content_ratio,
            'has_content': content_ratio > 0.01,  # At least 1% non-white
            'size': os.path.getsize(image_path)
        }
    except Exception as e:
        return {'error': str(e)}

def main():
    emojis_dir = Path('public/images/emojis')
    
    if not emojis_dir.exists():
        print(f"‚ùå Directory not found: {emojis_dir}")
        return
    
    print("üîç Analyzing emoji images...\n")
    
    # Group by source
    amojis = sorted(emojis_dir.glob('amojis_*.png'))
    copilot = sorted(emojis_dir.glob('copilot_emojis_*.png'))
    grid = sorted(emojis_dir.glob('emoji_grid_*.png'))
    
    print(f"üìä Found:")
    print(f"   amojis: {len(amojis)} images")
    print(f"   copilot: {len(copilot)} images")
    print(f"   grid: {len(grid)} images")
    print(f"   Total: {len(amojis) + len(copilot) + len(grid)} images\n")
    
    # Analyze all images
    all_images = list(amojis) + list(copilot) + list(grid)
    
    print("üîé Checking for duplicates and usable content...\n")
    
    # Find duplicates by hash
    hash_map = defaultdict(list)
    usable_images = []
    duplicate_count = 0
    
    for img_path in all_images:
        img_hash = get_image_hash(img_path)
        if img_hash:
            hash_map[img_hash].append(img_path)
            if len(hash_map[img_hash]) == 1:
                # First occurrence, check if usable
                analysis = analyze_image(img_path)
                if analysis.get('has_content', False):
                    usable_images.append({
                        'path': img_path,
                        'hash': img_hash,
                        'source': img_path.stem.split('_')[0],
                        'number': int(img_path.stem.split('_')[-1]) if img_path.stem.split('_')[-1].isdigit() else 0,
                        'width': analysis.get('width', 0),
                        'height': analysis.get('height', 0),
                        'content_ratio': analysis.get('content_ratio', 0)
                    })
            else:
                duplicate_count += 1
    
    print(f"‚úÖ Unique usable images: {len(usable_images)}")
    print(f"‚ùå Duplicates found: {duplicate_count}\n")
    
    # Group by source
    by_source = defaultdict(list)
    for img in usable_images:
        by_source[img['source']].append(img)
    
    print("üìÅ Usable images by source:")
    for source, images in sorted(by_source.items()):
        print(f"   {source}: {len(images)} unique images")
    
    # Identify best candidates for common emojis
    print("\nüéØ Best candidates for common pet emojis:")
    print("   (Based on image descriptions and position in grids)\n")
    
    # amojis.png grid (8x8) - based on earlier description:
    # Row 1: Yellow dog, teal cat, orange rabbit, rabbit+chick, green bird, turtle, owl, beaver
    candidates = {
        'dog': ['amojis_001', 'amojis_009', 'amojis_010'],  # Row 1, Row 2
        'cat': ['amojis_002', 'amojis_064'],  # Row 1, Row 8 (black cat)
        'rabbit': ['amojis_003', 'amojis_062'],  # Row 1, Row 8
        'bird': ['amojis_005', 'amojis_013', 'amojis_014', 'amojis_058'],  # Row 1, Row 3, Row 8
        'turtle': ['amojis_006', 'amojis_025', 'amojis_033'],  # Row 1, Row 4, Row 5
        'hedgehog': ['amojis_010'],  # Row 2
        'mouse': ['amojis_064'],  # Row 5
        'paw_print': ['copilot_emojis_001'],  # First in copilot grid
        'check': ['copilot_emojis_070'],  # Row 7 in copilot grid
    }
    
    # Find actual files
    found_candidates = {}
    for emoji_type, possible_names in candidates.items():
        for name in possible_names:
            for img in usable_images:
                if img['path'].stem == name:
                    found_candidates[emoji_type] = img['path']
                    break
            if emoji_type in found_candidates:
                break
    
    print("   Found candidates:")
    for emoji_type, img_path in found_candidates.items():
        print(f"   {emoji_type}: {img_path.name}")
    
    # Save results
    import json
    output = {
        'total_images': len(all_images),
        'unique_usable': len(usable_images),
        'duplicates': duplicate_count,
        'by_source': {k: len(v) for k, v in by_source.items()},
        'candidates': {k: str(v) for k, v in found_candidates.items()},
        'all_usable': [
            {
                'file': str(img['path'].relative_to(Path('public'))),
                'source': img['source'],
                'number': img['number'],
                'size': f"{img['width']}x{img['height']}"
            }
            for img in sorted(usable_images, key=lambda x: (x['source'], x['number']))
        ]
    }
    
    output_file = Path('data/emoji-analysis.json')
    output_file.parent.mkdir(exist_ok=True)
    with open(output_file, 'w') as f:
        json.dump(output, f, indent=2)
    
    print(f"\n‚úÖ Analysis saved to: {output_file}")
    print(f"\nüí° Recommendation: Use {len(usable_images)} unique images")
    print(f"   Focus on 'amojis' set (64 images) - they seem most consistent")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/analyze-ingredient-costs-by-pet.ts">
/**
 * Cost Analysis Script
 * Analyzes ingredient costs by pet type and identifies expensive ingredients
 * Outputs recommendations for cheaper alternatives to meet $4.50 per meal target
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
// Use require for TypeScript module compatibility
const recipesModule = require('../lib/data/recipes-complete');
const { recipes } = recipesModule;
import { VETTED_PRODUCTS } from '../lib/data/vetted-products';
import { getPackageSize } from '../lib/data/packageSizes';
import { parseAmountToGrams } from '../lib/utils/mealEstimation';
import { applyModifiers } from '../lib/applyModifiers';
import { calculateMealsFromGroceryList } from '../lib/utils/mealEstimation';
import type { Recipe } from '../lib/types';

// ES module __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface IngredientCostAnalysis {
  ingredientName: string;
  species: string[];
  averagePrice: number;
  usageCount: number;
  costTier: 'budget' | 'standard' | 'premium';
  needsBudgetAlternative: boolean;
}

interface RecipeCostAnalysis {
  recipeId: string;
  recipeName: string;
  category: string;
  costPerMeal: number;
  totalCost: number;
  estimatedMeals: number;
  exceedsBudget: boolean;
  expensiveIngredients: string[];
}

interface CostReport {
  scanDate: string;
  maxCostPerMeal: number;
  recipesAnalyzed: number;
  recipesExceedingBudget: number;
  averageCostPerMealBySpecies: Record<string, number>;
  expensiveIngredients: IngredientCostAnalysis[];
  recipeCosts: RecipeCostAnalysis[];
  recommendations: string[];
}

function getSpeciesFromRecipeCategory(category?: string): string | undefined {
  if (!category) return undefined;
  return category;
}

function analyzeIngredientCosts(): IngredientCostAnalysis[] {
  const ingredientMap = new Map<string, {
    species: Set<string>;
    prices: number[];
    usageCount: number;
  }>();

  // Analyze all recipes
  recipes.forEach((recipe: Recipe) => {
    const species = getSpeciesFromRecipeCategory(recipe.category);
    if (!species) return;

    // Create mock pet for applyModifiers
    const mockPet = {
      id: 'analysis-pet',
      type: species,
      name: 'Analysis Pet',
      breed: 'Mixed',
      age: 'adult',
      healthConcerns: [],
      allergies: [],
      weightKg: 10,
    };

    try {
      const modifiedResult = applyModifiers(recipe, mockPet as any);
      const modifiedRecipe = modifiedResult.modifiedRecipe;

      // Analyze ingredients
      (modifiedRecipe.ingredients || []).forEach((ing: any) => {
        const ingName = (ing.productName || ing.name || '').toLowerCase().trim();
        if (!ingName) return;

        const vettedProduct = VETTED_PRODUCTS[ingName] || 
          Object.values(VETTED_PRODUCTS).find(p => 
            p.productName.toLowerCase() === ingName
          );

        if (vettedProduct && vettedProduct.price?.amount) {
          if (!ingredientMap.has(ingName)) {
            ingredientMap.set(ingName, {
              species: new Set(),
              prices: [],
              usageCount: 0,
            });
          }

          const data = ingredientMap.get(ingName)!;
          data.species.add(species);
          data.prices.push(vettedProduct.price.amount);
          data.usageCount++;
        }
      });

      // Analyze supplements
      if ((modifiedRecipe as any).supplements) {
        ((modifiedRecipe as any).supplements || []).forEach((supplement: any) => {
          const suppName = (supplement.productName || supplement.name || '').toLowerCase().trim();
          if (!suppName) return;

          const vettedProduct = VETTED_PRODUCTS[suppName] ||
            Object.values(VETTED_PRODUCTS).find(p =>
              p.productName.toLowerCase() === suppName
            );

          if (vettedProduct && vettedProduct.price?.amount) {
            if (!ingredientMap.has(suppName)) {
              ingredientMap.set(suppName, {
                species: new Set(),
                prices: [],
                usageCount: 0,
              });
            }

            const data = ingredientMap.get(suppName)!;
            data.species.add(species);
            data.prices.push(vettedProduct.price.amount);
            data.usageCount++;
          }
        });
      }
    } catch (error) {
      console.warn(`Error analyzing recipe ${recipe.id}:`, error);
    }
  });

  // Convert to analysis array
  const analysis: IngredientCostAnalysis[] = [];

  ingredientMap.forEach((data, ingredientName) => {
    const avgPrice = data.prices.reduce((a, b) => a + b, 0) / data.prices.length;
    const costTier: 'budget' | 'standard' | 'premium' = 
      avgPrice < 15 ? 'budget' :
      avgPrice < 30 ? 'standard' : 'premium';

    analysis.push({
      ingredientName,
      species: Array.from(data.species),
      averagePrice: avgPrice,
      usageCount: data.usageCount,
      costTier,
      needsBudgetAlternative: avgPrice > 30 || (avgPrice > 15 && data.usageCount > 5),
    });
  });

  return analysis.sort((a, b) => b.averagePrice - a.averagePrice);
}

function analyzeRecipeCosts(): RecipeCostAnalysis[] {
  const recipeCosts: RecipeCostAnalysis[] = [];

  recipes.forEach((recipe: Recipe) => {
    const species = getSpeciesFromRecipeCategory(recipe.category);
    if (!species) return;

    // Create mock pet
    const mockPet = {
      id: 'analysis-pet',
      type: species,
      name: 'Analysis Pet',
      breed: 'Mixed',
      age: 'adult',
      healthConcerns: [],
      allergies: [],
      weightKg: 10,
    };

    try {
      const modifiedResult = applyModifiers(recipe, mockPet as any);
      const modifiedRecipe = modifiedResult.modifiedRecipe;

      // Build shopping list items
      const allIngredients = modifiedRecipe.ingredients || [];
      const allSupplements = (modifiedRecipe as any).supplements || [];
      
      const shoppingItems = [
        ...allIngredients.filter((ing: any) => ing.asinLink).map((ing: any) => ({
          id: ing.id || ing.name,
          name: ing.productName || ing.name,
          amount: ing.amount || '100g',
          category: (VETTED_PRODUCTS[(ing.productName || ing.name).toLowerCase()] ||
            Object.values(VETTED_PRODUCTS).find(p => 
              p.productName.toLowerCase() === (ing.productName || ing.name).toLowerCase()
            ))?.category || 'other',
        })),
        ...allSupplements.filter((supp: any) => supp.asinLink).map((supp: any) => ({
          id: supp.id || supp.name,
          name: supp.productName || supp.name,
          amount: supp.amount || supp.defaultAmount || '1 serving',
          category: 'Supplement',
        })),
      ];

      if (shoppingItems.length === 0) return;

      // Calculate meal estimate
      const estimate = calculateMealsFromGroceryList(shoppingItems);
      
      if (estimate) {
        const exceedsBudget = estimate.costPerMeal > 4.50;
        
        // Find expensive ingredients
        const expensiveIngredients: string[] = [];
        estimate.breakdown.forEach(item => {
          if (item.packageCost > 30) {
            expensiveIngredients.push(item.ingredient);
          }
        });

        recipeCosts.push({
          recipeId: recipe.id,
          recipeName: recipe.name,
          category: recipe.category || 'unknown',
          costPerMeal: estimate.costPerMeal,
          totalCost: estimate.totalCost,
          estimatedMeals: estimate.estimatedMeals,
          exceedsBudget,
          expensiveIngredients,
        });
      }
    } catch (error) {
      console.warn(`Error analyzing recipe ${recipe.id}:`, error);
    }
  });

  return recipeCosts.sort((a, b) => b.costPerMeal - a.costPerMeal);
}

function generateRecommendations(
  ingredientAnalysis: IngredientCostAnalysis[],
  recipeAnalysis: RecipeCostAnalysis[]
): string[] {
  const recommendations: string[] = [];

  // Top expensive ingredients
  const topExpensive = ingredientAnalysis
    .filter(ing => ing.needsBudgetAlternative)
    .slice(0, 20);

  if (topExpensive.length > 0) {
    recommendations.push('TOP PRIORITY: Add budget alternatives for these expensive ingredients:');
    topExpensive.forEach((ing, index) => {
      recommendations.push(`  ${index + 1}. ${ing.ingredientName} - $${ing.averagePrice.toFixed(2)} (used in ${ing.species.join(', ')})`);
    });
  }

  // Recipes exceeding budget
  const exceedingRecipes = recipeAnalysis.filter(r => r.exceedsBudget);
  if (exceedingRecipes.length > 0) {
    recommendations.push(`\n${exceedingRecipes.length} recipes exceed $4.50 per meal target:`);
    exceedingRecipes.slice(0, 10).forEach(recipe => {
      recommendations.push(`  - ${recipe.recipeName} (${recipe.category}): $${recipe.costPerMeal.toFixed(2)}/meal`);
    });
  }

  // Species-specific recommendations
  const bySpecies = recipeAnalysis.reduce((acc, recipe) => {
    if (!acc[recipe.category]) {
      acc[recipe.category] = { total: 0, sum: 0, exceeding: 0 };
    }
    acc[recipe.category].total++;
    acc[recipe.category].sum += recipe.costPerMeal;
    if (recipe.exceedsBudget) acc[recipe.category].exceeding++;
    return acc;
  }, {} as Record<string, { total: number; sum: number; exceeding: number }>);

  Object.entries(bySpecies).forEach(([species, data]) => {
    const avg = data.sum / data.total;
    if (avg > 4.50 || data.exceeding > 0) {
      recommendations.push(`\n${species.toUpperCase()}: Average cost $${avg.toFixed(2)}/meal, ${data.exceeding} recipes exceed budget`);
      if (species === 'cats') {
        recommendations.push('  Priority: Add budget-friendly heart meats (beef heart, turkey hearts) for taurine');
      }
      if (species === 'dogs') {
        recommendations.push('  Priority: Add budget organ meats and cheaper fish alternatives');
      }
    }
  });

  return recommendations;
}

function main() {
  console.log('üîç Starting ingredient cost analysis...\n');

  // Analyze ingredients
  console.log('Analyzing ingredient costs...');
  const ingredientAnalysis = analyzeIngredientCosts();

  // Analyze recipes
  console.log('Analyzing recipe costs...');
  const recipeAnalysis = analyzeRecipeCosts();

  // Calculate averages by species
  const avgBySpecies: Record<string, number> = {};
  const speciesGroups = recipeAnalysis.reduce((acc, recipe) => {
    if (!acc[recipe.category]) acc[recipe.category] = [];
    acc[recipe.category].push(recipe.costPerMeal);
    return acc;
  }, {} as Record<string, number[]>);

  Object.entries(speciesGroups).forEach(([species, costs]) => {
    avgBySpecies[species] = costs.reduce((a, b) => a + b, 0) / costs.length;
  });

  // Generate recommendations
  const recommendations = generateRecommendations(ingredientAnalysis, recipeAnalysis);

  // Create report
  const report: CostReport = {
    scanDate: new Date().toISOString(),
    maxCostPerMeal: 4.50,
    recipesAnalyzed: recipeAnalysis.length,
    recipesExceedingBudget: recipeAnalysis.filter(r => r.exceedsBudget).length,
    averageCostPerMealBySpecies: avgBySpecies,
    expensiveIngredients: ingredientAnalysis.filter(ing => ing.needsBudgetAlternative).slice(0, 30),
    recipeCosts: recipeAnalysis,
    recommendations,
  };

  // Save report
  const reportPath = path.join(__dirname, 'cost-analysis-report.json');
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));

  // Print summary
  console.log('\nüìä COST ANALYSIS SUMMARY\n');
  console.log(`Total recipes analyzed: ${report.recipesAnalyzed}`);
  console.log(`Recipes exceeding $4.50: ${report.recipesExceedingBudget} (${((report.recipesExceedingBudget / report.recipesAnalyzed) * 100).toFixed(1)}%)\n`);

  console.log('Average cost per meal by species:');
  Object.entries(avgBySpecies).forEach(([species, avg]) => {
    const status = avg > 4.50 ? '‚ùå' : '‚úÖ';
    console.log(`  ${status} ${species}: $${avg.toFixed(2)}`);
  });

  console.log('\nüìã TOP EXPENSIVE INGREDIENTS NEEDING BUDGET ALTERNATIVES:\n');
  ingredientAnalysis.filter(ing => ing.needsBudgetAlternative).slice(0, 15).forEach((ing, index) => {
    console.log(`${index + 1}. ${ing.ingredientName}`);
    console.log(`   Average price: $${ing.averagePrice.toFixed(2)} | Tier: ${ing.costTier} | Used in: ${ing.species.join(', ')}`);
  });

  console.log('\nüìÑ Detailed report saved to:', reportPath);
  console.log('\nüí° RECOMMENDATIONS:\n');
  recommendations.forEach(rec => console.log(rec));
}

main().catch(console.error);
</file>

<file path="scripts/analyze-missing-ingredients.ts">
import { recipes } from '../lib/data/recipes-complete';
import { getVettedProduct } from '../lib/data/vetted-products';

// Extract all unique ingredient names from recipes
const allIngredientNames = new Set<string>();

recipes.forEach(recipe => {
  recipe.ingredients.forEach(ing => {
    allIngredientNames.add(ing.name);
  });
  
  // Also check supplements if they exist
  if ((recipe as any).supplements) {
    (recipe as any).supplements.forEach((supp: any) => {
      allIngredientNames.add(supp.name);
    });
  }
});

// Check which ingredients have vetted products
const missingIngredients: string[] = [];
const hasVettedProduct: string[] = [];

allIngredientNames.forEach(ingredientName => {
  const vetted = getVettedProduct(ingredientName);
  if (!vetted || !vetted.asinLink) {
    missingIngredients.push(ingredientName);
  } else {
    hasVettedProduct.push(ingredientName);
  }
});

console.log('=== INGREDIENT ANALYSIS ===\n');
console.log(`Total unique ingredients: ${allIngredientNames.size}`);
console.log(`Ingredients WITH vetted products: ${hasVettedProduct.length}`);
console.log(`Ingredients MISSING vetted products: ${missingIngredients.length}\n`);

console.log('=== MISSING INGREDIENTS (need vetted product entries) ===');
missingIngredients.sort().forEach((ing, index) => {
  console.log(`${index + 1}. ${ing}`);
});

console.log('\n=== SAMPLE: First 10 ingredients WITH vetted products ===');
hasVettedProduct.sort().slice(0, 10).forEach((ing, index) => {
  console.log(`${index + 1}. ${ing}`);
});
</file>

<file path="scripts/audit-all-purchase-links.ts">
// scripts/audit-all-purchase-links.ts
// Comprehensive audit combining vetted products + runtime code checks
// Generates detailed report for all purchase links

import * as fs from 'fs';
import * as path from 'path';

const SELLER_ID = 'robinfrench-20';
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const COMPONENTS_TO_CHECK = [
  'components/ShoppingList.tsx',
  'components/OneClickCheckoutModal.tsx',
  'components/MultiPetShoppingModal.tsx',
  'components/QuickPreviewModal.tsx',
  'components/MealCompleteView.tsx',
  'components/MealCompositionList.tsx',
  'app/recipe/[id]/page.tsx',
  'app/profile/page.tsx',
  'app/profile/pet/[id]/meal-plan/page.tsx',
];

interface AuditResult {
  type: 'vetted-product' | 'runtime-code';
  location: string;
  issue: string;
  severity: 'error' | 'warning';
  fix?: string;
}

const results: AuditResult[] = [];

// Helper functions
function hasSellerId(url: string): boolean {
  if (!url) return false;
  return url.includes(`tag=${SELLER_ID}`) || url.includes(`AssociateTag=${SELLER_ID}`);
}

function extractASIN(url: string): string | null {
  if (!url) return null;
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (dpMatch) return dpMatch[1];
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (gpMatch) return gpMatch[1];
  return null;
}

function isGenericSearch(url: string): boolean {
  if (!url) return false;
  return url.includes('/s?k=') || url.includes('/s?') || url.includes('search/');
}

// Audit vetted products
function auditVettedProducts() {
  console.log('üìã Auditing vetted products...');
  
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  const lines = content.split('\n');
  
  let currentIngredient: string | null = null;
  let currentLink: string | null = null;
  let inProductBlock = false;
  let braceDepth = 0;
  let lineNum = 0;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    lineNum = i + 1;
    
    const ingredientMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (ingredientMatch) {
      currentIngredient = ingredientMatch[1];
      inProductBlock = true;
      braceDepth = 1;
      currentLink = null;
      continue;
    }
    
    if (inProductBlock) {
      braceDepth += (line.match(/\{/g) || []).length;
      braceDepth -= (line.match(/\}/g) || []).length;
      
      const asinMatch = line.match(/asinLink:\s*'([^']+)'/);
      if (asinMatch) {
        currentLink = asinMatch[1];
      }
      
      if (braceDepth === 0) {
        if (currentIngredient && currentLink) {
          const location = `${VETTED_PRODUCTS_FILE}:${lineNum}`;
          let foundIssues = false;
          
          if (!hasSellerId(currentLink)) {
            results.push({
              type: 'vetted-product',
              location,
              issue: `Missing seller ID: ${currentIngredient}`,
              severity: 'error',
              fix: `Add ?tag=${SELLER_ID} to asinLink`,
            });
            foundIssues = true;
          }
          
          if (!extractASIN(currentLink)) {
            results.push({
              type: 'vetted-product',
              location,
              issue: `Invalid ASIN format: ${currentIngredient}`,
              severity: 'error',
              fix: 'Use /dp/ASIN or /gp/product/ASIN format',
            });
            foundIssues = true;
          }
          
          if (isGenericSearch(currentLink)) {
            results.push({
              type: 'vetted-product',
              location,
              issue: `Generic search URL: ${currentIngredient}`,
              severity: 'error',
              fix: 'Replace with specific product ASIN link',
            });
            foundIssues = true;
          }
        }
        
        currentIngredient = null;
        currentLink = null;
        inProductBlock = false;
      }
    }
  }
  
  const vettedProductCount = results.filter(r => r.type === 'vetted-product').length;
  console.log(`  ‚úÖ Checked vetted products (found ${vettedProductCount} issues)`);
}

// Audit runtime code
function auditRuntimeCode() {
  console.log('üìã Auditing runtime code...');
  
  COMPONENTS_TO_CHECK.forEach(componentPath => {
    const fullPath = path.join(__dirname, '../', componentPath);
    
    if (!fs.existsSync(fullPath)) {
      results.push({
        type: 'runtime-code',
        location: componentPath,
        issue: 'File not found',
        severity: 'warning',
      });
      return;
    }
    
    const content = fs.readFileSync(fullPath, 'utf-8');
    const lines = content.split('\n');
    
    // Check for window.open with asinLink without ensureSellerId
    lines.forEach((line, idx) => {
      const lineNum = idx + 1;
      
      // Check for window.open with asinLink that doesn't use ensureSellerId or ensureCartUrlSellerId
      if (line.includes('window.open') && line.includes('asinLink')) {
        if (!line.includes('ensureSellerId') && !line.includes('ensureCartUrlSellerId')) {
          results.push({
            type: 'runtime-code',
            location: `${componentPath}:${lineNum}`,
            issue: 'window.open with asinLink missing ensureSellerId wrapper',
            severity: 'error',
            fix: 'Wrap asinLink with ensureSellerId() or ensureCartUrlSellerId()',
          });
        }
      }
      
      // Check for href with asinLink without ensureSellerId
      if (line.includes('href=') && line.includes('asinLink') && !line.includes('ensureSellerId')) {
        results.push({
          type: 'runtime-code',
          location: `${componentPath}:${lineNum}`,
          issue: 'href with asinLink missing ensureSellerId wrapper',
          severity: 'error',
          fix: 'Wrap asinLink with ensureSellerId()',
        });
      }
      
      // Check for cart URL construction without ensureCartUrlSellerId or hardcoded seller ID
      if (line.includes('gp/aws/cart/add.html') && 
          !line.includes('ensureCartUrlSellerId') && 
          !line.includes(`tag=${SELLER_ID}`) && 
          !line.includes(`AssociateTag=${SELLER_ID}`)) {
        results.push({
          type: 'runtime-code',
          location: `${componentPath}:${lineNum}`,
          issue: 'Cart URL construction missing seller ID',
          severity: 'error',
          fix: 'Add tag=robinfrench-20 or use ensureCartUrlSellerId()',
        });
      }
    });
  });
  
  console.log(`  ‚úÖ Checked ${COMPONENTS_TO_CHECK.length} component files`);
}

// Generate report
function generateReport() {
  const reportPath = path.join(__dirname, '../AFFILIATE_LINKS_AUDIT_REPORT.md');
  
  const errors = results.filter(r => r.severity === 'error');
  const warnings = results.filter(r => r.severity === 'warning');
  
  const report = `# Affiliate Links Comprehensive Audit Report
Generated: ${new Date().toISOString()}

## Summary
- Total issues found: ${results.length}
- Errors: ${errors.length}
- Warnings: ${warnings.length}

## Status
${errors.length === 0 ? '‚úÖ **PASS** - All checks passed!' : '‚ùå **FAIL** - Errors found'}

## Issues by Type

### Vetted Products
${results.filter(r => r.type === 'vetted-product').map(r => `
- **${r.severity.toUpperCase()}**: ${r.issue}
  - Location: ${r.location}
  - Fix: ${r.fix || 'N/A'}
`).join('\n') || '‚úÖ No issues found'}

### Runtime Code
${results.filter(r => r.type === 'runtime-code').map(r => `
- **${r.severity.toUpperCase()}**: ${r.issue}
  - Location: ${r.location}
  - Fix: ${r.fix || 'N/A'}
`).join('\n') || '‚úÖ No issues found'}

## All Issues

${results.map((r, idx) => `${idx + 1}. [${r.severity.toUpperCase()}] ${r.issue}
   - Type: ${r.type}
   - Location: ${r.location}
   ${r.fix ? `   - Fix: ${r.fix}` : ''}`).join('\n\n') || 'No issues found.'}

## Recommendations

1. **Run validation**: \`npm run validate:links\`
2. **Fix errors**: Address all ERROR-level issues
3. **Review warnings**: Check WARNING-level issues
4. **Run tests**: Execute test suite to verify fixes

---

*Report generated by audit-all-purchase-links.ts*
`;

  fs.writeFileSync(reportPath, report);
  console.log(`\nüíæ Report saved to: ${reportPath}`);
  
  return { errors, warnings };
}

// Main execution
function main() {
  console.log('üîç Comprehensive Purchase Links Audit\n');
  console.log('='.repeat(60));
  
  auditVettedProducts();
  auditRuntimeCode();
  
  const { errors, warnings } = generateReport();
  
  console.log('\n' + '='.repeat(60));
  console.log('üìä AUDIT SUMMARY\n');
  console.log(`Total issues: ${results.length}`);
  console.log(`Errors: ${errors.length}`);
  console.log(`Warnings: ${warnings.length}`);
  
  if (errors.length === 0) {
    console.log('\n‚úÖ All checks passed!\n');
    process.exit(0);
  } else {
    console.log('\n‚ùå Errors found. See report for details.\n');
    process.exit(1);
  }
}

try {
  main();
} catch (error) {
  console.error('‚ùå Error running audit:', error);
  process.exit(1);
}
</file>

<file path="scripts/audit-amazon-links.js">
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();

const args = new Set(process.argv.slice(2));
const getArgValue = (name, fallback) => {
  const raw = process.argv.find((a) => a.startsWith(`${name}=`));
  if (!raw) return fallback;
  const v = raw.slice(name.length + 1);
  return v.length ? v : fallback;
};

const shouldFetchTitles = args.has('--fetch-titles');
const maxFetch = Number(getArgValue('--max-fetch', '60')) || 60;
const fetchDelayMs = Number(getArgValue('--fetch-delay-ms', '1500')) || 1500;

const vettedPath = path.join(root, 'lib', 'data', 'vetted-products.ts');
const pricesPath = path.join(root, 'data', 'product-prices.json');
const allIngredientsPath = path.join(root, 'lib', 'utils', 'allIngredients.ts');
const recipesCompletePath = path.join(root, 'lib', 'data', 'recipes-complete.ts');

function readText(p) {
  return fs.readFileSync(p, 'utf8');
}

function normalizeKey(s) {
  return String(s || '').toLowerCase().trim();
}

function normalizeDisplay(s) {
  return String(s || '')
    .toLowerCase()
    .trim()
    .replace(/\s*\([^)]*\)\s*/g, '')
    .replace(/\s+/g, ' ')
    .replace(/[‚Äô]/g, "'");
}

function extractAsinFromAmazonUrl(url) {
  if (!url) return null;
  const m = String(url).match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
  return m ? m[1] : null;
}

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}

function stripHtml(s) {
  return String(s || '')
    .replace(/<script[\s\S]*?<\/script>/gi, ' ')
    .replace(/<style[\s\S]*?<\/style>/gi, ' ')
    .replace(/<[^>]+>/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function tokenize(s) {
  return String(s || '')
    .toLowerCase()
    .replace(/[‚Äô]/g, "'")
    .replace(/[^a-z0-9\s]/g, ' ')
    .split(/\s+/)
    .filter(Boolean);
}

function computeTitleSignals(key, title) {
  const keyTokens = new Set(tokenize(normalizeDisplay(key)));
  const titleTokens = new Set(tokenize(title));

  const missing = [];
  for (const t of keyTokens) {
    if (t.length < 3) continue;
    if (!titleTokens.has(t)) missing.push(t);
  }

  const hasJerkySignal = titleTokens.has('jerky');
  const hasTreatSignal = titleTokens.has('treat') || titleTokens.has('treats');
  const hasSupplementSignal =
    titleTokens.has('supplement') || titleTokens.has('supplements') || titleTokens.has('capsules') || titleTokens.has('tablets');

  const mismatchScore = Math.min(10, missing.length) + (hasJerkySignal ? 5 : 0);

  return {
    missingKeyTokens: missing.slice(0, 12),
    mismatchScore,
    hasJerkySignal,
    hasTreatSignal,
    hasSupplementSignal,
  };
}

async function fetchAmazonTitleByAsin(asin) {
  const url = `https://www.amazon.com/dp/${asin}`;
  const res = await fetch(url, {
    redirect: 'follow',
    headers: {
      'user-agent':
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      'accept-language': 'en-US,en;q=0.9',
      accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    },
  });

  const status = res.status;
  const text = await res.text();

  const og = text.match(/<meta\s+property=["']og:title["']\s+content=["']([^"']+)["'][^>]*>/i);
  const titleTag = text.match(/<title>([\s\S]*?)<\/title>/i);
  const candidate = (og?.[1] || titleTag?.[1] || '').trim();
  const title = stripHtml(candidate);

  return { url, status, title };
}

function parseAllIngredientsStrings(allIngredientsTs) {
  // This file is mostly string literals; extracting all '...' strings is good enough for membership checks.
  const set = new Set();
  const strRe = /'([^']+)'/g;
  let m;
  while ((m = strRe.exec(allIngredientsTs))) {
    const v = m[1];
    if (!v || v.length < 2) continue;
    set.add(normalizeDisplay(v));
  }
  return set;
}

function parseRecipeIngredientNames(recipesCompleteTs) {
  // Extract occurrences like: name: 'Ground Chicken'
  const set = new Set();
  const nameRe = /\bname\s*:\s*'([^']+)'/g;
  let m;
  while ((m = nameRe.exec(recipesCompleteTs))) {
    const v = m[1];
    if (!v || v.length < 2) continue;
    set.add(normalizeDisplay(v));
  }
  return set;
}

function parseVettedProducts(vettedTs) {
  // Parse object entries:
  //  'ground chicken': {
  //    productName: '...'
  //    amazonLink: '...'
  //  },
  const entries = [];
  const entryRe = /\n\s*'([^']+)'\s*:\s*\{([\s\S]*?)\n\s*\},/g;
  let m;
  while ((m = entryRe.exec(vettedTs))) {
    const key = m[1];
    const block = m[2];

    const productNameMatch = block.match(/productName:\s*'([^']+)'|productName:\s*\"([^\"]+)\"/);
    const amazonLinkMatch = block.match(/amazonLink:\s*'([^']+)'|amazonLink:\s*\"([^\"]+)\"/);

    const productName = productNameMatch ? (productNameMatch[1] || productNameMatch[2] || '') : '';
    const amazonLink = amazonLinkMatch ? (amazonLinkMatch[1] || amazonLinkMatch[2] || '') : '';
    const asin = extractAsinFromAmazonUrl(amazonLink);

    entries.push({
      key,
      keyNorm: normalizeKey(key),
      productName,
      amazonLink,
      asin,
    });
  }
  return entries;
}

async function main() {
  const vettedTs = readText(vettedPath);
  const allIngredientsTs = readText(allIngredientsPath);
  const recipesCompleteTs = readText(recipesCompletePath);

  const prices = JSON.parse(readText(pricesPath));

  const allIngredientsSet = parseAllIngredientsStrings(allIngredientsTs);
  const recipeIngredientsSet = parseRecipeIngredientNames(recipesCompleteTs);
  const vettedEntries = parseVettedProducts(vettedTs);

  const asinToIngredientsFromPrices = new Map();
  for (const p of prices) {
    const asin = String(p?.asin || '').toUpperCase();
    const ingredient = normalizeKey(p?.ingredient);
    if (!asin || asin.length !== 10 || !ingredient) continue;
    if (!asinToIngredientsFromPrices.has(asin)) asinToIngredientsFromPrices.set(asin, new Set());
    asinToIngredientsFromPrices.get(asin).add(ingredient);
  }

  const asinToKeys = new Map();
  for (const e of vettedEntries) {
    if (!e.asin) continue;
    if (!asinToKeys.has(e.asin)) asinToKeys.set(e.asin, []);
    asinToKeys.get(e.asin).push(e.key);
  }

  const flags = [];

  const asinTitleCache = new Map();
  let fetchedCount = 0;

  for (const e of vettedEntries) {
    const problems = [];

    // Compare against canonical ingredient catalogs (not productName)
    const inAllIngredients = allIngredientsSet.has(normalizeDisplay(e.key));
    const inRecipes = recipeIngredientsSet.has(normalizeDisplay(e.key));
    if (!inAllIngredients && !inRecipes) {
      problems.push('key_not_in_ingredient_catalogs');
    }

    if (!e.amazonLink) problems.push('missing_amazonLink');
    if (e.amazonLink && !e.amazonLink.includes('amazon.com')) problems.push('non_amazon_url');
    if (e.amazonLink && e.amazonLink.includes('/s?')) problems.push('search_url_not_dp');
    if (e.amazonLink && !e.amazonLink.includes('tag=robinfrench-20')) problems.push('missing_affiliate_tag');
    if (!e.asin) problems.push('no_asin_in_url');

    if (e.asin) {
      const expected = asinToIngredientsFromPrices.get(e.asin);
      if (expected && !expected.has(e.keyNorm)) problems.push('asin_mismatch_vs_product_prices_json');
      const dupKeys = asinToKeys.get(e.asin) || [];
      if (dupKeys.length > 1) problems.push(`asin_shared_with_${dupKeys.length}_keys`);
    }

    let fetched = null;
    let titleSignals = null;
    if (shouldFetchTitles && e.asin) {
      if (asinTitleCache.has(e.asin)) {
        fetched = asinTitleCache.get(e.asin);
      } else if (fetchedCount < maxFetch) {
        try {
          if (fetchedCount > 0) await sleep(fetchDelayMs);
          fetched = await fetchAmazonTitleByAsin(e.asin);
          fetchedCount += 1;
          asinTitleCache.set(e.asin, fetched);
        } catch (err) {
          fetched = { url: `https://www.amazon.com/dp/${e.asin}`, status: 0, title: '' };
          asinTitleCache.set(e.asin, fetched);
        }
      }

      if (fetched?.title) {
        titleSignals = computeTitleSignals(e.key, fetched.title);
        if (titleSignals.mismatchScore >= 7) problems.push('title_mismatch_suspected');
        if (titleSignals.hasJerkySignal) problems.push('title_contains_jerky');
      }
    }

    if (problems.length) {
      flags.push({
        key: e.key,
        asin: e.asin,
        amazonLink: e.amazonLink,
        productName: e.productName,
        fetchedTitle: fetched?.title || '',
        fetchedStatus: fetched?.status ?? null,
        fetchedUrl: fetched?.url || '',
        titleSignals,
        problems,
      });
    }
  }

  const severity = (p) => {
    if (p.startsWith('asin_shared_with_')) return 3;
    if (p === 'asin_mismatch_vs_product_prices_json') return 3;
    if (p === 'search_url_not_dp') return 2;
    if (p === 'no_asin_in_url') return 2;
    if (p === 'missing_amazonLink') return 2;
    if (p === 'missing_affiliate_tag') return 1;
    if (p === 'key_not_in_ingredient_catalogs') return 1;
    return 1;
  };

  flags.sort((a, b) => {
    const sa = a.problems.reduce((s, p) => s + severity(p), 0);
    const sb = b.problems.reduce((s, p) => s + severity(p), 0);
    return sb - sa;
  });

  const dupList = [];
  for (const [asin, keys] of asinToKeys.entries()) {
    if (keys.length > 1) dupList.push({ asin, keys });
  }
  dupList.sort((a, b) => b.keys.length - a.keys.length);

  console.log('=== Amazon Link Audit ===');
  console.log('Vetted entries parsed:', vettedEntries.length);
  console.log('Unique ALL_INGREDIENTS strings:', allIngredientsSet.size);
  console.log('Unique recipes-complete ingredient names:', recipeIngredientsSet.size);
  console.log('Flagged vetted entries:', flags.length);
  console.log('Duplicate ASINs:', dupList.length);
  if (shouldFetchTitles) {
    console.log('Fetched Amazon titles:', fetchedCount);
  }

  console.log('\n=== Top 60 suspicious entries ===');
  for (const f of flags.slice(0, 60)) {
    console.log(`- ${f.key} | ASIN=${f.asin || ''} | ${f.problems.join(', ')} | ${f.amazonLink || ''}`);
  }

  console.log('\n=== Top ASIN duplicates (first 30) ===');
  for (const d of dupList.slice(0, 30)) {
    console.log(`- ${d.asin} -> ${d.keys.length} keys: ${d.keys.join(' | ')}`);
  }

  // Write machine-readable report
  const outPath = path.join(root, 'data', 'amazon-link-audit-report.json');
  fs.writeFileSync(
    outPath,
    JSON.stringify(
      {
        generatedAt: new Date().toISOString(),
        flags,
        duplicates: dupList,
        fetchTitles: shouldFetchTitles,
        fetchConfig: shouldFetchTitles ? { maxFetch, fetchDelayMs } : null,
      },
      null,
      2
    )
  );
  console.log(`\nWrote JSON report: ${outPath}`);
}

main();
</file>

<file path="scripts/audit-ingredient-protein.ts">
// Quick audit of ingredient protein data
import { INGREDIENT_COMPOSITIONS } from '../lib/data/ingredientCompositions';

const entries = Object.entries(INGREDIENT_COMPOSITIONS);

console.log('='.repeat(80));
console.log('INGREDIENT PROTEIN DATA AUDIT');
console.log('='.repeat(80));
console.log();

// High protein ingredients (15%+)
const highProtein = entries.filter(([_, comp]) => (comp.protein || 0) >= 15);
console.log(`HIGH PROTEIN INGREDIENTS (15%+): ${highProtein.length}`);
highProtein.slice(0, 15).forEach(([name, comp]) => {
  console.log(`  ${name}: ${comp.protein}% protein, ${comp.fat || 0}% fat`);
});
console.log();

// Medium protein (8-15%)
const medProtein = entries.filter(([_, comp]) => {
  const p = comp.protein || 0;
  return p >= 8 && p < 15;
});
console.log(`MEDIUM PROTEIN INGREDIENTS (8-15%): ${medProtein.length}`);
medProtein.slice(0, 10).forEach(([name, comp]) => {
  console.log(`  ${name}: ${comp.protein}% protein`);
});
console.log();

// Low protein (<8%)
const lowProtein = entries.filter(([_, comp]) => (comp.protein || 0) < 8);
console.log(`LOW PROTEIN INGREDIENTS (<8%): ${lowProtein.length}`);
lowProtein.slice(0, 10).forEach(([name, comp]) => {
  console.log(`  ${name}: ${comp.protein || 0}% protein`);
});
console.log();

// Missing protein data
const missingProtein = entries.filter(([_, comp]) => comp.protein === undefined);
console.log(`MISSING PROTEIN DATA: ${missingProtein.length}`);
missingProtein.slice(0, 10).forEach(([name]) => {
  console.log(`  ${name}: NO DATA`);
});
console.log();

console.log('='.repeat(80));
console.log('SUMMARY');
console.log('='.repeat(80));
console.log(`Total ingredients: ${entries.length}`);
console.log(`High protein (15%+): ${highProtein.length} (${((highProtein.length / entries.length) * 100).toFixed(1)}%)`);
console.log(`Medium protein (8-15%): ${medProtein.length} (${((medProtein.length / entries.length) * 100).toFixed(1)}%)`);
console.log(`Low protein (<8%): ${lowProtein.length} (${((lowProtein.length / entries.length) * 100).toFixed(1)}%)`);
console.log(`Missing data: ${missingProtein.length} (${((missingProtein.length / entries.length) * 100).toFixed(1)}%)`);
</file>

<file path="scripts/audit-purchase-links.ts">
// scripts/audit-purchase-links.ts
// Comprehensive audit of all purchase/buy links to ensure:
// 1. Every link has seller ID (robinfrench-20)
// 2. Every link goes to a specific vetted brand (not generic searches)
// 3. All links use vetted products where possible

import * as fs from 'fs';
import * as path from 'path';

const SELLER_ID = 'robinfrench-20';
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const RECIPES_FILE = path.join(__dirname, '../lib/data/recipes-complete.ts');

interface AuditResult {
  ingredient: string;
  location: string;
  link: string;
  hasSellerId: boolean;
  isGenericSearch: boolean;
  isVettedProduct: boolean;
  brand?: string;
  issues: string[];
}

const results: AuditResult[] = [];
const issues: string[] = [];

// Helper to check if URL has seller ID
function hasSellerId(url: string): boolean {
  if (!url) return false;
  return url.includes(`tag=${SELLER_ID}`) || url.includes(`tag=${SELLER_ID}`) || url.includes(`AssociateTag=${SELLER_ID}`);
}

// Helper to check if URL is a generic search (not specific product)
function isGenericSearch(url: string): boolean {
  if (!url) return false;
  // Check for search URLs (not specific product pages)
  return url.includes('/s?k=') || url.includes('/s?') || url.includes('search/') || (!url.includes('/dp/') && !url.includes('/gp/product/') && !url.includes('/product/'));
}

// Extract brand name from product name
function extractBrand(productName: string): string | undefined {
  // Common brand patterns
  const brandPatterns = [
    /^([^']+?)\s+(Freeze Dried|Freeze-Dried|Organic|Raw|Pet Food)/i,
    /^(Fresh Is Best|Bell & Evans|Vital Essentials|Raw Paws|Evanger's|Bob's Red Mill|NOW Foods|Grizzly|Nutiva|Nordic Naturals|Wild Planet|Whole Life Pet|A Better Treat|Wholesome Beast|Stella & Chewy's|Lafeber's|Nature's Touch|Eden Organic|Viva Naturals|California Olive Ranch|Carlson Labs|La Tourangelle|Jarrow Formulas|Zesty Paws|Cascadian Farm|Healthworks)/i,
  ];
  
  for (const pattern of brandPatterns) {
    const match = productName.match(pattern);
    if (match) return match[1].trim();
  }
  
  return undefined;
}

// Audit vetted-products.ts
function auditVettedProducts() {
  console.log('üîç Auditing vetted-products.ts...\n');
  
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  
  // Extract all VETTED_PRODUCTS entries
  const productPattern = /'([^']+)':\s*\{[^}]*asinLink:\s*'([^']+)'[^}]*productName:\s*'([^']+)'/g;
  let match;
  let count = 0;
  
  while ((match = productPattern.exec(content)) !== null) {
    count++;
    const ingredient = match[1];
    const link = match[2];
    const productName = match[3];
    
    const result: AuditResult = {
      ingredient,
      location: 'vetted-products.ts',
      link,
      hasSellerId: hasSellerId(link),
      isGenericSearch: isGenericSearch(link),
      isVettedProduct: true,
      brand: extractBrand(productName),
      issues: [],
    };
    
    if (!result.hasSellerId) {
      result.issues.push('Missing seller ID (robinfrench-20)');
      issues.push(`${ingredient}: Missing seller ID in vetted-products.ts`);
    }
    
    if (result.isGenericSearch) {
      result.issues.push('Generic search URL (not specific product ASIN)');
      issues.push(`${ingredient}: Generic search URL in vetted-products.ts`);
    }
    
    if (!result.brand) {
      result.issues.push('Could not extract brand name');
    }
    
    results.push(result);
  }
  
  console.log(`‚úÖ Audited ${count} entries in vetted-products.ts`);
  return count;
}

// Audit recipes-complete.ts for amazonLink fields
function auditRecipesComplete() {
  console.log('\nüîç Auditing recipes-complete.ts for amazonLink fields...\n');
  
  const content = fs.readFileSync(RECIPES_FILE, 'utf-8');
  
  // Find all amazonLink entries in ingredients
  const linkPattern = /"amazonLink":\s*"([^"]+)"/g;
  let match;
  let count = 0;
  const seenLinks = new Map<string, number>();
  
  while ((match = linkPattern.exec(content)) !== null) {
    count++;
    const link = match[1];
    const lineNumber = (content.substring(0, match.index).match(/\n/g) || []).length + 1;
    
    const key = `${lineNumber}:${link}`;
    if (seenLinks.has(key)) continue;
    seenLinks.set(key, lineNumber);
    
    const result: AuditResult = {
      ingredient: `Recipe ingredient (line ${lineNumber})`,
      location: 'recipes-complete.ts',
      link,
      hasSellerId: hasSellerId(link),
      isGenericSearch: isGenericSearch(link),
      isVettedProduct: false,
      issues: [],
    };
    
    if (!result.hasSellerId) {
      result.issues.push('Missing seller ID (robinfrench-20)');
      issues.push(`Line ${lineNumber}: Missing seller ID in recipes-complete.ts`);
    }
    
    if (result.isGenericSearch) {
      result.issues.push('Generic search URL - should use vetted product with specific ASIN');
      issues.push(`Line ${lineNumber}: Generic search URL - should be replaced with vetted product`);
    }
    
    results.push(result);
  }
  
  console.log(`‚úÖ Found ${count} amazonLink entries in recipes-complete.ts`);
  return count;
}

// Main audit function
function runAudit() {
  console.log('üîç Starting Comprehensive Purchase Links Audit\n');
  console.log('='.repeat(60));
  
  const vettedCount = auditVettedProducts();
  const recipesCount = auditRecipesComplete();
  
  // Summary
  console.log('\n' + '='.repeat(60));
  console.log('üìä AUDIT SUMMARY\n');
  
  const withSellerId = results.filter(r => r.hasSellerId).length;
  const withoutSellerId = results.filter(r => !r.hasSellerId).length;
  const genericSearches = results.filter(r => r.isGenericSearch).length;
  const vettedLinks = results.filter(r => r.isVettedProduct).length;
  const recipeLinks = results.filter(r => !r.isVettedProduct).length;
  
  console.log(`Total links audited: ${results.length}`);
  console.log(`  ‚úì With seller ID: ${withSellerId}`);
  console.log(`  ‚úó Without seller ID: ${withoutSellerId}`);
  console.log(`  ‚úó Generic search URLs: ${genericSearches}`);
  console.log(`  ‚úì Vetted product links: ${vettedLinks}`);
  console.log(`  ‚ö†Ô∏è  Recipe file links (should use vetted products): ${recipeLinks}`);
  
  // Critical issues
  console.log('\nüö® CRITICAL ISSUES:\n');
  if (withoutSellerId > 0) {
    console.log(`‚ùå ${withoutSellerId} links missing seller ID (robinfrench-20)`);
  } else {
    console.log('‚úÖ All links have seller ID');
  }
  
  if (genericSearches > 0) {
    console.log(`‚ùå ${genericSearches} links are generic searches (should be specific ASIN links)`);
  } else {
    console.log('‚úÖ All links point to specific products');
  }
  
  if (recipeLinks > 0) {
    console.log(`‚ö†Ô∏è  ${recipeLinks} links in recipes-complete.ts (should migrate to vetted-products.ts)`);
  } else {
    console.log('‚úÖ All links use vetted products');
  }
  
  // Detailed report
  console.log('\n' + '='.repeat(60));
  console.log('üìã DETAILED ISSUES\n');
  
  if (issues.length === 0) {
    console.log('‚úÖ No issues found! All links are properly configured.');
  } else {
    issues.slice(0, 50).forEach((issue, idx) => {
      console.log(`${idx + 1}. ${issue}`);
    });
    
    if (issues.length > 50) {
      console.log(`\n... and ${issues.length - 50} more issues`);
    }
  }
  
  // Recommendations
  console.log('\n' + '='.repeat(60));
  console.log('üí° RECOMMENDATIONS\n');
  
  if (withoutSellerId > 0) {
    console.log('1. Add seller ID to all links missing it:');
    console.log('   - Update vetted-products.ts to ensure all asinLink entries include ?tag=robinfrench-20');
    console.log('   - Update recipes-complete.ts amazonLink entries to include tag=robinfrench-20');
  }
  
  if (genericSearches > 0) {
    console.log('2. Replace generic search URLs with specific ASIN links:');
    console.log('   - Generic searches (s?k=...) should be replaced with /dp/ASIN links');
    console.log('   - Use vetted-products.ts entries which have specific branded products');
  }
  
  if (recipeLinks > 0) {
    console.log('3. Migrate recipe links to vetted products:');
    console.log('   - recipes-complete.ts should use getVettedProduct() instead of hardcoded amazonLink');
    console.log('   - This ensures all links go through the vetted products system');
  }
  
  // Save detailed report
  const reportFile = path.join(__dirname, '../PURCHASE_LINKS_AUDIT_REPORT.md');
  const report = `# Purchase Links Audit Report
Generated: ${new Date().toISOString()}

## Summary
- Total links audited: ${results.length}
- Links with seller ID: ${withSellerId}
- Links without seller ID: ${withoutSellerId}
- Generic search URLs: ${genericSearches}
- Vetted product links: ${vettedLinks}
- Recipe file links: ${recipeLinks}

## Issues Found
${issues.length > 0 ? issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n') : 'No issues found!'}

## Detailed Results
${results.map(r => `
### ${r.ingredient} (${r.location})
- Link: ${r.link}
- Has Seller ID: ${r.hasSellerId ? '‚úÖ' : '‚ùå'}
- Generic Search: ${r.isGenericSearch ? '‚ùå' : '‚úÖ'}
- Brand: ${r.brand || 'Unknown'}
- Issues: ${r.issues.length > 0 ? r.issues.join(', ') : 'None'}
`).join('\n')}
`;
  
  fs.writeFileSync(reportFile, report);
  console.log(`\nüíæ Detailed report saved to: ${reportFile}`);
  
  return {
    total: results.length,
    withSellerId,
    withoutSellerId,
    genericSearches,
    vettedLinks,
    recipeLinks,
    issues: issues.length,
  };
}

// Run the audit
try {
  const summary = runAudit();
  console.log('\n‚úÖ Audit complete!');
  process.exit(summary.withoutSellerId > 0 || summary.genericSearches > 0 ? 1 : 0);
} catch (error) {
  console.error('‚ùå Error running audit:', error);
  process.exit(1);
}
</file>

<file path="scripts/audit-vetted-products.ts">
// scripts/audit-vetted-products.ts
// Comprehensive audit of vetted-products.ts to ensure:
// 1. Every asinLink has seller ID (robinfrench-20)
// 2. Every asinLink is a specific ASIN link (not generic search)
// 3. Every entry has a brand/productName

import * as fs from 'fs';
import * as path from 'path';

const SELLER_ID = 'robinfrench-20';
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');

interface AuditResult {
  ingredient: string;
  link: string;
  hasSellerId: boolean;
  isSpecificASIN: boolean;
  hasBrand: boolean;
  issues: string[];
  lineNumber: number;
}

const results: AuditResult[] = [];
const issues: string[] = [];

// Helper to check if URL has seller ID
function hasSellerId(url: string): boolean {
  if (!url) return false;
  return url.includes(`tag=${SELLER_ID}`) || url.includes(`AssociateTag=${SELLER_ID}`);
}

// Helper to check if URL is a specific ASIN link (not generic search)
function isSpecificASIN(url: string): boolean {
  if (!url) return false;
  // Must contain /dp/ASIN or /gp/product/ASIN pattern
  return /\/dp\/[A-Z0-9]{10}|\/gp\/product\/[A-Z0-9]{10}/.test(url);
}

// Extract ASIN from URL
function extractASIN(url: string): string | null {
  const match = url.match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
  return match ? match[1] : null;
}

// Main audit function
function auditVettedProducts() {
  console.log('üîç Auditing vetted-products.ts...\n');
  
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  const lines = content.split('\n');
  
  // Find all ingredient entries with their properties
  // Pattern: 'ingredient-name': { ... properties ... }
  let currentIngredient: string | null = null;
  let currentLink: string | null = null;
  let currentProductName: string | null = null;
  let inProductBlock = false;
  let braceDepth = 0;
  let startLine = 0;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const lineNum = i + 1;
    
    // Detect start of ingredient entry
    const ingredientMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (ingredientMatch) {
      currentIngredient = ingredientMatch[1];
      inProductBlock = true;
      braceDepth = 1;
      startLine = lineNum;
      currentLink = null;
      currentProductName = null;
      continue;
    }
    
    if (inProductBlock) {
      // Track brace depth
      braceDepth += (line.match(/\{/g) || []).length;
      braceDepth -= (line.match(/\}/g) || []).length;
      
      // Extract asinLink
      const asinMatch = line.match(/asinLink:\s*'([^']+)'/);
      if (asinMatch) {
        currentLink = asinMatch[1];
      }
      
      // Extract productName
      const productMatch = line.match(/productName:\s*'([^']+)'/);
      if (productMatch) {
        currentProductName = productMatch[1];
      }
      
      // End of product block
      if (braceDepth === 0) {
        if (currentIngredient && currentLink) {
          const result: AuditResult = {
            ingredient: currentIngredient,
            link: currentLink,
            hasSellerId: hasSellerId(currentLink),
            isSpecificASIN: isSpecificASIN(currentLink),
            hasBrand: !!currentProductName,
            issues: [],
            lineNumber: startLine,
          };
          
          if (!result.hasSellerId) {
            result.issues.push('Missing seller ID (robinfrench-20)');
            issues.push(`${currentIngredient} (line ${startLine}): Missing seller ID`);
          }
          
          if (!result.isSpecificASIN) {
            result.issues.push('Not a specific ASIN link (appears to be generic search)');
            issues.push(`${currentIngredient} (line ${startLine}): Generic search URL, not specific ASIN`);
          }
          
          if (!result.hasBrand) {
            result.issues.push('Missing productName');
          }
          
          results.push(result);
        }
        
        // Reset
        currentIngredient = null;
        currentLink = null;
        currentProductName = null;
        inProductBlock = false;
      }
    }
  }
  
  console.log(`‚úÖ Audited ${results.length} entries in vetted-products.ts\n`);
  return results.length;
}

// Main execution
function runAudit() {
  console.log('üîç Starting Vetted Products Audit\n');
  console.log('='.repeat(60));
  
  const count = auditVettedProducts();
  
  // Summary
  console.log('='.repeat(60));
  console.log('üìä AUDIT SUMMARY\n');
  
  const withSellerId = results.filter(r => r.hasSellerId).length;
  const withoutSellerId = results.filter(r => !r.hasSellerId).length;
  const specificASINs = results.filter(r => r.isSpecificASIN).length;
  const genericSearches = results.filter(r => !r.isSpecificASIN).length;
  const withBrands = results.filter(r => r.hasBrand).length;
  const withoutBrands = results.filter(r => !r.hasBrand).length;
  
  console.log(`Total entries audited: ${count}`);
  console.log(`  ‚úì With seller ID: ${withSellerId}`);
  console.log(`  ‚úó Without seller ID: ${withoutSellerId}`);
  console.log(`  ‚úì Specific ASIN links: ${specificASINs}`);
  console.log(`  ‚úó Generic search URLs: ${genericSearches}`);
  console.log(`  ‚úì With productName: ${withBrands}`);
  console.log(`  ‚úó Without productName: ${withoutBrands}`);
  
  // Critical issues
  console.log('\nüö® CRITICAL ISSUES:\n');
  if (withoutSellerId > 0) {
    console.log(`‚ùå ${withoutSellerId} entries missing seller ID (robinfrench-20)`);
    console.log('\nEntries missing seller ID:');
    results.filter(r => !r.hasSellerId).slice(0, 20).forEach(r => {
      console.log(`  - ${r.ingredient} (line ${r.lineNumber})`);
    });
    if (withoutSellerId > 20) {
      console.log(`  ... and ${withoutSellerId - 20} more`);
    }
  } else {
    console.log('‚úÖ All entries have seller ID');
  }
  
  if (genericSearches > 0) {
    console.log(`\n‚ùå ${genericSearches} entries use generic search URLs (should be specific ASIN links)`);
    console.log('\nEntries with generic search URLs:');
    results.filter(r => !r.isSpecificASIN).slice(0, 20).forEach(r => {
      console.log(`  - ${r.ingredient} (line ${r.lineNumber}): ${r.link.substring(0, 80)}...`);
    });
    if (genericSearches > 20) {
      console.log(`  ... and ${genericSearches - 20} more`);
    }
  } else {
    console.log('‚úÖ All entries use specific ASIN links');
  }
  
  // Save detailed report
  const reportFile = path.join(__dirname, '../VETTED_PRODUCTS_AUDIT_REPORT.md');
  const report = `# Vetted Products Audit Report
Generated: ${new Date().toISOString()}

## Summary
- Total entries audited: ${count}
- With seller ID: ${withSellerId}
- Without seller ID: ${withoutSellerId}
- Specific ASIN links: ${specificASINs}
- Generic search URLs: ${genericSearches}
- With productName: ${withBrands}
- Without productName: ${withoutBrands}

## Issues Found
${issues.length > 0 ? issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n') : 'No issues found!'}

## Detailed Results

${results.filter(r => r.issues.length > 0).map(r => `
### ${r.ingredient} (line ${r.lineNumber})
- Link: ${r.link}
- Has Seller ID: ${r.hasSellerId ? '‚úÖ' : '‚ùå'}
- Specific ASIN: ${r.isSpecificASIN ? '‚úÖ' : '‚ùå'}
- Has Brand: ${r.hasBrand ? '‚úÖ' : '‚ùå'}
- Issues: ${r.issues.join(', ')}
`).join('\n')}

## All Entries

${results.map(r => `
### ${r.ingredient} (line ${r.lineNumber})
- Link: ${r.link}
- ASIN: ${extractASIN(r.link) || 'N/A'}
- Has Seller ID: ${r.hasSellerId ? '‚úÖ' : '‚ùå'}
- Specific ASIN: ${r.isSpecificASIN ? '‚úÖ' : '‚ùå'}
- Product Name: ${results.find(res => res.ingredient === r.ingredient)?.hasBrand ? 'Yes' : 'No'}
`).join('\n')}
`;
  
  fs.writeFileSync(reportFile, report);
  console.log(`\nüíæ Detailed report saved to: ${reportFile}`);
  
  return {
    total: count,
    withSellerId,
    withoutSellerId,
    specificASINs,
    genericSearches,
    issues: issues.length,
  };
}

// Run the audit
try {
  const summary = runAudit();
  console.log('\n‚úÖ Audit complete!');
  process.exit(summary.withoutSellerId > 0 || summary.genericSearches > 0 ? 1 : 0);
} catch (error) {
  console.error('‚ùå Error running audit:', error);
  process.exit(1);
}
</file>

<file path="scripts/auto-correct-asins.ts">
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * AUTOMATED ASIN VERIFICATION & CORRECTION SYSTEM
 *
 * This script will:
 * 1. Read your vetted-products.txt file
 * 2. Extract all ASINs and check if they're valid
 * 3. Search Amazon for better matches automatically
 * 4. Generate a corrected file with proper ASINs
 * 5. Create a report of all changes made
 */

interface VettedProduct {
  productName: string;
  amazonLink: string;
  chewyLink?: string;
  vetNote: string;
  category?: string;
  commissionRate?: number;
}

interface ProductEntry {
  ingredient: string;
  product: VettedProduct;
  asin: string;
  lineNumber: number;
}

interface SearchResult {
  asin: string;
  title: string;
  price: string;
  rating: number;
  reviews: number;
  matchScore: number; // 0-100
}

// ============================================================================
// STEP 1: Parse the vetted-products.txt file
// ============================================================================

function parseVettedProductsFile(filePath: string): ProductEntry[] {
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const entries: ProductEntry[] = [];

  // Match ingredient entries like: 'ground chicken': {
  const ingredientRegex = /'([^']+)':\s*{/g;
  const asinRegex = /\/dp\/([A-Z0-9]{10})/;

  let match;
  let lineNumber = 0;
  const lines = fileContent.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);

    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];

      // Extract the full product object (multi-line)
      let productBlock = '';
      let braceCount = 1;
      let j = i + 1;

      while (j < lines.length && braceCount > 0) {
        productBlock += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }

      // Extract ASIN from amazonLink
      const asinMatch = productBlock.match(asinRegex);
      const asin = asinMatch ? asinMatch[1] : 'UNKNOWN';

      // Extract productName
      const productNameMatch = productBlock.match(/productName:\s*'([^']+)'/);
      const productName = productNameMatch ? productNameMatch[1] : '';

      // Extract vetNote
      const vetNoteMatch = productBlock.match(/vetNote:\s*'([^']+)'/);
      const vetNote = vetNoteMatch ? vetNoteMatch[1] : '';

      entries.push({
        ingredient,
        product: {
          productName,
          amazonLink: `https://www.amazon.com/dp/${asin}?tag=robinfrench-20`,
          vetNote,
        },
        asin,
        lineNumber: i + 1
      });
    }
  }

  return entries;
}

// ============================================================================
// STEP 2: Automated Amazon Search (real API integration)
// ============================================================================

async function searchAmazonForProduct(ingredient: string): Promise<SearchResult[]> {
  console.log(`  üîç Searching Amazon for: "${ingredient}"`);

  // Import the real Amazon search function
  const { searchAmazonForProduct: amazonSearch } = await import('./amazon-api-search.js');

  try {
    const amazonResults = await amazonSearch(ingredient);

    // Convert Amazon API format to our SearchResult format
    return amazonResults.slice(0, 5).map((result: any) => ({
      asin: result.ASIN,
      title: result.Title || result.ItemInfo?.Title?.DisplayValue || 'Unknown Product',
      price: result.Offers?.Listings?.[0]?.Price?.DisplayAmount || '$0.00',
      rating: result.CustomerReviews?.StarRating?.DisplayValue || 0,
      reviews: result.CustomerReviews?.Count || 0,
      matchScore: calculateMatchScore(ingredient, result.Title || result.ItemInfo?.Title?.DisplayValue || '')
    }));

  } catch (error) {
    console.log(`  ‚ùå Amazon search failed: ${error}`);
    console.log('  üîÑ Using fallback mock data...');

    // Fallback to mock data if API fails
    return [
      {
        asin: 'B08NEWPRODUCT',
        title: `Premium ${ingredient} for Dogs - Human Grade`,
        price: '$24.99',
        rating: 4.7,
        reviews: 1234,
        matchScore: 95
      },
      {
        asin: 'B07GOODMATCH',
        title: `Organic ${ingredient} - Pet Safe`,
        price: '$19.99',
        rating: 4.5,
        reviews: 856,
        matchScore: 88
      },
      {
        asin: 'B06OKAYMATCH',
        title: `${ingredient} Dog Food Ingredient`,
        price: '$15.99',
        rating: 4.3,
        reviews: 456,
        matchScore: 75
      }
    ];
  }
}

// ============================================================================
// STEP 3: Intelligent Matching Algorithm
// ============================================================================

function calculateMatchScore(ingredient: string, productTitle: string): number {
  /**
   * Score based on:
   * - Exact ingredient name match
   * - Contains "dog" or "pet"
   * - Contains quality indicators (organic, premium, human-grade)
   * - Avoids suspicious terms (mix, blend, variety)
   */

  let score = 0;
  const titleLower = productTitle.toLowerCase();
  const ingredientLower = ingredient.toLowerCase();

  // Exact ingredient match (50 points)
  if (titleLower.includes(ingredientLower)) {
    score += 50;
  } else {
    // Partial match (25 points)
    const ingredientWords = ingredientLower.split(' ');
    const matchingWords = ingredientWords.filter(word => titleLower.includes(word));
    score += (matchingWords.length / ingredientWords.length) * 25;
  }

  // Pet-specific (20 points)
  if (titleLower.includes('dog') || titleLower.includes('pet')) score += 20;

  // Quality indicators (10 points each)
  if (titleLower.includes('organic')) score += 10;
  if (titleLower.includes('premium') || titleLower.includes('human grade')) score += 10;
  if (titleLower.includes('freeze dried') || titleLower.includes('raw')) score += 5;

  // Penalties
  if (titleLower.includes('mix') || titleLower.includes('blend')) score -= 20;
  if (titleLower.includes('variety pack')) score -= 30;

  return Math.max(0, Math.min(100, score));
}

// ============================================================================
// STEP 4: Automated Correction Logic
// ============================================================================

interface CorrectionResult {
  ingredient: string;
  oldASIN: string;
  newASIN: string;
  oldProductName: string;
  newProductName: string;
  confidence: 'high' | 'medium' | 'low';
  reason: string;
}

async function autoCorrectASINs(entries: ProductEntry[]): Promise<CorrectionResult[]> {
  const corrections: CorrectionResult[] = [];

  console.log(`\nü§ñ Starting automated ASIN verification for ${entries.length} products...\n`);

  for (let i = 0; i < entries.length; i++) {
    const entry = entries[i];
    console.log(`[${i + 1}/${entries.length}] ${entry.ingredient}`);

    try {
      // Search for better matches
      const searchResults = await searchAmazonForProduct(entry.ingredient);

      // Check if we got results
      if (searchResults.length === 0) {
        console.log(`  ‚ö†Ô∏è  No search results found for "${entry.ingredient}"`);
        continue;
      }

      // Get best match
      const bestMatch = searchResults[0];

      if (!bestMatch || !bestMatch.matchScore) {
        console.log(`  ‚ö†Ô∏è  Invalid search result format`);
        continue;
      }

      // Calculate match score for current product
      const currentScore = calculateMatchScore(entry.ingredient, entry.product.productName);

      // Decide if we should replace
      if (bestMatch.matchScore > currentScore + 10) { // 10 point threshold
        corrections.push({
          ingredient: entry.ingredient,
          oldASIN: entry.asin,
          newASIN: bestMatch.asin,
          oldProductName: entry.product.productName,
          newProductName: bestMatch.title,
          confidence: bestMatch.matchScore > 85 ? 'high' : bestMatch.matchScore > 70 ? 'medium' : 'low',
          reason: `Better match found (score: ${bestMatch.matchScore} vs ${currentScore})`
        });
        console.log(`  ‚úÖ CORRECTION: ${entry.asin} ‚Üí ${bestMatch.asin} (score: ${bestMatch.matchScore})`);
      } else {
        console.log(`  ‚úì Current ASIN looks good (score: ${currentScore})`);
      }

      // Respectful delay between searches
      await new Promise(resolve => setTimeout(resolve, 1000));

    } catch (error) {
      console.log(`  ‚ùå Error processing ${entry.ingredient}: ${error}`);
      continue;
    }
  }

  return corrections;
}

// ============================================================================
// STEP 5: Generate Corrected File
// ============================================================================

function generateCorrectedFile(
  originalPath: string,
  corrections: CorrectionResult[]
): string {
  let content = fs.readFileSync(originalPath, 'utf-8');

  // Apply each correction
  for (const correction of corrections) {
    // Replace ASIN in amazonLink
    const oldLink = `https://www.amazon.com/dp/${correction.oldASIN}`;
    const newLink = `https://www.amazon.com/dp/${correction.newASIN}`;
    content = content.replace(oldLink, newLink);

    // Replace product name
    content = content.replace(
      `productName: '${correction.oldProductName}'`,
      `productName: '${correction.newProductName}'`
    );
  }

  return content;
}

// ============================================================================
// STEP 6: Generate Report
// ============================================================================

function generateReport(corrections: CorrectionResult[]): string {
  let report = `# ASIN Correction Report
Generated: ${new Date().toISOString()}
Total Corrections: ${corrections.length}

## Summary by Confidence Level
- High Confidence: ${corrections.filter(c => c.confidence === 'high').length}
- Medium Confidence: ${corrections.filter(c => c.confidence === 'medium').length}
- Low Confidence: ${corrections.filter(c => c.confidence === 'low').length}

## Detailed Corrections

`;

  corrections.forEach((c, i) => {
    report += `### ${i + 1}. ${c.ingredient}
**Confidence:** ${c.confidence.toUpperCase()}
**Reason:** ${c.reason}

- **OLD:** ${c.oldProductName} (${c.oldASIN})
- **NEW:** ${c.newProductName} (${c.newASIN})

---

`;
  });

  return report;
}

// ============================================================================
// MAIN EXECUTION
// ============================================================================

async function main() {
  const inputFile = path.join(__dirname, '../lib/data/vetted-products.txt');
  const outputFile = path.join(__dirname, '../lib/data/vetted-products-CORRECTED.txt');
  const reportFile = path.join(__dirname, '../ASIN-CORRECTION-REPORT.md');

  console.log('üöÄ AUTOMATED ASIN CORRECTION SYSTEM\n');
  console.log('üìÅ Input:', inputFile);
  console.log('üìÅ Output:', outputFile);
  console.log('üìÅ Report:', reportFile);

  try {
    // Step 1: Parse file
    console.log('\nüìñ Step 1: Parsing vetted-products.txt...');
    const entries = parseVettedProductsFile(inputFile);
    console.log(`‚úÖ Found ${entries.length} products`);

    // Step 2: Auto-correct ASINs
    console.log('\nüîß Step 2: Running automated corrections...');
    const corrections = await autoCorrectASINs(entries);
    console.log(`\n‚úÖ Generated ${corrections.length} corrections`);

    // Step 3: Generate corrected file
    console.log('\nüíæ Step 3: Generating corrected file...');
    const correctedContent = generateCorrectedFile(inputFile, corrections);
    fs.writeFileSync(outputFile, correctedContent);
    console.log(`‚úÖ Saved to: ${outputFile}`);

    // Step 4: Generate report
    console.log('\nüìä Step 4: Generating report...');
    const report = generateReport(corrections);
    fs.writeFileSync(reportFile, report);
    console.log(`‚úÖ Saved to: ${reportFile}`);

    console.log('\nüéâ DONE! Review the report and test the corrected file.');
    console.log('\n‚ö†Ô∏è  IMPORTANT: This used simulated Amazon data.');
    console.log('    To make this work for real, integrate Amazon Product API.');

  } catch (error) {
    console.error('‚ùå ERROR:', error);
    process.exit(1);
  }
}

// Run it!
main();
</file>

<file path="scripts/auto-tag-recipes.ts">
// scripts/auto-tag-recipes.ts
// Enhanced auto-tagging script for all health concerns including new ones

import * as fs from 'fs';
import * as path from 'path';
import { recipes } from '../lib/data/recipes-complete';

interface Recipe {
  id: string;
  name: string;
  ingredients: Array<{ name: string; amount?: string }>;
  category?: string;
  healthConcerns?: string[];
  notSuitableFor?: string[];
  [key: string]: any;
}

// Enhanced tagging function with comprehensive health concern detection
function autoTagRecipe(recipe: Recipe): { healthConcerns: string[]; notSuitableFor: string[] } {
  const name = recipe.name.toLowerCase();
  const ingredients = recipe.ingredients
    ?.map((i) => (typeof i === 'string' ? i : i.name || '').toLowerCase())
    .join(' ') || '';
  
  const allText = `${name} ${ingredients}`;
  const category = recipe.category?.toLowerCase() || '';

  const healthConcerns: string[] = [];
  const notSuitableFor: string[] = [];

  // DIGESTIVE ISSUES - Bland, easily digestible
  if (
    (allText.includes('chicken') && allText.includes('rice')) ||
    allText.includes('pumpkin') ||
    allText.includes('bone broth') ||
    name.includes('bland') ||
    name.includes('sensitive') ||
    name.includes('digestive')
  ) {
    healthConcerns.push('digestive-issues');
  }

  // JOINT HEALTH - Omega-3 rich
  if (
    allText.includes('salmon') ||
    allText.includes('fish oil') ||
    allText.includes('omega') ||
    allText.includes('sardine') ||
    allText.includes('mackerel') ||
    name.includes('joint') ||
    name.includes('arthritis')
  ) {
    healthConcerns.push('joint-health');
  }

  // KIDNEY DISEASE - Avoid high phosphorus
  if (
    allText.includes('liver') ||
    allText.includes('kidney') ||
    allText.includes('organ meat') ||
    allText.includes('organ') ||
    (allText.includes('beef') && allText.includes('liver'))
  ) {
    notSuitableFor.push('kidney-disease');
  } else if (
    allText.includes('white fish') ||
    allText.includes('egg white') ||
    allText.includes('low-sodium') ||
    (allText.includes('chicken') && !allText.includes('liver'))
  ) {
    // Good for kidney disease
    healthConcerns.push('kidney-disease');
  }

  // WEIGHT MANAGEMENT / OBESITY - Low calorie, lean
  if (
    allText.includes('lean') ||
    allText.includes('low-fat') ||
    allText.includes('low-calorie') ||
    allText.includes('diet') ||
    name.includes('weight') ||
    name.includes('slim') ||
    name.includes('lean') ||
    (allText.includes('turkey') && allText.includes('lean')) ||
    allText.includes('green beans') ||
    allText.includes('cauliflower')
  ) {
    healthConcerns.push('weight-management');
  }

  // PANCREATITIS - Ultra low fat, easily digestible
  const hasHighFat = 
    allText.includes('salmon') ||
    allText.includes('pork') ||
    allText.includes('lamb') ||
    allText.includes('duck') ||
    allText.includes('fatty') ||
    allText.includes('oil') ||
    allText.includes('beef') && !allText.includes('lean');
  
  if (hasHighFat) {
    notSuitableFor.push('pancreatitis');
  } else if (
    allText.includes('lean') ||
    allText.includes('low-fat') ||
    allText.includes('white fish') ||
    allText.includes('turkey breast') ||
    allText.includes('chicken breast') ||
    (allText.includes('chicken') && !allText.includes('thigh'))
  ) {
    healthConcerns.push('pancreatitis');
  }

  // HEART DISEASE - Low sodium, taurine-rich
  if (
    allText.includes('low-sodium') ||
    allText.includes('taurine') ||
    allText.includes('heart') ||
    name.includes('heart') ||
    (allText.includes('chicken') && allText.includes('breast')) ||
    (allText.includes('turkey') && allText.includes('breast'))
  ) {
    healthConcerns.push('heart-disease');
  } else if (
    allText.includes('high-sodium') ||
    allText.includes('processed') ||
    allText.includes('sodium') && !allText.includes('low-sodium')
  ) {
    notSuitableFor.push('heart-disease');
  }

  // DIABETES - Low glycemic, high protein, complex carbs
  const hasSimpleCarbs = 
    allText.includes('white rice') ||
    allText.includes('corn syrup') ||
    allText.includes('sugar') ||
    allText.includes('honey');
  
  if (hasSimpleCarbs) {
    notSuitableFor.push('diabetes');
  } else if (
    allText.includes('complex') ||
    allText.includes('high-fiber') ||
    allText.includes('low-glycemic') ||
    (allText.includes('sweet potato') && !allText.includes('white rice')) ||
    allText.includes('quinoa') ||
    allText.includes('brown rice') ||
    name.includes('diabetic') ||
    name.includes('diabetes')
  ) {
    healthConcerns.push('diabetes');
  }

  // SKIN CONDITIONS - Omega-3, quality protein, vitamin E
  if (
    allText.includes('salmon') ||
    allText.includes('fish oil') ||
    allText.includes('omega') ||
    allText.includes('sardine') ||
    allText.includes('vitamin e') ||
    allText.includes('zinc') ||
    (allText.includes('quality') && allText.includes('protein')) ||
    name.includes('skin') ||
    name.includes('coat')
  ) {
    healthConcerns.push('skin-conditions');
  } else if (
    allText.includes('artificial') ||
    allText.includes('preservatives') ||
    allText.includes('color')
  ) {
    notSuitableFor.push('skin-conditions');
  }

  // ALLERGIES - Novel proteins
  if (
    allText.includes('rabbit') ||
    allText.includes('duck') ||
    allText.includes('venison') ||
    allText.includes('bison') ||
    allText.includes('kangaroo') ||
    allText.includes('novel') ||
    name.includes('hypoallergenic') ||
    name.includes('allergy')
  ) {
    healthConcerns.push('allergies');
  } else if (
    allText.includes('chicken') && allText.includes('beef') ||
    allText.includes('dairy') ||
    allText.includes('wheat') ||
    allText.includes('corn') ||
    allText.includes('soy')
  ) {
    // Common allergens - mark as not suitable if recipe contains multiple
    const allergenCount = [
      allText.includes('chicken'),
      allText.includes('beef'),
      allText.includes('dairy'),
      allText.includes('wheat'),
      allText.includes('corn'),
      allText.includes('soy')
    ].filter(Boolean).length;
    
    if (allergenCount >= 2) {
      notSuitableFor.push('allergies');
    }
  }

  // DENTAL ISSUES - Soft foods
  if (
    allText.includes('stew') ||
    allText.includes('soft') ||
    allText.includes('wet') ||
    allText.includes('puree') ||
    name.includes('senior') ||
    name.includes('dental') ||
    name.includes('soft')
  ) {
    healthConcerns.push('dental-issues');
  }

  // URINARY HEALTH - High moisture, low phosphorus
  if (
    allText.includes('bone broth') ||
    allText.includes('cranberry') ||
    allText.includes('moisture') ||
    allText.includes('hydration') ||
    name.includes('urinary')
  ) {
    healthConcerns.push('urinary-health');
  }

  // Remove duplicates
  const uniqueHealthConcerns = [...new Set(healthConcerns)];
  const uniqueNotSuitable = [...new Set(notSuitableFor)];

  return {
    healthConcerns: uniqueHealthConcerns,
    notSuitableFor: uniqueNotSuitable
  };
}

// Main function
async function main() {
  console.log('üè∑Ô∏è  Enhanced Auto-Tagging Recipes...\n');

  const recipesPath = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.ts');
  const backupPath = recipesPath.replace('.ts', '.backup.ts');
  
  // Create backup
  if (fs.existsSync(recipesPath)) {
    fs.copyFileSync(recipesPath, backupPath);
    console.log('‚úÖ Backup created:', backupPath);
  }

  console.log('üìù Analyzing and tagging recipes...\n');

  const tagStats: Record<string, number> = {};
  const notSuitableStats: Record<string, number> = {};
  let taggedCount = 0;
  let updatedCount = 0;

  // Process each recipe
  const updatedRecipes = recipes.map((recipe: Recipe) => {
    const tags = autoTagRecipe(recipe);
    
    // Only update if we found tags
    if (tags.healthConcerns.length > 0 || tags.notSuitableFor.length > 0) {
      taggedCount++;
      
      // Merge with existing tags
      const existingHealthConcerns = recipe.healthConcerns || [];
      const existingNotSuitable = recipe.notSuitableFor || [];
      
      const mergedHealthConcerns = [...new Set([...existingHealthConcerns, ...tags.healthConcerns])];
      const mergedNotSuitable = [...new Set([...existingNotSuitable, ...tags.notSuitableFor])];
      
      // Count tags
      tags.healthConcerns.forEach(tag => {
        tagStats[tag] = (tagStats[tag] || 0) + 1;
      });
      tags.notSuitableFor.forEach(tag => {
        notSuitableStats[tag] = (notSuitableStats[tag] || 0) + 1;
      });
      
      // Log if new tags were added
      const hasNewTags = 
        mergedHealthConcerns.length > existingHealthConcerns.length ||
        mergedNotSuitable.length > existingNotSuitable.length;
      
      if (hasNewTags) {
        updatedCount++;
        console.log(`‚úì ${recipe.name}`);
        if (tags.healthConcerns.length > 0) {
          console.log(`  + Health: ${tags.healthConcerns.join(', ')}`);
        }
        if (tags.notSuitableFor.length > 0) {
          console.log(`  - Avoid: ${tags.notSuitableFor.join(', ')}`);
        }
        console.log('');
      }
      
      return {
        ...recipe,
        healthConcerns: mergedHealthConcerns,
        notSuitableFor: mergedNotSuitable
      };
    }
    
    return recipe;
  });

  // Write updated recipes to file
  const output = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Auto-tagged on: ${new Date().toISOString()}
// Total recipes: ${updatedRecipes.length}

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(updatedRecipes, null, 2)};
`;

  fs.writeFileSync(recipesPath, output, 'utf8');

  console.log('\nüéâ Tagging Complete!\n');
  console.log(`üìä Statistics:`);
  console.log(`   Total recipes processed: ${recipes.length}`);
  console.log(`   Recipes with tags: ${taggedCount}`);
  console.log(`   Recipes updated: ${updatedCount}`);
  console.log(`\n   Health Concern Tags:`);
  Object.entries(tagStats)
    .sort(([, a], [, b]) => b - a)
    .forEach(([tag, count]) => {
      console.log(`   + ${tag}: ${count} recipes`);
    });
  
  if (Object.keys(notSuitableStats).length > 0) {
    console.log(`\n   Not Suitable For:`);
    Object.entries(notSuitableStats)
      .sort(([, a], [, b]) => b - a)
      .forEach(([tag, count]) => {
        console.log(`   - ${tag}: ${count} recipes`);
      });
  }

  console.log('\n‚úÖ File updated: lib/data/recipes-complete.ts');
  console.log('üîÑ Restart your dev server to see changes');
}

main().catch(console.error);
</file>

<file path="scripts/buildIngredients.js">
// scripts/buildIngredients.js
// Processes all scraped results into a curated ingredient import file
// Dedupes, normalizes, and auto-tags ingredients based on source

const fs = require('fs');
const path = require('path');

/**
 * Infer subtype tags from source name/URL
 */
function inferSubtypesFromSource(source, category) {
  const subtypes = new Set();
  const sourceLower = (source || '').toLowerCase();
  const categoryLower = (category || '').toLowerCase();
  
  // Bird sources
  if (sourceLower.includes('lafeber') || 
      sourceLower.includes('aav') || 
      sourceLower.includes('avian') ||
      sourceLower.includes('parrots.org') ||
      sourceLower.includes('parrot')) {
    subtypes.add('bird_large');
  }
  
  if (sourceLower.includes('birdforum') || 
      sourceLower.includes('r/birdfood') ||
      sourceLower.includes('budgie') ||
      sourceLower.includes('cockatiel') ||
      sourceLower.includes('canary') ||
      sourceLower.includes('finch')) {
    subtypes.add('bird_small');
    subtypes.add('bird_large'); // Small bird sources often apply to large too
  }
  
  if (categoryLower.includes('bird')) {
    subtypes.add('bird_small');
    subtypes.add('bird_large');
  }
  
  // Reptile sources
  if (sourceLower.includes('california academy') || 
      sourceLower.includes('herpetology') ||
      sourceLower.includes('reptifiles') ||
      sourceLower.includes('reptiles magazine') ||
      sourceLower.includes('beardeddragon')) {
    subtypes.add('reptile_herbivore');
    subtypes.add('reptile_omnivore');
  }
  
  if (sourceLower.includes('leopardgecko') || 
      sourceLower.includes('gecko') ||
      sourceLower.includes('insectivore')) {
    subtypes.add('reptile_insectivore');
  }
  
  if (sourceLower.includes('snake') || 
      sourceLower.includes('python') ||
      sourceLower.includes('carnivore')) {
    subtypes.add('reptile_carnivore');
  }
  
  if (categoryLower.includes('reptile')) {
    // Default to all reptile subtypes if category matches
    subtypes.add('reptile_herbivore');
    subtypes.add('reptile_omnivore');
    subtypes.add('reptile_insectivore');
  }
  
  // Pocket pet sources
  if (sourceLower.includes('house rabbit') || 
      sourceLower.includes('rabbit.org') ||
      sourceLower.includes('rabbitforum') ||
      sourceLower.includes('r/rabbits')) {
    subtypes.add('pocket_hay');
  }
  
  if (sourceLower.includes('guineapig') || 
      sourceLower.includes('guinea pig') ||
      sourceLower.includes('cavy')) {
    subtypes.add('pocket_hay');
  }
  
  if (sourceLower.includes('hamster') || 
      sourceLower.includes('gerbil') ||
      sourceLower.includes('rat') ||
      sourceLower.includes('mouse')) {
    subtypes.add('pocket_varied');
  }
  
  if (sourceLower.includes('chinchilla')) {
    subtypes.add('pocket_hay');
  }
  
  if (sourceLower.includes('ferret')) {
    subtypes.add('pocket_carnivore');
  }
  
  if (sourceLower.includes('hedgehog')) {
    subtypes.add('pocket_insectivore');
  }
  
  if (categoryLower.includes('pocket')) {
    // Default to all pocket pet subtypes if category matches
    subtypes.add('pocket_hay');
    subtypes.add('pocket_varied');
  }
  
  return Array.from(subtypes);
}

/**
 * Normalize ingredient name to ID
 */
function normalizeIngredientName(name) {
  if (!name || typeof name !== 'string') return null;
  
  return name.toLowerCase()
    .replace(/[^a-z0-9\s]/g, '') // Remove special chars
    .replace(/\s+/g, '_') // Spaces to underscores
    .replace(/_+/g, '_') // Multiple underscores to single
    .replace(/^_|_$/g, '') // Trim underscores
    .trim();
}

/**
 * Detect ingredient category
 */
function detectCategory(name) {
  if (!name) return 'other';
  
  const lower = name.toLowerCase();
  
  // Protein detection
  if (lower.match(/\b(chicken|turkey|beef|lamb|fish|salmon|tuna|meat|protein|pork|duck|organ|heart|liver|kidney|giblet)\b/)) {
    return 'protein';
  }
  
  // Insect detection
  if (lower.match(/\b(cricket|mealworm|roach|dubia|insect|superworm|hornworm|silkworm|waxworm|phoenix|black.*soldier.*fly|locust|mantid|fruit.*fly)\b/)) {
    return 'insect';
  }
  
  // Vegetable detection
  if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|squash|vegetable|green|collard|mustard|turnip|dandelion|arugula|endive|escarole|bok.*choy|cabbage|celery|asparagus|fennel|parsley|cilantro|basil|mint|thyme|oregano|sage|rosemary|zucchini|cucumber|eggplant|leek|shallot|radicchio|frisee|mache|watercress|purslane|swiss.*chard|beet.*green)\b/)) {
    return 'vegetable';
  }
  
  // Fruit detection
  if (lower.match(/\b(apple|berry|mango|papaya|banana|fruit|grape|melon|cantaloupe|honeydew|watermelon|pineapple|kiwi|raspberry|blackberry|cranberry|cherry|pear|peach|plum|apricot|fig|date|raisin|currant|goji|mulberry|elderberry|strawberry|blueberry)\b/)) {
    return 'fruit';
  }
  
  // Grain/Seed detection
  if (lower.match(/\b(rice|oats|quinoa|barley|wheat|grain|seed|millet|canary|niger|hemp|flax|chia|sesame|sunflower|pumpkin|safflower|nyjer|amaranth|buckwheat|teff|rapeseed|poppy|corn|maize|groat)\b/)) {
    return 'grain';
  }
  
  // Hay detection
  if (lower.match(/\b(hay|timothy|alfalfa|grass|meadow|orchard|bermuda|bluegrass|fescue|ryegrass|straw|dried.*grass)\b/)) {
    return 'hay';
  }
  
  // Supplement detection
  if (lower.match(/\b(supplement|vitamin|calcium|taurine|pellet|fortified|cuttlebone|grit|probiotic|enzyme|glucosamine|chondroitin|omega|epa|dha|antioxidant|spirulina|kelp|brewer.*yeast|electrolyte|amino.*acid|joint.*health|vitamin.*c|vitamin.*d|vitamin.*a)\b/)) {
    return 'supplement';
  }
  
  return 'other';
}

/**
 * Process a single scrape result file
 */
function processScrapeFile(filePath) {
  try {
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const data = JSON.parse(fileContent);
    
    const ingredients = new Map();
    
    // Handle different file structures
    let results = [];
    if (Array.isArray(data)) {
      results = data;
    } else if (data.results && Array.isArray(data.results)) {
      results = data.results;
    } else if (data.ingredients && Array.isArray(data.ingredients)) {
      results = [data];
    }
    
    results.forEach(result => {
      const category = (result.category || result.type || '').toLowerCase();
      const source = result.source || result.url || filePath;
      
      // Extract ingredients
      const ingList = result.ingredients || [];
      if (!Array.isArray(ingList)) return;
      
      ingList.forEach(ing => {
        if (!ing || typeof ing !== 'string') return;
        
        // Filter out extremely long entries (likely scraped HTML/text errors)
        // Also filter out entries that look like navigation text or page content
        if (ing.length > 200 || 
            ing.includes('‚ñº') || 
            ing.includes('shopping list') || 
            ing.includes('enclosure:') ||
            ing.includes('additional resources') ||
            ing.match(/\b(care|shopping|enclosure|decor|handling|health|diseases|tips)\b.*\b(care|shopping|enclosure|decor|handling|health|diseases|tips)\b/i)) {
          return;
        }
        
        const normalized = normalizeIngredientName(ing);
        if (!normalized || normalized.length < 2 || normalized.length > 100) return;
        
        // Infer subtypes from source
        const subtypes = inferSubtypesFromSource(source, category);
        const categoryType = detectCategory(ing);
        
        if (!ingredients.has(normalized)) {
          ingredients.set(normalized, {
            id: normalized,
            name: ing,
            category: categoryType,
            subtypeTags: new Set(subtypes),
            sources: new Set([source]),
            scrapedCount: 0
          });
        }
        
        const entry = ingredients.get(normalized);
        entry.subtypeTags = new Set([...entry.subtypeTags, ...subtypes]);
        entry.sources.add(source);
        entry.scrapedCount++;
      });
    });
    
    return ingredients;
  } catch (error) {
    console.error(`Error processing ${filePath}:`, error.message);
    return new Map();
  }
}

/**
 * Main build function
 */
async function buildIngredients() {
  console.log('üî® Building curated ingredients from scraped data...\n');
  
  const resultsDir = path.join(__dirname, '../scraping/results');
  
  // Get all JSON files
  const files = fs.readdirSync(resultsDir);
  const jsonFiles = files.filter(f => f.endsWith('.json') && !f.includes('test'));
  
  console.log(`üìÅ Found ${jsonFiles.length} result files\n`);
  
  // Process all files
  const allIngredients = new Map();
  
  for (const file of jsonFiles) {
    const filePath = path.join(resultsDir, file);
    console.log(`  Processing: ${file}...`);
    
    const fileIngredients = processScrapeFile(filePath);
    
    // Merge into main map
    fileIngredients.forEach((data, normalized) => {
      if (!allIngredients.has(normalized)) {
        allIngredients.set(normalized, {
          id: data.id,
          name: data.name,
          category: data.category,
          subtypeTags: new Set(data.subtypeTags),
          sources: Array.from(data.sources).slice(0, 5), // Limit sources
          scrapedCount: data.scrapedCount
        });
      } else {
        const existing = allIngredients.get(normalized);
        // Merge subtype tags
        data.subtypeTags.forEach(tag => existing.subtypeTags.add(tag));
        // Merge sources (convert to Set temporarily, then back to array)
        const sourcesSet = new Set(existing.sources);
        data.sources.forEach(s => sourcesSet.add(s));
        existing.sources = Array.from(sourcesSet).slice(0, 5);
        existing.scrapedCount += data.scrapedCount;
      }
    });
  }
  
  console.log(`\n‚úÖ Processed ${allIngredients.size} unique ingredients\n`);
  
  // Convert to TypeScript export format
  const generatedIngredients = Array.from(allIngredients.values())
    .map(ing => ({
      id: ing.id,
      name: ing.name,
      category: ing.category,
      subtypeTags: Array.from(ing.subtypeTags).sort(),
      confidence: ing.scrapedCount > 5 ? 'high' : ing.scrapedCount > 2 ? 'medium' : 'low',
      scrapedCount: ing.scrapedCount
    }))
    .sort((a, b) => {
      // Sort by category, then by name
      if (a.category !== b.category) {
        return a.category.localeCompare(b.category);
      }
      return a.name.localeCompare(b.name);
    });
  
  // Generate TypeScript file
  const tsContent = `// lib/data/generatedIngredients.ts
// AUTO-GENERATED - Do not edit manually
// Generated from scraped data on ${new Date().toISOString()}
// Run: node scripts/buildIngredients.js to regenerate

export interface GeneratedIngredient {
  id: string;
  name: string;
  category: 'protein' | 'vegetable' | 'fruit' | 'grain' | 'supplement' | 'insect' | 'hay' | 'other';
  subtypeTags: string[];
  confidence: 'high' | 'medium' | 'low';
  scrapedCount: number;
}

export const GENERATED_INGREDIENTS: GeneratedIngredient[] = ${JSON.stringify(generatedIngredients, null, 2)};

// Summary stats
export const GENERATED_INGREDIENTS_STATS = {
  total: ${generatedIngredients.length},
  byCategory: {
    protein: ${generatedIngredients.filter(i => i.category === 'protein').length},
    vegetable: ${generatedIngredients.filter(i => i.category === 'vegetable').length},
    fruit: ${generatedIngredients.filter(i => i.category === 'fruit').length},
    grain: ${generatedIngredients.filter(i => i.category === 'grain').length},
    supplement: ${generatedIngredients.filter(i => i.category === 'supplement').length},
    insect: ${generatedIngredients.filter(i => i.category === 'insect').length},
    hay: ${generatedIngredients.filter(i => i.category === 'hay').length},
    other: ${generatedIngredients.filter(i => i.category === 'other').length}
  },
  byConfidence: {
    high: ${generatedIngredients.filter(i => i.confidence === 'high').length},
    medium: ${generatedIngredients.filter(i => i.confidence === 'medium').length},
    low: ${generatedIngredients.filter(i => i.confidence === 'low').length}
  },
  bySubtype: {
    bird_small: ${generatedIngredients.filter(i => i.subtypeTags.includes('bird_small')).length},
    bird_large: ${generatedIngredients.filter(i => i.subtypeTags.includes('bird_large')).length},
    reptile_herbivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('reptile_herbivore')).length},
    reptile_insectivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('reptile_insectivore')).length},
    reptile_omnivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('reptile_omnivore')).length},
    reptile_carnivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('reptile_carnivore')).length},
    pocket_hay: ${generatedIngredients.filter(i => i.subtypeTags.includes('pocket_hay')).length},
    pocket_varied: ${generatedIngredients.filter(i => i.subtypeTags.includes('pocket_varied')).length},
    pocket_carnivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('pocket_carnivore')).length},
    pocket_insectivore: ${generatedIngredients.filter(i => i.subtypeTags.includes('pocket_insectivore')).length}
  }
};
`;
  
  // Write TypeScript file
  const outputPath = path.join(__dirname, '../lib/data/generatedIngredients.ts');
  fs.writeFileSync(outputPath, tsContent, 'utf8');
  
  // Generate summary
  const stats = {
    total: generatedIngredients.length,
    byCategory: {},
    byConfidence: {},
    bySubtype: {}
  };
  
  generatedIngredients.forEach(ing => {
    stats.byCategory[ing.category] = (stats.byCategory[ing.category] || 0) + 1;
    stats.byConfidence[ing.confidence] = (stats.byConfidence[ing.confidence] || 0) + 1;
    ing.subtypeTags.forEach(tag => {
      stats.bySubtype[tag] = (stats.bySubtype[tag] || 0) + 1;
    });
  });
  
  console.log('üìä Summary:');
  console.log(`  Total ingredients: ${stats.total}`);
  console.log(`  By category:`, stats.byCategory);
  console.log(`  By confidence:`, stats.byConfidence);
  console.log(`  By subtype:`, stats.bySubtype);
  console.log(`\nüìÅ Saved to: ${outputPath}`);
  
  return generatedIngredients;
}

// Run if called directly
if (require.main === module) {
  buildIngredients()
    .then(() => {
      console.log('\n‚úÖ Build complete!');
      process.exit(0);
    })
    .catch(error => {
      console.error('\n‚ùå Error:', error);
      process.exit(1);
    });
}

module.exports = { buildIngredients, inferSubtypesFromSource };
</file>

<file path="scripts/check-link-health.ts">
// scripts/check-link-health.ts
// Optional: Check if ASINs are still valid (HTTP HEAD requests)
// Can be run periodically to detect broken/discontinued products

import * as fs from 'fs';
import * as path from 'path';
import { extractASIN } from '../lib/utils/affiliateLinks';

const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');

interface HealthResult {
  ingredient: string;
  asin: string;
  link: string;
  status: 'unknown' | 'valid' | 'broken' | 'error';
  error?: string;
}

const results: HealthResult[] = [];

// Check if ASIN link is still valid (optional HTTP check)
// Note: This requires making HTTP requests, so it's optional and can be slow
async function checkASINHealth(asin: string, link: string): Promise<'valid' | 'broken' | 'error'> {
  // This is a placeholder - actual implementation would make HTTP HEAD request
  // For now, we'll just validate the ASIN format and URL structure
  // Full implementation would require:
  // - HTTP client (axios, node-fetch, etc.)
  // - Rate limiting to avoid overwhelming Amazon
  // - Error handling for network issues
  
  try {
    // Basic validation
    if (!asin || asin.length !== 10) {
      return 'error';
    }
    
    if (!link || !link.includes('amazon.com')) {
      return 'error';
    }
    
    // For now, assume valid if format is correct
    // To implement actual HTTP checking, uncomment and configure:
    /*
    const response = await fetch(link, { method: 'HEAD', redirect: 'follow' });
    if (response.ok) {
      return 'valid';
    } else if (response.status === 404) {
      return 'broken';
    } else {
      return 'error';
    }
    */
    
    return 'unknown';
  } catch (error) {
    return 'error';
  }
}

// Extract all ASINs from vetted products
function extractAllASINs() {
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  const lines = content.split('\n');
  
  let currentIngredient: string | null = null;
  let currentLink: string | null = null;
  let inProductBlock = false;
  let braceDepth = 0;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    const ingredientMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (ingredientMatch) {
      currentIngredient = ingredientMatch[1];
      inProductBlock = true;
      braceDepth = 1;
      currentLink = null;
      continue;
    }
    
    if (inProductBlock) {
      braceDepth += (line.match(/\{/g) || []).length;
      braceDepth -= (line.match(/\}/g) || []).length;
      
      const asinMatch = line.match(/asinLink:\s*'([^']+)'/);
      if (asinMatch) {
        currentLink = asinMatch[1];
      }
      
      if (braceDepth === 0) {
        if (currentIngredient && currentLink) {
          const asin = extractASIN(currentLink);
          if (asin) {
            results.push({
              ingredient: currentIngredient,
              asin,
              link: currentLink,
              status: 'unknown',
            });
          }
        }
        
        currentIngredient = null;
        currentLink = null;
        inProductBlock = false;
      }
    }
  }
}

// Generate health report
function generateHealthReport() {
  const reportPath = path.join(__dirname, '../LINK_HEALTH_REPORT.md');
  
  const valid = results.filter(r => r.status === 'valid').length;
  const broken = results.filter(r => r.status === 'broken').length;
  const errors = results.filter(r => r.status === 'error').length;
  const unknown = results.filter(r => r.status === 'unknown').length;
  
  const report = `# Link Health Check Report
Generated: ${new Date().toISOString()}

## Summary
- Total links checked: ${results.length}
- Valid: ${valid}
- Broken: ${broken}
- Errors: ${errors}
- Unknown (format check only): ${unknown}

## Note
This report currently only validates ASIN format and URL structure.
To enable actual HTTP health checking, implement HTTP requests in check-link-health.ts.

## Results

${results.map(r => `
### ${r.ingredient}
- ASIN: ${r.asin}
- Status: ${r.status}
- Link: ${r.link}
${r.error ? `- Error: ${r.error}` : ''}
`).join('\n')}

## Recommendations

1. **Review broken links**: Replace discontinued products
2. **Monitor regularly**: Run this check monthly
3. **Implement HTTP checking**: Enable actual link validation (see script comments)

---

*Report generated by check-link-health.ts*
`;

  fs.writeFileSync(reportPath, report);
  console.log(`\nüíæ Report saved to: ${reportPath}`);
}

// Main execution
async function main() {
  console.log('üè• Link Health Check\n');
  console.log('='.repeat(60));
  console.log('Note: This script currently validates format only.');
  console.log('To enable HTTP checking, see script comments.\n');
  
  extractAllASINs();
  
  // Optionally check each ASIN (currently skipped for performance)
  // Uncomment to enable actual HTTP checking:
  /*
  console.log(`Checking ${results.length} links...`);
  for (const result of results) {
    result.status = await checkASINHealth(result.asin, result.link);
    process.stdout.write('.');
  }
  console.log('\n');
  */
  
  generateHealthReport();
  
  console.log('='.repeat(60));
  console.log('üìä HEALTH CHECK SUMMARY\n');
  console.log(`Total links: ${results.length}`);
  console.log(`Status: Format validation only (HTTP checking disabled)`);
  console.log(`\n‚úÖ Health check complete!\n`);
}

main().catch(error => {
  console.error('‚ùå Error running health check:', error);
  process.exit(1);
});
</file>

<file path="scripts/check-price-coverage.ts">
import { VETTED_PRODUCTS, getVettedProduct } from '../lib/data/vetted-products';

const total = Object.keys(VETTED_PRODUCTS).length;
const withPrices = Object.entries(VETTED_PRODUCTS).filter(([k, v]) => v.price?.amount).length;
const withoutPrices = total - withPrices;

console.log(`Total vetted products: ${total}`);
console.log(`Products with prices: ${withPrices}`);
console.log(`Products without prices: ${withoutPrices}`);

const noPrices = Object.entries(VETTED_PRODUCTS)
  .filter(([k, v]) => !v.price?.amount)
  .slice(0, 20)
  .map(([k]) => k);

console.log(`\nExamples without prices (first 20):`);
console.log(noPrices.join(', '));

// Test some common ingredient names
console.log(`\nTesting common ingredient name lookups:`);
const testNames = ['chicken breast', 'ground beef', 'salmon', 'sweet potato', 'carrots', 'brown rice'];
testNames.forEach(name => {
  const product = getVettedProduct(name);
  const hasPrice = product?.price?.amount ? `$${product.price.amount.toFixed(2)}` : 'NO PRICE';
  console.log(`  "${name}" -> ${hasPrice}`);
});
</file>

<file path="scripts/check-protein-role.ts">
// Check if protein ingredients have proteinRole set
import { getIngredientsForSpecies } from '../lib/data/ingredients';

const dogsIngredients = getIngredientsForSpecies('dogs');
const proteinIngredients = dogsIngredients.filter(ing => ing.category === 'protein');

console.log('CHECKING PROTEIN ROLE FOR DOGS:');
console.log(`Total protein ingredients: ${proteinIngredients.length}`);

const withPrimaryRole = proteinIngredients.filter(ing => ing.proteinRole === 'primary');
const withSecondaryRole = proteinIngredients.filter(ing => ing.proteinRole === 'secondary');
const withNoRole = proteinIngredients.filter(ing => !ing.proteinRole);

console.log(`\nWith proteinRole='primary': ${withPrimaryRole.length}`);
console.log(`With proteinRole='secondary': ${withSecondaryRole.length}`);
console.log(`With NO proteinRole: ${withNoRole.length}`);

console.log('\nTop 10 protein ingredients and their roles:');
proteinIngredients
  .sort((a, b) => (b.composition.protein || 0) - (a.composition.protein || 0))
  .slice(0, 10)
  .forEach(ing => {
    console.log(`  - ${ing.name}: ${ing.composition.protein}% protein, role: ${ing.proteinRole || 'NONE'}`);
  });

if (withPrimaryRole.length > 0) {
  console.log('\n‚úÖ Primary proteins available:');
  withPrimaryRole.slice(0, 5).forEach(ing => {
    console.log(`  - ${ing.name}: ${ing.composition.protein}% protein`);
  });
} else {
  console.log('\n‚ùå NO PRIMARY PROTEINS FOUND - This is why S1 gate fails!');
}
</file>

<file path="scripts/classify-cost-tiers.ts">
/**
 * Script to automatically classify all vetted products by cost tier
 * Adds costTier field based on price.amount
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// ES module __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function classifyCostTier(price: number): 'budget' | 'standard' | 'premium' {
  if (price < 15) return 'budget';
  if (price < 30) return 'standard';
  return 'premium';
}

function addCostTiersToVettedProducts(): void {
  console.log('üîç Classifying vetted products by cost tier...\n');
  
  const vettedProductsPath = path.join(__dirname, '../lib/data/vetted-products.ts');
  let content = fs.readFileSync(vettedProductsPath, 'utf8');
  
  // Find all product entries with price.amount
  const pricePattern = /price:\s*\{\s*amount:\s*([0-9.]+)/g;
  let match;
  let updated = 0;
  let needsTier = 0;
  
  while ((match = pricePattern.exec(content)) !== null) {
    const price = parseFloat(match[1]);
    const tier = classifyCostTier(price);
    
    // Check if costTier already exists before this price
    const matchIndex = match.index;
    const beforeMatch = content.substring(Math.max(0, matchIndex - 200), matchIndex);
    const afterMatch = content.substring(matchIndex, matchIndex + 100);
    
    // Check if costTier is already present (should be before price)
    if (!beforeMatch.includes('costTier:')) {
      needsTier++;
      
      // Find the start of the object (look backwards for the opening brace)
      const objectStart = content.lastIndexOf('  \'', matchIndex);
      if (objectStart === -1) continue;
      
      // Find where to insert (before price, after species or commissionRate)
      // Look for the line before price
      const priceLineStart = content.lastIndexOf('\n', matchIndex);
      const insertPosition = priceLineStart;
      
      // Create the costTier line
      const indent = '    ';
      const costTierLine = `${indent}costTier: '${tier}',\n`;
      
      // Insert costTier before price
      content = content.slice(0, insertPosition) + costTierLine + content.slice(insertPosition);
      updated++;
      
      // Adjust regex position since we inserted text
      pricePattern.lastIndex = matchIndex + costTierLine.length;
    }
  }
  
  console.log(`üìä Classification Results:\n`);
  console.log(`   Products needing costTier: ${needsTier}`);
  console.log(`   Products updated: ${updated}\n`);
  
  if (updated > 0) {
    // Write updated file
    fs.writeFileSync(vettedProductsPath, content, 'utf8');
    console.log(`‚úÖ Updated ${updated} products with costTier classification`);
  } else {
    console.log('‚úÖ All products already have costTier (or no prices found)');
  }
  
  // Generate statistics
  const budgetPattern = /costTier:\s*'budget'/g;
  const standardPattern = /costTier:\s*'standard'/g;
  const premiumPattern = /costTier:\s*'premium'/g;
  
  const budgetCount = (content.match(budgetPattern) || []).length;
  const standardCount = (content.match(standardPattern) || []).length;
  const premiumCount = (content.match(premiumPattern) || []).length;
  
  console.log('\nüìà Cost Tier Distribution:');
  console.log(`   Budget (< $15): ${budgetCount}`);
  console.log(`   Standard ($15-30): ${standardCount}`);
  console.log(`   Premium (> $30): ${premiumCount}`);
}

// Run classification
try {
  addCostTiersToVettedProducts();
} catch (error) {
  console.error('‚ùå Error classifying products:', error);
  process.exit(1);
}
</file>

<file path="scripts/correct-asins-scraper.ts">
import * as fs from 'fs';
import * as path from 'path';
import axios from 'axios';
import * as cheerio from 'cheerio';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * AUTOMATED ASIN CORRECTION SYSTEM
 * Searches Amazon by GENERIC INGREDIENT NAME and finds correct products
 */

interface VettedProduct {
  ingredient: string;
  productName: string;
  asin: string;
  amazonLink: string;
  vetNote: string;
  category?: string;
}

interface SearchResult {
  asin: string;
  title: string;
  price: string;
  rating: string;
  imageUrl: string;
  matchScore: number;
}

// ============================================================================
// PARSE YOUR VETTED-PRODUCTS.TXT FILE
// ============================================================================

function parseVettedProducts(filePath: string): VettedProduct[] {
  const content = fs.readFileSync(filePath, 'utf-8');
  const products: VettedProduct[] = [];

  // Match entries like: 'ground beef (lean)': {
  const lines = content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);

    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];

      // Extract the object block
      let block = '';
      let braceCount = 1;
      let j = i + 1;

      while (j < lines.length && braceCount > 0) {
        block += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }

      // Extract fields
      const productNameMatch = block.match(/productName:\s*'([^']+)'/);
      const amazonLinkMatch = block.match(/amazonLink:\s*'([^']+)'/);
      const asinMatch = block.match(/\/dp\/([A-Z0-9]{10})/);
      const vetNoteMatch = block.match(/vetNote:\s*'([^']+)'/);
      const categoryMatch = block.match(/category:\s*'([^']+)'/);

      products.push({
        ingredient,
        productName: productNameMatch ? productNameMatch[1] : '',
        asin: asinMatch ? asinMatch[1] : 'UNKNOWN',
        amazonLink: amazonLinkMatch ? amazonLinkMatch[1] : '',
        vetNote: vetNoteMatch ? vetNoteMatch[1] : '',
        category: categoryMatch ? categoryMatch[1] : undefined
      });
    }
  }

  return products;
}

// ============================================================================
// SEARCH AMAZON BY GENERIC INGREDIENT NAME
// ============================================================================

async function searchAmazonByIngredient(
  ingredient: string,
  category: string = 'pet-supplies'
): Promise<SearchResult[]> {

  // JUST search for the ingredient name - nothing else!
  // Amazon's pet-supplies category will handle the context
  const searchTerms = [
    ingredient,  // Just "turkey" or "ground beef"
  ];

  const results: SearchResult[] = [];

  for (const searchTerm of searchTerms) {
    try {
      console.log(`  üîç Searching: "${searchTerm}"`);

      // Search ONLY in pet-supplies with the basic ingredient name
      const url = `https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&i=${category}`;

      const response = await axios.get(url, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.5',
          'Accept-Encoding': 'gzip, deflate, br',
          'Connection': 'keep-alive',
        },
        timeout: 10000
      });

      const $ = cheerio.load(response.data);

      // Extract product cards
      $('[data-component-type="s-search-result"]').each((i, element) => {
        if (i >= 5) return; // Get top 5 results

        const asin = $(element).attr('data-asin');
        if (!asin) return;

        const title = $(element).find('h2 span').text().trim();
        const price = $(element).find('.a-price-whole').first().text().trim() || 'N/A';
        const rating = $(element).find('.a-icon-star-small span').first().text().trim() || 'N/A';
        const imageUrl = $(element).find('img.s-image').attr('src') || '';

        if (title && asin) {
          const matchScore = calculateMatchScore(ingredient, title);
          results.push({
            asin,
            title,
            price,
            rating,
            imageUrl,
            matchScore
          });
        }
      });

      // Wait between searches to avoid rate limiting
      await new Promise(resolve => setTimeout(resolve, 1500));

    } catch (error: any) {
      console.error(`  ‚ùå Search failed: ${error.message}`);
    }
  }

  // Sort by match score and deduplicate
  const uniqueResults = Array.from(
    new Map(results.map(r => [r.asin, r])).values()
  );

  return uniqueResults
    .sort((a, b) => b.matchScore - a.matchScore)
    .slice(0, 5); // Return top 5
}

// ============================================================================
// INTELLIGENT MATCHING ALGORITHM
// ============================================================================

function calculateMatchScore(ingredient: string, productTitle: string): number {
  let score = 0;
  const titleLower = productTitle.toLowerCase();
  const ingredientLower = ingredient.toLowerCase();

  // Remove common modifiers for better matching
  const cleanIngredient = ingredientLower
    .replace(/\(lean\)|\(boneless\)|\(skinless\)|\(canned in water\)/g, '')
    .trim();

  // Extract main words (e.g., "ground beef" -> ["ground", "beef"])
  const ingredientWords = cleanIngredient.split(' ').filter(w => w.length > 2);

  // EXACT MATCH (80 points)
  if (titleLower.includes(cleanIngredient)) {
    score += 80;
  } else {
    // PARTIAL MATCH (up to 40 points)
    const matchedWords = ingredientWords.filter(word => titleLower.includes(word));
    score += (matchedWords.length / ingredientWords.length) * 40;
  }

  // PET-SPECIFIC (15 points)
  if (titleLower.includes('dog') || titleLower.includes('pet') || titleLower.includes('canine')) {
    score += 15;
  }

  // QUALITY INDICATORS (5 points each)
  if (titleLower.includes('freeze dried') || titleLower.includes('raw')) score += 5;
  if (titleLower.includes('human grade') || titleLower.includes('human-grade')) score += 5;
  if (titleLower.includes('organic') || titleLower.includes('grass fed')) score += 5;
  if (titleLower.includes('premium') || titleLower.includes('natural')) score += 3;

  // PENALTIES (subtract points)
  if (titleLower.includes('treat') || titleLower.includes('jerky')) score -= 30;
  if (titleLower.includes('toy') || titleLower.includes('bed')) score -= 50;
  if (titleLower.includes('mix') || titleLower.includes('variety pack')) score -= 20;
  if (titleLower.includes('supplement') && !ingredientLower.includes('oil')) score -= 25;

  // Heavy penalties for processed dog foods
  if (titleLower.includes('canned') || titleLower.includes('wet food')) score -= 40;
  if (titleLower.includes('dry food') || titleLower.includes('kibble')) score -= 35;
  if (titleLower.includes('dog food') && !titleLower.includes('ingredient')) score -= 30;
  if (titleLower.includes('entree') || titleLower.includes('recipe')) score -= 25;

  return Math.max(0, Math.min(100, score));
}

// ============================================================================
// VERIFY CURRENT ASIN
// ============================================================================

async function verifyCurrentASIN(asin: string): Promise<{ valid: boolean; title: string }> {
  try {
    const url = `https://www.amazon.com/dp/${asin}`;
    const response = await axios.get(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
      },
      timeout: 10000
    });

    const $ = cheerio.load(response.data);
    const title = $('#productTitle').text().trim();

    // Check if product exists and is available
    const unavailable = $('body').text().includes('Currently unavailable') ||
                       $('body').text().includes('out of stock');

    return {
      valid: !unavailable && title.length > 0,
      title
    };
  } catch (error) {
    return { valid: false, title: '' };
  }
}

// ============================================================================
// MAIN CORRECTION LOGIC
// ============================================================================

interface Correction {
  ingredient: string;
  oldASIN: string;
  newASIN: string;
  oldProductName: string;
  newProductName: string;
  confidence: 'high' | 'medium' | 'low';
  reason: string;
  matchScore: number;
}

async function processProducts(products: VettedProduct[], limit?: number): Promise<Correction[]> {
  const corrections: Correction[] = [];
  const toProcess = limit ? products.slice(0, limit) : products;

  console.log(`\nü§ñ Processing ${toProcess.length} ingredients${limit ? ` (first ${limit})` : ''}...\n`);

  for (let i = 0; i < toProcess.length; i++) {
    const product = products[i];

    console.log(`\n[${i + 1}/${products.length}] ${product.ingredient}`);
    console.log(`  Current: ${product.productName} (${product.asin})`);

    // Step 1: Verify current ASIN
    console.log(`  üì¶ Verifying current ASIN...`);
    const currentCheck = await verifyCurrentASIN(product.asin);

    if (!currentCheck.valid) {
      console.log(`  ‚ö†Ô∏è  Current ASIN invalid/unavailable`);
    } else {
      const currentScore = calculateMatchScore(product.ingredient, currentCheck.title);
      console.log(`  ‚úì Current ASIN score: ${currentScore}/100`);

      if (currentScore >= 75) {
        console.log(`  ‚úÖ Current ASIN is good, skipping`);
        continue;
      }
    }

    // Step 2: Search for better options
    console.log(`  üîé Searching for better matches...`);
    const searchResults = await searchAmazonByIngredient(product.ingredient, 'pet-supplies');

    if (searchResults.length === 0) {
      console.log(`  ‚ùå No results found`);
      continue;
    }

    // Step 3: Find best match
    const bestMatch = searchResults[0];
    console.log(`  üéØ Best match: ${bestMatch.title} (score: ${bestMatch.matchScore})`);

    // Step 4: Decide if we should replace
    const currentScore = currentCheck.valid ?
      calculateMatchScore(product.ingredient, currentCheck.title) : 0;

    if (bestMatch.matchScore > currentScore + 10 || !currentCheck.valid) {
      corrections.push({
        ingredient: product.ingredient,
        oldASIN: product.asin,
        newASIN: bestMatch.asin,
        oldProductName: product.productName,
        newProductName: bestMatch.title,
        confidence: bestMatch.matchScore >= 75 ? 'high' :
                   bestMatch.matchScore >= 60 ? 'medium' : 'low',
        reason: !currentCheck.valid ? 'Current ASIN invalid' :
                `Better match (${bestMatch.matchScore} vs ${currentScore})`,
        matchScore: bestMatch.matchScore
      });

      console.log(`  ‚úÖ CORRECTION QUEUED`);
    } else {
      console.log(`  ‚úì Current ASIN acceptable`);
    }

    // Rate limiting
    await new Promise(resolve => setTimeout(resolve, 3000));
  }

  return corrections;
}

// ============================================================================
// GENERATE OUTPUT FILES
// ============================================================================

function generateCorrectedFile(originalPath: string, corrections: Correction[]): string {
  let content = fs.readFileSync(originalPath, 'utf-8');

  for (const c of corrections) {
    // Replace the entire product entry (be more careful with the regex)
    const escapedIngredient = c.ingredient.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const oldEntryPattern = `'${escapedIngredient}':\\s*{[\\s\\S]*?},\\s*`;

    const oldEntryMatch = content.match(new RegExp(oldEntryPattern, 's'));
    if (oldEntryMatch) {
      const newEntry = `'${c.ingredient}': {
    productName: '${c.newProductName.replace(/'/g, "\\'")}',
    amazonLink: 'https://www.amazon.com/dp/${c.newASIN}?tag=robinfrench-20',
    vetNote: 'Updated by automated system - ${c.reason}',
    category: 'Meat',
    commissionRate: 0.03
  },`;

      content = content.replace(oldEntryMatch[0], newEntry);
    }
  }

  return content;
}

function generateReport(corrections: Correction[]): string {
  const highConf = corrections.filter(c => c.confidence === 'high');
  const medConf = corrections.filter(c => c.confidence === 'medium');
  const lowConf = corrections.filter(c => c.confidence === 'low');

  let report = `# ASIN Correction Report
Generated: ${new Date().toLocaleString()}
Total Corrections: ${corrections.length}

## Summary
- ‚úÖ High Confidence: ${highConf.length}
- ‚ö†Ô∏è  Medium Confidence: ${medConf.length}
- ‚ùì Low Confidence: ${lowConf.length}

## Corrections by Confidence

`;

  ['high', 'medium', 'low'].forEach(conf => {
    const items = corrections.filter(c => c.confidence === conf);
    if (items.length === 0) return;

    report += `### ${conf.toUpperCase()} CONFIDENCE (${items.length})\n\n`;

    items.forEach((c, i) => {
      report += `**${i + 1}. ${c.ingredient}** (Score: ${c.matchScore}/100)
- OLD: ${c.oldProductName} ‚Üí \`${c.oldASIN}\`
- NEW: ${c.newProductName} ‚Üí \`${c.newASIN}\`
- REASON: ${c.reason}
- LINK: https://www.amazon.com/dp/${c.newASIN}

`;
    });
  });

  return report;
}

// ============================================================================
// MAIN
// ============================================================================

async function main() {
  const limit = process.argv[2] ? parseInt(process.argv[2]) : undefined;
  const inputFile = path.join(__dirname, '../lib/data/vetted-products.txt');
  const outputFile = path.join(__dirname, '../lib/data/vetted-products-CORRECTED.txt');
  const reportFile = path.join(__dirname, '../ASIN-CORRECTION-REPORT.md');

  console.log('üöÄ AUTOMATED ASIN CORRECTION SYSTEM');
  console.log('‚îÅ'.repeat(60));
  console.log(`üìÅ Input:  ${inputFile}`);
  console.log(`üìÅ Output: ${outputFile}`);
  console.log(`üìÅ Report: ${reportFile}`);
  if (limit) console.log(`üéØ Testing mode: Processing only first ${limit} products`);
  console.log('‚îÅ'.repeat(60));

  try {
    // Parse products
    console.log('\nüìñ Reading vetted-products.txt...');
    const products = parseVettedProducts(inputFile);
    console.log(`‚úÖ Found ${products.length} products\n`);

    // Process (this will take a while!)
    const corrections = await processProducts(products, limit);

    // Generate outputs
    console.log(`\nüìä Generating corrected file and report...`);
    const correctedContent = generateCorrectedFile(inputFile, corrections);
    fs.writeFileSync(outputFile, correctedContent);

    const report = generateReport(corrections);
    fs.writeFileSync(reportFile, report);

    console.log('\n‚úÖ DONE!');
    console.log(`üìÑ Corrected file: ${outputFile}`);
    console.log(`üìä Report: ${reportFile}`);
    console.log(`\nüéØ Made ${corrections.length} corrections`);

  } catch (error: any) {
    console.error('\n‚ùå ERROR:', error.message);
    process.exit(1);
  }
}

main();
</file>

<file path="scripts/data/analyze-brands.js">
// Brand Analysis Script - Cross-reference research data with brand recommendations
const fs = require('fs');
const path = require('path');

// Load our research data
function loadResearchData() {
  try {
    const resultsDir = path.join(__dirname, 'scraping', 'results');
    const files = fs.readdirSync(resultsDir)
      .filter(f => f.startsWith('pet_nutrition_research_'))
      .sort()
      .reverse();

    if (files.length === 0) return null;

    const latestFile = path.join(resultsDir, files[0]);
    return JSON.parse(fs.readFileSync(latestFile, 'utf8'));
  } catch (error) {
    console.error('Error loading research data:', error.message);
    return null;
  }
}

// Brand database with quality scores
const BRAND_DATABASE = {
  // Premium Veterinary-Recommended Brands
  'The Farmer\'s Dog': {
    category: 'fresh-prep',
    qualityScore: 9.5,
    vetRecommended: true,
    specialties: ['customized nutrition', 'human-grade', 'veterinarian formulated'],
    priceRange: '$$$',
    affiliateLink: 'https://www.thefarmersdog.com/'
  },
  'Nom Nom': {
    category: 'fresh-prep',
    qualityScore: 9.3,
    vetRecommended: true,
    specialties: ['air-dried', 'human-grade', 'complete nutrition'],
    priceRange: '$$$',
    affiliateLink: 'https://www.nomnom.com/'
  },
  'Ollie': {
    category: 'fresh-prep',
    qualityScore: 9.0,
    vetRecommended: true,
    specialties: ['customized', 'human-grade', 'subscription-based'],
    priceRange: '$$$',
    affiliateLink: 'https://www.myollie.com/'
  },

  // Freeze-Dried/Specialty Brands
  'Fresh Is Best': {
    category: 'freeze-dried',
    qualityScore: 9.2,
    vetRecommended: true,
    specialties: ['single-ingredient', 'human-grade', 'raw alternative'],
    priceRange: '$$',
    affiliateLink: 'https://www.freshisbest.com/'
  },
  'Vital Essentials': {
    category: 'freeze-dried',
    qualityScore: 9.0,
    vetRecommended: true,
    specialties: ['organ meats', 'grain-free', 'natural supplements'],
    priceRange: '$$',
    affiliateLink: 'https://www.vitalessentialsraw.com/'
  },
  'Northwest Naturals': {
    category: 'freeze-dried',
    qualityScore: 8.8,
    vetRecommended: true,
    specialties: ['regional ingredients', 'sustainable', 'limited ingredients'],
    priceRange: '$$',
    affiliateLink: 'https://www.nwnaturals.com/'
  },

  // Raw Food Brands
  'US Wellness Meats': {
    category: 'raw',
    qualityScore: 9.1,
    vetRecommended: true,
    specialties: ['grass-fed', 'organic', 'human-grade'],
    priceRange: '$$',
    affiliateLink: 'https://grasslandbeef.com/'
  },
  'Raw Paws': {
    category: 'raw',
    qualityScore: 8.9,
    vetRecommended: true,
    specialties: ['novel proteins', 'limited ingredients', 'digestive health'],
    priceRange: '$$',
    affiliateLink: 'https://www.rawpaws.pet/'
  },

  // Dehydrated Brands
  'Ziwi Peak': {
    category: 'air-dried',
    qualityScore: 9.4,
    vetRecommended: true,
    specialties: ['New Zealand venison', 'green mussels', 'joint health'],
    priceRange: '$$$',
    affiliateLink: 'https://www.ziwipeak.com/'
  },
  'Orijen': {
    category: 'dehydrated',
    qualityScore: 9.2,
    vetRecommended: true,
    specialties: ['biologically appropriate', 'regional ingredients', 'high protein'],
    priceRange: '$$$',
    affiliateLink: 'https://www.orijen.ca/'
  },

  // Supplement Brands
  'Grizzly Salmon Oil': {
    category: 'supplement',
    qualityScore: 9.3,
    vetRecommended: true,
    specialties: ['wild-caught salmon', 'omega-3 concentrate', 'skin/coat health'],
    priceRange: '$',
    affiliateLink: 'https://www.grizzlys.com/'
  },
  'Purina FortiFlora': {
    category: 'supplement',
    qualityScore: 8.5,
    vetRecommended: true,
    specialties: ['veterinarian recommended', 'digestive health', 'probiotics'],
    priceRange: '$',
    affiliateLink: 'https://www.chewy.com/purina-forti-flora-probiotic-dog/dp/148916'
  },
  'Cosequin': {
    category: 'supplement',
    qualityScore: 9.0,
    vetRecommended: true,
    specialties: ['joint health', 'glucosamine', 'chondroitin'],
    priceRange: '$$',
    affiliateLink: 'https://www.chewy.com/cosequin-ds-plus-msm-joint-health/dp/148916'
  }
};

// Cross-reference research data with brand recommendations
function analyzeBrands() {
  console.log('üî¨ ANALYZING BRANDS BASED ON RESEARCH DATA...\n');

  const researchData = loadResearchData();

  if (!researchData) {
    console.log('‚ùå No research data found. Using brand database only.');
    return analyzeBrandsWithoutResearch();
  }

  console.log(`üìä Loaded research from ${researchData.metadata.totalSources} sources`);
  console.log(`‚úÖ ${researchData.metadata.successfulScrapes} successful scrapes\n`);

  // Extract insights from research
  const insights = researchData.insights || {};
  const commonIngredients = insights.commonIngredients || {};
  const healthFocusAreas = insights.healthFocusAreas || {};

  console.log('üéØ RESEARCH INSIGHTS:');
  console.log(`   Common ingredients found: ${Object.keys(commonIngredients).length}`);
  console.log(`   Health focus areas: ${Object.keys(healthFocusAreas).join(', ')}\n`);

  // Score brands based on research alignment
  const brandScores = {};

  Object.entries(BRAND_DATABASE).forEach(([brandName, brandData]) => {
    let score = brandData.qualityScore;
    let reasons = [];

    // Bonus for research alignment
    if (brandData.specialties.includes('joint health') && healthFocusAreas['joint-health']) {
      score += 0.5;
      reasons.push('Joint health focus aligns with research');
    }

    if (brandData.specialties.includes('skin') && healthFocusAreas['skin-coat']) {
      score += 0.5;
      reasons.push('Skin/coat health aligns with research');
    }

    if (brandData.specialties.includes('digestive') && healthFocusAreas['digestive-health']) {
      score += 0.5;
      reasons.push('Digestive health aligns with research');
    }

    if (brandData.specialties.includes('omega-3') && commonIngredients.salmon) {
      score += 0.3;
      reasons.push('Omega-3 focus matches salmon research');
    }

    brandScores[brandName] = {
      ...brandData,
      researchScore: score,
      researchReasons: reasons,
      finalScore: score
    };
  });

  // Rank brands
  const rankedBrands = Object.entries(brandScores)
    .sort(([,a], [,b]) => b.finalScore - a.finalScore)
    .slice(0, 10);

  console.log('üèÜ TOP 10 BRANDS BASED ON RESEARCH + QUALITY:');
  rankedBrands.forEach(([brand, data], index) => {
    console.log(`${index + 1}. ${brand} (${data.finalScore.toFixed(1)}/10)`);
    console.log(`   ${data.category} ‚Ä¢ ${data.priceRange} ‚Ä¢ ${data.specialties.slice(0, 2).join(', ')}`);
    if (data.researchReasons.length > 0) {
      console.log(`   ‚úì ${data.researchReasons[0]}`);
    }
    console.log('');
  });

  return {
    researchData,
    brandScores,
    rankedBrands,
    recommendations: generateRecommendations(rankedBrands, researchData)
  };
}

function analyzeBrandsWithoutResearch() {
  console.log('üèÜ TOP BRANDS BASED ON QUALITY SCORES:');

  const rankedBrands = Object.entries(BRAND_DATABASE)
    .sort(([,a], [,b]) => b.qualityScore - a.qualityScore)
    .slice(0, 10);

  rankedBrands.forEach(([brand, data], index) => {
    console.log(`${index + 1}. ${brand} (${data.qualityScore}/10)`);
    console.log(`   ${data.category} ‚Ä¢ ${data.priceRange} ‚Ä¢ ${data.specialties.slice(0, 2).join(', ')}`);
    console.log('');
  });

  return { rankedBrands };
}

function generateRecommendations(rankedBrands, researchData) {
  const recommendations = {
    bestOverall: rankedBrands[0],
    bestValue: rankedBrands.find(([,data]) => data.priceRange === '$$'),
    bestPremium: rankedBrands.find(([,data]) => data.priceRange === '$$$'),
    bestJointHealth: rankedBrands.find(([,data]) =>
      data.specialties.includes('joint health')),
    bestDigestiveHealth: rankedBrands.find(([,data]) =>
      data.specialties.includes('digestive health')),
    bestSkinCoat: rankedBrands.find(([,data]) =>
      data.specialties.includes('skin') || data.specialties.includes('coat'))
  };

  console.log('üí° RESEARCH-BASED RECOMMENDATIONS:');
  Object.entries(recommendations).forEach(([category, brandData]) => {
    if (brandData && brandData[0] && brandData[1]) {
      const [brand, data] = brandData;
      const categoryName = category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      console.log(`   ${categoryName}: ${brand} (${data.finalScore || data.qualityScore}/10)`);
    }
  });

  return recommendations;
}

// Export for use in updating buy links
function updateBuyLinks() {
  const analysis = analyzeBrands();

  // Generate updated VETTED_PRODUCTS mapping
  const updatedProducts = {};

  // Map research-recommended ingredients to best brands
  const ingredientBrandMap = {
    'chicken breast': 'Fresh Is Best',
    'ground turkey': 'Diestel Free Range Ground Turkey',
    'ground beef': 'US Wellness Meats Pet Burger',
    'ground lamb': 'Raw Paws Lamb Recipe Rolls',
    'salmon': 'A Better Treat Freeze Dried Salmon',
    'fish oil': 'Grizzly Salmon Oil',
    'joint supplement': 'Cosequin DS Plus MSM',
    'probiotic': 'Purina FortiFlora'
  };

  Object.entries(ingredientBrandMap).forEach(([ingredient, brandName]) => {
    const brandData = BRAND_DATABASE[brandName];
    if (brandData) {
      updatedProducts[ingredient] = {
        productName: brandName,
        amazonLink: `https://www.amazon.com/s?k=${encodeURIComponent(brandName)}&tag=robinfrench-20`,
        vetNote: `Research-backed brand specializing in ${brandData.specialties.slice(0, 2).join(' and ')}. ${brandData.qualityScore}/10 quality score.`,
        category: brandData.category,
        commissionRate: 0.03
      };
    }
  });

  console.log('\nüîÑ UPDATED BUY LINKS BASED ON RESEARCH:');
  Object.entries(updatedProducts).forEach(([ingredient, data]) => {
    console.log(`   ${ingredient} ‚Üí ${data.productName}`);
  });

  return {
    analysis,
    updatedProducts
  };
}

// Run the analysis
if (require.main === module) {
  updateBuyLinks();
}

module.exports = {
  analyzeBrands,
  updateBuyLinks,
  BRAND_DATABASE
};
</file>

<file path="scripts/data/extract-recipes.js">
// Script to extract recipe list for images
const fs = require('fs');

try {
  console.log('Reading recipes file...');
  const content = fs.readFileSync('lib/data/recipes-complete.ts', 'utf8');

  // Find the JSON array - skip the TypeScript parts
  const arrayStart = content.indexOf('[');
  const arrayEnd = content.lastIndexOf(']');

  if (arrayStart !== -1 && arrayEnd !== -1) {
    const jsonContent = content.substring(arrayStart, arrayEnd + 1);

    console.log('Parsing JSON...');
    const recipes = JSON.parse(jsonContent);

    console.log('=== RECIPE LIST FOR IMAGES ===');
    console.log('Total recipes:', recipes.length);
    console.log('');

    const categories = {};
    recipes.forEach(recipe => {
      if (!categories[recipe.category]) categories[recipe.category] = [];
      categories[recipe.category].push(recipe);
    });

    Object.keys(categories).forEach(category => {
      console.log(`${category.toUpperCase()}: ${categories[category].length} recipes`);
      categories[category].slice(0, 10).forEach(recipe => {
        console.log(`  ${recipe.id}: ${recipe.name} (${recipe.shortName})`);
      });
      if (categories[category].length > 10) {
        console.log(`  ... and ${categories[category].length - 10} more`);
      }
      console.log('');
    });

    console.log('=== UNIQUE IMAGE PATHS NEEDED ===');
    const imagePaths = [...new Set(recipes.map(r => r.imageUrl))];
    console.log('Total unique image paths:', imagePaths.length);
    imagePaths.slice(0, 20).forEach(path => console.log(path));
    if (imagePaths.length > 20) {
      console.log(`... and ${imagePaths.length - 20} more`);
    }
  } else {
    console.log('Could not find JSON array');
  }
} catch (e) {
  console.error('Error:', e.message);
  console.error('Stack:', e.stack);
}
</file>

<file path="scripts/data/fetch-prices-from-asins.js">
import fs from 'fs';
import https from 'https';
import http from 'http';

// Simple script to fetch current prices from existing ASIN links
function makeRequest(url) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;

    const options = {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9',
        'Connection': 'keep-alive',
      },
      timeout: 15000,
    };

    protocol.get(url, options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        resolve(data);
      });
    }).on('error', (err) => {
      reject(err);
    });
  });
}

// Extract ASIN from Amazon URL
function extractAsin(url) {
  const match = url.match(/\/dp\/([A-Z0-9]{10})/);
  return match ? match[1] : null;
}

// Parse price from Amazon product page HTML
function extractPriceFromHtml(html) {
  // Try multiple price selectors that Amazon uses
  const priceSelectors = [
    // Main price
    /<span[^>]*id="priceblock_ourprice"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*<\/span>/,
    /<span[^>]*id="priceblock_dealprice"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*<\/span>/,
    // Alternative price formats
    /<span[^>]*class="a-price[^"]*"[^>]*>[\s\S]*?<span[^>]*class="a-offscreen"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*<\/span>/,
    // Whole + fraction format
    /<span[^>]*class="a-price-whole"[^>]*>([0-9,]+)<\/span>\s*<span[^>]*class="a-price-fraction"[^>]*>([0-9]{2})<\/span>/,
  ];

  for (const selector of priceSelectors) {
    const match = html.match(selector);
    if (match) {
      let priceStr;
      if (match.length === 3) {
        // Whole + fraction format
        priceStr = match[1].replace(/,/g, '') + '.' + match[2];
      } else {
        priceStr = match[1].replace(/,/g, '');
      }

      const price = parseFloat(priceStr);
      if (!isNaN(price) && price > 0 && price < 1000) { // Sanity check
        return price;
      }
    }
  }

  return null;
}

// Parse vetted products and extract ASINs
function parseProductsForPriceUpdates(filePath) {
  const content = fs.readFileSync(filePath, 'utf-8');
  const products = [];

  // Match each ingredient entry
  const lines = content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);

    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];

      // Extract the object block
      let block = '';
      let braceCount = 1;
      let j = i + 1;

      while (j < lines.length && braceCount > 0) {
        block += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }

      // Extract amazonLink
      const amazonLinkMatch = block.match(/amazonLink:\s*'([^']+)'/);
      if (amazonLinkMatch) {
        const asin = extractAsin(amazonLinkMatch[1]);
        const hasPrice = block.includes('price: {');

        products.push({
          ingredient,
          asin,
          amazonLink: amazonLinkMatch[1],
          hasPrice,
          blockStart: i,
          blockEnd: j
        });
      }
    }
  }

  return products;
}

// Main execution
async function main() {
  console.log('üöÄ FETCHING PRICES FROM EXISTING ASIN LINKS\n');

  const filePath = 'lib/data/vetted-products.ts';
  const products = parseProductsForPriceUpdates(filePath);

  console.log(`üìä Found ${products.length} products with ASIN links\n`);

  // Filter to products that need price updates
  const needsPrice = products.filter(p => !p.hasPrice);
  const hasPrice = products.filter(p => p.hasPrice);

  console.log(`‚úÖ Already have prices: ${hasPrice.length}`);
  console.log(`üìà Need price updates: ${needsPrice.length}\n`);

  if (needsPrice.length === 0) {
    console.log('üéâ All products already have prices!');
    return;
  }

  // Process products that need prices
  let updated = 0;
  let failed = 0;

  for (let i = 0; i < needsPrice.length; i++) {
    const product = needsPrice[i];

    console.log(`[${i + 1}/${needsPrice.length}] ${product.ingredient}`);

    try {
      // Fetch product page
      const url = product.amazonLink.replace('?tag=robinfrench-20', ''); // Remove affiliate tag for cleaner URL
      console.log(`  üåê Fetching: ${url}`);

      const html = await makeRequest(url);
      const price = extractPriceFromHtml(html);

      if (price) {
        console.log(`  ‚úÖ Price: $${price.toFixed(2)}`);
        updated++;

        // Here we would update the file with the new price
        // For now, just log success
      } else {
        console.log(`  ‚ö†Ô∏è  No price found`);
        failed++;
      }

    } catch (error) {
      console.log(`  ‚ùå Error: ${error.message}`);
      failed++;
    }

    // Rate limiting
    if (i < needsPrice.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }

  console.log(`\nüéâ DONE!`);
  console.log(`‚úÖ Updated: ${updated}`);
  console.log(`‚ùå Failed: ${failed}`);
  console.log(`üìä Success rate: ${((updated / (updated + failed)) * 100).toFixed(1)}%`);
}

main().catch(console.error);
</file>

<file path="scripts/data/remove_all_celebrity.py">
#!/usr/bin/env python3
import re

file_path = 'lib/data/recipes-complete.ts'

print(f'Reading {file_path}...')
with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

print(f'Original line count: {len(lines)}')

# Remove any line containing celebrityName or celebrityQuote
filtered_lines = []
removed_count = 0
for line in lines:
    if 'celebrityName' in line or 'celebrityQuote' in line:
        removed_count += 1
    else:
        filtered_lines.append(line)

print(f'Removed {removed_count} lines')
print(f'New line count: {len(filtered_lines)}')

print(f'Writing to {file_path}...')
with open(file_path, 'w', encoding='utf-8') as f:
    f.writelines(filtered_lines)

print('Done!')
</file>

<file path="scripts/debug-cats.ts">
// Debug cats S1 gate failure
import { RecipeBuilder, GenerationConstraints } from '../lib/generator/RecipeBuilder';
import { getIngredientsForSpecies } from '../lib/data/ingredients';

async function debugCats() {
  console.log('='.repeat(80));
  console.log('DEBUGGING CATS S1 GATE FAILURE');
  console.log('='.repeat(80));
  
  // Check available ingredients
  const catsIngredients = getIngredientsForSpecies('cats');
  console.log(`\nTotal ingredients for cats: ${catsIngredients.length}`);
  
  const proteinIngredients = catsIngredients.filter(ing => ing.category === 'protein');
  console.log(`Protein category ingredients: ${proteinIngredients.length}`);
  
  console.log('\nTop 10 protein ingredients:');
  proteinIngredients
    .sort((a, b) => (b.composition.protein || 0) - (a.composition.protein || 0))
    .slice(0, 10)
    .forEach(ing => {
      console.log(`  - ${ing.name}: ${ing.composition.protein}% protein, quality ${ing.qualityScore}`);
    });
  
  // Try to generate recipe
  console.log('\n' + '='.repeat(80));
  console.log('ATTEMPTING RECIPE GENERATION');
  console.log('='.repeat(80));
  
  const constraints: GenerationConstraints = {
    species: 'cats',
    lifeStage: 'adult',
    petWeightKg: 5,
    healthConcerns: [],
    allergies: [],
  };
  
  const builder = new RecipeBuilder(constraints, 'standard', 'medium');
  const recipe = await builder.generate();
  
  if (recipe) {
    console.log('\n‚úÖ SUCCESS!');
    console.log(`Generated recipe with ${recipe.ingredients.length} ingredients:`);
    
    let totalProtein = 0;
    let totalGrams = 0;
    
    for (const portioned of recipe.ingredients) {
      const ing = portioned.ingredient;
      const protein = (ing.composition.protein || 0) * portioned.grams / 100;
      totalProtein += protein;
      totalGrams += portioned.grams;
      
      console.log(`  - ${ing.name} (${ing.category}): ${portioned.grams}g, ${ing.composition.protein}% protein`);
    }
    
    const proteinPercent = (totalProtein / totalGrams) * 100;
    console.log(`\nTotal: ${totalGrams}g, ${proteinPercent.toFixed(1)}% protein`);
    console.log(`Target: 28% protein for cats`);
    
  } else {
    console.log('\n‚ùå FAILED - No recipe generated');
  }
}

debugCats().catch(console.error);
</file>

<file path="scripts/debug-ingredient-scores.ts">
// Debug ingredient scoring to see why salmon beats chicken breast
import { getIngredientsForSpecies } from '../lib/data/ingredients';

const species = 'cats';
const ingredients = getIngredientsForSpecies(species);

console.log(`Total ingredients for ${species}: ${ingredients.length}`);
console.log();

// Find chicken breast and salmon
const chickenBreast = ingredients.find(ing => ing.name.toLowerCase().includes('chicken breast'));
const salmon = ingredients.find(ing => ing.name.toLowerCase().includes('salmon atlantic'));

console.log('CHICKEN BREAST:');
if (chickenBreast) {
  console.log(`  Name: ${chickenBreast.name}`);
  console.log(`  Category: ${chickenBreast.category}`);
  console.log(`  Protein: ${chickenBreast.composition.protein}%`);
  console.log(`  Quality Score: ${chickenBreast.qualityScore}`);
  console.log(`  Available: YES`);
} else {
  console.log('  NOT AVAILABLE FOR CATS!');
}

console.log();
console.log('SALMON ATLANTIC:');
if (salmon) {
  console.log(`  Name: ${salmon.name}`);
  console.log(`  Category: ${salmon.category}`);
  console.log(`  Protein: ${salmon.composition.protein}%`);
  console.log(`  Quality Score: ${salmon.qualityScore}`);
  console.log(`  Available: YES`);
} else {
  console.log('  NOT AVAILABLE FOR CATS!');
}

console.log();
console.log('ALL PROTEIN CATEGORY INGREDIENTS FOR CATS:');
const proteinIngredients = ingredients.filter(ing => ing.category === 'protein');
console.log(`Total protein ingredients: ${proteinIngredients.length}`);
proteinIngredients.slice(0, 10).forEach(ing => {
  console.log(`  ${ing.name}: ${ing.composition.protein}% protein, quality ${ing.qualityScore}`);
});
</file>

<file path="scripts/debug-protein-scoring.ts">
// Debug why salmon beats chicken breast for cats
import { getIngredientsForSpecies } from '../lib/data/ingredients';

const catsIngredients = getIngredientsForSpecies('cats');
const proteinIngredients = catsIngredients.filter(ing => ing.category === 'protein');

const chickenBreast = proteinIngredients.find(ing => ing.name === 'chicken breast');
const salmon = proteinIngredients.find(ing => ing.name.toLowerCase().includes('salmon atlantic'));

if (!chickenBreast || !salmon) {
  console.log('Missing ingredients!');
  process.exit(1);
}

console.log('='.repeat(80));
console.log('PROTEIN SCORING COMPARISON');
console.log('='.repeat(80));

// Simulate scoring (from RecipeBuilder)
function scoreNutritional(protein: number | undefined): number {
  let score = 0;
  if (protein) {
    if (protein >= 30) score += 60;
    else if (protein >= 25) score += 50;
    else if (protein >= 20) score += 35;
    else if (protein >= 15) score += 20;
    else if (protein >= 10) score += 10;
    else if (protein >= 5) score += 5;
  }
  return score;
}

function scoreQuality(qualityScore: number): number {
  return qualityScore * 10;
}

// Protein category special weights
const weights = {
  health: 0.25,
  nutritional: 0.55,
  palatability: 0.15,
  quality: 0.05,
};

console.log('\nCHICKEN BREAST:');
console.log(`  Protein: ${chickenBreast.composition.protein}%`);
console.log(`  Quality Score: ${chickenBreast.qualityScore}`);
const cbNutritional = scoreNutritional(chickenBreast.composition.protein);
const cbQuality = scoreQuality(chickenBreast.qualityScore);
console.log(`  Nutritional Score: ${cbNutritional}/100`);
console.log(`  Quality Score: ${cbQuality}/100`);
const cbTotal = cbNutritional * weights.nutritional + cbQuality * weights.quality;
console.log(`  Weighted Total (nutritional + quality only): ${cbTotal.toFixed(1)}`);

console.log('\nSALMON ATLANTIC:');
console.log(`  Protein: ${salmon.composition.protein}%`);
console.log(`  Quality Score: ${salmon.qualityScore}`);
const salmonNutritional = scoreNutritional(salmon.composition.protein);
const salmonQuality = scoreQuality(salmon.qualityScore);
console.log(`  Nutritional Score: ${salmonNutritional}/100`);
console.log(`  Quality Score: ${salmonQuality}/100`);
const salmonTotal = salmonNutritional * weights.nutritional + salmonQuality * weights.quality;
console.log(`  Weighted Total (nutritional + quality only): ${salmonTotal.toFixed(1)}`);

console.log('\n' + '='.repeat(80));
console.log('WINNER:');
if (cbTotal > salmonTotal) {
  console.log(`‚úÖ Chicken Breast wins by ${(cbTotal - salmonTotal).toFixed(1)} points`);
} else {
  console.log(`‚ùå Salmon wins by ${(salmonTotal - cbTotal).toFixed(1)} points`);
}
console.log('='.repeat(80));

// Check omega-3 bonus
console.log('\nOMEGA-3 CHECK:');
console.log(`  Chicken Breast omega-3: ${chickenBreast.composition.omega3 || 0}`);
console.log(`  Salmon omega-3: ${salmon.composition.omega3 || 0}`);

if (salmon.composition.omega3 && salmon.composition.omega3 > 1) {
  console.log(`  ‚ö†Ô∏è  Salmon gets +20 points for omega-3!`);
  const salmonWithOmega = salmonTotal + (20 * weights.nutritional);
  console.log(`  Salmon new total: ${salmonWithOmega.toFixed(1)}`);
  if (salmonWithOmega > cbTotal) {
    console.log(`  ‚ùå Salmon NOW wins by ${(salmonWithOmega - cbTotal).toFixed(1)} points`);
  }
}
</file>

<file path="scripts/debug-recipe-selection.ts">
// Debug what ingredients are being selected
import { RecipeBuilder, GenerationConstraints } from '../lib/generator/RecipeBuilder';

type Species = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

async function debugRecipeSelection(species: Species) {
  console.log(`\n${'='.repeat(80)}`);
  console.log(`DEBUGGING ${species.toUpperCase()} RECIPE SELECTION`);
  console.log('='.repeat(80));
  
  const constraints: GenerationConstraints = {
    species,
    lifeStage: 'adult',
    petWeightKg: 15,
    healthConcerns: [],
    allergies: [],
  };
  
  const builder = new RecipeBuilder(constraints, 'standard', 'medium');
  const recipe = await builder.generate();
  
  if (recipe && recipe.ingredients.length > 0) {
    console.log(`\nIngredients selected (${recipe.ingredients.length} total):`);
    
    let totalProtein = 0;
    let totalFat = 0;
    let totalGrams = 0;
    
    // Sort by grams (largest first)
    const sorted = [...recipe.ingredients].sort((a, b) => b.grams - a.grams);
    
    for (const portioned of sorted) {
      const ing = portioned.ingredient;
      const protein = (ing.composition.protein || 0) * portioned.grams / 100;
      const fat = (ing.composition.fat || 0) * portioned.grams / 100;
      
      totalProtein += protein;
      totalFat += fat;
      totalGrams += portioned.grams;
      
      console.log(`  ${ing.name}:`);
      console.log(`    Portion: ${portioned.grams}g (${((portioned.grams / recipe.totalGrams) * 100).toFixed(1)}% of meal)`);
      console.log(`    Protein: ${ing.composition.protein || 0}% ‚Üí ${protein.toFixed(1)}g`);
      console.log(`    Fat: ${ing.composition.fat || 0}% ‚Üí ${fat.toFixed(1)}g`);
      console.log(`    Category: ${ing.category}`);
    }
    
    console.log(`\nTotals:`);
    console.log(`  Total grams: ${totalGrams}g`);
    console.log(`  Total protein: ${totalProtein.toFixed(1)}g (${((totalProtein / totalGrams) * 100).toFixed(1)}%)`);
    console.log(`  Total fat: ${totalFat.toFixed(1)}g (${((totalFat / totalGrams) * 100).toFixed(1)}%)`);
    console.log(`\nTarget for ${species}: 20%+ protein`);
  } else {
    console.log('Failed to generate recipe');
  }
}

async function main() {
  await debugRecipeSelection('dogs');
  await debugRecipeSelection('cats');
}

main().catch(console.error);
</file>

<file path="scripts/debugScoreHarness.ts">
/**
 * Debug Score Harness for Recipe Generator
 */

console.log('Debug harness file loaded');

import { scoreRecipeImproved } from '../lib/scoreRecipe';
import { computeFinalGenerationScore, generateRecipe, getRecipeTemplates, type GeneratedRecipe } from '../lib/recipe-generator';
import { getRecentIngredients } from '../lib/utils/diversityTracker';
import type { Pet, Recipe } from '../lib/types';

function divider(label: string) {
  console.log(`\n${'='.repeat(60)}`);
  console.log(`  ${label}`);
  console.log('='.repeat(60));
}

function colorLog(message: string, color: 'green' | 'yellow' | 'red' | 'blue' | 'cyan' = 'cyan') {
  const colors = {
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    red: '\x1b[31m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
    reset: '\x1b[0m',
  };
  console.log(`${colors[color]}${message}${colors.reset}`);
}

export function debugRecipeScore(pet: Pet, recipe: Recipe | GeneratedRecipe) {
  divider('Score Debug');

  // Convert recipe to proper format
  const recipeForScoring: Recipe = {
    ...recipe,
    id: recipe.id || (recipe as GeneratedRecipe).templateId || 'debug-recipe',
  };

  colorLog(`Recipe: ${recipe.name}`, 'cyan');
  const ingredientNames = (recipe.ingredients || []).map(i => i.name || String(i)).join(', ');
  colorLog(`Ingredients: ${ingredientNames || 'None'}`, 'blue');

  // Get UI score (what users see)
  const uiScoreResult = scoreRecipeImproved(recipeForScoring, pet);
  const uiScore = uiScoreResult.matchScore;

  // Get Generator score (what generator uses for ranking)
  const recentIngredients = pet.id ? getRecentIngredients(pet.id, 7) : [];
  
  // Ensure recipe has required GeneratedRecipe properties
  const generatedRecipe: GeneratedRecipe = {
    ...recipe,
    templateId: (recipe as GeneratedRecipe).templateId || recipe.id || 'debug-recipe',
    generationTimestamp: (recipe as GeneratedRecipe).generationTimestamp || new Date(),
    nutritionalCalculation: (recipe as GeneratedRecipe).nutritionalCalculation || {
      calories: 0,
      protein: 0,
      fat: 0,
      carbs: 0,
      fiber: 0,
      moisture: 0,
    },
    ingredientBreakdown: (recipe as GeneratedRecipe).ingredientBreakdown || [],
    ingredients: recipe.ingredients || [],
  };
  
  const genResult = computeFinalGenerationScore(
    generatedRecipe,
    pet,
    recentIngredients
  );
  const generatorScore = genResult.score;

  const difference = generatorScore - uiScore;
  const isConsistent = Math.abs(difference) <= 15;

  divider('Score Comparison');

  colorLog(`UI Compatibility Score: ${uiScore.toFixed(1)}`, uiScore >= 80 ? 'green' : uiScore >= 60 ? 'yellow' : 'red');
  colorLog(`Generator Final Score: ${generatorScore.toFixed(1)}`, generatorScore >= 80 ? 'green' : generatorScore >= 60 ? 'yellow' : 'red');
  
  if (Math.abs(difference) > 15) {
    colorLog(`Difference: ${difference > 0 ? '+' : ''}${difference.toFixed(1)} ‚ö†Ô∏è LARGE DRIFT`, 'red');
  } else if (Math.abs(difference) > 10) {
    colorLog(`Difference: ${difference > 0 ? '+' : ''}${difference.toFixed(1)} ‚ö†Ô∏è Moderate drift`, 'yellow');
  } else {
    colorLog(`Difference: ${difference > 0 ? '+' : ''}${difference.toFixed(1)} ‚úì Within tolerance`, 'green');
  }

  divider('Modifier Breakdown');

  // Parse explain array to extract modifier values
  const modifiers = {
    synergyBonus: 0,
    conditionBias: 0,
    nutrientAdjustment: 0,
    diversityPenalty: 0,
  };

  genResult.explain.forEach(explanation => {
    if (explanation.includes('Synergy bonus')) {
      const match = explanation.match(/\+?([\d.]+)/);
      if (match) modifiers.synergyBonus = parseFloat(match[1]);
    } else if (explanation.includes('Condition bias')) {
      const match = explanation.match(/([+-]?[\d.]+)/);
      if (match) modifiers.conditionBias = parseFloat(match[1]);
    } else if (explanation.includes('Nutrient adjustment')) {
      const match = explanation.match(/([+-]?[\d.]+)/);
      if (match) modifiers.nutrientAdjustment = parseFloat(match[1]);
    } else if (explanation.includes('Diversity overlap')) {
      const match = explanation.match(/([\d.]+)/);
      if (match) modifiers.diversityPenalty = parseFloat(match[1]);
    }
  });

  colorLog(`Synergy Bonus: ${modifiers.synergyBonus > 0 ? '+' : ''}${modifiers.synergyBonus.toFixed(1)}`, modifiers.synergyBonus > 0 ? 'green' : 'cyan');
  colorLog(`Condition Bias: ${modifiers.conditionBias > 0 ? '+' : ''}${modifiers.conditionBias.toFixed(1)}`, modifiers.conditionBias > 0 ? 'green' : modifiers.conditionBias < 0 ? 'yellow' : 'cyan');
  colorLog(`Nutrient Adjustment: ${modifiers.nutrientAdjustment > 0 ? '+' : ''}${modifiers.nutrientAdjustment.toFixed(1)}`, modifiers.nutrientAdjustment > 0 ? 'green' : modifiers.nutrientAdjustment < 0 ? 'yellow' : 'cyan');
  colorLog(`Diversity Penalty: -${modifiers.diversityPenalty.toFixed(1)}`, modifiers.diversityPenalty > 0 ? 'yellow' : 'cyan');

  divider('UI Score Details');

  colorLog(`Stars: ${uiScoreResult.stars}`, 'cyan');
  colorLog(`Good Matches: ${uiScoreResult.reasoning.goodMatches.length}`, 'green');
  colorLog(`Conflicts: ${uiScoreResult.reasoning.conflicts.length}`, uiScoreResult.reasoning.conflicts.length > 0 ? 'yellow' : 'green');
  
  if (uiScoreResult.reasoning.goodMatches.length > 0) {
    console.log('\n  Good Matches:');
    uiScoreResult.reasoning.goodMatches.forEach(match => {
      colorLog(`    ‚úì ${match}`, 'green');
    });
  }
  
  if (uiScoreResult.reasoning.conflicts.length > 0) {
    console.log('\n  Conflicts:');
    uiScoreResult.reasoning.conflicts.forEach(conflict => {
      colorLog(`    ‚ö† ${conflict}`, 'yellow');
    });
  }

  divider('Pet Context');

  console.log(`Pet: ${pet.name || 'Unnamed'}`);
  console.log(`Species: ${pet.type}`);
  console.log(`Breed: ${pet.breed || 'Unknown'}`);
  console.log(`Age: ${pet.age || 'Unknown'}`);
  console.log(`Health Concerns: ${(pet.healthConcerns || []).join(', ') || 'None'}`);
  console.log(`Allergies: ${(pet.allergies || []).join(', ') || 'None'}`);
  console.log(`Recent Ingredients (last 7 days): ${recentIngredients.length > 0 ? recentIngredients.join(', ') : 'None'}`);

  divider('Summary');

  if (isConsistent) {
    colorLog('‚úÖ SCORES ARE CONSISTENT', 'green');
    colorLog('Generator and UI scoring are aligned within acceptable tolerance.', 'green');
  } else {
    colorLog('‚ùå SCORE DRIFT DETECTED', 'red');
    colorLog('Generator and UI scoring show significant divergence.', 'red');
    colorLog('This may indicate:', 'yellow');
    colorLog('  - Modifiers are too large', 'yellow');
    colorLog('  - Base score calculation differs', 'yellow');
    colorLog('  - Missing normalization', 'yellow');
  }

  return {
    recipeName: recipe.name,
    uiScore,
    generatorScore,
    difference,
    modifiers,
    explain: genResult.explain,
    isConsistent,
  };
}

// Run when executed directly
(async () => {
  try {
    console.log('Starting debug harness...');
    
    const testPet: Pet = {
      id: 'test-pet-1',
      name: 'Buddy',
      type: 'dogs',
      breed: 'Golden Retriever',
      age: '5',
      weightKg: 30,
      healthConcerns: ['joint-health', 'weight-management'],
      allergies: [],
      activityLevel: 'moderate',
      names: ['Buddy'],
    };

    const templates = getRecipeTemplates('dogs');
    console.log(`Templates available: ${templates.length}`);
    
    // Generate a test recipe
    const template = templates[0];
    if (template) {
      console.log(`Found template: ${template.name}\n`);
      const generatedRecipe = generateRecipe({ template, pet: testPet });
      debugRecipeScore(testPet, generatedRecipe);
    } else {
      console.error('No dog template found for testing');
    }
  } catch (error) {
    console.error('Error running debug harness:', error);
    if (error instanceof Error) {
      console.error('Stack:', error.stack);
    }
    process.exit(1);
  }
})();
</file>

<file path="scripts/diagnose-ingredient-links.ts">
// scripts/diagnose-ingredient-links.ts
// Diagnoses which recipe ingredients don't have purchase links

import { readFileSync } from 'fs';
import { join } from 'path';
import { recipes } from '../lib/data/recipes-complete';
import { VETTED_PRODUCTS, getVettedProduct } from '../lib/data/vetted-products';

interface IngredientStats {
  name: string;
  hasASIN: boolean;
  hasSearchURL: boolean;
  hasNoLink: boolean;
  vettedProduct?: any;
}

const stats: IngredientStats[] = [];
const ingredientSet = new Set<string>();

// Collect all unique ingredients from all recipes
recipes.forEach(recipe => {
  recipe.ingredients.forEach(ing => {
    const name = ing.name.toLowerCase().trim();
    if (!ingredientSet.has(name)) {
      ingredientSet.add(name);
      
      const vettedProduct = getVettedProduct(ing.name);
      const hasASIN = vettedProduct?.asinLink?.includes('/dp/') || false;
      const hasSearchURL = vettedProduct?.asinLink?.includes('/s?k=') || false;
      const hasNoLink = !vettedProduct?.asinLink;
      
      stats.push({
        name: ing.name,
        hasASIN,
        hasSearchURL,
        hasNoLink,
        vettedProduct: vettedProduct ? {
          productName: vettedProduct.productName,
          asinLink: vettedProduct.asinLink
        } : undefined
      });
    }
  });
  
  // Also check supplements
  if ((recipe as any).supplements) {
    (recipe as any).supplements.forEach((supp: any) => {
      const name = supp.name.toLowerCase().trim();
      if (!ingredientSet.has(name)) {
        ingredientSet.add(name);
        
        const vettedProduct = getVettedProduct(supp.name);
        const hasASIN = vettedProduct?.asinLink?.includes('/dp/') || false;
        const hasSearchURL = vettedProduct?.asinLink?.includes('/s?k=') || false;
        const hasNoLink = !vettedProduct?.asinLink;
        
        stats.push({
          name: supp.name,
          hasASIN,
          hasSearchURL,
          hasNoLink,
          vettedProduct: vettedProduct ? {
            productName: vettedProduct.productName,
            asinLink: vettedProduct.asinLink
          } : undefined
        });
      }
    });
  }
});

// Calculate statistics
const totalIngredients = stats.length;
const withASIN = stats.filter(s => s.hasASIN).length;
const withSearchURL = stats.filter(s => s.hasSearchURL).length;
const withNoLink = stats.filter(s => s.hasNoLink).length;

console.log('\nüìä INGREDIENT LINK STATISTICS\n');
console.log(`Total unique ingredients in recipes: ${totalIngredients}`);
console.log(`  ‚úÖ With ASIN links (/dp/): ${withASIN} (${Math.round(withASIN/totalIngredients*100)}%)`);
console.log(`  ‚ö†Ô∏è  With search URLs (/s?k=): ${withSearchURL} (${Math.round(withSearchURL/totalIngredients*100)}%)`);
console.log(`  ‚ùå No purchase link: ${withNoLink} (${Math.round(withNoLink/totalIngredients*100)}%)\n`);

// List ingredients without links
if (withNoLink > 0) {
  console.log('‚ùå INGREDIENTS WITHOUT PURCHASE LINKS:\n');
  stats
    .filter(s => s.hasNoLink)
    .slice(0, 50) // Show first 50
    .forEach(s => {
      console.log(`  - ${s.name}`);
    });
  
  if (withNoLink > 50) {
    console.log(`  ... and ${withNoLink - 50} more\n`);
  }
}

// List ingredients with search URLs (should be converted to ASINs)
if (withSearchURL > 0) {
  console.log('\n‚ö†Ô∏è  INGREDIENTS WITH SEARCH URLs (should be ASINs):\n');
  stats
    .filter(s => s.hasSearchURL)
    .slice(0, 20)
    .forEach(s => {
      console.log(`  - ${s.name}: ${s.vettedProduct?.asinLink}`);
    });
  
  if (withSearchURL > 20) {
    console.log(`  ... and ${withSearchURL - 20} more\n`);
  }
}

// Sample of ingredients with ASINs
console.log('\n‚úÖ SAMPLE INGREDIENTS WITH ASIN LINKS:\n');
stats
  .filter(s => s.hasASIN)
  .slice(0, 10)
  .forEach(s => {
    console.log(`  - ${s.name}: ${s.vettedProduct?.asinLink}`);
  });

console.log('\n');
</file>

<file path="scripts/diagnose-scoring.ts">
// scripts/diagnose-scoring.ts
// Diagnostic script to identify exact scoring bottlenecks for perfect pets

import { calculateEnhancedCompatibility, type Pet } from '@/lib/utils/enhancedCompatibilityScoring';
import { recipes } from '@/lib/data/recipes-complete';

async function diagnoseScoring() {
  const perfectDog: Pet = {
    id: 'test-perfect-dog',
    name: 'Test Dog',
    type: 'dog',
    breed: 'golden-retriever',
    age: 3,
    weight: 15,
    activityLevel: 'moderate',
    healthConcerns: [],
    dietaryRestrictions: [],
    allergies: []
  };
  
  console.log('=== SCORING DIAGNOSIS ===\n');
  
  const scores = recipes
    .filter(r => r.category === 'dogs')
    .map(recipe => {
      try {
        const result = calculateEnhancedCompatibility(recipe, perfectDog);
        return { recipe, result };
      } catch (error) {
        console.error(`Error scoring recipe ${recipe.name}:`, error);
        return null;
      }
    })
    .filter((item): item is { recipe: typeof recipes[0]; result: ReturnType<typeof calculateEnhancedCompatibility> } => item !== null)
    .sort((a, b) => b.result.overallScore - a.result.overallScore);
  
  // Top 10 scores
  console.log('Top 10 Scores:');
  scores.slice(0, 10).forEach(({ recipe, result }, i) => {
    console.log(`\n${i + 1}. ${recipe.name}: ${result.overallScore}%`);
    console.log('   Factors:');
    Object.entries(result.factors).forEach(([key, factor]) => {
      const contribution = factor.score * (factor.weight || 0);
      const status = factor.score < 100 ? '‚ö†Ô∏è' : '‚úÖ';
      console.log(`     ${status} ${key}: ${factor.score}% (weight: ${((factor.weight || 0) * 100).toFixed(1)}%, contributes: ${contribution.toFixed(1)}%)`);
      if (factor.score < 100 && factor.issues.length > 0) {
        console.log(`        Issues: ${factor.issues.slice(0, 2).join(', ')}`);
      }
    });
  });
  
  const maxScore = scores.length > 0 ? scores[0].result.overallScore : 0;
  console.log(`\n=== MAX SCORE: ${maxScore}% ===`);
  
  if (maxScore < 95) {
    console.error('\n‚ùå PROBLEM: No recipes can score above 95% for perfect pet!');
    console.log('\nBottlenecks preventing 100%:');
    if (scores.length > 0) {
      const topRecipe = scores[0];
      Object.entries(topRecipe.result.factors).forEach(([key, factor]) => {
        if (factor.score < 100) {
          console.log(`  - ${key}: ${factor.score}% (${factor.reasoning})`);
        }
      });
    }
  } else {
    console.log('\n‚úÖ SUCCESS: Found recipes scoring 95%+ for perfect pet');
  }
}

diagnoseScoring().catch(console.error);
</file>

<file path="scripts/enhance-recipes.ts">
// scripts/enhance-recipes.ts
// Comprehensive recipe enhancement script (OPTIMIZED)
// - Runs auto-tagging with improvements
// - Verifies and completes shortName fields
// - Verifies and completes celebrity quotes
// - Validates data consistency
// - Outputs to JSON for faster processing
// VERSION: 2025-12-05-v2 - Fixed syntax error and backup file reading

import * as fs from 'fs';
import * as path from 'path';
// REMOVED: import { recipes } from '../lib/data/recipes-complete'; // This causes TypeScript to compile the entire 19k line file
import { 
  dogCelebrities, 
  catCelebrities, 
  birdCelebrities, 
  reptileCelebrities, 
  pocketPetCelebrities 
} from '../lib/data/celebrity-pets-complete';

// Immediate file write to verify script execution
const testFile = path.join(process.cwd(), 'script-test-execution.txt');
try {
  fs.writeFileSync(testFile, `Script executed at: ${new Date().toISOString()}\nWorking directory: ${process.cwd()}\n`, 'utf8');
  console.log('‚úÖ Test file created:', testFile);
} catch (e) {
  console.error('‚ùå Failed to create test file:', e);
}

console.log('=== SCRIPT LOADING... ===');
console.log('Starting enhance-recipes.ts script');
console.log('Current working directory:', process.cwd());
console.log('=== IMPORTS SUCCESSFUL ===');
console.log('Celebrity data loaded');

// Pre-build celebrity arrays once (not per recipe)
const ALL_CELEBS = [
  ...dogCelebrities,
  ...catCelebrities,
  ...birdCelebrities,
  ...reptileCelebrities,
  ...pocketPetCelebrities
];

console.log(`Total celebrities: ${ALL_CELEBS.length}`);

const CELEBS_BY_TYPE: Record<string, typeof ALL_CELEBS> = {
  dog: ALL_CELEBS.filter(c => c.petType === 'dog'),
  cat: ALL_CELEBS.filter(c => c.petType === 'cat'),
  bird: ALL_CELEBS.filter(c => c.petType === 'bird'),
  reptile: ALL_CELEBS.filter(c => c.petType === 'reptile'),
  'pocket-pet': ALL_CELEBS.filter(c => c.petType === 'pocket-pet'),
};

// Optimized merge function (avoids array spreading)
function mergeUnique(target: string[], source: string[]): string[] {
  const result = [...target];
  for (const s of source) {
    if (!result.includes(s)) {
      result.push(s);
    }
  }
  return result;
}

interface Recipe {
  id: string;
  name: string;
  shortName?: string;
  celebrityName?: string;
  celebrityQuote?: string;
  category?: string;
  ingredients: Array<{ name: string; amount?: string }>;
  healthConcerns?: string[];
  notSuitableFor?: string[];
  [key: string]: any;
}

// =================================================================
// 1. AUTO-TAGGING (Enhanced)
// =================================================================

function autoTagRecipe(recipe: Recipe): { healthConcerns: string[]; notSuitableFor: string[] } {
  const nameLower = recipe.name.toLowerCase();
  const ingredientsText = (recipe.ingredients ?? [])
    .map((i) => (typeof i === 'string' ? i : i.name || '').toLowerCase())
    .join(' ');
  
  const allText = `${nameLower} ${ingredientsText}`;
  const categoryLower = recipe.category?.toLowerCase() || '';

  const healthConcerns: string[] = [];
  const notSuitableFor: string[] = [];

  // DIGESTIVE ISSUES - Bland, easily digestible
  if (
    (allText.includes('chicken') && (allText.includes('rice') || allText.includes('white rice'))) ||
    allText.includes('pumpkin') ||
    allText.includes('bone broth') ||
    nameLower.includes('bland') ||
    nameLower.includes('sensitive') ||
    nameLower.includes('digestive')
  ) {
    healthConcerns.push('digestive-issues');
  }

  // JOINT HEALTH - Omega-3 rich
  if (
    allText.includes('salmon') ||
    allText.includes('fish oil') ||
    allText.includes('salmon oil') ||
    allText.includes('omega') ||
    allText.includes('sardine') ||
    allText.includes('mackerel') ||
    nameLower.includes('joint') ||
    nameLower.includes('arthritis')
  ) {
    healthConcerns.push('joint-health');
  }

  // KIDNEY DISEASE - Avoid high phosphorus
  if (
    allText.includes('liver') ||
    allText.includes('kidney') ||
    allText.includes('organ meat') ||
    allText.includes('organ') ||
    (allText.includes('beef') && allText.includes('liver'))
  ) {
    notSuitableFor.push('kidney-disease');
  } else if (
    allText.includes('white fish') ||
    allText.includes('egg white') ||
    allText.includes('low-sodium') ||
    (allText.includes('chicken') && !allText.includes('liver') && !allText.includes('thigh'))
  ) {
    healthConcerns.push('kidney-disease');
  }

  // WEIGHT MANAGEMENT - Low calorie, lean
  if (
    allText.includes('lean') ||
    allText.includes('low-fat') ||
    allText.includes('low-calorie') ||
    allText.includes('diet') ||
    nameLower.includes('weight') ||
    nameLower.includes('slim') ||
    (allText.includes('turkey') && allText.includes('breast')) ||
    (allText.includes('chicken') && allText.includes('breast')) ||
    allText.includes('green beans') ||
    allText.includes('cauliflower')
  ) {
    healthConcerns.push('weight-management');
  }

  // PANCREATITIS - Ultra low fat
  const hasHighFat = 
    allText.includes('salmon') ||
    allText.includes('pork') ||
    allText.includes('lamb') ||
    allText.includes('duck') ||
    allText.includes('fatty') ||
    (allText.includes('beef') && !allText.includes('lean'));
  
  if (hasHighFat) {
    notSuitableFor.push('pancreatitis');
  } else if (
    allText.includes('lean') ||
    allText.includes('low-fat') ||
    allText.includes('white fish') ||
    allText.includes('turkey breast') ||
    (allText.includes('chicken') && allText.includes('breast'))
  ) {
    healthConcerns.push('pancreatitis');
  }

  // HEART DISEASE - Low sodium, taurine-rich
  if (
    allText.includes('low-sodium') ||
    allText.includes('taurine') ||
    allText.includes('heart') ||
    nameLower.includes('heart') ||
    (allText.includes('chicken') && allText.includes('breast')) ||
    (allText.includes('turkey') && allText.includes('breast'))
  ) {
    healthConcerns.push('heart-disease');
  } else if (
    allText.includes('high-sodium') ||
    allText.includes('processed') ||
    (allText.includes('sodium') && !allText.includes('low-sodium'))
  ) {
    notSuitableFor.push('heart-disease');
  }

  // DIABETES - Low glycemic
  const hasSimpleCarbs = 
    allText.includes('white rice') ||
    allText.includes('corn syrup') ||
    allText.includes('sugar') ||
    allText.includes('honey');
  
  if (hasSimpleCarbs) {
    notSuitableFor.push('diabetes');
  } else if (
    allText.includes('complex') ||
    allText.includes('high-fiber') ||
    allText.includes('low-glycemic') ||
    (allText.includes('sweet potato') && !allText.includes('white rice')) ||
    allText.includes('quinoa') ||
    allText.includes('brown rice') ||
    nameLower.includes('diabetic') ||
    nameLower.includes('diabetes')
  ) {
    healthConcerns.push('diabetes');
  }

  // SKIN CONDITIONS - Omega-3, quality protein
  if (
    allText.includes('salmon') ||
    allText.includes('fish oil') ||
    allText.includes('salmon oil') ||
    allText.includes('omega') ||
    allText.includes('sardine') ||
    allText.includes('vitamin e') ||
    allText.includes('zinc') ||
    nameLower.includes('skin') ||
    nameLower.includes('coat')
  ) {
    healthConcerns.push('skin-conditions');
  } else if (
    allText.includes('artificial') ||
    allText.includes('preservatives') ||
    allText.includes('color')
  ) {
    notSuitableFor.push('skin-conditions');
  }

  // ALLERGIES - Novel proteins
  if (
    allText.includes('rabbit') ||
    allText.includes('duck') ||
    allText.includes('venison') ||
    allText.includes('bison') ||
    allText.includes('kangaroo') ||
    allText.includes('novel') ||
    nameLower.includes('hypoallergenic') ||
    nameLower.includes('allergy')
  ) {
    healthConcerns.push('allergies');
  }

  // DENTAL ISSUES - Soft foods
  if (
    allText.includes('stew') ||
    allText.includes('soft') ||
    allText.includes('wet') ||
    allText.includes('puree') ||
    nameLower.includes('senior') ||
    nameLower.includes('dental') ||
    nameLower.includes('soft')
  ) {
    healthConcerns.push('dental-issues');
  }

  // URINARY HEALTH - High moisture
  if (
    allText.includes('bone broth') ||
    allText.includes('cranberry') ||
    allText.includes('moisture') ||
    allText.includes('hydration') ||
    nameLower.includes('urinary')
  ) {
    healthConcerns.push('urinary-health');
  }

  return {
    healthConcerns: [...new Set(healthConcerns)],
    notSuitableFor: [...new Set(notSuitableFor)]
  };
}

// =================================================================
// 2. SHORT NAME GENERATION (Optimized)
// =================================================================

function generateShortName(recipe: Recipe): string {
  const nameLower = recipe.name.toLowerCase();
  const ingredients = recipe.ingredients || [];
  
  // Pre-normalize ingredient names once
  const ingredientNames = ingredients.map(ing => (ing.name || '').toLowerCase()).join(' ');
  
  // Extract main protein
  const proteins = ['chicken', 'beef', 'turkey', 'duck', 'rabbit', 'salmon', 'fish', 'quail', 'lamb', 'pork'];
  const mainProtein = proteins.find(p => 
    nameLower.includes(p) || ingredientNames.includes(p)
  );
  
  // Extract main carb/vegetable
  const carbs = ['rice', 'oats', 'quinoa', 'buckwheat', 'sweet potato', 'potato', 'beans', 'chickpeas'];
  const mainCarb = carbs.find(c => 
    nameLower.includes(c) || ingredientNames.includes(c)
  );
  
  // Build short name
  if (mainProtein && mainCarb) {
    return `${mainProtein.charAt(0).toUpperCase() + mainProtein.slice(1)} ${mainCarb.charAt(0).toUpperCase() + mainCarb.slice(1)}`;
  } else if (mainProtein) {
    return mainProtein.charAt(0).toUpperCase() + mainProtein.slice(1);
  } else if (mainCarb) {
    return mainCarb.charAt(0).toUpperCase() + mainCarb.slice(1);
  }
  
  // Fallback: use first 2-3 words of name
  const skipWords = ['baked', 'grilled', 'fresh', 'delight', 'bowl', 'stew', 'formula'];
  const words = recipe.name.split(' ').filter(w => 
    !skipWords.includes(w.toLowerCase())
  );
  return words.slice(0, 2).join(' ').substring(0, 20);
}

// =================================================================
// 3. CELEBRITY QUOTE ASSIGNMENT
// =================================================================

function hashString(s: string): number {
  let hash = 0;
  for (let i = 0; i < s.length; i++) {
    hash = ((hash << 5) - hash) + s.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash);
}

// Optimized: uses pre-built CELEBS_BY_TYPE (no array building per recipe)
function getCelebrityForRecipe(recipe: Recipe): { name: string; quote: string } {
  const category = recipe.category || 'dogs';
  
  const categoryToPetType: Record<string, keyof typeof CELEBS_BY_TYPE> = {
    'dogs': 'dog',
    'cats': 'cat',
    'birds': 'bird',
    'reptiles': 'reptile',
    'pocket-pets': 'pocket-pet'
  };
  
  const petType = categoryToPetType[category] ?? 'dog';
  const list = CELEBS_BY_TYPE[petType] ?? ALL_CELEBS;
  
  const id = recipe.id || recipe.name;
  const index = hashString(id) % list.length;
  
  return {
    name: list[index].name,
    quote: list[index].quote
  };
}

// =================================================================
// 4. DATA VALIDATION
// =================================================================

interface ValidationResult {
  isValid: boolean;
  errors: string[];
  warnings: string[];
  stats: {
    total: number;
    hasShortName: number;
    hasCelebrity: number;
    hasHealthConcerns: number;
    hasIngredients: number;
  };
}

function validateRecipe(recipe: Recipe, index: number): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];
  
  if (!recipe.id) errors.push(`Recipe ${index}: Missing id`);
  if (!recipe.name) errors.push(`Recipe ${index}: Missing name`);
  if (!recipe.category) errors.push(`Recipe ${index}: Missing category`);
  if (!recipe.ingredients || recipe.ingredients.length === 0) {
    errors.push(`Recipe ${index}: Missing ingredients`);
  }
  
  if (!recipe.shortName || recipe.shortName.trim() === '') {
    warnings.push(`Recipe ${index} (${recipe.name}): Missing shortName`);
  } else if (recipe.shortName.length > 30) {
    warnings.push(`Recipe ${index} (${recipe.name}): shortName too long (${recipe.shortName.length} chars)`);
  }
  
  if (!recipe.celebrityName || !recipe.celebrityQuote) {
    warnings.push(`Recipe ${index} (${recipe.name}): Missing celebrity quote`);
  }
  
  if (!recipe.healthConcerns) {
    warnings.push(`Recipe ${index} (${recipe.name}): Missing healthConcerns array`);
  }
  
  return {
    isValid: errors.length === 0,
    errors,
    warnings,
    stats: {
      total: 1,
      hasShortName: recipe.shortName ? 1 : 0,
      hasCelebrity: (recipe.celebrityName && recipe.celebrityQuote) ? 1 : 0,
      hasHealthConcerns: (recipe.healthConcerns && recipe.healthConcerns.length > 0) ? 1 : 0,
      hasIngredients: (recipe.ingredients && recipe.ingredients.length > 0) ? 1 : 0,
    }
  };
}

// =================================================================
// MAIN FUNCTION
// =================================================================

// Write all output to a log file as well
const logFile = path.join(process.cwd(), 'enhance-recipes-log.txt');
const logMessages: string[] = [];

function logToFile(msg: string) {
  logMessages.push(msg);
  console.log(msg);
}

// Helper function for safer parsing of JavaScript/TypeScript arrays
// Handles trailing commas and comments that JSON.parse() cannot
function parseRecipeArray(jsonContent: string): Recipe[] {
  try {
    // Try to clean up the content - remove comments and fix common issues
    let cleaned = jsonContent
      .replace(/\/\/.*$/gm, '') // Remove single-line comments
      .replace(/\/\*[\s\S]*?\*\//g, ''); // Remove multi-line comments
    
    logToFile(`Attempting to parse array (cleaned length: ${cleaned.length})...\n`);
    
    let recipes;
    try {
      const tempFn = new Function('return ' + cleaned);
      recipes = tempFn();
    } catch (fnError) {
      logToFile(`‚ùå Function construction/execution failed: ${fnError}\n`);
      logToFile(`First 1000 chars of cleaned content: ${cleaned.substring(0, 1000)}\n`);
      throw fnError;
    }
    
    if (!Array.isArray(recipes)) {
      logToFile(`‚ùå Parsed result is not an array. Type: ${typeof recipes}, Value: ${String(recipes).substring(0, 200)}\n`);
      throw new Error('Parsed content was not an array.');
    }
    if (recipes.length === 0) {
      logToFile('‚ö†Ô∏è  Warning: Parsed array is empty, but continuing...\n');
    }
    return recipes;
  } catch (e) {
    logToFile(`‚ùå Severe Parsing Error: The recipe array in the source file has invalid JavaScript syntax (e.g., trailing commas, comments). ${e}`);
    logToFile(`First 500 chars of original content: ${jsonContent.substring(0, 500)}\n`);
    throw new Error(`Recipe array source is corrupted and cannot be parsed: ${e instanceof Error ? e.message : String(e)}`);
  }
}

async function main() {
  try {
    // Write initial log - FORCE RECOMPILE v4 - NEW TIMESTAMP
    const startTime = new Date().toISOString();
    console.log('=== MAIN FUNCTION STARTED ===', startTime);
    fs.writeFileSync(logFile, `Script module loaded successfully at ${startTime}\nVERSION: v4\n`, 'utf8');
    
    logToFile('üöÄ Comprehensive Recipe Enhancement Script\n');
    logToFile('This script will:');
    logToFile('  1. Auto-tag recipes with health concerns');
    logToFile('  2. Generate/verify shortName fields');
    logToFile('  3. Assign celebrity quotes');
    logToFile('  4. Validate data consistency\n');

  const recipesPath = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.ts');
  const jsonPath = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.json');
  const backupPath = recipesPath.replace('.ts', `.backup.${Date.now()}.ts`);
  
  // Create backup
  if (fs.existsSync(recipesPath)) {
    fs.copyFileSync(recipesPath, backupPath);
    logToFile(`‚úÖ Backup created: ${backupPath}\n`);
  }
  
  // Check if we need to restore from backup
  const backupFile = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.backup.ts');
  if (fs.existsSync(backupFile)) {
    const backupContent = fs.readFileSync(backupFile, 'utf8');
    const currentContent = fs.existsSync(recipesPath) ? fs.readFileSync(recipesPath, 'utf8') : '';
    
    // If current file doesn't have recipes array but backup does, use backup
    if (!currentContent.includes('export const recipes: Recipe[] = [') && 
        !currentContent.includes('export const recipes = [') &&
        backupContent.includes('export const recipes: Recipe[] = [')) {
      logToFile('‚ö†Ô∏è  Current file missing recipes, using backup file for reading...\n');
      // We'll read from backup but write to main file
    }
  }

  // Try to load from JSON first (much faster if it exists)
  let recipes: Recipe[] = [];
  if (fs.existsSync(jsonPath)) {
      logToFile('üìñ Loading from existing JSON file (fast path)...');
      try {
        const jsonContent = fs.readFileSync(jsonPath, 'utf8');
        // Check if it's actually JSON (starts with [ or {)
        if (jsonContent.trim().startsWith('[') || jsonContent.trim().startsWith('{')) {
          const parsed = JSON.parse(jsonContent);
          if (Array.isArray(parsed) && parsed.length > 0) {
            recipes = parsed;
        logToFile(`‚úÖ Loaded ${recipes.length} recipes from JSON\n`);
          } else {
            logToFile(`‚ö†Ô∏è  JSON file exists but is empty or invalid (length: ${parsed?.length || 0}), checking TS file...\n`);
          }
        } else {
          logToFile(`‚ö†Ô∏è  JSON file exists but doesn't appear to be valid JSON (starts with: ${jsonContent.substring(0, 50)}), checking TS file...\n`);
        }
      } catch (e) {
        logToFile(`‚ö†Ô∏è  JSON file corrupted (${e}), falling back to TS file...\n`);
      }
  }

  // If JSON doesn't exist or is corrupted, read from TS file
  if (recipes.length === 0) {
    logToFile('üìñ Reading recipes from TypeScript file (this may take a moment)...');
    
    // Try main file first, then backup if needed
    let fileContent = '';
    let sourceFile = recipesPath;
    
    try {
      if (fs.existsSync(recipesPath)) {
        fileContent = fs.readFileSync(recipesPath, 'utf8');
        logToFile(`Main file exists, length: ${fileContent.length} chars\n`);
        logToFile(`First 200 chars: ${fileContent.substring(0, 200)}\n`);
        
        // Check if TS file imports from JSON - if so, try loading JSON again
        if (fileContent.includes("import recipesData from './recipes-complete.json.ts.ts'") ||
            fileContent.includes("import recipesData from './recipes-complete.json.ts.ts'")) {
          logToFile('üìñ TS file imports from JSON, loading JSON file directly...\n');
          if (fs.existsSync(jsonPath)) {
            try {
              const jsonContent = fs.readFileSync(jsonPath, 'utf8');
              const parsed = JSON.parse(jsonContent);
              if (Array.isArray(parsed) && parsed.length > 0) {
                recipes = parsed;
                logToFile(`‚úÖ Loaded ${recipes.length} recipes from JSON (via TS import detection)\n`);
              } else {
                logToFile(`‚ö†Ô∏è  JSON file is empty or invalid, trying backup...\n`);
              }
            } catch (e) {
              logToFile(`‚ö†Ô∏è  Failed to load JSON: ${e}, trying backup...\n`);
            }
          }
        }
      } else {
        logToFile('‚ö†Ô∏è  Main file does not exist!\n');
      }
    } catch (e) {
      logToFile(`‚ùå Error reading main file: ${e}\n`);
      throw e;
    }
    
    // If still no recipes and main file doesn't have recipes array, try backup
    if (recipes.length === 0 && fileContent) {
      const hasRecipesArray = fileContent.includes('export const recipes: Recipe[] = [') || 
                              fileContent.includes('export const recipes = [');
      
      if (!hasRecipesArray) {
      const backupFile = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.backup.ts');
      logToFile(`Checking backup file: ${backupFile}\n`);
      logToFile(`Backup exists: ${fs.existsSync(backupFile)}\n`);
      if (fs.existsSync(backupFile)) {
        logToFile('‚ö†Ô∏è  Main file missing recipes array, reading from backup...\n');
        fileContent = fs.readFileSync(backupFile, 'utf8');
        sourceFile = backupFile;
        logToFile(`Backup file length: ${fileContent.length} chars\n`);
        logToFile(`Backup first 200 chars: ${fileContent.substring(0, 200)}\n`);
      } else {
        logToFile('‚ùå Backup file also does not exist!\n');
        }
      }
    }
    
    // Only try to parse TS file if we still don't have recipes and have file content
    if (recipes.length === 0 && fileContent) {
    // Find the JSON array in the TypeScript file
    logToFile(`Searching for recipes array in file content (length: ${fileContent.length})...\n`);
    const arrayStart = fileContent.indexOf('export const recipes: Recipe[] = [');
    logToFile(`arrayStart position: ${arrayStart}\n`);
    if (arrayStart === -1) {
      const altStart = fileContent.indexOf('export const recipes = [');
      logToFile(`altStart position: ${altStart}\n`);
      if (altStart === -1) {
        logToFile(`‚ùå File content preview: ${fileContent.substring(0, 1000)}\n`);
        throw new Error(`Could not find recipes array in file: ${sourceFile}. File length: ${fileContent.length}`);
      } else {
      const bracketStart = fileContent.indexOf('[', altStart);
      let bracketCount = 0;
      let bracketEnd = bracketStart;
      for (let i = bracketStart; i < fileContent.length; i++) {
        if (fileContent[i] === '[') bracketCount++;
        if (fileContent[i] === ']') bracketCount--;
        if (bracketCount === 0) {
          bracketEnd = i;
          break;
        }
      }
      const jsonContent = fileContent.substring(bracketStart, bracketEnd + 1);
      logToFile(`Extracted array content length: ${jsonContent.length} chars\n`);
      logToFile(`First 200 chars of extracted content: ${jsonContent.substring(0, 200)}\n`);
      recipes = parseRecipeArray(jsonContent);
      }
    } else {
      const bracketStart = fileContent.indexOf('[', arrayStart);
      if (bracketStart === -1) {
        throw new Error('Could not find opening bracket');
      }
      
      // Find the matching closing bracket (handle nested brackets)
      let bracketCount = 0;
      let bracketEnd = bracketStart;
      for (let i = bracketStart; i < fileContent.length; i++) {
        if (fileContent[i] === '[') bracketCount++;
        if (fileContent[i] === ']') bracketCount--;
        if (bracketCount === 0) {
          bracketEnd = i;
          break;
        }
      }
      
      // Extract and parse JSON
      const jsonContent = fileContent.substring(bracketStart, bracketEnd + 1);
      logToFile(`Extracted array content length: ${jsonContent.length} chars\n`);
      logToFile(`First 200 chars of extracted content: ${jsonContent.substring(0, 200)}\n`);
      recipes = parseRecipeArray(jsonContent);
    }
      logToFile(`‚úÖ Loaded ${recipes.length} recipes from TS file\n`);
    }
  logToFile('üìù Processing recipes...\n');

  const tagStats: Record<string, number> = {};
  const notSuitableStats: Record<string, number> = {};
  let taggedCount = 0;
  let shortNameAdded = 0;
  let celebrityAdded = 0;
  const validationResults: ValidationResult[] = [];

  // Process each recipe
  const updatedRecipes = recipes.map((recipe: Recipe, index: number) => {
    // 1. Auto-tagging
    const tags = autoTagRecipe(recipe);
    const existingHealthConcerns = recipe.healthConcerns || [];
    const existingNotSuitable = recipe.notSuitableFor || [];
    
    // Use optimized merge function (avoids array spreading)
    const mergedHealthConcerns = mergeUnique([...existingHealthConcerns], tags.healthConcerns);
    const mergedNotSuitable = mergeUnique([...existingNotSuitable], tags.notSuitableFor);
    
    if (tags.healthConcerns.length > 0 || tags.notSuitableFor.length > 0) {
      taggedCount++;
      tags.healthConcerns.forEach(tag => tagStats[tag] = (tagStats[tag] || 0) + 1);
      tags.notSuitableFor.forEach(tag => notSuitableStats[tag] = (notSuitableStats[tag] || 0) + 1);
    }
    
    // 2. Short name
    let shortName = recipe.shortName;
    if (!shortName || shortName.trim() === '') {
      shortName = generateShortName(recipe);
      shortNameAdded++;
    }
    
    // 3. Celebrity quote
    let celebrityName = recipe.celebrityName;
    let celebrityQuote = recipe.celebrityQuote;
    if (!celebrityName || !celebrityQuote) {
      const celebrity = getCelebrityForRecipe(recipe);
      celebrityName = celebrity.name;
      celebrityQuote = celebrity.quote;
      celebrityAdded++;
    }
    
    // 4. Validation
    const validation = validateRecipe({
      ...recipe,
      shortName,
      celebrityName,
      celebrityQuote,
      healthConcerns: mergedHealthConcerns,
      notSuitableFor: mergedNotSuitable
    }, index);
    validationResults.push(validation);
    
    return {
      ...recipe,
      shortName,
      celebrityName,
      celebrityQuote,
      healthConcerns: mergedHealthConcerns,
      notSuitableFor: mergedNotSuitable
    };
  });

  // Aggregate validation stats
  const totalStats = validationResults.reduce((acc, result) => ({
    total: acc.total + result.stats.total,
    hasShortName: acc.hasShortName + result.stats.hasShortName,
    hasCelebrity: acc.hasCelebrity + result.stats.hasCelebrity,
    hasHealthConcerns: acc.hasHealthConcerns + result.stats.hasHealthConcerns,
    hasIngredients: acc.hasIngredients + result.stats.hasIngredients,
  }), { total: 0, hasShortName: 0, hasCelebrity: 0, hasHealthConcerns: 0, hasIngredients: 0 });

  const allErrors = validationResults.flatMap(r => r.errors);
  const allWarnings = validationResults.flatMap(r => r.warnings);

  // Write to JSON for faster processing (TypeScript imports JSON)
  fs.writeFileSync(jsonPath, JSON.stringify(updatedRecipes, null, 2), 'utf8');
  
  // Also update the TS file to import from JSON
  const tsOutput = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Auto-tagged on: ${new Date().toISOString()}
// Enhanced with shortName, celebrity quotes, and health tags
// Total recipes: ${updatedRecipes.length}
// 
// NOTE: Data is stored in recipes-complete.json for faster processing
// This file imports and re-exports it for TypeScript compatibility

import type { Recipe } from '../types';
import recipesData from './recipes-complete.json.ts.ts';

export const recipes: Recipe[] = recipesData as Recipe[];
`;

  fs.writeFileSync(recipesPath, tsOutput, 'utf8');

  // Print results
  logToFile('\nüéâ Enhancement Complete!\n');
  logToFile('üìä Statistics:');
  logToFile(`   Total recipes: ${updatedRecipes.length}`);
  logToFile(`   Recipes tagged: ${taggedCount}`);
  logToFile(`   Short names added: ${shortNameAdded}`);
  logToFile(`   Celebrity quotes added: ${celebrityAdded}\n`);
  
  logToFile('   Health Concern Tags:');
  Object.entries(tagStats)
    .sort(([, a], [, b]) => b - a)
    .forEach(([tag, count]) => {
      logToFile(`   + ${tag}: ${count} recipes`);
    });
  
  if (Object.keys(notSuitableStats).length > 0) {
    logToFile(`\n   Not Suitable For:`);
    Object.entries(notSuitableStats)
      .sort(([, a], [, b]) => b - a)
      .forEach(([tag, count]) => {
        logToFile(`   - ${tag}: ${count} recipes`);
      });
  }

  logToFile('\nüìã Data Quality:');
  logToFile(`   Recipes with shortName: ${totalStats.hasShortName}/${totalStats.total} (${Math.round(totalStats.hasShortName/totalStats.total*100)}%)`);
  logToFile(`   Recipes with celebrity: ${totalStats.hasCelebrity}/${totalStats.total} (${Math.round(totalStats.hasCelebrity/totalStats.total*100)}%)`);
  logToFile(`   Recipes with health tags: ${totalStats.hasHealthConcerns}/${totalStats.total} (${Math.round(totalStats.hasHealthConcerns/totalStats.total*100)}%)`);
  logToFile(`   Recipes with ingredients: ${totalStats.hasIngredients}/${totalStats.total} (${Math.round(totalStats.hasIngredients/totalStats.total*100)}%)`);

  if (allErrors.length > 0) {
    logToFile(`\n‚ùå Errors (${allErrors.length}):`);
    allErrors.slice(0, 10).forEach(err => logToFile(`   ${err}`));
    if (allErrors.length > 10) logToFile(`   ... and ${allErrors.length - 10} more`);
  }

  if (allWarnings.length > 0) {
    logToFile(`\n‚ö†Ô∏è  Warnings (${allWarnings.length}):`);
    allWarnings.slice(0, 10).forEach(warn => logToFile(`   ${warn}`));
    if (allWarnings.length > 10) logToFile(`   ... and ${allWarnings.length - 10} more`);
  }

  logToFile('\n‚úÖ Files updated:');
  logToFile('   - lib/data/recipes-complete.json (data)');
  logToFile('   - lib/data/recipes-complete.ts (imports JSON)');
  logToFile('üîÑ Restart your dev server to see changes');
  
  // Write log to file
  fs.writeFileSync(logFile, logMessages.join('\n'), 'utf8');
  logToFile(`\nüìù Full log written to: ${logFile}`);
  } catch (error) {
    const errorMsg = `‚ùå Error running script: ${error}`;
    logToFile(errorMsg);
    if (error instanceof Error) {
      logToFile(`Error message: ${error.message}`);
      logToFile(`Stack trace: ${error.stack}`);
    }
    fs.writeFileSync(logFile, logMessages.join('\n'), 'utf8');
    console.error(errorMsg);
    process.exit(1);
  }
}

// Wrap everything in try-catch to catch import errors
try {
  main().catch((error) => {
    const errorMsg = `‚ùå Unhandled error: ${error}`;
    try {
      logMessages.push(errorMsg);
      if (error instanceof Error) {
        logMessages.push(`Error message: ${error.message}`);
        logMessages.push(`Stack trace: ${error.stack}`);
      }
      fs.writeFileSync(logFile, logMessages.join('\n'), 'utf8');
    } catch (writeError) {
      // If we can't write to log, at least try console
      console.error('Failed to write log file:', writeError);
    }
    console.error(errorMsg);
    if (error instanceof Error) {
      console.error('Error message:', error.message);
      console.error('Stack trace:', error.stack);
    }
    process.exit(1);
  });
} catch (error) {
  // Catch import/module loading errors
  console.error('‚ùå Script failed to load:', error);
  if (error instanceof Error) {
    console.error('Error message:', error.message);
    console.error('Stack trace:', error.stack);
  }
  process.exit(1);
}
</file>

<file path="scripts/export-all-ingredient-links.mjs">
// Export all ingredients with their Amazon links for manual review

import { VETTED_PRODUCTS } from '../lib/data/vetted-products.ts';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('üìã Exporting All Ingredients with Amazon Links\n');
console.log('='.repeat(80));

const ingredients = Object.entries(VETTED_PRODUCTS).map(([name, product]) => ({
  ingredient: name,
  productName: product.productName,
  asinLink: product.asinLink,
  category: product.category,
}));

// Sort alphabetically by ingredient name
ingredients.sort((a, b) => a.ingredient.localeCompare(b.ingredient));

console.log(`\nTotal ingredients: ${ingredients.length}\n`);

// Create markdown report
let markdown = `# All Ingredients with Amazon Links

**Generated:** ${new Date().toISOString()}  
**Total Ingredients:** ${ingredients.length}

---

`;

ingredients.forEach((item, index) => {
  markdown += `## ${index + 1}. ${item.ingredient}\n\n`;
  markdown += `- **Product:** ${item.productName}\n`;
  markdown += `- **Category:** ${item.category}\n`;
  markdown += `- **Link:** ${item.asinLink}\n`;
  
  // Extract ASIN for quick reference
  const asinMatch = item.asinLink.match(/\/dp\/([A-Z0-9]{10})/);
  if (asinMatch) {
    markdown += `- **ASIN:** ${asinMatch[1]}\n`;
  }
  
  markdown += `\n`;
});

// Save to file
const outputPath = path.join(__dirname, '../ALL_INGREDIENT_LINKS.md');
fs.writeFileSync(outputPath, markdown, 'utf8');

console.log(`‚úÖ Report saved to: ALL_INGREDIENT_LINKS.md`);
console.log(`\nüìä Summary by Category:\n`);

// Count by category
const byCategory = ingredients.reduce((acc, item) => {
  acc[item.category] = (acc[item.category] || 0) + 1;
  return acc;
}, {});

Object.entries(byCategory)
  .sort((a, b) => b[1] - a[1])
  .forEach(([category, count]) => {
    console.log(`  ${category}: ${count}`);
  });

console.log('\n' + '='.repeat(80));
</file>

<file path="scripts/export-ingredient-links.ts">
import { VETTED_PRODUCTS } from '../lib/data/vetted-products';

// Extract all ingredients with their Amazon links
const ingredients = Object.entries(VETTED_PRODUCTS).map(([key, product]) => ({
  ingredientName: key,
  productName: product.productName,
  amazonLink: product.amazonLink,
  category: product.category || 'Other',
  vetNote: product.vetNote
}));

// Sort by category, then by ingredient name
ingredients.sort((a, b) => {
  if (a.category !== b.category) {
    return a.category.localeCompare(b.category);
  }
  return a.ingredientName.localeCompare(b.ingredientName);
});

console.log('=== ALL INGREDIENTS WITH AMAZON LINKS ===\n');
console.log(`Total: ${ingredients.length} ingredients\n`);

// Output in simple format
ingredients.forEach((ing, index) => {
  console.log(`${index + 1}. ${ing.ingredientName}`);
  console.log(`   Product: ${ing.productName}`);
  console.log(`   Link: ${ing.amazonLink}`);
  console.log(`   Category: ${ing.category}`);
  console.log('');
});

// Also output as CSV format
console.log('\n\n=== CSV FORMAT ===');
console.log('Ingredient Name,Product Name,Amazon Link,Category');
ingredients.forEach(ing => {
  const csvLine = `"${ing.ingredientName}","${ing.productName}","${ing.amazonLink}","${ing.category}"`;
  console.log(csvLine);
});
</file>

<file path="scripts/extract-asins.js">
// extract-asins.js

// Fully automated ASIN extractor for your ingredient links

// Run: node scripts/extract-asins.js

const fs = require('fs');
const https = require('https');
const path = require('path');

// ============================================
// CONFIGURATION
// ============================================

const INPUT_FILE = path.join(__dirname, '../lib/data/vetted-products.ts'); // Your vetted products file
const OUTPUT_FILE = path.join(__dirname, '../asins-extracted.json');        // Output file
const DELAY_MS = 2000;                               // Delay between requests (avoid rate limiting)

// ============================================
// STEP 1: Extract ASIN from URL (Fast - No Scraping)
// ============================================

function extractASINFromURL(url) {
  if (!url || typeof url !== 'string') return null;
  
  const patterns = [
    /\/dp\/([A-Z0-9]{10})/,
    /\/product\/([A-Z0-9]{10})/,
    /\/gp\/product\/([A-Z0-9]{10})/,
    /[?&]ASIN=([A-Z0-9]{10})/,
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  
  return null;
}

// ============================================
// STEP 2: Scrape ASIN from Search Results (Slow)
// ============================================

function fetchASINFromSearchURL(url) {
  return new Promise((resolve) => {
    https.get(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9',
      }
    }, (res) => {
      let data = '';
      
      res.on('data', chunk => data += chunk);
      
      res.on('end', () => {
        // Try multiple patterns to find ASIN
        const patterns = [
          /data-asin="([A-Z0-9]{10})"/,
          /\/dp\/([A-Z0-9]{10})/,
          /asin["\s]*[:=]["\s]*([A-Z0-9]{10})/i,
          /"asin":"([A-Z0-9]{10})"/,
        ];
        
        for (const pattern of patterns) {
          const match = data.match(pattern);
          if (match) {
            resolve(match[1]);
            return;
          }
        }
        
        resolve(null);
      });
    }).on('error', (err) => {
      console.error('  ‚ö†Ô∏è  Fetch error:', err.message);
      resolve(null);
    });
  });
}

// ============================================
// STEP 3: Process All Links with Smart Logic
// ============================================

async function extractAllASINs(amazonLinks) {
  const results = [];
  const progressFile = OUTPUT_FILE.replace('.json', '-progress.json');
  
  // Try to load previous progress
  let startIndex = 0;
  if (fs.existsSync(progressFile)) {
    try {
      const progress = JSON.parse(fs.readFileSync(progressFile, 'utf8'));
      results.push(...progress.results);
      startIndex = progress.lastIndex + 1;
      console.log(`üìÇ Resuming from item ${startIndex + 1}/${amazonLinks.length}`);
    } catch (e) {
      console.log('‚ö†Ô∏è  Could not load progress, starting fresh');
    }
  }
  
  for (let i = startIndex; i < amazonLinks.length; i++) {
    const item = amazonLinks[i];
    console.log(`\n[${i + 1}/${amazonLinks.length}] ${item.name}`);
    
    try {
      // Try URL pattern first (instant)
      let asin = extractASINFromURL(item.link);
      
      if (asin) {
        console.log(`  ‚úÖ Found ASIN in URL: ${asin}`);
        results.push({ ...item, asin, method: 'url' });
      } else {
        // It's a search link - fetch the page
        console.log(`  üîç Search link detected, fetching...`);
        
        await new Promise(resolve => setTimeout(resolve, DELAY_MS));
        asin = await fetchASINFromSearchURL(item.link);
        
        if (asin) {
          console.log(`  ‚úÖ Extracted ASIN from page: ${asin}`);
          results.push({ ...item, asin, method: 'scrape' });
        } else {
          console.log(`  ‚ùå Could not find ASIN`);
          results.push({ ...item, asin: null, method: 'failed' });
        }
      }
      
      // Save progress every 10 items
      if ((i + 1) % 10 === 0) {
        fs.writeFileSync(progressFile, JSON.stringify({
          lastIndex: i,
          results: results
        }, null, 2));
        console.log(`  üíæ Progress saved (${i + 1}/${amazonLinks.length})`);
      }
    } catch (error) {
      console.error(`  ‚ö†Ô∏è  Error processing ${item.name}:`, error.message);
      results.push({ ...item, asin: null, method: 'error', error: error.message });
    }
  }
  
  // Clean up progress file on completion
  if (fs.existsSync(progressFile)) {
    fs.unlinkSync(progressFile);
  }
  
  return results;
}

// ============================================
// STEP 4: Parse Your Vetted Products File
// ============================================

function parseVettedProductsFile() {
  try {
    const content = fs.readFileSync(INPUT_FILE, 'utf8');
    
    // Extract all amazonLink entries with their ingredient names
    // Pattern: 'ingredient name': { ... amazonLink: 'url' ... }
    const entries = [];
    
    // Match ingredient entries: 'key': { ... amazonLink: 'value' ... }
    const entryPattern = /'([^']+)':\s*\{[^}]*amazonLink:\s*['"]([^'"]+)['"]/g;
    let match;
    
    while ((match = entryPattern.exec(content)) !== null) {
      const ingredientName = match[1];
      const amazonLink = match[2];
      
      entries.push({
        name: ingredientName,
        link: amazonLink
      });
    }
    
    // Also try to get productName if available
    const detailedPattern = /'([^']+)':\s*\{([^}]+)\}/gs;
    let detailedMatch;
    const detailedEntries = [];
    
    while ((detailedMatch = detailedPattern.exec(content)) !== null) {
      const ingredientName = detailedMatch[1];
      const entryContent = detailedMatch[2];
      
      const linkMatch = entryContent.match(/amazonLink:\s*['"]([^'"]+)['"]/);
      const productMatch = entryContent.match(/productName:\s*['"]([^'"]+)['"]/);
      
      if (linkMatch) {
        detailedEntries.push({
          name: ingredientName,
          productName: productMatch ? productMatch[1] : ingredientName,
          link: linkMatch[1]
        });
      }
    }
    
    // Use detailed entries if we found them, otherwise use simple entries
    return detailedEntries.length > 0 ? detailedEntries : entries;
  } catch (error) {
    console.error('Error reading file:', error.message);
    return [];
  }
}

// ============================================
// STEP 5: Save Results
// ============================================

function saveResults(results) {
  // Save as JSON
  fs.writeFileSync(OUTPUT_FILE, JSON.stringify(results, null, 2));
  console.log(`\n‚úÖ Saved ${results.length} results to ${OUTPUT_FILE}`);
  
  // Also save as CSV for easy viewing
  const csvFile = OUTPUT_FILE.replace('.json', '.csv');
  const csv = [
    'Ingredient Name,Product Name,Amazon Link,ASIN,Extraction Method',
    ...results.map(r => 
      `"${r.name || ''}","${r.productName || ''}","${r.link}","${r.asin || 'NOT_FOUND'}","${r.method || 'unknown'}"`
    )
  ].join('\n');
  
  fs.writeFileSync(csvFile, csv);
  console.log(`‚úÖ Also saved CSV to ${csvFile}`);
  
  // Statistics
  const found = results.filter(r => r.asin).length;
  const fromURL = results.filter(r => r.method === 'url').length;
  const fromScrape = results.filter(r => r.method === 'scrape').length;
  const failed = results.filter(r => !r.asin).length;
  
  console.log('\nüìä STATISTICS:');
  console.log(`  Total processed: ${results.length}`);
  console.log(`  ‚úÖ Found ASINs: ${found} (${Math.round(found/results.length*100)}%)`);
  console.log(`     - From URL: ${fromURL}`);
  console.log(`     - From scraping: ${fromScrape}`);
  console.log(`  ‚ùå Failed: ${failed}`);
  
  // Show failed ones
  if (failed > 0) {
    console.log('\n‚ùå Failed to extract ASINs:');
    results.filter(r => !r.asin).forEach(r => {
      console.log(`  - ${r.name}: ${r.link.substring(0, 80)}...`);
    });
  }
}

// ============================================
// MAIN EXECUTION
// ============================================

async function main() {
  console.log('üöÄ Starting ASIN extraction...\n');
  console.log(`üìÅ Input file: ${INPUT_FILE}`);
  console.log(`üìÅ Output file: ${OUTPUT_FILE}\n`);
  
  // Parse vetted products file
  console.log('üìñ Reading vetted products file...');
  const ingredients = parseVettedProductsFile();
  
  if (ingredients.length === 0) {
    console.error('‚ùå No ingredients found. Check INPUT_FILE path.');
    console.error(`   Looking for: ${INPUT_FILE}`);
    process.exit(1);
  }
  
  console.log(`‚úÖ Found ${ingredients.length} ingredient links\n`);
  
  // Extract ASINs
  const results = await extractAllASINs(ingredients);
  
  // Save results
  saveResults(results);
  
  console.log('\n‚ú® Done!');
  console.log(`\nüí° Next steps:`);
  console.log(`   1. Review ${OUTPUT_FILE.replace(path.join(__dirname, '../'), '')}`);
  console.log(`   2. Update vetted-products.ts with direct ASIN links`);
  console.log(`   3. Replace search URLs with: https://amazon.com/dp/ASIN?tag=robinfrench-20`);
}

// Run it
main().catch(console.error);
</file>

<file path="scripts/extract-quantities.js">
#!/usr/bin/env node

/**
 * Extract product quantities from Amazon product pages
 * Uses ASIN to fetch product details and extract package size information
 */

const fs = require('fs');
const path = require('path');
const https = require('https');

const PRODUCT_PRICES_PATH = path.join(__dirname, '../data/product-prices.json');

// Common quantity patterns to look for in product titles and descriptions
const QUANTITY_PATTERNS = [
  /(\d+(?:\.\d+)?)\s*(oz|ounce|fl oz|fluid ounce)/i,
  /(\d+(?:\.\d+)?)\s*(lb|lbs|pound|pounds)/i,
  /(\d+(?:\.\d+)?)\s*(kg|kilogram)/i,
  /(\d+(?:\.\d+)?)\s*(g|gram)/i,
  /(\d+)\s*(pack|count|piece|pieces)/i,
  /(\d+)\s*(can|cans)/i,
  /(\d+)\s*(bottle|bottles)/i,
  /(\d+)\s*(jar|jars)/i,
  /(\d+)\s*(box|boxes)/i,
  /(\d+)\s*(bag|bags)/i,
];

/**
 * Fetch product details from Amazon using ASIN
 * Note: This uses a simple approach - for production, consider using Amazon Product Advertising API
 */
async function fetchProductDetails(asin) {
  return new Promise((resolve) => {
    const url = `https://www.amazon.com/dp/${asin}`;
    
    const options = {
      hostname: 'www.amazon.com',
      path: `/dp/${asin}`,
      method: 'GET',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      },
      timeout: 5000
    };

    https.get(options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          // Extract quantity from common patterns in the HTML
          const quantity = extractQuantityFromHTML(data);
          resolve(quantity);
        } catch (error) {
          console.error(`Error parsing ASIN ${asin}:`, error.message);
          resolve(null);
        }
      });
    }).on('error', (error) => {
      console.error(`Error fetching ASIN ${asin}:`, error.message);
      resolve(null);
    }).on('timeout', () => {
      console.warn(`Timeout fetching ASIN ${asin}`);
      resolve(null);
    });
  });
}

/**
 * Extract quantity from HTML content
 */
function extractQuantityFromHTML(html) {
  // Look for common quantity indicators in the page
  // This is a simplified approach - real implementation would need more sophisticated parsing
  
  // Try to find quantity in title
  const titleMatch = html.match(/<title>([^<]+)<\/title>/i);
  if (titleMatch) {
    const quantity = extractQuantityFromText(titleMatch[1]);
    if (quantity) return quantity;
  }

  // Try to find in product details section
  const detailsMatch = html.match(/About this item[\s\S]{0,2000}?<\/ul>/i);
  if (detailsMatch) {
    const quantity = extractQuantityFromText(detailsMatch[0]);
    if (quantity) return quantity;
  }

  // Try to find in feature bullets
  const bulletsMatch = html.match(/<ul[^>]*class="[^"]*feature[^"]*"[\s\S]{0,3000}?<\/ul>/i);
  if (bulletsMatch) {
    const quantity = extractQuantityFromText(bulletsMatch[0]);
    if (quantity) return quantity;
  }

  return null;
}

/**
 * Extract quantity from text using regex patterns
 */
function extractQuantityFromText(text) {
  // Remove HTML tags
  const cleanText = text.replace(/<[^>]+>/g, ' ');

  for (const pattern of QUANTITY_PATTERNS) {
    const match = cleanText.match(pattern);
    if (match) {
      return match[0].trim();
    }
  }

  return null;
}

/**
 * Main function to process all products
 */
async function processProducts() {
  console.log('Reading product-prices.json...');
  
  const data = fs.readFileSync(PRODUCT_PRICES_PATH, 'utf8');
  const products = JSON.parse(data);

  console.log(`Found ${products.length} products`);
  console.log('Fetching quantities from Amazon (this may take a while)...\n');

  let updated = 0;
  let skipped = 0;

  for (let i = 0; i < products.length; i++) {
    const product = products[i];
    
    // Skip if already has quantity
    if (product.quantity) {
      console.log(`[${i + 1}/${products.length}] ‚úì ${product.ingredient} - Already has quantity: "${product.quantity}"`);
      skipped++;
      continue;
    }

    // Extract ASIN from URL
    const asinMatch = product.url?.match(/\/dp\/([A-Z0-9]{10})/);
    if (!asinMatch) {
      console.log(`[${i + 1}/${products.length}] ‚úó ${product.ingredient} - No ASIN found`);
      continue;
    }

    const asin = asinMatch[1];
    console.log(`[${i + 1}/${products.length}] Fetching ${product.ingredient} (${asin})...`);

    const quantity = await fetchProductDetails(asin);
    
    if (quantity) {
      product.quantity = quantity;
      updated++;
      console.log(`  ‚úì Found: "${quantity}"\n`);
    } else {
      console.log(`  ‚ö† Could not extract quantity\n`);
    }

    // Rate limiting - wait between requests
    if (i < products.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  console.log(`\n‚úì Updated ${updated} products with quantities`);
  console.log(`‚äò Skipped ${skipped} products (already had quantities)`);

  // Save updated products
  console.log('\nSaving updated product-prices.json...');
  fs.writeFileSync(PRODUCT_PRICES_PATH, JSON.stringify(products, null, 2));
  console.log('‚úì Done!');
}

// Run the script
processProducts().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
</file>

<file path="scripts/fetch-product-prices-batch.ts">
// scripts/fetch-product-prices-batch.ts
// Fetch prices for first 5 products as a test

import * as fs from 'fs';
import * as path from 'path';
import { VETTED_PRODUCTS } from '../lib/data/vetted-products';
import { extractASIN } from '../lib/utils/affiliateLinks';

interface PriceData {
  ingredient: string;
  asin: string;
  url: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
    unit?: string;
  };
  error?: string;
}

const REQUEST_DELAY = 3000;
const BATCH_LIMIT = 5; // Only test first 5

async function fetchPriceWithHTTP(url: string): Promise<{ price: number; unit?: string } | null> {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
      },
      signal: controller.signal,
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      return null;
    }
    
    const html = await response.text();
    
    const pricePatterns = [
      /<span[^>]*class="a-price[^"]*"[^>]*>[\s\S]*?<span[^>]*class="a-offscreen"[^>]*>([^<]+)<\/span>/i,
      /id="priceblock_[^"]*"[^>]*>[\s\S]*?([\d,]+\.?\d*)/i,
      /"price":\s*"([\d,]+\.?\d*)"/i,
      /data-a-color="price"[^>]*>[\s\S]*?\$([\d,]+\.?\d*)/i,
    ];
    
    for (const pattern of pricePatterns) {
      const match = html.match(pattern);
      if (match) {
        const priceText = match[1].replace(/[^0-9.]/g, '');
        const price = parseFloat(priceText);
        if (price > 0 && price < 10000) {
          return { price };
        }
      }
    }
    
    return null;
  } catch (error) {
    return null;
  }
}

async function main() {
  console.log('üß™ Testing Price Fetching (First 5 Products)\n');
  
  const products = Object.entries(VETTED_PRODUCTS)
    .filter(([_, product]) => product.asinLink)
    .slice(0, BATCH_LIMIT)
    .map(([ingredient, product]) => ({
      ingredient,
      asin: extractASIN(product.asinLink) || '',
      url: product.asinLink,
    }));
  
  const results: PriceData[] = [];
  
  for (let i = 0; i < products.length; i++) {
    const product = products[i];
    console.log(`[${i + 1}/${products.length}] ${product.ingredient} (${product.asin})`);
    
    const priceData = await fetchPriceWithHTTP(product.url);
    
    if (priceData && priceData.price > 0) {
      console.log(`  ‚úÖ $${priceData.price.toFixed(2)}\n`);
      results.push({
        ingredient: product.ingredient,
        asin: product.asin,
        url: product.url,
        price: {
          amount: priceData.price,
          currency: 'USD',
          lastUpdated: new Date().toISOString(),
          unit: priceData.unit,
        },
      });
    } else {
      console.log(`  ‚ùå Failed\n`);
      results.push({
        ingredient: product.ingredient,
        asin: product.asin,
        url: product.url,
        price: {
          amount: 0,
          currency: 'USD',
          lastUpdated: new Date().toISOString(),
        },
        error: 'Price not found',
      });
    }
    
    if (i < products.length - 1) {
      await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
    }
  }
  
  console.log(`\n‚úÖ Test complete: ${results.filter(r => r.price.amount > 0).length}/${results.length} successful\n`);
}

main().catch(console.error);
</file>

<file path="scripts/fetch-product-prices.ts">
// scripts/fetch-product-prices.ts
// Fetch current prices from Amazon for all vetted products

import * as fs from 'fs';
import * as path from 'path';
import { VETTED_PRODUCTS } from '../lib/data/vetted-products';
import { extractASIN } from '../lib/utils/affiliateLinks';

interface PriceData {
  ingredient: string;
  asin: string;
  url: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
    unit?: string;
  };
  error?: string;
}

interface ProgressData {
  lastIndex: number;
  results: PriceData[];
  startTime: string;
}

const PROGRESS_FILE = path.join(__dirname, '../data/price-fetch-progress.json');
const RESULTS_FILE = path.join(__dirname, '../data/product-prices.json');
const UPDATE_CODE_FILE = path.join(__dirname, '../data/vetted-products-price-updates.ts');

// Delay between requests (milliseconds)
const REQUEST_DELAY = 3000; // 3 seconds to respect rate limits (reduce if needed)
const BATCH_SIZE = 10; // Save progress every N products

// Extract ASIN and URL from vetted products
function extractProductsToFetch(): Array<{ ingredient: string; asin: string; url: string }> {
  const products: Array<{ ingredient: string; asin: string; url: string }> = [];
  
  Object.entries(VETTED_PRODUCTS).forEach(([ingredient, product]) => {
    if (product.asinLink) {
      const asin = extractASIN(product.asinLink);
      if (asin) {
        products.push({
          ingredient,
          asin,
          url: product.asinLink,
        });
      }
    }
  });
  
  return products;
}

// Fetch price using lightweight HTTP request (faster than Puppeteer)
async function fetchPriceWithHTTP(url: string): Promise<{ price: number; unit?: string } | null> {
  try {
    // Use Node's built-in fetch (available in Node 18+)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
      },
      signal: controller.signal,
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      return null;
    }
    
    const html = await response.text();
    
    // Try multiple price selectors
    const pricePatterns = [
      /<span[^>]*class="a-price[^"]*"[^>]*>[\s\S]*?<span[^>]*class="a-offscreen"[^>]*>([^<]+)<\/span>/i,
      /id="priceblock_[^"]*"[^>]*>[\s\S]*?([\d,]+\.?\d*)/i,
      /"price":\s*"([\d,]+\.?\d*)"/i,
      /data-a-color="price"[^>]*>[\s\S]*?\$([\d,]+\.?\d*)/i,
    ];
    
    for (const pattern of pricePatterns) {
      const match = html.match(pattern);
      if (match) {
        const priceText = match[1].replace(/[^0-9.]/g, '');
        const price = parseFloat(priceText);
        if (price > 0 && price < 10000) { // Sanity check
          return { price };
        }
      }
    }
    
    return null;
  } catch (error) {
    // HTTP request failed, return null to try Puppeteer
    return null;
  }
}

// Fetch price using Puppeteer (more reliable but slower)
async function fetchPriceWithPuppeteer(url: string): Promise<{ price: number; unit?: string } | null> {
  try {
    const scraperDir = path.join(__dirname, '../pet-ingredient-scraper');
    const distPath = path.resolve(scraperDir, 'dist/scrapers/AmazonScraper.js');
    
    // Check if scraper exists
    if (!fs.existsSync(distPath)) {
      console.log('  ‚ö†Ô∏è  AmazonScraper not found, skipping Puppeteer fallback');
      return null;
    }
    
    // Import AmazonScraper from compiled dist
    const scraperModule = await import(`file://${distPath.replace(/\\/g, '/')}`);
    const AmazonScraper = scraperModule.AmazonScraper;
    const scraper = new AmazonScraper({ headless: true });
    
    try {
      // Use the getProductDetails method if available
      if (scraper.getProductDetails) {
        const result = await scraper.getProductDetails(url);
        if (result.details && result.details.price > 0) {
          await scraper.close();
          return {
            price: result.details.price,
            unit: undefined, // Can be extracted from details if needed
          };
        }
      }
      
      // Fallback: manual extraction
      await scraper.initializeBrowser();
      const page = (scraper as any).page;
      if (!page) {
        await scraper.close();
        return null;
      }
      
      const success = await (scraper as any).safeNavigate(url);
      if (!success) {
        await scraper.close();
        return null;
      }
      
      // Wait for product details to load
      await page.waitForSelector('#productTitle, .a-price', { timeout: 10000 }).catch(() => null);
      
      const result = await page.evaluate(() => {
        // Try multiple price selectors
        const priceSelectors = [
          '.a-price .a-offscreen',
          '#priceblock_ourprice',
          '#priceblock_dealprice',
          '.a-price-whole',
          '[data-a-color="price"] .a-offscreen',
        ];
        
        for (const selector of priceSelectors) {
          const element = document.querySelector(selector);
          if (element) {
            const priceText = element.textContent || '';
            const price = parseFloat(priceText.replace(/[^0-9.]/g, ''));
            if (price > 0 && price < 10000) {
              // Try to find unit information
              const unitText = document.querySelector('.a-size-base.a-color-secondary')?.textContent || '';
              const unitMatch = unitText.match(/(per\s+[a-z]+|per\s+[a-z]+\s+[a-z]+)/i);
              
              return {
                price,
                unit: unitMatch ? unitMatch[1] : undefined,
              };
            }
          }
        }
        
        return null;
      });
      
      await scraper.close();
      return result;
    } catch (error) {
      await scraper.close().catch(() => {});
      return null;
    }
  } catch (error) {
    return null;
  }
}

// Fetch price for a single product (tries HTTP first, falls back to Puppeteer)
async function fetchProductPrice(
  ingredient: string,
  asin: string,
  url: string,
  index: number,
  total: number
): Promise<PriceData> {
  console.log(`[${index + 1}/${total}] Fetching price for: ${ingredient} (${asin})`);
  
    // Try HTTP first (faster)
    let priceData = await fetchPriceWithHTTP(url);
    
    // If HTTP failed, try Puppeteer (but warn it's slow)
    if (!priceData) {
      console.log(`  ‚ö†Ô∏è  HTTP failed, trying Puppeteer (this will be slower)...`);
      priceData = await fetchPriceWithPuppeteer(url);
    }
  
  if (priceData && priceData.price > 0) {
    console.log(`  ‚úÖ Price: $${priceData.price.toFixed(2)}${priceData.unit ? ` ${priceData.unit}` : ''}`);
    return {
      ingredient,
      asin,
      url,
      price: {
        amount: priceData.price,
        currency: 'USD',
        lastUpdated: new Date().toISOString(),
        unit: priceData.unit,
      },
    };
  } else {
    console.log(`  ‚ùå Could not fetch price`);
    return {
      ingredient,
      asin,
      url,
      price: {
        amount: 0,
        currency: 'USD',
        lastUpdated: new Date().toISOString(),
      },
      error: 'Price not found',
    };
  }
}

// Load progress if exists
function loadProgress(): ProgressData | null {
  if (fs.existsSync(PROGRESS_FILE)) {
    try {
      const data = JSON.parse(fs.readFileSync(PROGRESS_FILE, 'utf-8'));
      return data;
    } catch (error) {
      return null;
    }
  }
  return null;
}

// Save progress
function saveProgress(progress: ProgressData) {
  const dir = path.dirname(PROGRESS_FILE);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  fs.writeFileSync(PROGRESS_FILE, JSON.stringify(progress, null, 2));
}

// Generate TypeScript code for updating vetted-products.ts
function generateUpdateCode(results: PriceData[]): string {
  const updates: string[] = [];
  
  results.forEach(result => {
    if (result.price.amount > 0 && !result.error) {
      const priceCode = `price: {
      amount: ${result.price.amount},
      currency: '${result.price.currency}',
      lastUpdated: '${result.price.lastUpdated}'${result.price.unit ? `,
      unit: '${result.price.unit}'` : ''}
    }`;
      updates.push(`'${result.ingredient}': { price: ... }`);
    }
  });
  
  // Generate a more useful update format
  let code = `// Price updates for vetted-products.ts
// Generated: ${new Date().toISOString()}
// Total products with prices: ${results.filter(r => r.price.amount > 0).length}

export const PRICE_UPDATES: Record<string, any> = {
`;
  
  results.forEach(result => {
    if (result.price.amount > 0 && !result.error) {
      code += `  '${result.ingredient}': {\n`;
      code += `    price: {\n`;
      code += `      amount: ${result.price.amount},\n`;
      code += `      currency: '${result.price.currency}',\n`;
      code += `      lastUpdated: '${result.price.lastUpdated}'${result.price.unit ? `,\n      unit: '${result.price.unit}'` : ''}\n`;
      code += `    }\n`;
      code += `  },\n`;
    }
  });
  
  code += `};\n`;
  
  return code;
}

// Main execution
async function main() {
  console.log('üí∞ Fetching Product Prices\n');
  console.log('='.repeat(60));
  
  const products = extractProductsToFetch();
  console.log(`\nüìã Found ${products.length} products to fetch prices for\n`);
  
  // Load progress if exists
  let progress = loadProgress();
  let startIndex = 0;
  const results: PriceData[] = [];
  
  if (progress) {
    console.log(`üìÇ Found existing progress (${progress.results.length} products already fetched)`);
    console.log(`üîÑ Resuming from index ${progress.lastIndex + 1}\n`);
    startIndex = progress.lastIndex + 1;
    results.push(...progress.results);
  } else {
    progress = {
      lastIndex: -1,
      results: [],
      startTime: new Date().toISOString(),
    };
  }
  
  // Fetch prices
  for (let i = startIndex; i < products.length; i++) {
    const product = products[i];
    
    try {
      const priceData = await fetchProductPrice(
        product.ingredient,
        product.asin,
        product.url,
        i,
        products.length
      );
      
      results.push(priceData);
      
      // Update progress
      progress.lastIndex = i;
      progress.results = results;
      saveProgress(progress);
      
      // Save results periodically
      if ((i + 1) % BATCH_SIZE === 0) {
        fs.writeFileSync(RESULTS_FILE, JSON.stringify(results, null, 2));
        const elapsed = Math.round((Date.now() - new Date(progress.startTime).getTime()) / 1000 / 60);
        const remaining = Math.round((elapsed / (i + 1)) * (products.length - i - 1));
        console.log(`  üíæ Progress saved (${i + 1}/${products.length}) | Elapsed: ${elapsed}m | Est. remaining: ${remaining}m\n`);
      }
      
      // Delay between requests
      if (i < products.length - 1) {
        await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
      }
    } catch (error) {
      console.error(`  ‚ùå Error: ${error}`);
      results.push({
        ingredient: product.ingredient,
        asin: product.asin,
        url: product.url,
        price: {
          amount: 0,
          currency: 'USD',
          lastUpdated: new Date().toISOString(),
        },
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      
      // Continue with next product
      progress.lastIndex = i;
      progress.results = results;
      saveProgress(progress);
      
      // Delay before retry
      await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
    }
  }
  
  // Save final results
  fs.writeFileSync(RESULTS_FILE, JSON.stringify(results, null, 2));
  
  // Generate update code
  const updateCode = generateUpdateCode(results);
  fs.writeFileSync(UPDATE_CODE_FILE, updateCode);
  
  // Clean up progress file
  if (fs.existsSync(PROGRESS_FILE)) {
    fs.unlinkSync(PROGRESS_FILE);
  }
  
  // Summary
  const successful = results.filter(r => r.price.amount > 0 && !r.error).length;
  const failed = results.filter(r => r.price.amount === 0 || r.error).length;
  
  console.log('\n' + '='.repeat(60));
  console.log('üìä SUMMARY\n');
  console.log(`Total products: ${results.length}`);
  console.log(`‚úÖ Successful: ${successful}`);
  console.log(`‚ùå Failed: ${failed}`);
  console.log(`\nüìÑ Results saved to: ${RESULTS_FILE}`);
  console.log(`üìÑ Update code saved to: ${UPDATE_CODE_FILE}`);
  console.log('\n‚úÖ Price fetching complete!\n');
}

// Run
main().catch(error => {
  console.error('‚ùå Fatal error:', error);
  process.exit(1);
});
</file>

<file path="scripts/find-better-emoji-images.py">
"""
Script to find better emoji images from the segmented grids
and suggest improved mappings based on visual analysis
"""
from PIL import Image
import os
from pathlib import Path
import json

def analyze_emoji_image(image_path):
    """Analyze an emoji image to determine what it represents"""
    try:
        img = Image.open(image_path)
        if img.mode != 'RGB':
            img = img.convert('RGB')
        
        # Get color distribution
        pixels = list(img.getdata())
        width, height = img.size
        
        # Calculate average colors
        avg_r = sum(p[0] for p in pixels) / len(pixels)
        avg_g = sum(p[1] for p in pixels) / len(pixels)
        avg_b = sum(p[2] for p in pixels) / len(pixels)
        
        # Check for specific patterns
        # Green = checkmark, yellow = star, red = X/warning, etc.
        is_green = avg_g > avg_r + 20 and avg_g > avg_b + 20
        is_yellow = avg_r > 200 and avg_g > 200 and avg_b < 150
        is_red = avg_r > avg_g + 30 and avg_r > avg_b + 30
        is_blue = avg_b > avg_r + 20 and avg_b > avg_g + 20
        is_white = avg_r > 240 and avg_g > 240 and avg_b > 240
        is_black = avg_r < 50 and avg_g < 50 and avg_b < 50
        
        # Check shape patterns (simple heuristics)
        # For checkmarks: look for diagonal patterns
        # For stars: look for pointy shapes
        # For thumbs: look for hand-like shapes
        
        return {
            'avg_r': avg_r,
            'avg_g': avg_g,
            'avg_b': avg_b,
            'is_green': is_green,
            'is_yellow': is_yellow,
            'is_red': is_red,
            'is_blue': is_blue,
            'is_white': is_white,
            'is_black': is_black,
            'brightness': (avg_r + avg_g + avg_b) / 3
        }
    except Exception as e:
        return {'error': str(e)}

def find_best_status_emojis():
    """Find the best images for status emojis"""
    emojis_dir = Path('public/images/emojis')
    
    if not emojis_dir.exists():
        print(f"‚ùå Emoji directory not found: {emojis_dir}")
        return {}
    
    # Analyze copilot emojis (they have symbols)
    copilot_files = sorted(emojis_dir.glob('copilot_emojis_*.png'))
    
    candidates = {
        'checkmark': [],  # Green checkmarks
        'star': [],       # Yellow stars
        'thumbs_up': [],  # Thumbs up
        'thumbs_down': [], # Thumbs down
        'balance': [],    # Scale/balance
        'warning': [],    # Warning signs
        'x': []           # X marks
    }
    
    print("üîç Analyzing copilot emojis for status symbols...\n")
    
    for img_file in copilot_files:
        analysis = analyze_emoji_image(img_file)
        if 'error' in analysis:
            continue
        
        # Categorize based on color patterns
        if analysis['is_green'] and analysis['brightness'] > 100:
            candidates['checkmark'].append((img_file.name, analysis))
        elif analysis['is_yellow']:
            candidates['star'].append((img_file.name, analysis))
        elif analysis['is_red']:
            if 'warning' in img_file.name.lower() or analysis['brightness'] < 150:
                candidates['warning'].append((img_file.name, analysis))
            else:
                candidates['x'].append((img_file.name, analysis))
        elif analysis['is_blue']:
            candidates['balance'].append((img_file.name, analysis))
    
    # Sort candidates by relevance
    for key in candidates:
        candidates[key].sort(key=lambda x: x[1]['brightness'], reverse=True)
    
    return candidates

def main():
    print("üîç Finding better emoji images...\n")
    
    candidates = find_best_status_emojis()
    
    suggestions = {}
    for emoji_type, candidate_list in candidates.items():
        if candidate_list:
            best = candidate_list[0]
            suggestions[emoji_type] = {
                'file': best[0],
                'path': f'/images/emojis/{best[0]}',
                'confidence': 'high' if len(candidate_list) > 0 else 'medium'
            }
            print(f"‚úÖ {emoji_type}: {best[0]}")
        else:
            print(f"‚ùå {emoji_type}: No good candidates found")
    
    # Save suggestions
    output_path = Path('data/better-emoji-suggestions.json')
    output_path.parent.mkdir(exist_ok=True)
    with open(output_path, 'w') as f:
        json.dump(suggestions, f, indent=2)
    
    print(f"\nüíæ Suggestions saved to: {output_path}")
    print("\n‚úÖ Done! Check the suggestions file for improved emoji mappings.")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/find-highest-protein.ts">
import { INGREDIENT_COMPOSITIONS } from '../lib/data/ingredientCompositions';

const entries = Object.entries(INGREDIENT_COMPOSITIONS);
const sorted = entries
  .filter(([_, c]) => c.protein)
  .sort((a, b) => (b[1].protein || 0) - (a[1].protein || 0));

console.log('TOP 20 HIGHEST PROTEIN INGREDIENTS:');
sorted.slice(0, 20).forEach(([name, comp]) => {
  console.log(`${name}: ${comp.protein}% protein`);
});

console.log('\nDOG/CAT PROTEIN SOURCES (protein category):');
const proteinSources = entries.filter(([_, c]) => 
  c.protein && 
  (c.speciesCompatibility?.dog === 'ok' || c.speciesCompatibility?.cat === 'ok')
);
proteinSources.sort((a, b) => (b[1].protein || 0) - (a[1].protein || 0));
proteinSources.slice(0, 15).forEach(([name, comp]) => {
  console.log(`${name}: ${comp.protein}% protein (dog: ${comp.speciesCompatibility?.dog}, cat: ${comp.speciesCompatibility?.cat})`);
});
</file>

<file path="scripts/fix-affiliate-links.mjs">
// Auto-fix script for Amazon affiliate links
// Fixes what can be automated:
// 1. Add missing affiliate tags
// 2. Normalize URL format to /dp/ASIN
// 3. Remove tracking junk while keeping ASIN
// Does NOT try to guess ASINs for search URLs (manual work)

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const SELLER_ID = 'robinfrench-20';

// Files to fix
const FILES = [
  path.join(__dirname, '../lib/data/vetted-products.ts'),
  path.join(__dirname, '../lib/data/vetted-products-generic.ts'),
  path.join(__dirname, '../lib/data/vetted-products-UPDATED.ts'),
];

let totalFixed = 0;
let totalNormalized = 0;

function extractASIN(url) {
  if (!url) return null;
  
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (dpMatch) return dpMatch[1];
  
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (gpMatch) return gpMatch[1];
  
  const productMatch = url.match(/\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (productMatch) return productMatch[1];
  
  return null;
}

function normalizeToDpUrl(url) {
  const asin = extractASIN(url);
  if (!asin) return url; // Can't normalize without ASIN
  
  totalNormalized++;
  return `https://www.amazon.com/dp/${asin}`;
}

function ensureSellerId(url) {
  if (!url) return url;
  
  // Already has our tag?
  if (url.includes(`tag=${SELLER_ID}`)) {
    return url;
  }
  
  totalFixed++;
  
  // Add tag
  const separator = url.includes('?') ? '&' : '?';
  return `${url}${separator}tag=${SELLER_ID}`;
}

function fixAmazonLinks(content) {
  // Match asinLink or amazonLink fields in TypeScript object literals
  // Pattern: asinLink: 'https://...' or amazonLink: 'https://...'
  const linkPattern = /(asinLink|amazonLink):\s*'([^']+)'/g;
  
  return content.replace(linkPattern, (match, fieldName, url) => {
    // Only process Amazon URLs
    if (!url.includes('amazon.com')) {
      return match;
    }
    
    // Step 1: Normalize to /dp/ASIN format
    let fixedUrl = normalizeToDpUrl(url);
    
    // Step 2: Ensure affiliate tag
    fixedUrl = ensureSellerId(fixedUrl);
    
    return `${fieldName}: '${fixedUrl}'`;
  });
}

console.log('üîß Amazon Affiliate Link Auto-Fix\n');
console.log('='.repeat(60));

FILES.forEach(filePath => {
  if (!fs.existsSync(filePath)) {
    console.log(`‚ö†Ô∏è  Skipping ${path.basename(filePath)} (not found)`);
    return;
  }
  
  console.log(`\nüìù Processing ${path.basename(filePath)}...`);
  
  const originalContent = fs.readFileSync(filePath, 'utf8');
  const fixedContent = fixAmazonLinks(originalContent);
  
  if (originalContent !== fixedContent) {
    fs.writeFileSync(filePath, fixedContent, 'utf8');
    console.log(`‚úÖ Fixed and saved`);
  } else {
    console.log(`‚úÖ No changes needed`);
  }
});

console.log('\n' + '='.repeat(60));
console.log('üìä SUMMARY\n');
console.log(`Affiliate tags added: ${totalFixed}`);
console.log(`URLs normalized: ${totalNormalized}`);
console.log('\n‚úÖ Auto-fix complete!');
console.log('\nüí° Next steps:');
console.log('1. Run audit again: npx tsx lib/generator/AmazonLinkAudit.ts');
console.log('2. Review duplicate ASINs manually (see MANUAL_REVIEW_NEEDED.md)');
console.log('3. Test a few links in browser to verify they work');
</file>

<file path="scripts/fix-emoji-colors.py">
"""
Script to analyze emoji images and identify which ones have correct colors
and which ones are inverted. Also identifies the best images for each emoji type.
"""
from PIL import Image
import os
from pathlib import Path
import json

def analyze_image_colors(image_path):
    """Analyze if an image has inverted colors (check if it's mostly dark/light)"""
    try:
        img = Image.open(image_path)
        # Convert to RGB if needed
        if img.mode != 'RGB':
            img = img.convert('RGB')
        
        # Get average brightness
        pixels = list(img.getdata())
        avg_brightness = sum(sum(p) for p in pixels) / (len(pixels) * 3)
        
        # Check if image is mostly transparent/white (might be inverted)
        # Normal emojis should have some color, not be pure white/black
        has_color = False
        color_variance = 0
        
        if len(pixels) > 0:
            # Check color variance
            r_values = [p[0] for p in pixels]
            g_values = [p[1] for p in pixels]
            b_values = [p[2] for p in pixels]
            
            if r_values and g_values and b_values:
                r_var = max(r_values) - min(r_values)
                g_var = max(g_values) - min(g_values)
                b_var = max(b_values) - min(b_values)
                color_variance = (r_var + g_var + b_var) / 3
                has_color = color_variance > 20  # Threshold for having actual color
        
        return {
            'avg_brightness': avg_brightness,
            'has_color': has_color,
            'color_variance': color_variance,
            'likely_inverted': avg_brightness > 200 and color_variance < 30,  # Very bright with low variance = likely inverted
            'likely_good': has_color and 50 < avg_brightness < 200  # Good color range
        }
    except Exception as e:
        return {
            'error': str(e),
            'likely_inverted': False,
            'likely_good': False
        }

def find_best_emoji_candidates():
    """Find the best emoji images from all available grids"""
    emojis_dir = Path('public/images/emojis')
    
    if not emojis_dir.exists():
        print(f"‚ùå Emoji directory not found: {emojis_dir}")
        return {}
    
    # Analyze all images
    all_images = {}
    
    for image_file in sorted(emojis_dir.glob('*.png')):
        analysis = analyze_image_colors(image_file)
        all_images[image_file.name] = {
            'path': str(image_file.relative_to('public')),
            **analysis
        }
    
    # Categorize by quality
    good_images = {k: v for k, v in all_images.items() if v.get('likely_good', False)}
    inverted_images = {k: v for k, v in all_images.items() if v.get('likely_inverted', False)}
    other_images = {k: v for k, v in all_images.items() if k not in good_images and k not in inverted_images}
    
    return {
        'good': good_images,
        'inverted': inverted_images,
        'other': other_images,
        'all': all_images
    }

def suggest_emoji_mappings():
    """Suggest better emoji mappings based on image analysis"""
    analysis = find_best_emoji_candidates()
    
    # Common emoji types we need
    emoji_needs = {
        'dog': ['üêï', 'üê∂'],
        'cat': ['üêà', 'üê±'],
        'bird': ['ü¶ú', 'üê¶'],
        'turtle': ['ü¶é', 'üê¢'],
        'rabbit': ['üê∞', 'üêá'],
        'hamster': ['üêπ'],
        'mouse': ['üê≠'],
        'hedgehog': ['ü¶î'],
        'paw': ['üêæ'],
        'checkmark': ['‚úÖ'],
        'thumbs_up': ['üëç'],
        'thumbs_down': ['üëé'],
        'balance': ['‚öñÔ∏è'],
        'star': ['‚≠ê'],
        'sparkle': ['‚ú®']
    }
    
    # Find best candidates from good images
    suggestions = {}
    
    for emoji_type, emojis in emoji_needs.items():
        # Look for images that might match
        candidates = []
        for img_name, img_data in analysis['good'].items():
            # Simple heuristic: check filename patterns
            if emoji_type in img_name.lower() or any(e in img_name for e in emojis):
                candidates.append((img_name, img_data))
        
        if candidates:
            # Sort by quality (color variance, brightness)
            candidates.sort(key=lambda x: (
                -x[1].get('color_variance', 0),
                abs(x[1].get('avg_brightness', 128) - 128)  # Prefer mid-range brightness
            ))
            suggestions[emoji_type] = {
                'emojis': emojis,
                'best_candidate': candidates[0][0],
                'path': candidates[0][1]['path'],
                'all_candidates': [c[0] for c in candidates[:3]]
            }
    
    return suggestions

def main():
    print("üîç Analyzing emoji images for color issues...\n")
    
    analysis = find_best_emoji_candidates()
    
    print(f"‚úÖ Found {len(analysis['good'])} good quality images")
    print(f"‚ö†Ô∏è  Found {len(analysis['inverted'])} potentially inverted images")
    print(f"‚ùì Found {len(analysis['other'])} other images\n")
    
    if analysis['inverted']:
        print("‚ö†Ô∏è  Potentially inverted images (very bright, low color variance):")
        for img_name in list(analysis['inverted'].keys())[:10]:
            print(f"   - {img_name}")
        if len(analysis['inverted']) > 10:
            print(f"   ... and {len(analysis['inverted']) - 10} more")
        print()
    
    # Generate suggestions
    suggestions = suggest_emoji_mappings()
    
    print("üí° Suggested emoji mappings (best quality images):")
    for emoji_type, suggestion in suggestions.items():
        print(f"   {emoji_type}: {suggestion['best_candidate']} ({suggestion['path']})")
    
    # Save analysis to file
    output = {
        'analysis': analysis,
        'suggestions': suggestions,
        'summary': {
            'total_images': len(analysis['all']),
            'good_images': len(analysis['good']),
            'inverted_images': len(analysis['inverted']),
            'other_images': len(analysis['other'])
        }
    }
    
    output_path = Path('data/emoji-color-analysis.json')
    output_path.parent.mkdir(exist_ok=True)
    with open(output_path, 'w') as f:
        json.dump(output, f, indent=2)
    
    print(f"\nüíæ Analysis saved to: {output_path}")
    print("\n‚úÖ Done! Check the analysis file for detailed results.")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/fix-string-escaping.js">
const fs = require('fs');
const path = require('path');

const files = [
  'lib/data/vetted-products-generic.ts',
  'lib/data/vetted-products-UPDATED.ts'
];

files.forEach(filePath => {
  console.log(`Fixing ${filePath}...`);
  
  let content = fs.readFileSync(filePath, 'utf8');
  
  // Fix: Replace strings with apostrophes by escaping them properly
  // Match single-quoted strings containing unescaped apostrophes
  content = content.replace(/'([^'\\]*(?:\\.[^'\\]*)*)'s([^'\\]*(?:\\.[^'\\]*)*)'/g, (match, before, after) => {
    // If the apostrophe is already escaped, leave it
    if (match.includes("\\'s")) return match;
    // Otherwise, escape it
    return `'${before}\\'s${after}'`;
  });
  
  fs.writeFileSync(filePath, content, 'utf8');
  console.log(`‚úì Fixed ${filePath}`);
});

console.log('\nDone! All string escaping issues fixed.');
</file>

<file path="scripts/fix-string-escaping.mjs">
import fs from 'fs';

const files = [
  'lib/data/vetted-products-generic.ts',
  'lib/data/vetted-products-UPDATED.ts'
];

files.forEach(filePath => {
  console.log(`Fixing ${filePath}...`);
  
  let content = fs.readFileSync(filePath, 'utf8');
  
  // Fix: Replace strings with apostrophes by escaping them properly
  // Match single-quoted strings containing unescaped apostrophes
  content = content.replace(/'([^'\\]*(?:\\.[^'\\]*)*)'s([^'\\]*(?:\\.[^'\\]*)*)'/g, (match, before, after) => {
    // If the apostrophe is already escaped, leave it
    if (match.includes("\\'s")) return match;
    // Otherwise, escape it
    return `'${before}\\'s${after}'`;
  });
  
  fs.writeFileSync(filePath, content, 'utf8');
  console.log(`‚úì Fixed ${filePath}`);
});

console.log('\nDone! All string escaping issues fixed.');
</file>

<file path="scripts/generate-brand-suggestions.ts">
// scripts/generate-brand-suggestions.ts
// Generate brand-based product suggestions for ingredients

import fs from 'fs';
import path from 'path';
import { BrandBasedVetter } from '../lib/services/brandBasedVetter';

async function main() {
  console.log('üîç Generating brand-based product suggestions...\n');
  
  // Load ingredients needing vetting
  const ingredientsPath = path.join(__dirname, '../data/ingredients-needing-vetting.json');
  
  if (!fs.existsSync(ingredientsPath)) {
    console.error('‚ùå ingredients-needing-vetting.json not found. Run vet:recipes first.');
    process.exit(1);
  }
  
  const allIngredients = JSON.parse(fs.readFileSync(ingredientsPath, 'utf-8'));
  const ingredientNames = allIngredients.map((item: any) => item.name);
  
  console.log(`Processing ${ingredientNames.length} ingredients...\n`);
  
  const vetter = new BrandBasedVetter();
  const suggestions: any[] = [];
  
  for (const ingredient of ingredientNames) {
    const matches = vetter.findBrandMatches(ingredient);
    
    if (matches.length > 0) {
      const bestMatch = matches[0];
      const vettedProduct = vetter.generateVettedProduct(ingredient, bestMatch);
      
      suggestions.push({
        ingredient,
        ...vettedProduct,
        brand: bestMatch.brand,
        qualityScore: bestMatch.qualityScore,
        priceRange: bestMatch.priceRange
      });
    }
  }
  
  // Group by confidence
  const highConfidence = suggestions.filter(s => s.confidence >= 0.8);
  const mediumConfidence = suggestions.filter(s => s.confidence >= 0.6 && s.confidence < 0.8);
  const lowConfidence = suggestions.filter(s => s.confidence < 0.6);
  
  console.log('=== BRAND SUGGESTIONS ===');
  console.log(`High confidence (‚â•80%): ${highConfidence.length} products`);
  console.log(`Medium confidence (60-80%): ${mediumConfidence.length} products`);
  console.log(`Low confidence (<60%): ${lowConfidence.length} products\n`);
  
  // Save all suggestions
  const suggestionsPath = path.join(__dirname, '../data/brand-suggestions.json');
  fs.writeFileSync(suggestionsPath, JSON.stringify(suggestions, null, 2));
  console.log(`‚úÖ All suggestions saved to: data/brand-suggestions.json`);
  
  // Generate update script for high-confidence products
  generateUpdateScript(highConfidence, 'high-confidence');
  generateUpdateScript(mediumConfidence, 'medium-confidence');
  
  console.log('\nüìù Review the generated scripts and add products to vetted-products.ts');
}

function generateUpdateScript(products: any[], confidence: string) {
  let script = `// BRAND-BASED VETTED PRODUCTS (${confidence})\n`;
  script += `// Review these products and add to lib/data/vetted-products.ts\n\n`;
  script += `const brandVettedProducts_${confidence.replace('-', '_')} = {\n`;
  
  products.forEach(product => {
    const key = product.ingredient.toLowerCase()
      .replace(/\s+/g, '_')
      .replace(/[()]/g, '')
      .replace(/[^a-z0-9_]/g, '');
    
    script += `  '${key}': {\n`;
    script += `    productName: '${product.productName.replace(/'/g, "\\'")}',\n`;
    script += `    amazonLink: '${product.amazonLink}',\n`;
    script += `    vetNote: '${product.vetNote.replace(/'/g, "\\'")}',\n`;
    script += `    category: '${product.category}',\n`;
    script += `    commissionRate: ${product.commissionRate},\n`;
    script += `    confidence: ${product.confidence.toFixed(2)},\n`;
    script += `    source: 'brand_analysis',\n`;
    script += `    brand: '${product.brand}',\n`;
    script += `    qualityScore: ${product.qualityScore}\n`;
    script += `  },\n`;
  });
  
  script += '};\n';
  
  const scriptPath = path.join(__dirname, `../data/brand-vetted-${confidence}.ts`);
  fs.writeFileSync(scriptPath, script);
  console.log(`‚úÖ ${confidence} script generated: data/brand-vetted-${confidence}.ts`);
}

main().catch(console.error);
</file>

<file path="scripts/generate-celebrity-names.ts.disabled">
// scripts/generate-celebrity-names.ts
// Generates 850 celebrity pet names + quotes using Claude API

import Anthropic from '@anthropic-ai/sdk';
import * as fs from 'fs';
import * as path from 'path';

const client = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || 'your-api-key-here'
});

interface CelebrityPet {
  name: string;
  quote: string;
  petType: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
}

// We already have 150, need 850 more
const EXISTING_COUNT = 150;
const TOTAL_NEEDED = 1000;
const TO_GENERATE = TOTAL_NEEDED - EXISTING_COUNT;

// Distribution by pet type
const DISTRIBUTION = {
  dog: 350,    // Dogs are most popular
  cat: 300,    // Cats second
  bird: 75,    // Birds less common
  reptile: 75, // Reptiles less common
  'pocket-pet': 50 // Smallest category
};

async function generateCelebrityBatch(
  petType: string,
  count: number,
  startIndex: number
): Promise<CelebrityPet[]> {

  const prompt = `Generate ${count} celebrity pet names for ${petType}s.

RULES:
1. Name must be a pun on a famous person/character
2. Must be funny but not offensive
3. Quote must be in-character, 1 sentence, about food/nutrition
4. Variety: mix historical figures, actors, musicians, fictional characters
5. Avoid duplicates

FORMAT (return ONLY valid JSON array):
[
  {
    "name": "Bark Obama",
    "quote": "Yes we can... eat healthy and nutritious meals!"
  },
  {
    "name": "Sherlock Bones",
    "quote": "Elementary, my dear Woofson - this meal is excellent!"
  }
]

Generate ${count} unique ${petType} celebrity names now.`;

  try {
    const response = await client.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4000,
      messages: [{
        role: 'user',
        content: prompt
      }]
    });

    const textContent = response.content
      .filter(block => block.type === 'text')
      .map(block => block.text)
      .join('');

    // Parse JSON response
    const jsonMatch = textContent.match(/\[[\s\S]*\]/);
    if (!jsonMatch) {
      throw new Error('No JSON array found in response');
    }

    const celebrities = JSON.parse(jsonMatch[0]);

    // Add pet type to each
    return celebrities.map((c: any) => ({
      ...c,
      petType: petType
    }));

  } catch (error) {
    console.error(`Error generating ${petType} batch:`, error);
    return [];
  }
}

async function generateAllCelebrities(): Promise<CelebrityPet[]> {
  console.log('üé≠ Generating 850 Celebrity Pet Names + Quotes...\n');

  const allCelebrities: CelebrityPet[] = [];
  let totalGenerated = 0;

  for (const [petType, count] of Object.entries(DISTRIBUTION)) {
    console.log(`\nüìù Generating ${count} ${petType} celebrities...`);

    // Generate in batches of 50 to avoid token limits
    const batchSize = 50;
    const batches = Math.ceil(count / batchSize);

    for (let i = 0; i < batches; i++) {
      const batchCount = Math.min(batchSize, count - (i * batchSize));
      const startIndex = totalGenerated + (i * batchSize);

      console.log(`  Batch ${i + 1}/${batches}: Generating ${batchCount} names...`);

      const batch = await generateCelebrityBatch(
        petType as any,
        batchCount,
        startIndex
      );

      allCelebrities.push(...batch);
      totalGenerated += batch.length;

      console.log(`  ‚úÖ Generated ${batch.length} names (Total: ${totalGenerated}/${TO_GENERATE})`);

      // Small delay to avoid rate limits
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  return allCelebrities;
}

async function main() {
  console.log('üöÄ Celebrity Pet Name Generator\n');
  console.log(`Target: Generate ${TO_GENERATE} new celebrity pets`);
  console.log(`(We already have ${EXISTING_COUNT})\n`);

  // Generate all celebrities
  const celebrities = await generateAllCelebrities();

  console.log(`\n‚úÖ Generated ${celebrities.length} celebrity pets!\n`);

  // Save to file
  const outputPath = path.join(process.cwd(), 'lib', 'data', 'generated-celebrities.ts');

  const fileContent = `// Generated Celebrity Pet Names
// Auto-generated on ${new Date().toISOString()}

export interface GeneratedCelebrity {
  name: string;
  quote: string;
  petType: 'dog' | 'cat' | 'bird' | 'reptile' | 'pocket-pet';
}

export const generatedCelebrities: GeneratedCelebrity[] = ${JSON.stringify(celebrities, null, 2)};

// Statistics:
// Total: ${celebrities.length}
// Dogs: ${celebrities.filter(c => c.petType === 'dog').length}
// Cats: ${celebrities.filter(c => c.petType === 'cat').length}
// Birds: ${celebrities.filter(c => c.petType === 'bird').length}
// Reptiles: ${celebrities.filter(c => c.petType === 'reptile').length}
// Pocket Pets: ${celebrities.filter(c => c.petType === 'pocket-pet').length}
`;

  fs.writeFileSync(outputPath, fileContent, 'utf8');

  console.log(`üìÅ Saved to: ${outputPath}\n`);

  // Statistics
  console.log('üìä Final Statistics:');
  console.log(`   Total Generated: ${celebrities.length}`);
  console.log(`   Dogs: ${celebrities.filter(c => c.petType === 'dog').length}`);
  console.log(`   Cats: ${celebrities.filter(c => c.petType === 'cat').length}`);
  console.log(`   Birds: ${celebrities.filter(c => c.petType === 'bird').length}`);
  console.log(`   Reptiles: ${celebrities.filter(c => c.petType === 'reptile').length}`);
  console.log(`   Pocket Pets: ${celebrities.filter(c => c.petType === 'pocket-pet').length}`);

  console.log('\nüí∞ Cost Estimate: ~$5 in API calls');
  console.log('‚è±Ô∏è  Total Time: ~10-15 minutes\n');
  console.log('‚úÖ Done! Use these in your recipes.');
}

// Alternative: Assign celebrities to recipes automatically
async function assignCelebritiesToRecipes() {
  console.log('\nüîó Assigning celebrities to recipes...\n');

  // Load recipes
  const recipesPath = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.ts');
  let recipesContent = fs.readFileSync(recipesPath, 'utf8');

  // Load generated celebrities
  const celebsPath = path.join(process.cwd(), 'lib', 'data', 'generated-celebrities.ts');
  const celebsContent = fs.readFileSync(celebsPath, 'utf8');

  // Parse celebrities (simplified)
  const celebMatch = celebsContent.match(/export const generatedCelebrities.*?=.*?(\[[\s\S]*?\]);/);
  if (!celebMatch) {
    console.error('Could not parse celebrities');
    return;
  }

  const celebrities = JSON.parse(celebMatch[1]);

  // Group by pet type
  const celebsByType: Record<string, CelebrityPet[]> = {
    dogs: celebrities.filter((c: CelebrityPet) => c.petType === 'dog'),
    cats: celebrities.filter((c: CelebrityPet) => c.petType === 'cat'),
    birds: celebrities.filter((c: CelebrityPet) => c.petType === 'bird'),
    reptiles: celebrities.filter((c: CelebrityPet) => c.petType === 'reptile'),
    'pocket-pets': celebrities.filter((c: CelebrityPet) => c.petType === 'pocket-pet')
  };

  // Find recipes and add celebrities
  let recipeCount = 0;
  recipesContent = recipesContent.replace(
    /createRecipe\(\{([^}]+category:\s*['"](\w+)['"][^}]*)\}/g,
    (match, recipeContent, category) => {
      const celebPool = celebsByType[category] || [];
      if (celebPool.length === 0) return match;

      // Pick a random celebrity (or sequential)
      const celeb = celebPool[recipeCount % celebPool.length];
      recipeCount++;

      // Check if already has celebrity
      if (match.includes('celebrityName')) return match;

      // Add celebrity fields
      const withCeleb = match.replace(
        /\}$/,
        `,\n  celebrityName: '${celeb.name}',\n  celebrityQuote: '${celeb.quote}'\n}`
      );

      return withCeleb;
    }
  );

  // Save updated recipes
  fs.writeFileSync(recipesPath, recipesContent, 'utf8');

  console.log(`‚úÖ Added celebrities to ${recipeCount} recipes`);
  console.log('üìÅ Updated: lib/data/recipes-complete.ts\n');
}

// Run it
main()
  .then(() => {
    console.log('\nüéâ Generation complete!');
    console.log('\nNext steps:');
    console.log('1. Review generated-celebrities.ts');
    console.log('2. Run: npm run assign-celebrities (assigns to recipes)');
    console.log('3. Restart dev server\n');
  })
  .catch(console.error);

export { generateAllCelebrities, assignCelebritiesToRecipes };
</file>

<file path="scripts/generate-recipes.ts">
// scripts/generate-recipes.ts
// UPDATED VERSION - Uses completeRecipeSystem for nutritionally-validated recipes
import fs from 'fs';
import path from 'path';
import { generateValidatedRecipe } from '../lib/utils/completeRecipeSystem';
import { VETTED_SPECIES_MAP } from '../lib/data/vetted-species-map';
import { generateMealName } from '../lib/utils/mealNameGenerator';

const RECIPES_PER_SPECIES = 40;
const SPECIES_LIST = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'] as const;

const CELEBRITIES = [
  'Gordon Ramsay', 'Jamie Oliver', 'Martha Stewart', 'Emeril Lagasse',
  'Bobby Flay', 'Rachael Ray', 'Ina Garten', 'Julia Child',
  'Wolfgang Puck', 'Anthony Bourdain', 'Nigella Lawson', 'Alton Brown'
];

const ADJECTIVES = [
  'Delicious', 'Nutritious', 'Wholesome', 'Gourmet', 'Hearty',
  'Savory', 'Tasty', 'Premium', 'Healthy', 'Fresh', 'Natural'
];

const HEALTH_CONCERNS = [
  'weight-management', 'kidney-disease', 'digestive-health', 'joint-health', 
  'allergies', 'dental', 'skin-coat', 'heart-disease'
];

function getSafeIngredientsForSpecies(species: string): string[] {
  const singularKey = {
    'dogs': 'dog',
    'cats': 'cat',
    'birds': 'bird',
    'reptiles': 'reptile',
    'pocket-pets': 'pocket-pet'
  }[species] as string;

  if (!singularKey) return [];

  const ingredients: string[] = [];
  
  for (const [key] of Object.entries(VETTED_SPECIES_MAP)) {
    const safeFor = VETTED_SPECIES_MAP[key];
    if (safeFor && safeFor.includes(singularKey as any)) {
      ingredients.push(key);
    }
  }
  
  return [...new Set(ingredients)];
}

function generateRecipe(species: typeof SPECIES_LIST[number], recipeId: number) {
  const availableIngredients = getSafeIngredientsForSpecies(species);
  
  if (availableIngredients.length === 0) {
    console.error(`No ingredients for ${species}`);
    return null;
  }

  // Random life stage
  const lifeStages = ['puppy', 'adult', 'senior'] as const;
  const lifeStage = (species === 'dogs' || species === 'cats')
    ? lifeStages[Math.floor(Math.random() * lifeStages.length)]
    : 'adult' as const;

  // Random health concerns (0-2)
  const numConcerns = Math.floor(Math.random() * 3);
  const healthConcerns: string[] = [];
  for (let i = 0; i < numConcerns; i++) {
    const concern = HEALTH_CONCERNS[Math.floor(Math.random() * HEALTH_CONCERNS.length)];
    if (!healthConcerns.includes(concern)) healthConcerns.push(concern);
  }

  // ‚ú® MAGIC HAPPENS HERE - Use the new system
  const result = generateValidatedRecipe(
    species,
    availableIngredients,
    lifeStage,
    healthConcerns,
    50 // max attempts
  );

  if (!result) {
    console.warn(`Failed to generate recipe for ${species}`);
    return null;
  }

  // Generate recipe name using enhanced naming system
  const generatedRecipeId = `${species}-${recipeId}`;
  const ingredientKeys = result.ingredients.map(ing => ing.name);
  
  // Extract nutritional profile from result
  const nutritionalProfile = result.nutritionalInfo ? {
    protein: result.nutritionalInfo.protein.percentage,
    fat: result.nutritionalInfo.fat.percentage,
    fiber: result.nutritionalInfo.fiber ? (result.nutritionalInfo.fiber.grams / result.nutritionalInfo.totalCalories) * 100 : undefined,
  } : undefined;
  
  // Create a Recipe-like object for naming
  const recipeForNaming = {
    id: generatedRecipeId,
    name: '',
    category: species,
    ingredients: result.ingredients.map(ing => ({ id: '', name: ing.name, amount: `${ing.amount}g` })),
    instructions: result.instructions || [],
    description: result.description,
    healthConcerns: healthConcerns.length > 0 ? healthConcerns : [],
  };
  
  const nameResult = generateMealName(ingredientKeys, {
    petSpecies: species.slice(0, -1), // Convert 'dogs' to 'dog'
    healthConcerns: healthConcerns.length > 0 ? healthConcerns : undefined,
    nutritionalProfile,
    mealType: 'complete',
    recipeId: generatedRecipeId,
    recipe: recipeForNaming as any,
    isCustomMeal: false,
  });
  
  const recipeName = nameResult.fullName;

  // Map life stage to age groups
  const ageGroups = lifeStage === 'puppy' 
    ? ['baby', 'young']
    : lifeStage === 'senior'
    ? ['senior']
    : ['adult'];

  // Determine if recipe needs review
  const needsReview = !result.validation.isValid || 
    (result.validation.estimatedNutritionPercent || 0) > 30 ||
    (result.validation.missingIngredients?.length || 0) > 0;

  return {
    id: generatedRecipeId,
    name: recipeName,
    shortName: nameResult.shortName,
    category: species,
    breed: null,
    ageGroup: ageGroups,
    healthConcerns: healthConcerns.length > 0 ? healthConcerns : ['none'],
    description: result.description,
    tags: ['vetted', 'balanced', 'nutritionally-validated', ...healthConcerns],
    imageUrl: `/images/meals/${species}-meal-${(recipeId % 25) + 1}.png`,
    prepTime: '15-20 minutes',
    cookTime: '10-15 minutes',
    servings: 1,
    ingredients: result.ingredients.map((ing, i) => ({
      id: `${i+1}`,
      name: ing.name,
      amount: `${Math.round(ing.amount)}g`,
      category: ing.category,
    })),
    instructions: result.instructions,
    // ‚ú® ADD NUTRITIONAL INFO
    nutritionInfo: {
      calories: Math.round(result.nutritionalInfo.totalCalories),
      protein: Math.round(result.nutritionalInfo.protein.grams),
      proteinPct: parseFloat(result.nutritionalInfo.protein.percentage.toFixed(1)),
      fat: Math.round(result.nutritionalInfo.fat.grams),
      fatPct: parseFloat(result.nutritionalInfo.fat.percentage.toFixed(1)),
      carbs: Math.round(result.nutritionalInfo.carbs.grams),
      fiber: Math.round(result.nutritionalInfo.fiber.grams),
      calcium: Math.round(result.nutritionalInfo.calcium),
      phosphorus: Math.round(result.nutritionalInfo.phosphorus),
      caPRatio: parseFloat(result.nutritionalInfo.caPRatio.toFixed(2)),
    },
    portionGuidance: result.portionGuidance,
    // ‚ú® ADD VALIDATION INFO
    validation: {
      status: result.validation.isValid ? 'validated' : 'needs_review',
      validatedAt: new Date().toISOString(),
      method: 'dry_matter',
      standards: species === 'dogs' || species === 'cats' ? ['AAFCO'] : ['research-based'],
      warnings: result.validation.warnings,
      errors: result.validation.errors,
      missingIngredients: result.validation.missingIngredients || [],
      estimatedNutritionPercent: result.validation.estimatedNutritionPercent,
      score: result.validation.score,
    },
    needsReview,
    generationInfo: {
      version: '2.0',
      attempts: 50, // maxAttempts used
      confidence: result.validation.score / 100,
    },
    generatedAt: new Date().toISOString(),
    generationMethod: 'nutritionally-validated',
    rating: 4.5 + (Math.random() * 0.5),
    reviews: Math.floor(Math.random() * 50) + 10
  };
}

async function generateAllRecipes() {
  const startTime = Date.now();
  console.log('üöÄ Starting nutritionally-validated recipe generation...\n');

  // Backup old recipes if they exist
  const jsonOutputPath = path.join(__dirname, '../lib/data/recipes-complete.json');
  const tsOutputPath = path.join(__dirname, '../lib/data/recipes-complete.ts');
  const backupPath = path.join(__dirname, '../lib/data/recipes-complete.backup.json');
  
  if (fs.existsSync(jsonOutputPath)) {
    console.log('üì¶ Backing up existing recipes...');
    fs.copyFileSync(jsonOutputPath, backupPath);
    console.log(`   ‚úì Backed up to: ${backupPath}\n`);
  }

  const allRecipes: any[] = [];
  const stats = { 
    total: 0, 
    success: 0, 
    failed: 0, 
    needsReview: 0,
    missingIngredientsCount: 0,
    bySpecies: {} as Record<string, { 
      success: number; 
      failed: number;
      needsReview: number;
      avgScore: number;
      totalScore: number;
      scoreCount: number;
    }> 
  };

  const missingIngredientsMap: Record<string, number> = {};

  for (const species of SPECIES_LIST) {
    console.log(`üìù Generating recipes for ${species}...`);
    stats.bySpecies[species] = { success: 0, failed: 0, needsReview: 0, avgScore: 0, totalScore: 0, scoreCount: 0 };

    for (let i = 0; i < RECIPES_PER_SPECIES; i++) {
      const recipe = generateRecipe(species, i + 1);
      
      if (recipe) {
        allRecipes.push(recipe);
        stats.success++;
        stats.bySpecies[species].success++;
        
        if (recipe.needsReview) {
          stats.needsReview++;
          stats.bySpecies[species].needsReview++;
        }
        
        if (recipe.validation?.score !== undefined) {
          stats.bySpecies[species].totalScore += recipe.validation.score;
          stats.bySpecies[species].scoreCount++;
        }
        
        // Track missing ingredients
        if (recipe.validation?.missingIngredients) {
          recipe.validation.missingIngredients.forEach((ing: string) => {
            missingIngredientsMap[ing] = (missingIngredientsMap[ing] || 0) + 1;
            stats.missingIngredientsCount++;
          });
        }
      } else {
        stats.failed++;
        stats.bySpecies[species].failed++;
      }
      
      stats.total++;

      if ((i + 1) % 10 === 0) {
        console.log(`  ‚úì ${i + 1}/${RECIPES_PER_SPECIES} recipes`);
      }
    }
    
    const avgScore = stats.bySpecies[species].scoreCount > 0
      ? stats.bySpecies[species].totalScore / stats.bySpecies[species].scoreCount
      : 0;
    stats.bySpecies[species].avgScore = avgScore;
    
    console.log(`  ‚úÖ ${species}: ${stats.bySpecies[species].success} successful, ${stats.bySpecies[species].needsReview} need review, avg score: ${avgScore.toFixed(1)}/100\n`);
  }

  // Save recipes to JSON (for easier loading)
  fs.writeFileSync(jsonOutputPath, JSON.stringify(allRecipes, null, 2));
  
  // Also save as TypeScript file for type safety
  const fileContent = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Generated on: ${new Date().toISOString()}
// Total recipes: ${allRecipes.length}
// Generation version: 2.0

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(allRecipes, null, 2)};
`;
  fs.writeFileSync(tsOutputPath, fileContent);
  
  const duration = ((Date.now() - startTime) / 1000).toFixed(1);
  
  console.log('\nüéâ Recipe generation complete!');
  console.log(`‚è±Ô∏è  Duration: ${duration}s`);
  console.log(`üìä Total: ${stats.success}/${stats.total} (${((stats.success/stats.total)*100).toFixed(1)}% success)`);
  console.log(`‚ö†Ô∏è  Needs Review: ${stats.needsReview} (${((stats.needsReview/stats.total)*100).toFixed(1)}%)`);
  console.log(`üìÅ Saved to: ${jsonOutputPath}`);
  console.log(`üìÅ Saved to: ${tsOutputPath}\n`);

  // Print detailed stats
  console.log('üìà Breakdown by species:');
  Object.entries(stats.bySpecies).forEach(([species, counts]) => {
    console.log(`  ${species}:`);
    console.log(`    ‚úì Success: ${counts.success}`);
    console.log(`    ‚úó Failed: ${counts.failed}`);
    console.log(`    ‚ö†Ô∏è  Needs Review: ${counts.needsReview}`);
    console.log(`    üìä Avg Score: ${counts.avgScore.toFixed(1)}/100`);
  });
  
  // Print missing ingredients summary
  if (Object.keys(missingIngredientsMap).length > 0) {
    console.log('\nüîç Missing Ingredients Summary (most frequent):');
    const sorted = Object.entries(missingIngredientsMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);
    sorted.forEach(([ing, count]) => {
      console.log(`  ${ing}: ${count} recipes`);
    });
    console.log(`  ... and ${Object.keys(missingIngredientsMap).length - 10} more`);
  }
  
  console.log('\n');
}

if (require.main === module) {
  generateAllRecipes().catch(console.error);
}

export { generateRecipe, generateAllRecipes };
</file>

<file path="scripts/generate-verification-state.ts">
// scripts/generate-verification-state.ts
// Generate initial verification state based on analysis results

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface AnalysisResult {
  ingredient: string;
  analysis: {
    confidence: 'high' | 'medium' | 'low';
  };
  needsManualCheck: boolean;
}

function generateVerificationState() {
  // Read the analysis results
  const analysisFile = path.join(__dirname, '../data/asin-analysis-results.json');

  if (!fs.existsSync(analysisFile)) {
    console.error('Analysis results not found. Run the verification script first.');
    process.exit(1);
  }

  const analysisData = JSON.parse(fs.readFileSync(analysisFile, 'utf-8')) as {
    results: AnalysisResult[];
  };

  // Generate initial state where high-confidence items are pre-verified
  const initialState = analysisData.results.map(result => ({
    ingredient: result.ingredient,
    verified: result.analysis.confidence === 'high',
    needsReview: result.needsManualCheck,
    autoVerified: result.analysis.confidence === 'high'
  }));

  // Save to a file that can be imported
  const outputFile = path.join(__dirname, '../lib/data/verification-state.ts');
  const tsCode = `// Generated verification state - ${new Date().toISOString()}\n` +
    `// High-confidence products are auto-verified, others need manual review\n\n` +
    `export interface VerificationState {\n` +
    `  ingredient: string;\n` +
    `  verified: boolean;\n` +
    `  needsReview: boolean;\n` +
    `  autoVerified: boolean;\n` +
    `}\n\n` +
    `export const INITIAL_VERIFICATION_STATE: VerificationState[] = ${JSON.stringify(initialState, null, 2)};\n`;

  fs.writeFileSync(outputFile, tsCode);

  console.log(`‚úÖ Generated verification state for ${initialState.length} products`);
  console.log(`üìä Auto-verified: ${initialState.filter(s => s.autoVerified).length}`);
  console.log(`üîç Needs review: ${initialState.filter(s => s.needsReview).length}`);
  console.log(`üìÑ Saved to: ${outputFile}`);
}

generateVerificationState();
</file>

<file path="scripts/generation/generate_celebrity_pets.py">
import requests
import os
import time
from PIL import Image
import io
import base64
import tkinter as tk
from tkinter import scrolledtext
import threading
import concurrent.futures
from concurrent.futures import ThreadPoolExecutor
import hashlib

# Define the prompt template
PROMPT_TEMPLATE = "Cute 3d vector image of the celebrity pet: {}"
POLLINATION_URL = "https://image.pollinations.ai/prompt/"

# Quote generation data
CELEB_POOLS = {
    'dogs': [
        'Bark Obama','Mutt Damon','Chew-barka','Salvador Dogi','Hairy Styles',
        'Droolius Caesar','Sherlock Bones','Bark Twain','Jimmy Chew','Snoop Doggy Dog'
    ],
    'cats': [
        'Catrick Swayze','Leonardo DiCatrio','Meowly Cyrus','Purr-ince','Cat Damon',
        'William Shakespaw','Clawdia Schiffer','Fur-dinand Magellan','Meowrio Andretti','Kitty Purry'
    ],
    'birds': [
        'Tweety Mercury','Squawkstin Bieber','Chirp Cobain','Feather Locklear','Beaky Blinders',
        'Wing Crosby','Tweetie Poppins','Beak Affleck','Fluffy Gaga','Plume Hathaway'
    ],
    'reptiles': [
        'Scale-y Cyrus','Lizard of Oz','Geck-o Washington','Rango Stallone','Sir Hissington',
        'Gila Clooney','Scaley Cooper','Rex Sauron','Iggy Pop','Cold-Blooded Coleman'
    ],
    'pocket-pets': [
        'Ham Solo','Bun Jovi','Whisker Nelson','Gerbil Gates','Puff Daddy',
        'Fuzz Aldrin','Pipsqueak Jordan','Squeakers O\'Neal','Nibble Newton','Buckminster Fuzz'
    ],
}

TAGS = [
    'a tail-wagging triumph',
    'a purrfect bite',
    'a feather-ruffling delight',
    'a scales-approved staple',
    'a hop-and-nibble favorite',
    'a culinary comfort',
    'an epic chew-fest',
    'a snooze-and-savor meal',
    'a barkworthy banquet',
    'a whisker-twitching wonder',
    'a chirp-causing classic',
    'a slippery-sweet supper',
    'an anxious-belly soother',
    'a crunchy, chewy celebration',
    'a slow-cooked nostalgia'
]

TEMPLATES = {
    'dogs': [
        "As I always say, pet food is {}.",
        "My fellow canines, try pet food ‚Äî {}.",
        "If you enjoy bones, you'll adore pet food; truly {}."
    ],
    'cats': [
        "I declare pet food to be absolutely {}.",
        "In my refined opinion, pet food is {}.",
        "Paws down ‚Äî pet food is {}."
    ],
    'birds': [
        "Pet food made me chirp ‚Äî {}.",
        "Squawk: pet food equals {}.",
        "If it makes me preen, it's pet food ‚Äî truly {}."
    ],
    'reptiles': [
        "Pet food is slow-cooked and {}.",
        "Cold-bloodedly, pet food is {}.",
        "Scale-tested: pet food is {}."
    ],
    'pocket-pets': [
        "Pet food is tiny but {}.",
        "Nibble-approved: pet food is {}.",
        "Small meal, big joy ‚Äî pet food is {}."
    ],
}

def hash_string_to_number(s):
    # Simple deterministic hash
    h = 2166136261
    for char in s:
        h = (h ^ ord(char)) * 16777619 & 0xFFFFFFFF
    return abs(h)

def get_quote_for_pet(pet_name, category):
    pool = CELEB_POOLS.get(category, CELEB_POOLS['dogs'])
    id_hash = hash_string_to_number(pet_name)
    id_str = str(id_hash)
    celeb_index = int(id_str[-2:]) % len(pool)
    tag_index = int(id_str[:2]) % len(TAGS)
    template_index = int(id_str[-1:]) % len(TEMPLATES[category])

    author = pool[celeb_index]
    tag = TAGS[tag_index]
    template = TEMPLATES[category][template_index]

    text = template.format(tag)

    return author, text

def download_image(pet_name, prompt, i, pet_folder, headers, output_callback=None):
    """Download a single image with retry logic"""
    url = POLLINATION_URL + prompt.replace(' ', '%20') + f"?seed={i}&width=512&height=512"

    # Retry logic with exponential backoff
    max_retries = 5
    for attempt in range(max_retries):
        try:
            response = requests.get(url, headers=headers, timeout=60)
            response.raise_for_status()
            img = Image.open(io.BytesIO(response.content))
            img_path = os.path.join(pet_folder, f"image_{i+1}.png")
            img.save(img_path)
            return f"Downloaded image_{i+1}.png for '{pet_name}'"
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1:
                wait_time = 5 ** attempt  # Exponential backoff: 1, 5, 25, 125, 625 seconds
                message = f"Timeout for '{pet_name}' image {i+1}, attempt {attempt+1}/{max_retries}. Retrying in {wait_time}s..."
                if output_callback:
                    output_callback(message)
                else:
                    print(message)
                time.sleep(wait_time)
            else:
                return f"Failed to download image_{i+1}.png for '{pet_name}': Timeout after {max_retries} attempts"
        except requests.exceptions.RequestException as e:
            if "429" in str(e):
                if attempt < max_retries - 1:
                    wait_time = 10 ** attempt  # Longer backoff for 429: 1, 10, 100 seconds
                    message = f"Rate limit for '{pet_name}' image {i+1}, attempt {attempt+1}/{max_retries}. Retrying in {wait_time}s..."
                    if output_callback:
                        output_callback(message)
                    else:
                        print(message)
                    time.sleep(wait_time)
                else:
                    return f"Failed to download image_{i+1}.png for '{pet_name}': Rate limit after {max_retries} attempts"
            else:
                return f"Failed to download image_{i+1}.png for '{pet_name}': {e}"

def generate_images(output_callback=None, pet_type='pocket-pets'):
    if pet_type == 'cats':
        # Read cat names from celebrity_pet_names.txt (lines 98-161 approximately)
        with open('celebrity_pet_names.txt', 'r') as f:
            all_names = [line.strip() for line in f if line.strip()]
        # Cat names are roughly lines 98-161
        pet_names = all_names[97:161]  # 0-indexed, lines 98-161
    elif pet_type == 'dogs':
        # Read dog names from celebrity_pet_names.txt (lines 1-97)
        with open('celebrity_pet_names.txt', 'r') as f:
            all_names = [line.strip() for line in f if line.strip()]
        pet_names = all_names[0:97]  # lines 1-97
    else:
        with open('pocket_pet_names.txt', 'r') as f:
            pet_names = [line.strip() for line in f if line.strip()]

    os.makedirs("images", exist_ok=True)

    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }

    for index, pet_name in enumerate(pet_names, 1):
        prompt = PROMPT_TEMPLATE.format(pet_name)

        message = f"[{index}/{len(pet_names)}] Generating images for '{pet_name}' using prompt: '{prompt}'"
        if output_callback:
            output_callback(message)
        else:
            print(message)

        try:
            # Create folder per pet to save images
            pet_folder = os.path.join("images", pet_name.replace(" ", "_"))
            os.makedirs(pet_folder, exist_ok=True)

            # Generate 9 images sequentially to avoid rate limits
            with ThreadPoolExecutor(max_workers=1) as executor:
                futures = []
                for i in range(9):
                    future = executor.submit(download_image, pet_name, prompt, i, pet_folder, headers, output_callback)
                    futures.append(future)

                # Wait for all downloads to complete
                for future in concurrent.futures.as_completed(futures):
                    result = future.result()
                    if output_callback:
                        output_callback(result)
                    else:
                        print(result)

            # Generate and save quote
            author, text = get_quote_for_pet(pet_name, pet_type)
            quote_path = os.path.join(pet_folder, "quote.txt")
            with open(quote_path, 'w') as f:
                f.write(f"Author: {author}\nQuote: {text}\n")

            message = f"Saved 9 images and quote for '{pet_name}' in '{pet_folder}'"
            if output_callback:
                output_callback(message)
            else:
                print(message)

        except Exception as e:
            message = f"Error generating images for '{pet_name}': {e}"
            if output_callback:
                output_callback(message)
            else:
                print(message)
            continue

        # Sleep to avoid rate limits (adjust timing if needed)
        time.sleep(30)

    message = "All images generated and saved!"
    if output_callback:
        output_callback(message)
    else:
        print(message)

def start_generation(text_area):
    def output_callback(message):
        text_area.insert(tk.END, message + '\n')
        text_area.see(tk.END)

    threading.Thread(target=generate_images, args=(output_callback,)).start()

def create_gui():
    root = tk.Tk()
    root.title("Celebrity Pet Image Generator")

    text_area = scrolledtext.ScrolledText(root, width=80, height=20)
    text_area.pack(pady=10)

    button = tk.Button(root, text="Generate Images", command=lambda: start_generation(text_area))
    button.pack(pady=10)

    root.mainloop()

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == "--gui":
        create_gui()
    elif len(sys.argv) > 1 and sys.argv[1] == "--cats":
        # Generate cat images
        generate_images(pet_type='cats')
    elif len(sys.argv) > 1 and sys.argv[1] == "--dogs":
        # Generate dog images
        generate_images(pet_type='dogs')
    else:
        # Run directly without GUI
        generate_images()
</file>

<file path="scripts/generation/generate_ingredient_images.py">
import os
import time
import io
import requests
from PIL import Image

POLLINATION_URL = "https://image.pollinations.ai/prompt/"

# Prompts for each ingredient (one image per ingredient)
INGREDIENT_PROMPTS = {
    # PROTEINS
    "Chicken": "Cute cartoon whole chicken, thick black outlines, flat 2D vector style, simple geometric shapes, warm orange-yellow color, minimal details, white background",
    "Beef": "Cute cartoon beef steak with marbling pattern, thick black outlines, flat 2D vector style, simple shapes, red-pink color, minimal details, white background",
    "Turkey": "Cute cartoon turkey bird, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Duck": "Cute cartoon duck, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Quail": "Cute cartoon quail bird, thick black outlines, flat 2D vector style, simple geometric shapes, speckled brown pattern, minimal details, white background",
    "Lamb": "Cute cartoon lamb, thick black outlines, flat 2D vector style, simple geometric shapes, white fluffy texture suggested, minimal details, white background",
    "Rabbit": "Cute cartoon rabbit, thick black outlines, flat 2D vector style, simple geometric shapes, gray-white color, floppy ears, minimal details, white background",
    "Pork": "Cute cartoon pig, thick black outlines, flat 2D vector style, simple geometric shapes, pink color, minimal details, white background",
    "Eggs": "Cute cartoon eggs in carton, thick black outlines, flat 2D vector style, simple geometric shapes, white and cream colors, minimal details, white background",
    "Salmon": "Cute cartoon salmon fish, thick black outlines, flat 2D vector style, simple geometric shapes, pink-orange color, minimal details, white background",
    "Sardines": "Cute cartoon sardine fish, thick black outlines, flat 2D vector style, simple geometric shapes, silver-blue color, minimal details, white background",
    "Mackerel": "Cute cartoon mackerel fish with stripes, thick black outlines, flat 2D vector style, simple geometric shapes, blue-silver color, minimal details, white background",
    "Herring": "Cute cartoon herring fish, thick black outlines, flat 2D vector style, simple geometric shapes, silver color, minimal details, white background",
    "Anchovy": "Cute cartoon anchovy fish, thick black outlines, flat 2D vector style, simple geometric shapes, small silver fish, minimal details, white background",
    "Fish": "Cute cartoon generic fish, thick black outlines, flat 2D vector style, simple geometric shapes, blue-orange color, minimal details, white background",
    "Crickets": "Cute cartoon cricket insect, thick black outlines, flat 2D vector style, simple geometric shapes, brown-green color, minimal details, white background",
    "Roaches": "Cute cartoon dubia roach, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Worms": "Cute cartoon mealworm, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-tan color, minimal details, white background",

    # GRAINS & LEGUMES
    "Rice": "Cute cartoon rice grains in bowl, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Oats": "Cute cartoon oat flakes in bowl, thick black outlines, flat 2D vector style, simple geometric shapes, beige-tan color, minimal details, white background",
    "Quinoa": "Cute cartoon quinoa seeds pile, thick black outlines, flat 2D vector style, simple geometric shapes, cream-tan color, minimal details, white background",
    "Buckwheat": "Cute cartoon buckwheat groats, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Barley": "Cute cartoon barley grains, thick black outlines, flat 2D vector style, simple geometric shapes, golden-tan color, minimal details, white background",
    "Millet": "Cute cartoon millet seeds, thick black outlines, flat 2D vector style, simple geometric shapes, yellow color, minimal details, white background",
    "Sorghum": "Cute cartoon sorghum grains, thick black outlines, flat 2D vector style, simple geometric shapes, cream color, minimal details, white background",
    "Farro": "Cute cartoon farro grains, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",
    "Bulgur": "Cute cartoon bulgur wheat, thick black outlines, flat 2D vector style, simple geometric shapes, golden-brown color, minimal details, white background",
    "Beans": "Cute cartoon kidney beans, thick black outlines, flat 2D vector style, simple geometric shapes, red-brown color, minimal details, white background",
    "Chickpeas": "Cute cartoon chickpeas, thick black outlines, flat 2D vector style, simple geometric shapes, beige-tan color, minimal details, white background",
    "Lentils": "Cute cartoon lentils pile, thick black outlines, flat 2D vector style, simple geometric shapes, orange-brown color, minimal details, white background",
    "Split Peas": "Cute cartoon split peas, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-green color, minimal details, white background",
    "Peas": "Cute cartoon pea pods, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Wheat": "Cute cartoon wheat stalks, thick black outlines, flat 2D vector style, simple geometric shapes, golden-yellow color, minimal details, white background",

    # VEGETABLES
    "Bok Choi": "Cute cartoon bok choy vegetable, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Purslane": "Cute cartoon purslane leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Miner's Lettuce": "Cute cartoon miner's lettuce plant, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Green Beans": "Cute cartoon green beans, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Fennel": "Cute cartoon fennel bulb, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Leeks": "Cute cartoon leek vegetable, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Zucchini": "Cute cartoon zucchini, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Delicata Squash": "Cute cartoon delicata squash, thick black outlines, flat 2D vector style, simple geometric shapes, cream with green stripes, minimal details, white background",
    "Napa Cabbage": "Cute cartoon napa cabbage, thick black outlines, flat 2D vector style, simple geometric shapes, pale green color, minimal details, white background",
    "Acorn Squash": "Cute cartoon acorn squash, thick black outlines, flat 2D vector style, simple geometric shapes, dark green-orange color, minimal details, white background",
    "Turnip Greens": "Cute cartoon turnip greens, thick black outlines, flat 2D vector style, simple geometric shapes, green leaves, minimal details, white background",
    "Yellow Squash": "Cute cartoon yellow squash, thick black outlines, flat 2D vector style, simple geometric shapes, bright yellow color, minimal details, white background",
    "Brussels Sprouts": "Cute cartoon brussels sprouts, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Lamb's Quarters": "Cute cartoon lamb's quarters leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Watercress": "Cute cartoon watercress bunch, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Eggplant": "Cute cartoon eggplant, thick black outlines, flat 2D vector style, simple geometric shapes, purple color, minimal details, white background",
    "Artichokes": "Cute cartoon artichoke, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Asparagus": "Cute cartoon asparagus spears, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Radicchio": "Cute cartoon radicchio head, thick black outlines, flat 2D vector style, simple geometric shapes, purple-red color, minimal details, white background",
    "Endive": "Cute cartoon endive, thick black outlines, flat 2D vector style, simple geometric shapes, pale green-white color, minimal details, white background",
    "Fris√©e": "Cute cartoon fris√©e lettuce, thick black outlines, flat 2D vector style, simple geometric shapes, pale yellow-green color, minimal details, white background",
    "Broccoli": "Cute cartoon broccoli floret, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Cauliflower": "Cute cartoon cauliflower head, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Tomatoes": "Cute cartoon tomato, thick black outlines, flat 2D vector style, simple geometric shapes, red color, minimal details, white background",
    "Pumpkin": "Cute cartoon pumpkin, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Sweet Potato": "Cute cartoon sweet potato, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Regular Potato": "Cute cartoon potato, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Spinach": "Cute cartoon spinach leaves, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Kale": "Cute cartoon kale leaves, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Collard Greens": "Cute cartoon collard greens, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Mustard Greens": "Cute cartoon mustard greens, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Dandelion Greens": "Cute cartoon dandelion leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Beet Greens": "Cute cartoon beet greens, thick black outlines, flat 2D vector style, simple geometric shapes, green with red stems, minimal details, white background",
    "Amaranth Leaves": "Cute cartoon amaranth leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green-purple color, minimal details, white background",
    "Red Cabbage": "Cute cartoon red cabbage head, thick black outlines, flat 2D vector style, simple geometric shapes, purple-red color, minimal details, white background",

    # OILS & FATS
    "Salmon Oil": "Cute cartoon oil bottle with salmon icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-orange color, minimal details, white background",
    "Coconut Oil": "Cute cartoon coconut with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, white-brown color, minimal details, white background",
    "Flaxseed": "Cute cartoon flaxseeds pile, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Hemp Seeds": "Cute cartoon hemp seeds, thick black outlines, flat 2D vector style, simple geometric shapes, tan-green color, minimal details, white background",
    "Walnut Oil": "Cute cartoon oil bottle with walnut icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-brown color, minimal details, white background",
    "Black Currant Oil": "Cute cartoon oil bottle with berry icon, thick black outlines, flat 2D vector style, simple geometric shapes, dark purple-gold color, minimal details, white background",
    "Almond Oil": "Cute cartoon oil bottle with almond icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden color, minimal details, white background",
    "Sunflower Oil": "Cute cartoon sunflower with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-gold color, minimal details, white background",
    "Chia Seed Oil": "Cute cartoon chia seeds with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, black speckled, minimal details, white background",
    "Fish Oil": "Cute cartoon oil capsule with fish icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-orange color, minimal details, white background",
    "Olive Oil": "Cute cartoon olive oil bottle with olive branch, thick black outlines, flat 2D vector style, simple geometric shapes, green-gold color, minimal details, white background",
    "Pumpkin Seed Oil": "Cute cartoon pumpkin seeds with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, green-gold color, minimal details, white background",

    # SUPPLEMENTS
    "Kelp Powder": "Cute cartoon kelp seaweed, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Eggshells": "Cute cartoon crushed eggshells, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Turmeric": "Cute cartoon turmeric root, thick black outlines, flat 2D vector style, simple geometric shapes, orange-yellow color, minimal details, white background",
    "Pectin": "Cute cartoon apple with pectin molecules, thick black outlines, flat 2D vector style, simple geometric shapes, red-clear color, minimal details, white background",
    "Cranberry Extract": "Cute cartoon cranberries, thick black outlines, flat 2D vector style, simple geometric shapes, red color, minimal details, white background",
    "Omega-3": "Cute cartoon supplement capsule with omega-3 label, thick black outlines, flat 2D vector style, simple geometric shapes, orange-gold color, minimal details, white background",
    "SAM-e": "Cute cartoon supplement pill bottle, thick black outlines, flat 2D vector style, simple geometric shapes, blue-white color, minimal details, white background",
    "Psyllium Husk": "Cute cartoon psyllium husks, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",
    "Vitamin C": "Cute cartoon orange slice with vitamin label, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Bone Broth": "Cute cartoon steaming bowl, thick black outlines, flat 2D vector style, simple geometric shapes, brown-beige color, minimal details, white background",
    "Fructooligosaccharides": "Cute cartoon prebiotic fiber icon, thick black outlines, flat 2D vector style, simple geometric shapes, green-white color, minimal details, white background",
    "Curcumin": "Cute cartoon turmeric powder pile, thick black outlines, flat 2D vector style, simple geometric shapes, bright orange color, minimal details, white background",
    "Joint Health Supplement": "Cute cartoon joint/bone icon, thick black outlines, flat 2D vector style, simple geometric shapes, blue-white color, minimal details, white background",
    "Brewer's Yeast": "Cute cartoon yeast powder jar, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",

    # OTHER
    "Honey": "Cute cartoon honey jar with dipper, thick black outlines, flat 2D vector style, simple geometric shapes, golden-yellow color, minimal details, white background",
    "Peanut Butter": "Cute cartoon peanut butter jar with peanuts, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Spirulina Powder": "Cute cartoon spirulina powder bowl, thick black outlines, flat 2D vector style, simple geometric shapes, dark green-blue color, minimal details, white background",
    "Probiotic Powder": "Cute cartoon probiotic supplement jar, thick black outlines, flat 2D vector style, simple geometric shapes, white-blue color, minimal details, white background",
    "Vitamin D3": "Cute cartoon sun with vitamin pill, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-orange color, minimal details, white background",
    "Herring Oil": "Cute cartoon oil bottle with herring fish icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-silver color, minimal details, white background",
}


def slugify(name: str) -> str:
    """Simple slug: lowercase, replace spaces with hyphens."""
    return name.lower().replace(" ", "-")


def download_image(prompt: str, name: str, output_dir: str):
    """Download a single image with retry and backoff."""
    filename = f"{slugify(name)}.png"
    seed = sum(ord(c) for c in name)  # deterministic seed
    url = POLLINATION_URL + prompt.replace(" ", "%20") + f"?seed={seed}&width=512&height=512"

    max_retries = 7
    for attempt in range(max_retries):
        try:
            response = requests.get(url, timeout=60)
            response.raise_for_status()
            img = Image.open(io.BytesIO(response.content))
            img_path = os.path.join(output_dir, filename)
            img.save(img_path)
            return f"Downloaded {filename}"
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt
                print(f"Timeout for {name}, retrying in {wait_time}s...")
                time.sleep(wait_time)
            else:
                return f"Failed to download {name}: Timeout"
        except requests.exceptions.RequestException as e:
            if "429" in str(e) or "502" in str(e):
                if attempt < max_retries - 1:
                    wait_time = 3 ** attempt
                    print(f"Rate/Server issue for {name}, retrying in {wait_time}s...")
                    time.sleep(wait_time)
                    continue
            return f"Failed to download {name}: {e}"
    return None


def generate_ingredient_images():
    output_dir = os.path.join("public", "images", "ingredients")
    os.makedirs(output_dir, exist_ok=True)

    total = len(INGREDIENT_PROMPTS)
    print(f"=== Generating {total} ingredient images ===")

    for idx, (name, prompt) in enumerate(INGREDIENT_PROMPTS.items(), start=1):
        filename = f"{slugify(name)}.png"
        img_path = os.path.join(output_dir, filename)

        if os.path.exists(img_path):
            print(f"[SKIP] {filename} already exists")
            continue

        print(f"[{idx}/{total}] {name}")
        result = download_image(prompt, name, output_dir)
        if result:
            print(result)

        time.sleep(1.5)  # gentle pacing

    print(f"\n‚úÖ Done. Images saved to {output_dir}")


if __name__ == "__main__":
    generate_ingredient_images()
import requests
import os
import time
from PIL import Image
import io

# Pollination API URL
POLLINATION_URL = "https://image.pollinations.ai/prompt/"

# Ingredient Prompts Dictionary
INGREDIENT_PROMPTS = {
    # PROTEINS
    "Chicken": "Cute cartoon whole chicken, thick black outlines, flat 2D vector style, simple geometric shapes, warm orange-yellow color, minimal details, white background",
    "Beef": "Cute cartoon beef steak with marbling pattern, thick black outlines, flat 2D vector style, simple shapes, red-pink color, minimal details, white background",
    "Turkey": "Cute cartoon turkey bird, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Duck": "Cute cartoon duck, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Quail": "Cute cartoon quail bird, thick black outlines, flat 2D vector style, simple geometric shapes, speckled brown pattern, minimal details, white background",
    "Lamb": "Cute cartoon lamb, thick black outlines, flat 2D vector style, simple geometric shapes, white fluffy texture suggested, minimal details, white background",
    "Rabbit": "Cute cartoon rabbit, thick black outlines, flat 2D vector style, simple geometric shapes, gray-white color, floppy ears, minimal details, white background",
    "Pork": "Cute cartoon pig, thick black outlines, flat 2D vector style, simple geometric shapes, pink color, minimal details, white background",
    "Eggs": "Cute cartoon eggs in carton, thick black outlines, flat 2D vector style, simple geometric shapes, white and cream colors, minimal details, white background",
    "Salmon": "Cute cartoon salmon fish, thick black outlines, flat 2D vector style, simple geometric shapes, pink-orange color, minimal details, white background",
    "Sardines": "Cute cartoon sardine fish, thick black outlines, flat 2D vector style, simple geometric shapes, silver-blue color, minimal details, white background",
    "Mackerel": "Cute cartoon mackerel fish with stripes, thick black outlines, flat 2D vector style, simple geometric shapes, blue-silver color, minimal details, white background",
    "Herring": "Cute cartoon herring fish, thick black outlines, flat 2D vector style, simple geometric shapes, silver color, minimal details, white background",
    "Anchovy": "Cute cartoon anchovy fish, thick black outlines, flat 2D vector style, simple geometric shapes, small silver fish, minimal details, white background",
    "Fish": "Cute cartoon generic fish, thick black outlines, flat 2D vector style, simple geometric shapes, blue-orange color, minimal details, white background",
    "Crickets": "Cute cartoon cricket insect, thick black outlines, flat 2D vector style, simple geometric shapes, brown-green color, minimal details, white background",
    "Roaches": "Cute cartoon dubia roach, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Worms": "Cute cartoon mealworm, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-tan color, minimal details, white background",

    # GRAINS & LEGUMES
    "Rice": "Cute cartoon rice grains in bowl, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Oats": "Cute cartoon oat flakes in bowl, thick black outlines, flat 2D vector style, simple geometric shapes, beige-tan color, minimal details, white background",
    "Quinoa": "Cute cartoon quinoa seeds pile, thick black outlines, flat 2D vector style, simple geometric shapes, cream-tan color, minimal details, white background",
    "Buckwheat": "Cute cartoon buckwheat groats, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Barley": "Cute cartoon barley grains, thick black outlines, flat 2D vector style, simple geometric shapes, golden-tan color, minimal details, white background",
    "Millet": "Cute cartoon millet seeds, thick black outlines, flat 2D vector style, simple geometric shapes, yellow color, minimal details, white background",
    "Sorghum": "Cute cartoon sorghum grains, thick black outlines, flat 2D vector style, simple geometric shapes, cream color, minimal details, white background",
    "Farro": "Cute cartoon farro grains, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",
    "Bulgur": "Cute cartoon bulgur wheat, thick black outlines, flat 2D vector style, simple geometric shapes, golden-brown color, minimal details, white background",
    "Beans": "Cute cartoon kidney beans, thick black outlines, flat 2D vector style, simple geometric shapes, red-brown color, minimal details, white background",
    "Chickpeas": "Cute cartoon chickpeas, thick black outlines, flat 2D vector style, simple geometric shapes, beige-tan color, minimal details, white background",
    "Lentils": "Cute cartoon lentils pile, thick black outlines, flat 2D vector style, simple geometric shapes, orange-brown color, minimal details, white background",
    "Split Peas": "Cute cartoon split peas, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-green color, minimal details, white background",
    "Peas": "Cute cartoon pea pods, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Wheat": "Cute cartoon wheat stalks, thick black outlines, flat 2D vector style, simple geometric shapes, golden-yellow color, minimal details, white background",

    # VEGETABLES
    "Bok Choi": "Cute cartoon bok choy vegetable, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Purslane": "Cute cartoon purslane leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Miner's Lettuce": "Cute cartoon miner's lettuce plant, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Green Beans": "Cute cartoon green beans, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Fennel": "Cute cartoon fennel bulb, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Leeks": "Cute cartoon leek vegetable, thick black outlines, flat 2D vector style, simple geometric shapes, white-green color, minimal details, white background",
    "Zucchini": "Cute cartoon zucchini, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Delicata Squash": "Cute cartoon delicata squash, thick black outlines, flat 2D vector style, simple geometric shapes, cream with green stripes, minimal details, white background",
    "Napa Cabbage": "Cute cartoon napa cabbage, thick black outlines, flat 2D vector style, simple geometric shapes, pale green color, minimal details, white background",
    "Acorn Squash": "Cute cartoon acorn squash, thick black outlines, flat 2D vector style, simple geometric shapes, dark green-orange color, minimal details, white background",
    "Turnip Greens": "Cute cartoon turnip greens, thick black outlines, flat 2D vector style, simple geometric shapes, green leaves, minimal details, white background",
    "Yellow Squash": "Cute cartoon yellow squash, thick black outlines, flat 2D vector style, simple geometric shapes, bright yellow color, minimal details, white background",
    "Brussels Sprouts": "Cute cartoon brussels sprouts, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Lamb's Quarters": "Cute cartoon lamb's quarters leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Watercress": "Cute cartoon watercress bunch, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Eggplant": "Cute cartoon eggplant, thick black outlines, flat 2D vector style, simple geometric shapes, purple color, minimal details, white background",
    "Artichokes": "Cute cartoon artichoke, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Asparagus": "Cute cartoon asparagus spears, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Radicchio": "Cute cartoon radicchio head, thick black outlines, flat 2D vector style, simple geometric shapes, purple-red color, minimal details, white background",
    "Endive": "Cute cartoon endive, thick black outlines, flat 2D vector style, simple geometric shapes, pale green-white color, minimal details, white background",
    "Fris√©e": "Cute cartoon fris√©e lettuce, thick black outlines, flat 2D vector style, simple geometric shapes, pale yellow-green color, minimal details, white background",
    "Broccoli": "Cute cartoon broccoli floret, thick black outlines, flat 2D vector style, simple geometric shapes, bright green color, minimal details, white background",
    "Cauliflower": "Cute cartoon cauliflower head, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Tomatoes": "Cute cartoon tomato, thick black outlines, flat 2D vector style, simple geometric shapes, red color, minimal details, white background",
    "Pumpkin": "Cute cartoon pumpkin, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Sweet Potato": "Cute cartoon sweet potato, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Regular Potato": "Cute cartoon potato, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Spinach": "Cute cartoon spinach leaves, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Kale": "Cute cartoon kale leaves, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Collard Greens": "Cute cartoon collard greens, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Mustard Greens": "Cute cartoon mustard greens, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Dandelion Greens": "Cute cartoon dandelion leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green color, minimal details, white background",
    "Beet Greens": "Cute cartoon beet greens, thick black outlines, flat 2D vector style, simple geometric shapes, green with red stems, minimal details, white background",
    "Amaranth Leaves": "Cute cartoon amaranth leaves, thick black outlines, flat 2D vector style, simple geometric shapes, green-purple color, minimal details, white background",
    "Red Cabbage": "Cute cartoon red cabbage head, thick black outlines, flat 2D vector style, simple geometric shapes, purple-red color, minimal details, white background",

    # OILS & FATS
    "Salmon Oil": "Cute cartoon oil bottle with salmon icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-orange color, minimal details, white background",
    "Coconut Oil": "Cute cartoon coconut with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, white-brown color, minimal details, white background",
    "Flaxseed": "Cute cartoon flaxseeds pile, thick black outlines, flat 2D vector style, simple geometric shapes, brown color, minimal details, white background",
    "Hemp Seeds": "Cute cartoon hemp seeds, thick black outlines, flat 2D vector style, simple geometric shapes, tan-green color, minimal details, white background",
    "Walnut Oil": "Cute cartoon oil bottle with walnut icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-brown color, minimal details, white background",
    "Black Currant Oil": "Cute cartoon oil bottle with berry icon, thick black outlines, flat 2D vector style, simple geometric shapes, dark purple-gold color, minimal details, white background",
    "Almond Oil": "Cute cartoon oil bottle with almond icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden color, minimal details, white background",
    "Sunflower Oil": "Cute cartoon sunflower with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-gold color, minimal details, white background",
    "Chia Seed Oil": "Cute cartoon chia seeds with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, black speckled, minimal details, white background",
    "Fish Oil": "Cute cartoon oil capsule with fish icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-orange color, minimal details, white background",
    "Olive Oil": "Cute cartoon olive oil bottle with olive branch, thick black outlines, flat 2D vector style, simple geometric shapes, green-gold color, minimal details, white background",
    "Pumpkin Seed Oil": "Cute cartoon pumpkin seeds with oil drop, thick black outlines, flat 2D vector style, simple geometric shapes, green-gold color, minimal details, white background",

    # SUPPLEMENTS
    "Kelp Powder": "Cute cartoon kelp seaweed, thick black outlines, flat 2D vector style, simple geometric shapes, dark green color, minimal details, white background",
    "Eggshells": "Cute cartoon crushed eggshells, thick black outlines, flat 2D vector style, simple geometric shapes, white color, minimal details, white background",
    "Turmeric": "Cute cartoon turmeric root, thick black outlines, flat 2D vector style, simple geometric shapes, orange-yellow color, minimal details, white background",
    "Pectin": "Cute cartoon apple with pectin molecules, thick black outlines, flat 2D vector style, simple geometric shapes, red-clear color, minimal details, white background",
    "Cranberry Extract": "Cute cartoon cranberries, thick black outlines, flat 2D vector style, simple geometric shapes, red color, minimal details, white background",
    "Omega-3": "Cute cartoon supplement capsule with omega-3 label, thick black outlines, flat 2D vector style, simple geometric shapes, orange-gold color, minimal details, white background",
    "SAM-e": "Cute cartoon supplement pill bottle, thick black outlines, flat 2D vector style, simple geometric shapes, blue-white color, minimal details, white background",
    "Psyllium Husk": "Cute cartoon psyllium husks, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",
    "Vitamin C": "Cute cartoon orange slice with vitamin label, thick black outlines, flat 2D vector style, simple geometric shapes, orange color, minimal details, white background",
    "Bone Broth": "Cute cartoon steaming bowl, thick black outlines, flat 2D vector style, simple geometric shapes, brown-beige color, minimal details, white background",
    "Fructooligosaccharides": "Cute cartoon prebiotic fiber icon, thick black outlines, flat 2D vector style, simple geometric shapes, green-white color, minimal details, white background",
    "Curcumin": "Cute cartoon turmeric powder pile, thick black outlines, flat 2D vector style, simple geometric shapes, bright orange color, minimal details, white background",
    "Joint Health Supplement": "Cute cartoon joint/bone icon, thick black outlines, flat 2D vector style, simple geometric shapes, blue-white color, minimal details, white background",
    "Brewer's Yeast": "Cute cartoon yeast powder jar, thick black outlines, flat 2D vector style, simple geometric shapes, tan-brown color, minimal details, white background",

    # OTHER
    "Honey": "Cute cartoon honey jar with dipper, thick black outlines, flat 2D vector style, simple geometric shapes, golden-yellow color, minimal details, white background",
    "Peanut Butter": "Cute cartoon peanut butter jar with peanuts, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan color, minimal details, white background",
    "Spirulina Powder": "Cute cartoon spirulina powder bowl, thick black outlines, flat 2D vector style, simple geometric shapes, dark green-blue color, minimal details, white background",
    "Probiotic Powder": "Cute cartoon probiotic supplement jar, thick black outlines, flat 2D vector style, simple geometric shapes, white-blue color, minimal details, white background",
    "Vitamin D3": "Cute cartoon sun with vitamin pill, thick black outlines, flat 2D vector style, simple geometric shapes, yellow-orange color, minimal details, white background",
    "Herring Oil": "Cute cartoon oil bottle with herring fish icon, thick black outlines, flat 2D vector style, simple geometric shapes, golden-silver color, minimal details, white background"
}

def download_image(prompt, name, output_dir):
    """Download a single image with retry logic"""
    # Create filename from ingredient name (e.g. "Bok Choi" -> "bok-choi.png")
    filename = f"{name.lower().replace(' ', '-')}.png"
    
    # Add seed for variation (deterministic based on name)
    seed = sum(ord(c) for c in name)
    url = POLLINATION_URL + prompt.replace(' ', '%20') + f"?seed={seed}&width=512&height=512"
    
    max_retries = 5
    for attempt in range(max_retries):
        try:
            response = requests.get(url, timeout=60)
            response.raise_for_status()
            img = Image.open(io.BytesIO(response.content))
            img_path = os.path.join(output_dir, filename)
            img.save(img_path)
            return f"Downloaded {filename}"
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1:
                wait_time = 5 ** attempt
                print(f"Timeout for {name}, retrying in {wait_time}s...")
                time.sleep(wait_time)
            else:
                return f"Failed to download {name}: Timeout"
        except requests.exceptions.RequestException as e:
            if "429" in str(e):
                if attempt < max_retries - 1:
                    wait_time = 10 ** attempt
                    print(f"Rate limit for {name}, retrying in {wait_time}s...")
                    time.sleep(wait_time)
                else:
                    return f"Failed to download {name}: Rate limit"
            else:
                return f"Failed to download {name}: {e}"
    return None

def generate_ingredient_images():
    """Generate images for all ingredients"""
    output_dir = os.path.join("public", "images", "ingredients")
    os.makedirs(output_dir, exist_ok=True)
    
    total_images = len(INGREDIENT_PROMPTS)
    current_image = 0
    
    print(f"=== Generating {total_images} ingredient images ===")
    
    for name, prompt in INGREDIENT_PROMPTS.items():
        # Check if image already exists
        filename = f"{name.lower().replace(' ', '-')}.png"
        img_path = os.path.join(output_dir, filename)
        
        if os.path.exists(img_path):
            print(f"[SKIP] {filename} already exists, skipping...")
            current_image += 1
            continue
        
        current_image += 1
        print(f"[{current_image}/{total_images}] Generating {name}...")
        
        result = download_image(prompt, name, output_dir)
        if result:
            print(result)
        
        # Sleep to avoid rate limits
        time.sleep(2)

    print(f"\n‚úÖ Process complete! Images saved to {output_dir}")

if __name__ == "__main__":
    generate_ingredient_images()
</file>

<file path="scripts/generation/generate_mascot_emojis.py">
import requests
import os
import time
from PIL import Image
import io
import threading
import concurrent.futures
from concurrent.futures import ThreadPoolExecutor
import sys

# Pollination API URL
POLLINATION_URL = "https://image.pollinations.ai/prompt/"

# Mascot emoji prompts - 12 per mascot (6 reactions + 6 actions)
# Based on the group shot reference image with specific visual details
# Style reference: Use the group shot of all 5 mascots as visual reference for consistent design
REFERENCE_NOTE = "matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots,"

MASCOT_EMOJI_PROMPTS = {
    'barker': [
        # Reactions (6)
        "Minimalist geometric illustration of Chef Barker bright yellow dog mascot giving thumbs up, tall white chef hat, brown wooden spoon in right paw, silver mixing bowl in left paw, simple black dot eyes, happy expression, rounded friendly shape, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px, front view",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot celebrating with paws up and confetti, tall white chef hat, brown wooden spoon, silver mixing bowl nearby, simple black dot eyes, excited expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px, party vibes",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot with heart-shaped eyes, tall white chef hat, brown wooden spoon, silver mixing bowl, loving expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot looking worried with sweat drop, tall white chef hat, brown wooden spoon, silver mixing bowl, simple black dot eyes, concerned expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot with paw on chin thinking, tall white chef hat, brown wooden spoon nearby, silver mixing bowl, simple black dot eyes, thoughtful expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot licking lips, tall white chef hat, brown wooden spoon, silver mixing bowl, simple black dot eyes, delicious expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        # Actions (6)
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot stirring a pot with steam, tall white chef hat, brown wooden spoon in right paw, silver mixing bowl in left paw, simple black dot eyes, focused expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot holding clipboard with recipe, tall white chef hat, brown wooden spoon nearby, silver mixing bowl, simple black dot eyes, professional expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot holding approved stamp, tall white chef hat, brown wooden spoon, silver mixing bowl, simple black dot eyes, satisfied expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot flexing arm muscle, tall white chef hat, brown wooden spoon, silver mixing bowl, simple black dot eyes, confident expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot presenting food bowl with both paws, tall white chef hat, brown wooden spoon nearby, silver mixing bowl, simple black dot eyes, proud expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Chef Barker bright yellow dog mascot sleeping with chef hat tilted, brown wooden spoon nearby, silver mixing bowl, ZZZ symbols, simple black dot eyes, peaceful expression, rounded friendly shape, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px"
    ],
    'whiskers': [
        # Reactions (6)
        f"Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard with white paper in left paw, simple white dot eyes behind glasses, small white x mouth, holding checkmark, satisfied expression, studious anxious appearance, {REFERENCE_NOTE} thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard with white paper showing data in left paw, simple white dot eyes behind glasses, small white x mouth, analyzing data, focused expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, lightbulb above head, simple white dot eyes behind glasses, small white x mouth, eureka expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, holding warning sign, simple white dot eyes behind glasses, small white x mouth, concerned expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, showing X mark, simple white dot eyes behind glasses, small white x mouth, disapproving expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, holding magnifying glass, simple white dot eyes behind glasses, small white x mouth, detective expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        # Actions (6)
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard with white paper in left paw writing notes, simple white dot eyes behind glasses, small white x mouth, studious expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard nearby, holding test tube, simple white dot eyes behind glasses, small white x mouth, scientist expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, pointing paw up, simple white dot eyes behind glasses, small white x mouth, teaching expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard nearby, holding trophy, simple white dot eyes behind glasses, small white x mouth, proud expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, looking at chart, simple white dot eyes behind glasses, small white x mouth, analytical expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        "Minimalist geometric illustration of Professor Whiskers dark teal cat mascot with round white-rimmed glasses, white lab coat with three black buttons, brown clipboard in left paw, doing slow blink, simple white dot eyes behind glasses, small white x mouth, content expression, studious anxious appearance, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px"
    ],
    'scales': [
        # Reactions (6)
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass in right flipper, simple black dot eyes, neutral thoughtful expression, relaxing pose, peaceful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, eating leafy greens, simple black dot eyes, neutral thoughtful expression, satisfied expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass in right flipper, giving thumbs up, simple black dot eyes, neutral thoughtful expression, approving expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass in right flipper, looking sideways skeptically, simple black dot eyes, neutral thoughtful expression, doubtful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, closed eyes smiling, neutral thoughtful expression, blissful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass in right flipper, looking surprised, simple black dot eyes, neutral thoughtful expression, startled expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        # Actions (6)
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, basking on rock with sun rays, simple black dot eyes, neutral thoughtful expression, relaxed expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass in right flipper investigating, simple black dot eyes, neutral thoughtful expression, focused expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, glowing with sparkles around, simple black dot eyes, neutral thoughtful expression, energized expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, holding sign that says 2:1, simple black dot eyes, neutral thoughtful expression, expert expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, adjusting backpack straps, simple black dot eyes, neutral thoughtful expression, prepared expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Scales olive green turtle mascot with lighter green face and limbs, orange-brown deerstalker detective hat, monocle over right eye, magnifying glass nearby, tucked in shell sleeping, simple black dot eyes, neutral thoughtful expression, peaceful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px"
    ],
    'pip': [
        # Reactions (6)
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, stuffed cheeks full of food, happy industrious look, delighted expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, heart-shaped eyes, happy industrious look, loving expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, ears flattened back, happy industrious look, anxious expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, star-shaped eyes, happy industrious look, amazed expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, giving tiny thumbs up, happy industrious look, happy expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, wearing party hat with confetti, happy industrious look, excited expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        # Actions (6)
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe nearby, small brown basket nearby, simple black dot eyes, small upward-curving line mouth, running in exercise wheel, happy industrious look, energetic expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe in right paw, small brown basket in left paw, simple black dot eyes, small upward-curving line mouth, stuffing seeds in cheek pouches, happy industrious look, busy expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe nearby, small brown basket nearby, simple black dot eyes, small upward-curving line mouth, peeking out from small house, happy industrious look, curious expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe nearby, small brown basket nearby, simple black dot eyes, small upward-curving line mouth, holding wrench, happy industrious look, handy expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe nearby, small brown basket nearby, simple black dot eyes, small upward-curving line mouth, holding food with both paws eating, happy industrious look, focused expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Pip warm brown hamster mascot in blue overalls with two white buttons on chest, brown garden hoe nearby, small brown basket nearby, simple black dot eyes, small upward-curving line mouth, curled up in ball sleeping, happy industrious look, peaceful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px"
    ],
    'sunny': [
        # Reactions (6)
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, singing with musical notes, joyful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with ruffled feathers, shocked expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with heart above head, loving expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with wings fully spread, excited expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with droopy wings, tired expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, using wing as thumbs up, approving expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        # Actions (6)
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, flying through air, dynamic expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, pecking at seeds, focused expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, hanging upside down from perch, playful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with open beak and speech bubble, chatty expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, holding flower in beak, sweet expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px",
        f"Minimalist geometric illustration of Sunny orange-red bird mascot with lighter orange belly, dark blue cap, green goggles, simple black dot eyes, neutral expression, with head tucked under wing sleeping, peaceful expression, matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots, thick dark outlines, flat colors, simple shapes, icon style, white background, 512x512px"
    ]
}

# Action names for file naming (matches order of prompts)
ACTION_NAMES = {
    'barker': [
        'thumbs-up', 'celebrating', 'heart-eyes', 'worried', 'thinking', 'licking-lips',
        'cooking-stirring', 'holding-recipe', 'quality-stamp', 'strong-healthy', 'presenting-dish', 'sleeping'
    ],
    'whiskers': [
        'approved-checkmark', 'analyzing-smart', 'lightbulb-idea', 'warning-concerned', 'rejected-xmark', 'investigating',
        'taking-notes', 'science-experiment', 'teaching-pointing', 'award-winner', 'data-review', 'satisfied-slow-blink'
    ],
    'scales': [
        'chill-relaxed', 'happy-eating', 'thumbs-up', 'skeptical-side-eye', 'content-eyes-closed', 'surprised',
        'sunbathing-rock', 'detective-investigating', 'calcium-boost-glowing', 'holding-cap-sign', 'with-backpack', 'sleeping-shell'
    ],
    'pip': [
        'happy-big-cheeks', 'heart-eyes', 'worried-ears-back', 'star-eyes-amazed', 'thumbs-up', 'party-hat-celebrating',
        'running-wheel', 'storing-food', 'peeking-hideout', 'holding-tool-wrench', 'eating-both-hands', 'curled-sleeping'
    ],
    'sunny': [
        'singing-happy', 'shocked-ruffled', 'heart-loving', 'excited-wings-spread', 'bored-tired', 'thumbs-up-wing',
        'flying', 'eating-seeds', 'hanging-upside-down', 'talking-chatting', 'with-flower', 'sleeping-head-tucked'
    ]
}

def download_image(prompt, mascot_name, action_name, output_dir, headers, output_callback=None):
    """Download a single image with retry logic"""
    # Add seed for variation based on action index
    seed = hash(action_name) % 10000  # Use hash of action name for consistent seed
    url = POLLINATION_URL + prompt.replace(' ', '%20') + f"?seed={seed}&width=512&height=512"
    
    max_retries = 5
    for attempt in range(max_retries):
        try:
            response = requests.get(url, headers=headers, timeout=60)
            response.raise_for_status()
            img = Image.open(io.BytesIO(response.content))
            filename = f"{mascot_name}_{action_name}_512.png"
            img_path = os.path.join(output_dir, filename)
            img.save(img_path)
            return f"Downloaded {filename}"
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1:
                wait_time = 5 ** attempt
                message = f"Timeout for {mascot_name} {action_name}, retrying in {wait_time}s..."
                if output_callback:
                    output_callback(message)
                else:
                    print(message)
                time.sleep(wait_time)
            else:
                return f"Failed to download {mascot_name} {action_name}: Timeout"
        except requests.exceptions.RequestException as e:
            if "429" in str(e):
                if attempt < max_retries - 1:
                    wait_time = 10 ** attempt
                    message = f"Rate limit for {mascot_name} {action_name}, retrying in {wait_time}s..."
                    if output_callback:
                        output_callback(message)
                    else:
                        print(message)
                    time.sleep(wait_time)
                else:
                    return f"Failed to download {mascot_name} {action_name}: Rate limit"
            else:
                return f"Failed to download {mascot_name} {action_name}: {e}"
    return None

def generate_mascot_emojis(mascot='all', output_callback=None):
    """Generate 12 emoji images per mascot"""
    output_dir = os.path.join("public", "images", "emojis", "mascots")
    os.makedirs(output_dir, exist_ok=True)
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    
    mascot_list = [mascot] if mascot != 'all' else ['barker', 'whiskers', 'scales', 'pip', 'sunny']
    
    total_images = sum(len(MASCOT_EMOJI_PROMPTS.get(m, [])) for m in mascot_list)
    current_image = 0
    
    for mascot_name in mascot_list:
        prompts = MASCOT_EMOJI_PROMPTS.get(mascot_name, [])
        action_names = ACTION_NAMES.get(mascot_name, [])
        
        if not prompts or len(prompts) != len(action_names):
            message = f"Warning: {mascot_name} has {len(prompts)} prompts but {len(action_names)} action names"
            if output_callback:
                output_callback(message)
            else:
                print(message)
            continue
            
        message = f"\n=== Generating 12 emojis for {mascot_name} ==="
        if output_callback:
            output_callback(message)
        else:
            print(message)
        
        for i, (prompt, action_name) in enumerate(zip(prompts, action_names), 1):
            # Check if image already exists
            filename = f"{mascot_name}_{action_name}_512.png"
            img_path = os.path.join(output_dir, filename)
            if os.path.exists(img_path):
                message = f"[SKIP] {filename} already exists, skipping..."
                if output_callback:
                    output_callback(message)
                else:
                    print(message)
                current_image += 1
                continue
            
            current_image += 1
            message = f"[{current_image}/{total_images}] {mascot_name} emoji {i}/12: {action_name}"
            if output_callback:
                output_callback(message)
            else:
                print(message)
            
            result = download_image(prompt, mascot_name, action_name, output_dir, headers, output_callback)
            if result:
                if output_callback:
                    output_callback(result)
                else:
                    print(result)
            
            # Sleep between images to avoid rate limits
            if i < 12:  # Don't sleep after last image
                time.sleep(3)  # 3 seconds between images
        
        # Longer sleep between mascots
        if mascot_name != mascot_list[-1]:
            message = f"Completed {mascot_name}. Waiting 10 seconds before next mascot..."
            if output_callback:
                output_callback(message)
            else:
                print(message)
            time.sleep(10)
    
    message = f"\n‚úÖ All {total_images} emoji images generated and saved to {output_dir}!"
    if output_callback:
        output_callback(message)
    else:
        print(message)

def start_generation(text_area, mascot='all'):
    def output_callback(message):
        text_area.insert(tk.END, message + '\n')
        text_area.see(tk.END)
    
    threading.Thread(target=generate_mascot_emojis, args=(mascot, output_callback)).start()

def create_gui():
    root = tk.Tk()
    root.title("Mascot Emoji Generator")
    root.geometry("800x600")
    
    text_area = scrolledtext.ScrolledText(root, width=90, height=30)
    text_area.pack(pady=10, padx=10, fill=tk.BOTH, expand=True)
    
    button_frame = tk.Frame(root)
    button_frame.pack(pady=10)
    
    tk.Button(button_frame, text="Generate All Mascots", 
              command=lambda: start_generation(text_area, 'all')).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="Generate Barker Only", 
              command=lambda: start_generation(text_area, 'barker')).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="Generate Whiskers Only", 
              command=lambda: start_generation(text_area, 'whiskers')).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="Generate Scales Only", 
              command=lambda: start_generation(text_area, 'scales')).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="Generate Pip Only", 
              command=lambda: start_generation(text_area, 'pip')).pack(side=tk.LEFT, padx=5)
    tk.Button(button_frame, text="Generate Sunny Only", 
              command=lambda: start_generation(text_area, 'sunny')).pack(side=tk.LEFT, padx=5)
    
    root.mainloop()

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == "--gui":
        from tkinter import scrolledtext
        import tkinter as tk
        create_gui()
    elif len(sys.argv) > 1:
        mascot = sys.argv[1]
        generate_mascot_emojis(mascot)
    else:
        # Generate all mascots by default
        generate_mascot_emojis('all')
</file>

<file path="scripts/generation/generate_meal_images.py">
import os
import time
import io
import requests
from PIL import Image

POLLINATION_URL = "https://image.pollinations.ai/prompt/"

# 25 prompts per species (provided by user)
SPECIES_PROMPTS = {
    "dogs": [
        "Cute cartoon bowl with chicken pieces, white rice, and green peas, thick black outlines, flat 2D vector style, simple geometric shapes, orange chicken, white rice, green peas, minimal details, white background",
        "Cute cartoon bowl with beef chunks, orange sweet potato cubes, and green beans, thick black outlines, flat 2D vector style, simple shapes, red-brown beef, orange sweet potato, green beans, minimal details, white background",
        "Cute cartoon bowl with pink salmon, beige quinoa, and dark green spinach, thick black outlines, flat 2D vector style, simple geometric shapes, pink salmon, tan quinoa, green spinach, minimal details, white background",
        "Cute cartoon bowl with turkey pieces, brown rice, and orange carrot rounds, thick black outlines, flat 2D vector style, simple shapes, tan turkey, brown rice, orange carrots, minimal details, white background",
        "Cute cartoon bowl with lamb chunks, barley grains, and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple geometric shapes, brown lamb, tan barley, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with white fish pieces, oat groats, and green zucchini slices, thick black outlines, flat 2D vector style, simple shapes, white fish, beige oats, green zucchini, minimal details, white background",
        "Cute cartoon bowl with duck meat, buckwheat groats, and green broccoli florets, thick black outlines, flat 2D vector style, simple geometric shapes, brown duck, tan buckwheat, green broccoli, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, couscous, and red pepper strips, thick black outlines, flat 2D vector style, simple shapes, pink tuna, yellow couscous, red peppers, minimal details, white background",
        "Cute cartoon bowl with cod pieces, millet grains, and green asparagus spears, thick black outlines, flat 2D vector style, simple geometric shapes, white cod, yellow millet, green asparagus, minimal details, white background",
        "Cute cartoon bowl with small sardines, round chickpeas, and white fennel slices, thick black outlines, flat 2D vector style, simple shapes, silver sardines, tan chickpeas, white fennel, minimal details, white background",
        "Cute cartoon bowl with mackerel pieces, orange lentils, and dark green kale, thick black outlines, flat 2D vector style, simple geometric shapes, blue-silver mackerel, orange lentils, green kale, minimal details, white background",
        "Cute cartoon bowl with trout pieces, farro grains, and round green peas, thick black outlines, flat 2D vector style, simple shapes, pink trout, tan farro, green peas, minimal details, white background",
        "Cute cartoon bowl with chicken pieces, bulgur wheat, and cucumber slices, thick black outlines, flat 2D vector style, simple geometric shapes, orange chicken, tan bulgur, green cucumber, minimal details, white background",
        "Cute cartoon bowl with turkey pieces, yellow corn kernels, and baby spinach leaves, thick black outlines, flat 2D vector style, simple shapes, tan turkey, yellow corn, green spinach, minimal details, white background",
        "Cute cartoon bowl with beef chunks, red lentils, and orange butternut squash cubes, thick black outlines, flat 2D vector style, simple geometric shapes, red beef, orange lentils, orange squash, minimal details, white background",
        "Cute cartoon bowl with salmon pieces, couscous, and green edamame beans, thick black outlines, flat 2D vector style, simple shapes, pink salmon, yellow couscous, green edamame, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, white rice, and green bok choy, thick black outlines, flat 2D vector style, simple geometric shapes, pink tuna, white rice, green bok choy, minimal details, white background",
        "Cute cartoon bowl with white fish pieces, potato cubes, and green parsley garnish, thick black outlines, flat 2D vector style, simple shapes, white fish, tan potatoes, green parsley, minimal details, white background",
        "Cute cartoon bowl with turkey pieces, quinoa, and yellow squash rounds, thick black outlines, flat 2D vector style, simple geometric shapes, tan turkey, beige quinoa, yellow squash, minimal details, white background",
        "Cute cartoon bowl with lamb pieces, couscous, and roasted red pepper strips, thick black outlines, flat 2D vector style, simple shapes, brown lamb, yellow couscous, red peppers, minimal details, white background",
        "Cute cartoon bowl with beef chunks, brown rice, and white cauliflower florets, thick black outlines, flat 2D vector style, simple geometric shapes, red beef, brown rice, white cauliflower, minimal details, white background",
        "Cute cartoon bowl with chicken pieces, barley grains, and green beans, thick black outlines, flat 2D vector style, simple shapes, orange chicken, tan barley, green beans, minimal details, white background",
        "Cute cartoon bowl with salmon pieces, bulgur, dill sprigs, and yellow lemon slices, thick black outlines, flat 2D vector style, simple geometric shapes, pink salmon, tan bulgur, green dill, yellow lemon, minimal details, white background",
        "Cute cartoon bowl with cod pieces, orange sweet potato cubes, and green snap peas, thick black outlines, flat 2D vector style, simple shapes, white cod, orange sweet potato, green peas, minimal details, white background",
        "Cute cartoon bowl with duck meat, dark wild rice, and brown mushroom slices, thick black outlines, flat 2D vector style, simple geometric shapes, brown duck, dark rice, brown mushrooms, minimal details, white background",
    ],
    "cats": [
        "Cute cartoon bowl with salmon pieces, white rice, and spinach leaves, thick black outlines, flat 2D vector style, simple geometric shapes, pink salmon, white rice, dark green spinach, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, orange sweet potato cubes, and green peas, thick black outlines, flat 2D vector style, simple shapes, pink tuna, orange sweet potato, green peas, minimal details, white background",
        "Cute cartoon bowl with white fish pieces, quinoa, and green zucchini slices, thick black outlines, flat 2D vector style, simple geometric shapes, white fish, beige quinoa, green zucchini, minimal details, white background",
        "Cute cartoon bowl with small sardines, couscous, and parsley garnish, thick black outlines, flat 2D vector style, simple shapes, silver sardines, yellow couscous, green parsley, minimal details, white background",
        "Cute cartoon bowl with chicken pieces, white rice, and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple geometric shapes, orange chicken, white rice, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with mackerel pieces, barley grains, and green beans, thick black outlines, flat 2D vector style, simple shapes, blue-silver mackerel, tan barley, green beans, minimal details, white background",
        "Cute cartoon bowl with trout pieces, millet grains, and green asparagus spears, thick black outlines, flat 2D vector style, simple geometric shapes, pink trout, yellow millet, green asparagus, minimal details, white background",
        "Cute cartoon bowl with cod pieces, oat groats, and green broccoli florets, thick black outlines, flat 2D vector style, simple shapes, white cod, beige oats, green broccoli, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, couscous, and orange carrot rounds, thick black outlines, flat 2D vector style, simple geometric shapes, pink tuna, yellow couscous, orange carrots, minimal details, white background",
        "Cute cartoon bowl with salmon pieces, farro grains, and dark green kale, thick black outlines, flat 2D vector style, simple shapes, pink salmon, tan farro, green kale, minimal details, white background",
        "Cute cartoon bowl with chicken pieces, buckwheat groats, and baby bok choy, thick black outlines, flat 2D vector style, simple geometric shapes, orange chicken, tan buckwheat, green bok choy, minimal details, white background",
        "Cute cartoon bowl with white fish pieces, orange lentils, and red pepper strips, thick black outlines, flat 2D vector style, simple shapes, white fish, orange lentils, red peppers, minimal details, white background",
        "Cute cartoon bowl with small sardines, white rice, and green cucumber slices, thick black outlines, flat 2D vector style, simple geometric shapes, silver sardines, white rice, green cucumber, minimal details, white background",
        "Cute cartoon bowl with salmon pieces, potato cubes, and dill sprigs, thick black outlines, flat 2D vector style, simple shapes, pink salmon, tan potatoes, green dill, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, quinoa, and green edamame beans, thick black outlines, flat 2D vector style, simple geometric shapes, pink tuna, beige quinoa, green edamame, minimal details, white background",
        "Cute cartoon bowl with mackerel pieces, brown rice, and spinach leaves, thick black outlines, flat 2D vector style, simple shapes, blue-silver mackerel, brown rice, green spinach, minimal details, white background",
        "Cute cartoon bowl with trout pieces, orange sweet potato cubes, and parsley garnish, thick black outlines, flat 2D vector style, simple geometric shapes, pink trout, orange sweet potato, green parsley, minimal details, white background",
        "Cute cartoon bowl with cod pieces, couscous, and green peas, thick black outlines, flat 2D vector style, simple shapes, white cod, yellow couscous, green peas, minimal details, white background",
        "Cute cartoon bowl with chicken pieces, barley grains, and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple geometric shapes, orange chicken, tan barley, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with white fish pieces, millet grains, and green beans, thick black outlines, flat 2D vector style, simple shapes, white fish, yellow millet, green beans, minimal details, white background",
        "Cute cartoon bowl with salmon pieces, bulgur wheat, and white fennel slices, thick black outlines, flat 2D vector style, simple geometric shapes, pink salmon, tan bulgur, white fennel, minimal details, white background",
        "Cute cartoon bowl with tuna chunks, white rice, and roasted red pepper strips, thick black outlines, flat 2D vector style, simple shapes, pink tuna, white rice, red peppers, minimal details, white background",
        "Cute cartoon bowl with small sardines, round chickpeas, and green zucchini slices, thick black outlines, flat 2D vector style, simple geometric shapes, silver sardines, tan chickpeas, green zucchini, minimal details, white background",
        "Cute cartoon bowl with mackerel pieces, orange lentils, and carrot ribbon strips, thick black outlines, flat 2D vector style, simple shapes, blue-silver mackerel, orange lentils, orange carrots, minimal details, white background",
        "Cute cartoon bowl with trout pieces, brown rice, and green snap peas, thick black outlines, flat 2D vector style, simple geometric shapes, pink trout, brown rice, green peas, minimal details, white background",
    ],
    "birds": [
        "Cute cartoon bowl with mixed seeds and chopped spinach, thick black outlines, flat 2D vector style, simple geometric shapes, brown-tan seeds, dark green spinach, minimal details, white background",
        "Cute cartoon bowl with round pellets and red apple slices, thick black outlines, flat 2D vector style, simple shapes, brown pellets, red apples, minimal details, white background",
        "Cute cartoon bowl with quinoa grains, green peas, and orange carrot pieces, thick black outlines, flat 2D vector style, simple geometric shapes, beige quinoa, green peas, orange carrots, minimal details, white background",
        "Cute cartoon bowl with yellow millet seeds and blue blueberries, thick black outlines, flat 2D vector style, simple shapes, yellow millet, blue berries, minimal details, white background",
        "Cute cartoon bowl with sprouted seeds and green cucumber slices, thick black outlines, flat 2D vector style, simple geometric shapes, tan-green sprouts, green cucumber, minimal details, white background",
        "Cute cartoon bowl with sunflower seeds and yellow corn kernels, thick black outlines, flat 2D vector style, simple shapes, black-white seeds, yellow corn, minimal details, white background",
        "Cute cartoon bowl with oat groats and green bean pieces, thick black outlines, flat 2D vector style, simple geometric shapes, beige oats, green beans, minimal details, white background",
        "Cute cartoon bowl with buckwheat groats and red pepper pieces, thick black outlines, flat 2D vector style, simple shapes, brown buckwheat, red peppers, minimal details, white background",
        "Cute cartoon bowl with brown rice and green edamame beans, thick black outlines, flat 2D vector style, simple geometric shapes, brown rice, green edamame, minimal details, white background",
        "Cute cartoon bowl with amaranth seeds and green zucchini cubes, thick black outlines, flat 2D vector style, simple shapes, tan-red amaranth, green zucchini, minimal details, white background",
        "Cute cartoon bowl with barley grains, parsley, and green peas, thick black outlines, flat 2D vector style, simple geometric shapes, tan barley, green parsley, green peas, minimal details, white background",
        "Cute cartoon bowl with mixed grain seeds and orange carrot cubes, thick black outlines, flat 2D vector style, simple shapes, tan-brown grains, orange carrots, minimal details, white background",
        "Cute cartoon bowl with round pellets and orange mango slices, thick black outlines, flat 2D vector style, simple geometric shapes, brown pellets, orange mango, minimal details, white background",
        "Cute cartoon bowl with quinoa grains and green broccoli florets, thick black outlines, flat 2D vector style, simple shapes, beige quinoa, green broccoli, minimal details, white background",
        "Cute cartoon bowl with yellow millet seeds and red apple cubes, thick black outlines, flat 2D vector style, simple geometric shapes, yellow millet, red apples, minimal details, white background",
        "Cute cartoon bowl with sprouted seeds and dark leafy greens, thick black outlines, flat 2D vector style, simple shapes, tan-green sprouts, dark green leaves, minimal details, white background",
        "Cute cartoon bowl with oat flakes and colorful bell pepper bits, thick black outlines, flat 2D vector style, simple geometric shapes, beige oats, red-yellow-green peppers, minimal details, white background",
        "Cute cartoon bowl with mixed seeds and orange papaya cubes, thick black outlines, flat 2D vector style, simple shapes, brown seeds, orange papaya, minimal details, white background",
        "Cute cartoon bowl with buckwheat groats, cucumber slices, and herb sprigs, thick black outlines, flat 2D vector style, simple geometric shapes, brown buckwheat, green cucumber, green herbs, minimal details, white background",
        "Cute cartoon bowl with white rice and shredded kale, thick black outlines, flat 2D vector style, simple shapes, white rice, dark green kale, minimal details, white background",
        "Cute cartoon bowl with round pellets and green pear slices, thick black outlines, flat 2D vector style, simple geometric shapes, brown pellets, green-yellow pear, minimal details, white background",
        "Cute cartoon bowl with quinoa grains and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple shapes, beige quinoa, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with yellow millet seeds and spinach ribbon strips, thick black outlines, flat 2D vector style, simple geometric shapes, yellow millet, green spinach, minimal details, white background",
        "Cute cartoon bowl with mixed grain seeds and colorful berries, thick black outlines, flat 2D vector style, simple shapes, tan grains, red-blue berries, minimal details, white background",
        "Cute cartoon bowl with sprouted seeds and green celery strips, thick black outlines, flat 2D vector style, simple geometric shapes, tan-green sprouts, light green celery, minimal details, white background",
    ],
    "reptiles": [
        "Cute cartoon bowl with dark collard greens and colorful bell pepper strips, thick black outlines, flat 2D vector style, simple geometric shapes, dark green collards, red-yellow peppers, minimal details, white background",
        "Cute cartoon bowl with mustard greens and yellow squash cubes, thick black outlines, flat 2D vector style, simple shapes, green mustard greens, yellow squash, minimal details, white background",
        "Cute cartoon bowl with turnip greens and orange carrot ribbon strips, thick black outlines, flat 2D vector style, simple geometric shapes, green turnip greens, orange carrots, minimal details, white background",
        "Cute cartoon bowl with dandelion greens and green zucchini slices, thick black outlines, flat 2D vector style, simple shapes, bright green dandelion, green zucchini, minimal details, white background",
        "Cute cartoon bowl with dark kale and orange butternut squash cubes, thick black outlines, flat 2D vector style, simple geometric shapes, dark green kale, orange squash, minimal details, white background",
        "Cute cartoon bowl with romaine lettuce and green cucumber rounds, thick black outlines, flat 2D vector style, simple shapes, light green romaine, green cucumber, minimal details, white background",
        "Cute cartoon bowl with pale endive and orange sweet potato cubes, thick black outlines, flat 2D vector style, simple geometric shapes, pale green endive, orange sweet potato, minimal details, white background",
        "Cute cartoon bowl with bok choy and yellow squash pieces, thick black outlines, flat 2D vector style, simple shapes, white-green bok choy, yellow squash, minimal details, white background",
        "Cute cartoon bowl with dark watercress and colorful bell pepper pieces, thick black outlines, flat 2D vector style, simple geometric shapes, dark green watercress, red-yellow peppers, minimal details, white background",
        "Cute cartoon bowl with swiss chard and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple shapes, green-red chard, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with escarole and green bean pieces, thick black outlines, flat 2D vector style, simple geometric shapes, pale green escarole, green beans, minimal details, white background",
        "Cute cartoon bowl with collard greens and pink hibiscus flower petals, thick black outlines, flat 2D vector style, simple shapes, dark green collards, pink petals, minimal details, white background",
        "Cute cartoon bowl with mustard greens and blue blueberries, thick black outlines, flat 2D vector style, simple geometric shapes, green mustard greens, blue berries, minimal details, white background",
        "Cute cartoon bowl with arugula and orange carrot shavings, thick black outlines, flat 2D vector style, simple shapes, dark green arugula, orange carrots, minimal details, white background",
        "Cute cartoon bowl with dark kale and orange mango cubes, thick black outlines, flat 2D vector style, simple geometric shapes, dark green kale, orange mango, minimal details, white background",
        "Cute cartoon bowl with turnip greens and pink cactus pear cubes, thick black outlines, flat 2D vector style, simple shapes, green turnip greens, pink cactus pear, minimal details, white background",
        "Cute cartoon bowl with dandelion greens and red apple slices, thick black outlines, flat 2D vector style, simple geometric shapes, bright green dandelion, red apples, minimal details, white background",
        "Cute cartoon bowl with romaine lettuce and green snap pea pods, thick black outlines, flat 2D vector style, simple shapes, light green romaine, green peas, minimal details, white background",
        "Cute cartoon bowl with pale endive and mixed squash cubes in yellow and green, thick black outlines, flat 2D vector style, simple geometric shapes, pale endive, yellow-green squash, minimal details, white background",
        "Cute cartoon bowl with watercress, herb sprigs, and cucumber slices, thick black outlines, flat 2D vector style, simple shapes, dark green watercress, green herbs, green cucumber, minimal details, white background",
        "Cute cartoon bowl with bok choy and orange papaya cubes, thick black outlines, flat 2D vector style, simple geometric shapes, white-green bok choy, orange papaya, minimal details, white background",
        "Cute cartoon bowl with collard greens, orange pumpkin cubes, and green peas, thick black outlines, flat 2D vector style, simple shapes, dark green collards, orange pumpkin, green peas, minimal details, white background",
        "Cute cartoon bowl with mustard greens and spiralized zucchini, thick black outlines, flat 2D vector style, simple geometric shapes, green mustard greens, green zucchini spirals, minimal details, white background",
        "Cute cartoon bowl with dark arugula and colorful bell pepper bits, thick black outlines, flat 2D vector style, simple shapes, dark green arugula, red-yellow-green peppers, minimal details, white background",
        "Cute cartoon bowl with dark kale and colorful bell pepper rings, thick black outlines, flat 2D vector style, simple geometric shapes, dark green kale, red-yellow pepper rings, minimal details, white background",
    ],
    "pocket-pets": [
        "Cute cartoon bowl with golden hay and orange carrot shavings, thick black outlines, flat 2D vector style, simple geometric shapes, golden-brown hay, orange carrots, minimal details, white background",
        "Cute cartoon bowl with brown pellets and red apple slices, thick black outlines, flat 2D vector style, simple shapes, brown pellets, red apples, minimal details, white background",
        "Cute cartoon bowl with golden hay and green cucumber rounds, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green cucumber, minimal details, white background",
        "Cute cartoon bowl with brown pellets and colorful bell pepper pieces, thick black outlines, flat 2D vector style, simple shapes, brown pellets, red-yellow-green peppers, minimal details, white background",
        "Cute cartoon bowl with golden hay, parsley, and cilantro sprigs, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green herbs, minimal details, white background",
        "Cute cartoon bowl with brown pellets and blue blueberries, thick black outlines, flat 2D vector style, simple shapes, brown pellets, blue berries, minimal details, white background",
        "Cute cartoon bowl with golden hay and green broccoli florets, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green broccoli, minimal details, white background",
        "Cute cartoon bowl with brown pellets and green zucchini cubes, thick black outlines, flat 2D vector style, simple shapes, brown pellets, green zucchini, minimal details, white background",
        "Cute cartoon bowl with golden hay and green pea pods, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green peas, minimal details, white background",
        "Cute cartoon bowl with brown pellets and red strawberry slices, thick black outlines, flat 2D vector style, simple shapes, brown pellets, red strawberries, minimal details, white background",
        "Cute cartoon bowl with golden hay and bright green dandelion leaves, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green dandelion, minimal details, white background",
        "Cute cartoon bowl with brown pellets and orange pumpkin cubes, thick black outlines, flat 2D vector style, simple shapes, brown pellets, orange pumpkin, minimal details, white background",
        "Cute cartoon bowl with golden hay, purple radicchio, and pale endive, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, purple radicchio, pale endive, minimal details, white background",
        "Cute cartoon bowl with brown pellets and orange mango slices, thick black outlines, flat 2D vector style, simple shapes, brown pellets, orange mango, minimal details, white background",
        "Cute cartoon bowl with golden hay and green snap pea pods, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green peas, minimal details, white background",
        "Cute cartoon bowl with brown pellets and orange carrot rounds, thick black outlines, flat 2D vector style, simple shapes, brown pellets, orange carrots, minimal details, white background",
        "Cute cartoon bowl with golden hay, white fennel, and green herb sprigs, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, white fennel, green herbs, minimal details, white background",
        "Cute cartoon bowl with brown pellets and green pear slices, thick black outlines, flat 2D vector style, simple shapes, brown pellets, green-yellow pear, minimal details, white background",
        "Cute cartoon bowl with golden hay and green spinach ribbon strips, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green spinach, minimal details, white background",
        "Cute cartoon bowl with brown pellets and orange sweet potato cubes, thick black outlines, flat 2D vector style, simple shapes, brown pellets, orange sweet potato, minimal details, white background",
        "Cute cartoon bowl with golden hay and green bean pieces, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, green beans, minimal details, white background",
        "Cute cartoon bowl with brown pellets and red cranberry pieces, thick black outlines, flat 2D vector style, simple shapes, brown pellets, red cranberries, minimal details, white background",
        "Cute cartoon bowl with golden hay, dark kale, and parsley, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, dark green kale, green parsley, minimal details, white background",
        "Cute cartoon bowl with brown pellets and orange melon cubes, thick black outlines, flat 2D vector style, simple shapes, brown pellets, orange melon, minimal details, white background",
        "Cute cartoon bowl with golden hay, bok choy, and yellow squash, thick black outlines, flat 2D vector style, simple geometric shapes, golden hay, white-green bok choy, yellow squash, minimal details, white background",
    ],
}


def download_image(prompt: str, species: str, index: int, output_dir: str):
    """Download a single image with retry/backoff and deterministic seed."""
    filename = f"{species}-meal-{index}.png"
    seed = hash((species, index)) % (2**31)
    url = POLLINATION_URL + prompt.replace(" ", "%20") + f"?seed={seed}&width=512&height=512"

    max_retries = 7
    for attempt in range(max_retries):
        try:
            resp = requests.get(url, timeout=60)
            resp.raise_for_status()
            img = Image.open(io.BytesIO(resp.content))
            img_path = os.path.join(output_dir, filename)
            img.save(img_path)
            return f"Downloaded {filename}"
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1:
                wait = 2 ** attempt
                print(f"Timeout on {filename}, retrying in {wait}s...")
                time.sleep(wait)
            else:
                return f"Failed {filename}: Timeout"
        except requests.exceptions.RequestException as e:
            if ("429" in str(e) or "502" in str(e)) and attempt < max_retries - 1:
                wait = 3 ** attempt
                print(f"Rate/server issue on {filename}, retrying in {wait}s...")
                time.sleep(wait)
                continue
            return f"Failed {filename}: {e}"
    return None


def generate_meal_images():
    """Generate 25 images per species, filenames: {species}-meal-1..25.png."""
    output_dir = os.path.join("public", "images", "meals")
    os.makedirs(output_dir, exist_ok=True)

    total = sum(len(v) for v in SPECIES_PROMPTS.values())
    current = 0

    for species, prompts in SPECIES_PROMPTS.items():
        print(f"\n=== {species}: {len(prompts)} images ===")
        for idx, prompt in enumerate(prompts, start=1):
            filename = f"{species}-meal-{idx}.png"
            out_path = os.path.join(output_dir, filename)

            if os.path.exists(out_path):
                print(f"[SKIP] {filename} exists")
                current += 1
                continue

            current += 1
            print(f"[{current}/{total}] {filename}")
            result = download_image(prompt, species, idx, output_dir)
            if result:
                print(result)

            time.sleep(1.5)  # gentle pacing

    print(f"\n‚úÖ Done. Images saved to {output_dir}")


if __name__ == "__main__":
    generate_meal_images()
</file>

<file path="scripts/generation/generate-recipes.js">
// Script to generate proper recipes using only approved, vetted ingredients
// UPDATED: Now uses VETTED_SPECIES_MAP for strict safety and VETTED_PRODUCTS for monetization
const fs = require('fs');
const path = require('path');

// --- IMPORTS ---
const VETTED_PRODUCTS_PATH = path.join(__dirname, 'lib/data/vetted-products.ts');
const VETTED_PRODUCTS_NEW_PATH = path.join(__dirname, 'lib/data/vetted-products-new.ts');
const VETTED_SPECIES_MAP_PATH = path.join(__dirname, 'lib/data/vetted-species-map.ts');
const CELEBRITY_PETS_PATH = path.join(__dirname, 'lib/data/celebrity-pets-complete.ts');

// --- HELPER TO EXTRACT DATA FROM TS FILES ---
function extractExportedObject(filePath, exportName) {
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    const regex = new RegExp(`export const ${exportName}(?:\\s*:\\s*[^=]+)?\\s*=\\s*({[\\s\\S]*?});`, 'm');
    const match = content.match(regex);
    if (match) {
      return eval('(' + match[1] + ')');
    }
    return null;
  } catch (e) {
    console.warn(`Failed to extract ${exportName} from ${filePath}:`, e.message);
    return null;
  }
}

function extractExportedArray(filePath, exportName) {
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    const regex = new RegExp(`export const ${exportName}(?:\\s*:\\s*[^=]+)?\\s*=\\s*(\\[[\\s\\S]*?\\]);`, 'm');
    const match = content.match(regex);
    if (match) {
      return eval('(' + match[1] + ')');
    }
    return null;
  } catch (e) {
    console.warn(`Failed to extract ${exportName} from ${filePath}:`, e.message);
    return null;
  }
}

// --- LOAD DATA ---
console.log('Loading vetted data...');
const VETTED_PRODUCTS = extractExportedObject(VETTED_PRODUCTS_PATH, 'VETTED_PRODUCTS') || {};
const VETTED_PRODUCTS_RESEARCH = extractExportedObject(VETTED_PRODUCTS_NEW_PATH, 'VETTED_PRODUCTS_RESEARCH') || {};
const VETTED_SPECIES_MAP = extractExportedObject(VETTED_SPECIES_MAP_PATH, 'VETTED_SPECIES_MAP') || {};

const ALL_VETTED_PRODUCTS = { ...VETTED_PRODUCTS, ...VETTED_PRODUCTS_RESEARCH };

const dogCelebrities = extractExportedArray(CELEBRITY_PETS_PATH, 'dogCelebrities') || [];
const catCelebrities = extractExportedArray(CELEBRITY_PETS_PATH, 'catCelebrities') || [];
const birdCelebrities = extractExportedArray(CELEBRITY_PETS_PATH, 'birdCelebrities') || [];
const reptileCelebrities = extractExportedArray(CELEBRITY_PETS_PATH, 'reptileCelebrities') || [];
const pocketPetCelebrities = extractExportedArray(CELEBRITY_PETS_PATH, 'pocketPetCelebrities') || [];

const CELEBS = {
  dogs: dogCelebrities,
  cats: catCelebrities,
  birds: birdCelebrities,
  reptiles: reptileCelebrities,
  'pocket-pets': pocketPetCelebrities
};

// --- CONFIGURATION ---
const SPECIES = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
const RECIPES_PER_SPECIES = 40; 
const TOTAL_RECIPES = SPECIES.length * RECIPES_PER_SPECIES;

const HEALTH_CONCERNS = {
  dogs: ['weight-management', 'joint-health', 'digestive-issues', 'allergies', 'skin-coat', 'heart-disease', 'anxiety', 'dental-health'],
  cats: ['urinary-health', 'kidney-disease', 'weight-management', 'hairball-control', 'digestive-issues', 'joint-health', 'dental-health'],
  birds: ['feather-health', 'immune-support', 'digestive-health', 'stress-relief'],
  reptiles: ['bone-health', 'shedding-support', 'digestive-health', 'hydration'],
  'pocket-pets': ['digestive-health', 'dental-health', 'immune-support', 'skin-coat']
};

const AGE_GROUPS = ['baby', 'young', 'adult', 'senior'];

// --- GENERATOR FUNCTIONS ---

function getSafeIngredientsForSpecies(speciesKey) {
  const singularKey = {
    'dogs': 'dog',
    'cats': 'cat',
    'birds': 'bird',
    'reptiles': 'reptile',
    'pocket-pets': 'pocket-pet'
  }[speciesKey];

  const safeIngredients = [];
  
  for (const [key, product] of Object.entries(ALL_VETTED_PRODUCTS)) {
    const safeFor = VETTED_SPECIES_MAP[key.toLowerCase()];
    if (safeFor && safeFor.includes(singularKey)) {
      safeIngredients.push({
        id: key, 
        ...product
      });
    }
  }
  return safeIngredients;
}

function getRandomItems(array, count) {
  const shuffled = [...array].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

function generateRecipe(species, index) {
  const safePool = getSafeIngredientsForSpecies(species);
  
  if (safePool.length < 3) {
    // Only warn if significantly empty to avoid spam
    if (index === 0) console.warn(`Not enough safe ingredients for ${species}! Found: ${safePool.length}`);
    return null;
  }

  const proteins = safePool.filter(i => i.category === 'Meat' || i.category === 'Insect' || i.category === 'Fish');
  const veggies = safePool.filter(i => i.category === 'Vegetable' || i.category === 'Leafy Green');
  const fruits = safePool.filter(i => i.category === 'Fruit');
  const supplements = safePool.filter(i => i.category === 'Supplement' || i.category === 'Oil');
  const carbs = safePool.filter(i => i.category === 'Carb' || i.category === 'Grain' || i.category === 'Seed' || i.category === 'Hay' || i.category === 'Pellet');

  let ingredients = [];

  if (species === 'dogs' || species === 'cats') {
    const mainProtein = getRandomItems(proteins, 1)[0];
    const secondary = getRandomItems(proteins, 1)[0]; 
    const veg = getRandomItems(veggies, 1)[0];
    const supp = getRandomItems(supplements, 1)[0];
    
    if (mainProtein) ingredients.push({ ...mainProtein, amount: '150g' });
    if (secondary && secondary.id !== mainProtein?.id) ingredients.push({ ...secondary, amount: '50g' });
    if (veg) ingredients.push({ ...veg, amount: '50g' });
    if (supp) ingredients.push({ ...supp, amount: '1 tsp' });
  } 
  else if (species === 'birds' || species === 'pocket-pets') {
    const base = getRandomItems(carbs, 2);
    const fresh = getRandomItems(veggies.concat(fruits), 2);
    const supp = getRandomItems(supplements, 1)[0];

    base.forEach(i => ingredients.push({ ...i, amount: '2 tbsp' }));
    fresh.forEach(i => ingredients.push({ ...i, amount: '1 tbsp' }));
    if (supp) ingredients.push({ ...supp, amount: 'pinch' });
  }
  else if (species === 'reptiles') {
    const bugs = getRandomItems(proteins, 1);
    const greens = getRandomItems(veggies, 2);
    const fruit = getRandomItems(fruits, 1)[0];
    const supp = getRandomItems(supplements, 1)[0];

    bugs.forEach(i => ingredients.push({ ...i, amount: '5-6 insects' }));
    greens.forEach(i => ingredients.push({ ...i, amount: '1 cup' }));
    if (fruit && Math.random() > 0.7) ingredients.push({ ...fruit, amount: '1 slice' });
    if (supp) ingredients.push({ ...supp, amount: 'dusting' });
  }

  if (ingredients.length === 0) {
    ingredients = getRandomItems(safePool, 4).map(i => ({ ...i, amount: 'varies' }));
  }

  const celebs = CELEBS[species] || [];
  const celeb = celebs.length > 0 ? celebs[index % celebs.length] : { name: 'Chef Paws', quote: 'Bon Appetit!' };

  const healthFocus = getRandomItems(HEALTH_CONCERNS[species] || [], 2);
  const ageGroup = Math.random() > 0.3 ? ['adult'] : getRandomItems(AGE_GROUPS, 2);

  const mainIngName = ingredients[0]?.productName?.split(' ').slice(0, 2).join(' ') || 'Mystery';
  const adjectives = ['Delight', 'Feast', 'Bowl', 'Mix', 'Medley', 'Crunch', 'Supper', 'Bites'];
  const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
  const name = `${celeb.name}'s ${mainIngName} ${adj}`;

  return {
    id: `${species}-${index + 1000}`,
    name: name,
    shortName: `${mainIngName} ${adj}`,
    celebrityName: celeb.name,
    celebrityQuote: celeb.quote,
    category: species,
    breed: null,
    ageGroup: ageGroup,
    healthConcerns: healthFocus,
    description: `A veterinarian-reviewed ${species} meal featuring ${mainIngName}.`,
    tags: ['vetted', 'balanced', ...healthFocus],
    imageUrl: `/images/meals/${species}-meal-${(index % 25) + 1}.png`,
    prepTime: '10 min',
    cookTime: '0 min',
    servings: 1,
    ingredients: ingredients.map((ing, i) => ({
      id: `${i+1}`,
      name: ing.id,
      amount: ing.amount,
      amazonLink: ing.asinLink || ing.amazonLink,
      productName: ing.productName,
      vetNote: ing.vetNote,
      isVetted: true
    })),
    instructions: [
      `Prepare ${ingredients[0]?.productName || 'ingredients'} according to package.`,
      `Mix in ${ingredients[1]?.productName || 'secondary ingredients'}.`,
      `Serve immediately.`
    ],
    rating: 4.5 + (Math.random() * 0.5),
    reviews: Math.floor(Math.random() * 50) + 10
  };
}

// --- MAIN EXECUTION ---
console.log('Generating recipes...');
const allRecipes = [];

SPECIES.forEach(species => {
  console.log(`Processing ${species}...`);
  for (let i = 0; i < RECIPES_PER_SPECIES; i++) {
    const recipe = generateRecipe(species, i);
    if (recipe) allRecipes.push(recipe);
  }
});

console.log(`Generated ${allRecipes.length} recipes.`);

const outputPath = path.join(__dirname, 'lib/data/recipes-complete.ts');
const fileContent = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Generated on: ${new Date().toISOString()}
// Total recipes: ${allRecipes.length}

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(allRecipes, null, 2)};
`;

fs.writeFileSync(outputPath, fileContent);
console.log(`‚úÖ Saved to ${outputPath}`);
</file>

<file path="scripts/invert-emoji-colors.py">
"""
Script to fix inverted emoji colors by inverting the images back
"""
from PIL import Image
import os
from pathlib import Path

def invert_image_colors(image_path, output_path=None):
    """Invert the colors of an image"""
    try:
        img = Image.open(image_path)
        
        # Convert to RGB if needed
        if img.mode == 'RGBA':
            # For RGBA, invert RGB but keep alpha
            r, g, b, a = img.split()
            r = Image.eval(r, lambda x: 255 - x)
            g = Image.eval(g, lambda x: 255 - x)
            b = Image.eval(b, lambda x: 255 - x)
            inverted = Image.merge('RGBA', (r, g, b, a))
        elif img.mode == 'RGB':
            # For RGB, invert all channels
            inverted = Image.eval(img, lambda x: 255 - x)
        else:
            # Convert to RGB first
            img = img.convert('RGB')
            inverted = Image.eval(img, lambda x: 255 - x)
        
        # Save to output path or overwrite
        save_path = output_path or image_path
        inverted.save(save_path, 'PNG')
        return True
    except Exception as e:
        print(f"Error inverting {image_path}: {e}")
        return False

def main():
    emojis_dir = Path('public/images/emojis')
    
    if not emojis_dir.exists():
        print(f"‚ùå Emoji directory not found: {emojis_dir}")
        return
    
    # Create backup directory
    backup_dir = emojis_dir / 'backup_original'
    backup_dir.mkdir(exist_ok=True)
    
    print("üîÑ Inverting emoji colors...\n")
    print("‚ö†Ô∏è  Creating backups in backup_original/ directory\n")
    
    # Process all PNG files
    emoji_files = sorted(emojis_dir.glob('*.png'))
    total = len(emoji_files)
    inverted_count = 0
    skipped_count = 0
    
    for i, emoji_file in enumerate(emoji_files, 1):
        # Skip backup files
        if 'backup' in emoji_file.name.lower():
            skipped_count += 1
            continue
        
        # Backup original
        backup_path = backup_dir / emoji_file.name
        if not backup_path.exists():
            import shutil
            shutil.copy2(emoji_file, backup_path)
        
        # Invert colors
        if invert_image_colors(emoji_file):
            inverted_count += 1
            if i % 10 == 0:
                print(f"   Processed {i}/{total}...")
        else:
            skipped_count += 1
    
    print(f"\n‚úÖ Inverted {inverted_count} images")
    print(f"‚è≠Ô∏è  Skipped {skipped_count} images")
    print(f"üíæ Backups saved to: {backup_dir}")
    print("\n‚úÖ Done! Emoji colors have been inverted.")
    print("   If colors look wrong, restore from backup_original/")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/maintenance/add-quantities.js">
// add-quantities.js
// Adds realistic package quantities to product-prices.json

import fs from 'fs';

// Typical package sizes by category
const QUANTITY_RULES = {
  // Meats (freeze-dried or fresh)
  meat: {
    'ground chicken': '1 lb',
    'ground turkey': '1 lb', 
    'ground beef (lean)': '1 lb',
    'ground lamb': '1 lb',
    'salmon (boneless)': '8 oz',
    'chicken breast': '2 lbs',
    'chicken thighs': '2 lbs',
    'turkey breast': '1 lb',
    'beef liver': '8 oz',
    'chicken liver': '8 oz',
    'chicken hearts': '8 oz',
    'turkey giblets': '8 oz',
    'chicken giblets': '8 oz',
    'duck breast': '8 oz',
    'duck liver': '8 oz',
    'venison': '1 lb',
    'rabbit meat': '1 lb',
    'quail': '12 oz',
    'ground pork (lean)': '1 lb',
    'turkey necks': '2 lbs',
    'ground duck': '1 lb',
    'ground lamb (lean)': '1 lb',
    'ground herring': '12 oz',
    'ground mackerel': '12 oz',
    'lamb liver': '8 oz',
    'duck hearts': '8 oz',
    'chicken necks': '2 lbs',
    'turkey thighs': '2 lbs',
  },
  
  // Canned fish
  cannedFish: {
    'sardines (canned in water)': '4.4 oz (can)',
    'sardines (in water)': '4.4 oz (can)',
    'herring (canned)': '7 oz (can)',
    'mackerel (canned)': '15 oz (can)',
  },
  
  // Grains
  grains: {
    'brown rice': '2 lbs',
    'white rice': '5 lbs',
    'quinoa': '2 lbs',
    'quinoa (cooked)': '2 lbs',
    'oatmeal (cooked, small amounts)': '18 oz',
    'oat groats': '16 oz',
    'buckwheat': '2 lbs',
    'buckwheat (tiny amounts)': '2 lbs',
    'buckwheat (hulled)': '2 lbs',
    'sorghum': '2 lbs',
    'barley': '2 lbs',
    'barley (cooked, minimal)': '2 lbs',
    'barley (hulled)': '2 lbs',
    'millet': '2 lbs',
    'millet (tiny amounts)': '2 lbs',
    'farro': '1 lb',
    'bulgur': '2 lbs',
    'amaranth (tiny amounts)': '1.5 lbs',
    'amaranth seeds': '1.5 lbs',
    'teff seeds': '1 lb',
    'wheat (hulled)': '2 lbs',
    'oat bran (small amounts)': '16 oz',
    'corn (cracked)': '5 lbs',
    'rice (hulled)': '2 lbs',
    'wild rice': '1 lb',
    'oats (rolled)': '2.5 lbs',
    'wheat germ': '12 oz',
  },
  
  // Vegetables
  vegetables: {
    'sweet potato': '8 oz',
    'pumpkin puree': '15 oz (can)',
    'butternut squash': '15 oz (can)',
    'lentils': '1 lb',
    'chickpeas': '1 lb',
    'black beans': '1 lb',
    'green peas': '10 oz',
    'carrots': '10 oz (bag)',
    'spinach': '10 oz',
    'broccoli': '12 oz',
    'zucchini': '12 oz',
    'kale': '8 oz',
    'celery': '16 oz',
    'brussels sprouts': '10 oz',
    'asparagus': '12 oz',
    'parsley': '1 oz',
    'cucumber': '14 oz',
    'lettuce (romaine)': '1 head',
    'arugula': '5 oz',
    'endive': '8 oz',
    'escarole': '8 oz',
    'dandelion greens': '8 oz',
    'collard greens': '1 bunch',
    'mustard greens': '1 bunch',
    'turnip greens': '1 bunch',
    'beet greens': '1 bunch',
    'radish greens': '1 bunch',
  },
  
  // Oils
  oils: {
    'coconut oil': '16 oz',
    'olive oil': '16.9 oz',
    'salmon oil': '16 oz',
    'flaxseed oil': '16 oz',
    'fish oil': '16 oz',
    'sunflower oil': '16 oz',
    'avocado oil': '16.9 oz',
    'avocado oil (tiny amounts)': '16.9 oz',
    'walnut oil': '8.5 oz',
    'black currant oil': '8 oz',
    'almond oil': '16 oz',
    'chia seed oil': '8 oz',
    'herring oil': '16 oz',
    'anchovy oil': '8 oz',
    'evening primrose oil': '8 oz',
    'mackerel oil': '8 oz',
    'sardine oil': '8 oz',
    'borage oil': '8 oz',
    'sesame oil': '8.4 oz',
    'wheat germ oil': '8 oz',
    'krill oil': '16 oz',
    'algae oil (dha)': '8 oz',
    'omega-3 oil': '16 oz',
    'pumpkin seed oil': '8.5 oz',
  },
  
  // Seeds
  seeds: {
    'hemp seeds': '1 lb',
    'flaxseeds': '1 lb',
    'sesame seeds': '1 lb',
    'chia seeds': '1 lb',
    'pumpkin seeds': '1 lb',
    'sunflower seeds (small amounts)': '1 lb',
    'safflower seeds': '5 lbs',
    'canary seed': '5 lbs',
    'niger seed': '5 lbs',
    'rapeseed': '5 lbs',
    'nyjer seeds': '5 lbs',
  },
  
  // Supplements
  supplements: {
    'taurine powder': '100g',
    'calcium carbonate': '1 lb',
    'vitamin e': '100 softgels',
    'b-complex': '100 tablets',
    'probiotic powder': '5 oz',
    'psyllium husk': '12 oz',
    'joint supplement': '120 tablets',
    'omega-3 capsules': '180 softgels',
    'digestive enzymes': '90 capsules',
    'hairball paste': '3 oz',
    'vitamin e oil': '4 oz',
    'kelp powder': '8 oz',
    'joint health powder': '120 tablets',
    'amino acid supplement': '120 capsules',
    'calcium supplement': '120 tablets',
    'spirulina powder': '1 lb',
    'electrolyte powder': '8 oz',
    'vitamin d3 drops': '1 oz',
    'brewer\'s yeast': '16 oz',
    'biotin': '100 tablets',
    'quercetin': '120 capsules',
    'd-mannose': '120 tablets',
    'beta-glucans': '60 capsules',
    'sage': '0.5 oz',
  },
  
  // Hay
  hay: {
    'timothy hay': '10 lbs',
    'meadow hay': '10 lbs',
    'orchard grass hay': '10 lbs',
    'alfalfa hay': '10 lbs',
    'wheat hay': '10 lbs',
    'fescue hay': '10 lbs',
    'oat hay': '10 lbs',
    'bluegrass hay': '10 lbs',
    'barley hay': '5 lbs',
    'bermuda hay': '10 lbs',
    'straw (wheat/pine)': '10 lbs',
    'dried grass': '1 lb',
  },
  
  // Pellets
  pellets: {
    'pellets (fortified)': '3 lbs',
    'guinea pig pellets (with vitamin c)': '5 lbs',
    'rabbit pellets (high fiber)': '10 lbs',
    'hamster pellets (higher protein)': '2 lbs',
    'cuttlebone': '3 pack',
  },
  
  // Fruits
  fruits: {
    'apples (no seeds)': '12 oz',
    'blueberries': '4 oz',
    'strawberries': '12 oz',
    'mango': '10 oz',
    'banana': '1 lb',
    'grapes (chopped)': '2 lbs',
    'papaya': '16 oz',
    'melon': '2 lbs',
    'apricots (pitted)': '1 lb',
    'kiwi': '2 lbs',
    'mulberries': '8 oz',
    'raspberries': '12 oz',
    'cranberries': '12 oz',
    'pineapple (small amounts)': '16 oz',
    'pears (no seeds)': '2 lbs',
    'figs': '1 lb',
    'plums (pitted)': '2 lbs',
    'raisins (unsweetened)': '12 oz',
  },
  
  // Insects
  insects: {
    'dubia roaches': '50 count',
    'crickets': '100 count',
    'mealworms': '100 count',
    'superworms': '50 count',
    'black soldier fly larvae': '250 count',
    'hornworms': '25 count',
    'pinhead crickets': '500 count',
    'locusts': '50 count',
    'butterworms': '50 count',
    'grasshoppers': '50 count',
    'small dubia roaches': '100 count',
    'silkworms': '25 count',
    'earthworms': '50 count',
  },
  
  // Bird seed
  birdSeed: {
    'millet (white/red)': '5 lbs',
    'wild bird mix': '5 lbs',
  },
  
  // Eggs
  eggs: {
    'eggs': '12 oz',
    'egg (hard-boiled)': '6 pack',
    'egg yolks': '8 oz',
    'quail eggs': '18 count',
  },
  
  // Misc
  misc: {
    'chicken broth': '32 oz',
    'bone broth (low sodium)': '16 oz',
    'honey (tiny amounts)': '16 oz',
    'peanut butter (unsalted, tiny amounts)': '16 oz',
  }
};

// Flatten all rules into one object
const ALL_QUANTITIES = {};
Object.values(QUANTITY_RULES).forEach(category => {
  Object.assign(ALL_QUANTITIES, category);
});

// Add default quantities for items not in the rules
function getDefaultQuantity(ingredient) {
  const name = ingredient.toLowerCase();
  
  if (name.includes('oil')) return '16 oz';
  if (name.includes('seed')) return '1 lb';
  if (name.includes('powder') || name.includes('supplement')) return '8 oz';
  if (name.includes('hay')) return '10 lbs';
  if (name.includes('pellet')) return '5 lbs';
  if (name.includes('broth')) return '32 oz';
  if (name.includes('meat') || name.includes('ground')) return '1 lb';
  if (name.includes('liver') || name.includes('heart') || name.includes('giblet')) return '8 oz';
  if (name.includes('fish') || name.includes('salmon') || name.includes('herring')) return '12 oz';
  if (name.includes('vegetable') || name.includes('greens')) return '12 oz';
  if (name.includes('fruit') || name.includes('berry')) return '12 oz';
  if (name.includes('bean')) return '1 lb';
  if (name.includes('rice') || name.includes('grain')) return '2 lbs';
  
  return '1 lb'; // Default fallback
}

function addQuantitiesToJSON(inputFile, outputFile) {
  console.log('üìñ Reading product-prices.json...');
  
  const data = JSON.parse(fs.readFileSync(inputFile, 'utf-8'));
  
  console.log(`‚úÖ Found ${data.length} products\n`);
  console.log('üì¶ Adding quantities...\n');
  
  let addedCount = 0;
  
  const updatedData = data.map(item => {
    const quantity = ALL_QUANTITIES[item.ingredient] || getDefaultQuantity(item.ingredient);
    
    console.log(`  ${item.ingredient} ‚Üí ${quantity}`);
    addedCount++;
    
    return {
      ...item,
      quantity: quantity
    };
  });
  
  // Fix the two $0 items while we're at it
  const fixedData = updatedData.map(item => {
    if (item.ingredient === 'venison' && item.price.amount === 0) {
      return {
        ...item,
        price: { amount: 24.99, currency: 'USD', lastUpdated: new Date().toISOString() }
      };
    }
    if (item.ingredient === 'snow peas' && item.price.amount === 0) {
      return {
        ...item,
        price: { amount: 16.99, currency: 'USD', lastUpdated: new Date().toISOString() }
      };
    }
    return item;
  });
  
  console.log(`\nüíæ Writing to ${outputFile}...`);
  fs.writeFileSync(outputFile, JSON.stringify(fixedData, null, 2));
  
  console.log(`\n‚úÖ Done!`);
  console.log(`üì¶ Added quantities to ${addedCount} products`);
  console.log(`üîß Fixed 2 zero-price items (venison, snow peas)`);
}

// Run it
const inputFile = './data/product-prices.json';
const outputFile = './data/product-prices-UPDATED.json';

try {
  addQuantitiesToJSON(inputFile, outputFile);
} catch (error) {
  console.error('‚ùå ERROR:', error.message);
  process.exit(1);
}
</file>

<file path="scripts/maintenance/fix_now.js">
const fs = require('fs');
const path = require('path');

const filePath = path.join(__dirname, 'app/profile/page.tsx');
console.log('Fixing:', filePath);

let content = fs.readFileSync(filePath, 'utf8');

// Check if already fixed
if (content.includes('Save each pet async')) {
  console.log('‚úÖ Already fixed!');
  process.exit(0);
}

// Fix the line
const oldCode = 'savePetsToLocalStorage(userId, updatedPets);';
const newCode = `// Save each pet async
        updatedPets.forEach(pet => {
          savePet(userId, pet).catch(err => console.error('Failed to save pet:', err));
        });`;

if (content.includes(oldCode)) {
  content = content.replace(oldCode, newCode);
  fs.writeFileSync(filePath, content);
  console.log('‚úÖ Fixed successfully!');
  
  // Show the fix
  const lines = content.split('\n');
  const lineNum = lines.findIndex(l => l.includes('Save each pet async'));
  console.log('\nFixed at line', lineNum + 1);
  console.log(lines.slice(lineNum, lineNum + 4).join('\n'));
} else {
  console.log('‚ùå Could not find exact match.');
  
  // Try to find any variation
  const lines = content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('savePetsToLocalStorage')) {
      console.log(`Found at line ${i + 1}: ${lines[i]}`);
      console.log('Replacing...');
      lines[i] = lines[i].replace('savePetsToLocalStorage(userId, updatedPets);', newCode);
      fs.writeFileSync(filePath, lines.join('\n'));
      console.log('‚úÖ Fixed line', i + 1);
      break;
    }
  }
}
</file>

<file path="scripts/maintenance/fix-all-js-imports.cjs">
// Comprehensive script to remove ALL .js extensions from imports in TypeScript files
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('üîç Finding all TypeScript files with .js imports...\n');

// Find all .ts and .tsx files with .js imports
let filesToFix = [];
try {
  // Use grep/findstr to locate files (cross-platform approach)
  const isWindows = process.platform === 'win32';
  
  if (isWindows) {
    // Windows: recursively find all .ts and .tsx files
    const findCommand = 'dir /s /b *.ts *.tsx 2>nul';
    const allFiles = execSync(findCommand, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 })
      .split('\n')
      .filter(f => f.trim() && !f.includes('node_modules'));
    
    // Check each file for .js imports
    allFiles.forEach(file => {
      try {
        const content = fs.readFileSync(file.trim(), 'utf8');
        if (content.match(/from ['"]\.\/.*\.js['"]/)) {
          filesToFix.push(file.trim());
        }
      } catch (e) {
        // Skip files that can't be read
      }
    });
  } else {
    // Unix-like systems
    const grepCommand = 'grep -rl "from [\'\\"]\\./.*\\.js[\'\\\"]" --include="*.ts" --include="*.tsx" . 2>/dev/null || true';
    const output = execSync(grepCommand, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 });
    filesToFix = output.split('\n').filter(f => f.trim() && !f.includes('node_modules'));
  }
} catch (e) {
  console.log('‚ö†Ô∏è  Could not auto-detect files, using manual list...');
  filesToFix = [
    './lib/utils/customMealStorageFirebase.ts',
    './lib/services/unifiedVettingService.ts',
    './lib/utils/ingredientSuggestions.ts',
    './lib/utils/improvedCompatibilityScoring.ts',
    './lib/utils/localStorageSafe.ts',
    './lib/utils/ingredientWhitelists.ts',
    './lib/data/__tests__/TESTEST.ts',
    './lib/utils/petPurchaseTracking.ts',
    './lib/utils/purchaseTracking.ts',
    './lib/utils/recipeRecommendations.ts',
    './lib/utils/scoringDiagnostics.ts',
    './lib/utils/scoringTransparency.ts',
    './lib/utils/validation.ts',
  ];
}

console.log(`üìù Found ${filesToFix.length} files to check\n`);

let fixedCount = 0;
let skippedCount = 0;
let errorCount = 0;

filesToFix.forEach(filePath => {
  try {
    const fullPath = path.resolve(filePath);
    if (!fs.existsSync(fullPath)) {
      console.log(`‚ö†Ô∏è  Skipping ${filePath} - file not found`);
      skippedCount++;
      return;
    }

    let content = fs.readFileSync(fullPath, 'utf8');
    const original = content;
    
    // Remove ALL .js extensions from imports
    // Pattern 1: from './something.js' or from "./something.js"
    content = content.replace(/from ['"](\.\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 2: from '@/something.js'
    content = content.replace(/from ['"](@\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 3: import './something.js'
    content = content.replace(/import ['"](\.\/.+?)\.js['"]/g, "import '$1'");
    // Pattern 4: import '@/something.js'
    content = content.replace(/import ['"](@\/.+?)\.js['"]/g, "import '$1'");
    
    if (content !== original) {
      fs.writeFileSync(fullPath, content, 'utf8');
      const relativePath = path.relative(process.cwd(), fullPath);
      console.log(`‚úÖ Fixed ${relativePath}`);
      fixedCount++;
    } else {
      const relativePath = path.relative(process.cwd(), fullPath);
      console.log(`‚è≠Ô∏è  No changes needed for ${relativePath}`);
      skippedCount++;
    }
  } catch (error) {
    console.error(`‚ùå Error fixing ${filePath}:`, error.message);
    errorCount++;
  }
});

console.log('\n' + '='.repeat(50));
console.log('üìä Summary:');
console.log(`‚úÖ Fixed: ${fixedCount} files`);
console.log(`‚è≠Ô∏è  Skipped: ${skippedCount} files`);
console.log(`‚ùå Errors: ${errorCount} files`);
console.log('='.repeat(50));
console.log('\n‚ú® All done! Try running: npm run dev');
</file>

<file path="scripts/maintenance/fix-all-js-imports.js">
// Comprehensive script to remove ALL .js extensions from imports in TypeScript files
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('üîç Finding all TypeScript files with .js imports...\n');

// Find all .ts and .tsx files with .js imports
let filesToFix = [];
try {
  // Use grep/findstr to locate files (cross-platform approach)
  const isWindows = process.platform === 'win32';
  
  if (isWindows) {
    // Windows: recursively find all .ts and .tsx files
    const findCommand = 'dir /s /b *.ts *.tsx 2>nul';
    const allFiles = execSync(findCommand, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 })
      .split('\n')
      .filter(f => f.trim() && !f.includes('node_modules'));
    
    // Check each file for .js imports
    allFiles.forEach(file => {
      try {
        const content = fs.readFileSync(file.trim(), 'utf8');
        if (content.match(/from ['"]\.\/.*\.js['"]/)) {
          filesToFix.push(file.trim());
        }
      } catch (e) {
        // Skip files that can't be read
      }
    });
  } else {
    // Unix-like systems
    const grepCommand = 'grep -rl "from [\'\\"]\\./.*\\.js[\'\\\"]" --include="*.ts" --include="*.tsx" . 2>/dev/null || true';
    const output = execSync(grepCommand, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 });
    filesToFix = output.split('\n').filter(f => f.trim() && !f.includes('node_modules'));
  }
} catch (e) {
  console.log('‚ö†Ô∏è  Could not auto-detect files, using manual list...');
  filesToFix = [
    './lib/utils/customMealStorageFirebase.ts',
    './lib/services/unifiedVettingService.ts',
    './lib/utils/ingredientSuggestions.ts',
    './lib/utils/improvedCompatibilityScoring.ts',
    './lib/utils/localStorageSafe.ts',
    './lib/utils/ingredientWhitelists.ts',
    './lib/data/__tests__/TESTEST.ts',
    './lib/utils/petPurchaseTracking.ts',
    './lib/utils/purchaseTracking.ts',
    './lib/utils/recipeRecommendations.ts',
    './lib/utils/scoringDiagnostics.ts',
    './lib/utils/scoringTransparency.ts',
    './lib/utils/validation.ts',
  ];
}

console.log(`üìù Found ${filesToFix.length} files to check\n`);

let fixedCount = 0;
let skippedCount = 0;
let errorCount = 0;

filesToFix.forEach(filePath => {
  try {
    const fullPath = path.resolve(filePath);
    if (!fs.existsSync(fullPath)) {
      console.log(`‚ö†Ô∏è  Skipping ${filePath} - file not found`);
      skippedCount++;
      return;
    }

    let content = fs.readFileSync(fullPath, 'utf8');
    const original = content;
    
    // Remove ALL .js extensions from imports
    // Pattern 1: from './something.js' or from "./something.js"
    content = content.replace(/from ['"](\.\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 2: from '@/something.js'
    content = content.replace(/from ['"](@\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 3: import './something.js'
    content = content.replace(/import ['"](\.\/.+?)\.js['"]/g, "import '$1'");
    // Pattern 4: import '@/something.js'
    content = content.replace(/import ['"](@\/.+?)\.js['"]/g, "import '$1'");
    
    if (content !== original) {
      fs.writeFileSync(fullPath, content, 'utf8');
      const relativePath = path.relative(process.cwd(), fullPath);
      console.log(`‚úÖ Fixed ${relativePath}`);
      fixedCount++;
    } else {
      const relativePath = path.relative(process.cwd(), fullPath);
      console.log(`‚è≠Ô∏è  No changes needed for ${relativePath}`);
      skippedCount++;
    }
  } catch (error) {
    console.error(`‚ùå Error fixing ${filePath}:`, error.message);
    errorCount++;
  }
});

console.log('\n' + '='.repeat(50));
console.log('üìä Summary:');
console.log(`‚úÖ Fixed: ${fixedCount} files`);
console.log(`‚è≠Ô∏è  Skipped: ${skippedCount} files`);
console.log(`‚ùå Errors: ${errorCount} files`);
console.log('='.repeat(50));
console.log('\n‚ú® All done! Try running: npm run dev');
</file>

<file path="scripts/maintenance/fix-apostrophes.js">
const fs = require('fs');

let content = fs.readFileSync('lib/data/vetted-products.ts', 'utf-8');

// Fix all productName entries with apostrophes
content = content.replace(/productName: '([^']*')([^']*)'/g, (match, before, after) => {
  // Extract the ingredient name from context (this is a simple approach)
  const lines = match.split('\n');
  // For now, just remove the apostrophe and make it generic
  const cleaned = before.replace(/'/g, '') + after;
  return `productName: '${cleaned}'`;
});

// More targeted fixes for known patterns
const replacements = [
  ["Canary seed's Parrot Food Flax Seed", "Flax seed"],
  ["Canary seed's Parrot Food Sesame Seed", "Sesame seed"],
  ["Canary seed's Parrot Food Chia Seed", "Chia seed"],
  ["Canary seed's Parrot Food Cooked Quinoa", "Quinoa (Cooked)"],
  ["Canary seed's Parrot Food Rapeseed", "Rapeseed"],
  ["Canary seed's Parrot Food Sunflower Seed", "Sunflower seed"],
  ["Canary seed's Parrot Food Pumpkin Seed", "Pumpkin seed"],
  ["Strawberries's Organic Blueberries", "Blueberries (Organic)"],
  ["Strawberries's Organic Strawberries", "Strawberries (Organic)"],
  ["Canary seed's Parrot Food Pellets", "Bird pellets"],
  ["Canary seed's Parrot Food Cuttlebone", "Cuttlebone"],
  ["Superworms's Frogs Live Dubia Roaches", "Dubia roaches (Live)"],
  ["Mealworms's Live Crickets", "Crickets (Live)"],
];

replacements.forEach(([old, new_]) => {
  content = content.replace(new RegExp(`productName: '${old.replace(/'/g, "\\'")}'`, 'g'), `productName: '${new_}'`);
});

fs.writeFileSync('lib/data/vetted-products.ts', content);
console.log('Fixed all apostrophes in product names');
</file>

<file path="scripts/maintenance/fix-imports.js">
// Script to remove .js extensions from ALL imports in TypeScript files
const fs = require('fs');
const path = require('path');

const filesToFix = [
  './lib/services/unifiedVettingService.ts',
  './lib/utils/customMealStorageFirebase.ts',
  './lib/utils/improvedCompatibilityScoring.ts',
  './lib/data/__tests__/TESTEST.ts',
  './lib/utils/enhancedCompatibilityScoring.ts',
  './lib/utils/ingredientSuggestions.ts',
  './lib/utils/localStorageSafe.ts',
  './lib/utils/ingredientWhitelists.ts',
  './lib/utils/petPurchaseTracking.ts',
  './lib/utils/purchaseTracking.ts',
  './lib/utils/recipeRecommendations.ts',
  './lib/utils/scoringDiagnostics.ts',
  './lib/utils/scoringTransparency.ts',
  './lib/utils/validation.ts',
];

let fixedCount = 0;
let skippedCount = 0;
let errorCount = 0;

filesToFix.forEach(filePath => {
  try {
    const fullPath = path.resolve(filePath);
    if (!fs.existsSync(fullPath)) {
      console.log(`‚ö†Ô∏è  Skipping ${filePath} - file not found`);
      skippedCount++;
      return;
    }

    let content = fs.readFileSync(fullPath, 'utf8');
    const original = content;
    
    // Remove .js extensions from ALL imports (relative and absolute)
    // Pattern 1: from './something.js'
    content = content.replace(/from ['"](\.\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 2: from '@/something.js'
    content = content.replace(/from ['"](@\/.+?)\.js['"]/g, "from '$1'");
    // Pattern 3: import './something.js'
    content = content.replace(/import ['"](\.\/.+?)\.js['"]/g, "import '$1'");
    
    if (content !== original) {
      fs.writeFileSync(fullPath, content, 'utf8');
      console.log(`‚úÖ Fixed ${filePath}`);
      fixedCount++;
    } else {
      console.log(`‚è≠Ô∏è  No changes needed for ${filePath}`);
      skippedCount++;
    }
  } catch (error) {
    console.error(`‚ùå Error fixing ${filePath}:`, error.message);
    errorCount++;
  }
});

console.log('\nüìä Summary:');
console.log(`‚úÖ Fixed: ${fixedCount}`);
console.log(`‚è≠Ô∏è  Skipped: ${skippedCount}`);
console.log(`‚ùå Errors: ${errorCount}`);
console.log('\n‚ú® Done!');
</file>

<file path="scripts/maintenance/fix-prices-standalone.js">
// fix-prices-standalone.js
// Standalone script to update vetted products with prices and ASINs
// Uses GENERIC ingredient names for Amazon searches
// Run with: node fix-prices-standalone.js

import fs from 'fs';
import https from 'https';
import http from 'http';

// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
  inputFile: './lib/data/vetted-products.txt',  // Your current file
  outputFile: './lib/data/vetted-products-UPDATED.txt',
  reportFile: './PRICE-ASIN-REPORT.md',
  delayBetweenRequests: 3000, // 3 seconds (don't change - rate limiting)
  maxRetries: 2,
};

// ============================================================================
// GENERIC INGREDIENT NAME EXTRACTION
// ============================================================================

/**
 * Extracts the generic ingredient name from the key.
 * Examples:
 *   'ground-chicken' -> 'ground chicken'
 *   'chicken-breast' -> 'chicken breast'
 *   'salmon-(boneless)' -> 'salmon'
 */
function getGenericIngredientName(key) {
  return key
    .replace(/-/g, ' ')           // Replace hyphens with spaces
    .replace(/\(.*?\)/g, '')      // Remove parentheses content
    .replace(/\s+/g, ' ')         // Normalize spaces
    .trim();
}

// ============================================================================
// HTTP REQUEST HELPER
// ============================================================================

function makeRequest(url) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;
    
    const options = {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9',
        'Connection': 'keep-alive',
      },
      timeout: 15000,
    };
    
    protocol.get(url, options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        resolve(data);
      });
    }).on('error', (err) => {
      reject(err);
    });
  });
}

// ============================================================================
// PARSE VETTED PRODUCTS FILE
// ============================================================================

function parseVettedProductsFile(filePath) {
  console.log(`üìñ Reading file: ${filePath}`);
  
  const content = fs.readFileSync(filePath, 'utf-8');
  const products = {};
  
  // Match entries like: 'ingredient-name': { ... }
  const lines = content.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);
    
    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];
      
      // Extract the object block
      let block = '';
      let braceCount = 1;
      let j = i + 1;
      
      while (j < lines.length && braceCount > 0) {
        block += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }
      
      // Extract fields
      const productNameMatch = block.match(/productName:\s*'([^']+)'/);
      const amazonLinkMatch = block.match(/amazonLink:\s*'([^']+)'/);
      const vetNoteMatch = block.match(/vetNote:\s*'([^']+)'/);
      const categoryMatch = block.match(/category:\s*'([^']+)'/);
      
      products[ingredient] = {
        productName: productNameMatch ? productNameMatch[1] : '',
        amazonLink: amazonLinkMatch ? amazonLinkMatch[1] : '',
        vetNote: vetNoteMatch ? vetNoteMatch[1] : '',
        category: categoryMatch ? categoryMatch[1] : 'other',
      };
    }
  }
  
  console.log(`‚úÖ Found ${Object.keys(products).length} products\n`);
  return products;
}

// ============================================================================
// SEARCH AMAZON USING GENERIC INGREDIENT NAME
// ============================================================================

async function searchAmazonByGenericName(ingredientKey, retryCount = 0) {
  const genericName = getGenericIngredientName(ingredientKey);
  
  try {
    console.log(`  üîç Searching for: "${genericName}"`);
    
    // Search in pet-supplies category
    const searchUrl = `https://www.amazon.com/s?k=${encodeURIComponent(genericName)}&i=pet-supplies`;
    const html = await makeRequest(searchUrl);
    
    // Extract first product ASIN and price
    const asinMatch = html.match(/data-asin="([A-Z0-9]{10})"/);
    if (!asinMatch) {
      console.log(`  ‚ùå No ASIN found`);
      return null;
    }
    
    const asin = asinMatch[1];
    
    // Try to extract price from search results
    const pricePattern = new RegExp(`data-asin="${asin}"[\\s\\S]{0,1000}?\\$([\\d,]+\\.\\d{2})`);
    const priceMatch = html.match(pricePattern);
    
    let price = null;
    if (priceMatch) {
      price = parseFloat(priceMatch[1].replace(/,/g, ''));
    }
    
    // Try to get title
    const titlePattern = new RegExp(`data-asin="${asin}"[\\s\\S]{0,500}?<span class="a-size-[^"]*">([^<]+)</span>`);
    const titleMatch = html.match(titlePattern);
    const title = titleMatch ? titleMatch[1].trim() : 'Unknown Product';
    
    console.log(`  ‚úÖ Found: ${title}`);
    console.log(`  üì¶ ASIN: ${asin}`);
    
    if (price) {
      console.log(`  üí∞ Price: $${price.toFixed(2)}`);
    } else {
      console.log(`  ‚ö†Ô∏è  No price found in search, will try product page...`);
      price = await getPriceFromProductPage(asin);
      if (price) {
        console.log(`  üí∞ Price from product page: $${price.toFixed(2)}`);
      }
    }
    
    return {
      asin,
      title,
      price,
      link: `https://www.amazon.com/dp/${asin}?tag=robinfrench-20`,
    };
    
  } catch (error) {
    if (retryCount < CONFIG.maxRetries) {
      console.log(`  ‚ö†Ô∏è  Error, retrying (${retryCount + 1}/${CONFIG.maxRetries})...`);
      await sleep(5000);
      return searchAmazonByGenericName(ingredientKey, retryCount + 1);
    }
    console.error(`  ‚ùå Search failed: ${error.message}`);
    return null;
  }
}

// ============================================================================
// GET PRICE FROM PRODUCT PAGE
// ============================================================================

async function getPriceFromProductPage(asin) {
  try {
    const url = `https://www.amazon.com/dp/${asin}`;
    const html = await makeRequest(url);
    
    // Try multiple price patterns
    const pricePatterns = [
      /<span class="a-price-whole">([\d,]+)<\/span><span class="a-price-fraction">(\d{2})<\/span>/,
      /<span id="priceblock_ourprice"[^>]*>\$([\d,]+\.?\d{2})<\/span>/,
      /<span id="priceblock_dealprice"[^>]*>\$([\d,]+\.?\d{2})<\/span>/,
      /<span class="a-offscreen">\$([\d,]+\.?\d{2})<\/span>/,
    ];
    
    for (const pattern of pricePatterns) {
      const match = html.match(pattern);
      if (match) {
        let priceStr;
        if (match.length === 3) {
          // Whole + fraction pattern
          priceStr = match[1].replace(/,/g, '') + '.' + match[2];
        } else {
          priceStr = match[1].replace(/,/g, '');
        }
        const price = parseFloat(priceStr);
        if (!isNaN(price) && price > 0) {
          return price;
        }
      }
    }
    
    return null;
  } catch (error) {
    return null;
  }
}

// ============================================================================
// PROCESS ALL PRODUCTS
// ============================================================================

async function processAllProducts(products) {
  const results = [];
  const ingredients = Object.keys(products);
  
  console.log(`\nüöÄ Processing ${ingredients.length} products...\n`);
  console.log(`‚è±Ô∏è  Estimated time: ${Math.ceil((ingredients.length * CONFIG.delayBetweenRequests) / 60000)} minutes\n`);
  
  for (let i = 0; i < ingredients.length; i++) {
    const ingredient = ingredients[i];
    const product = products[ingredient];
    
    console.log(`\n[${i + 1}/${ingredients.length}] ${ingredient}`);
    console.log(`  Generic name: "${getGenericIngredientName(ingredient)}"`);
    
    // Search using generic ingredient name
    const searchResult = await searchAmazonByGenericName(ingredient);
    
    if (!searchResult) {
      results.push({
        ingredient,
        genericName: getGenericIngredientName(ingredient),
        oldLink: product.amazonLink,
        newASIN: null,
        newLink: null,
        price: null,
        status: 'failed',
        reason: 'No search results found',
      });
      
      // Rate limiting
      await sleep(CONFIG.delayBetweenRequests);
      continue;
    }
    
    results.push({
      ingredient,
      genericName: getGenericIngredientName(ingredient),
      oldLink: product.amazonLink,
      newASIN: searchResult.asin,
      newLink: searchResult.link,
      price: searchResult.price,
      title: searchResult.title,
      status: 'success',
    });
    
    // Rate limiting (IMPORTANT!)
    await sleep(CONFIG.delayBetweenRequests);
  }
  
  return results;
}

// ============================================================================
// GENERATE UPDATED FILE
// ============================================================================

function generateUpdatedFile(originalProducts, results) {
  const updatesMap = new Map();
  results.forEach(r => updatesMap.set(r.ingredient, r));
  
  let output = `// lib/data/vetted-products-UPDATED.txt
// AUTO-GENERATED with prices and correct ASINs
// Generated: ${new Date().toISOString()}
// Searched using GENERIC ingredient names

export const VETTED_PRODUCTS = {\n`;
  
  for (const [ingredient, product] of Object.entries(originalProducts)) {
    const update = updatesMap.get(ingredient);
    
    output += `  '${ingredient}': {\n`;
    output += `    productName: '${product.productName}',\n`;
    
    // Use updated ASIN if available
    if (update && update.status === 'success' && update.newASIN) {
      output += `    amazonLink: '${update.newLink}',\n`;
      output += `    asinLink: '${update.newLink}',\n`;
      
      // Add price if available
      if (update.price !== null) {
        output += `    price: {\n`;
        output += `      amount: ${update.price.toFixed(2)},\n`;
        output += `      currency: 'USD'\n`;
        output += `    },\n`;
      }
    } else {
      output += `    amazonLink: '${product.amazonLink}',\n`;
      output += `    asinLink: '${product.amazonLink}',\n`;
    }
    
    output += `    vetNote: '${product.vetNote.replace(/'/g, "\\'")}',\n`;
    output += `    category: '${product.category}',\n`;
    output += `    commissionRate: 0.03\n`;
    output += `  },\n`;
  }
  
  output += `};\n`;
  
  return output;
}

// ============================================================================
// GENERATE REPORT
// ============================================================================

function generateReport(results) {
  const successful = results.filter(r => r.status === 'success');
  const failed = results.filter(r => r.status === 'failed');
  const withPrice = successful.filter(r => r.price !== null);
  const withoutPrice = successful.filter(r => r.price === null);
  
  let report = `# Price & ASIN Update Report
Generated: ${new Date().toLocaleString()}

## Summary
- Total Products: ${results.length}
- ‚úÖ Successfully Updated: ${successful.length}
- ‚ùå Failed: ${failed.length}
- üí∞ With Prices: ${withPrice.length}
- ‚ö†Ô∏è  Without Prices: ${withoutPrice.length}

## Successful Updates (With Prices)

`;

  withPrice.forEach((r, i) => {
    report += `### ${i + 1}. ${r.ingredient}
- **Generic Search:** "${r.genericName}"
- **Found:** ${r.title}
- **ASIN:** ${r.newASIN}
- **Price:** $${r.price.toFixed(2)}
- **Link:** ${r.newLink}

`;
  });
  
  if (withoutPrice.length > 0) {
    report += `\n## Updated (No Price Found)\n\n`;
    withoutPrice.forEach((r, i) => {
      report += `### ${i + 1}. ${r.ingredient}
- **Generic Search:** "${r.genericName}"
- **ASIN:** ${r.newASIN}
- **Link:** ${r.newLink}

`;
    });
  }
  
  if (failed.length > 0) {
    report += `\n## Failed Updates (Need Manual Fix)\n\n`;
    failed.forEach((r, i) => {
      report += `### ${i + 1}. ${r.ingredient}
- **Generic Search:** "${r.genericName}"
- **Reason:** ${r.reason}
- **Old Link:** ${r.oldLink}

`;
    });
  }
  
  return report;
}

// ============================================================================
// HELPERS
// ============================================================================

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================================================
// MAIN
// ============================================================================

async function main() {
  console.log('üöÄ AUTOMATED PRICE & ASIN UPDATER (Standalone)\n');
  console.log('‚îÅ'.repeat(60));
  console.log(`üìÅ Input:  ${CONFIG.inputFile}`);
  console.log(`üìÅ Output: ${CONFIG.outputFile}`);
  console.log(`üìÅ Report: ${CONFIG.reportFile}`);
  console.log('‚îÅ'.repeat(60));
  
  try {
    // Check if input file exists
    if (!fs.existsSync(CONFIG.inputFile)) {
      console.error(`\n‚ùå ERROR: Input file not found: ${CONFIG.inputFile}`);
      console.error('Please update CONFIG.inputFile with the correct path.\n');
      process.exit(1);
    }
    
    // Step 1: Parse input file
    const products = parseVettedProductsFile(CONFIG.inputFile);
    
    if (Object.keys(products).length === 0) {
      console.log('‚ùå No products found in file. Check file format.');
      process.exit(1);
    }
    
    // Step 2: Process products
    console.log('üîß Searching Amazon using GENERIC ingredient names...');
    console.log('‚ö†Ô∏è  This uses rate limiting (3s per product) to avoid blocking\n');
    
    const results = await processAllProducts(products);
    
    // Step 3: Generate updated file
    console.log('\nüíæ Generating updated file...');
    const updatedContent = generateUpdatedFile(products, results);
    fs.writeFileSync(CONFIG.outputFile, updatedContent);
    console.log(`‚úÖ Saved to: ${CONFIG.outputFile}`);
    
    // Step 4: Generate report
    console.log('\nüìä Generating report...');
    const report = generateReport(results);
    fs.writeFileSync(CONFIG.reportFile, report);
    console.log(`‚úÖ Saved to: ${CONFIG.reportFile}`);
    
    // Summary
    const successful = results.filter(r => r.status === 'success').length;
    const withPrice = results.filter(r => r.status === 'success' && r.price !== null).length;
    
    console.log('\nüéâ DONE!\n');
    console.log('‚îÅ'.repeat(60));
    console.log(`‚úÖ Successfully updated: ${successful}/${results.length}`);
    console.log(`üí∞ Found prices for: ${withPrice}/${results.length}`);
    console.log('‚îÅ'.repeat(60));
    console.log('\nüìã Next steps:');
    console.log('1. Review the report: ' + CONFIG.reportFile);
    console.log('2. Check the updated file: ' + CONFIG.outputFile);
    console.log('3. Manually fix any failed items');
    console.log('4. Replace your old file with the updated one\n');
    
  } catch (error) {
    console.error('\n‚ùå ERROR:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run it!
main();
</file>

<file path="scripts/maintenance/simple-price-test.js">
import https from 'https';

// Test fetching price from a single known ASIN
async function testSinglePrice() {
  const asin = 'B0BXZVFN6G'; // Fresh Is Best Freeze Dried Chicken Breast
  const url = `https://www.amazon.com/dp/${asin}`;

  console.log(`Testing price fetch for ASIN: ${asin}`);
  console.log(`URL: ${url}`);

  try {
    const html = await new Promise((resolve, reject) => {
      https.get(url, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        },
        timeout: 15000,
      }, (res) => {
        let data = '';
        res.on('data', (chunk) => data += chunk);
        res.on('end', () => resolve(data));
      }).on('error', reject);
    });

    console.log(`Response received, length: ${html.length}`);

    // Look for price patterns
    const pricePatterns = [
      /id="priceblock_ourprice"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*</,
      /id="priceblock_dealprice"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*</,
      /class="a-price[^"]*"[^>]*>[\s\S]*?class="a-offscreen"[^>]*>\s*\$([0-9,]+\.[0-9]{2})\s*</,
    ];

    for (let i = 0; i < pricePatterns.length; i++) {
      const match = html.match(pricePatterns[i]);
      if (match) {
        console.log(`‚úÖ Pattern ${i + 1} found: $${match[1]}`);
        return;
      }
    }

    // Look for any dollar amounts as fallback
    const dollarMatches = html.match(/\$([0-9,]+\.[0-9]{2})/g);
    if (dollarMatches) {
      console.log(`üí∞ Found dollar amounts: ${dollarMatches.slice(0, 3).join(', ')}`);
    } else {
      console.log(`‚ùå No dollar amounts found in HTML`);
    }

    // Check if it's a product page
    if (html.includes('priceblock')) {
      console.log(`üì¶ This appears to be a product page (found priceblock)`);
    } else {
      console.log(`‚ùì This might not be a product page (no priceblock found)`);
    }

  } catch (error) {
    console.error(`‚ùå Error: ${error.message}`);
  }
}

testSinglePrice();
</file>

<file path="scripts/maintenance/simple-replace-prices.js">
// simple-replace-prices.js
// NO BULLSHIT - Just replace the prices and ASINs

import fs from 'fs';

// ============================================================================
// BUDGET REPLACEMENTS - STRAIGHT FROM THE GUIDE
// ============================================================================

const REPLACEMENTS = {
  'sage': {
    asin: 'B00BUSL1SO',
    productName: 'Simply Organic Sage',
    price: 6.99
  },
  'beta-glucans': {
    asin: 'B08CXQV9V7',
    productName: 'Wonder Paws Turkey Tail Mushroom',
    price: 29.99
  },
  'collard greens': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'broccoli': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'kale': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'celery': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'krill oil': {
    asin: 'B01N9SSTG8',
    productName: 'Zesty Paws Wild Alaskan Salmon Oil',
    price: 21.99
  },
  'quinoa': {
    asin: 'B000EDG598',
    productName: "Bob's Red Mill Organic Quinoa",
    price: 12.49
  },
  'sweet potato': {
    asin: 'B07YNQ6T9Z',
    productName: 'Wholesome Pride Freeze-Dried Sweet Potato',
    price: 12.99
  },
  'snow peas (mashed)': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'duck liver': {
    asin: 'B0BXZ3JJL9',
    productName: 'Fresh Is Best Freeze-Dried Liver',
    price: 24.99
  },
  'oatmeal (cooked, small amounts)': {
    asin: 'B000EDG52O',
    productName: "Bob's Red Mill Steel Cut Oats",
    price: 7.99
  },
  'oatmeal': {
    asin: 'B000EDG52O',
    productName: "Bob's Red Mill Steel Cut Oats",
    price: 7.99
  },
  'eggs': {
    asin: 'B08P4C7QYZ',  // Freeze-dried eggs for pets
    productName: 'Vital Essentials Freeze-Dried Egg Treats',
    price: 12.99
  },
  'butternut squash': {
    asin: 'B000HDCSTG',
    productName: "Farmer's Market Organic Pumpkin Puree",
    price: 4.99
  },
  'sunflower oil': {
    asin: 'B00C11W8YW',
    productName: 'Spectrum Organic Sunflower Oil',
    price: 8.99
  },
  'olive oil': {
    asin: 'B00GGBLPVU',
    productName: 'California Olive Ranch Extra Virgin Olive Oil',
    price: 12.99
  },
  'chicken hearts': {
    asin: 'B0BXZ3JJL9',
    productName: 'Fresh Is Best Freeze-Dried Organ Meat',
    price: 24.99
  },
  'turkey giblets': {
    asin: 'B0BXZ3JJL9',
    productName: 'Fresh Is Best Freeze-Dried Organ Meat',
    price: 24.99
  },
  'escarole': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'niger seed': {
    asin: 'B001ODB3YE',
    productName: 'Kaytee Wild Bird Food Mix',
    price: 16.99
  },
  'oat groats': {
    asin: 'B000EDG52O',
    productName: "Bob's Red Mill Oat Groats",
    price: 7.99
  },
  'hemp seeds': {
    asin: 'B01N7GJVNH',
    productName: 'Manitoba Harvest Hemp Hearts',
    price: 14.99
  },
  'chia seeds': {
    asin: 'B00JL2X3D4',
    productName: 'Viva Naturals Organic Chia Seeds',
    price: 9.99
  },
  'sesame seeds': {
    asin: 'B07ZYNJ43K',
    productName: "Anthony's Organic Sesame Seeds",
    price: 8.99
  },
  'pellets (fortified)': {
    asin: 'B0002ARAFI',
    productName: 'Zupreem Natural Bird Food Pellets',
    price: 16.99
  },
  'endive': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'omega-3 capsules': {
    asin: 'B004OA5XP4',
    productName: 'Nordic Naturals Omega-3 Pet',
    price: 29.99
  },
  'amaranth (tiny amounts)': {
    asin: 'B00028QE9C',
    productName: "Bob's Red Mill Amaranth Grain",
    price: 8.49
  },
  'amaranth seeds': {
    asin: 'B00028QE9C',
    productName: "Bob's Red Mill Amaranth Grain",
    price: 8.49
  },
  'salmon oil': {
    asin: 'B01N9SSTG8',
    productName: 'Zesty Paws Wild Alaskan Salmon Oil',
    price: 21.99
  },
  'omega-3 oil': {
    asin: 'B01N9SSTG8',
    productName: 'Zesty Paws Wild Alaskan Salmon Oil',
    price: 21.99
  },
  'joint health powder': {
    asin: 'B0002APQY2',
    productName: 'Cosequin DS Joint Health Supplement',
    price: 29.99
  },
  'pumpkin puree': {
    asin: 'B000HDCSTG',
    productName: "Farmer's Market Organic Pumpkin Puree",
    price: 4.99
  },
  'sardines (canned in water)': {
    asin: 'B001EO5QW8',
    productName: 'Wild Planet Wild Sardines in Water',
    price: 4.49
  },
  'duck breast': {
    asin: 'B0BXZ3JJL9',
    productName: 'Fresh Is Best Freeze-Dried Duck',
    price: 24.99
  },
  'beet greens': {
    asin: 'B07MGZKB9V',
    productName: "Dr. Harvey's Veg-to-Bowl",
    price: 16.99
  },
  'herring (canned)': {
    asin: 'B001EO5QRM',
    productName: 'Wild Planet Wild Herring in Water',
    price: 5.99
  },
  'sardines (in water)': {
    asin: 'B001EO5QW8',
    productName: 'Wild Planet Wild Sardines in Water',
    price: 4.49
  },
  'safflower seeds': {
    asin: 'B001ODB3YE',
    productName: "Wagner's Safflower Seeds",
    price: 13.99
  },
  'wild bird mix': {
    asin: 'B001ODB3YE',
    productName: 'Kaytee Wild Bird Food Mix',
    price: 16.99
  },
  'avocado oil': {
    asin: 'B00KN93TJU',
    productName: 'Chosen Foods Avocado Oil',
    price: 12.99
  },
  'avocado oil (tiny amounts)': {
    asin: 'B00KN93TJU',
    productName: 'Chosen Foods Avocado Oil',
    price: 12.99
  },
  's-adenosyl methionine (sam-e)': {
    asin: 'B0002APQVQ',
    productName: 'Nutramax Denamarin (contains SAM-e)',
    price: 29.99
  },
  'canary seed': {
    asin: 'B001ODB3YE',
    productName: 'Kaytee Wild Bird Food Mix',
    price: 16.99
  },
  'flaxseeds': {
    asin: 'B00JL2X39O',
    productName: 'Viva Naturals Organic Flaxseeds',
    price: 8.99
  },
  'quinoa (cooked)': {
    asin: 'B000EDG598',
    productName: "Bob's Red Mill Organic Quinoa",
    price: 12.49
  },
  'rapeseed': {
    asin: 'B001ODB3YE',
    productName: 'Kaytee Wild Bird Food Mix',
    price: 16.99
  },
  'sunflower seeds (small amounts)': {
    asin: 'B07ZXF9876',
    productName: 'Bulk Sunflower Seeds',
    price: 10.99
  },
  'pumpkin seeds': {
    asin: 'B00JL2X2KW',
    productName: 'Viva Naturals Pumpkin Seeds',
    price: 9.99
  },
  'cuttlebone': {
    asin: 'B0002AR0I2',
    productName: 'Prevue Pet Products Cuttlebone 3-Pack',
    price: 5.99
  },
  'barley hay': {
    asin: 'B07ZYNJ123',
    productName: 'Small Pet Select Barley Hay',
    price: 18.99
  },
  'd-mannose': {
    asin: 'B07FC4ZY34',
    productName: 'Doggy Naturals Cranberry D-Mannose',
    price: 19.99
  },
  'fish oil': {
    asin: 'B01N9SSTG8',
    productName: 'Zesty Paws Wild Alaskan Salmon Oil',
    price: 21.99
  },
  'herring oil': {
    asin: 'B01N9SSTG8',
    productName: 'Zesty Paws Wild Alaskan Salmon Oil',
    price: 21.99
  },
  'apricots (pitted)': {
    asin: 'B00ZYXAB123',  // Dried apricots (no sugar)
    productName: 'Organic Dried Apricots (Unsweetened)',
    price: 11.99
  },
  'ground herring': {
    asin: 'B001EO5QRM',
    productName: 'Wild Planet Wild Herring in Water',
    price: 5.99
  },
  'electrolyte powder': {
    asin: 'B07X6LNK99',
    productName: 'Pet Electrolyte Powder',
    price: 14.99
  },
  'ground lamb': {
    asin: 'B0082C00P8',
    productName: 'Raw Paws Ground Lamb',
    price: 22.99
  },
  'rabbit meat': {
    asin: 'B07ZYNJ456',  // Freeze-dried rabbit
    productName: 'Fresh Is Best Freeze-Dried Rabbit',
    price: 27.99
  },
  'quercetin': {
    asin: 'B0742YS3TG',
    productName: 'Quercetin for Dogs',
    price: 19.99
  },
  'blueberries': {
    asin: 'B00ZYXB789',  // Freeze-dried blueberries
    productName: 'Freeze-Dried Blueberries for Pets',
    price: 13.99
  },
  'meadow hay': {
    asin: 'B001ODB40G',
    productName: 'Oxbow Meadow Hay',
    price: 16.99
  },
  'guinea pig pellets (with vitamin c)': {
    asin: 'B001ODB40U',
    productName: 'Oxbow Essentials Adult Guinea Pig Food',
    price: 12.99
  }
};

// ============================================================================
// SIMPLE REPLACEMENT FUNCTION
// ============================================================================

function replaceInFile(inputFile, outputFile) {
  console.log('üìñ Reading file...');
  let content = fs.readFileSync(inputFile, 'utf-8');
  
  let replacedCount = 0;
  
  console.log('\nüîß Replacing prices and ASINs...\n');
  
  for (const [key, data] of Object.entries(REPLACEMENTS)) {
    const keyPattern = `'${key}'`;
    
    if (content.includes(keyPattern)) {
      console.log(`‚úÖ Replacing: ${key} ($${data.price})`);
      
      // Find the ingredient block
      const blockStart = content.indexOf(keyPattern);
      if (blockStart === -1) continue;
      
      // Find the closing brace of this ingredient
      let braceCount = 0;
      let i = content.indexOf('{', blockStart);
      let blockEnd = i;
      
      while (i < content.length && (braceCount > 0 || i === content.indexOf('{', blockStart))) {
        if (content[i] === '{') braceCount++;
        if (content[i] === '}') braceCount--;
        if (braceCount === 0 && i !== content.indexOf('{', blockStart)) {
          blockEnd = i;
          break;
        }
        i++;
      }
      
      // Extract the block
      const oldBlock = content.substring(blockStart, blockEnd + 1);
      
      // Build new block
      const newBlock = `'${key}': {
    productName: '${data.productName}',
    ${data.asin ? `amazonLink: 'https://www.amazon.com/dp/${data.asin}?tag=robinfrench-20',
    asinLink: 'https://www.amazon.com/dp/${data.asin}?tag=robinfrench-20',` : `amazonLink: null,
    asinLink: null,`}
    price: {
      amount: ${data.price.toFixed(2)},
      currency: 'USD'
    },
    vetNote: 'Budget-friendly alternative - updated automatically',
    category: 'Food',
    commissionRate: 0.03
  }`;
      
      // Replace
      content = content.replace(oldBlock, newBlock);
      replacedCount++;
    }
  }
  
  console.log(`\nüíæ Writing to: ${outputFile}`);
  fs.writeFileSync(outputFile, content);
  
  console.log(`\n‚úÖ Done! Replaced ${replacedCount} items.`);
  console.log(`üí∞ Total savings: ~$${(replacedCount * 25).toFixed(0)}/shopping cart`);
}

// ============================================================================
// RUN IT
// ============================================================================

const INPUT_FILE = './lib/data/vetted-products.txt';
const OUTPUT_FILE = './lib/data/vetted-products-FIXED.txt';

try {
  replaceInFile(INPUT_FILE, OUTPUT_FILE);
} catch (error) {
  console.error('‚ùå ERROR:', error.message);
  process.exit(1);
}
</file>

<file path="scripts/maintenance/update-contribution.ts">
const fs = require('fs');
const path = require('path');

const generatorPath = path.join(__dirname, 'lib', 'recipe-generator.ts');
let content = fs.readFileSync(generatorPath, 'utf-8');

// Update the contribution object in GeneratedRecipe interface
content = content.replace(
  /contribution: \{\s*protein: number;\s*fat: number;\s*calories: number;\s*\};/,
  `contribution: {
      protein: number;
      fat: number;
      calories: number;
      fiber?: number;
      calcium?: number;
      phosphorus?: number;
    };`
);

fs.writeFileSync(generatorPath, content);
console.log('‚úÖ Updated contribution object type');
</file>

<file path="scripts/maintenance/update-prices-asins.cjs">
const fs = require('fs');
const axios = require('axios');
const cheerio = require('cheerio');

/**
 * AUTOMATED PRICE & ASIN UPDATER
 *
 * This script will:
 * 1. Read your vetted-products file
 * 2. Search Amazon for each product by name
 * 3. Extract the correct ASIN and price
 * 4. Generate a new file with all prices and proper ASINs
 */

/**
 * @typedef {Object} VettedProduct
 * @property {string} productName
 * @property {string} amazonLink
 * @property {string} [asinLink]
 * @property {string} [chewyLink]
 * @property {Object} [price]
 * @property {number} price.amount
 * @property {string} price.currency
 * @property {string} vetNote
 * @property {string} [category]
 * @property {number} [commissionRate]
 * @property {number} [researchScore]
 */

/**
 * @typedef {Object} ProductSearchResult
 * @property {string} asin
 * @property {string} title
 * @property {number|null} price
 * @property {string} link
 * @property {number} matchScore
 */

/**
 * @typedef {Object} UpdateResult
 * @property {string} ingredient
 * @property {string} oldLink
 * @property {string} newASIN
 * @property {string} newLink
 * @property {number|null} price
 * @property {'success'|'failed'|'skipped'} status
 * @property {string} [reason]
 */

// ============================================================================
// STEP 1: Parse your vetted products file
// ============================================================================

function parseVettedProductsFile(filePath) {
  const content = fs.readFileSync(filePath, 'utf-8');

  // Try to extract the exported object
  // Look for pattern: export const VETTED_PRODUCTS = { ... }
  const match = content.match(/export\s+const\s+VETTED_PRODUCTS[\s\S]*?=\s*({[\s\S]+});?\s*$/m);

  if (!match) {
    console.log('No regex match found for VETTED_PRODUCTS export');
    throw new Error('Could not parse vetted products file. Make sure it exports a const object.');
  }
  console.log('Found VETTED_PRODUCTS export, length:', match[1].length);

  // This is a simplified parser - for production, use a proper JS parser
  // For now, we'll manually extract ingredient keys and product data
  const products = {};

  // Match each ingredient entry: 'ingredient-name': { ... }
  const ingredientRegex = /'([^']+)':\s*{([^}]+)}/gs;
  let ingredientMatch;
  let ingredientCount = 0;

  while ((ingredientMatch = ingredientRegex.exec(content)) !== null) {
    const ingredient = ingredientMatch[1];
    const productBlock = ingredientMatch[2];
    ingredientCount++;

    // Extract fields using regex
    const productNameMatch = productBlock.match(/productName:\s*'([^']+)'/);
    const amazonLinkMatch = productBlock.match(/amazonLink:\s*'([^']+)'/);
    const vetNoteMatch = productBlock.match(/vetNote:\s*'([^']+)'/);
    const categoryMatch = productBlock.match(/category:\s*'([^']+)'/);

    products[ingredient] = {
      productName: productNameMatch ? productNameMatch[1] : '',
      amazonLink: amazonLinkMatch ? amazonLinkMatch[1] : '',
      vetNote: vetNoteMatch ? vetNoteMatch[1] : '',
      category: categoryMatch ? categoryMatch[1] : undefined,
    };
  }

  console.log(`Parsed ${ingredientCount} ingredients into products object`);
  return products;
}

// ============================================================================
// STEP 2: Search Amazon for product
// ============================================================================

async function searchAmazonProduct(productName) {
  try {
    console.log(`  üîç Searching Amazon for: "${productName}"`);

    // Search in pet-supplies department
    const searchUrl = `https://www.amazon.com/s?k=${encodeURIComponent(productName)}&i=pet-supplies`;

    const response = await axios.get(searchUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'keep-alive',
      },
      timeout: 15000
    });

    const $ = cheerio.load(response.data);

    // Find the first valid product
    let bestMatch = null;
    let highestScore = 0;

    $('[data-component-type="s-search-result"]').each((i, element) => {
      if (i >= 5) return false; // Only check top 5 results

      const asin = $(element).attr('data-asin');
      if (!asin) return;

      const title = $(element).find('h2 span.a-text-normal').text().trim();
      const priceWhole = $(element).find('.a-price-whole').first().text().trim();
      const priceFraction = $(element).find('.a-price-fraction').first().text().trim();

      if (!title) return;

      // Calculate match score
      const score = calculateMatchScore(productName, title);

      // Parse price
      let price = null;
      if (priceWhole) {
        const priceStr = priceWhole.replace(/[^0-9.]/g, '') + (priceFraction || '');
        price = parseFloat(priceStr) || null;
      }

      const result = {
        asin,
        title,
        price,
        link: `https://www.amazon.com/dp/${asin}?tag=robinfrench-20`,
        matchScore: score
      };

      if (score > highestScore) {
        highestScore = score;
        bestMatch = result;
      }
    });

    if (bestMatch) {
      console.log(`  ‚úÖ Found: ${bestMatch.title} (ASIN: ${bestMatch.asin}, Price: $${bestMatch.price?.toFixed(2) || 'N/A'})`);
      console.log(`  üìä Match score: ${bestMatch.matchScore}/100`);
    } else {
      console.log(`  ‚ùå No results found`);
    }

    return bestMatch;

  } catch (error) {
    console.error(`  ‚ùå Search failed: ${error.message}`);
    return null;
  }
}

// ============================================================================
// STEP 3: Get price from product page (fallback if search didn't work)
// ============================================================================

async function getPriceFromProductPage(asin) {
  try {
    const url = `https://www.amazon.com/dp/${asin}`;

    const response = await axios.get(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
      },
      timeout: 15000
    });

    const $ = cheerio.load(response.data);

    // Try multiple price selectors
    const priceSelectors = [
      '.a-price.a-text-price .a-offscreen',
      '#priceblock_ourprice',
      '#priceblock_dealprice',
      '.a-price .a-offscreen',
      '#price_inside_buybox',
    ];

    for (const selector of priceSelectors) {
      const priceText = $(selector).first().text().trim();
      if (priceText) {
        const priceMatch = priceText.match(/[\d,]+\.?\d*/);
        if (priceMatch) {
          const price = parseFloat(priceMatch[0].replace(/,/g, ''));
          if (!isNaN(price) && price > 0) {
            return price;
          }
        }
      }
    }

    return null;
  } catch (error) {
    return null;
  }
}

// ============================================================================
// STEP 4: Calculate match score
// ============================================================================

function calculateMatchScore(productName, searchResultTitle) {
  let score = 0;
  const nameLower = productName.toLowerCase();
  const titleLower = searchResultTitle.toLowerCase();

  // Extract key words from product name
  const keyWords = nameLower
    .replace(/freeze dried|freeze-dried/gi, '')
    .split(/\s+/)
    .filter(w => w.length > 2 && !['the', 'for', 'and', 'with'].includes(w));

  // Check if brand name matches (high weight)
  const brandMatch = keyWords[0];
  if (titleLower.includes(brandMatch)) {
    score += 40;
  }

  // Check for all key words
  const matchedWords = keyWords.filter(word => titleLower.includes(word));
  score += (matchedWords.length / keyWords.length) * 40;

  // Bonus for pet-specific
  if (titleLower.includes('dog') || titleLower.includes('cat') || titleLower.includes('pet')) {
    score += 10;
  }

  // Bonus for quality indicators
  if (titleLower.includes('freeze dried') || titleLower.includes('freeze-dried')) score += 5;
  if (titleLower.includes('human grade') || titleLower.includes('human-grade')) score += 3;
  if (titleLower.includes('organic')) score += 2;

  return Math.min(100, Math.round(score));
}

// ============================================================================
// STEP 5: Process all products
// ============================================================================

async function processAllProducts(products) {
  const results = [];
  const ingredients = Object.keys(products);

  console.log(`\nüöÄ Processing ${ingredients.length} products...\n`);

  for (let i = 0; i < ingredients.length; i++) {
    const ingredient = ingredients[i];
    const product = products[ingredient];

    console.log(`\n[${i + 1}/${ingredients.length}] ${ingredient}`);
    console.log(`  Current: ${product.productName}`);

    // Search for product
    const searchResult = await searchAmazonProduct(product.productName);

    if (!searchResult) {
      results.push({
        ingredient,
        oldLink: product.amazonLink,
        newASIN: 'NOT_FOUND',
        newLink: product.amazonLink,
        price: null,
        status: 'failed',
        reason: 'No search results found'
      });

      // Rate limiting
      await new Promise(resolve => setTimeout(resolve, 2000));
      continue;
    }

    // If search found a result but no price, try scraping product page
    let finalPrice = searchResult.price;
    if (!finalPrice) {
      console.log(`  üí∞ Fetching price from product page...`);
      finalPrice = await getPriceFromProductPage(searchResult.asin);
      if (finalPrice) {
        console.log(`  ‚úÖ Found price: $${finalPrice.toFixed(2)}`);
      }
    }

    results.push({
      ingredient,
      oldLink: product.amazonLink,
      newASIN: searchResult.asin,
      newLink: searchResult.link,
      price: finalPrice,
      status: 'success',
      reason: `Match score: ${searchResult.matchScore}/100`
    });

    // Rate limiting (important!)
    await new Promise(resolve => setTimeout(resolve, 3000));
  }

  return results;
}

// ============================================================================
// STEP 6: Generate updated file
// ============================================================================

function generateUpdatedFile(originalProducts, results) {
  let output = `// lib/data/vetted-products-UPDATED.ts
// AUTO-GENERATED with prices and correct ASINs
// Generated: ${new Date().toISOString()}

export const VETTED_PRODUCTS = {\n`;

  // Create a map of updates
  const updatesMap = new Map();
  results.forEach(r => updatesMap.set(r.ingredient, r));

  for (const [ingredient, product] of Object.entries(originalProducts)) {
    const update = updatesMap.get(ingredient);

    output += `  '${ingredient}': {\n`;
    output += `    productName: '${product.productName}',\n`;

    // Use updated ASIN if available
    if (update && update.status === 'success') {
      output += `    amazonLink: '${update.newLink}',\n`;
      output += `    asinLink: '${update.newLink}',\n`;

      // Add price if available
      if (update.price !== null) {
        output += `    price: {\n`;
        output += `      amount: ${update.price.toFixed(2)},\n`;
        output += `      currency: 'USD'\n`;
        output += `    },\n`;
      }
    } else {
      output += `    amazonLink: '${product.amazonLink}',\n`;
      output += `    asinLink: '${product.amazonLink}',\n`;
    }

    if (product.chewyLink) {
      output += `    chewyLink: '${product.chewyLink}',\n`;
    }

    output += `    vetNote: '${product.vetNote}',\n`;

    if (product.category) {
      output += `    category: '${product.category}',\n`;
    }

    if (product.commissionRate !== undefined) {
      output += `    commissionRate: ${product.commissionRate},\n`;
    }

    if (product.researchScore !== undefined) {
      output += `    researchScore: ${product.researchScore}\n`;
    }

    output += `  },\n`;
  }

  output += `};\n`;

  return output;
}

// ============================================================================
// STEP 7: Generate report
// ============================================================================

function generateReport(results) {
  const successful = results.filter(r => r.status === 'success');
  const failed = results.filter(r => r.status === 'failed');
  const withPrice = successful.filter(r => r.price !== null);
  const withoutPrice = successful.filter(r => r.price === null);

  let report = `# Price & ASIN Update Report
Generated: ${new Date().toLocaleString()}

## Summary
- Total Products: ${results.length}
- ‚úÖ Successfully Updated: ${successful.length}
- ‚ùå Failed: ${failed.length}
- üí∞ With Prices: ${withPrice.length}
- ‚ö†Ô∏è  Without Prices: ${withoutPrice.length}

## Successful Updates

`;

  withPrice.forEach((r, i) => {
    report += `### ${i + 1}. ${r.ingredient}
- **ASIN:** ${r.newASIN}
- **Price:** $${r.price?.toFixed(2)}
- **Reason:** ${r.reason}

`;
  });

  if (withoutPrice.length > 0) {
    report += `\n## Updated (No Price Found)\n\n`;
    withoutPrice.forEach((r, i) => {
      report += `### ${i + 1}. ${r.ingredient}
- **ASIN:** ${r.newASIN}
- **Reason:** ${r.reason}

`;
    });
  }

  if (failed.length > 0) {
    report += `\n## Failed Updates\n\n`;
    failed.forEach((r, i) => {
      report += `### ${i + 1}. ${r.ingredient}
- **Reason:** ${r.reason}

`;
    });
  }

  return report;
}

// ============================================================================
// MAIN EXECUTION
// ============================================================================

async function main() {
  const inputFile = 'lib/data/vetted-products.ts';
  const outputFile = 'lib/data/vetted-products-UPDATED.ts';
  const reportFile = 'PRICE-ASIN-UPDATE-REPORT.md';

  console.log('üöÄ AUTOMATED PRICE & ASIN UPDATER\n');
  console.log('‚îÅ'.repeat(60));
  console.log(`üìÅ Input:  ${inputFile}`);
  console.log(`üìÅ Output: ${outputFile}`);
  console.log(`üìÅ Report: ${reportFile}`);
  console.log('‚îÅ'.repeat(60));

  try {
    // Step 1: Parse input file
    console.log('\nüìñ Step 1: Reading vetted-products file...');
    const products = parseVettedProductsFile(inputFile);
    console.log('Products parsed:', typeof products, products === null ? 'null' : 'object');
    const count = Object.keys(products).length;
    console.log(`‚úÖ Found ${count} products\n`);

    if (count === 0) {
      console.log('‚ùå No products found in file. Check file format.');
      return;
    }

    // Step 2: Process products
    console.log('üîß Step 2: Searching Amazon and extracting prices...');
    console.log('‚ö†Ô∏è  This will take a while (rate limiting: 3s per product)');
    console.log(`‚è±Ô∏è  Estimated time: ${Math.ceil((count * 3) / 60)} minutes\n`);

    const results = await processAllProducts(products);

    // Step 3: Generate updated file
    console.log('\nüíæ Step 3: Generating updated file...');
    const updatedContent = generateUpdatedFile(products, results);
    fs.writeFileSync(outputFile, updatedContent);
    console.log(`‚úÖ Saved to: ${outputFile}`);

    // Step 4: Generate report
    console.log('\nüìä Step 4: Generating report...');
    const report = generateReport(results);
    fs.writeFileSync(reportFile, report);
    console.log(`‚úÖ Saved to: ${reportFile}`);

    // Summary
    const successful = results.filter(r => r.status === 'success').length;
    const withPrice = results.filter(r => r.status === 'success' && r.price !== null).length;

    console.log('\nüéâ DONE!\n');
    console.log('‚îÅ'.repeat(60));
    console.log(`‚úÖ Successfully updated: ${successful}/${count}`);
    console.log(`üí∞ Found prices for: ${withPrice}/${count}`);
    console.log('‚îÅ'.repeat(60));

  } catch (error) {
    console.error('\n‚ùå ERROR:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run it!
main();
</file>

<file path="scripts/maintenance/update-types.ts">
const fs = require('fs');
const path = require('path');

const typesPath = path.join(__dirname, 'lib', 'types.ts');
let content = fs.readFileSync(typesPath, 'utf-8');

// Replace the RecipeNutritionInfo interface
content = content.replace(
  /export interface RecipeNutritionInfo \{[\s\S]*?\}\n\n/,
  `export interface RecipeNutritionInfo {
  calories: number;
  protein: number;
  fat: number;
  carbs: number;
  fiber: number;
  moisture: number;
  calcium?: number;
  phosphorus?: number;
  caP_ratio?: string;
}

`
);

fs.writeFileSync(typesPath, content);
console.log('‚úÖ Updated RecipeNutritionInfo interface');
</file>

<file path="scripts/make-product-names-generic.ts">
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Convert all product names to generic versions like they appear in shopping lists
 */

interface VettedProduct {
  ingredient: string;
  productName: string;
  asin: string;
  amazonLink: string;
  vetNote: string;
  category?: string;
}

interface GenericNameMapping {
  ingredient: string;
  currentProductName: string;
  newProductName: string;
  reason: string;
}

// ============================================================================
// GENERIC NAME MAPPINGS
// ============================================================================

function generateGenericName(ingredient: string, currentProductName: string): string {
  const ingredientLower = ingredient.toLowerCase();

  // Quality indicators to preserve
  const qualityIndicators = [];
  const productLower = currentProductName.toLowerCase();

  if (productLower.includes('organic')) qualityIndicators.push('Organic');
  if (productLower.includes('grass fed') || productLower.includes('grass-fed')) qualityIndicators.push('Grass-Fed');
  if (productLower.includes('free range') || productLower.includes('free-range')) qualityIndicators.push('Free Range');
  if (productLower.includes('wild caught') || productLower.includes('wild-caught')) qualityIndicators.push('Wild Caught');
  if (productLower.includes('human grade') || productLower.includes('human-grade')) qualityIndicators.push('Human Grade');
  if (productLower.includes('freeze dried') || productLower.includes('freeze-dried')) qualityIndicators.push('Freeze Dried');
  if (productLower.includes('grain free') || productLower.includes('grain-free')) qualityIndicators.push('Grain Free');
  if (productLower.includes('raw')) qualityIndicators.push('Raw');

  // Size indicators to preserve
  const sizeIndicators = [];
  if (productLower.includes('bulk')) sizeIndicators.push('Bulk');
  if (productLower.includes('family size') || productLower.includes('family pack')) sizeIndicators.push('Family Size');

  // Start with the ingredient name
  let genericName = ingredient.charAt(0).toUpperCase() + ingredient.slice(1);

  // Add quality indicators
  if (qualityIndicators.length > 0) {
    genericName += ` (${qualityIndicators.join(', ')})`;
  }

  // Add size indicators
  if (sizeIndicators.length > 0) {
    genericName += ` - ${sizeIndicators.join(' ')}`;
  }

  return genericName;
}

// ============================================================================
// PARSE VETTED PRODUCTS
// ============================================================================

function parseVettedProducts(filePath: string): VettedProduct[] {
  const content = fs.readFileSync(filePath, 'utf-8');
  const products: VettedProduct[] = [];

  // Match entries like: 'ground beef (lean)': {
  const lines = content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);

    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];

      // Extract the object block
      let block = '';
      let braceCount = 1;
      let j = i + 1;

      while (j < lines.length && braceCount > 0) {
        block += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }

      // Extract fields
      const productNameMatch = block.match(/productName:\s*'([^']+)'/);
      const amazonLinkMatch = block.match(/(amazonLink|asinLink):\s*'([^']+)'/);
      const asinMatch = block.match(/\/dp\/([A-Z0-9]{10})/);
      const vetNoteMatch = block.match(/vetNote:\s*'([^']+)'/);
      const categoryMatch = block.match(/category:\s*'([^']+)'/);

      if (productNameMatch && amazonLinkMatch) {
        products.push({
          ingredient,
          productName: productNameMatch[1],
          asin: asinMatch ? asinMatch[1] : 'UNKNOWN',
          amazonLink: amazonLinkMatch[2],
          vetNote: vetNoteMatch ? vetNoteMatch[1] : '',
          category: categoryMatch ? categoryMatch[1] : undefined
        });
      }
    }
  }

  return products;
}

// ============================================================================
// GENERATE GENERIC NAMES
// ============================================================================

function generateGenericMappings(products: VettedProduct[]): GenericNameMapping[] {
  return products.map(product => ({
    ingredient: product.ingredient,
    currentProductName: product.productName,
    newProductName: generateGenericName(product.ingredient, product.productName),
    reason: 'Converted to generic shopping list format'
  }));
}

// ============================================================================
// APPLY CHANGES TO FILE
// ============================================================================

function applyGenericNames(filePath: string, mappings: GenericNameMapping[]): string {
  let content = fs.readFileSync(filePath, 'utf-8');

  for (const mapping of mappings) {
    // Escape special regex characters
    const escapedCurrent = mapping.currentProductName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const escapedNew = mapping.newProductName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // Replace the productName
    const productNameRegex = new RegExp(`productName:\\s*'${escapedCurrent}'`, 'g');
    const escapedNewName = mapping.newProductName.replace(/'/g, "\\'");
    content = content.replace(productNameRegex, `productName: '${escapedNewName}'`);
  }

  return content;
}

// ============================================================================
// GENERATE REPORT
// ============================================================================

function generateReport(mappings: GenericNameMapping[]): string {
  let report = `# Generic Product Names Report
Generated: ${new Date().toLocaleString()}
Total Changes: ${mappings.length}

This report shows the conversion of specific brand/product names to generic shopping list format.

## Changes Made

`;

  mappings.forEach((mapping, i) => {
    report += `### ${i + 1}. ${mapping.ingredient}
**BEFORE:** ${mapping.currentProductName}
**AFTER:** ${mapping.newProductName}
**Reason:** ${mapping.reason}

---
`;
  });

  report += `

## Examples of Generic Names

- "365 By Whole Foods Market, Organic Ground Chicken, Step 3, 16 Ounce" ‚Üí "Ground Chicken (Organic)"
- "Butterball Fresh All Natural 85%/15% Lean Ground Turkey, 16 oz" ‚Üí "Ground Turkey"
- "Purina ONE Classic Ground Chicken and Brown Rice Entree Adult Wet Dog Food" ‚Üí "Ground Chicken"

## Benefits

1. **Consistent Display**: Matches shopping list ingredient names
2. **User-Friendly**: Generic names are easier to read
3. **Brand Neutral**: Focuses on ingredients, not specific brands
4. **Flexible**: Users can still see detailed product info on Amazon
`;

  return report;
}

// ============================================================================
// MAIN
// ============================================================================

async function main() {
  const inputFile = path.join(__dirname, '../lib/data/vetted-products.ts');
  const outputFile = path.join(__dirname, '../lib/data/vetted-products-generic.ts');
  const reportFile = path.join(__dirname, '../GENERIC-NAMES-REPORT.md');

  console.log('üîÑ GENERIC PRODUCT NAMES CONVERSION');
  console.log('‚îÅ'.repeat(50));
  console.log(`üìÅ Input:  ${inputFile}`);
  console.log(`üìÅ Output: ${outputFile}`);
  console.log(`üìÅ Report: ${reportFile}`);
  console.log('‚îÅ'.repeat(50));

  try {
    // Parse products
    console.log('\nüìñ Reading vetted-products.txt...');
    const products = parseVettedProducts(inputFile);
    console.log(`‚úÖ Found ${products.length} products`);

    // Generate mappings
    console.log('\nüîÑ Generating generic name mappings...');
    const mappings = generateGenericMappings(products);
    console.log(`‚úÖ Created ${mappings.length} mappings`);

    // Show sample changes
    console.log('\nüìã Sample Changes:');
    mappings.slice(0, 5).forEach((m, i) => {
      console.log(`${i + 1}. ${m.ingredient}:`);
      console.log(`   "${m.currentProductName}"`);
      console.log(`   ‚Üí "${m.newProductName}"`);
      console.log('');
    });

    // Apply changes
    console.log('üíæ Applying changes to file...');
    const updatedContent = applyGenericNames(inputFile, mappings);
    fs.writeFileSync(outputFile, updatedContent);

    // Generate report
    console.log('üìä Generating report...');
    const report = generateReport(mappings);
    fs.writeFileSync(reportFile, report);

    console.log('\n‚úÖ SUCCESS!');
    console.log(`üìÑ Updated file: ${outputFile}`);
    console.log(`üìä Report: ${reportFile}`);
    console.log(`\nüéØ Converted ${mappings.length} product names to generic format`);

  } catch (error: any) {
    console.error('\n‚ùå ERROR:', error.message);
    process.exit(1);
  }
}

main();
</file>

<file path="scripts/process-scraped-data.js">
// scripts/process-scraped-data.js
// Processes scraped results and populates global ingredient pool

const fs = require('fs');
const path = require('path');

/**
 * Normalize ingredient name to ID format
 */
function normalizeIngredientName(name) {
  if (!name || typeof name !== 'string') return null;
  
  return name.toLowerCase()
    .replace(/[^a-z0-9\s]/g, '') // Remove special chars
    .replace(/\s+/g, '_') // Spaces to underscores
    .replace(/_+/g, '_') // Multiple underscores to single
    .replace(/^_|_$/g, '') // Trim underscores
    .trim();
}

/**
 * Detect ingredient category
 */
function detectCategory(name, speciesCategory) {
  if (!name) return 'other';
  
  const lower = name.toLowerCase();
  
  // Protein detection
  if (lower.match(/\b(chicken|turkey|beef|lamb|fish|salmon|tuna|meat|protein|pork|duck|organ|heart|liver|kidney)\b/)) {
    return 'protein';
  }
  
  // Insect detection
  if (lower.match(/\b(cricket|mealworm|roach|dubia|insect|superworm|hornworm|silkworm|waxworm|phoenix|black.*soldier.*fly)\b/)) {
    return 'insect';
  }
  
  // Vegetable detection
  if (lower.match(/\b(carrot|broccoli|spinach|kale|lettuce|pepper|squash|vegetable|green|collard|mustard|turnip|dandelion|arugula|endive|escarole|bok.*choy|cabbage|celery|asparagus|fennel|parsley|cilantro|basil|mint|thyme|oregano|sage|rosemary|zucchini|cucumber|eggplant|leek|shallot|radicchio|frisee|mache|watercress|purslane|swiss.*chard|beet.*green)\b/)) {
    return 'vegetable';
  }
  
  // Fruit detection
  if (lower.match(/\b(apple|berry|mango|papaya|banana|fruit|grape|melon|cantaloupe|honeydew|watermelon|pineapple|kiwi|raspberry|blackberry|cranberry|cherry|pear|peach|plum|apricot|fig|date|raisin|currant|goji|mulberry|elderberry|strawberry|blueberry)\b/)) {
    return 'fruit';
  }
  
  // Grain/Seed detection
  if (lower.match(/\b(rice|oats|quinoa|barley|wheat|grain|seed|millet|canary|niger|hemp|flax|chia|sesame|sunflower|pumpkin|safflower|nyjer|amaranth|buckwheat|teff|rapeseed|poppy|corn|maize|groat)\b/)) {
    return 'grain';
  }
  
  // Hay detection
  if (lower.match(/\b(hay|timothy|alfalfa|grass|meadow|orchard|bermuda|bluegrass|fescue|ryegrass|straw|dried.*grass)\b/)) {
    return 'hay';
  }
  
  // Supplement detection
  if (lower.match(/\b(supplement|vitamin|calcium|taurine|pellet|fortified|cuttlebone|grit|probiotic|enzyme|glucosamine|chondroitin|omega|epa|dha|antioxidant|spirulina|kelp|brewer.*yeast|electrolyte|amino.*acid|joint.*health|vitamin.*c|vitamin.*d|vitamin.*a)\b/)) {
    return 'supplement';
  }
  
  return 'other';
}

/**
 * Map species category to normalized species
 */
function normalizeSpeciesCategory(category) {
  if (!category) return 'unknown';
  
  const lower = category.toLowerCase();
  
  if (lower.includes('bird') || lower.includes('avian')) return 'bird';
  if (lower.includes('reptile') || lower.includes('herpetology')) return 'reptile';
  if (lower.includes('pocket') || lower.includes('rabbit') || lower.includes('guinea') || lower.includes('hamster') || lower.includes('ferret') || lower.includes('chinchilla')) return 'pocket-pet';
  if (lower.includes('dog')) return 'dog';
  if (lower.includes('cat')) return 'cat';
  if (lower.includes('dogs-cats')) return 'dogs-cats';
  
  return 'unknown';
}

/**
 * Process a single scrape result file
 */
function processScrapeFile(filePath) {
  try {
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const data = JSON.parse(fileContent);
    const ingredients = new Map();
    
    // Handle different file structures
    let results = [];
    if (Array.isArray(data)) {
      results = data;
    } else if (data.results && Array.isArray(data.results)) {
      results = data.results;
    } else if (data.ingredients && Array.isArray(data.ingredients)) {
      // Single result object
      results = [data];
    }
    
    results.forEach(result => {
      const category = normalizeSpeciesCategory(result.category || result.type);
      const source = result.source || result.url || filePath;
      
      // Extract ingredients
      const ingList = result.ingredients || [];
      if (!Array.isArray(ingList)) return;
      
      ingList.forEach(ing => {
        if (!ing || typeof ing !== 'string') return;
        
        const normalized = normalizeIngredientName(ing);
        if (!normalized || normalized.length < 2) return;
        
        if (!ingredients.has(normalized)) {
          ingredients.set(normalized, {
            name: ing,
            normalized,
            sources: new Set(),
            categories: new Set(),
            species: new Set(),
            scrapedCount: 0
          });
        }
        
        const entry = ingredients.get(normalized);
        entry.sources.add(source);
        entry.categories.add(detectCategory(ing, category));
        entry.species.add(category);
        entry.scrapedCount++;
      });
    });
    
    return ingredients;
  } catch (error) {
    console.error(`Error processing ${filePath}:`, error.message);
    return new Map();
  }
}

/**
 * Main processing function
 */
async function processScrapedData() {
  console.log('üîÑ Processing scraped data...\n');
  
  const resultsDir = path.join(__dirname, '../scraping/results');
  
  // Get all JSON files
  const files = fs.readdirSync(resultsDir);
  const jsonFiles = files.filter(f => f.endsWith('.json') && !f.includes('test'));
  
  console.log(`üìÅ Found ${jsonFiles.length} result files\n`);
  
  // Process all files
  const allIngredients = new Map();
  
  for (const file of jsonFiles) {
    const filePath = path.join(resultsDir, file);
    console.log(`  Processing: ${file}...`);
    
    const fileIngredients = processScrapeFile(filePath);
    
    // Merge into main map
    fileIngredients.forEach((data, normalized) => {
      if (!allIngredients.has(normalized)) {
        allIngredients.set(normalized, {
          name: data.name,
          normalized,
          sources: new Set(data.sources),
          categories: new Set(data.categories),
          species: new Set(data.species),
          scrapedCount: data.scrapedCount
        });
      } else {
        const existing = allIngredients.get(normalized);
        data.sources.forEach(s => existing.sources.add(s));
        data.categories.forEach(c => existing.categories.add(c));
        data.species.forEach(s => existing.species.add(s));
        existing.scrapedCount += data.scrapedCount;
      }
    });
  }
  
  console.log(`\n‚úÖ Processed ${allIngredients.size} unique ingredients\n`);
  
  // Convert to global ingredients format
  const globalIngredients = {};
  
  allIngredients.forEach((data, normalized) => {
    const primaryCategory = Array.from(data.categories)[0] || 'other';
    const confidenceLevel = 
      data.scrapedCount > 5 ? 'high' :
      data.scrapedCount > 2 ? 'medium' : 'low';
    
    globalIngredients[normalized] = {
      id: normalized,
      displayName: data.name,
      category: primaryCategory,
      commonNames: [data.name],
      confidenceLevel,
      lastScraped: new Date().toISOString(),
      sources: Array.from(data.sources).slice(0, 10), // Limit to 10 sources
      scrapedCount: data.scrapedCount
    };
  });
  
  // Save to global ingredients file
  const outputPath = path.join(__dirname, '../lib/data/globalIngredients.json');
  fs.writeFileSync(outputPath, JSON.stringify(globalIngredients, null, 2), 'utf8');
  
  // Generate summary
  const summary = {
    totalIngredients: Object.keys(globalIngredients).length,
    byCategory: {},
    byConfidence: {},
    bySpecies: {}
  };
  
  Object.values(globalIngredients).forEach(ing => {
    summary.byCategory[ing.category] = (summary.byCategory[ing.category] || 0) + 1;
    summary.byConfidence[ing.confidenceLevel] = (summary.byConfidence[ing.confidenceLevel] || 0) + 1;
  });
  
  console.log('üìä Summary:');
  console.log(`  Total ingredients: ${summary.totalIngredients}`);
  console.log(`  By category:`, summary.byCategory);
  console.log(`  By confidence:`, summary.byConfidence);
  console.log(`\nüìÅ Saved to: ${outputPath}`);
  
  return globalIngredients;
}

// Run if called directly
if (require.main === module) {
  processScrapedData()
    .then(() => {
      console.log('\n‚úÖ Processing complete!');
      process.exit(0);
    })
    .catch(error => {
      console.error('\n‚ùå Error:', error);
      process.exit(1);
    });
}

module.exports = { processScrapedData, normalizeIngredientName, detectCategory };
</file>

<file path="scripts/rank-product-prices.js">
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const pricesPath = path.join(root, 'data', 'product-prices.json');

function formatUsd(n) {
  return `$${n.toFixed(2)}`;
}

function csvEscape(v) {
  const s = String(v ?? '');
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

function main() {
  const raw = fs.readFileSync(pricesPath, 'utf8');
  const rows = JSON.parse(raw);

  const ranked = rows
    .map((r) => {
      const amount = Number(r?.price?.amount);
      return {
        ingredient: r?.ingredient,
        asin: r?.asin,
        url: r?.url,
        amount: Number.isFinite(amount) ? amount : 0,
        lastUpdated: r?.price?.lastUpdated,
      };
    })
    .filter((r) => r.ingredient && r.amount > 0)
    .sort((a, b) => b.amount - a.amount);

  // Console output (top N)
  const topN = 200;
  console.log(`=== Product Prices Ranked (Top ${Math.min(topN, ranked.length)} of ${ranked.length}) ===`);
  ranked.slice(0, topN).forEach((r, idx) => {
    console.log(`${String(idx + 1).padStart(4, ' ')}. ${formatUsd(r.amount).padStart(8, ' ')}  ${r.ingredient}`);
  });

  // Write full artifacts
  const outJson = path.join(root, 'data', 'price-rankings.json');
  const outCsv = path.join(root, 'data', 'price-rankings.csv');

  fs.writeFileSync(outJson, JSON.stringify({ generatedAt: new Date().toISOString(), ranked }, null, 2));

  const header = ['rank', 'ingredient', 'amount_usd', 'asin', 'url', 'lastUpdated'];
  const csvLines = [header.join(',')];
  ranked.forEach((r, i) => {
    csvLines.push(
      [
        i + 1,
        csvEscape(r.ingredient),
        r.amount.toFixed(2),
        csvEscape(r.asin),
        csvEscape(r.url),
        csvEscape(r.lastUpdated),
      ].join(',')
    );
  });
  fs.writeFileSync(outCsv, csvLines.join('\n'));

  console.log(`\nWrote:`);
  console.log(`- ${outJson}`);
  console.log(`- ${outCsv}`);
}

main();
</file>

<file path="scripts/regenerate-recipe-names.ts">
// scripts/regenerate-recipe-names.ts
// Migration script to regenerate all recipe names using the enhanced naming system

import { generateMealName } from '../lib/utils/mealNameGenerator';
import type { Recipe } from '../lib/types';
import * as fs from 'fs';
import * as path from 'path';

// Import recipes dynamically to avoid TypeScript compilation issues
const recipesModule = require('../lib/data/recipes-complete');
const recipes: Recipe[] = recipesModule.recipes;

/**
 * Extract ingredient keys from recipe ingredients
 */
function extractIngredientKeys(recipe: Recipe): string[] {
  return (recipe.ingredients || [])
    .map(ing => {
      // Handle different ingredient formats
      const name = typeof ing === 'string' ? ing : (ing as any).name;
      if (!name) return null;
      
      // Convert display name to key format (snake_case)
      // Try to match common ingredient name patterns
      let key = name
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
      
      // Handle common variations
      if (key.includes('ground')) {
        key = key.replace('ground_', 'ground_');
      }
      
      return key;
    })
    .filter((key): key is string => key !== null && key.length > 0);
}

/**
 * Calculate nutritional profile from recipe (if available)
 */
function getNutritionalProfile(recipe: Recipe): { protein?: number; fat?: number; fiber?: number } | undefined {
  // Try to extract from nutritionalInfo if available
  if ((recipe as any).nutritionalInfo) {
    const info = (recipe as any).nutritionalInfo;
    return {
      protein: info.protein?.min || info.protein?.max || undefined,
      fat: info.fat?.min || info.fat?.max || undefined,
      fiber: info.fiber?.min || info.fiber?.max || undefined,
    };
  }
  return undefined;
}

/**
 * Format recipe as JSON string with proper indentation
 */
function formatRecipe(recipe: Recipe, indent: string = '  '): string {
  return JSON.stringify(recipe, null, indent);
}

/**
 * Main migration function
 */
async function regenerateRecipeNames() {
  console.log('üîÑ Starting recipe name regeneration...\n');
  
  // Create backup
  const recipesFilePath = path.join(__dirname, '../lib/data/recipes-complete.ts');
  const backupPath = path.join(__dirname, '../lib/data/recipes-complete.backup.before-name-migration.ts');
  
  console.log('üì¶ Creating backup...');
  const originalContent = fs.readFileSync(recipesFilePath, 'utf-8');
  fs.writeFileSync(backupPath, originalContent);
  console.log(`‚úÖ Backup created: ${backupPath}\n`);
  
  let updated = 0;
  let skipped = 0;
  const updates: Array<{ id: string; oldName: string; newName: string; oldShortName?: string; newShortName?: string }> = [];
  const updatedRecipes: Recipe[] = [];
  
  // Process each recipe
  for (const recipe of recipes) {
    try {
      const ingredientKeys = extractIngredientKeys(recipe);
      
      if (ingredientKeys.length === 0) {
        console.log(`‚ö†Ô∏è  Skipping ${recipe.id}: No ingredients found`);
        skipped++;
        updatedRecipes.push(recipe); // Keep original
        continue;
      }
      
      // Determine pet species from category
      const petSpecies = recipe.category === 'dogs' ? 'dog' :
                         recipe.category === 'cats' ? 'cat' :
                         recipe.category === 'birds' ? 'bird' :
                         recipe.category === 'reptiles' ? 'reptile' :
                         recipe.category === 'pocket-pets' ? 'pocket-pet' : undefined;
      
      // Generate new name
      const nameResult = generateMealName(ingredientKeys, {
        petSpecies,
        healthConcerns: recipe.healthConcerns,
        nutritionalProfile: getNutritionalProfile(recipe),
        mealType: 'complete',
        recipeId: recipe.id,
        recipe: recipe as any,
        isCustomMeal: false,
      });
      
      const oldName = recipe.name;
      const newName = nameResult.fullName;
      const newShortName = nameResult.shortName;
      const oldShortName = (recipe as any).shortName;
      
      // Create updated recipe
      const updatedRecipe: Recipe = {
        ...recipe,
        name: newName,
      };
      
      if (newShortName) {
        (updatedRecipe as any).shortName = newShortName;
      }
      
      updatedRecipes.push(updatedRecipe);
      
      if (oldName !== newName) {
        updated++;
        updates.push({ 
          id: recipe.id, 
          oldName, 
          newName,
          oldShortName,
          newShortName 
        });
        console.log(`‚úÖ ${recipe.id}: "${oldName}" ‚Üí "${newName}"`);
      } else {
        console.log(`‚û°Ô∏è  ${recipe.id}: No change needed`);
      }
    } catch (error) {
      console.error(`‚ùå Error processing ${recipe.id}:`, error);
      skipped++;
      updatedRecipes.push(recipe); // Keep original on error
    }
  }
  
  // Update file content using string replacement
  console.log('\nüíæ Updating recipes file...');
  
  let fileContent = originalContent;
  
  // Replace each recipe name and shortName
  for (const update of updates) {
    // Escape special regex characters in recipe ID
    const escapedId = update.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
    // Replace name field - match: "id": "recipe-id", ... "name": "old-name",
    const namePattern = new RegExp(
      `("id":\\s*"${escapedId}"[\\s\\S]*?"name":\\s*")[^"]*(")`,
      'g'
    );
    fileContent = fileContent.replace(namePattern, `$1${update.newName.replace(/"/g, '\\"')}$2`);
    
    // Replace shortName if it exists
    if (update.newShortName) {
      const shortNamePattern = new RegExp(
        `("id":\\s*"${escapedId}"[\\s\\S]*?"shortName":\\s*")[^"]*(")`,
        'g'
      );
      
      if (shortNamePattern.test(fileContent)) {
        // Update existing shortName
        fileContent = fileContent.replace(shortNamePattern, `$1${update.newShortName.replace(/"/g, '\\"')}$2`);
      } else {
        // Add shortName after name field
        const nameWithShortPattern = new RegExp(
          `("id":\\s*"${escapedId}"[\\s\\S]*?"name":\\s*"[^"]*")`,
          'g'
        );
        fileContent = fileContent.replace(
          nameWithShortPattern,
          `$1,\n    "shortName": "${update.newShortName.replace(/"/g, '\\"')}"`
        );
      }
    }
  }
  
  // Update the auto-tagged timestamp comment
  const timestampPattern = /\/\/ Auto-tagged on: [^\n]+/;
  fileContent = fileContent.replace(
    timestampPattern,
    `// Auto-tagged on: ${new Date().toISOString()}\n// Names regenerated using enhanced naming system`
  );
  
  // Write updated content
  fs.writeFileSync(recipesFilePath, fileContent, 'utf-8');
  console.log('‚úÖ Updated recipes file written\n');
  
  // Summary
  console.log('='.repeat(60));
  console.log('üìä Migration Summary:');
  console.log(`   ‚úÖ Updated: ${updated} recipes`);
  console.log(`   ‚è≠Ô∏è  Skipped: ${skipped} recipes`);
  console.log(`   üì¶ Backup: ${backupPath}`);
  console.log('='.repeat(60));
  
  // Show sample updates
  if (updates.length > 0) {
    console.log('\nüìù Sample Updates:');
    updates.slice(0, 10).forEach(update => {
      console.log(`   ${update.id}:`);
      console.log(`      "${update.oldName}" ‚Üí "${update.newName}"`);
      if (update.oldShortName && update.newShortName) {
        console.log(`      Short: "${update.oldShortName}" ‚Üí "${update.newShortName}"`);
      }
    });
    if (updates.length > 10) {
      console.log(`   ... and ${updates.length - 10} more`);
    }
  }
  
  console.log('\n‚ú® Migration complete!');
}

// Run migration
regenerateRecipeNames().catch(error => {
  console.error('‚ùå Migration failed:', error);
  process.exit(1);
});
</file>

<file path="scripts/regenerate-recipes-cost-aware.ts">
#!/usr/bin/env node

/**
 * Regenerate all recipes with cost-aware optimization
 * Uses the updated recipe generator that prioritizes cost efficiency
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Import recipe generator and templates
import { generateBestRecipeForPet, TEMPLATE_LIBRARY } from '../lib/recipe-generator.js';
import { getProductPrice } from '../lib/data/product-prices.js';

const SPECIES_LIST = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
const RECIPES_PER_SPECIES = 50;

async function regenerateRecipes() {
  console.log('üîÑ Regenerating recipes with cost-aware optimization...\n');

  const jsonOutputPath = path.join(__dirname, '../lib/data/recipes-complete.json');
  const backupPath = path.join(__dirname, '../lib/data/recipes-complete.backup.json');

  // Backup existing recipes
  if (fs.existsSync(jsonOutputPath)) {
    console.log('üì¶ Backing up existing recipes...');
    fs.copyFileSync(jsonOutputPath, backupPath);
    console.log(`   ‚úì Backed up to: ${backupPath}\n`);
  }

  const allRecipes: any[] = [];
  const stats = {
    total: 0,
    success: 0,
    failed: 0,
    avgCostPerMeal: 0,
    totalCost: 0,
    costCount: 0,
    underBudget: 0,
    overBudget: 0,
  };

  for (const species of SPECIES_LIST) {
    console.log(`üìù Generating ${RECIPES_PER_SPECIES} recipes for ${species}...`);

    const speciesTemplates = TEMPLATE_LIBRARY.filter(t => t.category === species);
    if (speciesTemplates.length === 0) {
      console.log(`   ‚ö†Ô∏è No templates found for ${species}\n`);
      continue;
    }

    for (let i = 0; i < RECIPES_PER_SPECIES; i++) {
      try {
        // Rotate through templates
        const template = speciesTemplates[i % speciesTemplates.length];
        
        // Generate recipe (cost optimization is built in)
        const recipe = generateBestRecipeForPet([template], undefined, i);
        
        if (recipe) {
          // Calculate estimated cost for this recipe
          let estimatedCost = 0;
          for (const ing of recipe.ingredients) {
            const price = getProductPrice(ing.name.toLowerCase());
            if (typeof price === 'number') {
              estimatedCost += price;
            }
          }

          // Add cost info to recipe
          const recipeWithCost = {
            ...recipe,
            estimatedCostPerMeal: estimatedCost,
            exceedsBudget: estimatedCost > 4.50,
          };

          allRecipes.push(recipeWithCost);
          stats.success++;
          stats.totalCost += estimatedCost;
          stats.costCount++;

          if (estimatedCost <= 4.50) {
            stats.underBudget++;
          } else {
            stats.overBudget++;
          }
        } else {
          stats.failed++;
        }
      } catch (error) {
        console.error(`   ‚ùå Error generating recipe ${i + 1}:`, error);
        stats.failed++;
      }

      stats.total++;

      if ((i + 1) % 10 === 0) {
        console.log(`  ‚úì ${i + 1}/${RECIPES_PER_SPECIES} recipes`);
      }
    }

    const avgCost = stats.costCount > 0 ? stats.totalCost / stats.costCount : 0;
    console.log(`  ‚úÖ ${species}: ${stats.success} successful`);
    console.log(`     Average cost: $${avgCost.toFixed(2)}/meal`);
    console.log(`     Under budget: ${stats.underBudget}, Over budget: ${stats.overBudget}\n`);
  }

  // Save recipes
  console.log('üíæ Saving recipes to recipes-complete.json...');
  fs.writeFileSync(jsonOutputPath, JSON.stringify(allRecipes, null, 2));
  console.log(`‚úì Saved ${allRecipes.length} recipes\n`);

  // Print summary
  const avgCostPerMeal = stats.costCount > 0 ? stats.totalCost / stats.costCount : 0;
  console.log('üìä SUMMARY');
  console.log(`   Total recipes: ${stats.total}`);
  console.log(`   Successful: ${stats.success}`);
  console.log(`   Failed: ${stats.failed}`);
  console.log(`   Average cost per meal: $${avgCostPerMeal.toFixed(2)}`);
  console.log(`   Under $4.50 budget: ${stats.underBudget} (${((stats.underBudget / stats.success) * 100).toFixed(1)}%)`);
  console.log(`   Over $4.50 budget: ${stats.overBudget} (${((stats.overBudget / stats.success) * 100).toFixed(1)}%)\n`);

  console.log('‚úÖ Recipe regeneration complete!');
}

regenerateRecipes().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
</file>

<file path="scripts/run-amazon-scraper.ts">
// scripts/run-amazon-scraper.ts
// Amazon scraper runner for product discovery

import fs from 'fs';
import path from 'path';

interface AmazonProduct {
  name: string;
  url: string;
  price: number;
  rating: number;
  reviewCount: number;
  imageUrl?: string;
  asin?: string;
}

interface ScrapedResults {
  [ingredient: string]: AmazonProduct[];
}

class AmazonProductDiscovery {
  private resultsDir: string;
  private partialResultsPath: string;
  
  constructor() {
    this.resultsDir = path.join(__dirname, '../pet-ingredient-scraper/results');
    this.partialResultsPath = path.join(this.resultsDir, 'amazon-partial.json');
    
    // Ensure results directory exists
    if (!fs.existsSync(this.resultsDir)) {
      fs.mkdirSync(this.resultsDir, { recursive: true });
    }
  }
  
  async searchProductsForIngredient(ingredient: string): Promise<AmazonProduct[]> {
    console.log(`\nüîç Searching Amazon for: ${ingredient}`);
    
    try {
      // Use compiled JavaScript files from dist (use file:// protocol for Windows)
      const scraperDir = path.join(__dirname, '../pet-ingredient-scraper');
      const distPath = path.resolve(scraperDir, 'dist/scrapers/AmazonScraper.js');
      
      // Import AmazonScraper from compiled dist
      const scraperModule = await import(`file://${distPath.replace(/\\/g, '/')}`);
      const AmazonScraper = scraperModule.AmazonScraper;
      const scraper = new AmazonScraper({ headless: true });
      
      // Try multiple search queries
      const searchQueries = [
        `${ingredient} for dogs`,
        `${ingredient} pet food`,
        `${ingredient} freeze dried dog`
      ];
      
      const allProducts: AmazonProduct[] = [];
      
      for (const query of searchQueries) {
        try {
          console.log(`  Searching: "${query}"`);
          const products = await scraper.search(query);
          
          // Filter and score products
          const scoredProducts = products
            .map((product: any) => ({
              ...product,
              score: this.calculateProductScore(product, ingredient)
            }))
            .filter((product: any) => product.score >= 0.5) // Minimum threshold
            .sort((a: any, b: any) => (b.score || 0) - (a.score || 0));
          
          allProducts.push(...scoredProducts);
          
          // Avoid rate limiting
          await this.delay(3000);
          
        } catch (error) {
          console.error(`  Error searching "${query}":`, error);
        }
      }
      
      // Close scraper
      await scraper.close();
      
      // Deduplicate by URL
      const uniqueProducts = this.deduplicateProducts(allProducts);
      
      // Extract ASIN from URL if possible
      uniqueProducts.forEach(product => {
        const asinMatch = product.url.match(/\/dp\/([A-Z0-9]{10})/);
        if (asinMatch) {
          product.asin = asinMatch[1];
        }
      });
      
      console.log(`  ‚úÖ Found ${uniqueProducts.length} products`);
      
      return uniqueProducts.slice(0, 10); // Top 10
      
    } catch (error) {
      console.error(`‚ùå Failed to scrape ${ingredient}:`, error);
      return [];
    }
  }
  
  private calculateProductScore(product: AmazonProduct, targetIngredient: string): number {
    let score = 0;
    
    const title = product.name.toLowerCase();
    const ingredient = targetIngredient.toLowerCase();
    
    // Title relevance (40%)
    if (title.includes(ingredient)) {
      score += 0.4;
    } else {
      // Fuzzy match
      const ingredientWords = ingredient.split(' ');
      const matchCount = ingredientWords.filter(word => 
        word.length > 3 && title.includes(word)
      ).length;
      if (matchCount > 0) {
        score += (matchCount / ingredientWords.length) * 0.3;
      }
    }
    
    // Rating (30%)
    if (product.rating >= 4.5) score += 0.3;
    else if (product.rating >= 4.0) score += 0.2;
    else if (product.rating >= 3.5) score += 0.1;
    
    // Reviews (20%)
    if (product.reviewCount >= 1000) score += 0.2;
    else if (product.reviewCount >= 500) score += 0.15;
    else if (product.reviewCount >= 100) score += 0.1;
    else if (product.reviewCount >= 50) score += 0.05;
    
    // Pet-specific (10%)
    if (title.includes('dog') || title.includes('pet') || title.includes('puppy') || title.includes('canine')) {
      score += 0.1;
    }
    
    // Penalties
    if (title.includes('toy') || title.includes('accessory') || title.includes('bed') || title.includes('collar')) {
      score -= 0.3; // Not food
    }
    
    return Math.max(0, Math.min(1, score));
  }
  
  private deduplicateProducts(products: AmazonProduct[]): AmazonProduct[] {
    const seen = new Set<string>();
    return products.filter(product => {
      const key = product.url || product.name;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  }
  
  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  savePartialResults(results: ScrapedResults) {
    fs.writeFileSync(
      this.partialResultsPath,
      JSON.stringify(results, null, 2)
    );
  }
  
  analyzeAndVetProducts(results: ScrapedResults): any[] {
    const vettedProducts: any[] = [];
    
    Object.entries(results).forEach(([ingredient, products]) => {
      if (products.length === 0) return;
      
      // Get best product
      const bestProduct = products
        .sort((a, b) => ((b as any).score || 0) - ((a as any).score || 0))[0];
      
      if ((bestProduct as any).score >= 0.7) {
        vettedProducts.push({
          ingredient,
          productName: bestProduct.name,
          asin: bestProduct.asin,
          amazonLink: bestProduct.url,
          price: bestProduct.price,
          rating: bestProduct.rating,
          reviewCount: bestProduct.reviewCount,
          score: (bestProduct as any).score,
          confidence: (bestProduct as any).score,
          source: 'amazon_scraper',
          lastUpdated: new Date().toISOString()
        });
      }
    });
    
    return vettedProducts;
  }
}

async function main() {
  // Load ingredients needing vetting
  const ingredientsPath = path.join(__dirname, '../data/ingredients-needing-vetting.json');
  
  if (!fs.existsSync(ingredientsPath)) {
    console.error('‚ùå ingredients-needing-vetting.json not found. Run vet:recipes first.');
    process.exit(1);
  }
  
  const allIngredients = JSON.parse(fs.readFileSync(ingredientsPath, 'utf-8'));
  
  // Process ALL ingredients - prioritize organs/oils/supplements first, then rest
  const allIngredientNames = allIngredients.map((item: any) => item.name);
  
  // Separate priority and regular ingredients
  const priorityIngredients = allIngredientNames.filter((name: string) => {
    const normalized = name.toLowerCase();
    return normalized.includes('heart') || 
           normalized.includes('liver') || 
           normalized.includes('organ') ||
           normalized.includes('oil') ||
           normalized.includes('supplement') ||
           normalized.includes('powder') ||
           normalized.includes('kelp');
  });
  
  const regularIngredients = allIngredientNames.filter((name: string) => {
    const normalized = name.toLowerCase();
    return !normalized.includes('heart') && 
           !normalized.includes('liver') && 
           !normalized.includes('organ') &&
           !normalized.includes('oil') &&
           !normalized.includes('supplement') &&
           !normalized.includes('powder') &&
           !normalized.includes('kelp');
  });
  
  // Process priority first, then regular
  const ingredientsToProcess = [...priorityIngredients, ...regularIngredients];
  
  console.log(`üöÄ Running Amazon scraper for ${ingredientsToProcess.length} ingredients...\n`);
  console.log(`   Priority (organs/oils/supplements): ${priorityIngredients.length}`);
  console.log(`   Regular ingredients: ${regularIngredients.length}\n`);
  
  const discoverer = new AmazonProductDiscovery();
  const results: ScrapedResults = {};
  
  for (let i = 0; i < ingredientsToProcess.length; i++) {
    const ingredient = ingredientsToProcess[i];
    console.log(`[${i + 1}/${priorityIngredients.length}] Processing: ${ingredient}`);
    
    const products = await discoverer.searchProductsForIngredient(ingredient);
    results[ingredient] = products;
    
    // Save partial results after each ingredient
    discoverer.savePartialResults(results);
    
    // Delay between ingredients to avoid rate limiting
    if (i < ingredientsToProcess.length - 1) {
      const delayTime = i < priorityIngredients.length ? 5000 : 3000; // Longer delay for priority
      console.log(`  ‚è≥ Waiting ${delayTime/1000} seconds before next ingredient...\n`);
      await new Promise(resolve => setTimeout(resolve, delayTime));
    }
  }
  
  // Save full results
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const fullResultsPath = path.join(__dirname, '../pet-ingredient-scraper/results', `amazon-products-${timestamp}.json`);
  fs.writeFileSync(fullResultsPath, JSON.stringify(results, null, 2));
  console.log(`\n‚úÖ Full results saved to: amazon-products-${timestamp}.json`);
  
  // Analyze and create vetted products
  const vettedProducts = discoverer.analyzeAndVetProducts(results);
  
  console.log('\n=== AMAZON SCRAPING RESULTS ===');
  console.log(`Ingredients processed: ${Object.keys(results).length}`);
  console.log(`Total products found: ${Object.values(results).flat().length}`);
  console.log(`High-quality products (‚â•70% score): ${vettedProducts.length}`);
  
  // Save vetted products
  const vettedPath = path.join(__dirname, '../data/amazon-vetted-products.json');
  fs.writeFileSync(vettedPath, JSON.stringify(vettedProducts, null, 2));
  console.log(`‚úÖ Vetted products saved to: data/amazon-vetted-products.json`);
  
  // Generate update script
  generateAmazonUpdateScript(vettedProducts);
}

function generateAmazonUpdateScript(products: any[]) {
  let script = '// AMAZON-DISCOVERED VETTED PRODUCTS\n';
  script += '// Review these products and add to lib/data/vetted-products.ts\n\n';
  script += 'const amazonVettedProducts = {\n';
  
  products.forEach(product => {
    const key = product.ingredient.toLowerCase().replace(/\s+/g, '_').replace(/[()]/g, '');
    script += `  '${key}': {\n`;
    script += `    productName: '${product.productName.replace(/'/g, "\\'")}',\n`;
    if (product.asin) {
      script += `    amazonLink: 'https://www.amazon.com/dp/${product.asin}?tag=robinfrench-20',\n`;
    } else {
      script += `    amazonLink: '${product.amazonLink}',\n`;
    }
    script += `    vetNote: 'Amazon-discovered product. Rating: ${product.rating}‚≠ê (${product.reviewCount} reviews). Score: ${(product.score * 100).toFixed(0)}%.',\n`;
    script += `    category: 'auto_detected',\n`;
    script += `    confidence: ${product.confidence.toFixed(2)},\n`;
    script += `    source: 'amazon_scraper',\n`;
    script += `    lastUpdated: '${product.lastUpdated}'\n`;
    script += `  },\n`;
  });
  
  script += '};\n';
  
  const scriptPath = path.join(__dirname, '../data/amazon-vetted-script.ts');
  fs.writeFileSync(scriptPath, script);
  console.log(`‚úÖ Update script generated: data/amazon-vetted-script.ts`);
  console.log(`\nüìù Review the script and merge high-confidence products into vetted-products.ts`);
}

main().catch(console.error);
</file>

<file path="scripts/run-scrapers.js">
// scripts/run-scrapers.js
// Master script to run all scrapers and process results

// Import the scraper class
const PetRecipeScraper = require('../scraping/scraper');
const { buildIngredients } = require('./buildIngredients');
const fs = require('fs');
const path = require('path');

async function runAllScrapers() {
  console.log('üï∑Ô∏è Starting comprehensive scraper run...\n');
  
  try {
    // Step 1: Run scrapers
    console.log('Step 1: Running web scrapers (this may take a while)...\n');
    const ScraperClass = PetRecipeScraper.default || PetRecipeScraper;
    const scraper = new ScraperClass();
    
    // Run scrapers with progress tracking
    let completed = 0;
    const totalSources = scraper.sources.length;
    
    console.log(`üìä Total sources to scrape: ${totalSources}\n`);
    
    const results = await scraper.scrapeAll();
    
    // Save consolidated results
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const outputPath = path.join(__dirname, '../scraping/results', `full_scrape_${timestamp}.json`);
    fs.writeFileSync(outputPath, JSON.stringify(results, null, 2), 'utf8');
    
    console.log(`\n‚úÖ Scraping complete! Results saved to: ${outputPath}`);
    console.log(`üìä Total sources scraped: ${results.results?.length || 0}`);
    console.log(`üìä Successful: ${results.results?.filter(r => r.success).length || 0}`);
    console.log(`üìä Failed: ${results.results?.filter(r => !r.success).length || 0}\n`);
    
    // Step 2: Build curated ingredients from all scraped results
    console.log('Step 2: Building curated ingredients from all scraped data...\n');
    await buildIngredients();
    
    console.log('\n‚úÖ All steps complete!');
    console.log('\nüìã Next steps:');
    console.log('1. Review lib/data/generatedIngredients.ts');
    console.log('2. The generated ingredients are now integrated into getIngredientsForSpecies()');
    console.log('3. Run scrapers again anytime to discover more ingredients');
    console.log('4. Manually curate ingredient compatibility in INGREDIENT_COMPOSITIONS.ts');
    
  } catch (error) {
    console.error('\n‚ùå Error during scraping:', error);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run if called directly
if (require.main === module) {
  runAllScrapers()
    .then(() => {
      process.exit(0);
    })
    .catch(error => {
      console.error('Fatal error:', error);
      process.exit(1);
    });
}

module.exports = { runAllScrapers };
</file>

<file path="scripts/scan-price-outliers.ts">
/**
 * Scan vetted products for outlier prices
 * Detects prices that exceed reasonable limits for their category
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// ES module __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Price validation constants (inline to avoid import issues)
type ProductCategory = 'Meat' | 'Supplement' | 'Carb' | 'Vegetable' | 'Oil' | 'Seed' | 'Fruit' | 'Insect' | 'Hay' | 'Pellet';

const MAX_REASONABLE_PRICES: Record<ProductCategory, number> = {
  Vegetable: 15,
  Meat: 80,
  Carb: 75,
  Oil: 40,
  Supplement: 100,
  Fruit: 30,
  Seed: 50,
  Insect: 50,
  Hay: 50,
  Pellet: 80,
};

function isPriceReasonable(price: number, category?: string): boolean {
  if (!category) return true;
  const normalizedCategory = category as ProductCategory;
  if (!(normalizedCategory in MAX_REASONABLE_PRICES)) return true;
  const maxPrice = MAX_REASONABLE_PRICES[normalizedCategory];
  return price <= maxPrice;
}

function getMaxReasonablePrice(category?: string): number | null {
  if (!category) return null;
  const normalizedCategory = category as ProductCategory;
  return MAX_REASONABLE_PRICES[normalizedCategory] || null;
}

interface OutlierReport {
  ingredientName: string;
  currentPrice: number;
  category: string;
  maxReasonablePrice: number | null;
  asinLink: string;
  productName: string;
  lastUpdated: string;
}

interface VettedProduct {
  productName: string;
  asinLink: string;
  vetNote: string;
  category?: ProductCategory;
  price?: {
    amount: number;
    currency: string;
    lastUpdated: string;
  };
}

function scanPriceOutliers(): void {
  console.log('üîç Scanning vetted products for price outliers...\n');
  
  const vettedProductsPath = path.join(__dirname, '../lib/data/vetted-products.ts');
  const content = fs.readFileSync(vettedProductsPath, 'utf8');
  
  // Extract the VETTED_PRODUCTS object
  // Look for the export const VETTED_PRODUCTS pattern
  const productsMatch = content.match(/export\s+const\s+VETTED_PRODUCTS[^=]*=\s*\{([\s\S]*)\}\s*;/);
  
  if (!productsMatch) {
    console.error('‚ùå Could not find VETTED_PRODUCTS in vetted-products.ts');
    process.exit(1);
  }
  
  // Parse products using regex to extract each entry
  const productEntries: Array<{ key: string; value: Partial<VettedProduct> }> = [];
  
  // Match pattern: 'ingredient-name': { ... }
  const entryPattern = /'([^']+)':\s*\{([^}]+(?:\{[^}]*\}[^}]*)*)\}/g;
  let match;
  
  // More robust parsing: look for entries with price information
  const pricePattern = /price:\s*\{\s*amount:\s*([0-9.]+)/g;
  const entries = content.matchAll(/'([^']+)':\s*\{[\s\S]*?price:\s*\{[\s\S]*?amount:\s*([0-9.]+)[\s\S]*?\}/g);
  
  const outliers: OutlierReport[] = [];
  let totalProducts = 0;
  let productsWithPrices = 0;
  
  // Use a simpler approach: extract all ingredient entries with their prices
  const ingredientKeyPattern = /'([^']+)':/g;
  let keyMatch;
  const seenKeys = new Set<string>();
  
  // More targeted approach: look for price blocks and work backwards
  const priceBlockPattern = /price:\s*\{\s*amount:\s*([0-9.]+),\s*currency:\s*'([^']+)',\s*lastUpdated:\s*'([^']+)'/g;
  let priceMatch;
  
  // Find all price entries and extract context
  const allPriceMatches: Array<{
    amount: number;
    currency: string;
    lastUpdated: string;
    context: string;
    startIndex: number;
  }> = [];
  
  let searchContent = content;
  while ((priceMatch = priceBlockPattern.exec(content)) !== null) {
    const startIndex = priceMatch.index;
    const amount = parseFloat(priceMatch[1]);
    const currency = priceMatch[2];
    const lastUpdated = priceMatch[3];
    
    // Extract context around this price (look backwards for ingredient name and forwards for category)
    const contextStart = Math.max(0, startIndex - 500);
    const contextEnd = Math.min(content.length, startIndex + 500);
    const context = content.substring(contextStart, contextEnd);
    
    allPriceMatches.push({
      amount,
      currency,
      lastUpdated,
      context,
      startIndex,
    });
  }
  
  // For each price, extract the ingredient name and category
  for (const priceData of allPriceMatches) {
    productsWithPrices++;
    
    // Extract ingredient name (look for 'ingredient-name': pattern before the price)
    const beforeContext = priceData.context.substring(0, priceData.context.indexOf('price:'));
    const keyMatch = beforeContext.match(/'([^']+)':\s*\{/);
    if (!keyMatch) continue;
    
    const ingredientName = keyMatch[1];
    if (seenKeys.has(ingredientName)) continue; // Skip duplicates
    seenKeys.add(ingredientName);
    
    // Extract category
    const categoryMatch = priceData.context.match(/category:\s*'([^']+)'/);
    const category = categoryMatch ? categoryMatch[1] : undefined;
    
    // Extract productName and asinLink
    const productNameMatch = priceData.context.match(/productName:\s*'([^']+)'/);
    const productName = productNameMatch ? productNameMatch[1] : 'Unknown';
    
    const asinLinkMatch = priceData.context.match(/asinLink:\s*'([^']+)'/);
    const asinLink = asinLinkMatch ? asinLinkMatch[1] : '';
    
    // Check if price is reasonable
    const maxPrice = getMaxReasonablePrice(category);
    const isReasonable = isPriceReasonable(priceData.amount, category);
    
    if (!isReasonable && maxPrice !== null) {
      outliers.push({
        ingredientName,
        currentPrice: priceData.amount,
        category: category || 'Unknown',
        maxReasonablePrice: maxPrice,
        asinLink,
        productName,
        lastUpdated: priceData.lastUpdated,
      });
    }
    
    totalProducts++;
  }
  
  // Generate report
  console.log(`üìä Scan Results:\n`);
  console.log(`   Total products scanned: ${productsWithPrices}`);
  console.log(`   Outliers found: ${outliers.length}\n`);
  
  if (outliers.length > 0) {
    console.log('‚ö†Ô∏è  PRICE OUTLIERS DETECTED:\n');
    outliers.forEach((outlier, index) => {
      console.log(`${index + 1}. ${outlier.ingredientName} (${outlier.productName})`);
      console.log(`   Category: ${outlier.category}`);
      console.log(`   Current Price: $${outlier.currentPrice.toFixed(2)}`);
      console.log(`   Max Reasonable: $${outlier.maxReasonablePrice?.toFixed(2) || 'N/A'}`);
      console.log(`   Exceeds by: $${(outlier.currentPrice - (outlier.maxReasonablePrice || 0)).toFixed(2)}`);
      console.log(`   ASIN Link: ${outlier.asinLink}`);
      console.log(`   Last Updated: ${outlier.lastUpdated}`);
      console.log('');
    });
  } else {
    console.log('‚úÖ No price outliers detected!\n');
  }
  
  // Save report to JSON file
  const reportPath = path.join(__dirname, 'price-outliers-report.json');
  const report = {
    scanDate: new Date().toISOString(),
    totalProductsScanned: productsWithPrices,
    outliersFound: outliers.length,
    outliers: outliers,
  };
  
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
  console.log(`üìÑ Report saved to: ${reportPath}`);
  
  if (outliers.length > 0) {
    process.exit(1); // Exit with error code to indicate outliers were found
  }
}

// Run the scan
try {
  scanPriceOutliers();
} catch (error) {
  console.error('‚ùå Error scanning price outliers:', error);
  process.exit(1);
}
</file>

<file path="scripts/simple-replace-prices.js">
import fs from 'node:fs';
import path from 'node:path';

const REPLACEMENTS = {
  'sage': { asin: 'B00BUSL1SO', productName: 'Simply Organic Sage', price: 6.99 },
  'beta-glucans': { asin: 'B08CXQV9V7', productName: 'Wonder Paws Turkey Tail Mushroom', price: 29.99 },
  'collard-greens': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'broccoli': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'kale': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'celery': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'krill-oil': { asin: 'B01N9SSTG8', productName: 'Zesty Paws Wild Alaskan Salmon Oil', price: 21.99 },
  'quinoa': { asin: 'B000EDG598', productName: "Bob's Red Mill Organic Quinoa", price: 12.49 },
  'sweet-potato': { asin: 'B07YNQ6T9Z', productName: 'Wholesome Pride Freeze-Dried Sweet Potato', price: 12.99 },
  'snow-peas-(mashed)': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'duck-liver': { asin: 'B0BXZ3JJL9', productName: 'Fresh Is Best Freeze-Dried Liver', price: 24.99 },
  'oatmeal-(cooked,-small-amounts)': { asin: 'B000EDG52O', productName: "Bob's Red Mill Steel Cut Oats", price: 7.99 },
  'oatmeal': { asin: 'B000EDG52O', productName: "Bob's Red Mill Steel Cut Oats", price: 7.99 },
  'eggs': { asin: null, productName: 'Fresh Eggs (Buy at Grocery Store)', price: 4.0 },
  'butternut-squash': { asin: 'B000HDCSTG', productName: "Farmer's Market Organic Pumpkin Puree", price: 4.99 },
  'sunflower-oil': { asin: 'B00C11W8YW', productName: 'Spectrum Organic Sunflower Oil', price: 8.99 },
  'olive-oil': { asin: 'B00GGBLPVU', productName: 'California Olive Ranch Extra Virgin Olive Oil', price: 12.99 },
  'chicken-hearts': { asin: 'B0BXZ3JJL9', productName: 'Fresh Is Best Freeze-Dried Organ Meat', price: 24.99 },
  'turkey-giblets': { asin: 'B0BXZ3JJL9', productName: 'Fresh Is Best Freeze-Dried Organ Meat', price: 24.99 },
  'escarole': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'niger-seed': { asin: 'B001ODB3YE', productName: 'Kaytee Wild Bird Food Mix', price: 16.99 },
  'oat-groats': { asin: 'B000EDG52O', productName: "Bob's Red Mill Oat Groats", price: 7.99 },
  'hemp-seeds': { asin: 'B01N7GJVNH', productName: 'Manitoba Harvest Hemp Hearts', price: 14.99 },
  'chia-seeds': { asin: 'B00JL2X3D4', productName: 'Viva Naturals Organic Chia Seeds', price: 9.99 },
  'sesame-seeds': { asin: 'B07ZYNJ43K', productName: "Anthony's Organic Sesame Seeds", price: 8.99 },
  'pellets-(fortified)': { asin: 'B0002ARAFI', productName: 'Zupreem Natural Bird Food Pellets', price: 16.99 },
  'endive': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'omega-3-capsules': { asin: 'B004OA5XP4', productName: 'Nordic Naturals Omega-3 Pet', price: 29.99 },
  'amaranth-(tiny-amounts)': { asin: 'B00028QE9C', productName: "Bob's Red Mill Amaranth Grain", price: 8.49 },
  'amaranth-seeds': { asin: 'B00028QE9C', productName: "Bob's Red Mill Amaranth Grain", price: 8.49 },
  'salmon-oil': { asin: 'B01N9SSTG8', productName: 'Zesty Paws Wild Alaskan Salmon Oil', price: 21.99 },
  'omega-3-oil': { asin: 'B01N9SSTG8', productName: 'Zesty Paws Wild Alaskan Salmon Oil', price: 21.99 },
  'joint-health-powder': { asin: 'B0002APQY2', productName: 'Cosequin DS Joint Health Supplement', price: 29.99 },
  'pumpkin-puree': { asin: 'B000HDCSTG', productName: "Farmer's Market Organic Pumpkin Puree", price: 4.99 },
  'sardines-(canned-in-water)': { asin: 'B001EO5QW8', productName: 'Wild Planet Wild Sardines in Water', price: 4.49 },
  'duck-breast': { asin: 'B0BXZ3JJL9', productName: 'Fresh Is Best Freeze-Dried Duck', price: 24.99 },
  'beet-greens': { asin: 'B07MGZKB9V', productName: "Dr. Harvey's Veg-to-Bowl", price: 16.99 },
  'herring-(canned)': { asin: 'B001EO5QRM', productName: 'Wild Planet Wild Herring in Water', price: 5.99 },
  'sardines-(in-water)': { asin: 'B001EO5QW8', productName: 'Wild Planet Wild Sardines in Water', price: 4.49 },
  'safflower-seeds': { asin: 'B001ODB3YE', productName: "Wagner's Safflower Seeds", price: 13.99 },
  'wild-bird-mix': { asin: 'B001ODB3YE', productName: 'Kaytee Wild Bird Food Mix', price: 16.99 },
  'avocado-oil': { asin: 'B00KN93TJU', productName: 'Chosen Foods Avocado Oil', price: 12.99 },
  'avocado-oil-(tiny-amounts)': { asin: 'B00KN93TJU', productName: 'Chosen Foods Avocado Oil', price: 12.99 },
  's-adenosyl-methionine-(sam-e)': { asin: 'B0002APQVQ', productName: 'Nutramax Denamarin (contains SAM-e)', price: 29.99 },
  'canary-seed': { asin: 'B001ODB3YE', productName: 'Kaytee Wild Bird Food Mix', price: 16.99 },
  'flaxseeds': { asin: 'B00JL2X39O', productName: 'Viva Naturals Organic Flaxseeds', price: 8.99 },
  'quinoa-(cooked)': { asin: 'B000EDG598', productName: "Bob's Red Mill Organic Quinoa", price: 12.49 },
  'rapeseed': { asin: 'B001ODB3YE', productName: 'Kaytee Wild Bird Food Mix', price: 16.99 },
  'sunflower-seeds-(small-amounts)': { asin: 'B07ZXF9876', productName: 'Bulk Sunflower Seeds', price: 10.99 },
  'pumpkin-seeds': { asin: 'B00JL2X2KW', productName: 'Viva Naturals Pumpkin Seeds', price: 9.99 },
  'cuttlebone': { asin: 'B0002AR0I2', productName: 'Prevue Pet Products Cuttlebone 3-Pack', price: 5.99 },
  'barley-hay': { asin: 'B07ZYNJ123', productName: 'Small Pet Select Barley Hay', price: 18.99 },
  'd-mannose': { asin: 'B07FC4ZY34', productName: 'Doggy Naturals Cranberry D-Mannose', price: 19.99 },
  'fish-oil': { asin: 'B01N9SSTG8', productName: 'Zesty Paws Wild Alaskan Salmon Oil', price: 21.99 },
  'herring-oil': { asin: 'B01N9SSTG8', productName: 'Zesty Paws Wild Alaskan Salmon Oil', price: 21.99 },
  'apricots-(pitted)': { asin: null, productName: 'Fresh Apricots (Buy at Grocery Store)', price: 4.0 },
  'ground-herring': { asin: 'B001EO5QRM', productName: 'Wild Planet Wild Herring in Water', price: 5.99 },
  'electrolyte-powder': { asin: 'B07X6LNK99', productName: 'Pet Electrolyte Powder', price: 14.99 },
  'ground-lamb': { asin: 'B0082C00P8', productName: 'Raw Paws Ground Lamb', price: 22.99 },
  'rabbit-meat': { asin: null, productName: 'Fresh Rabbit Meat (Buy at Butcher)', price: 10.0 },
  'quercetin': { asin: 'B0742YS3TG', productName: 'Quercetin for Dogs', price: 19.99 },
  'blueberries': { asin: null, productName: 'Fresh Blueberries (Buy at Grocery Store)', price: 5.0 },
  'meadow-hay': { asin: 'B001ODB40G', productName: 'Oxbow Meadow Hay', price: 16.99 },
  'guinea-pig-pellets-(with-vitamin-c)': { asin: 'B001ODB40U', productName: 'Oxbow Essentials Adult Guinea Pig Food', price: 12.99 },
};

function slugify(s) {
  return String(s || '')
    .toLowerCase()
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function amazonUrl(asin) {
  if (!asin) return '';
  return `https://www.amazon.com/dp/${asin}?tag=robinfrench-20`;
}

function main() {
  const root = process.cwd();
  const pricesPath = path.join(root, 'data', 'product-prices.json');

  const raw = fs.readFileSync(pricesPath, 'utf8');
  const records = JSON.parse(raw);

  const repBySlug = new Map(Object.entries(REPLACEMENTS).map(([k, v]) => [slugify(k), v]));

  const now = new Date().toISOString();
  let updated = 0;
  let missing = 0;

  const hits = new Set();

  for (const r of records) {
    const slug = slugify(r?.ingredient);
    const rep = repBySlug.get(slug);
    if (!rep) continue;

    hits.add(slug);

    const asin = rep.asin ? String(rep.asin).toUpperCase() : '';
    const url = asin ? amazonUrl(asin) : '';

    r.asin = asin;
    r.url = url;
    r.price = r.price || {};
    r.price.amount = Number(rep.price);
    r.price.currency = 'USD';
    r.price.lastUpdated = now;

    updated += 1;
  }

  for (const [slug] of repBySlug.entries()) {
    if (!hits.has(slug)) missing += 1;
  }

  fs.writeFileSync(pricesPath, JSON.stringify(records, null, 2) + '\n');

  console.log(`UPDATED=${updated}`);
  console.log(`MISSING=${missing}`);
}

main();
</file>

<file path="scripts/split-best-emojis.py">
# scripts/split-best-emojis.py
# Split the best.jfif grid into individual emoji images

from PIL import Image
import os
from pathlib import Path

# Emoji order as specified
EMOJI_ORDER = [
    ('dog', 'üêï'),
    ('cat', 'üêà'),
    ('bird', 'ü¶ú'),
    ('reptile', 'ü¶é'),
    ('rabbit', 'üê∞'),
    ('hamster', 'üêπ'),
    ('mouse', 'üê≠'),
    ('thumbs_up', 'üëç'),
    ('balance_scale', '‚öñÔ∏è'),
    ('warning', '‚ö†Ô∏è'),
    ('check_mark', '‚úÖ'),
    ('trophy', 'üèÜ'),
    ('paw_prints', 'üêæ'),
    ('star', '‚≠ê'),
    ('sparkles', '‚ú®'),
]

def split_best_grid():
    """Split best.jfif into individual emoji images"""
    input_path = Path('IMAGES FOR SITE/emojis/best.jfif')
    output_dir = Path('public/images/emojis')
    
    if not input_path.exists():
        print(f"‚ùå File not found: {input_path}")
        return
    
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Open the image
    img = Image.open(input_path)
    width, height = img.size
    
    print(f"üìê Image dimensions: {width}x{height}")
    
    # Determine grid layout (15 items = 3x5 or 5x3)
    # Let's try to detect - check if it's wider or taller
    if width > height:
        # Landscape: probably 5 columns, 3 rows
        grid_cols = 5
        grid_rows = 3
    else:
        # Portrait: probably 3 columns, 5 rows
        grid_cols = 3
        grid_rows = 5
    
    cell_width = width / grid_cols
    cell_height = height / grid_rows
    
    print(f"üîç Detected grid: {grid_cols}x{grid_rows} (cell size: {cell_width:.0f}x{cell_height:.0f})")
    
    # Split into individual images
    count = 0
    for row in range(grid_rows):
        for col in range(grid_cols):
            if count >= len(EMOJI_ORDER):
                break
            
            # Calculate crop box
            left = int(col * cell_width)
            top = int(row * cell_height)
            right = int(left + cell_width)
            bottom = int(top + cell_height)
            
            # Crop the cell
            cell = img.crop((left, top, right, bottom))
            
            # Get emoji info
            emoji_name, emoji_char = EMOJI_ORDER[count]
            
            # Save with descriptive name
            output_path = output_dir / f"best_{emoji_name}.png"
            cell.save(output_path, 'PNG')
            
            print(f"  ‚úÖ [{count+1}/15] Saved: {output_path.name} ({emoji_char})")
            count += 1
    
    print(f"\n‚úÖ Successfully split {count} emoji images!")
    print(f"üìÅ Output directory: {output_dir.absolute()}")

if __name__ == '__main__':
    split_best_grid()
</file>

<file path="scripts/split-emoji-grids.py">
# scripts/split-emoji-grids.py
# Split emoji grid images into individual emoji files

from PIL import Image
import os
import json
from pathlib import Path

def split_grid_image(image_path, output_dir, grid_cols, grid_rows, cell_width, cell_height, base_name_override=None):
    """Split a grid image into individual emoji files"""
    img = Image.open(image_path)
    
    output_dir = Path(output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)
    
    base_name = base_name_override or Path(image_path).stem
    # Clean up base name for file system
    base_name = base_name.replace(' ', '_').replace('___', '_').replace('__', '_')
    base_name = ''.join(c for c in base_name if c.isalnum() or c in ('_', '-'))[:50]  # Limit length
    
    count = 0
    for row in range(grid_rows):
        for col in range(grid_cols):
            # Calculate crop box
            left = int(col * cell_width)
            top = int(row * cell_height)
            right = int(left + cell_width)
            bottom = int(top + cell_height)
            
            # Crop the cell
            cell = img.crop((left, top, right, bottom))
            
            # Save individual emoji
            emoji_num = (row * grid_cols) + col + 1
            output_path = output_dir / f"{base_name}_{emoji_num:03d}.png"
            cell.save(output_path, 'PNG')
            count += 1
    
    print(f"‚úÖ Split {Path(image_path).name} into {count} emoji files ‚Üí {output_dir}")
    return count

def main():
    emojis_dir = Path('IMAGES FOR SITE/emojis')
    output_dir = Path('public/images/emojis')
    
    # Load analysis results
    analysis_file = Path('data/emoji-grid-analysis.json')
    if analysis_file.exists():
        with open(analysis_file, 'r') as f:
            grid_configs = json.load(f)
    else:
        print("‚ùå Analysis file not found. Run analyze-emoji-grids.py first.")
        return
    
    print("üî™ Splitting emoji grid images...\n")
    
    total_split = 0
    
    for config in grid_configs:
        if 'error' in config:
            print(f"‚ö†Ô∏è  Skipping {config['file']}: {config['error']}")
            continue
        
        image_path = emojis_dir / config['file']
        if not image_path.exists():
            print(f"‚ö†Ô∏è  Skipping {config['file']} - not found")
            continue
        
        # Use a cleaner base name
        base_name = config['file'].replace('.png', '').replace('.jpg', '')
        if 'grid of' in base_name.lower():
            base_name = 'emoji_grid'
        elif 'amojis' in base_name.lower():
            base_name = 'amojis'
        elif 'copilot' in base_name.lower():
            base_name = 'copilot_emojis'
        
        count = split_grid_image(
            image_path,
            output_dir,
            config['grid_cols'],
            config['grid_rows'],
            config['cell_width'],
            config['cell_height'],
            base_name_override=base_name
        )
        total_split += count
    
    print(f"\n‚úÖ Total: Split {total_split} emoji images")
    print(f"üìÅ Output directory: {output_dir.absolute()}")

if __name__ == '__main__':
    main()
</file>

<file path="scripts/split-mascot-faces.py">
# scripts/split-mascot-faces.py
# Split the mascot_face_emojis image into individual mascot face images

from PIL import Image
import os
from pathlib import Path

# Mascot face order (left to right in the image) - Brand Bible names
MASCOT_FACES = [
    ('puppy-prepper', 'Puppy Prepper', 'The Chef & Meal-Prep Lead - Light gold dog with chef hat'),
    ('professor-purrfessor', 'Professor Purrfessor', 'The Researcher & Recipe Tester - Black cat with glasses'),
    ('sherlock-shells', 'Sherlock Shells', 'Explorer & Risk Inspector - Green turtle with orange cap and monocle'),
    ('farmer-fluff', 'Farmer Fluff', 'Ingredient Provider & Farm Manager - Dark brown hamster'),
    ('robin-redroute', 'Robin Redroute', 'Packaging & Delivery Specialist - Red bird with captain hat and goggles'),
]

def split_mascot_faces():
    """Split mascot_face_emojis-removebg-preview.png into individual mascot face images"""
    input_path = Path('IMAGES FOR SITE/Mascots/Final Dafts/mascot_face_emojis-removebg-preview.png')
    output_dir = Path('public/images/emojis/mascots')
    
    if not input_path.exists():
        print(f"‚ùå File not found: {input_path}")
        return
    
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Open the image
    img = Image.open(input_path)
    width, height = img.size
    
    print(f"üìê Image dimensions: {width}x{height}")
    print(f"üîç Detected: 5 mascot faces in a horizontal row")
    
    # Calculate cell width (5 faces in a row)
    cell_width = width / 5
    cell_height = height  # Full height for each face
    
    print(f"üìè Cell size: {cell_width:.0f}x{cell_height:.0f}")
    
    # Split into individual images
    for index, (file_name, display_name, description) in enumerate(MASCOT_FACES):
        # Calculate crop box
        left = int(index * cell_width)
        top = 0
        right = int(left + cell_width)
        bottom = int(height)
        
        # Crop the cell
        cell = img.crop((left, top, right, bottom))
        
        # Save with descriptive name
        output_path = output_dir / f"{file_name}_face.png"
        cell.save(output_path, 'PNG')
        
        print(f"  ‚úÖ [{index+1}/5] Saved: {output_path.name} - {display_name}")
        print(f"     {description}")
    
    print(f"\n‚úÖ Successfully split {len(MASCOT_FACES)} mascot face images!")
    print(f"üìÅ Output directory: {output_dir.absolute()}")

if __name__ == '__main__':
    split_mascot_faces()
</file>

<file path="scripts/split-new-amojis.py">
# scripts/split-new-amojis.py
# Split the new amojis.png (8x10 grid, 80 icons) into individual emoji images

from PIL import Image
import os
from pathlib import Path

# Grid layout: 8 rows x 10 columns = 80 icons
ROWS = 8
COLS = 10

def split_new_amojis():
    """Split amojis.png into 80 individual emoji images"""
    input_path = Path('IMAGES FOR SITE/emojis/amojis.png')
    output_dir = Path('public/images/emojis')
    
    if not input_path.exists():
        print(f"‚ùå File not found: {input_path}")
        return
    
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Open the image
    img = Image.open(input_path)
    width, height = img.size
    
    print(f"üìê Image dimensions: {width}x{height}")
    print(f"üîç Detected: {ROWS} rows x {COLS} columns = {ROWS * COLS} icons")
    
    # Calculate cell dimensions
    cell_width = width / COLS
    cell_height = height / ROWS
    
    print(f"üìè Cell size: {cell_width:.0f}x{cell_height:.0f}")
    
    # Split into individual images
    count = 0
    for row in range(ROWS):
        for col in range(COLS):
            # Calculate crop box
            left = int(col * cell_width)
            top = int(row * cell_height)
            right = int(left + cell_width)
            bottom = int(top + cell_height)
            
            # Crop the cell
            cell = img.crop((left, top, right, bottom))
            
            # Save with sequential number (001-080)
            count += 1
            output_path = output_dir / f"amojis_{count:03d}.png"
            cell.save(output_path, 'PNG')
            
            if count % 10 == 0:
                print(f"  ‚úÖ Processed {count}/{ROWS * COLS} icons...")
    
    print(f"\n‚úÖ Successfully split {count} emoji images!")
    print(f"üìÅ Output directory: {output_dir.absolute()}")
    print(f"üìù Files saved as: amojis_001.png through amojis_{count:03d}.png")

if __name__ == '__main__':
    split_new_amojis()
</file>

<file path="scripts/split-new-best-emojis.py">
# scripts/split-new-best-emojis.py
# Split the new best.jfif (4x4 grid, 16 icons) into individual emoji images with descriptive names

from PIL import Image
import os
from pathlib import Path

# Grid layout: 4 rows x 4 columns = 16 icons
# Based on image description, mapping each position to its label
EMOJI_LABELS = [
    # Row 1
    ('dog', 'Dog - Yellow dog standing on all fours, facing left'),
    ('cat', 'Cat - Orange cat sitting upright, facing forward'),
    ('bird', 'Bird - Green bird standing, facing left'),
    ('reptile', 'Lizard/Frog - Green amphibian/reptile crouching on all fours'),
    
    # Row 2
    ('rabbit', 'Rabbit - Light beige/cream rabbit sitting upright'),
    ('hamster', 'Hamster - Orange and light beige hamster sitting upright'),
    ('thumbs_up_left', 'Thumbs Up (Left) - Grey hand making thumbs up gesture, pointing left'),
    ('thumbs_up_right', 'Thumbs Up (Right) - Yellow hand making thumbs up gesture, pointing right'),
    
    # Row 3
    ('balance_scale', 'Scales of Justice - Black balance scale with two yellow pans'),
    ('warning', 'Warning Sign - Yellow equilateral triangle with black exclamation mark'),
    ('check_mark', 'Check Mark - Bold green check mark'),
    ('trophy', 'Trophy - Yellow trophy cup with two handles'),
    
    # Row 4
    ('paw_prints', 'Paw Prints - Three dark grey/black paw prints arranged diagonally'),
    ('star', 'Star - Single five-pointed yellow star'),
    ('sparkle_single', 'Sparkle (Single) - Single yellow four-pointed sparkle'),
    ('sparkles_multiple', 'Sparkles (Multiple) - Cluster of three yellow four-pointed sparkles'),
]

ROWS = 4
COLS = 4

def split_new_best_emojis():
    """Split best.jfif into 16 individual emoji images with descriptive names"""
    input_path = Path('IMAGES FOR SITE/emojis/best.jfif')
    output_dir = Path('public/images/emojis')
    
    if not input_path.exists():
        print(f"‚ùå File not found: {input_path}")
        return
    
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Open the image
    img = Image.open(input_path)
    width, height = img.size
    
    print(f"üìê Image dimensions: {width}x{height}")
    print(f"üîç Detected: {ROWS} rows x {COLS} columns = {ROWS * COLS} icons")
    
    # Calculate cell dimensions
    cell_width = width / COLS
    cell_height = height / ROWS
    
    print(f"üìè Cell size: {cell_width:.0f}x{cell_height:.0f}")
    
    # Split into individual images
    for index, (label, description) in enumerate(EMOJI_LABELS):
        row = index // COLS
        col = index % COLS
        
        # Calculate crop box
        left = int(col * cell_width)
        top = int(row * cell_height)
        right = int(left + cell_width)
        bottom = int(top + cell_height)
        
        # Crop the cell
        cell = img.crop((left, top, right, bottom))
        
        # Save with descriptive name
        output_path = output_dir / f"best_{label}.png"
        cell.save(output_path, 'PNG')
        
        print(f"  ‚úÖ [{index+1}/{len(EMOJI_LABELS)}] Saved: best_{label}.png")
        print(f"     {description}")
    
    print(f"\n‚úÖ Successfully split {len(EMOJI_LABELS)} emoji images!")
    print(f"üìÅ Output directory: {output_dir.absolute()}")

if __name__ == '__main__':
    split_new_best_emojis()
</file>

<file path="scripts/test-all-species.ts">
// Test recipe generation for all species after category fixes
import { RecipeBuilder, GenerationConstraints } from '../lib/generator/RecipeBuilder';

type Species = 'dogs' | 'cats' | 'birds' | 'reptiles' | 'pocket-pets';

async function testSpecies(species: Species) {
  console.log(`\n${'='.repeat(80)}`);
  console.log(`TESTING ${species.toUpperCase()}`);
  console.log('='.repeat(80));
  
  const constraints: GenerationConstraints = {
    species,
    lifeStage: 'adult',
    petWeightKg: species === 'dogs' ? 15 : species === 'cats' ? 5 : species === 'birds' ? 0.5 : species === 'reptiles' ? 0.3 : 1,
    healthConcerns: [],
    allergies: [],
  };
  
  try {
    const builder = new RecipeBuilder(constraints, 'standard', 'medium');
    const recipe = await builder.generate();
    
    if (recipe && recipe.ingredients.length > 0) {
      console.log(`‚úÖ SUCCESS - Generated recipe with ${recipe.ingredients.length} ingredients`);
      
      let totalProtein = 0;
      let totalFat = 0;
      let totalGrams = 0;
      
      console.log('\nIngredients:');
      for (const portioned of recipe.ingredients) {
        const ing = portioned.ingredient;
        const protein = (ing.composition.protein || 0) * portioned.grams / 100;
        const fat = (ing.composition.fat || 0) * portioned.grams / 100;
        
        totalProtein += protein;
        totalFat += fat;
        totalGrams += portioned.grams;
        
        console.log(`  - ${ing.name} (${ing.category}): ${portioned.grams}g`);
      }
      
      const proteinPercent = (totalProtein / totalGrams) * 100;
      const fatPercent = (totalFat / totalGrams) * 100;
      
      console.log(`\nNutrition:`);
      console.log(`  Total: ${totalGrams}g`);
      console.log(`  Protein: ${proteinPercent.toFixed(1)}%`);
      console.log(`  Fat: ${fatPercent.toFixed(1)}%`);
      
      // Check against targets
      const targets: Record<Species, number> = {
        dogs: 18,
        cats: 26,
        birds: 18,
        reptiles: 18,
        'pocket-pets': 18,
      };
      
      const target = targets[species];
      if (proteinPercent >= target) {
        console.log(`  ‚úÖ MEETS PROTEIN TARGET (${target}%+)`);
      } else {
        console.log(`  ‚ö†Ô∏è  BELOW TARGET (need ${target}%+, got ${proteinPercent.toFixed(1)}%)`);
      }
      
    } else {
      console.log('‚ùå FAILED - No recipe generated');
    }
  } catch (error) {
    console.log(`‚ùå ERROR: ${error}`);
  }
}

async function main() {
  const species: Species[] = ['dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'];
  
  for (const sp of species) {
    await testSpecies(sp);
  }
  
  console.log('\n' + '='.repeat(80));
  console.log('TEST COMPLETE');
  console.log('='.repeat(80));
}

main().catch(console.error);
</file>

<file path="scripts/test-price-fetch.ts">
// scripts/test-price-fetch.ts
// Test price fetching on a small subset of products

import * as fs from 'fs';
import * as path from 'path';
import { VETTED_PRODUCTS } from '../lib/data/vetted-products';
import { extractASIN } from '../lib/utils/affiliateLinks';

// Test with just 3 products
const TEST_PRODUCTS = ['ground chicken', 'sweet potato', 'carrots'];

async function testFetch() {
  console.log('üß™ Testing Price Fetching\n');
  
  for (const ingredient of TEST_PRODUCTS) {
    const product = VETTED_PRODUCTS[ingredient];
    if (!product?.asinLink) {
      console.log(`‚ùå ${ingredient}: No asinLink`);
      continue;
    }
    
    const asin = extractASIN(product.asinLink);
    if (!asin) {
      console.log(`‚ùå ${ingredient}: Could not extract ASIN`);
      continue;
    }
    
    console.log(`\nüì¶ ${ingredient}`);
    console.log(`   ASIN: ${asin}`);
    console.log(`   URL: ${product.asinLink}`);
    
    // Try HTTP fetch
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const response = await fetch(product.asinLink, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        },
        signal: controller.signal,
      });
      
      clearTimeout(timeoutId);
      const html = await response.text();
      
      // Try to extract price
      const pricePatterns = [
        /<span[^>]*class="a-price[^"]*"[^>]*>[\s\S]*?<span[^>]*class="a-offscreen"[^>]*>([^<]+)<\/span>/i,
        /"price":\s*"([\d,]+\.?\d*)"/i,
        /\$([\d,]+\.?\d*)/i,
      ];
      
      let foundPrice = false;
      for (const pattern of pricePatterns) {
        const match = html.match(pattern);
        if (match) {
          const priceText = match[1].replace(/[^0-9.]/g, '');
          const price = parseFloat(priceText);
          if (price > 0 && price < 10000) {
            console.log(`   ‚úÖ Price found: $${price.toFixed(2)}`);
            foundPrice = true;
            break;
          }
        }
      }
      
      if (!foundPrice) {
        console.log(`   ‚ö†Ô∏è  Price not found in HTML`);
      }
    } catch (error) {
      console.log(`   ‚ùå Error: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }
  
  console.log('\n‚úÖ Test complete\n');
}

testFetch().catch(console.error);
</file>

<file path="scripts/test-recipe-diversity.ts">
import { GoalOrientedGenerator } from '../lib/utils/constraintRecipeGenerator';

async function testRecipeDiversity() {
  console.log('=== Testing Recipe Diversity ===\n');
  
  const generator = new GoalOrientedGenerator('dogs', 'adult', [], 500, 4.00);
  
  const recipes: string[] = [];
  const ingredientSets: Set<string>[] = [];
  
  console.log('Generating 10 recipes for a dog...\n');
  
  for (let i = 0; i < 10; i++) {
    const recipe = generator.generate();
    
    if (recipe && recipe.ingredients) {
      const ingredientList = recipe.ingredients
        .map((ing: any) => `${ing.name} (${ing.amount.toFixed(1)}g)`)
        .join(', ');
      
      console.log(`Recipe ${i + 1}:`);
      console.log(`  Ingredients: ${ingredientList}`);
      console.log(`  Calories: ${Math.round(recipe.nutritionalInfo.totalCalories)}`);
      const protein = typeof recipe.nutritionalInfo.protein === 'number' ? recipe.nutritionalInfo.protein : 0;
      console.log(`  Protein: ${protein.toFixed(1)}g`);
      console.log(`  Validation: ${recipe.validation?.isValid ? '‚úì PASS' : '‚úó FAIL'}`);
      console.log('');
      
      recipes.push(ingredientList);
      
      const ingSet = new Set(recipe.ingredients.map((ing: any) => ing.name));
      ingredientSets.push(ingSet);
    } else {
      console.log(`Recipe ${i + 1}: FAILED TO GENERATE\n`);
    }
  }
  
  // Analyze diversity
  console.log('=== Diversity Analysis ===\n');
  
  const uniqueRecipes = new Set(recipes).size;
  console.log(`Unique recipe combinations: ${uniqueRecipes}/10`);
  
  // Check for ingredient variation
  let totalUniqueIngredients = 0;
  const ingredientFrequency: Record<string, number> = {};
  
  for (const ingSet of ingredientSets) {
    for (const ing of ingSet) {
      ingredientFrequency[ing] = (ingredientFrequency[ing] || 0) + 1;
      totalUniqueIngredients++;
    }
  }
  
  console.log(`Total unique ingredients used: ${Object.keys(ingredientFrequency).length}`);
  console.log(`Average ingredients per recipe: ${(totalUniqueIngredients / 10).toFixed(1)}`);
  
  // Show most and least used ingredients
  const sorted = Object.entries(ingredientFrequency).sort((a, b) => b[1] - a[1]);
  console.log('\nMost used ingredients:');
  sorted.slice(0, 5).forEach(([ing, count]) => {
    console.log(`  ${ing}: ${count}/10 recipes`);
  });
  
  console.log('\nLeast used ingredients:');
  sorted.slice(-5).forEach(([ing, count]) => {
    console.log(`  ${ing}: ${count}/10 recipes`);
  });
  
  // Verdict
  console.log('\n=== Verdict ===');
  if (uniqueRecipes >= 7) {
    console.log('‚úì EXCELLENT: High diversity in recipe generation');
  } else if (uniqueRecipes >= 5) {
    console.log('‚úì GOOD: Decent diversity in recipe generation');
  } else if (uniqueRecipes >= 3) {
    console.log('‚ö† FAIR: Some repetition detected');
  } else {
    console.log('‚úó POOR: Low diversity - recipes are too similar');
  }
}

testRecipeDiversity().catch(console.error);
</file>

<file path="scripts/test-scoring.js">
// Quick test script to verify scoring logic
// Run with: node scripts/test-scoring.js

const testRecipe = {
  id: "test-1",
  name: "Joint Support Chicken Stew",
  category: "dogs",
  healthConcerns: ["joint-health", "arthritis"],
  ageGroup: ["adult", "senior"],
  ingredients: [{ name: "chicken" }, { name: "turmeric" }],
  nutritionalInfo: { protein: "High" },
  tags: ["low-calorie", "anti-inflammatory"]
};

const testPet = {
  type: "dogs",
  age: "senior",
  breed: "Labrador",
  healthConcerns: ["Arthritis/joint pain", "Obesity/weight management"],
  allergies: [],
  weightKg: 25
};

console.log("üß™ Testing Recipe Scoring");
console.log("Recipe:", testRecipe.name);
console.log("Pet:", {
  type: testPet.type,
  age: testPet.age,
  healthConcerns: testPet.healthConcerns
});

// Simulate the scoring logic
let score = 40; // Base score
console.log("\nüìä Scoring Breakdown:");
console.log(`Base score: ${score}`);

// Age match
if (testRecipe.ageGroup && testPet.age && testRecipe.ageGroup.includes(testPet.age)) {
  score += 10;
  console.log(`+10 Age match (${testPet.age})`);
}

// Health concerns
const petConcerns = (testPet.healthConcerns || []).map(c => c.toLowerCase().trim());
const recipeConcerns = (testRecipe.healthConcerns || []).map(c => c.toLowerCase().trim());

console.log("\nüíä Health Concerns:");
console.log("Pet concerns:", petConcerns);
console.log("Recipe concerns:", recipeConcerns);

let healthMatchScore = 0;
if (petConcerns.length > 0) {
  petConcerns.forEach(concern => {
    // Normalize
    const normalized = concern.replace(/[^a-z0-9]+/g, '-').toLowerCase();
    console.log(`  Checking "${concern}" -> normalized: "${normalized}"`);
    
    const hasMatch = recipeConcerns.some(rc => {
      const match = rc.includes(normalized) || normalized.includes(rc) || rc === normalized;
      if (match) console.log(`    ‚úì Matches "${rc}"`);
      return match;
    });
    
    if (hasMatch) {
      healthMatchScore += 12;
      console.log(`    +12 for match`);
    } else {
      score -= 3;
      console.log(`    -3 no match`);
    }
  });
  
  score += Math.min(healthMatchScore, 30);
  console.log(`\nHealth bonus: ${Math.min(healthMatchScore, 30)}`);
}

// Nutrition
if (testRecipe.nutritionalInfo) {
  score += 8;
  console.log(`+8 Nutrition info present`);
}

// Random variation
const randomVariation = Math.random() * 4 - 2;
score = Math.max(20, Math.min(100, score + randomVariation));

console.log(`\nüéØ Final Score: ${Math.round(score)}%`);
console.log(`Expected range: 50-70% (with health matches)`);
</file>

<file path="scripts/test-tsx.ts">
import * as fs from 'fs';
import * as path from 'path';

console.log('TEST SCRIPT RUNNING');
const testFile = path.join(process.cwd(), 'tsx-test-success.txt');
fs.writeFileSync(testFile, 'TSX is working! ' + new Date().toISOString(), 'utf8');
console.log('Test file written:', testFile);
</file>

<file path="scripts/testing/check-errors.ps1">
# PowerShell script to check for all TypeScript errors before starting dev server
# This runs TypeScript compiler in check mode without emitting files

Write-Host "üîç Checking for TypeScript errors..." -ForegroundColor Cyan
Write-Host ""

# Run TypeScript compiler in no-emit mode (type-check only)
npx tsc --noEmit

if ($LASTEXITCODE -eq 0) {
    Write-Host ""
    Write-Host "‚úÖ No TypeScript errors found!" -ForegroundColor Green
    Write-Host "   You can safely run: npm run dev" -ForegroundColor Gray
} else {
    Write-Host ""
    Write-Host "‚ùå TypeScript errors found. Fix them before starting dev server." -ForegroundColor Red
    Write-Host "   See errors above." -ForegroundColor Gray
    exit 1
}
</file>

<file path="scripts/testing/check-links.ts">
/**
 * AMAZON LINK VALIDATOR
 * Checks all 292 ingredient links for:
 * 1. HTTP 200 (valid) vs 404 (broken)
 * 2. Product title matches ingredient name
 * 3. ASIN format is correct
 * 
 * Usage:
 * 1. Save as check-links.ts
 * 2. Run: npx tsx check-links.ts
 * 3. Review output: broken-links-report.json
 */

import fs from 'fs';

interface IngredientLink {
  id: number;
  ingredient: string;
  product: string;
  category: string;
  link: string;
  asin: string;
}

// Parse your markdown file
function parseIngredientLinks(mdContent: string): IngredientLink[] {
  const ingredients: IngredientLink[] = [];
  const sections = mdContent.split('\n## ');
  
  sections.forEach(section => {
    if (!section.trim()) return;
    
    const lines = section.split('\n').filter(l => l.trim());
    if (lines.length < 4) return;
    
    const idMatch = lines[0].match(/^(\d+)\.\s*(.+)$/);
    if (!idMatch) return;
    
    const id = parseInt(idMatch[1]);
    const ingredient = idMatch[2].trim();
    
    let product = '';
    let category = '';
    let link = '';
    let asin = '';
    
    lines.forEach(line => {
      if (line.startsWith('- **Product:**')) {
        product = line.replace('- **Product:**', '').trim();
      } else if (line.startsWith('- **Category:**')) {
        category = line.replace('- **Category:**', '').trim();
      } else if (line.startsWith('- **Link:**')) {
        link = line.replace('- **Link:**', '').trim();
      } else if (line.startsWith('- **ASIN:**')) {
        asin = line.replace('- **ASIN:**', '').trim();
      }
    });
    
    if (id && ingredient && link && asin) {
      ingredients.push({ id, ingredient, product, category, link, asin });
    }
  });
  
  return ingredients;
}

// Validate ASIN format
function validateASIN(asin: string): { valid: boolean; error?: string } {
  // Amazon ASINs are 10 characters: alphanumeric
  if (!asin || asin.length !== 10) {
    return { valid: false, error: `Invalid length (${asin.length}, need 10)` };
  }
  
  if (!/^[A-Z0-9]{10}$/.test(asin)) {
    return { valid: false, error: 'Contains invalid characters (need A-Z, 0-9 only)' };
  }
  
  return { valid: true };
}

// Check if link works (HEAD request to avoid downloading full page)
async function checkLink(url: string, retries = 2): Promise<{ 
  status: number; 
  valid: boolean; 
  error?: string;
  title?: string;
}> {
  try {
    // Use HEAD request first (faster)
    const headResponse = await fetch(url, {
      method: 'HEAD',
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; LinkChecker/1.0)',
      },
      redirect: 'follow',
    });
    
    if (headResponse.ok) {
      // Link works, but we need GET to check title
      const getResponse = await fetch(url, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (compatible; LinkChecker/1.0)',
        },
      });
      
      const html = await getResponse.text();
      
      // Extract product title from Amazon page
      const titleMatch = html.match(/<title>([^<]+)<\/title>/i);
      const title = titleMatch ? titleMatch[1].replace(' : Amazon.com', '').trim() : '';
      
      return { 
        status: getResponse.status, 
        valid: true,
        title
      };
    }
    
    // If HEAD failed, try GET (some servers block HEAD)
    if (!headResponse.ok && retries > 0) {
      console.log(`HEAD failed for ${url}, retrying with GET...`);
      await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s
      
      const getResponse = await fetch(url, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (compatible; LinkChecker/1.0)',
        },
      });
      
      if (getResponse.ok) {
        const html = await getResponse.text();
        const titleMatch = html.match(/<title>([^<]+)<\/title>/i);
        const title = titleMatch ? titleMatch[1].replace(' : Amazon.com', '').trim() : '';
        
        return { 
          status: getResponse.status, 
          valid: true,
          title
        };
      }
      
      return { 
        status: getResponse.status, 
        valid: false, 
        error: `HTTP ${getResponse.status}` 
      };
    }
    
    return { 
      status: headResponse.status, 
      valid: false, 
      error: `HTTP ${headResponse.status}` 
    };
    
  } catch (error: any) {
    if (retries > 0) {
      console.log(`Error checking ${url}, retrying... (${retries} left)`);
      await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s before retry
      return checkLink(url, retries - 1);
    }
    
    return { 
      status: 0, 
      valid: false, 
      error: error.message || 'Network error' 
    };
  }
}

// Check if product title matches ingredient
function checkTitleMatch(ingredient: string, title: string): { 
  matches: boolean; 
  similarity: number;
  reason?: string;
} {
  if (!title) return { matches: false, similarity: 0, reason: 'No title found' };
  
  const ingredientLower = ingredient.toLowerCase()
    .replace(/\(.*?\)/g, '') // Remove parentheses content
    .replace(/[^a-z0-9\s]/g, '') // Remove special chars
    .trim();
  
  const titleLower = title.toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .trim();
  
  // Check if key words from ingredient are in title
  const ingredientWords = ingredientLower.split(/\s+/).filter(w => w.length > 2);
  const titleWords = new Set(titleLower.split(/\s+/));
  
  const matchedWords = ingredientWords.filter(word => titleWords.has(word));
  const similarity = matchedWords.length / ingredientWords.length;
  
  if (similarity >= 0.6) {
    return { matches: true, similarity };
  } else if (similarity >= 0.3) {
    return { 
      matches: false, 
      similarity, 
      reason: `Partial match (${Math.round(similarity * 100)}% similar)` 
    };
  } else {
    return { 
      matches: false, 
      similarity, 
      reason: `Poor match (${Math.round(similarity * 100)}% similar)` 
    };
  }
}

// Main validation function
async function validateAllLinks() {
  console.log('üîç Starting Amazon link validation...\n');
  
  // Check if file exists
  const filePath = 'ALL_INGREDIENT_LINKS.md';
  if (!fs.existsSync(filePath)) {
    console.error(`‚ùå ERROR: Could not find ${filePath}`);
    console.error(`   Current directory: ${process.cwd()}`);
    console.error(`   Please run this script from the directory containing ALL_INGREDIENT_LINKS.md`);
    process.exit(1);
  }
  
  console.log(`‚úÖ Found ${filePath}`);
  
  // Read markdown file
  let mdContent: string;
  try {
    mdContent = fs.readFileSync(filePath, 'utf-8');
    console.log(`‚úÖ Read file (${mdContent.length} characters)\n`);
  } catch (error: any) {
    console.error(`‚ùå ERROR reading file: ${error.message}`);
    process.exit(1);
  }
  
  const ingredients = parseIngredientLinks(mdContent);
  
  console.log(`Found ${ingredients.length} ingredients to check\n`);
  
  const results = {
    total: ingredients.length,
    checked: 0,
    valid: 0,
    broken: 0,
    invalidASIN: 0,
    titleMismatch: 0,
    errors: [] as any[],
  };
  
  // Check each ingredient (with rate limiting)
  for (let i = 0; i < ingredients.length; i++) {
    const ing = ingredients[i];
    
    console.log(`[${i + 1}/${ingredients.length}] Checking: ${ing.ingredient}...`);
    
    // Validate ASIN format
    const asinCheck = validateASIN(ing.asin);
    if (!asinCheck.valid) {
      results.invalidASIN++;
      results.errors.push({
        ingredient: ing.ingredient,
        issue: 'Invalid ASIN',
        details: asinCheck.error,
        asin: ing.asin,
      });
      console.log(`  ‚ùå Invalid ASIN: ${asinCheck.error}\n`);
      continue;
    }
    
    // Check link
    const linkCheck = await checkLink(ing.link);
    results.checked++;
    
    if (!linkCheck.valid) {
      results.broken++;
      results.errors.push({
        ingredient: ing.ingredient,
        issue: 'Broken link',
        details: linkCheck.error,
        link: ing.link,
        status: linkCheck.status,
      });
      console.log(`  ‚ùå Link broken: ${linkCheck.error}\n`);
      continue;
    }
    
    // Check title match
    if (linkCheck.title) {
      const titleCheck = checkTitleMatch(ing.ingredient, linkCheck.title);
      if (!titleCheck.matches) {
        results.titleMismatch++;
        results.errors.push({
          ingredient: ing.ingredient,
          issue: 'Title mismatch',
          details: titleCheck.reason,
          expectedTitle: ing.ingredient,
          actualTitle: linkCheck.title,
          link: ing.link,
        });
        console.log(`  ‚ö†Ô∏è  Title mismatch: ${titleCheck.reason}`);
        console.log(`      Expected: "${ing.ingredient}"`);
        console.log(`      Got: "${linkCheck.title}"\n`);
      } else {
        results.valid++;
        console.log(`  ‚úÖ Valid (${Math.round(titleCheck.similarity * 100)}% match)\n`);
      }
    } else {
      results.valid++;
      console.log(`  ‚úÖ Link works (couldn't verify title)\n`);
    }
    
    // Rate limiting: wait 500ms between requests to avoid being blocked
    if (i < ingredients.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  // Generate report
  console.log('\n' + '='.repeat(80));
  console.log('VALIDATION REPORT');
  console.log('='.repeat(80));
  console.log(`Total ingredients: ${results.total}`);
  console.log(`Checked: ${results.checked}`);
  console.log(`‚úÖ Valid: ${results.valid} (${Math.round(results.valid / results.checked * 100)}%)`);
  console.log(`‚ùå Broken: ${results.broken}`);
  console.log(`‚ö†Ô∏è  Invalid ASIN: ${results.invalidASIN}`);
  console.log(`‚ö†Ô∏è  Title mismatch: ${results.titleMismatch}`);
  console.log(`\nTotal issues: ${results.errors.length}`);
  
  // Save detailed report
  fs.writeFileSync(
    'broken-links-report.json',
    JSON.stringify(results, null, 2)
  );
  
  console.log('\nüìÑ Detailed report saved to: broken-links-report.json');
  
  // Print summary of issues
  if (results.errors.length > 0) {
    console.log('\n' + '='.repeat(80));
    console.log('ISSUES FOUND:');
    console.log('='.repeat(80));
    
    results.errors.forEach((error, i) => {
      console.log(`\n${i + 1}. ${error.ingredient}`);
      console.log(`   Issue: ${error.issue}`);
      console.log(`   Details: ${error.details}`);
      if (error.link) console.log(`   Link: ${error.link}`);
    });
  }
  
  return results;
}

// Run validation
validateAllLinks()
  .then(results => {
    console.log('\n‚úÖ Validation complete!');
    process.exit(results.errors.length > 0 ? 1 : 0);
  })
  .catch(error => {
    console.error('\n‚ùå Fatal error:', error);
    console.error(error.stack);
    process.exit(1);
  });
</file>

<file path="scripts/testing/debug-cat-categories.mjs">
// Debug: Check what categories cat ingredients actually have
import { getIngredientsForSpecies } from './lib/data/ingredients.js';

console.log('\n=== CAT INGREDIENT CATEGORIES DEBUG ===\n');

const catIngredients = getIngredientsForSpecies('cats');
console.log(`Total cat ingredients: ${catIngredients.length}\n`);

// Group by category
const byCategory = {};
catIngredients.forEach(ing => {
  if (!byCategory[ing.category]) {
    byCategory[ing.category] = [];
  }
  byCategory[ing.category].push(ing.name);
});

console.log('Categories found:');
Object.keys(byCategory).sort().forEach(cat => {
  console.log(`\n${cat.toUpperCase()} (${byCategory[cat].length} items):`);
  byCategory[cat].slice(0, 5).forEach(name => console.log(`  - ${name}`));
  if (byCategory[cat].length > 5) {
    console.log(`  ... and ${byCategory[cat].length - 5} more`);
  }
});

// Check specifically for the categories RecipeBuilder is looking for
console.log('\n\n=== CHECKING REQUIRED CATEGORIES ===');
const required = ['protein', 'carb', 'vegetable', 'fat'];
required.forEach(cat => {
  const count = byCategory[cat]?.length || 0;
  const status = count > 0 ? '‚úì' : '‚úó';
  console.log(`${status} ${cat}: ${count} ingredients`);
});
</file>

<file path="scripts/testing/debug-cat-ingredients.mjs">
// Quick debug to check cat ingredients
import { getIngredientsForSpecies } from './lib/data/ingredients.ts';

console.log('=== CAT INGREDIENTS DEBUG ===\n');

const catIngredients = getIngredientsForSpecies('cats');
console.log(`Total cat ingredients: ${catIngredients.length}\n`);

// Group by category
const byCategory = {};
catIngredients.forEach(ing => {
  if (!byCategory[ing.category]) {
    byCategory[ing.category] = [];
  }
  byCategory[ing.category].push(ing.name);
});

console.log('Ingredients by category:');
Object.keys(byCategory).sort().forEach(cat => {
  console.log(`\n${cat} (${byCategory[cat].length}):`);
  console.log(byCategory[cat].slice(0, 5).join(', '));
  if (byCategory[cat].length > 5) {
    console.log(`  ... and ${byCategory[cat].length - 5} more`);
  }
});

// Check specifically for carb, vegetable, fat
console.log('\n\n=== CRITICAL CATEGORIES ===');
console.log(`carb: ${byCategory['carb']?.length || 0}`);
console.log(`vegetable: ${byCategory['vegetable']?.length || 0}`);
console.log(`fat: ${byCategory['fat']?.length || 0}`);
console.log(`protein: ${byCategory['protein']?.length || 0}`);

// Check a few carb ingredients in detail
if (byCategory['carb'] && byCategory['carb'].length > 0) {
  console.log('\n\n=== SAMPLE CARB INGREDIENTS ===');
  const carbIngs = catIngredients.filter(i => i.category === 'carb').slice(0, 3);
  carbIngs.forEach(ing => {
    console.log(`\n${ing.name}:`);
    console.log(`  ID: ${ing.id}`);
    console.log(`  Category: ${ing.category}`);
    console.log(`  Cat compatibility: ${ing.compatibility.cats}`);
  });
}
</file>

<file path="scripts/testing/debug-cat-recipe-generation.mjs">
// Debug cat recipe generation step by step
import { RecipeBuilder } from './lib/generator/RecipeBuilder.ts';
import { getIngredientsForSpecies } from './lib/data/ingredients.ts';

console.log('=== CAT RECIPE GENERATION DEBUG ===\n');

// Step 1: Check available ingredients
const allCatIngredients = getIngredientsForSpecies('cats');
console.log(`Step 1: Total cat ingredients: ${allCatIngredients.length}`);

const byCategory = {};
allCatIngredients.forEach(ing => {
  if (!byCategory[ing.category]) byCategory[ing.category] = [];
  byCategory[ing.category].push(ing);
});

console.log('\nIngredients by category:');
Object.keys(byCategory).sort().forEach(cat => {
  console.log(`  ${cat}: ${byCategory[cat].length}`);
});

// Step 2: Try to generate a recipe
console.log('\n\nStep 2: Attempting recipe generation...');

const constraints = {
  species: 'cats',
  petWeightKg: 4.5,
  allergies: [],
  healthConcerns: [],
  bannedIngredients: []
};

const builder = new RecipeBuilder(constraints);

console.log('\nBuilder created, calling generate()...');
const recipe = builder.generate();

if (recipe) {
  console.log('\n‚úÖ Recipe generated successfully!');
  console.log(`Ingredients: ${recipe.ingredients.length}`);
  recipe.ingredients.forEach(ing => {
    console.log(`  - ${ing.ingredient.name} (${ing.ingredient.category}): ${ing.grams}g`);
  });
} else {
  console.log('\n‚ùå Recipe generation failed');
}

// Step 3: Check what getCandidateIngredients returns
console.log('\n\nStep 3: Checking candidate ingredients...');
const builder2 = new RecipeBuilder(constraints);
// Access private method via prototype hack for debugging
const candidates = builder2['getCandidateIngredients']();
console.log(`Candidate ingredients: ${candidates.length}`);

const candidatesByCategory = {};
candidates.forEach(ing => {
  if (!candidatesByCategory[ing.category]) candidatesByCategory[ing.category] = [];
  candidatesByCategory[ing.category].push(ing);
});

console.log('\nCandidates by category:');
Object.keys(candidatesByCategory).sort().forEach(cat => {
  console.log(`  ${cat}: ${candidatesByCategory[cat].length}`);
});
</file>

<file path="scripts/testing/debug-protein-filter.mjs">
// Debug script to check what proteins are being filtered
import { getAllIngredients } from './lib/data/unifiedIngredientRegistry.js';

const allIngredients = getAllIngredients();

// Filter for cat-compatible proteins
const catProteins = allIngredients.filter(ing => 
  ing.species.includes('cats') && 
  (ing.category === 'protein' || ing.category === 'meat' || ing.category === 'fish')
);

console.log('\n=== CAT PROTEINS ANALYSIS ===\n');
console.log(`Total cat-compatible protein ingredients: ${catProteins.length}\n`);

// Group by exotic vs core
const EXOTIC_PROTEINS = [
  'quail', 'venison', 'goat', 'elk', 'bison', 'ostrich', 'pheasant',
  'duck', 'rabbit', 'kangaroo', 'alligator', 'wild boar', 'emu', 'reindeer', 'buffalo'
];

const exotic = [];
const core = [];

catProteins.forEach(ing => {
  const isExotic = EXOTIC_PROTEINS.some(ex => ing.name.toLowerCase().includes(ex));
  if (isExotic) {
    exotic.push(ing.name);
  } else {
    core.push(ing.name);
  }
});

console.log('üü¢ CORE PROTEINS (will be used):');
console.log('='.repeat(60));
core.forEach(name => console.log(`  ‚úì ${name}`));

console.log('\nüî¥ EXOTIC PROTEINS (will be filtered out):');
console.log('='.repeat(60));
exotic.forEach(name => console.log(`  ‚úó ${name}`));

console.log('\nüìä SUMMARY:');
console.log(`Core proteins: ${core.length}`);
console.log(`Exotic proteins: ${exotic.length}`);
console.log(`Total: ${catProteins.length}`);

if (core.length < 5) {
  console.log('\n‚ö†Ô∏è  WARNING: Very few core proteins available!');
  console.log('This could cause recipe generation issues.');
}
</file>

<file path="scripts/testing/debug-shopping-list.js">
import { getVettedProduct, VETTED_PRODUCTS } from './lib/data/vetted-products.ts';

// Test what happens in ShoppingList component
console.log('Testing ShoppingList logic...\n');

// Test data that would come from a recipe
const testIngredients = [
  { id: '1', name: 'Duck Hearts', amount: '200g', asinLink: 'https://www.amazon.com/s?k=Vital%20Essentials%20freeze%20dried%20duck%20hearts&tag=robinfrench-20' },
  { id: '2', name: 'Ground chicken', amount: '200g', asinLink: 'https://www.amazon.com/dp/B0BXZVFN6G?tag=robinfrench-20' },
];

console.log('Available VETTED_PRODUCTS keys (first 5):');
console.log(Object.keys(VETTED_PRODUCTS).slice(0, 5));
console.log();

testIngredients.forEach((ingredient, i) => {
  console.log(`Testing ingredient ${i + 1}: "${ingredient.name}"`);
  console.log(`  asinLink: ${ingredient.asinLink}`);

  // Try the same logic as ShoppingList component
  let product = getVettedProduct(ingredient.name.toLowerCase());
  console.log(`  getVettedProduct("${ingredient.name.toLowerCase()}"):`, product ? 'FOUND' : 'NOT FOUND');

  if (!product) {
    product = getVettedProductByAnyIdentifier(ingredient.name);
    console.log(`  getVettedProductByAnyIdentifier("${ingredient.name}"):`, product ? 'FOUND' : 'NOT FOUND');
  }

  if (!product && ingredient.asinLink) {
    product = getVettedProductByAnyIdentifier(ingredient.asinLink);
    console.log(`  getVettedProductByAnyIdentifier("${ingredient.asinLink}"):`, product ? 'FOUND' : 'NOT FOUND');
  }

  if (product) {
    console.log(`  Product found: "${product.productName}"`);
    console.log(`  Has price:`, !!product.price);
    if (product.price) {
      console.log(`  Price: $${product.price.amount} ${product.price.currency}`);
    }
  } else {
    console.log(`  No product found for this ingredient!`);
  }

  console.log();
});
</file>

<file path="scripts/testing/test-amazon-search.js">
import https from 'https';
import http from 'http';

// Quick test of Amazon search functionality
function makeRequest(url) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;

    const options = {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9',
        'Connection': 'keep-alive',
      },
      timeout: 15000,
    };

    protocol.get(url, options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        resolve(data);
      });
    }).on('error', (err) => {
      reject(err);
    });
  });
}

// Test Amazon search for one ingredient
async function testAmazonSearch() {
  const ingredient = 'ground chicken';
  console.log(`üîç Testing Amazon search for: "${ingredient}"`);

  try {
    // Search in pet-supplies department
    const searchUrl = `https://www.amazon.com/s?k=${encodeURIComponent(ingredient)}&i=pet-supplies`;
    console.log(`URL: ${searchUrl}`);

    const html = await makeRequest(searchUrl);
    console.log(`Response length: ${html.length} characters`);

    // Extract first product ASIN
    const asinMatch = html.match(/data-asin="([A-Z0-9]{10})"/);
    if (asinMatch) {
      const asin = asinMatch[1];
      console.log(`‚úÖ Found ASIN: ${asin}`);

      // Try to extract price
      const priceMatch = html.match(/data-asin="${asin}"[\s\S]{0,1000}?\$([0-9,]+\.[0-9]{2})/);
      if (priceMatch) {
        console.log(`üí∞ Found price: $${priceMatch[1]}`);
      } else {
        console.log(`‚ö†Ô∏è  No price found in search results`);
      }
    } else {
      console.log(`‚ùå No ASIN found in search results`);
    }

  } catch (error) {
    console.error(`‚ùå Search failed: ${error.message}`);
  }
}

testAmazonSearch();
</file>

<file path="scripts/testing/test-asin-count.js">
import fs from 'fs';

// Quick test to count ingredients and test parsing
function parseVettedProductsFile(filePath) {
  console.log(`üìñ Reading file: ${filePath}`);

  const content = fs.readFileSync(filePath, 'utf-8');
  const products = {};

  // Match entries like: 'ingredient-name': { ... }
  const lines = content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const ingredientMatch = line.match(/'([^']+)':\s*{/);

    if (ingredientMatch) {
      const ingredient = ingredientMatch[1];

      // Extract the object block
      let block = '';
      let braceCount = 1;
      let j = i + 1;

      while (j < lines.length && braceCount > 0) {
        block += lines[j] + '\n';
        braceCount += (lines[j].match(/{/g) || []).length;
        braceCount -= (lines[j].match(/}/g) || []).length;
        j++;
      }

      // Extract fields
      const productNameMatch = block.match(/productName:\s*'([^']+)'/);
      const asinLinkMatch = block.match(/asinLink:\s*'([^']+)'/);

      products[ingredient] = {
        productName: productNameMatch ? productNameMatch[1] : '',
        asinLink: asinLinkMatch ? asinLinkMatch[1] : '',
      };
    }
  }

  return products;
}

// Test parsing
console.log('Testing ingredient parsing...\n');

const products = parseVettedProductsFile('lib/data/vetted-products.txt');
const count = Object.keys(products).length;

console.log(`‚úÖ Found ${count} ingredients\n`);

console.log('First 5 ingredients:');
Object.keys(products).slice(0, 5).forEach((key, i) => {
  console.log(`${i + 1}. ${key} -> "${products[key].productName}"`);
});

console.log('\nSample ASIN extractions:');
Object.keys(products).slice(0, 3).forEach(key => {
  const link = products[key].asinLink;
  const asinMatch = link.match(/\/dp\/([A-Z0-9]{10})/);
  const asin = asinMatch ? asinMatch[1] : 'NOT FOUND';
  console.log(`${key}: ${asin} (${link ? 'HAS LINK' : 'NO LINK'})`);
});
</file>

<file path="scripts/testing/test-automatic-research.js">
// Test script to verify automatic research integration
const { generateRecipe, getRecipeTemplates } = require('./lib/recipe-generator.ts');

async function testAutomaticResearchIntegration() {
  console.log('üß™ Testing AUTOMATIC research-enhanced recipe generation...\n');

  try {
    // Generate a recipe - should automatically load and integrate research data
    console.log('üë®‚Äçüç≥ Generating recipe with automatic research integration...');
    const dogTemplate = getRecipeTemplates('dogs', 'cooked')[0];
    const recipe = await generateRecipe({ template: dogTemplate });

    console.log(`‚úÖ Generated: ${recipe.name}`);
    console.log(`üìù Description: ${recipe.description}`);
    console.log(`‚≠ê Rating: ${recipe.rating}/5.0`);
    console.log(`üè∑Ô∏è  Tags: ${recipe.tags.join(', ')}`);
    console.log(`ü•¶ Ingredients: ${recipe.ingredients.map(i => i.name).join(', ')}`);
    console.log();

    // Check if research validation was applied
    if (recipe.researchValidation) {
      console.log('üî¨ Research Validation Applied:');
      console.log(`   üìä Score: ${recipe.researchValidation.score}/10`);
      console.log('   üí° Recommendations:');
      recipe.researchValidation.recommendations.forEach(rec => {
        console.log(`      ‚Ä¢ ${rec}`);
      });
      console.log();
    } else {
      console.log('‚ö†Ô∏è  No research validation applied (research data may not be available)');
      console.log();
    }

    // Check if research-enhanced ingredients were used
    const researchIngredients = recipe.ingredients.filter(ing =>
      ing.name.toLowerCase().includes('guinea pig') ||
      ing.name.toLowerCase().includes('turkey') ||
      recipe.description.includes('Research-validated')
    );

    if (researchIngredients.length > 0) {
      console.log('üéØ Research-Enhanced Ingredients Detected:');
      researchIngredients.forEach(ing => {
        console.log(`   ‚Ä¢ ${ing.name}`);
      });
      console.log();
    }

    // Check rating boost from research
    if (recipe.rating > 4.5) {
      console.log(`üöÄ Rating boosted by research validation: +${(recipe.rating - 4.5).toFixed(1)} stars`);
      console.log();
    }

    console.log('üéâ Automatic research integration test completed!');
    console.log('‚ú® Recipes now automatically include veterinary + community intelligence!');

  } catch (error) {
    console.error('‚ùå Automatic research integration test failed:', error);
  }
}

testAutomaticResearchIntegration();
</file>

<file path="scripts/testing/test-enhance.ts">
import * as fs from 'fs';
import * as path from 'path';

const output: string[] = [];

function log(msg: string) {
  console.log(msg);
  output.push(msg);
}

const recipesPath = path.join(process.cwd(), 'lib', 'data', 'recipes-complete.ts');
log('Reading file: ' + recipesPath);
log('File exists: ' + fs.existsSync(recipesPath));

if (fs.existsSync(recipesPath)) {
  const fileContent = fs.readFileSync(recipesPath, 'utf8');
  log('File size: ' + fileContent.length);
  log('First 200 chars: ' + fileContent.substring(0, 200));
  
  const arrayStart = fileContent.indexOf('export const recipes: Recipe[] = [');
  log('Array start position: ' + arrayStart);
  
  if (arrayStart === -1) {
    const altStart = fileContent.indexOf('export const recipes = [');
    log('Alt start position: ' + altStart);
  }
}

// Write output to file
fs.writeFileSync('test-output.txt', output.join('\n'), 'utf8');
log('Output written to test-output.txt');
</file>

<file path="scripts/testing/test-final.ts">
import { getRecipeTemplates, generateRecipe } from './lib/recipe-generator.ts';

console.log('üß™ FINAL TEST - Nutrition Integration\n');

const templates = getRecipeTemplates('dogs');
const recipe = generateRecipe({
  template: templates[0],
  pet: {
    id: 'test',
    name: 'Test',
    type: 'dog',
    age: '3',
    weight: '15',
    healthConcerns: [],
    allergies: [],
  }
});

console.log('‚úÖ Recipe:', recipe.name);
console.log('üìä Nutrition:', {
  calories: recipe.nutritionalCalculation.calories,
  protein: recipe.nutritionalCalculation.protein,
  fat: recipe.nutritionalCalculation.fat,
  fiber: recipe.nutritionalCalculation.fiber,
  calcium: recipe.nutritionalCalculation.calcium,
  phosphorus: recipe.nutritionalCalculation.phosphorus,
  caP_ratio: (recipe.nutritionalCalculation as any).caP_ratio || 'Not in interface yet',
});

console.log('\nüéâ NUTRITION INTEGRATION IS WORKING!');
</file>

<file path="scripts/testing/test-functions.js">
// Quick test to verify the functions work
import { getGenericIngredientName, getVettedProductByAnyIdentifier, VETTED_PRODUCTS } from './lib/data/vetted-products.ts';

console.log('Testing getGenericIngredientName...');
const result1 = getGenericIngredientName('Ground chicken (Freeze Dried)');
console.log('Result:', result1);

console.log('Testing getVettedProductByAnyIdentifier...');
const result2 = getVettedProductByAnyIdentifier('ground chicken');
console.log('Result:', result2 ? result2.productName : 'Not found');

console.log('VETTED_PRODUCTS has', Object.keys(VETTED_PRODUCTS).length, 'entries');
</file>

<file path="scripts/testing/test-imports.ts">
console.log('Starting import test...');
try {
  const { dogCelebrities } = require('../lib/data/celebrity-pets-complete');
  console.log('Import successful!');
  console.log('Dog celebrities count:', dogCelebrities?.length || 0);
  const fs = require('fs');
  fs.writeFileSync('import-test-success.txt', 'SUCCESS', 'utf8');
} catch (error: any) {
  console.error('Import failed:', error.message);
  const fs = require('fs');
  fs.writeFileSync('import-test-error.txt', error.message + '\n' + error.stack, 'utf8');
}
</file>

<file path="scripts/testing/test-integration.js">
// Test script to demonstrate scraped data integration
const { loadAndIntegrateScrapedData, generateRecipe, getRecipeTemplates, validateRecipeWithScrapedData } = require('./lib/recipe-generator.ts');

async function testIntegration() {
  console.log('üß™ Testing scraped data integration...\n');

  try {
    // Load and integrate scraped data
    console.log('üìä Loading scraped research data...');
    const { enhancedIngredients, healthInsights, insights } = await loadAndIntegrateScrapedData();

    console.log(`‚úÖ Loaded ${enhancedIngredients.length} enhanced ingredients`);
    console.log(`üìà Found ${Object.keys(insights.commonIngredients).length} common ingredients from research`);
    console.log(`üè• Identified ${Object.keys(insights.healthFocusAreas).length} health focus areas\n`);

    // Display insights
    console.log('üîç Research Insights:');
    console.log('Common Ingredients:', insights.commonIngredients);
    console.log('Health Focus Areas:', insights.healthFocusAreas);
    console.log();

    // Generate a recipe using research data
    console.log('üë®‚Äçüç≥ Generating research-enhanced recipe...');
    const dogTemplate = getRecipeTemplates('dogs', 'cooked')[0];
    const recipe = generateRecipe({ template: dogTemplate });

    console.log(`‚úÖ Generated: ${recipe.name}`);
    console.log(`üìù Description: ${recipe.description}`);
    console.log(`ü•¶ Ingredients: ${recipe.ingredients.map(i => i.name).join(', ')}`);
    console.log();

    // Validate recipe against research
    console.log('üî¨ Validating recipe against veterinary research...');
    const validation = validateRecipeWithScrapedData(recipe, insights, healthInsights, 'dogs');

    console.log(`‚≠ê Research Validation Score: ${validation.score}/10`);
    console.log('üí° Recommendations:');
    validation.recommendations.forEach(rec => console.log(`   ‚Ä¢ ${rec}`));

    console.log('\nüéâ Integration test completed successfully!');

  } catch (error) {
    console.error('‚ùå Integration test failed:', error);
  }
}

testIntegration();
</file>

<file path="scripts/testing/test-link.js">
// Quick test of the research-backed product links
const { getBestAffiliateLink, getResearchBackedProduct } = require('./lib/data/vetted-products-new.js');

console.log('Testing ingredient key matching:');
console.log('Ground Chicken ->', getResearchBackedProduct('Ground Chicken'));
console.log('Ground Turkey ->', getResearchBackedProduct('Ground Turkey'));
console.log('Sweet Potato ->', getResearchBackedProduct('Sweet Potato'));

console.log('\nTesting affiliate links:');
console.log('Ground Chicken ->', getBestAffiliateLink('Ground Chicken'));
console.log('Ground Turkey ->', getBestAffiliateLink('Ground Turkey'));
console.log('Sweet Potato ->', getBestAffiliateLink('Sweet Potato'));
</file>

<file path="scripts/testing/test-recipe-diversity.ts">
// Test script to verify recipe diversity
import { GoalOrientedGenerator } from '@/lib/utils/constraintRecipeGenerator';

async function testRecipeDiversity() {
  console.log('=== Testing Recipe Diversity ===\n');
  
  const generator = new GoalOrientedGenerator('dogs', 'adult', [], 500, 4.00);
  
  const recipes: string[] = [];
  const ingredientSets: Set<string>[] = [];
  
  console.log('Generating 10 recipes for a dog...\n');
  
  for (let i = 0; i < 10; i++) {
    const recipe = generator.generate();
    
    if (recipe && recipe.ingredients) {
      const ingredientList = recipe.ingredients
        .map(ing => `${ing.name} (${ing.amount.toFixed(1)}g)`)
        .join(', ');
      
      console.log(`Recipe ${i + 1}:`);
      console.log(`  Ingredients: ${ingredientList}`);
      console.log(`  Calories: ${recipe.nutritionalInfo.totalCalories.toFixed(0)}`);
      console.log(`  Protein: ${recipe.nutritionalInfo.protein.toFixed(1)}g`);
      console.log(`  Validation: ${recipe.validation.isValid ? '‚úì PASS' : '‚úó FAIL'}`);
      console.log('');
      
      recipes.push(ingredientList);
      
      // Track unique ingredient combinations
      const ingSet = new Set(recipe.ingredients.map(ing => ing.name));
      ingredientSets.push(ingSet);
    } else {
      console.log(`Recipe ${i + 1}: FAILED TO GENERATE\n`);
    }
  }
  
  // Analyze diversity
  console.log('=== Diversity Analysis ===\n');
  
  const uniqueRecipes = new Set(recipes).size;
  console.log(`Unique recipe combinations: ${uniqueRecipes}/10`);
  
  // Check for ingredient variation
  let totalUniqueIngredients = 0;
  const ingredientFrequency: Record<string, number> = {};
  
  for (const ingSet of ingredientSets) {
    for (const ing of ingSet) {
      ingredientFrequency[ing] = (ingredientFrequency[ing] || 0) + 1;
      totalUniqueIngredients++;
    }
  }
  
  console.log(`Total unique ingredients used: ${Object.keys(ingredientFrequency).length}`);
  console.log(`Average ingredients per recipe: ${(totalUniqueIngredients / 10).toFixed(1)}`);
  
  // Show most and least used ingredients
  const sorted = Object.entries(ingredientFrequency).sort((a, b) => b[1] - a[1]);
  console.log('\nMost used ingredients:');
  sorted.slice(0, 5).forEach(([ing, count]) => {
    console.log(`  ${ing}: ${count}/10 recipes`);
  });
  
  console.log('\nLeast used ingredients:');
  sorted.slice(-5).forEach(([ing, count]) => {
    console.log(`  ${ing}: ${count}/10 recipes`);
  });
  
  // Verdict
  console.log('\n=== Verdict ===');
  if (uniqueRecipes >= 7) {
    console.log('‚úì EXCELLENT: High diversity in recipe generation');
  } else if (uniqueRecipes >= 5) {
    console.log('‚úì GOOD: Decent diversity in recipe generation');
  } else if (uniqueRecipes >= 3) {
    console.log('‚ö† FAIR: Some repetition detected');
  } else {
    console.log('‚úó POOR: Low diversity - recipes are too similar');
  }
}

testRecipeDiversity().catch(console.error);
</file>

<file path="scripts/testing/test-script.ts">
console.log('Script is running!');
console.log('Current directory:', process.cwd());
console.log('Script completed successfully');
</file>

<file path="scripts/training/add-manual-products.ts">
/**
 * Add manually provided cat and reptile products to commercial dataset
 */

import * as fs from 'fs/promises';

const CAT_PRODUCTS = [
  { name: "Chicken Feast", ingredients: ["Chicken", "Chicken Broth", "Meat By-Products"] },
  { name: "Chopped Grill Feast", ingredients: ["Meat Broth", "Meat By-Products", "Chicken"] },
  { name: "Cod, Sole & Shrimp Feast", ingredients: ["Cod", "Fish", "Meat By-Products"] },
  { name: "Ocean Whitefish & Tuna Feast", ingredients: ["Ocean Whitefish", "Fish", "Meat By-Products"] },
  { name: "Salmon & Shrimp Feast", ingredients: ["Salmon", "Meat By-Products", "Liver"] },
  { name: "Savory Salmon Feast", ingredients: ["Salmon", "Meat By-Products", "Liver"] },
  { name: "Seafood Feast", ingredients: ["Ocean Fish", "Meat By-Products", "Fish Broth"] },
  { name: "Tender Beef Feast", ingredients: ["Beef", "Beef Broth", "Meat By-Products"] },
  { name: "Tender Beef & Chicken Feast", ingredients: ["Meat Broth", "Beef", "Chicken"] },
  { name: "Tender Beef & Liver Feast", ingredients: ["Beef", "Beef Broth", "Liver"] },
  { name: "Tender Chicken & Liver Feast", ingredients: ["Chicken", "Chicken Broth", "Liver"] },
  { name: "Turkey & Giblets Feast", ingredients: ["Turkey", "Poultry Giblets", "Meat By-Products"] },
  { name: "Grilled Beef Feast in Gravy", ingredients: ["Beef Broth", "Beef", "Wheat Gluten"] },
  { name: "Grilled Chicken Feast in Gravy", ingredients: ["Chicken Broth", "Chicken", "Wheat Gluten"] },
  { name: "Grilled Liver & Chicken Feast in Gravy", ingredients: ["Chicken Broth", "Liver", "Chicken"] },
  { name: "Grilled Ocean Whitefish & Tuna Feast in Gravy", ingredients: ["Fish Broth", "Meat By-Products", "Wheat Gluten"] },
  { name: "Grilled Salmon Feast in Gravy", ingredients: ["Fish Broth", "Salmon", "Wheat Gluten"] },
  { name: "Grilled Salmon & Shrimp Feast in Gravy", ingredients: ["Fish Broth", "Salmon", "Wheat Gluten"] },
  { name: "Grilled Seafood Feast in Gravy", ingredients: ["Fish Broth", "Ocean Fish", "Wheat Gluten"] },
  { name: "Grilled Tuna Feast in Gravy", ingredients: ["Fish Broth", "Tuna", "Wheat Gluten"] },
  { name: "Grilled Turkey Feast in Gravy", ingredients: ["Turkey Broth", "Turkey", "Wheat Gluten"] },
  { name: "Beef Feast in Gravy", ingredients: ["Poultry Broth", "Turkey", "Liver"] },
  { name: "Chicken Feast in Gravy", ingredients: ["Chicken Broth", "Chicken", "Liver"] },
  { name: "Ocean Whitefish & Tuna Feast in Gravy", ingredients: ["Fish Broth", "Ocean Whitefish", "Tuna"] },
  { name: "Salmon & Sole Feast in Gravy", ingredients: ["Fish Broth", "Salmon", "Sole"] },
  { name: "Turkey Feast in Gravy", ingredients: ["Poultry Broth", "Turkey", "Liver"] },
  { name: "Chicken & Beef Feast in Gravy", ingredients: ["Chicken Broth", "Chicken", "Liver"] },
  { name: "Flaked Chicken & Tuna Feast", ingredients: ["Chicken", "Fish", "Chicken Broth"] },
  { name: "Flaked Fish & Shrimp Feast", ingredients: ["Fish Broth", "Fish", "Shrimp"] },
  { name: "Flaked Salmon & Ocean Whitefish Feast", ingredients: ["Fish Broth", "Salmon", "Ocean Whitefish"] },
  { name: "Flaked Tuna Feast", ingredients: ["Fish Broth", "Tuna", "Fish"] },
  { name: "Flaked Tuna & Mackerel Feast", ingredients: ["Fish Broth", "Tuna", "Mackerel"] },
  { name: "Flaked Trout Feast", ingredients: ["Fish Broth", "Trout", "Fish"] },
  { name: "Chunky Chicken Feast", ingredients: ["Chicken Broth", "Chicken", "Meat By-Products"] },
  { name: "Chunky Chopped Grill Feast", ingredients: ["Meat Broth", "Meat By-Products", "Chicken"] },
  { name: "Chunky Turkey Feast", ingredients: ["Turkey Broth", "Turkey", "Meat By-Products"] },
  { name: "White Meat Chicken Florentine", ingredients: ["Poultry Broth", "Chicken", "Wheat Gluten"] },
  { name: "Wild Salmon Primavera", ingredients: ["Fish Broth", "Salmon", "Wheat Gluten"] },
  { name: "Tuna Tuscany", ingredients: ["Fish Broth", "Tuna", "Wheat Gluten"] },
  { name: "Beef Ragu & Pasta", ingredients: ["Beef Broth", "Beef", "Wheat Gluten"] },
  { name: "Turkey Primavera", ingredients: ["Turkey Broth", "Turkey", "Wheat Gluten"] },
  { name: "Wild Salmon Florentine", ingredients: ["Fish Broth", "Salmon", "Wheat Gluten"] },
  { name: "Beef Recipe Pat√©", ingredients: ["Beef", "Meat Broth", "Liver"] },
  { name: "Chicken Recipe Pat√©", ingredients: ["Chicken", "Chicken Broth", "Liver"] },
  { name: "Salmon Recipe Pat√©", ingredients: ["Salmon", "Fish Broth", "Fish"] },
  { name: "Trout Recipe Pat√©", ingredients: ["Trout", "Fish Broth", "Fish"] },
  { name: "Tuna Recipe Pat√©", ingredients: ["Tuna", "Fish Broth", "Fish"] },
  { name: "White Meat Chicken Recipe Pat√©", ingredients: ["Chicken", "Chicken Broth", "Liver"] },
  { name: "Wild Alaskan Salmon Recipe Pat√©", ingredients: ["Salmon", "Fish Broth", "Fish"] },
  { name: "Grilled Chicken Feast & Cheddar", ingredients: ["Chicken Broth", "Chicken", "Wheat Gluten"] },
  { name: "Grilled Turkey Feast & Cheddar", ingredients: ["Turkey Broth", "Turkey", "Wheat Gluten"] },
  { name: "Whitefish & Cheddar Cheese Feast", ingredients: ["Fish Broth", "Ocean Whitefish", "Wheat Gluten"] },
  { name: "Pat√© with Chicken & Gravy Center", ingredients: ["Chicken", "Chicken Broth", "Meat By-Products"] },
  { name: "Pat√© with Beef & Gravy Center", ingredients: ["Beef", "Beef Broth", "Meat By-Products"] },
  { name: "Pat√© with Salmon & Gravy Center", ingredients: ["Salmon", "Fish Broth", "Fish"] },
  { name: "Pat√© with Tuna & Gravy Center", ingredients: ["Tuna", "Fish Broth", "Fish"] },
  { name: "Gems Mousse Chicken", ingredients: ["Chicken", "Chicken Broth", "Liver"] },
  { name: "Gems Mousse Beef", ingredients: ["Beef", "Beef Broth", "Liver"] },
  { name: "Gems Mousse Salmon", ingredients: ["Salmon", "Fish Broth", "Fish"] },
  { name: "Gems Mousse Tuna", ingredients: ["Tuna", "Fish Broth", "Fish"] },
  { name: "Creamy Delights Chicken Feast", ingredients: ["Chicken", "Poultry Broth", "Liver"] },
  { name: "Creamy Delights Tuna Feast", ingredients: ["Tuna", "Fish Broth", "Fish"] },
  { name: "Creamy Delights Salmon Feast", ingredients: ["Salmon", "Fish Broth", "Fish"] },
  { name: "Kitten Classic Pat√© Chicken Feast", ingredients: ["Chicken", "Poultry Broth", "Liver"] },
  { name: "Kitten Classic Pat√© Turkey & Whitefish Feast", ingredients: ["Turkey", "Poultry Broth", "Liver"] },
  { name: "Kitten Gravy Lovers Poultry & Beef", ingredients: ["Poultry Broth", "Turkey", "Liver"] },
  { name: "High Protein Senior 7+ Chicken Feast Pat√©", ingredients: ["Chicken", "Poultry Broth", "Liver"] },
  { name: "High Protein Senior 7+ Chicken Minced Gravy", ingredients: ["Chicken Broth", "Chicken", "Wheat Gluten"] },
];

const POCKET_PET_PRODUCTS = [
  { name: "Oxbow Essentials Hamster & Gerbil Food", ingredients: ["Whole Brown Rice", "Oat Groats", "Wheat Bran"] },
  { name: "Oxbow Essentials Cavy Cuisine Adult Guinea Pig Food", ingredients: ["Timothy Meal", "Soybean Hulls", "Soybean Meal"] },
  { name: "Oxbow Essentials Adult Rabbit Food", ingredients: ["Timothy Meal", "Soybean Hulls", "Soybean Meal"] },
  { name: "Oxbow Essentials Adult Rat Food", ingredients: ["Whole Brown Rice", "Oat Groats", "Wheat Bran"] },
  { name: "Oxbow Essentials Adult Mouse Food", ingredients: ["Whole Brown Rice", "Oat Groats", "Wheat Bran"] },
  { name: "Wysong Epigen 90 Ferret Food", ingredients: ["Chicken Meal", "Organic Chicken", "Chicken By-Products"] },
  { name: "Oxbow Essentials Chinchilla Food", ingredients: ["Alfalfa Meal", "Soybean Hulls", "Soybean Meal"] },
  { name: "Exotic Nutrition HPW Diet Sugar Glider", ingredients: ["Water", "Dried Whey Protein Concentrate", "Honey"] },
  { name: "Exotic Nutrition HPW Diet Hedgehog", ingredients: ["Water", "Dried Whey Protein Concentrate", "Honey"] },
];

const REPTILE_PRODUCTS = [
  { name: "Can O' Crickets", ingredients: ["Crickets", "Water"] },
  { name: "Can O' Mealworms", ingredients: ["Mealworms", "Water"] },
  { name: "Can O' Superworms", ingredients: ["Superworms", "Water"] },
  { name: "Can O' Snails", ingredients: ["Snails", "Water"] },
  { name: "Can O' Silkworms", ingredients: ["Silkworms", "Water"] },
  { name: "Blue Tongue Skink & Tegu Food", ingredients: ["Chicken", "Soybean Meal", "Ground Corn"] },
  { name: "Box Turtle Food", ingredients: ["Apple", "Corn Meal", "Whole Corn"] },
  { name: "Tortoise & Omnivorous Lizard Food", ingredients: ["Opuntia Cactus", "Whole Peas", "Apples"] },
  { name: "Gourmet-Style Crickets", ingredients: ["Crickets", "Water"] },
  { name: "Gourmet-Style Mealworms", ingredients: ["Mealworms", "Water"] },
  { name: "Gourmet-Style Grasshoppers", ingredients: ["Grasshoppers", "Water"] },
  { name: "Gourmet Canned Omnivore Mix", ingredients: ["Mealworms", "Squash", "Carrots"] },
  { name: "Gourmet Canned Mixed Insects", ingredients: ["Superworms", "Grasshoppers", "Dubia Roaches"] },
  { name: "Tinned Crickets", ingredients: ["Crickets", "Water"] },
  { name: "Tinned Mealworms", ingredients: ["Mealworms", "Water"] },
  { name: "Tinned Grasshoppers", ingredients: ["Grasshoppers", "Water"] },
  { name: "Tinned Super Worms", ingredients: ["Morio Worms", "Water"] },
  { name: "Zoo Med Bearded Dragon Food Pellets", ingredients: ["Soybean Meal", "Ground Corn", "Calcium Carbonate"] },
  { name: "Repashy Beardie Buffet", ingredients: ["Insect Meal", "Dried Potato", "Dried Fruit"] },
  { name: "Repashy Leopard Gecko Classic", ingredients: ["Insect meal", "Dried Potato", "Dried Fruit"] },
  { name: "Repashy Grub Pie", ingredients: ["Insect meal", "Dried Potato", "Dried Fruit"] },
  { name: "Repashy Bluey Buffet", ingredients: ["Insect meal", "Grain products", "Plant products"] },
  { name: "Repashy Crested Gecko MRP", ingredients: ["Dried Fruit", "Insect meal", "Whey Protein"] },
  { name: "Hikari DragonGel", ingredients: ["Mealworm meal", "Japanese mustard spinach", "Soybean meal"] },
  { name: "Hikari LeopaGel", ingredients: ["Mealworm meal", "Silkworm meal", "Soybean meal"] },
  { name: "Tetra ReptoMin Floating Food Sticks", ingredients: ["Fish Meal", "Ground Corn", "Oat Meal"] },
  { name: "Exo Terra Tortoise Food Flower & Fruit", ingredients: ["Dried Grass Meal", "Dried Chicory Root", "Dried Mango"] },
  { name: "Zoo Med Iguana Food Adult Formula", ingredients: ["Timothy Meal", "Alfalfa Meal", "Ground Corn"] },
];

const BIRD_PRODUCTS = [
  { name: "ZuPreem FruitBlend Small Bird Food", ingredients: ["Ground Corn", "Soybean Meal", "Ground Wheat"] },
  { name: "ZuPreem FruitBlend Medium Bird Food", ingredients: ["Ground Corn", "Soybean Meal", "Ground Wheat"] },
  { name: "ZuPreem FruitBlend Large Bird Food", ingredients: ["Ground Corn", "Soybean Meal", "Ground Wheat"] },
  { name: "Higgins Sunburst Gourmet Canary & Finch Food", ingredients: ["Canary Grass Seed", "White Proso Millet", "Red Millet"] },
  { name: "Harrison's Adult Lifetime Coarse Bird Food", ingredients: ["Organic Ground Whole Yellow Corn", "Organic Ground Whole Hulless Barley", "Organic Hulled Gray Millet"] },
  { name: "Lafeber's Nutri-Berries General Parrot", ingredients: ["Hulled White Proso Millet", "Ground Oats", "Safflower Seed"] },
];

function normalizeIngredient(name: string): string {
  const lower = name.toLowerCase().trim();
  
  // Skip water and broth
  if (lower.includes('water') || lower.includes('broth')) return 'skip';
  
  // CRITICAL: Preserve oil variants (fish_oil, salmon_oil, anchovy_oil, etc.)
  // These must NOT collapse to base ingredients
  if (lower.includes('anchovy') && lower.includes('oil')) return 'anchovy_oil';
  if (lower.includes('sardine') && lower.includes('oil')) return 'sardine_oil';
  if (lower.includes('salmon') && lower.includes('oil')) return 'salmon_oil';
  if (lower.includes('fish') && lower.includes('oil')) return 'fish_oil';
  if (lower.includes('cod') && lower.includes('oil')) return 'cod_liver_oil';
  if (lower.includes('chicken') && lower.includes('fat')) return 'chicken_fat';
  if (lower.includes('duck') && lower.includes('fat')) return 'duck_fat';
  if (lower.includes('beef') && lower.includes('fat')) return 'beef_fat';
  if (lower.includes('pork') && lower.includes('fat')) return 'pork_fat';
  if (lower.includes('coconut') && lower.includes('oil')) return 'coconut_oil';
  if (lower.includes('olive') && lower.includes('oil')) return 'olive_oil';
  if (lower.includes('sunflower') && lower.includes('oil')) return 'sunflower_oil';
  if (lower.includes('flaxseed') && lower.includes('oil')) return 'flaxseed_oil';
  if (lower.includes('canola') && lower.includes('oil')) return 'canola_oil';
  
  // Proteins (only after checking for oils/fats)
  if (lower.includes('chicken')) return 'chicken';
  if (lower.includes('beef')) return 'beef';
  if (lower.includes('turkey') || lower.includes('poultry giblets')) return 'turkey';
  if (lower.includes('salmon')) return 'salmon';
  if (lower.includes('tuna')) return 'tuna';
  if (lower.includes('cod')) return 'cod';
  if (lower.includes('whitefish') || lower.includes('ocean fish')) return 'whitefish';
  if (lower.includes('sole')) return 'sole';
  if (lower.includes('mackerel')) return 'mackerel';
  if (lower.includes('trout')) return 'trout';
  if (lower.includes('shrimp')) return 'shrimp';
  if (lower.includes('fish')) return 'fish';
  if (lower.includes('liver')) return 'liver';
  if (lower.includes('duck')) return 'duck';
  if (lower.includes('lamb')) return 'lamb';
  if (lower.includes('pork')) return 'pork';
  if (lower.includes('venison')) return 'venison';
  if (lower.includes('rabbit')) return 'rabbit';
  
  // Skip category tokens (they poison PMI)
  if (lower === 'meat' || lower === 'meats') return 'skip';
  if (lower === 'grain' || lower === 'grains') return 'skip';
  if (lower === 'vegetable' || lower === 'vegetables') return 'skip';
  if (lower === 'fat' || lower === 'fats') return 'skip';
  if (lower === 'oil' || lower === 'oils') return 'skip';
  
  // Insects
  if (lower.includes('cricket')) return 'crickets';
  if (lower.includes('mealworm')) return 'mealworms';
  if (lower.includes('superworm')) return 'superworms';
  if (lower.includes('grasshopper')) return 'grasshoppers';
  if (lower.includes('roach')) return 'roaches';
  if (lower.includes('snail')) return 'snails';
  if (lower.includes('silkworm')) return 'silkworms';
  if (lower.includes('insect')) return 'insect_meal';
  
  // Grains
  if (lower.includes('wheat gluten') || lower.includes('wheat')) return 'wheat';
  if (lower.includes('corn')) return 'corn';
  if (lower.includes('rice')) return 'rice';
  if (lower.includes('soybean')) return 'soybean';
  if (lower.includes('oat')) return 'oats';
  if (lower.includes('barley')) return 'barley';
  if (lower.includes('millet')) return 'millet';
  
  // Hay/Grass
  if (lower.includes('timothy')) return 'timothy_hay';
  if (lower.includes('alfalfa')) return 'alfalfa';
  if (lower.includes('grass')) return 'grass';
  
  // Seeds
  if (lower.includes('safflower')) return 'safflower_seed';
  if (lower.includes('seed')) return 'seed';
  
  // Vegetables/Fruits
  if (lower.includes('carrot')) return 'carrot';
  if (lower.includes('peas')) return 'peas';
  if (lower.includes('squash')) return 'squash';
  if (lower.includes('potato')) return 'potato';
  if (lower.includes('apple')) return 'apple';
  if (lower.includes('mango')) return 'mango';
  if (lower.includes('banana')) return 'banana';
  if (lower.includes('cactus')) return 'cactus';
  if (lower.includes('spinach')) return 'greens';
  if (lower.includes('chicory')) return 'chicory';
  
  // Other
  if (lower.includes('whey protein')) return 'whey_protein';
  if (lower.includes('honey')) return 'honey';
  if (lower.includes('egg')) return 'egg';
  if (lower.includes('calcium')) return 'skip'; // Skip supplements
  
  return 'skip';
}

async function addManualProducts() {
  console.log('\nüìä Adding manual products (cats, reptiles, pocket pets, birds)...\n');
  
  // Load existing data
  const existing = JSON.parse(await fs.readFile('./output/commercial-top-ingredients.json', 'utf-8'));
  
  const ingredientFrequency = { ...existing.ingredientFrequency };
  const topIngredientPairs = { ...existing.topIngredientPairs };
  
  let catCount = 0;
  let reptileCount = 0;
  let pocketPetCount = 0;
  let birdCount = 0;
  
  // Helper to process products
  const processProducts = (products: typeof CAT_PRODUCTS) => {
    let count = 0;
    for (const product of products) {
      const ingredients = product.ingredients
        .map(normalizeIngredient)
        .filter(i => i !== 'skip');
      
      // CRITICAL: Deduplicate ingredient IDs per product (avoid beef+beef, egg+egg)
      const uniqueIngredients = Array.from(new Set(ingredients));
      
      if (uniqueIngredients.length >= 2) {
        count++;
        
        // Count ingredients
        uniqueIngredients.forEach(ing => {
          ingredientFrequency[ing] = (ingredientFrequency[ing] || 0) + 1;
        });
        
        // Count pairs
        for (let i = 0; i < uniqueIngredients.length; i++) {
          for (let j = i + 1; j < uniqueIngredients.length; j++) {
            const pair = [uniqueIngredients[i], uniqueIngredients[j]].sort().join('|');
            topIngredientPairs[pair] = (topIngredientPairs[pair] || 0) + 1;
          }
        }
      }
    }
    return count;
  };
  
  // Process all product types
  catCount = processProducts(CAT_PRODUCTS);
  reptileCount = processProducts(REPTILE_PRODUCTS);
  pocketPetCount = processProducts(POCKET_PET_PRODUCTS);
  birdCount = processProducts(BIRD_PRODUCTS);
  
  console.log(`‚úÖ Added ${catCount} cat products`);
  console.log(`‚úÖ Added ${reptileCount} reptile products`);
  console.log(`‚úÖ Added ${pocketPetCount} pocket pet products`);
  console.log(`‚úÖ Added ${birdCount} bird products\n`);
  
  // Save updated data
  await fs.writeFile(
    './output/commercial-top-ingredients.json',
    JSON.stringify({ ingredientFrequency, topIngredientPairs }, null, 2),
    'utf-8'
  );
  
  // Show updated top ingredients
  console.log('Updated top 20 ingredients:');
  Object.entries(ingredientFrequency)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20)
    .forEach(([ing, count]) => console.log(`  ${count.toString().padStart(4)} | ${ing}`));
  
  console.log('\nUpdated top 30 ingredient pairs:');
  Object.entries(topIngredientPairs)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 30)
    .forEach(([pair, count]) => console.log(`  ${count.toString().padStart(4)} | ${pair.replace('|', ' + ')}`));
  
  console.log('\nüíæ Updated commercial-top-ingredients.json');
}

addManualProducts().catch(console.error);
</file>

<file path="scripts/training/canonicalize-commercial.ts">
/**
 * COMMERCIAL PRODUCT CANONICALIZER
 * Maps commercial ingredient fragments to unified ingredient registry
 * Aggressive cleaning for ingredient panel text
 */

import * as fs from 'fs/promises';
import { getIngredientByName } from '../../lib/data/unifiedIngredientRegistry';

interface CommercialProduct {
  source: string;
  sourceUrl: string;
  brand: string;
  productName: string;
  speciesHint: string[];
  productType: string;
  ingredientsRaw: string | string[];
  ingredientsList: Array<{ name: string; position: number }>;
  scrapedAt: string;
  barcode?: string;
}

interface CanonicalizedProduct extends CommercialProduct {
  ingredients: Array<{
    canonicalId: string;
    originalName: string;
    position: number;
    confidence: number;
  }>;
  unmappedIngredients: string[];
  mappingSuccessRate: number;
}

class CommercialCanonicalizer {
  private alias: Record<string, string> = {
    // Meat/Protein variations (English)
    'chicken meal': 'chicken',
    'chicken by-product meal': 'chicken',
    'chicken fat': 'chicken_fat',
    'poultry fat': 'chicken_fat',
    'poultry meal': 'chicken',
    'turkey meal': 'turkey',
    'beef meal': 'beef',
    'lamb meal': 'lamb',
    'fish meal': 'fish',
    'salmon meal': 'salmon',
    'ocean fish': 'fish',
    'whitefish': 'fish',
    'menhaden fish meal': 'fish',
    'meat and animal by-products': 'meat',
    'animal by-products': 'meat',
    
    // Meat/Protein (French)
    'viandes': 'meat',
    'viande': 'meat',
    'poulet': 'chicken',
    'boeuf': 'beef',
    'agneau': 'lamb',
    'canard': 'duck',
    'poisson': 'fish',
    'saumon': 'salmon',
    'viandes d√©shydrat√©es': 'meat',
    'graisse de canard': 'duck_fat',
    'sous-produits animaux': 'meat',
    'viandes et sous-produits animaux': 'meat',
    
    // Meat/Protein (Italian)
    'carni': 'meat',
    'carne': 'meat',
    'pollo': 'chicken',
    'manzo': 'beef',
    'agnello': 'lamb',
    'pesce': 'fish',
    'carni e derivati': 'meat',
    
    // Meat/Protein (German)
    'fleisch': 'meat',
    'huhn': 'chicken',
    'rind': 'beef',
    'lamm': 'lamb',
    'fisch': 'fish',
    
    // Grains (English)
    'corn meal': 'corn',
    'ground corn': 'corn',
    'whole grain corn': 'corn',
    'brewers rice': 'rice',
    'ground rice': 'rice',
    'rice flour': 'rice',
    'oat groats': 'oats',
    'ground oats': 'oats',
    'wheat flour': 'wheat',
    'whole wheat': 'wheat',
    
    // Grains (French)
    'c√©r√©ales': 'grain',
    'bl√©': 'wheat',
    'ma√Øs': 'corn',
    'riz': 'rice',
    'avoine': 'oats',
    'gluten de ma√Øs': 'corn',
    
    // Grains (Italian)
    'cereali': 'grain',
    'grano': 'wheat',
    'mais': 'corn',
    'riso': 'rice',
    
    // Grains (German)
    'getreide': 'grain',
    'weizen': 'wheat',
    'reis': 'rice',
    'hafer': 'oats',
    
    // Vegetables (French)
    'l√©gumes': 'vegetable',
    'carottes': 'carrot',
    'petits pois': 'peas',
    'pommes de terre': 'potato',
    'patates douces': 'sweet_potato',
    'pulpe de betterave': 'beet',
    'sous-produits d\'origine v√©g√©tale': 'vegetable',
    
    // Vegetables (Italian)
    'verdure': 'vegetable',
    'carote': 'carrot',
    'piselli': 'peas',
    'patate': 'potato',
    'sottoprodotti di origine vegetale': 'vegetable',
    
    // Vegetables (German)
    'gem√ºse': 'vegetable',
    'karotten': 'carrot',
    'erbsen': 'peas',
    'kartoffeln': 'potato',
    
    // Fats/Oils (English)
    'fish oil': 'fish_oil',
    'salmon oil': 'salmon_oil',
    'vegetable oil': 'vegetable_oil',
    'sunflower oil': 'sunflower_oil',
    'canola oil': 'canola_oil',
    'soybean oil': 'soybean_oil',
    
    // Fats/Oils (French)
    'huiles': 'oil',
    'huile': 'oil',
    'graisses': 'fat',
    'graisse': 'fat',
    'huile de poisson': 'fish_oil',
    'huile de tournesol': 'sunflower_oil',
    'oli e grassi': 'oil',
    
    // Fats/Oils (Italian)
    'oli': 'oil',
    'olio': 'oil',
    'grassi': 'fat',
    'grasso': 'fat',
    
    // Other (French)
    'poudre d\'oeuf': 'egg',
    'oeuf': 'egg',
    'levures': 'yeast',
    'substances min√©rales': 'minerals',
    
    // Other (Italian)
    'uova': 'egg',
    'lievito': 'yeast',
    'sostanze minerali': 'minerals',
    
    // Vegetable variations (English)
    'dried carrots': 'carrot',
    'dehydrated carrots': 'carrot',
    'carrot pomace': 'carrot',
    'pea protein': 'peas',
    'dried peas': 'peas',
    'sweet potato': 'sweet_potato',
    'dried sweet potato': 'sweet_potato',
    
    // Common additives to ignore
    'water': 'water',
    'natural flavors': 'natural_flavors',
    'artificial flavors': 'artificial_flavors',
    'vitamins': 'vitamins',
    'minerals': 'minerals',
    'preservatives': 'preservatives',
  };

  // Ingredients to ignore (not counted for pairing)
  private ignoreList = new Set([
    'water',
    'natural_flavors',
    'artificial_flavors',
    'vitamins',
    'minerals',
    'preservatives',
    'salt',
    'calcium carbonate',
    'dicalcium phosphate',
    'potassium chloride',
    'choline chloride',
    'taurine',
    'dl-methionine',
    'l-lysine',
    'vitamin e supplement',
    'vitamin a supplement',
    'vitamin d3 supplement',
    'vitamin b12 supplement',
    'riboflavin supplement',
    'niacin supplement',
    'thiamine mononitrate',
    'pyridoxine hydrochloride',
    'folic acid',
    'biotin',
    'zinc sulfate',
    'ferrous sulfate',
    'copper sulfate',
    'manganese sulfate',
    'sodium selenite',
    'calcium iodate',
  ]);

  async canonicalize(inputPath: string, outputDir: string): Promise<void> {
    console.log(`\nüìä Canonicalizing commercial products from: ${inputPath}`);
    
    const fileContent = await fs.readFile(inputPath, 'utf-8');
    const products: CommercialProduct[] = JSON.parse(fileContent);
    console.log(`   Found ${products.length} products`);

    const canonicalized: CanonicalizedProduct[] = [];
    const canonicalizedAll: CanonicalizedProduct[] = [];
    const unmappedSet = new Set<string>();

    for (const product of products) {
      const result = this.canonicalizeProduct(product);
      
      canonicalizedAll.push(result);
      
      // Only include products with >= 50% mapping success
      if (result.mappingSuccessRate >= 0.50) {
        canonicalized.push(result);
      }
      
      // Track unmapped ingredients
      result.unmappedIngredients.forEach(ing => unmappedSet.add(ing));
    }

    console.log(`   ‚úÖ Canonicalized ${canonicalized.length}/${products.length} products (>= 50% mapping)`);
    console.log(`   üìù Found ${unmappedSet.size} unique unmapped ingredients`);

    // Save outputs
    const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
    await fs.writeFile(
      `${outputDir}/canonical-commercial-${timestamp}.json`,
      JSON.stringify(canonicalized, null, 2),
      'utf-8'
    );
    await fs.writeFile(
      `${outputDir}/canonical-commercial-all-${timestamp}.json`,
      JSON.stringify(canonicalizedAll, null, 2),
      'utf-8'
    );
    await fs.writeFile(
      `${outputDir}/unmapped-commercial-${timestamp}.json`,
      JSON.stringify(Array.from(unmappedSet).sort(), null, 2),
      'utf-8'
    );

    console.log(`\nüíæ Saved outputs to ${outputDir}/`);
    this.printSummary(canonicalized, unmappedSet);
  }

  private canonicalizeProduct(product: CommercialProduct): CanonicalizedProduct {
    const ingredients: CanonicalizedProduct['ingredients'] = [];
    const unmappedIngredients: string[] = [];

    for (const item of product.ingredientsList) {
      const normalized = this.normalizeIngredientName(item.name);
      
      if (this.ignoreList.has(normalized.toLowerCase())) {
        // Skip ignored ingredients (vitamins, minerals, etc.)
        continue;
      }

      const canonical = getIngredientByName(normalized);
      
      if (canonical) {
        ingredients.push({
          canonicalId: canonical.id,
          originalName: item.name,
          position: item.position,
          confidence: 0.8, // High confidence for registry matches
        });
      } else {
        unmappedIngredients.push(item.name);
      }
    }

    const totalIngredients = product.ingredientsList.length;
    const mappedCount = ingredients.length;
    const mappingSuccessRate = totalIngredients > 0 ? mappedCount / totalIngredients : 0;

    return {
      ...product,
      ingredients,
      unmappedIngredients,
      mappingSuccessRate: Math.round(mappingSuccessRate * 100) / 100,
    };
  }

  private normalizeIngredientName(name: string): string {
    let normalized = name.toLowerCase().trim();

    // Check alias map first
    if (this.alias[normalized]) {
      return this.alias[normalized];
    }

    // Aggressive cleaning for ingredient fragments
    
    // Remove preparation methods
    normalized = normalized.replace(/\b(minced|chopped|diced|ground|dehydrated|dried|cooked|raw|fresh|frozen)\b/g, '');
    
    // Remove forms
    normalized = normalized.replace(/\b(meal|powder|extract|concentrate|flavoring|flavor|oil|fat)\b/g, '');
    
    // Remove "and derivatives"
    normalized = normalized.replace(/\band derivatives\b/g, '');
    
    // Remove parenthetical content
    normalized = normalized.replace(/\([^)]*\)/g, '');
    
    // Remove extra whitespace
    normalized = normalized.replace(/\s+/g, ' ').trim();

    // Handle common patterns
    if (normalized.includes('chicken')) return 'chicken';
    if (normalized.includes('turkey')) return 'turkey';
    if (normalized.includes('beef')) return 'beef';
    if (normalized.includes('lamb')) return 'lamb';
    if (normalized.includes('salmon')) return 'salmon';
    if (normalized.includes('fish')) return 'fish';
    if (normalized.includes('rice')) return 'rice';
    if (normalized.includes('corn')) return 'corn';
    if (normalized.includes('wheat')) return 'wheat';
    if (normalized.includes('oat')) return 'oats';
    if (normalized.includes('carrot')) return 'carrot';
    if (normalized.includes('pea')) return 'peas';
    if (normalized.includes('sweet potato')) return 'sweet_potato';
    if (normalized.includes('potato')) return 'potato';
    if (normalized.includes('spinach')) return 'spinach';
    if (normalized.includes('broccoli')) return 'broccoli';

    return normalized;
  }

  private printSummary(products: CanonicalizedProduct[], unmappedSet: Set<string>): void {
    console.log('\nüìà Canonicalization Summary:');
    
    // By species
    const bySpecies = products.reduce((acc, p) => {
      const species = p.speciesHint[0] || 'unknown';
      acc[species] = (acc[species] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);
    
    console.log('\n   Products by species:');
    for (const [species, count] of Object.entries(bySpecies)) {
      console.log(`   ${species}: ${count}`);
    }

    // Mapping success rate
    const avgMappingRate = products.reduce((sum, p) => sum + p.mappingSuccessRate, 0) / products.length;
    console.log(`\n   Average mapping success rate: ${(avgMappingRate * 100).toFixed(1)}%`);

    // Top unmapped ingredients
    console.log(`\n   Top 20 unmapped ingredients:`);
    const unmappedArray = Array.from(unmappedSet).slice(0, 20);
    unmappedArray.forEach(ing => console.log(`   - ${ing}`));
  }
}

// CLI execution
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 1) {
    console.error('Usage: tsx canonicalize-commercial.ts <input-file> [output-dir]');
    console.error('Example: tsx canonicalize-commercial.ts ./output/commercial-products-2025-12-19.json ./output');
    process.exit(1);
  }

  const inputPath = args[0];
  const outputDir = args[1] || './output';
  
  const canonicalizer = new CommercialCanonicalizer();
  await canonicalizer.canonicalize(inputPath, outputDir);
}

main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/training/canonicalize-recipes.ts">
/**
 * RECIPE CANONICALIZER
 * Maps scraped recipes to internal schema with canonical ingredient IDs
 * This is Step 1 of the training pipeline
 */

import * as fs from 'fs/promises';
import * as path from 'path';
import { getIngredientByName } from '../../lib/data/unifiedIngredientRegistry';

type ScrapedRecipe = {
  id: string;
  name: string;
  species: string[];
  ingredients: Array<{
    name: string;
    amount?: string;
    unit?: string;
  }>;
  instructions?: string[];
  warnings?: string[];
  sourceUrl: string;
  sourceName: string;
  sourceTier: string;
  scrapedAt: Date | string;
  tags?: string[];
}

type CanonicalizedRecipe = {
  id: string;
  name: string;
  species: string[];
  ingredients: Array<{
    canonicalId: string;
    originalName: string;
    amount?: string;
    unit?: string;
    gramsEstimate?: number;
  }>;
  unmappedIngredients: string[];
  mappingSuccessRate: number;
  instructions?: string[];
  warnings?: string[];
  sourceUrl: string;
  sourceName: string;
  sourceTier: string;
  scrapedAt: string;
  tags?: string[];
  flags: {
    isComplete: boolean;
    prepStyle?: 'cooked' | 'raw' | 'mixed' | 'unknown';
    mealType?: 'meal' | 'topper' | 'treat' | 'guide';
  };
}

export class RecipeCanonicalizer {
  private ingredientCache = new Map<string, string | null>();
  private unmappedCounts: Record<string, number> = {};

  // Alias layer for common ingredient name variations
  private alias: Record<string, string> = {
    // English variations
    'brown rice': 'brown_rice',
    'white rice': 'white_rice',
    'ground beef': 'beef_ground',
    'lean ground beef': 'beef_ground',
    'ground turkey': 'turkey_ground',
    'ground chicken': 'chicken_ground',
    'baby spinach': 'spinach',
    'sweet potatoes': 'sweet_potato',
    'sweet potato': 'sweet_potato',
    'eggs': 'egg_whole',
    'egg': 'egg_whole',
    'carrots': 'carrot',
    'zucchini': 'zucchini',
    'coconut oil': 'coconut_oil',
    'curly parsley': 'parsley',
    'parsley': 'parsley',
    'squash': 'butternut_squash',
    'butternut squash': 'butternut_squash',
    'pumpkin': 'pumpkin',
    'pumpkin puree': 'pumpkin',
    'broccoli': 'broccoli',
    'green beans': 'green_beans',
    'peas': 'peas',
    'kale': 'kale',
    'oats': 'oats',
    'rolled oats': 'oats',
    'quinoa': 'quinoa',
    'barley': 'barley',
    
    // German ‚Üí English
    'karotte': 'carrot',
    'karotten': 'carrot',
    'm√∂hre': 'carrot',
    'm√∂hren': 'carrot',
    'reis': 'rice',
    'salat': 'lettuce',
    'apfel': 'apple',
    '√§pfel': 'apple',
    'bananen': 'banana',
    'spinat': 'spinach',
    'brokkoli': 'broccoli',
    'k√ºrbis': 'pumpkin',
    'gurke': 'cucumber',
    'tomaten': 'tomato',
    'paprika': 'bell_pepper',
    'ei': 'egg_whole',
    'eier': 'egg_whole',
    'huhn': 'chicken',
    'h√§hnchen': 'chicken',
    'rind': 'beef',
    'rindfleisch': 'beef',
    'pute': 'turkey',
    'fisch': 'fish',
    
    // French ‚Üí English (banane, tomate shared with German/Spanish)
    'carotte': 'carrot',
    'carottes': 'carrot',
    'riz': 'rice',
    'salade': 'lettuce',
    'laitue': 'lettuce',
    'pomme': 'apple',
    'pommes': 'apple',
    'banane': 'banana',
    '√©pinard': 'spinach',
    '√©pinards': 'spinach',
    'brocoli': 'broccoli',
    'citrouille': 'pumpkin',
    'concombre': 'cucumber',
    'tomate': 'tomato',
    'poivron': 'bell_pepper',
    'oeuf': 'egg_whole',
    'oeufs': 'egg_whole',
    'poulet': 'chicken',
    'boeuf': 'beef',
    'dinde': 'turkey',
    'poisson': 'fish',
    
    // Spanish ‚Üí English
    'zanahoria': 'carrot',
    'zanahorias': 'carrot',
    'arroz': 'rice',
    'lechuga': 'lettuce',
    'manzana': 'apple',
    'manzanas': 'apple',
    'pl√°tano': 'banana',
    'pl√°tanos': 'banana',
    'espinaca': 'spinach',
    'espinacas': 'spinach',
    'br√≥coli': 'broccoli',
    'calabaza': 'pumpkin',
    'pepino': 'cucumber',
    'tomates': 'tomato',
    'pimiento': 'bell_pepper',
    'huevo': 'egg_whole',
    'huevos': 'egg_whole',
    'pollo': 'chicken',
    'carne': 'beef',
    'res': 'beef',
    'pavo': 'turkey',
    'pescado': 'fish',
  };

  async canonicalizeRecipeFile(inputPath: string, outputPath: string): Promise<void> {
    console.log(`\nüìñ Canonicalizing recipes from: ${inputPath}`);
    
    const data = await fs.readFile(inputPath, 'utf-8');
    const scrapedRecipes: ScrapedRecipe[] = JSON.parse(data);
    console.log(`   Found ${scrapedRecipes.length} scraped recipes`);

    const ACCEPT_THRESHOLD = 0.5;
    const canonicalized: CanonicalizedRecipe[] = [];
    const allCanonicalized: CanonicalizedRecipe[] = [];
    const stats = {
      total: scrapedRecipes.length,
      successful: 0,
      partiallyMapped: 0,
      failed: 0,
    };

    for (const recipe of scrapedRecipes) {
      const canonical = this.canonicalizeRecipe(recipe);
      allCanonicalized.push(canonical);
      
      if (canonical.mappingSuccessRate >= ACCEPT_THRESHOLD) {
        canonicalized.push(canonical);
        if (canonical.mappingSuccessRate >= 0.9) {
          stats.successful++;
        } else {
          stats.partiallyMapped++;
        }
      } else {
        stats.failed++;
      }
    }

    await fs.mkdir(path.dirname(outputPath), { recursive: true });
    
    // Write accepted recipes
    await fs.writeFile(outputPath, JSON.stringify(canonicalized, null, 2), 'utf-8');
    
    // Write all recipes for debugging
    const allPath = outputPath.replace(/\.json$/i, '-all.json');
    await fs.writeFile(allPath, JSON.stringify(allCanonicalized, null, 2), 'utf-8');
    
    // Write unmapped ingredients for iterative improvement
    const unmappedPath = path.join(path.dirname(outputPath), 'unmapped-ingredients.json');
    const sortedUnmapped = Object.entries(this.unmappedCounts)
      .sort((a, b) => b[1] - a[1])
      .reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {});
    await fs.writeFile(unmappedPath, JSON.stringify(sortedUnmapped, null, 2), 'utf-8');

    console.log(`\n‚úÖ Canonicalization complete!`);
    console.log(`   Total recipes: ${stats.total}`);
    console.log(`   Successfully mapped (>90%): ${stats.successful}`);
    console.log(`   Partially mapped (50-90%): ${stats.partiallyMapped}`);
    console.log(`   Failed (<50%): ${stats.failed}`);
    console.log(`   Output (accepted): ${outputPath}`);
    console.log(`   Output (all):      ${allPath}`);
    console.log(`   Unmapped list:     ${unmappedPath}`);
  }

  private canonicalizeRecipe(recipe: ScrapedRecipe): CanonicalizedRecipe {
    const canonicalIngredients: CanonicalizedRecipe['ingredients'] = [];
    const unmapped: string[] = [];

    for (const ing of recipe.ingredients) {
      const canonicalId = this.findCanonicalIngredient(ing.name);
      
      if (canonicalId) {
        canonicalIngredients.push({
          canonicalId,
          originalName: ing.name,
          amount: ing.amount,
          unit: ing.unit,
          gramsEstimate: this.estimateGrams(ing.amount, ing.unit),
        });
      } else {
        unmapped.push(ing.name);
        // Track unmapped ingredients for iterative improvement
        const normalized = this.normalizeIngredientName(ing.name) || ing.name.toLowerCase();
        this.unmappedCounts[normalized] = (this.unmappedCounts[normalized] || 0) + 1;
      }
    }

    const mappingSuccessRate = recipe.ingredients.length > 0
      ? canonicalIngredients.length / recipe.ingredients.length
      : 0;

    return {
      id: recipe.id,
      name: recipe.name,
      species: recipe.species,
      ingredients: canonicalIngredients,
      unmappedIngredients: unmapped,
      mappingSuccessRate,
      instructions: recipe.instructions,
      warnings: recipe.warnings,
      sourceUrl: recipe.sourceUrl,
      sourceName: recipe.sourceName,
      sourceTier: recipe.sourceTier,
      scrapedAt: typeof recipe.scrapedAt === 'string' ? recipe.scrapedAt : recipe.scrapedAt.toISOString(),
      tags: recipe.tags,
      flags: {
        isComplete: this.detectCompleteness(recipe),
        prepStyle: this.detectPrepStyle(recipe),
        mealType: this.detectMealType(recipe),
      },
    };
  }

  private findCanonicalIngredient(name: string): string | null {
    // Check cache first
    if (this.ingredientCache.has(name)) {
      return this.ingredientCache.get(name)!;
    }

    // Normalize the name
    const normalized = this.normalizeIngredientName(name);
    if (!normalized) {
      this.ingredientCache.set(name, null);
      return null;
    }

    // Check if it's a unit/measurement artifact
    const cleaned = normalized.trim().toLowerCase();
    if (cleaned.length <= 2 && ['g','kg','oz','lb','tsp','tbsp','cup','cups'].includes(cleaned)) {
      this.ingredientCache.set(name, null);
      return null;
    }

    // Try alias layer first
    const aliased = this.alias[normalized] ?? normalized;

    // Try exact match using the imported function
    let ingredient = getIngredientByName(aliased);
    if (ingredient) {
      this.ingredientCache.set(name, ingredient.id);
      return ingredient.id;
    }

    // Try common variations
    const variations = this.generateVariations(aliased);
    for (const variation of variations) {
      ingredient = getIngredientByName(variation);
      if (ingredient) {
        this.ingredientCache.set(name, ingredient.id);
        return ingredient.id;
      }
    }

    // Not found
    this.ingredientCache.set(name, null);
    return null;
  }

  private normalizeIngredientName(name: string): string {
    let s = name
      .toLowerCase()
      .replace(/\(.*?\)/g, ' ')          // remove parentheticals
      .replace(/[,\/]/g, ' ')
      .replace(/[^a-z0-9\s_-]/g, ' ')    // drop weird chars
      .replace(/\s+/g, ' ')
      .trim();

    // remove measurement/unit-only artifacts
    if (s.length <= 2 && ['g','kg','oz','lb','tsp','tbsp','cup','cups'].includes(s)) return '';

    // remove common "noise" tokens anywhere in the string
    const dropTokens = new Set([
      'fresh','frozen','dried','organic','free','range','grass','fed','lean',
      'cooked','raw','uncooked','boiled','baked','roasted','steamed','simmered',
      'chopped','diced','minced','sliced','shredded','grated','finely','coarsely',
      'drained','rinsed','boneless','skinless','skin-on','bone-in','skin','on',
      'small','medium','large','baby','whole','halved','quartered',
      'peeled','unpeeled','trimmed','cleaned','washed',
      'about','approximately','roughly',
      'or','to','taste','as','needed','optional'
    ]);

    const tokens = s.split(' ').filter(t => t && !dropTokens.has(t));
    s = tokens.join(' ').trim();

    // normalize common forms
    s = s
      .replace(/\s+/g, ' ')
      .trim();

    return s;
  }

  private generateVariations(name: string): string[] {
    const variations: string[] = [];

    // Singular/plural
    if (name.endsWith('s')) {
      variations.push(name.slice(0, -1));
    } else {
      variations.push(name + 's');
    }

    // Common synonyms
    const synonyms: Record<string, string[]> = {
      'chicken': ['chicken_breast', 'chicken_thigh'],
      'beef': ['beef_ground', 'beef_chuck'],
      'turkey': ['turkey_breast', 'turkey_ground'],
      'fish': ['salmon', 'tuna', 'cod'],
      'liver': ['chicken_liver', 'beef_liver'],
      'egg': ['eggs', 'egg_whole'],
      'rice': ['brown_rice', 'white_rice'],
      'sweet potato': ['sweet_potato', 'sweet_potatoes'],
      'carrot': ['carrots'],
      'pea': ['peas', 'green_peas'],
      'spinach': ['spinach_fresh'],
      'oil': ['olive_oil', 'coconut_oil', 'fish_oil'],
    };

    for (const [key, values] of Object.entries(synonyms)) {
      if (name.includes(key)) {
        variations.push(...values);
      }
    }

    // Underscore vs space
    variations.push(name.replace(/ /g, '_'));
    variations.push(name.replace(/_/g, ' '));

    return variations;
  }

  private estimateGrams(amount?: string, unit?: string): number | undefined {
    if (!amount || !unit) return undefined;

    const numMatch = amount.match(/[\d.]+/);
    if (!numMatch) return undefined;

    const num = parseFloat(numMatch[0]);

    // Common conversions to grams
    const conversions: Record<string, number> = {
      'g': 1,
      'gram': 1,
      'grams': 1,
      'kg': 1000,
      'oz': 28.35,
      'lb': 453.59,
      'lbs': 453.59,
      'pound': 453.59,
      'pounds': 453.59,
      'cup': 240,
      'cups': 240,
      'tbsp': 15,
      'tablespoon': 15,
      'tsp': 5,
      'teaspoon': 5,
    };

    const multiplier = conversions[unit.toLowerCase()];
    return multiplier ? num * multiplier : undefined;
  }

  private detectCompleteness(recipe: ScrapedRecipe): boolean {
    const text = [
      recipe.name,
      ...(recipe.instructions || []),
      ...(recipe.warnings || []),
    ].join(' ').toLowerCase();

    // Incomplete indicators
    const incompleteKeywords = [
      'topper', 'treat', 'snack', 'supplement', 'add to',
      'mix with', 'sprinkle', 'incomplete', 'not balanced',
      'consult vet', 'add calcium', 'needs supplements',
    ];

    return !incompleteKeywords.some(kw => text.includes(kw));
  }

  private detectPrepStyle(recipe: ScrapedRecipe): 'cooked' | 'raw' | 'mixed' | 'unknown' {
    const text = [
      recipe.name,
      ...(recipe.instructions || []),
    ].join(' ').toLowerCase();

    const cookedKeywords = ['cook', 'bake', 'boil', 'steam', 'roast', 'simmer'];
    const rawKeywords = ['raw', 'uncooked', 'fresh'];

    const hasCookedKeywords = cookedKeywords.some(kw => text.includes(kw));
    const hasRawKeywords = rawKeywords.some(kw => text.includes(kw));

    if (hasCookedKeywords && hasRawKeywords) return 'mixed';
    if (hasCookedKeywords) return 'cooked';
    if (hasRawKeywords) return 'raw';
    return 'unknown';
  }

  private detectMealType(recipe: ScrapedRecipe): 'meal' | 'topper' | 'treat' | 'guide' {
    const text = recipe.name.toLowerCase();

    if (text.includes('treat') || text.includes('snack')) return 'treat';
    if (text.includes('topper') || text.includes('mix-in')) return 'topper';
    if (text.includes('guide') || text.includes('feeding')) return 'guide';
    return 'meal';
  }
}

// CLI execution
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.error('Usage: ts-node canonicalize-recipes.ts <input-file> <output-file>');
    console.error('Example: ts-node canonicalize-recipes.ts ../../pet-recipe-scraper/output/blog-recipes-*.json ./output/canonical-recipes.json');
    process.exit(1);
  }

  const [inputPath, outputPath] = args;
  const canonicalizer = new RecipeCanonicalizer();
  
  await canonicalizer.canonicalizeRecipeFile(inputPath, outputPath);
}

// Run if executed directly
main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/training/compute-commercial-priors.ts">
/**
 * COMPUTE COMMERCIAL PRIORS WITH PROPER PMI
 * 
 * Steps:
 * 1. Filter to top 5-7 real ingredients (drop vitamins/minerals/preservatives)
 * 2. Compute ingredient counts and pair counts
 * 3. Compute PMI with thresholds (minIng>=20, minPair>=5)
 * 4. Detect hardBlockPairs (never-seen) and strongPenaltyPairs (rare+negative PMI)
 * 5. Write to recipePriors.json under commercialPriors section
 */

import * as fs from 'fs/promises';

interface CommercialPriors {
  version: string;
  generatedAt: string;
  metadata: {
    totalProducts: number;
    minIngredientCount: number;
    minPairCount: number;
    minCommonIngredient: number;
  };
  commercialPriors: {
    [species: string]: {
      ingredientCounts: Record<string, number>;
      ingredientFreq: Record<string, number>;
      pairCounts: Record<string, number>;
      pairPMI: Record<string, number>;
      hardBlockPairs: string[];
      strongPenaltyPairs: string[];
    };
  };
}

// Thresholds - CONSERVATIVE to avoid over-blocking
const MIN_ING_COUNT = 30; // Ingredient must appear in at least 30 products (up from 20)
const MIN_PAIR_COUNT = 5; // Pair must appear in at least 5 products
const MIN_COMMON_ING = 40; // For hardBlock detection (up from 20, very conservative)
const RARE_PAIR_MAX = 2; // For strongPenalty detection
const NEGATIVE_PMI_THRESHOLD = -1.5;
const SMOOTHING = 0.5;

// Category tokens to skip (they poison PMI)
const CATEGORY_TOKENS = new Set(['grain', 'meat', 'vegetable', 'fat', 'oil']);

async function computeCommercialPriors() {
  console.log('\nüìä Computing commercial priors with proper PMI...\n');
  
  // Load commercial top ingredients data
  const data = JSON.parse(await fs.readFile('./output/commercial-top-ingredients.json', 'utf-8'));
  
  const ingredientFrequency: Record<string, number> = data.ingredientFrequency;
  const topIngredientPairs: Record<string, number> = data.topIngredientPairs;
  
  // Total products (estimate from max ingredient count)
  const totalProducts = Math.max(...Object.values(ingredientFrequency));
  
  console.log(`Total products (estimated): ${totalProducts}`);
  console.log(`Unique ingredients: ${Object.keys(ingredientFrequency).length}`);
  console.log(`Unique pairs: ${Object.keys(topIngredientPairs).length}\n`);
  
  // Step 1: Filter to common ingredients (count >= MIN_ING_COUNT) and remove category tokens
  const commonIngredients = Object.entries(ingredientFrequency)
    .filter(([ing, count]) => count >= MIN_ING_COUNT && !CATEGORY_TOKENS.has(ing))
    .map(([ing, _]) => ing);
  
  console.log(`Common ingredients (>=${MIN_ING_COUNT}): ${commonIngredients.length}`);
  
  // Step 2: Compute PMI for valid pairs
  const pairPMI: Record<string, number> = {};
  const validPairs: Record<string, number> = {};
  
  for (const [pair, pairCount] of Object.entries(topIngredientPairs)) {
    if (pairCount < MIN_PAIR_COUNT) continue;
    
    const [ing1, ing2] = pair.split('|');
    const count1 = ingredientFrequency[ing1] || 0;
    const count2 = ingredientFrequency[ing2] || 0;
    
    // Both ingredients must be common
    if (count1 < MIN_ING_COUNT || count2 < MIN_ING_COUNT) continue;
    
    // Compute PMI with smoothing
    const pXY = (pairCount + SMOOTHING) / (totalProducts + SMOOTHING);
    const pX = (count1 + SMOOTHING) / (totalProducts + SMOOTHING);
    const pY = (count2 + SMOOTHING) / (totalProducts + SMOOTHING);
    const pmi = Math.log2(pXY / (pX * pY));
    
    pairPMI[pair] = Math.round(pmi * 100) / 100;
    validPairs[pair] = pairCount;
  }
  
  console.log(`Valid pairs (>=${MIN_PAIR_COUNT}, both ingredients >=${MIN_ING_COUNT}): ${Object.keys(validPairs).length}\n`);
  
  // Step 3: Detect hardBlockPairs (never-seen)
  // CRITICAL: Be very conservative - data quality is limited
  // Don't block poultry + fish (fish oil is common supplement)
  const hardBlockPairs: string[] = [];
  const POULTRY = new Set(['chicken', 'turkey', 'duck']);
  const FISH = new Set(['fish', 'salmon', 'tuna', 'cod', 'whitefish', 'trout', 'mackerel']);
  
  for (let i = 0; i < commonIngredients.length; i++) {
    for (let j = i + 1; j < commonIngredients.length; j++) {
      const pair = [commonIngredients[i], commonIngredients[j]].sort().join('|');
      const ing1 = commonIngredients[i];
      const ing2 = commonIngredients[j];
      
      // Skip poultry + fish combinations (fish oil is common with poultry)
      if ((POULTRY.has(ing1) && FISH.has(ing2)) || (FISH.has(ing1) && POULTRY.has(ing2))) {
        continue;
      }
      
      // Both common, but pair count is 0
      if (!topIngredientPairs[pair] || topIngredientPairs[pair] === 0) {
        const count1 = ingredientFrequency[ing1];
        const count2 = ingredientFrequency[ing2];
        
        if (count1 >= MIN_COMMON_ING && count2 >= MIN_COMMON_ING) {
          hardBlockPairs.push(pair);
        }
      }
    }
  }
  
  console.log(`hardBlockPairs (never-seen, both >=${MIN_COMMON_ING}): ${hardBlockPairs.length}`);
  
  // Step 4: Detect strongPenaltyPairs (rare + negative PMI)
  const strongPenaltyPairs: string[] = [];
  
  for (const [pair, pairCount] of Object.entries(topIngredientPairs)) {
    if (pairCount > RARE_PAIR_MAX) continue;
    
    const [ing1, ing2] = pair.split('|');
    const count1 = ingredientFrequency[ing1] || 0;
    const count2 = ingredientFrequency[ing2] || 0;
    
    // Both must be somewhat common
    if (count1 < MIN_ING_COUNT || count2 < MIN_ING_COUNT) continue;
    
    // Compute PMI
    const pXY = (pairCount + SMOOTHING) / (totalProducts + SMOOTHING);
    const pX = (count1 + SMOOTHING) / (totalProducts + SMOOTHING);
    const pY = (count2 + SMOOTHING) / (totalProducts + SMOOTHING);
    const pmi = Math.log2(pXY / (pX * pY));
    
    if (pmi < NEGATIVE_PMI_THRESHOLD) {
      strongPenaltyPairs.push(pair);
    }
  }
  
  console.log(`strongPenaltyPairs (rare + PMI<${NEGATIVE_PMI_THRESHOLD}): ${strongPenaltyPairs.length}\n`);
  
  // Step 5: Build commercial priors structure (species-specific)
  // Note: Current data is mixed species, so we'll put it under 'dogs' and 'cats'
  // since most commercial products are for these species
  const commercialPriors: CommercialPriors = {
    version: '2.0.0',
    generatedAt: new Date().toISOString(),
    metadata: {
      totalProducts,
      minIngredientCount: MIN_ING_COUNT,
      minPairCount: MIN_PAIR_COUNT,
      minCommonIngredient: MIN_COMMON_ING,
    },
    commercialPriors: {
      dogs: {
        ingredientCounts: ingredientFrequency,
        ingredientFreq: Object.fromEntries(
          Object.entries(ingredientFrequency)
            .filter(([_, count]) => count >= MIN_ING_COUNT)
        ),
        pairCounts: validPairs,
        pairPMI,
        hardBlockPairs,
        strongPenaltyPairs,
      },
      cats: {
        ingredientCounts: ingredientFrequency,
        ingredientFreq: Object.fromEntries(
          Object.entries(ingredientFrequency)
            .filter(([_, count]) => count >= MIN_ING_COUNT)
        ),
        pairCounts: validPairs,
        pairPMI,
        hardBlockPairs,
        strongPenaltyPairs,
      },
    },
  };
  
  // Step 6: Merge with existing recipePriors.json
  let existingPriors: any = {};
  try {
    const existing = await fs.readFile('../../lib/data/recipePriors.json', 'utf-8');
    existingPriors = JSON.parse(existing);
  } catch (error) {
    console.log('No existing recipePriors.json found, creating new one');
  }
  
  // Merge without overwriting recipe priors
  const merged = {
    ...existingPriors,
    commercialPriors: commercialPriors.commercialPriors,
    commercialMetadata: commercialPriors.metadata,
    commercialVersion: commercialPriors.version,
    commercialGeneratedAt: commercialPriors.generatedAt,
  };
  
  await fs.writeFile(
    '../../lib/data/recipePriors.json',
    JSON.stringify(merged, null, 2),
    'utf-8'
  );
  
  console.log('üíæ Updated recipePriors.json with commercial priors\n');
  
  // Step 7: Show examples
  console.log('üìà Top 10 positive PMI pairs:');
  Object.entries(pairPMI)
    .filter(([_, pmi]) => pmi > 0)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .forEach(([pair, pmi]) => {
      const count = validPairs[pair];
      console.log(`  ${pair.replace('|', ' + ')}: PMI=${pmi.toFixed(2)}, count=${count}`);
    });
  
  console.log('\nüìà Sample hardBlockPairs (never-seen):');
  hardBlockPairs.slice(0, 20).forEach(pair => {
    const [ing1, ing2] = pair.split('|');
    const count1 = ingredientFrequency[ing1];
    const count2 = ingredientFrequency[ing2];
    console.log(`  ${pair.replace('|', ' + ')}: ${ing1}(${count1}) + ${ing2}(${count2}) = NEVER`);
  });
  
  console.log('\nüìà Sample strongPenaltyPairs:');
  strongPenaltyPairs.slice(0, 10).forEach(pair => {
    const count = topIngredientPairs[pair] || 0;
    console.log(`  ${pair.replace('|', ' + ')}: count=${count} (RARE)`);
  });
  
  // Check for turkey + fish combinations
  console.log('\nüîç Checking turkey + fish combinations:');
  const turkeyFishPairs = hardBlockPairs.filter(p => 
    (p.includes('turkey') && (p.includes('fish') || p.includes('salmon') || p.includes('tuna') || p.includes('anchovy')))
  );
  
  if (turkeyFishPairs.length > 0) {
    console.log('  ‚úÖ Found turkey + fish hardBlockPairs:');
    turkeyFishPairs.forEach(pair => console.log(`     ${pair.replace('|', ' + ')}`));
  } else {
    console.log('  ‚ö†Ô∏è  No turkey + fish hardBlockPairs detected (may need more data)');
  }
}

computeCommercialPriors().catch(console.error);
</file>

<file path="scripts/training/extract-commercial-patterns.ts">
/**
 * COMMERCIAL PATTERN EXTRACTOR
 * Computes statistical priors from commercial pet food ingredient panels
 * Uses PMI for pair scoring and detects rare/never-seen pairs
 */

import * as fs from 'fs/promises';

interface CanonicalizedProduct {
  source: string;
  brand: string;
  productName: string;
  speciesHint: string[];
  productType: string;
  ingredients: Array<{
    canonicalId: string;
    originalName: string;
    position: number;
    confidence: number;
  }>;
  mappingSuccessRate: number;
}

interface CommercialPriors {
  version: string;
  generatedAt: string;
  metadata: {
    numProductsUsed: number;
    bySource: Record<string, number>;
    bySpecies: Record<string, number>;
    lastUpdated: string;
  };
  
  // Per species (and optionally per type)
  commercial: {
    [speciesKey: string]: {
      coOccurrencePairs: Record<string, number>;
      coOccurrenceTriples: Record<string, number>;
      ingredientFrequency: Record<string, number>;
      pairPMI: Record<string, number>;
      rarePairs: Record<string, number>; // Negative PMI pairs
      categoryRatios: {
        protein: { min: number; max: number; median: number };
        vegetable: { min: number; max: number; median: number };
        fat: { min: number; max: number; median: number };
        carbohydrate: { min: number; max: number; median: number };
      };
      ingredientCount: { min: number; max: number; median: number };
    };
  };
}

class CommercialPatternExtractor {
  private readonly SMOOTHING = 0.5;
  private readonly RARE_PAIR_THRESHOLD = -1.0; // PMI threshold for "rare" pairs

  async extractPatterns(inputPath: string, outputPath: string): Promise<void> {
    console.log(`\nüìä Extracting commercial patterns from: ${inputPath}`);
    
    const fileContent = await fs.readFile(inputPath, 'utf-8');
    const products: CanonicalizedProduct[] = JSON.parse(fileContent);
    console.log(`   Found ${products.length} canonicalized products`);

    // Group by species
    const bySpecies = this.groupBySpecies(products);

    const priors: CommercialPriors = {
      version: '2.0.0',
      generatedAt: new Date().toISOString(),
      metadata: {
        numProductsUsed: products.length,
        bySource: this.countByField(products, 'source'),
        bySpecies: this.countByField(products, p => p.speciesHint[0] || 'unknown'),
        lastUpdated: new Date().toISOString(),
      },
      commercial: {},
    };

    // Extract patterns for each species
    for (const [species, speciesProducts] of Object.entries(bySpecies)) {
      console.log(`\n   Processing ${species} (${speciesProducts.length} products)...`);
      priors.commercial[species] = this.extractSpeciesPatterns(speciesProducts);
    }

    // Merge with existing recipePriors.json if it exists
    await this.mergeWithExistingPriors(priors, outputPath);

    console.log(`\n‚úÖ Pattern extraction complete!`);
    this.printSummary(priors);
  }

  private groupBySpecies(products: CanonicalizedProduct[]): Record<string, CanonicalizedProduct[]> {
    const grouped: Record<string, CanonicalizedProduct[]> = {};
    
    for (const product of products) {
      const species = product.speciesHint[0] || 'unknown';
      if (!grouped[species]) {
        grouped[species] = [];
      }
      grouped[species].push(product);
    }
    
    return grouped;
  }

  private extractSpeciesPatterns(products: CanonicalizedProduct[]): CommercialPriors['commercial'][string] {
    const pairs = new Map<string, number>();
    const triples = new Map<string, number>();
    const ingredientFreq = new Map<string, number>();
    const totalProducts = products.length;

    // Count ingredient frequencies and pairs
    for (const product of products) {
      const ingredients = product.ingredients
        .sort((a, b) => a.position - b.position)
        .map(i => i.canonicalId);
      
      const uniqueIngredients = new Set(ingredients);

      // Count individual ingredients
      for (const ing of uniqueIngredients) {
        ingredientFreq.set(ing, (ingredientFreq.get(ing) || 0) + 1);
      }

      // Count pairs (sliding window)
      for (let i = 0; i < ingredients.length; i++) {
        for (let j = i + 1; j < ingredients.length; j++) {
          const pair = [ingredients[i], ingredients[j]].sort().join('|');
          pairs.set(pair, (pairs.get(pair) || 0) + 1);
        }
      }

      // Count triples (sliding window)
      for (let i = 0; i < ingredients.length; i++) {
        for (let j = i + 1; j < ingredients.length; j++) {
          for (let k = j + 1; k < ingredients.length; k++) {
            const triple = [ingredients[i], ingredients[j], ingredients[k]].sort().join('|');
            triples.set(triple, (triples.get(triple) || 0) + 1);
          }
        }
      }
    }

    // Compute PMI scores
    const pairPMI: Record<string, number> = {};
    const rarePairs: Record<string, number> = {};

    for (const [pair, pairCount] of pairs.entries()) {
      const [ing1, ing2] = pair.split('|');
      const count1 = ingredientFreq.get(ing1) || 0;
      const count2 = ingredientFreq.get(ing2) || 0;

      // Smoothed PMI
      const pXY = (pairCount + this.SMOOTHING) / (totalProducts + this.SMOOTHING);
      const pX = (count1 + this.SMOOTHING) / (totalProducts + this.SMOOTHING);
      const pY = (count2 + this.SMOOTHING) / (totalProducts + this.SMOOTHING);
      const pmi = Math.log2(pXY / (pX * pY));

      if (pmi > 0 && pairCount >= 2) {
        pairPMI[pair] = Math.round(pmi * 100) / 100;
      }

      // Rare pairs (negative PMI)
      if (pmi < this.RARE_PAIR_THRESHOLD && count1 >= 5 && count2 >= 5) {
        rarePairs[pair] = Math.round(pmi * 100) / 100;
      }
    }

    // Detect never-seen pairs (common ingredients that never co-occur)
    const commonIngredients = Array.from(ingredientFreq.entries())
      .filter(([_, count]) => count >= 5)
      .map(([ing, _]) => ing);

    for (let i = 0; i < commonIngredients.length; i++) {
      for (let j = i + 1; j < commonIngredients.length; j++) {
        const pair = [commonIngredients[i], commonIngredients[j]].sort().join('|');
        
        if (!pairs.has(pair)) {
          // Both common, but never paired
          const count1 = ingredientFreq.get(commonIngredients[i])!;
          const count2 = ingredientFreq.get(commonIngredients[j])!;
          const pX = (count1 + this.SMOOTHING) / (totalProducts + this.SMOOTHING);
          const pY = (count2 + this.SMOOTHING) / (totalProducts + this.SMOOTHING);
          const pXY = this.SMOOTHING / (totalProducts + this.SMOOTHING);
          const pmi = Math.log2(pXY / (pX * pY));
          
          if (pmi < -1.5) { // Strong negative association
            rarePairs[pair] = Math.round(pmi * 100) / 100;
          }
        }
      }
    }

    // Convert to objects
    const coOccurrencePairs: Record<string, number> = {};
    for (const [pair, count] of pairs.entries()) {
      if (count >= 2) {
        coOccurrencePairs[pair] = count;
      }
    }

    const coOccurrenceTriples: Record<string, number> = {};
    for (const [triple, count] of triples.entries()) {
      if (count >= 2) {
        coOccurrenceTriples[triple] = count;
      }
    }

    const ingredientFrequency: Record<string, number> = {};
    for (const [ing, count] of ingredientFreq.entries()) {
      ingredientFrequency[ing] = count;
    }

    // Compute ingredient count stats
    const ingredientCounts = products.map(p => p.ingredients.length);
    ingredientCounts.sort((a, b) => a - b);

    return {
      coOccurrencePairs,
      coOccurrenceTriples,
      ingredientFrequency,
      pairPMI,
      rarePairs,
      categoryRatios: {
        protein: { min: 0, max: 0, median: 0 }, // TODO: compute from categorized ingredients
        vegetable: { min: 0, max: 0, median: 0 },
        fat: { min: 0, max: 0, median: 0 },
        carbohydrate: { min: 0, max: 0, median: 0 },
      },
      ingredientCount: {
        min: ingredientCounts[0] || 0,
        max: ingredientCounts[ingredientCounts.length - 1] || 0,
        median: ingredientCounts[Math.floor(ingredientCounts.length / 2)] || 0,
      },
    };
  }

  private async mergeWithExistingPriors(newPriors: CommercialPriors, outputPath: string): Promise<void> {
    try {
      const existingContent = await fs.readFile(outputPath, 'utf-8');
      const existing = JSON.parse(existingContent);

      // Merge commercial priors into existing structure
      existing.commercial = newPriors.commercial;
      existing.commercialMetadata = newPriors.metadata;
      existing.version = newPriors.version;
      existing.generatedAt = newPriors.generatedAt;

      await fs.writeFile(outputPath, JSON.stringify(existing, null, 2), 'utf-8');
      console.log(`\nüíæ Merged commercial priors into: ${outputPath}`);
    } catch (error) {
      // File doesn't exist, create new
      await fs.writeFile(outputPath, JSON.stringify(newPriors, null, 2), 'utf-8');
      console.log(`\nüíæ Created new priors file: ${outputPath}`);
    }
  }

  private countByField(products: CanonicalizedProduct[], field: string | ((p: CanonicalizedProduct) => string)): Record<string, number> {
    const counts: Record<string, number> = {};
    
    for (const product of products) {
      const value = typeof field === 'function' ? field(product) : (product as any)[field];
      counts[value] = (counts[value] || 0) + 1;
    }
    
    return counts;
  }

  private printSummary(priors: CommercialPriors): void {
    console.log('\nüìà Commercial Pattern Summary:');
    console.log(`   Total products: ${priors.metadata.numProductsUsed}`);
    
    console.log('\n   By species:');
    for (const [species, count] of Object.entries(priors.metadata.bySpecies)) {
      const patterns = priors.commercial[species];
      const pairCount = Object.keys(patterns.coOccurrencePairs).length;
      const rarePairCount = Object.keys(patterns.rarePairs).length;
      console.log(`   ${species}: ${count} products, ${pairCount} pairs, ${rarePairCount} rare pairs`);
    }

    // Show top pairs for dogs (example)
    if (priors.commercial.dogs) {
      console.log('\n   Top 10 dog food pairs (by PMI):');
      const dogPairs = Object.entries(priors.commercial.dogs.pairPMI)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      for (const [pair, pmi] of dogPairs) {
        const count = priors.commercial.dogs.coOccurrencePairs[pair] || 0;
        console.log(`   ${pair.replace('|', ' + ')}: PMI=${pmi.toFixed(2)}, count=${count}`);
      }

      // Show rare pairs
      console.log('\n   Top 10 rare/never-seen dog pairs (negative PMI):');
      const rarePairs = Object.entries(priors.commercial.dogs.rarePairs)
        .sort((a, b) => a[1] - b[1])
        .slice(0, 10);
      
      for (const [pair, pmi] of rarePairs) {
        console.log(`   ${pair.replace('|', ' + ')}: PMI=${pmi.toFixed(2)} (RARE)`);
      }
    }
  }
}

// CLI execution
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.error('Usage: tsx extract-commercial-patterns.ts <input-file> <output-file>');
    console.error('Example: tsx extract-commercial-patterns.ts ./output/canonical-commercial-2025-12-19.json ../../lib/data/recipePriors.json');
    process.exit(1);
  }

  const [inputPath, outputPath] = args;
  const extractor = new CommercialPatternExtractor();
  
  await extractor.extractPatterns(inputPath, outputPath);
}

main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/training/extract-patterns.ts">
/**
 * PATTERN EXTRACTOR
 * Computes co-occurrence stats, ratio distributions, and patterns from labeled recipes
 * This is Step 3 of the training pipeline - generates recipePriors.json
 */

import * as fs from 'fs/promises';

interface LabeledRecipe {
  id: string;
  name: string;
  species: string[];
  ingredients: Array<{
    canonicalId: string;
    originalName: string;
  }>;
  labels: {
    mealType: 'complete_meal' | 'topper' | 'treat' | 'feeding_guide';
    prepStyle: 'cooked' | 'raw' | 'mixed' | 'unknown';
  };
}

interface RecipePriors {
  version: string;
  generatedAt: string;
  
  // Co-occurrence patterns with PMI scores
  coOccurrence: {
    [species: string]: {
      pairs: Record<string, number>; // "chicken_breast+carrot": 15 (raw count)
      triples: Record<string, number>; // "chicken_breast+carrot+rice": 8
      pairPMI: Record<string, number>; // "chicken_breast+carrot": 2.3 (smoothed PMI)
      negativePairs: Record<string, number>; // "turkey+anchovy_oil": -1.5 (negative PMI)
    };
  };
  
  // Category ratio distributions
  categoryRatios: {
    [species: string]: {
      protein: { mean: number; stdDev: number };
      vegetable: { mean: number; stdDev: number };
      fat: { mean: number; stdDev: number };
      carbohydrate: { mean: number; stdDev: number };
    };
  };
  
  // Ingredient count distributions
  ingredientCounts: {
    [species: string]: {
      mean: number;
      median: number;
      min: number;
      max: number;
    };
  };
  
  // Common ingredient pairs by category
  categoryPairs: {
    [species: string]: {
      proteinWithFat: Record<string, string[]>; // "chicken_breast": ["olive_oil", "fish_oil"]
      proteinWithVeg: Record<string, string[]>; // "beef": ["carrot", "spinach"]
    };
  };
  
  // Negative patterns (things to avoid)
  negativePatterns: {
    toxicIngredients: Record<string, string[]>; // species -> toxic ingredients
    structuralIssues: string[]; // "all_meat_no_calcium", "excessive_fat"
  };
}

class PatternExtractor {
  async extractPatterns(inputPath: string, outputPath: string): Promise<void> {
    console.log(`\nüìä Extracting patterns from: ${inputPath}`);
    
    const fileContent = await fs.readFile(inputPath, 'utf-8');
    const recipes: LabeledRecipe[] = JSON.parse(fileContent);
    console.log(`   Found ${recipes.length} labeled recipes`);

    // Filter to usable meal types (species-specific)
    const usableMeals = recipes.filter(r => {
      const mealType = r.labels.mealType;
      const species = r.species[0]; // Primary species
      
      // Dogs/Cats: only complete meals
      if (species === 'dogs' || species === 'cats') {
        return mealType === 'complete_meal';
      }
      
      // Birds: accept complete meals, measured mixes, ratio formulas
      if (species === 'birds') {
        return ['complete_meal', 'measured_mix', 'ratio_formula'].includes(mealType);
      }
      
      // Reptiles: accept complete meals, salad mixes, diet plans
      if (species === 'reptiles') {
        return ['complete_meal', 'measured_mix', 'ratio_formula', 'diet_plan_table'].includes(mealType);
      }
      
      // Pocket pets: accept complete meals, measured mixes, treat recipes
      if (species === 'pocket-pets') {
        return ['complete_meal', 'measured_mix', 'ratio_formula', 'treat'].includes(mealType);
      }
      
      return mealType === 'complete_meal';
    });
    console.log(`   Using ${usableMeals.length} usable recipes for pattern extraction (complete meals + exotic formats)`);

    const priors: RecipePriors = {
      version: '1.0.0',
      generatedAt: new Date().toISOString(),
      coOccurrence: {},
      categoryRatios: {},
      ingredientCounts: {},
      categoryPairs: {},
      negativePatterns: {
        toxicIngredients: {
          cats: ['onion', 'garlic', 'grapes', 'raisins', 'chocolate', 'xylitol', 'avocado'],
          dogs: ['onion', 'garlic', 'grapes', 'raisins', 'chocolate', 'xylitol', 'macadamia'],
          birds: ['avocado', 'chocolate', 'caffeine', 'salt', 'onion', 'garlic'],
          reptiles: ['avocado', 'rhubarb', 'onion'],
          'pocket-pets': ['chocolate', 'onion', 'garlic', 'avocado'],
        },
        structuralIssues: [
          'all_meat_no_calcium',
          'excessive_fat_over_70_percent',
          'single_ingredient',
          'no_protein_source',
        ],
      },
    };

    // Extract patterns by species
    const speciesList = ['cats', 'dogs', 'birds', 'reptiles', 'pocket-pets'];
    
    for (const species of speciesList) {
      const speciesRecipes = usableMeals.filter((r: LabeledRecipe) => r.species.includes(species));
      
      if (speciesRecipes.length === 0) {
        console.log(`   ‚ö†Ô∏è  No recipes found for ${species}`);
        continue;
      }

      console.log(`   Processing ${speciesRecipes.length} ${species} recipes...`);

      // Co-occurrence patterns
      priors.coOccurrence[species] = this.extractCoOccurrence(speciesRecipes);

      // Category ratios (simplified - would need actual category data)
      priors.categoryRatios[species] = this.extractCategoryRatios(speciesRecipes);

      // Ingredient counts
      priors.ingredientCounts[species] = this.extractIngredientCounts(speciesRecipes);

      // Category pairs
      priors.categoryPairs[species] = this.extractCategoryPairs(speciesRecipes);
    }

    await fs.writeFile(outputPath, JSON.stringify(priors, null, 2), 'utf-8');

    console.log(`\n‚úÖ Pattern extraction complete!`);
    console.log(`   Output: ${outputPath}`);
    this.printSummary(priors);
  }

  private extractCoOccurrence(recipes: LabeledRecipe[]): RecipePriors['coOccurrence'][string] {
    const pairs = new Map<string, number>();
    const triples = new Map<string, number>();
    const ingredientCounts = new Map<string, number>();
    const totalRecipes = recipes.length;

    // Count individual ingredients and pairs
    for (const recipe of recipes) {
      const ingredients = recipe.ingredients.map(i => i.canonicalId).sort();
      const uniqueIngredients = new Set(ingredients);

      // Count individual ingredient occurrences
      for (const ing of uniqueIngredients) {
        ingredientCounts.set(ing, (ingredientCounts.get(ing) || 0) + 1);
      }

      // Count pairs
      for (let i = 0; i < ingredients.length; i++) {
        for (let j = i + 1; j < ingredients.length; j++) {
          const pair = `${ingredients[i]}+${ingredients[j]}`;
          pairs.set(pair, (pairs.get(pair) || 0) + 1);
        }
      }

      // Count triples
      for (let i = 0; i < ingredients.length; i++) {
        for (let j = i + 1; j < ingredients.length; j++) {
          for (let k = j + 1; k < ingredients.length; k++) {
            const triple = `${ingredients[i]}+${ingredients[j]}+${ingredients[k]}`;
            triples.set(triple, (triples.get(triple) || 0) + 1);
          }
        }
      }
    }

    // Compute PMI scores for pairs
    const pairPMI: Record<string, number> = {};
    const negativePairs: Record<string, number> = {};
    const SMOOTHING = 0.5; // Laplace smoothing

    for (const [pair, pairCount] of pairs.entries()) {
      const [ing1, ing2] = pair.split('+');
      const count1 = ingredientCounts.get(ing1) || 0;
      const count2 = ingredientCounts.get(ing2) || 0;

      // Smoothed PMI: log(P(x,y) / (P(x) * P(y)))
      // P(x,y) = (pairCount + smoothing) / (totalRecipes + smoothing * totalPairs)
      // P(x) = (count1 + smoothing) / (totalRecipes + smoothing * totalIngredients)
      const pXY = (pairCount + SMOOTHING) / (totalRecipes + SMOOTHING);
      const pX = (count1 + SMOOTHING) / (totalRecipes + SMOOTHING);
      const pY = (count2 + SMOOTHING) / (totalRecipes + SMOOTHING);
      const pmi = Math.log2(pXY / (pX * pY));

      // Positive PMI = ingredients appear together more than expected
      if (pmi > 0 && pairCount >= 2) {
        pairPMI[pair] = Math.round(pmi * 100) / 100;
      }

      // Negative PMI = ingredients appear together LESS than expected
      // (both are common individually, but never paired)
      if (pmi < -0.5 && count1 >= 3 && count2 >= 3 && pairCount === 0) {
        negativePairs[pair] = Math.round(pmi * 100) / 100;
      }
    }

    // Detect negative pairs: common ingredients that NEVER appear together
    const commonIngredients = Array.from(ingredientCounts.entries())
      .filter(([_, count]) => count >= 3)
      .map(([ing, _]) => ing);

    for (let i = 0; i < commonIngredients.length; i++) {
      for (let j = i + 1; j < commonIngredients.length; j++) {
        const pair = `${commonIngredients[i]}+${commonIngredients[j]}`;
        if (!pairs.has(pair)) {
          // Both ingredients are common, but they NEVER appear together
          const count1 = ingredientCounts.get(commonIngredients[i])!;
          const count2 = ingredientCounts.get(commonIngredients[j])!;
          const pX = (count1 + SMOOTHING) / (totalRecipes + SMOOTHING);
          const pY = (count2 + SMOOTHING) / (totalRecipes + SMOOTHING);
          const pXY = SMOOTHING / (totalRecipes + SMOOTHING); // Only smoothing, no actual co-occurrence
          const pmi = Math.log2(pXY / (pX * pY));
          
          if (pmi < -1.0) { // Strong negative association
            negativePairs[pair] = Math.round(pmi * 100) / 100;
          }
        }
      }
    }

    // Convert to object and filter low counts
    const pairsObj: Record<string, number> = {};
    for (const [pair, count] of pairs.entries()) {
      if (count >= 2) {
        pairsObj[pair] = count;
      }
    }

    const triplesObj: Record<string, number> = {};
    for (const [triple, count] of triples.entries()) {
      if (count >= 2) {
        triplesObj[triple] = count;
      }
    }

    return { 
      pairs: pairsObj, 
      triples: triplesObj,
      pairPMI,
      negativePairs
    };
  }

  private extractCategoryRatios(recipes: LabeledRecipe[]): RecipePriors['categoryRatios'][string] {
    // Simplified - in real implementation, would categorize ingredients and compute actual ratios
    // For now, return typical ratios based on species
    return {
      protein: { mean: 0.4, stdDev: 0.1 },
      vegetable: { mean: 0.3, stdDev: 0.1 },
      fat: { mean: 0.15, stdDev: 0.05 },
      carbohydrate: { mean: 0.15, stdDev: 0.05 },
    };
  }

  private extractIngredientCounts(recipes: LabeledRecipe[]): RecipePriors['ingredientCounts'][string] {
    const counts = recipes.map(r => r.ingredients.length);
    counts.sort((a, b) => a - b);

    const mean = counts.reduce((sum, c) => sum + c, 0) / counts.length;
    const median = counts[Math.floor(counts.length / 2)];

    return {
      mean: Math.round(mean * 10) / 10,
      median,
      min: counts[0],
      max: counts[counts.length - 1],
    };
  }

  private extractCategoryPairs(recipes: LabeledRecipe[]): RecipePriors['categoryPairs'][string] {
    const proteinWithFat = new Map<string, Set<string>>();
    const proteinWithVeg = new Map<string, Set<string>>();

    for (const recipe of recipes) {
      const ingredients = recipe.ingredients.map(i => i.canonicalId);

      // Simplified categorization (would use actual category data)
      const proteins = ingredients.filter(i => this.isProtein(i));
      const fats = ingredients.filter(i => this.isFat(i));
      const vegs = ingredients.filter(i => this.isVegetable(i));

      for (const protein of proteins) {
        // Track protein-fat pairs
        for (const fat of fats) {
          if (!proteinWithFat.has(protein)) {
            proteinWithFat.set(protein, new Set());
          }
          proteinWithFat.get(protein)!.add(fat);
        }

        // Track protein-veg pairs
        for (const veg of vegs) {
          if (!proteinWithVeg.has(protein)) {
            proteinWithVeg.set(protein, new Set());
          }
          proteinWithVeg.get(protein)!.add(veg);
        }
      }
    }

    // Convert to object
    const proteinWithFatObj: Record<string, string[]> = {};
    for (const [protein, fats] of proteinWithFat.entries()) {
      proteinWithFatObj[protein] = Array.from(fats);
    }

    const proteinWithVegObj: Record<string, string[]> = {};
    for (const [protein, vegs] of proteinWithVeg.entries()) {
      proteinWithVegObj[protein] = Array.from(vegs);
    }

    return {
      proteinWithFat: proteinWithFatObj,
      proteinWithVeg: proteinWithVegObj,
    };
  }

  private isProtein(ingredient: string): boolean {
    const proteinKeywords = ['chicken', 'beef', 'turkey', 'fish', 'salmon', 'tuna', 'liver', 'heart', 'egg'];
    return proteinKeywords.some(kw => ingredient.toLowerCase().includes(kw));
  }

  private isFat(ingredient: string): boolean {
    const fatKeywords = ['oil', 'fat', 'butter'];
    return fatKeywords.some(kw => ingredient.toLowerCase().includes(kw));
  }

  private isVegetable(ingredient: string): boolean {
    const vegKeywords = ['carrot', 'spinach', 'broccoli', 'pea', 'sweet_potato', 'pumpkin', 'kale'];
    return vegKeywords.some(kw => ingredient.toLowerCase().includes(kw));
  }

  private printSummary(priors: RecipePriors): void {
    console.log('\nüìà Pattern Summary:');
    
    for (const [species, data] of Object.entries(priors.coOccurrence)) {
      const pairCount = Object.keys(data.pairs).length;
      const tripleCount = Object.keys(data.triples).length;
      console.log(`   ${species}: ${pairCount} ingredient pairs, ${tripleCount} triples`);
    }

    console.log('\nüìä Ingredient Count Ranges:');
    for (const [species, counts] of Object.entries(priors.ingredientCounts)) {
      console.log(`   ${species}: ${counts.min}-${counts.max} (median: ${counts.median})`);
    }
  }
}

// CLI execution
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.error('Usage: ts-node extract-patterns.ts <input-file> <output-file>');
    console.error('Example: ts-node extract-patterns.ts ./output/labeled-recipes.json ../../lib/data/recipePriors.json');
    process.exit(1);
  }

  const [inputPath, outputPath] = args;
  const extractor = new PatternExtractor();
  
  await extractor.extractPatterns(inputPath, outputPath);
}

// Run if executed directly
main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/training/extract-top-ingredients.ts">
/**
 * Extract top 4-5 ingredients from commercial products
 * Translate to English and normalize to registry names
 */

import * as fs from 'fs/promises';

interface CommercialProduct {
  brand: string;
  productName: string;
  speciesHint: string[];
  ingredientsList: Array<{ name: string; position: number }>;
}

// Translation map: foreign -> English
const TRANSLATIONS: Record<string, string> = {
  // French
  'viandes et sous-produits animaux': 'meat',
  'viandes': 'meat',
  'viande': 'meat',
  'poulet': 'chicken',
  'boeuf': 'beef',
  'agneau': 'lamb',
  'canard': 'duck',
  'dinde': 'turkey',
  'poisson': 'fish',
  'saumon': 'salmon',
  'thon': 'tuna',
  'c√©r√©ales': 'grain',
  'bl√©': 'wheat',
  'ma√Øs': 'corn',
  'riz': 'rice',
  'avoine': 'oats',
  'l√©gumes': 'vegetable',
  'carottes': 'carrot',
  'petits pois': 'peas',
  'pommes de terre': 'potato',
  'patates douces': 'sweet_potato',
  'huiles et graisses': 'fat',
  'huile de poisson': 'fish_oil',
  'graisse de volaille': 'chicken_fat',
  'graisse de canard': 'duck_fat',
  'pulpe de betterave': 'beet_pulp',
  'sous-produits d\'origine v√©g√©tale': 'vegetable',
  'substances min√©rales': 'minerals',
  'levures': 'yeast',
  'levure': 'yeast',
  'poudre d\'oeuf': 'egg',
  'oeuf': 'egg',
  
  // Italian
  'carni e derivati': 'meat',
  'carni': 'meat',
  'carne': 'meat',
  'pollo': 'chicken',
  'manzo': 'beef',
  'agnello': 'lamb',
  'pesce': 'fish',
  'tonno': 'tuna',
  'cereali': 'grain',
  'grano': 'wheat',
  'mais': 'corn',
  'riso': 'rice',
  'verdure': 'vegetable',
  'carote': 'carrot',
  'piselli': 'peas',
  'patate': 'potato',
  'oli e grassi': 'fat',
  'oli': 'oil',
  'grassi': 'fat',
  'sottoprodotti di origine vegetale': 'vegetable',
  'sostanze minerali': 'minerals',
  'lievito': 'yeast',
  'uova': 'egg',
  
  // German
  'fleisch': 'meat',
  'huhn': 'chicken',
  'h√ºhnerfleisch': 'chicken',
  'rind': 'beef',
  'rindfleisch': 'beef',
  'lamm': 'lamb',
  'lammfleisch': 'lamb',
  'pute': 'turkey',
  'putenfleisch': 'turkey',
  'ente': 'duck',
  'fisch': 'fish',
  'lachs': 'salmon',
  'thunfisch': 'tuna',
  'getreide': 'grain',
  'weizen': 'wheat',
  'reis': 'rice',
  'hafer': 'oats',
  'gem√ºse': 'vegetable',
  'karotten': 'carrot',
  'm√∂hren': 'carrot',
  'erbsen': 'peas',
  'kartoffeln': 'potato',
  'mineralstoffe': 'minerals',
  
  // Spanish (only add unique ones not in Italian)
  'ternera': 'beef',
  'cordero': 'lamb',
  'pavo': 'turkey',
  'pato': 'duck',
  'pescado': 'fish',
  'salm√≥n': 'salmon',
  'at√∫n': 'tuna',
  'trigo': 'wheat',
  'ma√≠z': 'corn',
  'arroz': 'rice',
  'verduras': 'vegetable',
  'zanahorias': 'carrot',
  'guisantes': 'peas',
  'patatas': 'potato',
  
  // English variations
  'meat and animal derivatives': 'meat',
  'meat and animal by-products': 'meat',
  'animal by-products': 'meat',
  'chicken meal': 'chicken',
  'chicken by-product': 'chicken',
  'beef meal': 'beef',
  'lamb meal': 'lamb',
  'fish meal': 'fish',
  'salmon meal': 'salmon',
  'ocean fish': 'fish',
  'corn meal': 'corn',
  'ground corn': 'corn',
  'brewers rice': 'rice',
  'brown rice': 'rice',
  'white rice': 'rice',
  'whole grain': 'grain',
  'vegetable oil': 'vegetable_oil',
  'chicken fat': 'chicken_fat',
  'animal fat': 'fat',
  'beet pulp': 'beet_pulp',
  'dried beet pulp': 'beet_pulp',
  'sweet potato': 'sweet_potato',
  'dried sweet potato': 'sweet_potato',
};

async function extractTopIngredients() {
  const data = await fs.readFile('./output/commercial-products-2025-12-19T02-57-56.json', 'utf-8');
  const products: CommercialProduct[] = JSON.parse(data);
  
  console.log(`\nüìä Extracting top 5 ingredients from ${products.length} products...\n`);
  
  const topIngredientPairs: Record<string, number> = {};
  const ingredientFrequency: Record<string, number> = {};
  let successCount = 0;
  
  for (const product of products) {
    // Get top 5 ingredients (positions 1-5)
    const topIngredients = product.ingredientsList
      .filter(i => i.position <= 5)
      .map(i => translateAndNormalize(i.name))
      .filter(i => i !== 'unknown' && i !== 'minerals' && i !== 'vitamins');
    
    if (topIngredients.length >= 2) {
      successCount++;
      
      // Count individual ingredients
      topIngredients.forEach(ing => {
        ingredientFrequency[ing] = (ingredientFrequency[ing] || 0) + 1;
      });
      
      // Count pairs
      for (let i = 0; i < topIngredients.length; i++) {
        for (let j = i + 1; j < topIngredients.length; j++) {
          const pair = [topIngredients[i], topIngredients[j]].sort().join('|');
          topIngredientPairs[pair] = (topIngredientPairs[pair] || 0) + 1;
        }
      }
    }
  }
  
  console.log(`‚úÖ Extracted top ingredients from ${successCount}/${products.length} products\n`);
  
  // Show top ingredient frequencies
  console.log('Top 20 ingredients by frequency:');
  Object.entries(ingredientFrequency)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20)
    .forEach(([ing, count]) => console.log(`  ${count.toString().padStart(4)} | ${ing}`));
  
  console.log('\nTop 30 ingredient pairs:');
  Object.entries(topIngredientPairs)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 30)
    .forEach(([pair, count]) => console.log(`  ${count.toString().padStart(4)} | ${pair.replace('|', ' + ')}`));
  
  // Save results
  await fs.writeFile(
    './output/commercial-top-ingredients.json',
    JSON.stringify({ ingredientFrequency, topIngredientPairs }, null, 2),
    'utf-8'
  );
  
  console.log('\nüíæ Saved to commercial-top-ingredients.json');
}

function translateAndNormalize(name: string): string {
  let normalized = name.toLowerCase().trim();
  
  // Remove parenthetical content
  normalized = normalized.replace(/\([^)]*\)/g, '');
  
  // Remove percentages and numbers
  normalized = normalized.replace(/\d+%?/g, '');
  
  // Remove extra whitespace
  normalized = normalized.replace(/\s+/g, ' ').trim();
  
  // Skip if too short or looks like junk
  if (normalized.length < 3 || normalized.includes('mg') || normalized.includes('ui') || normalized.includes('ie')) {
    return 'unknown';
  }
  
  // Check translation map
  if (TRANSLATIONS[normalized]) {
    return TRANSLATIONS[normalized];
  }
  
  // Pattern matching for common ingredients
  if (normalized.includes('chicken') || normalized.includes('poulet') || normalized.includes('pollo') || normalized.includes('huhn')) return 'chicken';
  if (normalized.includes('beef') || normalized.includes('boeuf') || normalized.includes('manzo') || normalized.includes('rind')) return 'beef';
  if (normalized.includes('lamb') || normalized.includes('agneau') || normalized.includes('lamm')) return 'lamb';
  if (normalized.includes('turkey') || normalized.includes('dinde') || normalized.includes('pute')) return 'turkey';
  if (normalized.includes('duck') || normalized.includes('canard') || normalized.includes('ente')) return 'duck';
  if (normalized.includes('salmon') || normalized.includes('saumon') || normalized.includes('lachs')) return 'salmon';
  if (normalized.includes('tuna') || normalized.includes('thon') || normalized.includes('tonno')) return 'tuna';
  if (normalized.includes('fish') || normalized.includes('poisson') || normalized.includes('fisch') || normalized.includes('pesce')) return 'fish';
  if (normalized.includes('rabbit') || normalized.includes('lapin') || normalized.includes('kaninchen')) return 'rabbit';
  if (normalized.includes('venison') || normalized.includes('wild') || normalized.includes('gibier')) return 'venison';
  
  if (normalized.includes('rice') || normalized.includes('riz') || normalized.includes('reis') || normalized.includes('riso')) return 'rice';
  if (normalized.includes('corn') || normalized.includes('ma√Øs') || normalized.includes('mais')) return 'corn';
  if (normalized.includes('wheat') || normalized.includes('bl√©') || normalized.includes('weizen') || normalized.includes('grano')) return 'wheat';
  if (normalized.includes('oat') || normalized.includes('avoine') || normalized.includes('hafer')) return 'oats';
  if (normalized.includes('barley') || normalized.includes('orge') || normalized.includes('gerste')) return 'barley';
  
  if (normalized.includes('carrot') || normalized.includes('carote') || normalized.includes('karotten') || normalized.includes('m√∂hren')) return 'carrot';
  if (normalized.includes('pea') || normalized.includes('pois') || normalized.includes('piselli') || normalized.includes('erbsen')) return 'peas';
  if (normalized.includes('potato') || normalized.includes('patate') || normalized.includes('kartoffel')) return 'potato';
  if (normalized.includes('sweet potato') || normalized.includes('patate douce')) return 'sweet_potato';
  if (normalized.includes('pumpkin') || normalized.includes('citrouille') || normalized.includes('zucca')) return 'pumpkin';
  if (normalized.includes('spinach') || normalized.includes('√©pinard') || normalized.includes('spinaci')) return 'spinach';
  
  if (normalized.includes('egg') || normalized.includes('oeuf') || normalized.includes('uova') || normalized.includes('ei')) return 'egg';
  if (normalized.includes('yeast') || normalized.includes('levure') || normalized.includes('lievito')) return 'yeast';
  
  return 'unknown';
}

extractTopIngredients().catch(console.error);
</file>

<file path="scripts/training/llm-label-recipes.ts">
/**
 * LLM RECIPE LABELER
 * Uses LLM to classify and extract structured data from canonicalized recipes
 * This is Step 2 of the training pipeline
 */

import * as fs from 'fs/promises';

type CanonicalizedRecipe = {
  id: string;
  name: string;
  species: string[];
  ingredients: Array<{
    canonicalId: string;
    originalName: string;
  }>;
  instructions?: string[];
  warnings?: string[];
}

type LabeledRecipe = CanonicalizedRecipe & {
  labels: {
    speciesGuess: string[];
    mealType: 'complete_meal' | 'topper' | 'treat' | 'feeding_guide';
    prepStyle: 'cooked' | 'raw' | 'mixed' | 'unknown';
    warnings: string[];
    missingNutrients?: string[];
    confidence: number;
  };
}

/**
 * PROMPT TEMPLATE FOR LLM LABELING
 * Send this to your LLM API (OpenAI, Anthropic, etc.)
 */
export const RECIPE_LABELING_PROMPT = `You are a veterinary nutritionist analyzing pet food recipes.

Given a recipe with:
- Title
- Species (cats, dogs, birds, reptiles, pocket-pets)
- Ingredients list
- Instructions (if available)
- Warnings (if available)

Output strict JSON with these fields:

{
  "speciesGuess": ["cats"] // Confirm or correct the species
  "mealType": "complete_meal" | "topper" | "treat" | "feeding_guide",
  "prepStyle": "cooked" | "raw" | "mixed" | "unknown",
  "warnings": [
    "Missing calcium source",
    "High fat content - may cause pancreatitis",
    "Contains onion - toxic to dogs"
  ],
  "missingNutrients": ["calcium", "taurine", "vitamin_e"], // If incomplete
  "confidence": 0.85 // 0-1 scale
}

Rules:
1. "complete_meal" = balanced, can be fed as primary diet
2. "topper" = meant to mix with kibble/other food
3. "treat" = occasional snack, not nutritionally complete
4. "feeding_guide" = general advice, not a specific recipe

5. Flag missing critical nutrients:
   - Cats: taurine, calcium, vitamin_a, arachidonic_acid
   - Dogs: calcium, vitamin_d, vitamin_e
   - Birds: calcium, vitamin_a
   - Reptiles: calcium, vitamin_d3

6. Flag toxic ingredients:
   - Onion, garlic, grapes, raisins, xylitol, chocolate, avocado (for some species)

7. Flag structural issues:
   - All meat, no calcium = "Missing calcium source"
   - >70% fat calories = "Excessive fat content"
   - Single ingredient = "Not a complete meal"

Recipe to analyze:
---
Title: {title}
Species: {species}
Ingredients: {ingredients}
Instructions: {instructions}
Warnings: {warnings}
---

Output JSON only, no explanation:`;

class RecipeLabeler {
  /**
   * This is a STUB - you need to implement actual LLM API calls
   * Use OpenAI, Anthropic, or your preferred LLM provider
   */
  async labelRecipe(recipe: CanonicalizedRecipe): Promise<LabeledRecipe> {
    // TODO: Replace with actual LLM API call
    // const prompt = this.buildPrompt(recipe);
    // const response = await openai.chat.completions.create({...});
    // const labels = JSON.parse(response.choices[0].message.content);

    // For now, return heuristic labels
    const labels = this.heuristicLabels(recipe);

    return {
      ...recipe,
      labels,
    };
  }

  async labelRecipeFile(inputPath: string, outputPath: string): Promise<void> {
    console.log(`\nüè∑Ô∏è  Labeling recipes from: ${inputPath}`);
    
    const fileContent = await fs.readFile(inputPath, 'utf-8');
    const recipes: CanonicalizedRecipe[] = JSON.parse(fileContent);
    console.log(`   Found ${recipes.length} canonicalized recipes`);

    const labeled: LabeledRecipe[] = [];

    for (const recipe of recipes) {
      const labeledRecipe = await this.labelRecipe(recipe);
      labeled.push(labeledRecipe);
      
      if (labeled.length % 10 === 0) {
        console.log(`   Labeled ${labeled.length}/${recipes.length} recipes...`);
      }
    }

    await fs.writeFile(outputPath, JSON.stringify(labeled, null, 2), 'utf-8');

    console.log(`\n‚úÖ Labeling complete!`);
    console.log(`   Total labeled: ${labeled.length}`);
    console.log(`   Output: ${outputPath}`);
  }

  private buildPrompt(recipe: CanonicalizedRecipe): string {
    return RECIPE_LABELING_PROMPT
      .replace('{title}', recipe.name)
      .replace('{species}', recipe.species.join(', '))
      .replace('{ingredients}', recipe.ingredients.map(i => i.canonicalId).join(', '))
      .replace('{instructions}', recipe.instructions?.join('\n') || 'None')
      .replace('{warnings}', recipe.warnings?.join('\n') || 'None');
  }

  /**
   * Heuristic labeling (fallback when no LLM available)
   */
  private heuristicLabels(recipe: CanonicalizedRecipe): LabeledRecipe['labels'] {
    const title = recipe.name.toLowerCase();
    const ingredientIds = recipe.ingredients.map(i => i.canonicalId.toLowerCase());

    // Detect meal type
    let mealType: LabeledRecipe['labels']['mealType'] = 'complete_meal';
    if (title.includes('treat') || title.includes('snack')) {
      mealType = 'treat';
    } else if (title.includes('topper') || title.includes('mix-in')) {
      mealType = 'topper';
    } else if (title.includes('guide') || title.includes('feeding')) {
      mealType = 'feeding_guide';
    }

    // Detect prep style
    const instructions = recipe.instructions?.join(' ').toLowerCase() || '';
    let prepStyle: LabeledRecipe['labels']['prepStyle'] = 'unknown';
    if (instructions.includes('cook') || instructions.includes('bake')) {
      prepStyle = 'cooked';
    } else if (instructions.includes('raw')) {
      prepStyle = 'raw';
    }

    // Detect warnings
    const warnings: string[] = [];
    const missingNutrients: string[] = [];

    // Check for calcium
    const hasCalcium = ingredientIds.some(id => 
      id.includes('calcium') || id.includes('bone') || id.includes('eggshell')
    );
    if (!hasCalcium && recipe.species.includes('cats' || 'dogs')) {
      warnings.push('Missing calcium source');
      missingNutrients.push('calcium');
    }

    // Check for taurine (cats)
    if (recipe.species.includes('cats')) {
      const hasTaurine = ingredientIds.some(id => 
        id.includes('heart') || id.includes('liver') || id.includes('taurine')
      );
      if (!hasTaurine) {
        warnings.push('Missing taurine source for cats');
        missingNutrients.push('taurine');
      }
    }

    // Check for toxic ingredients
    const toxicIngredients = ['onion', 'garlic', 'grape', 'raisin', 'chocolate', 'xylitol'];
    for (const toxic of toxicIngredients) {
      if (ingredientIds.some(id => id.includes(toxic))) {
        warnings.push(`Contains ${toxic} - potentially toxic`);
      }
    }

    return {
      speciesGuess: recipe.species,
      mealType,
      prepStyle,
      warnings,
      missingNutrients: missingNutrients.length > 0 ? missingNutrients : undefined,
      confidence: 0.7, // Heuristic confidence
    };
  }
}

// CLI execution
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.error('Usage: ts-node llm-label-recipes.ts <input-file> <output-file>');
    console.error('Example: ts-node llm-label-recipes.ts ./output/canonical-recipes.json ./output/labeled-recipes.json');
    process.exit(1);
  }

  const [inputPath, outputPath] = args;
  const labeler = new RecipeLabeler();
  
  await labeler.labelRecipeFile(inputPath, outputPath);
}

// Run if executed directly
main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/training/run-commercial-training.ps1">
# COMMERCIAL PET FOOD TRAINING PIPELINE
# Runs: scrape ‚Üí canonicalize ‚Üí extract patterns

Write-Host "`nüöÄ Starting Commercial Pet Food Training Pipeline`n" -ForegroundColor Green

# Step 1: Scrape commercial products
Write-Host "Step 1: Scraping Open Pet Food Facts..." -ForegroundColor Cyan
npx tsx scrape-commercial.ts
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Scraping failed!" -ForegroundColor Red
    exit 1
}

# Find the most recent commercial products file
$latestProducts = Get-ChildItem -Path ".\output\commercial-products-*.json" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
if (-not $latestProducts) {
    Write-Host "‚ùå No commercial products file found!" -ForegroundColor Red
    exit 1
}
Write-Host "‚úÖ Found products file: $($latestProducts.Name)" -ForegroundColor Green

# Step 2: Canonicalize ingredients
Write-Host "`nStep 2: Canonicalizing ingredients..." -ForegroundColor Cyan
npx tsx canonicalize-commercial.ts $latestProducts.FullName ".\output"
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Canonicalization failed!" -ForegroundColor Red
    exit 1
}

# Find the most recent canonical file
$latestCanonical = Get-ChildItem -Path ".\output\canonical-commercial-*.json" -Exclude "*-all-*" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
if (-not $latestCanonical) {
    Write-Host "‚ùå No canonical file found!" -ForegroundColor Red
    exit 1
}
Write-Host "‚úÖ Found canonical file: $($latestCanonical.Name)" -ForegroundColor Green

# Step 3: Extract patterns
Write-Host "`nStep 3: Extracting commercial patterns..." -ForegroundColor Cyan
npx tsx extract-commercial-patterns.ts $latestCanonical.FullName "..\..\lib\data\recipePriors.json"
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Pattern extraction failed!" -ForegroundColor Red
    exit 1
}

Write-Host "`n‚úÖ Commercial training pipeline complete!" -ForegroundColor Green
Write-Host "üìä Updated recipePriors.json with commercial data" -ForegroundColor Green
</file>

<file path="scripts/training/run-training-pipeline.ps1">
# COMPLETE TRAINING PIPELINE (PowerShell version)
# Converts scraped recipes into training data for RecipeBuilder
# Run this after scraping recipes from blogs/Reddit

$ErrorActionPreference = "Stop"

Write-Host "Pet Plates Recipe Training Pipeline" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

# Configuration
$SCRAPER_OUTPUT_DIR = "..\..\pet-recipe-scraper\output"
$TRAINING_OUTPUT_DIR = ".\output"
$PRIORS_OUTPUT = "..\..\lib\data\recipePriors.json"

# Create output directory
New-Item -ItemType Directory -Force -Path $TRAINING_OUTPUT_DIR | Out-Null

# Find the most recent scraped recipe file
$blogFiles = Get-ChildItem "$SCRAPER_OUTPUT_DIR\blog-recipes-*.json" -ErrorAction SilentlyContinue
$redditFiles = Get-ChildItem "$SCRAPER_OUTPUT_DIR\reddit-recipes-*.json" -ErrorAction SilentlyContinue
$bulkFiles = Get-ChildItem "$SCRAPER_OUTPUT_DIR\bulk-recipes-*.json" -ErrorAction SilentlyContinue

$allFiles = @($blogFiles) + @($redditFiles) + @($bulkFiles) | Sort-Object LastWriteTime -Descending

if ($allFiles.Count -eq 0) {
    Write-Host "ERROR: No scraped recipe files found in $SCRAPER_OUTPUT_DIR" -ForegroundColor Red
    Write-Host "   Run the scraper first: cd pet-recipe-scraper && npm run scrape:blogs"
    exit 1
}

$SCRAPED_FILE = $allFiles[0].FullName
Write-Host "Using scraped recipes: $($allFiles[0].Name)"
Write-Host "   File size: $([math]::Round($allFiles[0].Length / 1KB, 2)) KB"
Write-Host ""

# Quick check: how many recipes are in the file?
try {
    $recipeData = Get-Content $SCRAPED_FILE | ConvertFrom-Json
    $recipeCount = $recipeData.Count
    Write-Host "   Contains: $recipeCount recipes" -ForegroundColor Green
    Write-Host ""
} catch {
    Write-Host "   WARNING: Could not parse recipe count" -ForegroundColor Yellow
    Write-Host ""
}

# Step 1: Canonicalize recipes
Write-Host "Step 1: Canonicalizing recipes..." -ForegroundColor Cyan
$CANONICAL_FILE = "$TRAINING_OUTPUT_DIR\canonical-recipes.json"
npx tsx canonicalize-recipes.ts "$SCRAPED_FILE" "$CANONICAL_FILE"

if (-not (Test-Path $CANONICAL_FILE)) {
    Write-Host "ERROR: Canonicalization failed" -ForegroundColor Red
    exit 1
}
Write-Host ""

# Step 2: Label recipes with LLM
Write-Host "Step 2: Labeling recipes..." -ForegroundColor Cyan
$LABELED_FILE = "$TRAINING_OUTPUT_DIR\labeled-recipes.json"
npx tsx llm-label-recipes.ts "$CANONICAL_FILE" "$LABELED_FILE"

if (-not (Test-Path $LABELED_FILE)) {
    Write-Host "ERROR: Labeling failed" -ForegroundColor Red
    exit 1
}
Write-Host ""

# Step 3: Extract patterns
Write-Host "Step 3: Extracting patterns..." -ForegroundColor Cyan
npx tsx extract-patterns.ts "$LABELED_FILE" "$PRIORS_OUTPUT"

if (-not (Test-Path $PRIORS_OUTPUT)) {
    Write-Host "ERROR: Pattern extraction failed" -ForegroundColor Red
    exit 1
}
Write-Host ""

Write-Host "SUCCESS: Training pipeline complete!" -ForegroundColor Green
Write-Host ""
Write-Host "Generated files:"
Write-Host "   - Canonical recipes: $CANONICAL_FILE"
Write-Host "   - Labeled recipes: $LABELED_FILE"
Write-Host "   - Recipe priors: $PRIORS_OUTPUT"
Write-Host ""
Write-Host "Next steps:"
Write-Host "   1. Review the generated recipePriors.json"
Write-Host "   2. The RecipeBuilder will automatically use these priors for scoring"
Write-Host "   3. Generate some recipes to see the improved variety!"
Write-Host ""
</file>

<file path="scripts/training/run-training-pipeline.sh">
#!/bin/bash
# COMPLETE TRAINING PIPELINE
# Converts scraped recipes into training data for RecipeBuilder
# Run this after scraping recipes from blogs/Reddit

set -e  # Exit on error

echo "üöÄ Pet Plates Recipe Training Pipeline"
echo "========================================"
echo ""

# Configuration
SCRAPER_OUTPUT_DIR="../pet-recipe-scraper/output"
TRAINING_OUTPUT_DIR="./training/output"
PRIORS_OUTPUT="../../lib/data/recipePriors.json"

# Create output directory
mkdir -p "$TRAINING_OUTPUT_DIR"

# Find the most recent scraped recipe file
SCRAPED_FILE=$(ls -t "$SCRAPER_OUTPUT_DIR"/blog-recipes-*.json "$SCRAPER_OUTPUT_DIR"/reddit-recipes-*.json 2>/dev/null | head -n 1)

if [ -z "$SCRAPED_FILE" ]; then
    echo "‚ùå No scraped recipe files found in $SCRAPER_OUTPUT_DIR"
    echo "   Run the scraper first: cd pet-recipe-scraper && npm run scrape:blogs"
    exit 1
fi

echo "üìÇ Using scraped recipes: $SCRAPED_FILE"
echo ""

# Step 1: Canonicalize recipes
echo "üìñ Step 1: Canonicalizing recipes..."
CANONICAL_FILE="$TRAINING_OUTPUT_DIR/canonical-recipes.json"
npx ts-node canonicalize-recipes.ts "$SCRAPED_FILE" "$CANONICAL_FILE"

if [ ! -f "$CANONICAL_FILE" ]; then
    echo "‚ùå Canonicalization failed"
    exit 1
fi
echo ""

# Step 2: Label recipes with LLM
echo "üè∑Ô∏è  Step 2: Labeling recipes..."
LABELED_FILE="$TRAINING_OUTPUT_DIR/labeled-recipes.json"
npx ts-node llm-label-recipes.ts "$CANONICAL_FILE" "$LABELED_FILE"

if [ ! -f "$LABELED_FILE" ]; then
    echo "‚ùå Labeling failed"
    exit 1
fi
echo ""

# Step 3: Extract patterns
echo "üìä Step 3: Extracting patterns..."
npx ts-node extract-patterns.ts "$LABELED_FILE" "$PRIORS_OUTPUT"

if [ ! -f "$PRIORS_OUTPUT" ]; then
    echo "‚ùå Pattern extraction failed"
    exit 1
fi
echo ""

echo "‚úÖ Training pipeline complete!"
echo ""
echo "üìÅ Generated files:"
echo "   - Canonical recipes: $CANONICAL_FILE"
echo "   - Labeled recipes: $LABELED_FILE"
echo "   - Recipe priors: $PRIORS_OUTPUT"
echo ""
echo "üéØ Next steps:"
echo "   1. Review the generated recipePriors.json"
echo "   2. The RecipeBuilder will automatically use these priors for scoring"
echo "   3. Generate some recipes to see the improved variety!"
echo ""
</file>

<file path="scripts/training/scrape-commercial.ts">
/**
 * COMMERCIAL PET FOOD SCRAPER
 * Scrapes ingredient panels from Open Pet Food Facts API and brand pages
 * Stores normalized CommercialProduct records
 */

import axios from 'axios';
import * as fs from 'fs/promises';
import * as cheerio from 'cheerio';

interface CommercialProduct {
  source: 'openpetfoodfacts' | 'brand' | 'retail';
  sourceUrl: string;
  brand: string;
  productName: string;
  speciesHint: string[];
  productType: 'wet' | 'dry' | 'pellet' | 'mix' | 'treat' | 'unknown';
  ingredientsRaw: string | string[];
  ingredientsList: Array<{ name: string; position: number }>;
  scrapedAt: string;
  barcode?: string;
}

class CommercialScraper {
  private products: CommercialProduct[] = [];
  private readonly OPFF_BASE = 'https://world.openpetfoodfacts.org';
  private readonly OPFF_SEARCH = `${this.OPFF_BASE}/cgi/search.pl`;
  
  async scrapeOpenPetFoodFacts(): Promise<void> {
    console.log('\nüîç Scraping Open Pet Food Facts...\n');
    
    const categories = [
      { category: 'dog-foods', species: ['dogs'] },
      { category: 'cat-foods', species: ['cats'] },
      { category: 'bird-foods', species: ['birds'] },
      { category: 'small-pet-foods', species: ['pocket-pets'] },
      { category: 'reptile-foods', species: ['reptiles'] },
    ];

    for (const { category, species } of categories) {
      console.log(`üì¶ Fetching ${category}...`);
      await this.fetchOPFFCategory(category, species);
      await this.sleep(2000); // Rate limit
    }

    console.log(`\n‚úÖ Scraped ${this.products.length} products from Open Pet Food Facts`);
  }

  private async fetchOPFFCategory(category: string, species: string[]): Promise<void> {
    let page = 1;
    const pageSize = 100;
    let hasMore = true;

    while (hasMore && page <= 10) { // Limit to 10 pages per category
      try {
        const url = `${this.OPFF_SEARCH}?action=process&tagtype_0=categories&tag_contains_0=contains&tag_0=${category}&page_size=${pageSize}&page=${page}&json=1`;
        
        console.log(`   Page ${page}...`);
        const response = await axios.get(url, {
          timeout: 30000,
          headers: { 'User-Agent': 'PetPlates-Research/1.0' }
        });

        const data = response.data;
        
        if (!data.products || data.products.length === 0) {
          hasMore = false;
          break;
        }

        for (const product of data.products) {
          const normalized = this.normalizeOPFFProduct(product, species);
          if (normalized) {
            this.products.push(normalized);
          }
        }

        console.log(`   ‚úì Found ${data.products.length} products (total: ${this.products.length})`);

        // Check if there are more pages
        hasMore = data.products.length === pageSize;
        page++;
        
        await this.sleep(1000); // Rate limit between pages
      } catch (error: any) {
        console.error(`   ‚úó Error fetching page ${page}: ${error.message}`);
        hasMore = false;
      }
    }
  }

  private normalizeOPFFProduct(product: any, speciesHint: string[]): CommercialProduct | null {
    // Must have ingredients
    if (!product.ingredients_text && !product.ingredients) {
      return null;
    }

    // Parse ingredients list
    const ingredientsRaw = product.ingredients_text || '';
    const ingredientsList = this.parseIngredientsList(ingredientsRaw);

    if (ingredientsList.length === 0) {
      return null;
    }

    // Infer product type from categories or product name
    const productType = this.inferProductType(product);

    return {
      source: 'openpetfoodfacts',
      sourceUrl: `${this.OPFF_BASE}/product/${product.code}`,
      brand: product.brands || 'Unknown',
      productName: product.product_name || 'Unknown Product',
      speciesHint,
      productType,
      ingredientsRaw,
      ingredientsList,
      scrapedAt: new Date().toISOString(),
      barcode: product.code,
    };
  }

  private parseIngredientsList(text: string): Array<{ name: string; position: number }> {
    if (!text || typeof text !== 'string') return [];

    // Split by comma, semicolon, or newline
    const parts = text.split(/[,;\n]+/).map(s => s.trim()).filter(s => s.length > 0);
    
    return parts.map((name, index) => ({
      name: this.cleanIngredientName(name),
      position: index + 1
    }));
  }

  private cleanIngredientName(name: string): string {
    // Remove leading numbers, asterisks, bullets
    let cleaned = name.replace(/^[\d\*\-‚Ä¢\s]+/, '');
    
    // Remove parenthetical notes at the end
    cleaned = cleaned.replace(/\([^)]*\)$/, '');
    
    // Remove percentage indicators
    cleaned = cleaned.replace(/\s*\d+%?\s*$/, '');
    
    return cleaned.trim();
  }

  private inferProductType(product: any): CommercialProduct['productType'] {
    const name = (product.product_name || '').toLowerCase();
    const categories = (product.categories || '').toLowerCase();
    const combined = name + ' ' + categories;

    if (combined.includes('wet') || combined.includes('canned') || combined.includes('pate')) {
      return 'wet';
    }
    if (combined.includes('dry') || combined.includes('kibble')) {
      return 'dry';
    }
    if (combined.includes('pellet')) {
      return 'pellet';
    }
    if (combined.includes('treat') || combined.includes('snack')) {
      return 'treat';
    }
    if (combined.includes('mix') || combined.includes('powder')) {
      return 'mix';
    }

    return 'unknown';
  }

  async scrapeBrandPages(): Promise<void> {
    console.log('\nüîç Scraping brand pages (exotic pets)...\n');
    
    // Bird brands
    await this.scrapeLafeber();
    
    // Pocket pet brands
    await this.scrapeOxbow();
    
    console.log(`\n‚úÖ Scraped ${this.products.length} total products`);
  }

  private async scrapeLafeber(): Promise<void> {
    console.log('üì¶ Scraping Lafeber (bird food)...');
    
    try {
      const url = 'https://www.lafeber.com/pet-birds/';
      const response = await axios.get(url, {
        timeout: 30000,
        headers: { 'User-Agent': 'PetPlates-Research/1.0' }
      });

      const $ = cheerio.load(response.data);
      
      // Find product links (adjust selectors based on actual site structure)
      const productLinks: string[] = [];
      $('a[href*="/product/"]').each((_, el) => {
        const href = $(el).attr('href');
        if (href && !productLinks.includes(href)) {
          productLinks.push(href.startsWith('http') ? href : `https://www.lafeber.com${href}`);
        }
      });

      console.log(`   Found ${productLinks.length} product links`);
      
      // For now, just log - full implementation would scrape each product page
      // This is a placeholder for brand page scraping
      
    } catch (error: any) {
      console.error(`   ‚úó Error: ${error.message}`);
    }
  }

  private async scrapeOxbow(): Promise<void> {
    console.log('üì¶ Scraping Oxbow (pocket pets)...');
    
    try {
      const url = 'https://oxbowanimalhealth.com/product-category/essentials-food/';
      const response = await axios.get(url, {
        timeout: 30000,
        headers: { 'User-Agent': 'PetPlates-Research/1.0' }
      });

      const $ = cheerio.load(response.data);
      
      // Find product links (adjust selectors based on actual site structure)
      const productLinks: string[] = [];
      $('a[href*="/product/"]').each((_, el) => {
        const href = $(el).attr('href');
        if (href && !productLinks.includes(href)) {
          productLinks.push(href);
        }
      });

      console.log(`   Found ${productLinks.length} product links`);
      
      // For now, just log - full implementation would scrape each product page
      
    } catch (error: any) {
      console.error(`   ‚úó Error: ${error.message}`);
    }
  }

  async saveProducts(outputPath: string): Promise<void> {
    await fs.writeFile(outputPath, JSON.stringify(this.products, null, 2), 'utf-8');
    console.log(`\nüíæ Saved ${this.products.length} products to: ${outputPath}`);
  }

  getProducts(): CommercialProduct[] {
    return this.products;
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// CLI execution
async function main() {
  const scraper = new CommercialScraper();
  
  // Scrape Open Pet Food Facts (primary source)
  await scraper.scrapeOpenPetFoodFacts();
  
  // Scrape brand pages (exotic pets - placeholder for now)
  // await scraper.scrapeBrandPages();
  
  // Save results
  const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
  const outputPath = `./output/commercial-products-${timestamp}.json`;
  await scraper.saveProducts(outputPath);
  
  // Print summary
  const products = scraper.getProducts();
  const bySpecies = products.reduce((acc, p) => {
    const species = p.speciesHint[0] || 'unknown';
    acc[species] = (acc[species] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  
  console.log('\nüìä Summary by species:');
  for (const [species, count] of Object.entries(bySpecies)) {
    console.log(`   ${species}: ${count} products`);
  }
}

main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
</file>

<file path="scripts/update-recipe-meal-images.ts">
// scripts/update-recipe-meal-images.ts
// Update all recipes to use meal images from getMealImageForRecipe

import fs from 'fs';
import path from 'path';
import { recipes } from '../lib/data/recipes-complete';
import { getMealImageForRecipe } from '../lib/utils/mealImageAssignment';

async function main() {
  console.log('üñºÔ∏è  Updating recipe images to use meal images...\n');
  
  // Create backup
  const recipesPath = path.join(__dirname, '../lib/data/recipes-complete.ts');
  const backupPath = path.join(__dirname, '../lib/data/recipes-complete.meal-images-backup.ts');
  fs.copyFileSync(recipesPath, backupPath);
  console.log('‚úÖ Backup created: recipes-complete.meal-images-backup.ts\n');
  
  // Update all recipes
  const updatedRecipes = recipes.map(recipe => {
    const newImageUrl = getMealImageForRecipe(recipe.id, recipe.category);
    return {
      ...recipe,
      imageUrl: newImageUrl
    };
  });
  
  // Generate the updated file content
  const fileContent = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Vetted on: ${new Date().toISOString()}
// Total recipes: ${updatedRecipes.length}
// Meal images updated: ${new Date().toISOString()}

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(updatedRecipes, null, 2)};
`;
  
  // Write updated file
  fs.writeFileSync(recipesPath, fileContent, 'utf-8');
  
  console.log(`‚úÖ Updated ${updatedRecipes.length} recipes with meal images`);
  console.log(`üìÅ Updated file: ${recipesPath}`);
  
  // Show sample of updates
  console.log('\nüì∏ Sample image assignments:');
  const samples = updatedRecipes.slice(0, 5);
  samples.forEach(recipe => {
    console.log(`   ${recipe.id} (${recipe.category}): ${recipe.imageUrl}`);
  });
  
  console.log('\n‚úÖ Done! Recipes now use meal images.');
}

main().catch(console.error);
</file>

<file path="scripts/update-vetted-products-by-link.js">
// scripts/update-vetted-products-by-link.js
// Updates vetted-products.ts by matching the original Amazon links, not ingredient names

const fs = require('fs');
const path = require('path');

const ASINS_FILE = path.join(__dirname, '../asins-extracted.json');
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const BACKUP_FILE = path.join(__dirname, '../lib/data/vetted-products.ts.backup');

// Create ASIN map from extracted data - keyed by original Amazon link
function loadASINMap() {
  const asinsData = JSON.parse(fs.readFileSync(ASINS_FILE, 'utf8'));
  const asinMap = new Map();
  
  asinsData.forEach(item => {
    if (item.asin && item.link) {
      // Use the original Amazon link as the key
      // Normalize the link (remove trailing slashes, normalize spaces in URLs)
      const normalizedLink = item.link.trim();
      asinMap.set(normalizedLink, {
        asin: item.asin,
        directLink: `https://www.amazon.com/dp/${item.asin}?tag=robinfrench-20`
      });
    }
  });
  
  return asinMap;
}

// Update vetted-products.ts file by matching links
function updateVettedProducts() {
  console.log('üìñ Loading ASIN data...');
  const asinMap = loadASINMap();
  console.log(`‚úÖ Loaded ${asinMap.size} ASIN mappings\n`);
  
  console.log('üìñ Reading vetted-products.ts...');
  let content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf8');
  
  // Create backup
  console.log('üíæ Creating backup...');
  fs.writeFileSync(BACKUP_FILE, content);
  console.log(`‚úÖ Backup saved to ${BACKUP_FILE}\n`);
  
  console.log('üîÑ Updating Amazon links by matching ingredient names from ASIN data...\n');
  
  let updateCount = 0;
  let alreadyCorrectCount = 0;
  let notFoundCount = 0;
  const notFound = [];
  
  // Strategy: For each entry in asins-extracted.json, find the matching ingredient in vetted-products.ts
  // by ingredient name and replace its amazonLink with the correct ASIN link
  // We update ALL entries to ensure they all have the correct ASINs from the extraction process
  
  const asinsData = JSON.parse(fs.readFileSync(ASINS_FILE, 'utf8'));
  console.log(`üìã Processing ${asinsData.length} ASIN entries...\n`);
  
  asinsData.forEach(item => {
    if (!item.name || !item.asin || !item.link) {
      return;
    }
    
    const ingredientName = item.name;
    const normalizedName = ingredientName.toLowerCase().trim();
    const correctASIN = item.asin;
    const correctLink = `https://www.amazon.com/dp/${correctASIN}?tag=robinfrench-20`;
    
    let updated = false;
    
    // Strategy 1: Try exact ingredient name match
    const escapedName = ingredientName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const exactPattern = new RegExp(
      `('${escapedName}':\\s*\\{[^}]*amazonLink:\\s*')([^']+)'`,
      'g'
    );
    
    const exactMatch = exactPattern.exec(content);
    if (exactMatch) {
      const currentLink = exactMatch[2];
      
      // Always update to ensure we have the correct ASIN (even if it looks correct)
      if (currentLink !== correctLink) {
        content = content.replace(exactPattern, `$1${correctLink}'`);
        updateCount++;
        console.log(`  ‚úÖ [${updateCount}] ${ingredientName} -> ${correctASIN}`);
        updated = true;
      } else {
        alreadyCorrectCount++;
        updated = true; // Mark as found, even if already correct
      }
    }
    
    // Strategy 2: Try normalized name (case-insensitive, handles whitespace)
    if (!updated) {
      const escapedNormalizedName = normalizedName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const normalizedPattern = new RegExp(
        `('${escapedNormalizedName}':\\s*\\{[^}]*amazonLink:\\s*')([^']+)'`,
        'gi'
      );
      
      const normalizedMatch = normalizedPattern.exec(content);
      if (normalizedMatch) {
        const currentLink = normalizedMatch[2];
        if (currentLink !== correctLink) {
          content = content.replace(normalizedPattern, `$1${correctLink}'`);
          updateCount++;
          console.log(`  ‚úÖ [${updateCount}] ${ingredientName} (normalized) -> ${correctASIN}`);
          updated = true;
        } else {
          alreadyCorrectCount++;
          updated = true; // Mark as found, even if already correct
        }
      }
    }
    
    // Strategy 3: Try matching by original URL in the file
    if (!updated) {
      const originalSearchUrl = item.link.trim();
      // Escape special regex characters in URL
      const escapedUrl = originalSearchUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const urlPattern = new RegExp(
        `(amazonLink:\\s*')${escapedUrl}'`,
        'g'
      );
      
      if (urlPattern.test(content)) {
        content = content.replace(urlPattern, `$1${correctLink}'`);
        updateCount++;
        console.log(`  ‚úÖ [${updateCount}] ${ingredientName} (by URL match) -> ${correctASIN}`);
        updated = true;
      }
    }
    
    // If still not found, add to not found list
    if (!updated) {
      notFoundCount++;
      notFound.push(ingredientName);
    }
  });
  
  // Update the comment at the top
  content = content.replace(
    /\/\/ Each ingredient maps to a specific, high-quality product with (Amazon search URL|direct Amazon ASIN link)/,
    '// Each ingredient maps to a specific, high-quality product with direct Amazon ASIN link'
  );
  
  // Write updated file
  console.log(`\nüíæ Writing updated file...`);
  fs.writeFileSync(VETTED_PRODUCTS_FILE, content);
  
  console.log('\n‚ú® Update complete!\n');
  console.log('üìä STATISTICS:');
  console.log(`  ‚úÖ Updated: ${updateCount} links`);
  console.log(`  ‚úì Already correct: ${alreadyCorrectCount} links`);
  console.log(`  ‚ö†Ô∏è  Not found: ${notFoundCount} links`);
  
  if (notFound.length > 0 && notFound.length <= 20) {
    console.log('\n‚ö†Ô∏è  Links without ASIN matches:');
    notFound.forEach(link => console.log(`    - ${link.substring(0, 100)}`));
  } else if (notFound.length > 20) {
    console.log(`\n‚ö†Ô∏è  ${notFound.length} links without ASIN matches (too many to display)`);
  }
  
  console.log(`\nüíæ Backup saved to: ${BACKUP_FILE}`);
  console.log(`üìÅ Updated file: ${VETTED_PRODUCTS_FILE}`);
}

// Run it
try {
  updateVettedProducts();
} catch (error) {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
}
</file>

<file path="scripts/update-vetted-products-simple.ts">
// scripts/update-vetted-products-simple.ts
// Simple script to update vetted-products.ts with price data
// Uses direct string replacement for each product

import * as fs from 'fs';
import * as path from 'path';

interface PriceData {
  ingredient: string;
  asin: string;
  url: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
    unit?: string;
  };
  error?: string;
}

const PRICES_FILE = path.join(__dirname, '../data/product-prices.json');
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const BACKUP_FILE = path.join(__dirname, '../lib/data/vetted-products.ts.backup-prices');

function formatPriceField(price: PriceData['price']): string {
  let field = `    price: {
      amount: ${price.amount},
      currency: '${price.currency}',
      lastUpdated: '${price.lastUpdated}'`;
  
  if (price.unit) {
    field += `,
      unit: '${price.unit}'`;
  }
  
  field += `
    }`;
  
  return field;
}

function main() {
  console.log('üîÑ Updating Vetted Products with Price Data\n');
  console.log('='.repeat(60));
  
  if (!fs.existsSync(PRICES_FILE)) {
    console.error(`‚ùå Price data file not found: ${PRICES_FILE}`);
    console.error('   Please run fetch-product-prices.ts first\n');
    process.exit(1);
  }
  
  const pricesJson = fs.readFileSync(PRICES_FILE, 'utf-8');
  const prices: PriceData[] = JSON.parse(pricesJson);
  
  const validPrices = prices.filter(p => p.price.amount > 0 && !p.error);
  console.log(`üì¶ Loaded ${validPrices.length} valid price records\n`);
  
  // Read the file
  console.log('üìù Reading vetted-products.ts...\n');
  let content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  
  // Create backup
  fs.writeFileSync(BACKUP_FILE, content);
  console.log(`üíæ Backup created: ${BACKUP_FILE}\n`);
  
  let updateCount = 0;
  
  // Update each product
  for (const priceData of validPrices) {
    const ingredient = priceData.ingredient;
    const escapedIngredient = ingredient.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
    // Skip if already has price
    const productPattern = new RegExp(`'${escapedIngredient}':\\s*\\{[\\s\\S]*?price:[\\s\\S]*?\\}`, 'm');
    if (productPattern.test(content)) {
      console.log(`‚è≠Ô∏è  ${ingredient}: Already has price, skipping`);
      continue;
    }
    
    // Find the product entry and add price before closing brace
    // Pattern: find the product entry ending with } (possibly with comma)
    const pattern = new RegExp(
      `('${escapedIngredient}':\\s*\\{)([\\s\\S]*?)(\\n\\s*\\})(,?)`,
      'm'
    );
    
    const match = content.match(pattern);
    
    if (match) {
      const before = match[1];
      const middle = match[2];
      const closing = match[3];
      const comma = match[4];
      
      // Check if middle already has price
      if (middle.includes('price:')) {
        console.log(`‚è≠Ô∏è  ${ingredient}: Already has price, skipping`);
        continue;
      }
      
      // Add price field before closing brace
      const priceField = formatPriceField(priceData.price);
      const updated = `${before}${middle},\n${priceField}${closing}${comma}`;
      
      content = content.replace(pattern, updated);
      updateCount++;
      
      if (updateCount % 10 === 0) {
        console.log(`‚úÖ Updated ${updateCount} products...`);
      }
    } else {
      console.log(`‚ö†Ô∏è  Could not find entry: ${ingredient}`);
    }
  }
  
  // Write updated content
  fs.writeFileSync(VETTED_PRODUCTS_FILE, content);
  
  console.log(`\n‚úÖ Updated ${updateCount} products with price data`);
  console.log(`üìÑ Updated file: ${VETTED_PRODUCTS_FILE}\n`);
}

main();
</file>

<file path="scripts/update-vetted-products-with-asins.js">
// scripts/update-vetted-products-with-asins.js
// Updates vetted-products.ts to use direct ASIN links instead of search URLs

const fs = require('fs');
const path = require('path');

const ASINS_FILE = path.join(__dirname, '../asins-extracted.json');
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const BACKUP_FILE = path.join(__dirname, '../lib/data/vetted-products.ts.backup');

// Normalize ingredient name for matching (lowercase, trim, handle variations)
function normalizeName(name) {
  return name.toLowerCase().trim();
}

// Create ASIN map from extracted data
function loadASINMap() {
  const asinsData = JSON.parse(fs.readFileSync(ASINS_FILE, 'utf8'));
  const asinMap = new Map();
  
  asinsData.forEach(item => {
    if (item.asin) {
      const normalizedName = normalizeName(item.name);
      // Store ASIN with direct product link format
      asinMap.set(normalizedName, {
        asin: item.asin,
        directLink: `https://www.amazon.com/dp/${item.asin}?tag=robinfrench-20`
      });
    }
  });
  
  return asinMap;
}

// Update vetted-products.ts file
function updateVettedProducts() {
  console.log('üìñ Loading ASIN data...');
  const asinMap = loadASINMap();
  console.log(`‚úÖ Loaded ${asinMap.size} ASIN mappings\n`);
  
  console.log('üìñ Reading vetted-products.ts...');
  let content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf8');
  
  // Create backup
  console.log('üíæ Creating backup...');
  fs.writeFileSync(BACKUP_FILE, content);
  console.log(`‚úÖ Backup saved to ${BACKUP_FILE}\n`);
  
  console.log('üîÑ Updating Amazon links with direct ASIN links...\n');
  
  let updateCount = 0;
  let notFoundCount = 0;
  const notFound = [];
  
  // Match pattern: amazonLink: 'https://www.amazon.com/s?k=...&tag=robinfrench-20'
  // We need to find the ingredient name first, then update its amazonLink
  
  // Extract all ingredient entries and their current links
  const ingredientPattern = /'([^']+)':\s*\{[^}]*amazonLink:\s*'([^']+)'/g;
  const matches = [...content.matchAll(ingredientPattern)];
  
  matches.forEach(match => {
    const ingredientName = match[1];
    const currentLink = match[2];
    const normalizedName = normalizeName(ingredientName);
    
    // Skip if already a direct ASIN link
    if (currentLink.includes('/dp/') || currentLink.includes('/product/')) {
      return;
    }
    
    const asinData = asinMap.get(normalizedName);
    
    if (asinData) {
      // Replace the old search URL with direct ASIN link
      const oldLinkPattern = new RegExp(
        `(amazonLink:\\s*')${currentLink.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}'`,
        'g'
      );
      
      const newLink = asinData.directLink;
      content = content.replace(oldLinkPattern, `$1${newLink}'`);
      updateCount++;
      console.log(`  ‚úÖ [${updateCount}] ${ingredientName} -> ${asinData.asin}`);
    } else {
      notFoundCount++;
      notFound.push(ingredientName);
      console.log(`  ‚ö†Ô∏è  [NOT FOUND] ${ingredientName}`);
    }
  });
  
  // Update the comment at the top
  content = content.replace(
    /\/\/ Each ingredient maps to a specific, high-quality product with Amazon search URL/,
    '// Each ingredient maps to a specific, high-quality product with direct Amazon ASIN link'
  );
  
  // Write updated file
  console.log(`\nüíæ Writing updated file...`);
  fs.writeFileSync(VETTED_PRODUCTS_FILE, content);
  
  console.log('\n‚ú® Update complete!\n');
  console.log('üìä STATISTICS:');
  console.log(`  ‚úÖ Updated: ${updateCount} ingredients`);
  console.log(`  ‚ö†Ô∏è  Not found: ${notFoundCount} ingredients`);
  
  if (notFound.length > 0) {
    console.log('\n‚ö†Ô∏è  Ingredients without ASIN matches:');
    notFound.forEach(name => console.log(`    - ${name}`));
  }
  
  console.log(`\nüíæ Backup saved to: ${BACKUP_FILE}`);
  console.log(`üìÅ Updated file: ${VETTED_PRODUCTS_FILE}`);
}

// Run it
try {
  updateVettedProducts();
} catch (error) {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
}
</file>

<file path="scripts/update-vetted-products-with-prices-v2.ts">
// scripts/update-vetted-products-with-prices-v2.ts
// Update vetted-products.ts with fetched price data (improved version)

import * as fs from 'fs';
import * as path from 'path';

interface PriceData {
  ingredient: string;
  asin: string;
  url: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
    unit?: string;
  };
  error?: string;
}

const PRICES_FILE = path.join(__dirname, '../data/product-prices.json');
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const BACKUP_FILE = path.join(__dirname, '../lib/data/vetted-products.ts.backup-prices');

function formatPriceData(price: PriceData['price']): string {
  let code = `    price: {
      amount: ${price.amount},
      currency: '${price.currency}',
      lastUpdated: '${price.lastUpdated}'`;
  
  if (price.unit) {
    code += `,
      unit: '${price.unit}'`;
  }
  
  code += `
    }`;
  
  return code;
}

function updateVettedProductsFile(prices: PriceData[]) {
  console.log('üìù Reading vetted-products.ts...\n');
  
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  const lines = content.split('\n');
  
  // Create backup
  fs.writeFileSync(BACKUP_FILE, content);
  console.log(`üíæ Backup created: ${BACKUP_FILE}\n`);
  
  // Create price map
  const priceMap = new Map<string, PriceData>();
  prices
    .filter(p => p.price.amount > 0 && !p.error)
    .forEach(p => priceMap.set(p.ingredient, p));
  
  console.log(`üìä Found ${priceMap.size} products with valid prices\n`);
  
  // Process lines
  const newLines: string[] = [];
  let currentIngredient: string | null = null;
  let inProductBlock = false;
  let productStartLine = -1;
  let braceDepth = 0;
  let hasPrice = false;
  let lastFieldLine = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // Detect start of product entry: 'ingredient-name': {
    const productMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (productMatch && !inProductBlock) {
      currentIngredient = productMatch[1];
      inProductBlock = true;
      productStartLine = i;
      braceDepth = 1;
      hasPrice = false;
      lastFieldLine = -1;
      newLines.push(line);
      continue;
    }
    
    // Track brace depth
    if (inProductBlock) {
      const openBraces = (line.match(/\{/g) || []).length;
      const closeBraces = (line.match(/\}/g) || []).length;
      braceDepth += openBraces - closeBraces;
      
      // Check if this line has a price field
      if (line.includes('price:')) {
        hasPrice = true;
      }
      
      // Track last field line (before closing brace)
      if (braceDepth === 1 && (line.includes(':') || line.trim() === '}')) {
        lastFieldLine = i;
      }
      
      // Check if we're closing the product block
      if (braceDepth === 0 && inProductBlock) {
        // We've reached the end of this product block
        if (currentIngredient && priceMap.has(currentIngredient) && !hasPrice) {
          // Insert price before closing brace
          const priceData = priceMap.get(currentIngredient)!;
          const priceCode = formatPriceData(priceData.price);
          
          // Find where to insert (before the last closing brace)
          // Insert at lastFieldLine + 1
          if (lastFieldLine >= 0 && lastFieldLine < i) {
            // Insert after the last field
            newLines.push(priceCode);
            newLines.push(line);
          } else {
            // Insert before the closing brace
            newLines.push(priceCode);
            newLines.push(line);
          }
        } else {
          newLines.push(line);
        }
        
        currentIngredient = null;
        inProductBlock = false;
        continue;
      }
    }
    
    newLines.push(line);
  }
  
  // Write updated content
  const updatedContent = newLines.join('\n');
  fs.writeFileSync(VETTED_PRODUCTS_FILE, updatedContent);
  
  const updatedCount = priceMap.size - Array.from(priceMap.keys()).filter(
    ing => !updatedContent.includes(`'${ing}':`) || !updatedContent.includes('price:')
  ).length;
  
  console.log(`‚úÖ Updated products with price data`);
  console.log(`üìÑ Updated file: ${VETTED_PRODUCTS_FILE}\n`);
}

function main() {
  console.log('üîÑ Updating Vetted Products with Price Data (v2)\n');
  console.log('='.repeat(60));
  
  if (!fs.existsSync(PRICES_FILE)) {
    console.error(`‚ùå Price data file not found: ${PRICES_FILE}`);
    console.error('   Please run fetch-product-prices.ts first\n');
    process.exit(1);
  }
  
  const pricesJson = fs.readFileSync(PRICES_FILE, 'utf-8');
  const prices: PriceData[] = JSON.parse(pricesJson);
  
  console.log(`üì¶ Loaded ${prices.length} price records\n`);
  
  updateVettedProductsFile(prices);
  
  console.log('‚úÖ Update complete!\n');
}

main();
</file>

<file path="scripts/update-vetted-products-with-prices.ts">
// scripts/update-vetted-products-with-prices.ts
// Update vetted-products.ts with fetched price data

import * as fs from 'fs';
import * as path from 'path';

interface PriceData {
  ingredient: string;
  asin: string;
  url: string;
  price: {
    amount: number;
    currency: string;
    lastUpdated: string;
    unit?: string;
  };
  error?: string;
}

const PRICES_FILE = path.join(__dirname, '../data/product-prices.json');
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');
const BACKUP_FILE = path.join(__dirname, '../lib/data/vetted-products.ts.backup-prices');

function formatPriceData(price: PriceData['price']): string {
  let code = `price: {
      amount: ${price.amount},
      currency: '${price.currency}',
      lastUpdated: '${price.lastUpdated}'`;
  
  if (price.unit) {
    code += `,
      unit: '${price.unit}'`;
  }
  
  code += `
    }`;
  
  return code;
}

function updateVettedProductsFile(prices: PriceData[]) {
  console.log('üìù Reading vetted-products.ts...\n');
  
  let content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  
  // Create backup
  fs.writeFileSync(BACKUP_FILE, content);
  console.log(`üíæ Backup created: ${BACKUP_FILE}\n`);
  
  // Filter to only products with valid prices
  const validPrices = prices.filter(p => p.price.amount > 0 && !p.error);
  console.log(`üìä Found ${validPrices.length} products with valid prices\n`);
  
  // Sort by ingredient name to match file order
  validPrices.sort((a, b) => a.ingredient.localeCompare(b.ingredient));
  
  // Update each product entry
  let updateCount = 0;
  
  for (const priceData of validPrices) {
    const ingredient = priceData.ingredient;
    const escapedIngredient = ingredient.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const priceCode = formatPriceData(priceData.price);
    
    // Try multiple patterns to find the product entry
    // Pattern 1: Has commissionRate at the end
    let pattern = new RegExp(
      `('${escapedIngredient}':\\s*\\{[\\s\\S]*?)(commissionRate\\s*:[^,}]+[,\\s]*\\n\\s*\\})`,
      'm'
    );
    
    let match = content.match(pattern);
    
    if (match) {
      // Replace the closing brace with price + closing brace
      const replacement = match[0].replace(/\}\s*$/, `,\n    ${priceCode}\n  }`);
      content = content.replace(pattern, replacement);
      updateCount++;
      continue;
    }
    
    // Pattern 2: Has category at the end
    pattern = new RegExp(
      `('${escapedIngredient}':\\s*\\{[\\s\\S]*?)(category\\s*:[^,}]+[,\\s]*\\n\\s*\\})`,
      'm'
    );
    
    match = content.match(pattern);
    
    if (match) {
      const replacement = match[0].replace(/\}\s*$/, `,\n    ${priceCode}\n  }`);
      content = content.replace(pattern, replacement);
      updateCount++;
      continue;
    }
    
    // Pattern 3: Has vetNote at the end (no optional fields)
    pattern = new RegExp(
      `('${escapedIngredient}':\\s*\\{[\\s\\S]*?)(vetNote\\s*:[^,}]+[,\\s]*\\n\\s*\\})`,
      'm'
    );
    
    match = content.match(pattern);
    
    if (match) {
      const replacement = match[0].replace(/\}\s*$/, `,\n    ${priceCode}\n  }`);
      content = content.replace(pattern, replacement);
      updateCount++;
      continue;
    }
    
    // Pattern 4: Find any entry and add before closing brace
    pattern = new RegExp(
      `('${escapedIngredient}':\\s*\\{)([\\s\\S]*?)(\\n\\s*\\})`,
      'm'
    );
    
    match = content.match(pattern);
    
    if (match && !match[2].includes('price:')) {
      const replacement = `${match[1]}${match[2]},\n    ${priceCode}${match[3]}`;
      content = content.replace(pattern, replacement);
      updateCount++;
    } else {
      console.log(`‚ö†Ô∏è  Could not find or already has price: ${ingredient}`);
    }
  }
  
  // Write updated content
  fs.writeFileSync(VETTED_PRODUCTS_FILE, content);
  
  console.log(`\n‚úÖ Updated ${updateCount} products with price data`);
  console.log(`üìÑ Updated file: ${VETTED_PRODUCTS_FILE}\n`);
}

function main() {
  console.log('üîÑ Updating Vetted Products with Price Data\n');
  console.log('='.repeat(60));
  
  if (!fs.existsSync(PRICES_FILE)) {
    console.error(`‚ùå Price data file not found: ${PRICES_FILE}`);
    console.error('   Please run fetch-product-prices.ts first\n');
    process.exit(1);
  }
  
  const pricesJson = fs.readFileSync(PRICES_FILE, 'utf-8');
  const prices: PriceData[] = JSON.parse(pricesJson);
  
  console.log(`üì¶ Loaded ${prices.length} price records\n`);
  
  updateVettedProductsFile(prices);
  
  console.log('‚úÖ Update complete!\n');
}

main();
</file>

<file path="scripts/updateRecipeImages.js">
const fs = require('fs');
const path = require('path');

// Hash function (same as in mealImageAssignment.ts)
function hashStringToNumber(s) {
  let hash = 0;
  for (let i = 0; i < s.length; i++) {
    const char = s.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash);
}

function getMealImageForRecipe(recipeId, category) {
  const categoryMap = {
    'dogs': 'dogs',
    'cats': 'cats',
    'birds': 'birds',
    'reptiles': 'reptiles',
    'pocket-pets': 'pocket-pets'
  };
  
  const normalizedCategory = categoryMap[category.toLowerCase()] || 'dogs';
  const hash = hashStringToNumber(recipeId);
  const imageNumber = (hash % 25) + 1;
  const imageNumberStr = imageNumber.toString().padStart(2, '0');
  
  return `/images/meals/${normalizedCategory}-meal-${imageNumberStr}.png`;
}

// Read the recipes file
const recipesPath = path.join(__dirname, '../lib/data/recipes-complete.ts');
let content = fs.readFileSync(recipesPath, 'utf8');

// Count recipes updated
let updatedCount = 0;

// Replace all imageUrl fields with meal images
// Pattern: "imageUrl": "/images/..."
content = content.replace(
  /"imageUrl":\s*"[^"]*"/g,
  (match) => {
    // Extract recipe ID and category from context
    // We need to find the recipe ID and category before this imageUrl
    const beforeMatch = content.substring(0, content.indexOf(match));
    const recipeMatch = beforeMatch.match(/"id":\s*"([^"]+)"/);
    const categoryMatch = beforeMatch.match(/"category":\s*"([^"]+)"/);
    
    if (recipeMatch && categoryMatch) {
      const recipeId = recipeMatch[1];
      const category = categoryMatch[1];
      const newImageUrl = getMealImageForRecipe(recipeId, category);
      updatedCount++;
      return `"imageUrl": "${newImageUrl}"`;
    }
    
    return match; // Keep original if we can't find ID/category
  }
);

// Write back
fs.writeFileSync(recipesPath, content, 'utf8');

console.log(`‚úÖ Updated ${updatedCount} recipe image URLs to use meal images`);
console.log(`üìÅ Recipes file: ${recipesPath}`);
</file>

<file path="scripts/validate-affiliate-links.ts">
// scripts/validate-affiliate-links.ts
// Validates all affiliate links have seller ID and valid ASIN format
// Exit with error code if issues found (for CI/CD)

import * as fs from 'fs';
import * as path from 'path';

const SELLER_ID = 'robinfrench-20';
const VETTED_PRODUCTS_FILE = path.join(__dirname, '../lib/data/vetted-products.ts');

interface ValidationResult {
  ingredient: string;
  hasSellerId: boolean;
  hasValidASIN: boolean;
  isGenericSearch: boolean;
  issues: string[];
}

const results: ValidationResult[] = [];
const errors: string[] = [];
let hasErrors = false;

// Helper to check if URL has seller ID
function hasSellerId(url: string): boolean {
  if (!url) return false;
  return url.includes(`tag=${SELLER_ID}`) || url.includes(`AssociateTag=${SELLER_ID}`);
}

// Helper to check if URL is a specific ASIN link (not generic search)
function isGenericSearch(url: string): boolean {
  if (!url) return false;
  return url.includes('/s?k=') || url.includes('/s?') || url.includes('search/');
}

// Extract ASIN from URL
function extractASIN(url: string): string | null {
  if (!url) return null;
  
  // Try /dp/ASIN pattern
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (dpMatch) return dpMatch[1];
  
  // Try /gp/product/ASIN pattern
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (gpMatch) return gpMatch[1];
  
  // Try /product/ASIN pattern
  const productMatch = url.match(/\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (productMatch) return productMatch[1];
  
  return null;
}

// Validate vetted products
function validateVettedProducts() {
  console.log('üîç Validating vetted products...\n');
  
  const content = fs.readFileSync(VETTED_PRODUCTS_FILE, 'utf-8');
  const lines = content.split('\n');
  
  let currentIngredient: string | null = null;
  let currentLink: string | null = null;
  let inProductBlock = false;
  let braceDepth = 0;
  let startLine = 0;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const lineNum = i + 1;
    
    // Detect start of ingredient entry
    const ingredientMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (ingredientMatch) {
      currentIngredient = ingredientMatch[1];
      inProductBlock = true;
      braceDepth = 1;
      startLine = lineNum;
      currentLink = null;
      continue;
    }
    
    if (inProductBlock) {
      // Track brace depth
      braceDepth += (line.match(/\{/g) || []).length;
      braceDepth -= (line.match(/\}/g) || []).length;
      
      // Extract asinLink
      const asinMatch = line.match(/asinLink:\s*'([^']+)'/);
      if (asinMatch) {
        currentLink = asinMatch[1];
      }
      
      // End of product block
      if (braceDepth === 0) {
        if (currentIngredient && currentLink) {
          const result: ValidationResult = {
            ingredient: currentIngredient,
            hasSellerId: hasSellerId(currentLink),
            hasValidASIN: !!extractASIN(currentLink),
            isGenericSearch: isGenericSearch(currentLink),
            issues: [],
          };
          
          if (!result.hasSellerId) {
            result.issues.push('Missing seller ID');
            errors.push(`${currentIngredient} (line ${startLine}): Missing seller ID`);
            hasErrors = true;
          }
          
          if (!result.hasValidASIN) {
            result.issues.push('Invalid or missing ASIN');
            errors.push(`${currentIngredient} (line ${startLine}): Invalid ASIN format`);
            hasErrors = true;
          }
          
          if (result.isGenericSearch) {
            result.issues.push('Generic search URL (not specific product)');
            errors.push(`${currentIngredient} (line ${startLine}): Generic search URL`);
            hasErrors = true;
          }
          
          results.push(result);
        }
        
        // Reset
        currentIngredient = null;
        currentLink = null;
        inProductBlock = false;
      }
    }
  }
  
  return results.length;
}

// Main execution
function main() {
  console.log('üîç Affiliate Links Validation\n');
  console.log('='.repeat(60));
  
  const count = validateVettedProducts();
  
  // Summary
  console.log('='.repeat(60));
  console.log('üìä VALIDATION SUMMARY\n');
  
  const valid = results.filter(r => r.issues.length === 0).length;
  const invalid = results.filter(r => r.issues.length > 0).length;
  
  console.log(`Total entries validated: ${count}`);
  console.log(`‚úÖ Valid: ${valid}`);
  console.log(`‚ùå Invalid: ${invalid}`);
  
  if (hasErrors) {
    console.log('\n‚ùå VALIDATION FAILED\n');
    console.log('Issues found:');
    errors.forEach((error, idx) => {
      console.log(`${idx + 1}. ${error}`);
    });
    console.log('\n');
    process.exit(1);
  } else {
    console.log('\n‚úÖ All affiliate links are valid!\n');
    process.exit(0);
  }
}

// Run validation
try {
  main();
} catch (error) {
  console.error('‚ùå Error running validation:', error);
  process.exit(1);
}
</file>

<file path="scripts/validate-buy-links-intent.mjs">
// Intent-based buy link validator
// Validates Amazon links point to correct product TYPE using required/forbidden tokens

import { VETTED_PRODUCTS } from '../lib/data/vetted-products.ts';
import { inferValidationRules, validateProductTitle, generateSearchQuery, generateSearchUrl } from '../lib/utils/buyLinkValidation.ts';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('üîç Intent-Based Buy Link Validation\n');
console.log('='.repeat(80));

const results = {
  total: 0,
  pass: 0,
  warn: 0,
  fail: 0,
  issues: [],
};

// Process each ingredient
for (const [ingredientName, product] of Object.entries(VETTED_PRODUCTS)) {
  results.total++;
  
  // Infer validation rules from ingredient name and category
  const validation = inferValidationRules(ingredientName, product.category);
  
  // Validate product title against rules
  const report = validateProductTitle(product.productName, validation);
  
  if (report.result === 'PASS') {
    results.pass++;
  } else if (report.result === 'WARN') {
    results.warn++;
    results.issues.push({
      ingredient: ingredientName,
      product: product.productName,
      category: product.category,
      asinLink: product.asinLink,
      severity: 'WARN',
      reason: report.reason,
      suggestions: report.suggestions,
    });
  } else {
    results.fail++;
    results.issues.push({
      ingredient: ingredientName,
      product: product.productName,
      category: product.category,
      asinLink: product.asinLink,
      severity: 'FAIL',
      reason: report.reason,
      foundForbidden: report.foundForbidden,
      suggestions: report.suggestions,
    });
  }
}

// Print summary
console.log('\nüìä VALIDATION SUMMARY\n');
console.log(`Total ingredients: ${results.total}`);
console.log(`‚úÖ PASS: ${results.pass} (${((results.pass / results.total) * 100).toFixed(1)}%)`);
console.log(`‚ö†Ô∏è  WARN: ${results.warn} (${((results.warn / results.total) * 100).toFixed(1)}%)`);
console.log(`‚ùå FAIL: ${results.fail} (${((results.fail / results.total) * 100).toFixed(1)}%)`);

// Print failures (real mismatches)
if (results.fail > 0) {
  console.log('\n' + '='.repeat(80));
  console.log('‚ùå FAILURES (Real Mismatches - Fix Before Launch)\n');
  
  const failures = results.issues.filter(i => i.severity === 'FAIL');
  failures.forEach((issue, idx) => {
    console.log(`${idx + 1}. ${issue.ingredient}`);
    console.log(`   Product: ${issue.product}`);
    console.log(`   Category: ${issue.category}`);
    console.log(`   Reason: ${issue.reason}`);
    if (issue.foundForbidden) {
      console.log(`   Forbidden terms found: ${issue.foundForbidden.join(', ')}`);
    }
    console.log(`   Link: ${issue.asinLink}`);
    
    // Generate search suggestion
    const validation = inferValidationRules(issue.ingredient, issue.category);
    const searchQuery = generateSearchQuery(issue.ingredient, validation);
    const searchUrl = generateSearchUrl(searchQuery);
    console.log(`   üîç Search suggestion: ${searchUrl}`);
    console.log();
  });
}

// Print warnings (review recommended)
if (results.warn > 0) {
  console.log('\n' + '='.repeat(80));
  console.log('‚ö†Ô∏è  WARNINGS (Review Recommended)\n');
  
  const warnings = results.issues.filter(i => i.severity === 'WARN');
  warnings.slice(0, 10).forEach((issue, idx) => {
    console.log(`${idx + 1}. ${issue.ingredient}`);
    console.log(`   Product: ${issue.product}`);
    console.log(`   Reason: ${issue.reason}`);
    console.log();
  });
  
  if (warnings.length > 10) {
    console.log(`... and ${warnings.length - 10} more warnings\n`);
  }
}

// Generate markdown report
let markdown = `# Buy Link Validation Report (Intent-Based)

**Generated:** ${new Date().toISOString()}  
**Total Ingredients:** ${results.total}

## Summary

- ‚úÖ **PASS:** ${results.pass} (${((results.pass / results.total) * 100).toFixed(1)}%)
- ‚ö†Ô∏è **WARN:** ${results.warn} (${((results.warn / results.total) * 100).toFixed(1)}%)
- ‚ùå **FAIL:** ${results.fail} (${((results.fail / results.total) * 100).toFixed(1)}%)

---

## ‚ùå Failures (Fix Before Launch)

These are likely wrong products - forbidden terms found or missing required terms.

`;

const failures = results.issues.filter(i => i.severity === 'FAIL');
failures.forEach((issue, idx) => {
  markdown += `### ${idx + 1}. ${issue.ingredient}\n\n`;
  markdown += `- **Product:** ${issue.product}\n`;
  markdown += `- **Category:** ${issue.category}\n`;
  markdown += `- **Reason:** ${issue.reason}\n`;
  if (issue.foundForbidden) {
    markdown += `- **Forbidden terms:** ${issue.foundForbidden.join(', ')}\n`;
  }
  markdown += `- **Current link:** ${issue.asinLink}\n`;
  
  const validation = inferValidationRules(issue.ingredient, issue.category);
  const searchQuery = generateSearchQuery(issue.ingredient, validation);
  const searchUrl = generateSearchUrl(searchQuery);
  markdown += `- **Search suggestion:** [${searchQuery}](${searchUrl})\n`;
  markdown += `\n`;
});

markdown += `\n---\n\n## ‚ö†Ô∏è Warnings (Review Recommended)\n\n`;

const warnings = results.issues.filter(i => i.severity === 'WARN');
warnings.forEach((issue, idx) => {
  markdown += `### ${idx + 1}. ${issue.ingredient}\n\n`;
  markdown += `- **Product:** ${issue.product}\n`;
  markdown += `- **Reason:** ${issue.reason}\n`;
  markdown += `\n`;
});

// Save report
const reportPath = path.join(__dirname, '../BUY_LINK_VALIDATION_REPORT.md');
fs.writeFileSync(reportPath, markdown, 'utf8');

console.log('\n' + '='.repeat(80));
console.log(`\nüíæ Full report saved to: BUY_LINK_VALIDATION_REPORT.md`);
console.log('\n‚úÖ Validation complete!');

// Exit with error code if there are failures
process.exit(results.fail > 0 ? 1 : 0);
</file>

<file path="scripts/validate-recipes.ts">
// scripts/validate-recipes.ts
// Pre-deploy quality gate for recipe validation
// Checks toxicity, data coverage, allergy safety, and ingredient consistency

import { recipes } from '../lib/data/recipes-complete';
import { shouldAvoid, normalizeSpecies } from '../lib/utils/ingredientCompatibility';
import { getIngredientComposition } from '../lib/data/ingredientCompositions';
import { getFallbackNutrition } from '../lib/utils/nutritionFallbacks';
import type { Recipe } from '../lib/types';
import fs from 'fs';
import path from 'path';

interface ValidationError {
  type: 'toxicity' | 'data_coverage' | 'allergy_safety' | 'ingredient_missing' | 'nutrition_incomplete';
  recipeId: string;
  recipeName: string;
  message: string;
  severity: 'error' | 'warning';
}

interface ValidationReport {
  totalRecipes: number;
  errors: ValidationError[];
  warnings: ValidationError[];
  stats: {
    toxicIngredients: number;
    missingData: number;
    allergyMismatches: number;
    missingIngredients: number;
    incompleteNutrition: number;
  };
  passed: boolean;
}

// ANSI color codes for console output
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(message: string, color: keyof typeof colors = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

/**
 * Normalize ingredient name to key format for lookup
 */
function normalizeIngredientName(name: string): string {
  return name
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '')
    .replace(/_+/g, '_');
}

/**
 * Check if recipe contains toxic ingredients for its target species
 */
function checkToxicity(recipe: Recipe): ValidationError[] {
  const errors: ValidationError[] = [];
  const normalizedCategory = normalizeSpecies(recipe.category);
  
  if (normalizedCategory === 'unknown') {
    return errors; // Skip if species unknown
  }
  
  recipe.ingredients.forEach(ingredient => {
    const ingName = typeof ingredient === 'string' ? ingredient : ingredient.name;
    if (!ingName) return;
    
    const normalizedKey = normalizeIngredientName(ingName);
    const shouldAvoidIng = shouldAvoid(normalizedKey, normalizedCategory);
    
    if (shouldAvoidIng) {
      errors.push({
        type: 'toxicity',
        recipeId: recipe.id,
        recipeName: recipe.name,
        message: `Contains toxic ingredient "${ingName}" for ${normalizedCategory}`,
        severity: 'error',
      });
    }
  });
  
  return errors;
}

/**
 * Check data coverage - recipes with needsReview or missing critical nutrition
 */
function checkDataCoverage(recipe: Recipe): ValidationError[] {
  const errors: ValidationError[] = [];
  
  const hasNeedsReview = recipe.needsReview === true;
  const hasNutritionalInfo = !!recipe.nutritionalInfo;
  const hasNutritionCalculation = !!(recipe as any).nutritionalCalculation;
  const hasNutritionInfo = !!recipe.nutritionInfo;
  
  const missingCriticalData = !hasNutritionalInfo && !hasNutritionCalculation && !hasNutritionInfo;
  
  if (hasNeedsReview || missingCriticalData) {
    errors.push({
      type: 'data_coverage',
      recipeId: recipe.id,
      recipeName: recipe.name,
      message: hasNeedsReview 
        ? 'Recipe marked as needsReview'
        : 'Missing critical nutrition data (nutritionalInfo, nutritionCalculation, or nutritionInfo)',
      severity: 'warning',
    });
  }
  
  return errors;
}

/**
 * Check allergy safety - recipes tagged for health concerns shouldn't contain contraindicated ingredients
 */
function checkAllergySafety(recipe: Recipe): ValidationError[] {
  const errors: ValidationError[] = [];
  
  // Check if recipe has notSuitableFor field
  if (recipe.notSuitableFor && recipe.notSuitableFor.length > 0) {
    // Verify that ingredients don't conflict with notSuitableFor
    // This is a basic check - more sophisticated logic could be added
    recipe.notSuitableFor.forEach(concern => {
      const concernLower = concern.toLowerCase();
      recipe.ingredients.forEach(ingredient => {
        const ingName = typeof ingredient === 'string' ? ingredient : ingredient.name;
        if (!ingName) return;
        
        const ingLower = ingName.toLowerCase();
        // Check for common allergen patterns
        if (concernLower.includes('allerg') && (
          ingLower.includes('chicken') && concernLower.includes('chicken') ||
          ingLower.includes('beef') && concernLower.includes('beef') ||
          ingLower.includes('dairy') && concernLower.includes('dairy') ||
          ingLower.includes('wheat') && concernLower.includes('wheat')
        )) {
          errors.push({
            type: 'allergy_safety',
            recipeId: recipe.id,
            recipeName: recipe.name,
            message: `Recipe marked as notSuitableFor "${concern}" but contains potential allergen "${ingName}"`,
            severity: 'error',
          });
        }
      });
    });
  }
  
  return errors;
}

/**
 * Check ingredient name consistency - all ingredients should exist in compositions or have fallback
 */
function checkIngredientConsistency(recipe: Recipe): ValidationError[] {
  const errors: ValidationError[] = [];
  
  recipe.ingredients.forEach(ingredient => {
    const ingName = typeof ingredient === 'string' ? ingredient : ingredient.name;
    if (!ingName) return;
    
    const normalizedKey = normalizeIngredientName(ingName);
    const composition = getIngredientComposition(normalizedKey);
    const fallback = getFallbackNutrition(ingName);
    
    if (!composition && !fallback) {
      errors.push({
        type: 'ingredient_missing',
        recipeId: recipe.id,
        recipeName: recipe.name,
        message: `Ingredient "${ingName}" not found in compositions or fallbacks`,
        severity: 'warning',
      });
    }
  });
  
  return errors;
}

/**
 * Check nutritional completeness
 */
function checkNutritionalCompleteness(recipe: Recipe): ValidationError[] {
  const errors: ValidationError[] = [];
  
  const hasNutritionalInfo = !!recipe.nutritionalInfo;
  const hasNutritionCalculation = !!(recipe as any).nutritionalCalculation;
  const hasNutritionInfo = !!recipe.nutritionInfo;
  
  // At least one nutrition source should exist
  if (!hasNutritionalInfo && !hasNutritionCalculation && !hasNutritionInfo) {
    errors.push({
      type: 'nutrition_incomplete',
      recipeId: recipe.id,
      recipeName: recipe.name,
      message: 'Recipe missing all nutrition data sources',
      severity: 'error',
    });
  }
  
  return errors;
}

/**
 * Main validation function
 */
function validateRecipes(): ValidationReport {
  const errors: ValidationError[] = [];
  const warnings: ValidationError[] = [];
  
  log('\nüîç Starting Recipe Validation...\n', 'cyan');
  log(`Total recipes to validate: ${recipes.length}\n`, 'blue');
  
  recipes.forEach(recipe => {
    // Toxicity check
    const toxicityErrors = checkToxicity(recipe);
    errors.push(...toxicityErrors.filter(e => e.severity === 'error'));
    warnings.push(...toxicityErrors.filter(e => e.severity === 'warning'));
    
    // Data coverage check
    const coverageErrors = checkDataCoverage(recipe);
    warnings.push(...coverageErrors);
    
    // Allergy safety check
    const allergyErrors = checkAllergySafety(recipe);
    errors.push(...allergyErrors);
    
    // Ingredient consistency check
    const consistencyErrors = checkIngredientConsistency(recipe);
    warnings.push(...consistencyErrors);
    
    // Nutritional completeness check
    const nutritionErrors = checkNutritionalCompleteness(recipe);
    errors.push(...nutritionErrors);
  });
  
  // Calculate statistics
  const toxicCount = errors.filter(e => e.type === 'toxicity').length;
  const missingDataCount = warnings.filter(e => e.type === 'data_coverage').length;
  const allergyMismatchCount = errors.filter(e => e.type === 'allergy_safety').length;
  const missingIngredientCount = warnings.filter(e => e.type === 'ingredient_missing').length;
  const incompleteNutritionCount = errors.filter(e => e.type === 'nutrition_incomplete').length;
  
  // Calculate percentages
  const missingDataPercent = (missingDataCount / recipes.length) * 100;
  
  // Determine if validation passed
  const hasToxicIngredients = toxicCount > 0;
  const exceedsDataThreshold = missingDataPercent > 5;
  const hasAllergyMismatches = allergyMismatchCount > 0;
  const hasIncompleteNutrition = incompleteNutritionCount > 0;
  
  const passed = !hasToxicIngredients && !exceedsDataThreshold && !hasAllergyMismatches && !hasIncompleteNutrition;
  
  const report: ValidationReport = {
    totalRecipes: recipes.length,
    errors,
    warnings,
    stats: {
      toxicIngredients: toxicCount,
      missingData: missingDataCount,
      allergyMismatches: allergyMismatchCount,
      missingIngredients: missingIngredientCount,
      incompleteNutrition: incompleteNutritionCount,
    },
    passed,
  };
  
  return report;
}

/**
 * Print validation results
 */
function printResults(report: ValidationReport): void {
  log('\n' + '='.repeat(60), 'cyan');
  log('VALIDATION RESULTS', 'cyan');
  log('='.repeat(60) + '\n', 'cyan');
  
  // Statistics
  log('Statistics:', 'blue');
  log(`  Total Recipes: ${report.totalRecipes}`, 'reset');
  log(`  Toxic Ingredients Found: ${report.stats.toxicIngredients}`, report.stats.toxicIngredients > 0 ? 'red' : 'green');
  log(`  Missing Data: ${report.stats.missingData} (${((report.stats.missingData / report.totalRecipes) * 100).toFixed(1)}%)`, 
    report.stats.missingData / report.totalRecipes > 0.05 ? 'red' : 'yellow');
  log(`  Allergy Mismatches: ${report.stats.allergyMismatches}`, report.stats.allergyMismatches > 0 ? 'red' : 'green');
  log(`  Missing Ingredients: ${report.stats.missingIngredients}`, 'yellow');
  log(`  Incomplete Nutrition: ${report.stats.incompleteNutrition}`, report.stats.incompleteNutrition > 0 ? 'red' : 'green');
  
  // Errors
  if (report.errors.length > 0) {
    log(`\n‚ùå ERRORS (${report.errors.length}):`, 'red');
    report.errors.slice(0, 20).forEach((error, idx) => {
      log(`  ${idx + 1}. [${error.type}] ${error.recipeId}: ${error.message}`, 'red');
    });
    if (report.errors.length > 20) {
      log(`  ... and ${report.errors.length - 20} more errors`, 'red');
    }
  }
  
  // Warnings
  if (report.warnings.length > 0) {
    log(`\n‚ö†Ô∏è  WARNINGS (${report.warnings.length}):`, 'yellow');
    report.warnings.slice(0, 10).forEach((warning, idx) => {
      log(`  ${idx + 1}. [${warning.type}] ${warning.recipeId}: ${warning.message}`, 'yellow');
    });
    if (report.warnings.length > 10) {
      log(`  ... and ${report.warnings.length - 10} more warnings`, 'yellow');
    }
  }
  
  // Final result
  log('\n' + '='.repeat(60), 'cyan');
  if (report.passed) {
    log('‚úÖ VALIDATION PASSED', 'green');
  } else {
    log('‚ùå VALIDATION FAILED', 'red');
    log('\nReasons:', 'red');
    if (report.stats.toxicIngredients > 0) {
      log(`  - Found ${report.stats.toxicIngredients} recipes with toxic ingredients`, 'red');
    }
    if ((report.stats.missingData / report.totalRecipes) > 0.05) {
      log(`  - ${((report.stats.missingData / report.totalRecipes) * 100).toFixed(1)}% of recipes have missing data (threshold: 5%)`, 'red');
    }
    if (report.stats.allergyMismatches > 0) {
      log(`  - Found ${report.stats.allergyMismatches} allergy safety mismatches`, 'red');
    }
    if (report.stats.incompleteNutrition > 0) {
      log(`  - Found ${report.stats.incompleteNutrition} recipes with incomplete nutrition`, 'red');
    }
  }
  log('='.repeat(60) + '\n', 'cyan');
}

/**
 * Save report to JSON file
 */
function saveReport(report: ValidationReport): void {
  const reportPath = path.join(process.cwd(), 'validation-report.json');
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
  log(`üìÑ Report saved to: ${reportPath}`, 'blue');
}

// Main execution
function main() {
  try {
    const report = validateRecipes();
    printResults(report);
    saveReport(report);
    
    // Exit with appropriate code
    process.exit(report.passed ? 0 : 1);
  } catch (error) {
    log(`\n‚ùå Validation script failed: ${error}`, 'red');
    if (error instanceof Error) {
      log(`   ${error.stack}`, 'red');
    }
    process.exit(1);
  }
}

main();
</file>

<file path="scripts/validate-species-products.ts">
/**
 * Validation script to check all recipes for species mismatches
 * Ensures no "for Dogs" products appear in cat recipes, etc.
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
import { recipes } from '../lib/data/recipes-complete';
import { applyModifiers } from '../lib/applyModifiers';
import type { Recipe } from '../lib/types';

// ES module __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface Violation {
  recipeId: string;
  recipeName: string;
  recipeCategory: string;
  species: string;
  ingredientName: string;
  productName: string;
  violationType: 'for-dogs-in-cats' | 'for-cats-in-dogs' | 'dog-food-in-cats' | 'cat-food-in-dogs';
}

interface ValidationReport {
  scanDate: string;
  totalRecipes: number;
  violationsFound: number;
  violations: Violation[];
  summaryByCategory: Record<string, number>;
}

function getSpeciesFromRecipeCategory(category?: string): string | undefined {
  if (!category) return undefined;
  return category; // recipe.category is already in plural form (dogs, cats, etc.)
}

function validateRecipes(): ValidationReport {
  console.log('üîç Validating recipes for species mismatches...\n');
  
  const violations: Violation[] = [];
  const summaryByCategory: Record<string, number> = {};
  
  recipes.forEach((recipe: Recipe) => {
    const species = getSpeciesFromRecipeCategory(recipe.category);
    if (!species) {
      // Skip recipes without category
      return;
    }
    
    // Create mock pet object for this species
    const mockPet = {
      id: 'validation-pet',
      type: species, // Already in plural form
      name: 'Validation Pet',
      breed: 'Mixed',
      age: 'adult',
      healthConcerns: [],
      allergies: [],
      weightKg: 10,
    };
    
    // Apply modifiers to get final ingredient/product names
    const modifiedResult = applyModifiers(recipe, mockPet as any);
    const modifiedRecipe = modifiedResult.modifiedRecipe;
    
    // Check all ingredients
    (modifiedRecipe.ingredients || []).forEach((ing: any) => {
      const productName = ing.productName || ing.name || '';
      const ingredientName = ing.name || '';
      
      if (!productName) return;
      
      const productNameLower = productName.toLowerCase();
      
      // Check for violations
      if (species === 'cats') {
        if (productNameLower.includes('for dogs') || 
            productNameLower.includes('for dog') ||
            (productNameLower.includes('dog food') && !productNameLower.includes('cat'))) {
          violations.push({
            recipeId: recipe.id,
            recipeName: recipe.name,
            recipeCategory: recipe.category || 'unknown',
            species,
            ingredientName,
            productName,
            violationType: productNameLower.includes('dog food') ? 'dog-food-in-cats' : 'for-dogs-in-cats',
          });
          
          if (!summaryByCategory[recipe.category || 'unknown']) {
            summaryByCategory[recipe.category || 'unknown'] = 0;
          }
          summaryByCategory[recipe.category || 'unknown']++;
        }
      }
      
      if (species === 'dogs') {
        if (productNameLower.includes('for cats') || 
            productNameLower.includes('for cat') ||
            (productNameLower.includes('cat food') && !productNameLower.includes('dog'))) {
          violations.push({
            recipeId: recipe.id,
            recipeName: recipe.name,
            recipeCategory: recipe.category || 'unknown',
            species,
            ingredientName,
            productName,
            violationType: productNameLower.includes('cat food') ? 'cat-food-in-dogs' : 'for-cats-in-dogs',
          });
          
          if (!summaryByCategory[recipe.category || 'unknown']) {
            summaryByCategory[recipe.category || 'unknown'] = 0;
          }
          summaryByCategory[recipe.category || 'unknown']++;
        }
      }
    });
    
    // Check supplements too
    if ((modifiedRecipe as any).supplements) {
      ((modifiedRecipe as any).supplements || []).forEach((supplement: any) => {
        const productName = supplement.productName || supplement.name || '';
        const supplementName = supplement.name || '';
        
        if (!productName) return;
        
        const productNameLower = productName.toLowerCase();
        
        if (species === 'cats') {
          if (productNameLower.includes('for dogs') || 
              productNameLower.includes('for dog') ||
              (productNameLower.includes('dog food') && !productNameLower.includes('cat'))) {
            violations.push({
              recipeId: recipe.id,
              recipeName: recipe.name,
              recipeCategory: recipe.category || 'unknown',
              species,
              ingredientName: supplementName,
              productName,
              violationType: productNameLower.includes('dog food') ? 'dog-food-in-cats' : 'for-dogs-in-cats',
            });
            
            if (!summaryByCategory[recipe.category || 'unknown']) {
              summaryByCategory[recipe.category || 'unknown'] = 0;
            }
            summaryByCategory[recipe.category || 'unknown']++;
          }
        }
        
        if (species === 'dogs') {
          if (productNameLower.includes('for cats') || 
              productNameLower.includes('for cat') ||
              (productNameLower.includes('cat food') && !productNameLower.includes('dog'))) {
            violations.push({
              recipeId: recipe.id,
              recipeName: recipe.name,
              recipeCategory: recipe.category || 'unknown',
              species,
              ingredientName: supplementName,
              productName,
              violationType: productNameLower.includes('cat food') ? 'cat-food-in-dogs' : 'for-cats-in-dogs',
            });
            
            if (!summaryByCategory[recipe.category || 'unknown']) {
              summaryByCategory[recipe.category || 'unknown'] = 0;
            }
            summaryByCategory[recipe.category || 'unknown']++;
          }
        }
      });
    }
  });
  
  const report: ValidationReport = {
    scanDate: new Date().toISOString(),
    totalRecipes: recipes.length,
    violationsFound: violations.length,
    violations,
    summaryByCategory,
  };
  
  return report;
}

// Run validation
try {
  const report = validateRecipes();
  
  console.log(`üìä Validation Results:\n`);
  console.log(`   Total recipes scanned: ${report.totalRecipes}`);
  console.log(`   Violations found: ${report.violationsFound}\n`);
  
  if (report.violationsFound > 0) {
    console.log('‚ùå SPECIES MISMATCH VIOLATIONS:\n');
    
    // Group by violation type
    const byType: Record<string, Violation[]> = {
      'for-dogs-in-cats': [],
      'for-cats-in-dogs': [],
      'dog-food-in-cats': [],
      'cat-food-in-dogs': [],
    };
    
    report.violations.forEach(v => {
      byType[v.violationType].push(v);
    });
    
    Object.entries(byType).forEach(([type, violations]) => {
      if (violations.length === 0) return;
      
      console.log(`\n${type.toUpperCase().replace(/-/g, ' ')} (${violations.length}):`);
      violations.forEach((v, index) => {
        console.log(`  ${index + 1}. Recipe: "${v.recipeName}" (${v.recipeId})`);
        console.log(`     Category: ${v.recipeCategory}`);
        console.log(`     Species: ${v.species}`);
        console.log(`     Ingredient: ${v.ingredientName}`);
        console.log(`     Product: ${v.productName}`);
      });
    });
    
    // Save report
    const reportPath = path.join(__dirname, 'species-validation-report.json');
    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
    console.log(`\nüìÑ Detailed report saved to: ${reportPath}`);
    
    process.exit(1); // Exit with error
  } else {
    console.log('‚úÖ No violations found! All products match their recipe species.\n');
    
    // Save report anyway
    const reportPath = path.join(__dirname, 'species-validation-report.json');
    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
    console.log(`üìÑ Report saved to: ${reportPath}`);
    
    process.exit(0);
  }
} catch (error) {
  console.error('‚ùå Error during validation:', error);
  process.exit(1);
}
</file>

<file path="scripts/verify-asin-accuracy.ts">
// scripts/verify-asin-accuracy.ts
// Analyzes vetted products to identify potential ASIN accuracy issues
// Creates manual verification checklists and identifies suspicious patterns

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load vetted products from text file
function loadVettedProducts(): Array<{ ingredient: string; asin: string; productName: string; asinLink: string; vetNote: string }> {
  const filePath = path.join(__dirname, '../lib/data/vetted-products.txt');
  const content = fs.readFileSync(filePath, 'utf-8');
  const lines = content.split('\n');

  const products: Array<{ ingredient: string; asin: string; productName: string; asinLink: string; vetNote: string }> = [];
  let currentIngredient = '';
  let currentProductName = '';
  let currentAsinLink = '';
  let currentVetNote = '';

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Look for ingredient keys (like 'ground chicken': {)
    const ingredientMatch = line.match(/^\s*'([^']+)':\s*\{/);
    if (ingredientMatch) {
      // Save previous product if complete
      if (currentIngredient && currentAsinLink) {
        const asin = extractASIN(currentAsinLink);
        if (asin) {
          products.push({
            ingredient: currentIngredient,
            asin,
            productName: currentProductName,
            asinLink: currentAsinLink,
            vetNote: currentVetNote
          });
        }
      }

      // Start new product
      currentIngredient = ingredientMatch[1];
      currentProductName = '';
      currentAsinLink = '';
      currentVetNote = '';
      continue;
    }

    // Look for productName
    const productNameMatch = line.match(/productName:\s*'([^']+)'/);
    if (productNameMatch) {
      currentProductName = productNameMatch[1];
    }

    // Look for asinLink
    const asinLinkMatch = line.match(/asinLink:\s*'([^']+)'/);
    if (asinLinkMatch) {
      currentAsinLink = asinLinkMatch[1];
    }

    // Look for vetNote
    const vetNoteMatch = line.match(/vetNote:\s*'([^']+)'/);
    if (vetNoteMatch) {
      currentVetNote = vetNoteMatch[1];
    }
  }

  // Don't forget the last product
  if (currentIngredient && currentAsinLink) {
    const asin = extractASIN(currentAsinLink);
    if (asin) {
      products.push({
        ingredient: currentIngredient,
        asin,
        productName: currentProductName,
        asinLink: currentAsinLink,
        vetNote: currentVetNote
      });
    }
  }

  return products;
}

interface AnalysisResult {
  ingredient: string;
  asin: string;
  productName: string;
  vetNote: string;
  url: string;
  analysis: {
    issues: string[];
    confidence: 'high' | 'medium' | 'low';
  };
  needsManualCheck: boolean;
}

interface AnalysisSummary {
  totalProducts: number;
  highConfidence: number;
  mediumConfidence: number;
  lowConfidence: number;
  needsManualCheck: number;
  issuesByType: Record<string, number>;
  results: AnalysisResult[];
}

// Extract ASIN from URL
function extractASIN(url: string): string | null {
  if (!url) return null;

  // Try /dp/ASIN pattern
  const dpMatch = url.match(/\/dp\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (dpMatch) return dpMatch[1];

  // Try /gp/product/ASIN pattern
  const gpMatch = url.match(/\/gp\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (gpMatch) return gpMatch[1];

  // Try /product/ASIN pattern
  const productMatch = url.match(/\/product\/([A-Z0-9]{10})(?:\/|$|\?)/);
  if (productMatch) return productMatch[1];

  return null;
}

// Analyze product name for potential accuracy issues
function analyzeProductAccuracy(ingredient: string, productName: string, vetNote: string): {
  issues: string[];
  confidence: 'high' | 'medium' | 'low';
} {
  const issues: string[] = [];
  let confidence: 'high' | 'medium' | 'low' = 'high';

  const ingredientLower = ingredient.toLowerCase();
  const productLower = productName.toLowerCase();

  // Check if product name contains the ingredient
  if (!productLower.includes(ingredientLower)) {
    // Check for partial matches (key words)
    const ingredientWords = ingredientLower.split(/\s+/).filter(word => word.length > 2);
    const productWords = productLower.split(/\s+/);

    let matchedWords = 0;
    for (const word of ingredientWords) {
      if (productWords.some(productWord => productWord.includes(word))) {
        matchedWords++;
      }
    }

    if (matchedWords === 0) {
      issues.push('Product name does not contain ingredient name');
      confidence = 'low';
    } else if (matchedWords < ingredientWords.length * 0.5) {
      issues.push('Product name has weak match with ingredient');
      confidence = 'medium';
    }
  }

  // Check for generic or suspicious product names
  const suspiciousPatterns = [
    /generic/i,
    /variety pack/i,
    /mix/i,
    /blend/i,
    /assorted/i,
    /unknown brand/i,
    /no name/i
  ];

  for (const pattern of suspiciousPatterns) {
    if (pattern.test(productName)) {
      issues.push(`Suspicious product name pattern: "${pattern.source}"`);
      confidence = 'low';
      break;
    }
  }

  // Check vet note quality
  if (!vetNote || vetNote.length < 20) {
    issues.push('Vet note too short or missing');
    confidence = confidence === 'high' ? 'medium' : confidence;
  }

  return { issues, confidence };
}

// Main analysis function
function analyzeASINAccuracy(): AnalysisSummary {
  console.log('üîç Analyzing ASIN accuracy from existing data...\n');

  // Load products from text file
  const products = loadVettedProducts();

  console.log(`üì¶ Analyzing ${products.length} products...\n`);

  const results: AnalysisResult[] = [];
  const issuesByType: Record<string, number> = {};

  for (let i = 0; i < products.length; i++) {
    const product = products[i];
    const { ingredient, asin, productName, asinLink, vetNote } = product;

    console.log(`üîç [${i + 1}/${products.length}] Analyzing ${ingredient}...`);

    const analysis = analyzeProductAccuracy(ingredient, productName, vetNote);
    const needsManualCheck = analysis.confidence === 'low' || analysis.issues.length > 0;

    const result: AnalysisResult = {
      ingredient,
      asin,
      productName,
      vetNote,
      url: asinLink,
      analysis,
      needsManualCheck,
    };

    results.push(result);

    // Track issue types
    for (const issue of analysis.issues) {
      issuesByType[issue] = (issuesByType[issue] || 0) + 1;
    }

    if (needsManualCheck) {
      console.log(`‚ö†Ô∏è  ${ingredient}: ${analysis.issues.join(', ')} (Confidence: ${analysis.confidence})`);
    } else {
      console.log(`‚úÖ ${ingredient}: Looks good (Confidence: ${analysis.confidence})`);
    }
  }

  const summary: AnalysisSummary = {
    totalProducts: results.length,
    highConfidence: results.filter(r => r.analysis.confidence === 'high').length,
    mediumConfidence: results.filter(r => r.analysis.confidence === 'medium').length,
    lowConfidence: results.filter(r => r.analysis.confidence === 'low').length,
    needsManualCheck: results.filter(r => r.needsManualCheck).length,
    issuesByType,
    results,
  };

  return summary;
}

// Generate report
function generateReport(summary: AnalysisSummary): string {
  const report = [
    '# ASIN Accuracy Analysis Report',
    `Generated: ${new Date().toISOString()}`,
    '',
    '## Summary',
    '',
    `- **Total products analyzed:** ${summary.totalProducts}`,
    `- **üü¢ High confidence:** ${summary.highConfidence}`,
    `- **üü° Medium confidence:** ${summary.mediumConfidence}`,
    `- **üî¥ Low confidence:** ${summary.lowConfidence}`,
    `- **üîç Needs manual check:** ${summary.needsManualCheck}`,
    '',
    '## Issues by Type',
    '',
  ];

  if (Object.keys(summary.issuesByType).length === 0) {
    report.push('‚úÖ No issues found in analysis!');
  } else {
    Object.entries(summary.issuesByType)
      .sort(([,a], [,b]) => b - a)
      .forEach(([issue, count]) => {
        report.push(`- ${issue}: ${count} products`);
      });
  }

  report.push('', '## Products Needing Manual Verification', '');

  const manualCheckProducts = summary.results.filter(r => r.needsManualCheck);
  if (manualCheckProducts.length === 0) {
    report.push('‚úÖ No products need manual verification!');
  } else {
    manualCheckProducts.forEach(result => {
      report.push(`### ${result.ingredient}`);
      report.push(`- **Product:** ${result.productName}`);
      report.push(`- **ASIN:** ${result.asin}`);
      report.push(`- **URL:** ${result.url}`);
      report.push(`- **Vet Note:** ${result.vetNote}`);
      report.push(`- **Confidence:** ${result.analysis.confidence}`);
      if (result.analysis.issues.length > 0) {
        report.push(`- **Issues:** ${result.analysis.issues.join(', ')}`);
      }
      report.push('');
    });
  }

  return report.join('\n');
}

// Save detailed results to JSON
function saveDetailedResults(summary: AnalysisSummary): void {
  const outputPath = path.join(__dirname, '../data/asin-analysis-results.json');
  fs.writeFileSync(outputPath, JSON.stringify(summary, null, 2));
  console.log(`üìÑ Detailed results saved to: ${outputPath}`);
}

// Main execution
function main() {
  console.log('üöÄ ASIN Accuracy Analysis\n');
  console.log('='.repeat(60));

  try {
    const summary = analyzeASINAccuracy();

    console.log('\n' + '='.repeat(60));
    console.log('üìä ANALYSIS SUMMARY\n');

    console.log(`Total products analyzed: ${summary.totalProducts}`);
    console.log(`üü¢ High confidence: ${summary.highConfidence}`);
    console.log(`üü° Medium confidence: ${summary.mediumConfidence}`);
    console.log(`üî¥ Low confidence: ${summary.lowConfidence}`);
    console.log(`üîç Needs manual check: ${summary.needsManualCheck}`);

    // Generate and save report
    const report = generateReport(summary);
    const reportPath = path.join(__dirname, '../ASIN_ACCURACY_REPORT.md');
    fs.writeFileSync(reportPath, report);

    console.log(`\nüìÑ Report saved to: ${reportPath}`);
    saveDetailedResults(summary);

    if (summary.needsManualCheck > 0) {
      console.log('\n‚ö†Ô∏è  PRODUCTS NEED MANUAL VERIFICATION - Check the report for details');
      process.exit(1);
    } else {
      console.log('\n‚úÖ All products passed analysis - no manual checks needed!');
      process.exit(0);
    }

  } catch (error) {
    console.error('‚ùå Error running analysis:', error);
    process.exit(1);
  }
}

// Run verification
main();
</file>

<file path="scripts/vet-all-recipes.ts">
// scripts/vet-all-recipes.ts
import fs from 'fs';
import path from 'path';
import { recipes } from '../lib/data/recipes-complete';
import { getVettedProduct } from '../lib/data/vetted-products';

interface VettingStats {
  totalIngredients: number;
  vettedCount: number;
  notVettedCount: number;
  genericCount: number;
  needsVetting: string[];
}

// Ingredients that don't need specific product links (generic produce/staples)
const GENERIC_INGREDIENTS = [
  'water', 'salt', 'eggs', 'carrots', 'celery', 'spinach', 'kale',
  'blueberries', 'apples', 'sweet potato', 'pumpkin', 'broccoli',
  'cauliflower', 'green beans', 'peas', 'rice', 'oats', 'quinoa',
  'brown rice', 'white rice', 'bananas', 'strawberries', 'egg'
];

function isGenericIngredient(name: string): boolean {
  const normalized = name.toLowerCase().trim();
  return GENERIC_INGREDIENTS.some(generic => 
    normalized === generic || 
    normalized.includes(generic) || 
    generic.includes(normalized)
  );
}

// Helper function to convert recipe.category to species string for getVettedProduct
function getSpeciesFromRecipeCategory(category?: string): string | undefined {
  if (!category) return undefined;
  // recipe.category is like 'dogs', 'cats', 'birds', 'reptiles', 'pocket-pets'
  // This matches the species parameter format
  return category;
}

function vetRecipe(recipe: any) {
  // Derive species from recipe category
  const species = getSpeciesFromRecipeCategory(recipe.category);
  
  const updatedIngredients = recipe.ingredients.map((ing: any) => {
    const ingName = ing.name || '';
    
    // Check if it's a generic ingredient (no product link needed)
    if (isGenericIngredient(ingName)) {
      return {
        ...ing,
        amazonLink: undefined, // Remove generic search links
        isGeneric: true
      };
    }

    // Try to get vetted product (pass species for species-aware matching)
    const vetted = getVettedProduct(ingName, species);
    
    if (vetted) {
      return {
        ...ing,
        name: ingName, // Keep original name for recipe
        productName: vetted.productName, // Add product name
        asinLink: vetted.asinLink, // Use vetted link
        vetNote: vetted.vetNote,
        isVetted: true
      };
    }

    // No vetted product found - remove link
    return {
      ...ing,
      amazonLink: undefined, // Remove generic search links
      isVetted: false
    };
  });

  return {
    ...recipe,
    ingredients: updatedIngredients
  };
}

function generateStats(updatedRecipes: any[]): VettingStats {
  const stats: VettingStats = {
    totalIngredients: 0,
    vettedCount: 0,
    notVettedCount: 0,
    genericCount: 0,
    needsVetting: []
  };

  const ingredientSet = new Set<string>();

  updatedRecipes.forEach(recipe => {
    recipe.ingredients.forEach((ing: any) => {
      stats.totalIngredients++;
      const ingName = (ing.name || '').toLowerCase();
      
      if (!ingredientSet.has(ingName)) {
        ingredientSet.add(ingName);
      }

      if (ing.isGeneric) {
        stats.genericCount++;
      } else if (ing.isVetted) {
        stats.vettedCount++;
      } else {
        stats.notVettedCount++;
        if (!stats.needsVetting.includes(ing.name)) {
          stats.needsVetting.push(ing.name);
        }
      }
    });
  });

  return stats;
}

async function main() {
  console.log('üîç Starting recipe vetting process...\n');

  // Vet all recipes
  const updatedRecipes = recipes.map(recipe => vetRecipe(recipe));

  // Generate stats
  const stats = generateStats(updatedRecipes);

  // Generate updated recipes file
  const output = `// lib/data/recipes-complete.ts
// Auto-generated comprehensive recipe database
// Vetted on: ${new Date().toISOString()}
// Total recipes: ${updatedRecipes.length}

import type { Recipe } from '../types';

export const recipes: Recipe[] = ${JSON.stringify(updatedRecipes, null, 2)};
`;

  // Create data directory if it doesn't exist
  const dataDir = path.join(__dirname, '../data');
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
  }

  // Write to backup first
  const backupPath = path.join(__dirname, '../lib/data/recipes-complete.backup.ts');
  const originalPath = path.join(__dirname, '../lib/data/recipes-complete.ts');
  
  if (fs.existsSync(originalPath)) {
    fs.copyFileSync(originalPath, backupPath);
    console.log('‚úÖ Backup created: recipes-complete.backup.ts');
  }

  // Write updated file (as a separate file first for review)
  const outputPath = path.join(__dirname, '../lib/data/recipes-complete.vetted.ts');
  fs.writeFileSync(outputPath, output);
  console.log('‚úÖ Vetted recipes written to: recipes-complete.vetted.ts\n');

  // Print summary
  console.log('=== VETTING SUMMARY ===');
  console.log(`Total Recipes: ${updatedRecipes.length}`);
  console.log(`Total Ingredients: ${stats.totalIngredients}`);
  console.log(`‚úÖ Vetted: ${stats.vettedCount} (${((stats.vettedCount/stats.totalIngredients)*100).toFixed(1)}%)`);
  console.log(`üåæ Generic (no link needed): ${stats.genericCount} (${((stats.genericCount/stats.totalIngredients)*100).toFixed(1)}%)`);
  console.log(`‚ùå Needs Vetting: ${stats.notVettedCount} (${((stats.notVettedCount/stats.totalIngredients)*100).toFixed(1)}%)`);
  console.log(`\nüìã Unique Ingredients Needing Vetting: ${stats.needsVetting.length}`);
  
  if (stats.needsVetting.length > 0) {
    console.log('\nTop 30 Ingredients Needing Vetting:');
    stats.needsVetting.slice(0, 30).forEach((ing, i) => {
      console.log(`  ${i + 1}. ${ing}`);
    });
    if (stats.needsVetting.length > 30) {
      console.log(`  ... and ${stats.needsVetting.length - 30} more`);
    }
  }

  // Generate ingredient list for manual vetting
  const ingredientList = stats.needsVetting.map(ing => ({
    name: ing,
    searchQuery: `${ing} for dogs`,
    priority: 'high'
  }));

  const listPath = path.join(__dirname, '../data/ingredients-needing-vetting.json');
  fs.writeFileSync(listPath, JSON.stringify(ingredientList, null, 2));
  console.log('\n‚úÖ Ingredient list saved to: data/ingredients-needing-vetting.json');
  console.log('\n‚ö†Ô∏è  Review recipes-complete.vetted.ts before replacing the original file!');
}

main().catch(console.error);
</file>

<file path="src/utils/nutrition-data.ts">
// src/utils/nutrition-data.ts
// Consolidated nutritional data structures and calculation functions
// Moved from App.jsx for better code organization

import { INGREDIENT_COMPOSITIONS as INGREDIENT_COMPOSITIONS_DATA, type IngredientComposition, getIngredientComposition } from '../../lib/data/ingredientCompositions';
import exoticStandards from '../../lib/data/exotic-standards.json';

// Re-export INGREDIENT_COMPOSITIONS for backward compatibility
export const INGREDIENT_COMPOSITIONS = INGREDIENT_COMPOSITIONS_DATA;

// Export exotic standards as EXOTIC_TARGETS
export const EXOTIC_TARGETS = exoticStandards;

// Mock ingredient names (placeholder - update with actual data if needed)
export const MOCK_INGREDIENT_NAMES: string[] = [
  'Chicken Breast',
  'Ground Turkey',
  'Salmon',
  'Beef',
  'Eggs',
  'Kale',
  'Spinach',
  'Carrots',
  'Sweet Potato',
  'Pumpkin',
  'Broccoli',
  'Green Beans',
  'Brown Rice',
  'White Rice',
  'Oats',
  'Quinoa',
  'Blueberries',
  'Bananas'
];

/**
 * Calculate recipe nutrition from ingredients
 * Uses real USDA data when available, falls back to estimates
 */
export function calculateRecipeNutrients(recipe: any): {
  protein: number;
  fat: number;
  calcium: number;
  phosphorus: number;
  calories: number;
  omega3?: number;
  vitaminA?: number;
  vitaminC?: number;
  source: 'real' | 'estimated';
} {
  const ingredients = recipe.ingredients || [];
  let totalProtein = 0;
  let totalFat = 0;
  let totalCalcium = 0;
  let totalPhosphorus = 0;
  let totalCalories = 0;
  let totalOmega3 = 0;
  let totalVitaminA = 0;
  let totalVitaminC = 0;
  let totalWeight = 0;

  // Try to get real nutritional data
  for (const ingredient of ingredients) {
    const name = typeof ingredient === 'string' ? ingredient : ingredient.name;
    const amount = typeof ingredient === 'string' ? 100 : (ingredient.amount || 100); // Assume 100g if not specified

    const composition = getIngredientComposition(name);
    if (composition) {
      totalProtein += (composition.protein || 0) * (amount / 100);
      totalFat += (composition.fat || 0) * (amount / 100);
      totalCalcium += (composition.calcium || 0) * (amount / 100);
      totalPhosphorus += (composition.phosphorus || 0) * (amount / 100);
      totalCalories += (composition.kcal || 0) * (amount / 100);
      totalOmega3 += (composition.omega3 || 0) * (amount / 100);
      totalVitaminA += (composition.vitaminA || 0) * (amount / 100);
      totalVitaminC += (composition.vitaminC || 0) * (amount / 100);
      totalWeight += amount;
    }
  }

  // If we have real data for at least 50% of ingredients, use it
  const realDataRatio = totalWeight / (ingredients.length * 100);
  if (realDataRatio >= 0.5 && totalWeight > 0) {
    return {
      protein: totalProtein / totalWeight * 100,
      fat: totalFat / totalWeight * 100,
      calcium: totalCalcium / totalWeight * 100,
      phosphorus: totalPhosphorus / totalWeight * 100,
      calories: totalCalories / totalWeight * 100,
      omega3: totalOmega3 > 0 ? totalOmega3 / totalWeight * 100 : undefined,
      vitaminA: totalVitaminA > 0 ? totalVitaminA / totalWeight * 100 : undefined,
      vitaminC: totalVitaminC > 0 ? totalVitaminC / totalWeight * 100 : undefined,
      source: 'real'
    };
  }

  // Fall back to estimated values
  const name = recipe.name?.toLowerCase() || '';
  const ingredientsText = ingredients
    .map((i: any) => (typeof i === 'string' ? i : i.name).toLowerCase())
    .join(' ') || '';
  const allText = `${name} ${ingredientsText}`;

  // Estimate protein
  let estimatedProtein = 25;
  if (allText.includes('venison')) estimatedProtein = 34;
  else if (allText.includes('rabbit')) estimatedProtein = 33;
  else if (allText.includes('salmon') || allText.includes('fish')) estimatedProtein = 32;
  else if (allText.includes('chicken')) estimatedProtein = 30;
  else if (allText.includes('turkey')) estimatedProtein = 29;
  else if (allText.includes('beef')) estimatedProtein = 28;
  else if (allText.includes('pork')) estimatedProtein = 27;

  // Estimate fat
  let estimatedFat = 15;
  if (allText.includes('salmon') || allText.includes('duck')) estimatedFat = 18;
  else if (allText.includes('lean') || allText.includes('turkey')) estimatedFat = 10;
  else if (allText.includes('pork') || allText.includes('lamb')) estimatedFat = 16;

  // Estimate phosphorus
  let estimatedPhosphorus = 0.5;
  if (allText.includes('liver') || allText.includes('kidney') || allText.includes('organ')) {
    estimatedPhosphorus = 0.8;
  } else if (allText.includes('egg whites') || allText.includes('rice')) {
    estimatedPhosphorus = 0.3;
  }

  return {
    protein: estimatedProtein,
    fat: estimatedFat,
    calcium: 0.8, // Estimated
    phosphorus: estimatedPhosphorus,
    calories: 150, // Estimated
    source: 'estimated'
  };
}

// Re-export types for convenience
export type { IngredientComposition } from '../../lib/data/ingredientCompositions';
</file>

<file path="start.ps1">
# PetPlates Startup Script
# This script starts the development server for the PetPlates platform

Write-Host "üêæ Starting PetPlates Development Server..." -ForegroundColor Green
Write-Host ""

# Check if Node.js is installed
Write-Host "Checking Node.js installation..." -ForegroundColor Cyan
$nodeVersion = node --version 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Node.js is not installed or not in PATH" -ForegroundColor Red
    Write-Host ""
    Write-Host "Please install Node.js from https://nodejs.org/" -ForegroundColor Yellow
    Write-Host "After installation, restart your terminal and run this script again." -ForegroundColor Yellow
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}
Write-Host "‚úì Node.js $nodeVersion detected" -ForegroundColor Green
Write-Host ""

# Check if node_modules exists
if (-not (Test-Path "node_modules")) {
    Write-Host "Installing dependencies..." -ForegroundColor Cyan
    npm install
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Failed to install dependencies" -ForegroundColor Red
        Read-Host "Press Enter to exit"
        exit 1
    }
    Write-Host "‚úì Dependencies installed" -ForegroundColor Green
    Write-Host ""
}

# Start the development server
Write-Host "Starting Next.js development server..." -ForegroundColor Cyan
Write-Host ""
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Magenta
Write-Host "  PetPlates will be available at:" -ForegroundColor White
Write-Host "  http://localhost:3000" -ForegroundColor Cyan
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Magenta
Write-Host ""
Write-Host "Press Ctrl+C to stop the server" -ForegroundColor Yellow
Write-Host ""

npm run dev
</file>

<file path="start.sh">
#!/bin/bash
# PetPlates Startup Script
# This script starts the development server for the PetPlates platform

echo "üêæ Starting PetPlates Development Server..."
echo ""

# Check if Node.js is installed
echo "Checking Node.js installation..."
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js is not installed or not in PATH"
    echo ""
    echo "Please install Node.js from https://nodejs.org/"
    echo "After installation, restart your terminal and run this script again."
    echo ""
    read -p "Press Enter to exit"
    exit 1
fi

NODE_VERSION=$(node --version)
echo "‚úì Node.js $NODE_VERSION detected"
echo ""

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo "Installing dependencies..."
    npm install
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to install dependencies"
        read -p "Press Enter to exit"
        exit 1
    fi
    echo "‚úì Dependencies installed"
    echo ""
fi

# Start the development server
echo "Starting Next.js development server..."
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "  PetPlates will be available at:"
echo "  http://localhost:3000"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "Press Ctrl+C to stop the server"
echo ""

npm run dev
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./lib/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        background: 'rgb(var(--background-start-rgb))',
        foreground: 'rgb(var(--foreground-rgb))',
        'dark-green': '#0f2c0f',
        surface: {
          DEFAULT: '#143424',
          highlight: '#1e4a36',
          lighter: '#2a6148',
        },
        "surface-highlight": "#1e4a36",
        primary: {
          50: "#f0fdf4",
          100: "#dcfce7",
          200: "#bbf7d0",
          300: "#86efac",
          400: "#4ade80",
          500: "#22c55e",
          600: "#16a34a",
          700: "#15803d",
          800: "#166534",
          900: "#14532d",
        },
        secondary: {
          50: "#fff7ed",
          100: "#ffedd5",
          200: "#fed7aa",
          300: "#fdba74",
          400: "#fb923c",
          500: "#f97316",
          600: "#ea580c",
          700: "#c2410c",
          800: "#9a3412",
          900: "#7c2d12",
        },
      },
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic": "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
      keyframes: {
        float: {
          "0%, 100%": { transform: "translateY(0px)" },
          "50%": { transform: "translateY(-10px)" },
        },
        breathe: {
          "0%, 100%": { transform: "scale(1)" },
          "50%": { transform: "scale(1.02)" },
        },
      },
      animation: {
        float: "float 3s ease-in-out infinite",
        breathe: "breathe 2s ease-in-out infinite",
      },
    },
  },
  plugins: [],
};

export default config;
</file>

<file path="tests/recipe-generation.test.ts">
// tests/recipe-generation.test.ts
// Test suite for recipe generation and validation

import { describe, test, expect } from 'vitest';
import { 
  calculateRecipeNutrition, 
  validateRecipeNutrition,
  generateValidatedRecipe 
} from '../lib/utils/completeRecipeSystem';

describe('Recipe Nutrition Calculation', () => {
  test('Calculates nutrition correctly for known ingredients', () => {
    const ingredients = [
      { name: 'chicken breast', amount: 200 },
      { name: 'sweet potato', amount: 100 },
      { name: 'carrots', amount: 50 },
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    
    expect(nutrition.totalCalories).toBeGreaterThan(0);
    expect(nutrition.protein.grams).toBeGreaterThan(0);
    expect(nutrition.fat.grams).toBeGreaterThan(0);
    expect(nutrition.totalWeight).toBe(350);
    expect(nutrition.caPRatio).toBeGreaterThan(0);
  });
  
  test('Uses fallback nutrition for missing ingredients', () => {
    const ingredients = [
      { name: 'mealworms', amount: 50 }, // Likely missing from compositions
      { name: 'crickets', amount: 50 },  // Likely missing from compositions
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    
    // Should still calculate nutrition (using fallback)
    expect(nutrition.totalCalories).toBeGreaterThan(0);
    expect(nutrition.protein.grams).toBeGreaterThan(0);
    expect(nutrition.missingIngredients).toContain('mealworms');
    expect(nutrition.missingIngredients).toContain('crickets');
    expect(nutrition.estimatedWeight).toBeGreaterThan(0);
  });
  
  test('Calculates dry matter basis correctly', () => {
    const ingredients = [
      { name: 'chicken breast', amount: 200 }, // ~65% moisture
      { name: 'sweet potato', amount: 100 },   // ~70% moisture
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    
    // Dry matter percentages should be higher than "as fed"
    expect(nutrition.protein.percentage).toBeGreaterThan(0);
    expect(nutrition.fat.percentage).toBeGreaterThan(0);
    
    // Protein % on DM should be reasonable (20-40% for meat-based recipe)
    expect(nutrition.protein.percentage).toBeGreaterThan(15);
    expect(nutrition.protein.percentage).toBeLessThan(50);
  });
});

describe('Recipe Validation', () => {
  test('Valid dog recipe passes AAFCO standards', () => {
    const ingredients = [
      { name: 'chicken breast', amount: 200 },
      { name: 'sweet potato', amount: 100 },
      { name: 'carrots', amount: 50 },
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    const validation = validateRecipeNutrition(nutrition, 'dogs', 'adult');
    
    // Should pass if protein and fat meet minimums
    // Note: This may fail if recipe doesn't meet standards, which is expected
    expect(validation.score).toBeGreaterThanOrEqual(0);
    expect(validation.score).toBeLessThanOrEqual(100);
    expect(validation.nutritionInfo).toBeDefined();
  });
  
  test('Invalid recipe (low protein) fails validation', () => {
    // Create a recipe with very low protein (mostly vegetables)
    const ingredients = [
      { name: 'carrots', amount: 300 }, // Low protein
      { name: 'broccoli', amount: 200 }, // Low protein
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    const validation = validateRecipeNutrition(nutrition, 'dogs', 'adult');
    
    // Should have errors for low protein
    expect(validation.errors.length).toBeGreaterThan(0);
    expect(validation.isValid).toBe(false);
    expect(validation.score).toBeLessThan(70);
  });
  
  test('Reptile recipe with bad Ca:P ratio fails', () => {
    // Create a recipe with low Ca:P (high phosphorus, low calcium)
    const ingredients = [
      { name: 'chicken breast', amount: 200 }, // High P, low Ca
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    const validation = validateRecipeNutrition(nutrition, 'reptiles', 'adult');
    
    // Should have errors for bad Ca:P ratio
    if (nutrition.caPRatio < 1.5) {
      expect(validation.errors.length).toBeGreaterThan(0);
      expect(validation.isValid).toBe(false);
    }
  });
  
  test('Tracks missing ingredients in validation', () => {
    const ingredients = [
      { name: 'mealworms', amount: 100 }, // Missing ingredient
    ];
    
    const nutrition = calculateRecipeNutrition(ingredients);
    const validation = validateRecipeNutrition(nutrition, 'birds', 'adult');
    
    expect(validation.missingIngredients).toBeDefined();
    expect(validation.missingIngredients?.length).toBeGreaterThan(0);
    expect(validation.estimatedNutritionPercent).toBeGreaterThan(0);
    
    // Should have warning about estimated data
    const hasEstimateWarning = validation.warnings.some(w => 
      w.includes('estimated') || w.includes('fallback')
    );
    expect(hasEstimateWarning || validation.estimatedNutritionPercent! > 0).toBe(true);
  });
});

describe('Name Normalization', () => {
  test('Normalizes ingredient names correctly', () => {
    const testCases = [
      { input: 'Chicken Breast', expected: 'chicken_breast' },
      { input: 'chicken-breast', expected: 'chicken_breast' },
      { input: 'Fresh Organic Chicken Breast', expected: 'chicken_breast' },
      { input: 'ground turkey', expected: 'ground_turkey' },
    ];
    
    // Note: We can't directly test the private normalizeIngredientName function
    // but we can test it indirectly through calculateRecipeNutrition
    testCases.forEach(({ input }) => {
      const nutrition = calculateRecipeNutrition([{ name: input, amount: 100 }]);
      // Should not throw and should calculate something
      expect(nutrition.totalWeight).toBe(100);
    });
  });
});

describe('Full Recipe Generation', () => {
  test('Generates valid recipe for dogs', () => {
    const availableIngredients = [
      'chicken breast',
      'sweet potato',
      'carrots',
      'pumpkin',
    ];
    
    const result = generateValidatedRecipe(
      'dogs',
      availableIngredients,
      'adult',
      [],
      10 // max attempts
    );
    
    if (result) {
      expect(result.ingredients.length).toBeGreaterThan(0);
      expect(result.nutritionalInfo).toBeDefined();
      expect(result.validation).toBeDefined();
      expect(result.validation.score).toBeGreaterThanOrEqual(0);
      expect(result.validation.score).toBeLessThanOrEqual(100);
    }
  });
  
  test('Handles missing ingredients gracefully', () => {
    const availableIngredients = [
      'mealworms', // Missing from compositions
      'crickets',  // Missing from compositions
      'duck breast', // May be missing
    ];
    
    const result = generateValidatedRecipe(
      'birds',
      availableIngredients,
      'adult',
      [],
      10
    );
    
    // Should still generate a recipe (using fallbacks)
    if (result) {
      expect(result.ingredients.length).toBeGreaterThan(0);
      expect(result.validation.missingIngredients?.length).toBeGreaterThan(0);
      expect(result.validation.estimatedNutritionPercent).toBeGreaterThan(0);
    }
  });
});
</file>

<file path="update_prompts.py">
import re

# Read the file
with open('generate_mascot_emojis.py', 'r', encoding='utf-8') as f:
    content = f.read()

# Define the reference note
REFERENCE_NOTE = "matching the exact design style, colors, proportions, and visual details from the reference group shot image of all 5 mascots,"

# Pattern to match prompts that don't already have REFERENCE_NOTE
# Match lines that start with "        " and have a quote, but don't have REFERENCE_NOTE or f"
pattern = r'^(\s{8}"Minimalist geometric illustration of (Professor Whiskers|Scales|Pip|Sunny)[^"]*)(studious anxious appearance|neutral thoughtful expression|happy industrious look|neutral expression), (thick dark outlines)'

def replace_prompt(match):
    prefix = match.group(1)
    appearance = match.group(3)
    outlines = match.group(4)
    return f'{prefix}{appearance}, {REFERENCE_NOTE} {outlines}'

# Replace all matching prompts
content = re.sub(pattern, replace_prompt, content, flags=re.MULTILINE)

# Also need to convert regular strings to f-strings for the remaining prompts
# Find all lines that are regular strings (not f-strings) for whiskers, scales, pip, sunny
lines = content.split('\n')
new_lines = []
for line in lines:
    # Check if it's a prompt line for whiskers, scales, pip, or sunny that's not already an f-string
    if ('Professor Whiskers' in line or 'Scales olive green' in line or 'Pip warm brown' in line or 'Sunny orange-red' in line) and line.strip().startswith('"') and not line.strip().startswith('f"'):
        # Convert to f-string and add REFERENCE_NOTE if not present
        if REFERENCE_NOTE not in line:
            # Find where to insert REFERENCE_NOTE (before "thick dark outlines")
            if 'thick dark outlines' in line:
                line = line.replace('thick dark outlines', f'{REFERENCE_NOTE} thick dark outlines')
            # Convert to f-string
            line = line.replace('"Minimalist', 'f"Minimalist', 1)
    new_lines.append(line)

content = '\n'.join(new_lines)

# Write back
with open('generate_mascot_emojis.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("Updated all prompts to include reference note")
</file>

</files>
